<?

	$vaucher = array (100005,100015,100020,100025,100040,100100,100200,100300);
	$prem_akk_prise=array ("1"=>5,"2"=>20,"3"=>35);
	$prem_akk_name=array ("1"=>'Silver аккаунта',"2"=>'Gold аккаунта',"3"=>'Platinum аккаунта');


	$larec_param=array(2014001,2014002,2014003,2014004);
	$larec_prise=array(2014001=>5,2014002=>30,2014003=>40,2014004=>25);
	$larec_type=array(2014001=>1,2014002=>2,2014003=>3,2014004=>4);	
	$larec_name=array(2014001=>"Рубиновый ларец",2014002=>"Бирюзовый ларец",2014003=>"Малахитовый ларец",2014004=>"Золотой ларец");		

	$artup_param=array(1200001,1200002,1200003,1200004,1200005,1200006);
	$artup_prise=array(1200001=>5,1200002=>7.5,1200003=>10,1200004=>20,1200005=>50,1200006=>100);
	$artup_name=array(	1200001=>"Великое улучшение личного артефакта I",
						1200002=>"Великое улучшение личного артефакта II",
						1200003=>"Великое улучшение личного артефакта III",
						1200004=>"Великое улучшение личного артефакта IV",
						1200005=>"Великое улучшение личного артефакта V",
						1200006=>"Великое улучшение личного артефакта VI");	

	$exprun_param=array(584,585,586);
	$exprun_prise=array(584=>5,585=>10,586=>15);
	$exprun_name=array(584=>"Рунный опыт 5000",585=>"Рунный опыт 10000",586=>"Рунный опыт 15000");	
	

// настройки дискаунтов

	$GOLD_DIS_COST[10000]=500;		$GOLD_DIS_BONUS[10000]=5000;		$GOLD_DIS_ITEMS[10000]=array(56999);
	$GOLD_DIS_COST[2000]=100;		$GOLD_DIS_BONUS[2000]=800;		$GOLD_DIS_ITEMS[2000]=array(56914);	
	$GOLD_DIS_COST[1000]=50;		$GOLD_DIS_BONUS[1000]=300;		$GOLD_DIS_ITEMS[1000]=array(56907);
	$GOLD_DIS_COST[400]=20;			$GOLD_DIS_BONUS[400]=140;		$GOLD_DIS_ITEMS[400]=array();
	$GOLD_DIS_COST[200]=10;			$GOLD_DIS_BONUS[200]=60;		$GOLD_DIS_ITEMS[200]=array();
	$GOLD_DIS_COST[100]=5;			$GOLD_DIS_BONUS[100]=20;		$GOLD_DIS_ITEMS[100]=array();
	
	
	

	$EKR_DIS_COST[500]=500;			$EKR_DIS_BONUS[500]=250;		    $EKR_DIS_ITEMS[500]=array(56999);
	$EKR_DIS_COST[100]=100;			$EKR_DIS_BONUS[100]=40;			     $EKR_DIS_ITEMS[100]=array(56914);
	$EKR_DIS_COST[50]=50;			  $EKR_DIS_BONUS[50]=15;			$EKR_DIS_ITEMS[50]=array(56907);
	$EKR_DIS_COST[20]=20;			  $EKR_DIS_BONUS[20]=7;				 $EKR_DIS_ITEMS[20]=array();
	$EKR_DIS_COST[10]=10;			  $EKR_DIS_BONUS[10]=3;				 $EKR_DIS_ITEMS[10]=array();
	$EKR_DIS_COST[5]=5;			    $EKR_DIS_BONUS[5]=1;			    $EKR_DIS_ITEMS[5]=array();
	
	
	
	$REP_DIS_COST[300000]=500;		$REP_DIS_BONUS[300000]=150000;		     $REP_DIS_ITEMS[300000]=array(56999);
	$REP_DIS_COST[60000]=100;		 $REP_DIS_BONUS[60000]=24000;			$REP_DIS_ITEMS[60000]=array(56914);
	$REP_DIS_COST[30000]=50;		  $REP_DIS_BONUS[30000]=9000;			  $REP_DIS_ITEMS[30000]=array(56907);
	$REP_DIS_COST[12000]=20;		  $REP_DIS_BONUS[12000]=4200;			  $REP_DIS_ITEMS[12000]=array();
	$REP_DIS_COST[6000]=10;			   $REP_DIS_BONUS[6000]=1800;			    $REP_DIS_ITEMS[6000]=array();
	$REP_DIS_COST[3000]=5;			    $REP_DIS_BONUS[3000]=600;			      $REP_DIS_ITEMS[3000]=array();

	



$podar =array(
			"Подарочный сертификат - 1 екр" =>200001,
			"Подарочный сертификат - 2 екр" =>200002,
			"Подарочный сертификат - 5 екр" =>200005,
			"Подарочный сертификат - 10 екр" =>200010,
			"Подарочный сертификат - 25 екр" =>200025,
			"Подарочный сертификат - 50 екр" =>200050,
			"Подарочный сертификат - 100 екр" =>200100,
			"Подарочный сертификат - 250 екр" =>200250,
			"Подарочный сертификат - 500 екр" =>200500);

$podarvl =array(
			"Подарочный сертификат - Валентинка - 1 екр" =>200001,
			"Подарочный сертификат - Валентинка - 2 екр" =>200002,
			"Подарочный сертификат - Валентинка - 5 екр" =>200005,
			"Подарочный сертификат - Валентинка - 10 екр" =>200010,
			"Подарочный сертификат - Валентинка - 25 екр" =>200025,
			"Подарочный сертификат - Валентинка - 50 екр" =>200050,
			"Подарочный сертификат - Валентинка - 100 екр" =>200100,
			"Подарочный сертификат - Валентинка - 250 екр" =>200250,
			"Подарочный сертификат - Валентинка - 500 екр" =>200500);

$podar23 =array(
			"Подарочный сертификат - 23 февраля - 1 екр" =>200001,
			"Подарочный сертификат - 23 февраля - 2 екр" =>200002,
			"Подарочный сертификат - 23 февраля - 5 екр" =>200005,
			"Подарочный сертификат - 23 февраля - 10 екр" =>200010,
			"Подарочный сертификат - 23 февраля - 25 екр" =>200025,
			"Подарочный сертификат - 23 февраля - 50 екр" =>200050,
			"Подарочный сертификат - 23 февраля - 100 екр" =>200100,
			"Подарочный сертификат - 23 февраля - 250 екр" =>200250,
			"Подарочный сертификат - 23 февраля - 500 екр" =>200500);


$podar8 =array(
			"Подарочный сертификат - 8 марта - 1 екр" =>200001,
			"Подарочный сертификат - 8 марта - 2 екр" =>200002,
			"Подарочный сертификат - 8 марта - 5 екр" =>200005,
			"Подарочный сертификат - 8 марта - 10 екр" =>200010,
			"Подарочный сертификат - 8 марта - 25 екр" =>200025,
			"Подарочный сертификат - 8 марта - 50 екр" =>200050,
			"Подарочный сертификат - 8 марта - 100 екр" =>200100,
			"Подарочный сертификат - 8 марта - 250 екр" =>200250,
			"Подарочный сертификат - 8 марта - 500 екр" =>200500);




$podarny_img = array(
	200001 => "GiftCard1_1.gif",
	200002 => "GiftCard2_1.gif",
	200005 => "GiftCard5_1.gif",
	200010 => "GiftCard10.gif",
	200025 => "GiftCard25.gif",
	200050 => "GiftCard50.gif",
	200100 => "GiftCard100.gif",
	200250 => "GiftCard250.gif",
	200500 => "GiftCard500.gif",
);

$podarvl_img = array(
	200001 => "val_GiftCard_1.gif",
	200002 => "val_GiftCard_2.gif",
	200005 => "val_GiftCard_5.gif",
	200010 => "val_GiftCard_10.gif",
	200025 => "val_GiftCard_25.gif",
	200050 => "val_GiftCard_50.gif",
	200100 => "val_GiftCard_100.gif",
	200250 => "val_GiftCard_250.gif",
	200500 => "val_GiftCard_500.gif",
);

$podar23_img = array(
	200001 => "23f_GiftCard_1.gif",
	200002 => "23f_GiftCard_2.gif",
	200005 => "23f_GiftCard_5.gif",
	200010 => "23f_GiftCard_10.gif",
	200025 => "23f_GiftCard_25.gif",
	200050 => "23f_GiftCard_50.gif",
	200100 => "23f_GiftCard_100.gif",
	200250 => "23f_GiftCard_250.gif",
	200500 => "23f_GiftCard_500.gif",
);

$podar8_img = array(
	200001 => "8m_GiftCard_1.gif",
	200002 => "8m_GiftCard_2.gif",
	200005 => "8m_GiftCard_5.gif",
	200010 => "8m_GiftCard_10.gif",
	200025 => "8m_GiftCard_25.gif",
	200050 => "8m_GiftCard_50.gif",
	200100 => "8m_GiftCard_100.gif",
	200250 => "8m_GiftCard_250.gif",
	200500 => "8m_GiftCard_500.gif",
);


$podar_prise = array (
			"200001" =>1,
			"200002" =>2,
			"200005" =>5,
			"200010" =>10,
			"200025" =>25,
			"200050" =>50,
			"200100" =>100,
			"200250" =>250,
			"200500" =>500);

$podar_ekr = array (
			"200001" =>"0.01",
			"200002" =>"0.01",
			"200005" =>"0.01",
			"200010" =>"0.02",
			"200025" =>"0.03",
			"200050" =>"0.04",
			"200100" =>"0.05",
			"200250" =>"0.06",
			"200500" =>"0.07");
////////////////////////////////////////////////////////////////////
	$bukets = array (
/*
			"Новогодняя ёлка 1 (екр)" =>55510312,
			"Новогодняя ёлка 2 (екр)" =>55510313,
			"Новогодняя ёлка 3 (екр)"=>55510314,
			"Новогодняя ёлка 4 (екр)"=>55510315,
			"Новогодняя ёлка 5 (екр)"=>55510316,
			"Новогодняя ёлка 6 (екр)"=>55510317,
			"Новогодняя ёлка 7 (екр)"=>55510318,
			"Новогодняя ёлка 8 (екр)"=>55510319,
			"Новогодняя ёлка 9 (екр)"=>55510320,
			"Новогодняя ёлка 10 (екр)"=>55510321,
			"Новогодняя ёлка 11 (екр)"=>55510322,
			"Новогодняя ёлка 12 (екр)"=>55510334,
			"Новогодняя ёлка 13 (екр)"=>55510335,
			"Новогодняя ёлка 14 (екр)"=>55510336,
			"Новогодняя ёлка 15 (екр)"=>55510337,
			"Новогодняя ёлка 16 (екр)"=>55510338,
			"Новогодняя ёлка 17 (екр)"=>55510339,
			"Новогодняя ёлка 1 (арт)"=>55510323,
			"Новогодняя ёлка 2 (арт)"=>55510324,
			"Новогодняя ёлка 3 (арт)"=>55510325,
			"Новогодняя ёлка 4 (арт)"=>55510326,
			"Новогодняя ёлка 5 (арт)"=>55510327,
			"Новогодняя ёлка 6 (арт)"=>55510340,
			"Новогодняя ёлка 7 (арт)"=>55510341,
			"Новогодняя ёлка 8 (арт)"=>55510342,
			"Новогодняя ёлка 9 (арт)"=>55510343,
			"Новогодняя ёлка 10 (арт)"=>55510344
*/
			"Новогодняя ёлка 2016 (екр)"=>55510350,
			"Новогодняя ёлка 2016 (арт)"=>55510351,
			
			);
$bukets_prise= array (
/*
			55510312=>15,
			55510313=>15,
			55510314=>15,
			55510315=>15,
			55510316=>15,
			55510317=>20,
			55510318=>20,
			55510319=>20,
			55510320=>20,
			55510321=>20,
			55510322=>20,
			55510334=>25,
			55510335=>25,
			55510336=>25,
			55510337=>25,
			55510338=>25,
			55510339=>25,
			55510323=>200,
			55510324=>200,
			55510325=>200,
			55510326=>200,
			55510327=>200,
			55510340=>250,
			55510341=>250,
			55510342=>250,
			55510343=>250,
			55510344=>250
*/
                        55510350 => 10,
                        55510351 => 50,			
			);
///////////////////////////////////////////////////////

$leto_bukets = array (
			"Букет тайных надежд (6)"=>410021,
			"Букет оправданных надежд (9)"=>410022,
			"Букет сумеречных скитаний (10)"=>410024,			
			"Букет небесных огней (11)"=>410025,							
			"Букет блистательных побед (12)"=>410023,			
			"Букет цветущих садов (13)"=>410026
			
			);
$leto_bukets_prise= array (
                        410021 => 10,
                        410022 => 10,			
                        410024 => 10,	
                        410025 => 10,	                        
                        410023 => 10,			
                        410026 => 10,	                                                                        
			);
///////////////////////////////////////////////////////
/*
 Сильвер-аккаунт сроком 1 день, стоимость 0,5 екр
2. Сильвер-аккаунт сроком 7 дней, стоимость 2 екр
3. Сильвер-аккаунт сроком 14 дней, стоимость 3 екр
"1"=>0.5,
*/					
$new_akks_prise[1] =array(  	"7" => 2,  "14" =>3,  "30"=>5 );
/*
1. Голд-аккаунт сроком 1 день, стоимость 2 екр
2. Голд-аккаунт сроком 7 дней, стоимость 8 екр
3. Голд-аккаунт сроком 14 дней, стоимость 12 екр
	 "1"=>2, 
*/
$new_akks_prise[2] =array(	"7" => 8,  "14" =>12,  "30"=>20 );
/*
1. Платинум-аккаунт сроком 1 день, стоимость 3$
2. Платинум-аккаунт сроком 7 дней, стоимость 12$
3. Платинум-аккаунт сроком 14 дней, стоимость 21$
 "1"=>3, 
*/
$new_akks_prise[3] =array(	"7" => 12,  "14" =>21,  "30"=>35 );								
	

function make_discount_bonus($telo,$sum,$t)	
{
global  $GOLD_DIS_COST, $GOLD_DIS_BONUS , $GOLD_DIS_ITEMS , $EKR_DIS_COST , $EKR_DIS_BONUS , $EKR_DIS_ITEMS , $REP_DIS_COST ,  $REP_DIS_BONUS ,  $REP_DIS_ITEMS ;
//начисление дискаунтов
//отключенно до сентября
//return false;
$sum=round($sum); //lдля того чтоб  4,99 = 5
	
			if ($t==1)
			{
			//монеты
			arsort($GOLD_DIS_COST);
			reset($GOLD_DIS_COST);
	 		foreach ($GOLD_DIS_COST as $k => $cost) 
	 			{
	 				if ($sum>=$cost)
	 					{
	 					//нужный бонус

	 							//добавление монет по бонусу
	 							if ($GOLD_DIS_BONUS[$k]>0)
	 							{

	 							$add_gold=$GOLD_DIS_BONUS[$k];
	 							
	 												mysql_query("UPDATE oldbk.`users` set `gold` = `gold`+'{$add_gold}' WHERE `id` = '{$telo['id']}' LIMIT 1;");
													if (mysql_affected_rows()>0)	
													{
													$rec['owner']=$telo['id'];
													$rec['owner_login']=$telo['login'];
													$rec['owner_balans_do']=$telo['money'];
													$rec['owner_balans_posle']=$telo['money'];
													$rec['target']=8383;
													$rec['target_login']=iconv("CP1251","CP1251",'Банкир');
													$rec['type']=3011;
													$rec['sum_kr']=0;
													$rec['sum_ekr']=0;
													$rec['sum_kom']=0;
													$rec['item_id']='';
													$rec['item_name']='Монеты';
													$rec['item_count']=$add_gold;
													$rec['item_type']=50;
													$ko_bonus_gold_str='. Начислено '.$add_gold.' монет по Дискаунт бонус:'.$k;	
													$rec['add_info'] = $add_gold."/".($telo['gold']+$add_gold).$ko_bonus_gold_str;
													add_to_new_delo($rec);
													telepost_new($telo,iconv("CP1251","CP1251",'<font color=red>Внимание!</font> Вам передано в подарок <b>'.$add_gold.'</b> монет.')); 
													}
	 							}

								
								//выдача бонусных предметов если надо
								if (count($GOLD_DIS_ITEMS[$k]>0))
								{
								$bonus_items=$GOLD_DIS_ITEMS[$k];
							 		foreach ($bonus_items as $n => $itmid) 
							 		{
									$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='{$itmid}' ;"));
									if ($dress['id']>0)
										{
										$dress['present']='Удача';
										by_item_bank_dil($telo,$dress,null,0);
										}
									}
								}
	 					return true;
	 					}

	 			}
			}
			elseif ($t==2)
			{
			//екры
			arsort($EKR_DIS_COST);
			reset($EKR_DIS_COST);
	 		foreach ($EKR_DIS_COST as $k => $cost) 
	 			{
	 				if ($sum>=$cost)
	 					{
	 					//нужный бонус
	 							
	 							//добавление екр по бонусу
	 							if ($EKR_DIS_BONUS[$k]>0)
	 							{
	 							$add_ekr=$EKR_DIS_BONUS[$k];
									$bank = mysql_fetch_array(mysql_query("select * from oldbk.bank where owner='{$telo['id']}' order by def desc,id limit 1"));
							
									if ($bank['id']>0)							
										{
			 								  mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + '".($add_ekr)."' WHERE `id`= '{$bank['id']}' LIMIT 1;");
											if (mysql_affected_rows()>0)	
													{
													mysql_query("INSERT INTO oldbk.`dilerdelo` (paysyst,dilerid,dilername,bank,owner,ekr) values ('','450','".iconv("CP1251","CP1251",'KO')."','{$bank['id']}','".$telo['login']."','{$add_ekr}');");					
													mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date` , `text` , `bankid`) VALUES ('".time()."','".iconv("CP1251","CP1251","Бонус за покупку еврокредитов <b>{$add_ekr}</b> екр. (<i>Итого: {$bank[cr]} кр., ".($bank['ekr']+$add_ekr)." екр. </i>)")."','{$bank['id']}');");		
				
								  		    			$rec['owner']=$telo[id]; 
													$rec['owner_login']=$telo['login'];
													$rec['owner_balans_do']=$telo['money'];
													$rec['owner_balans_posle']=$telo['money'];
													$rec['target']=8383;
													$rec['target_login']=iconv("CP1251","CP1251",'Банкир');
													$rec['type']=355;
													$rec['sum_ekr']=$add_ekr;
													$rec['bank_id']=$bank[id];
													$rec['add_info']=iconv("CP1251","CP1251",'Дискаунт бонус:'.$k);
													add_to_new_delo($rec);
													telepost_new($telo,iconv("CP1251","CP1251",'<font color=red>Внимание!</font> Вам передано в подарок <b>'.$add_ekr.'</b> екр. на счет №'.$bank['id'].'. ')); 
													}
										}
	 							}
								
								//выдача бонусных предметов если надо
								if (count($EKR_DIS_ITEMS[$k]>0))
								{
								$bonus_items=$EKR_DIS_ITEMS[$k];
							 		foreach ($bonus_items as $n => $itmid) 
							 		{
									$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='{$itmid}' ;"));
									if ($dress['id']>0)
										{
										$dress['present']='Удача';
										by_item_bank_dil($telo,$dress,null,0);
										}
									}
								}
	 					return true;
	 					}
	 			
	 			}
			}
			elseif ($t==3)
			{
			//репа
			arsort($REP_DIS_COST);
			reset($REP_DIS_COST);
	 		foreach ($REP_DIS_COST as $k => $cost) 
	 			{
	 				if ($sum>=$cost)
	 					{
	 					//нужный бонус
	 							
	 							//добавление екр по бонусу
	 							if ($REP_DIS_BONUS[$k]>0)
	 							{
	 							$add_rep=$REP_DIS_BONUS[$k];
	 							
	 											mysql_query("UPDATE `users` SET  `rep`=`rep`+'$add_rep' WHERE `id`= '".$telo['id']."' LIMIT 1;"); 
												mysql_query("UPDATE `users` SET   `repmoney` = `repmoney` + '$add_rep' WHERE `id`= '".$telo['id']."' LIMIT 1;"); 
													if (mysql_affected_rows()>0)	
													{
													$rec['owner']=$telo[id];
													$rec['owner_login']=$telo[login];
													$rec['owner_balans_do']=$telo['money'];
													$rec['owner_balans_posle']=$telo['money'];
													$rec['owner_rep_do']=$telo[repmoney];
													$rec['owner_rep_posle']=($telo[repmoney]+$add_rep);
													$rec['target']=8383;
													$rec['target_login']='Банкир';
													$rec['type']=2829;
													$rec['sum_rep']=$add_rep;					
													$add_bonus_str='. Начислено '.$add_rep.' репутации по Дискаунт бонус:'.$k;	
													$rec['add_info']='Баланс реп до '.$telo[repmoney]. ' после ' .($telo[repmoney]+$add_rep).$add_bonus_str;
													add_to_new_delo($rec);
													telepost_new($telo,iconv("CP1251","CP1251",'<font color=red>Внимание!</font> Вам передано в подарок <b>'.$add_rep.'</b> репутации.')); 
													}
	 							}
								
								//выдача бонусных предметов если надо
								if (count($REP_DIS_ITEMS[$k]>0))
								{
								$bonus_items=$REP_DIS_ITEMS[$k];
							 		foreach ($bonus_items as $n => $itmid) 
							 		{
									$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='{$itmid}' ;"));
									if ($dress['id']>0)
										{
										$dress['present']='Удача';
										by_item_bank_dil($telo,$dress,null,0);
										}
									}
								}
	 					return true;
	 					}
	 			
	 			}
			}			

return false;
}
	
	
	
function make_ekr_add_bonus($tonick,$get_bankid,$user,$addbonekr,$msg_off=0)
{
if (is_array($user))
	{
	$str1='от дилера '.$user['login'];
	}
	else
	{
	$str1='';
	$user['id']=450;
	$user['login']='КО';	
	}


					if ($addbonekr>0)
				  	{
				  	//добавляем бонус  в екрах
				  	
					mysql_query("UPDATE oldbk.`bank` set `ekr` = ekr+'{$addbonekr}' WHERE `id` = '{$get_bankid['id']}' LIMIT 1;");

					mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Получен бонус <b> {$addbonekr} екр.</b>,<i>(Итого: {$get_bankid[cr]} кр., ".($get_bankid['ekr']+$addbonekr)." екр.)</i>','{$get_bankid['id']}');");					
					mysql_query("INSERT INTO oldbk.`dilerdelo` (dilerid,dilername,bank,owner,ekr) values (450,'KO','{$get_bankid['id']}','{$tonick[login]}','{$addbonekr}');");
								//new_delo
			  		    			$rec['owner']=$tonick[id];
								$rec['owner_login']=$tonick[login];
								$rec['owner_balans_do']=$tonick['money'];
								$rec['owner_balans_posle']=$tonick['money'];
								$rec['target']=$user[id];
								$rec['target_login']=$user[login];
								$rec['type']=355;//бонус 
								$rec['sum_kr']=0;
								$rec['sum_ekr']=$addbonekr;
								$rec['sum_kom']=0;
								$rec['item_id']='';
								$rec['item_name']='';
								$rec['item_count']=0;
								$rec['item_type']=0;
								$rec['item_cost']=0;
								$rec['item_dur']=0;
								$rec['item_maxdur']=0;
								$rec['item_ups']=0;
								$rec['item_unic']=0;
								$rec['item_incmagic']='';
								$rec['item_incmagic_count']='';
								$rec['item_arsenal']='';
								$rec['bank_id']=$get_bankid['id'];
								$rec['add_info']='Баланс до:'.$get_bankid['ekr'].'екр. ';
								$get_bankid['ekr']+=$addbonekr;
								$rec['add_info'].='/ после:'.$get_bankid['ekr'].'екр. ';
								
								add_to_new_delo($rec); //юзеру

					if ($msg_off==0) { telepost_new($tonick,'<font color=red>Внимание!</font> На ваш счет №'.$get_bankid['id'].' переведено '.$addbonekr.' екр. от  Коммерческого отдела. Спасибо за покупку!'); }
					return true;
				  	}
return false;
}


function get_ekr_addbonus()
{
		$query_curs=mysql_query_cache("select * from  oldbk.variables where  var='dollar' or var='euro' or var='grivna' or var='ekrkof' or var='ekrbonus'   ",false,6);

	while(list($k,$row) = each($query_curs)) 
	{
		if($row['var'] =='dollar') { $dollar = $row[value];}
		 else
		 	if($row['var'] =='euro')  { $euro = $row[value];} 
		 		else
		 			if($row['var'] =='grivna') { $grivna = $row[value];}
 					 elseif($row['var'] =='ekrkof') { $ekrkof = $row[value];}		 
			 		elseif($row['var'] =='ekrbonus') { $ekrbonus = $row[value];} 		 					  					 			
	}

	if ($ekrbonus>0)
		{
		 return	$ekrbonus;
		}
		else return false;
}

function get_rur_curs()
{
		$query_curs=mysql_query_cache("select * from  oldbk.variables where  var='dollar' or var='euro' or var='grivna' or var='ekrkof' or var='ekrbonus'   ",false,6);

	while(list($k,$row) = each($query_curs)) 
	{
		if($row['var'] =='dollar') { $dollar = $row[value];}
		 else
		 	if($row['var'] =='euro')  { $euro = $row[value];} 
		 		else
		 			if($row['var'] =='grivna') { $grivna = $row[value];}
 					 elseif($row['var'] =='ekrkof') { $ekrkof = $row[value];}		 			
			 		elseif($row['var'] =='ekrbonus') { $ekrbonus = $row[value];} 		 					  					 
	}
	$RUR=round($dollar,3);
	$RUR=(ceil($RUR/0.01) * 0.01);
	if ($RUR>0)
		{
		 return	$RUR;
		}
		else return false;
		
}	

function get_ekr_usd()
{
		$query_curs=mysql_query_cache("select * from  oldbk.variables where  var='dollar' or var='euro' or var='grivna' or var='ekrkof' or var='ekrbonus'   ",false,6);

	while(list($k,$row) = each($query_curs)) 
	{
		if($row['var'] =='dollar') { $dollar = $row[value];}
		 else
		 	if($row['var'] =='euro')  { $euro = $row[value];} 
		 		else
		 			if($row['var'] =='grivna') { $grivna = $row[value];}
 					 elseif($row['var'] =='ekrkof') { $ekrkof = $row[value];}		 
			 		elseif($row['var'] =='ekrbonus') { $ekrbonus = $row[value];} 		 					  					 			
	}

	if ($ekrkof>0)
		{
		 return	$ekrkof;
		}
		else return false;
}

function get_rur_curs_bank()
{
		$query_curs=mysql_query_cache("select * from  oldbk.variables where  var='dollar' or var='euro' or var='grivna' or var='ekrkof' or var='ekrbonus'   ",false,6);

	while(list($k,$row) = each($query_curs)) 
	{
		if($row['var'] =='dollar') { $dollar = $row[value];}
		 else
		 	if($row['var'] =='euro')  { $euro = $row[value];} 
		 		else
		 			if($row['var'] =='grivna') { $grivna = $row[value];}
 					 elseif($row['var'] =='ekrkof') { $ekrkof = $row[value];}		
			 		elseif($row['var'] =='ekrbonus') { $ekrbonus = $row[value];} 		 					  					  			
	}
	
	$RUR=round($dollar,3);
	$RUR=(ceil($RUR/0.01) * 0.01);

	if ($RUR>0)
		{
		 $RURC=round(1/$RUR,7);
		 return	$RURC;
		}
		else return false;
		
}

function get_ekr_to_rur_curs()
{

		$query_curs=mysql_query_cache("select * from  oldbk.variables where  var='dollar' or var='euro' or var='grivna' or var='ekrkof' or var='ekrbonus'   ",false,6);

	while(list($k,$row) = each($query_curs)) 
	{
		if($row['var'] =='dollar') { $dollar = $row[value];}
		 else
		 	if($row['var'] =='euro')  { $euro = $row[value];} 
		 		else
		 			if($row['var'] =='grivna') { $grivna = $row[value];}
 					 elseif($row['var'] =='ekrkof') { $ekrkof = $row[value];}		 
			 		elseif($row['var'] =='ekrbonus') { $ekrbonus = $row[value];} 		 					  					 					 			
	}
	
	
	$RUR=round($dollar,3);
	$RUR=(ceil($RUR/0.01) * 0.01);
	if ($RUR>0)
		{
		 return	$RUR;
		}
		else return false;
		
}


////Покупка ваучеров КО ИЗ банка
	function by_item_ko($telo_id,$item_id,$bank_id)
	{
	  //обработка ваучеров КО
	  
	  $tonick = check_users_city_data($telo_id);
	if ($tonick['login']) {
			$dress=mysql_fetch_array(mysql_query("select * from oldbk.eshop where id='{$item_id}' ;"));
			if ($dress[id]>0)
			  {
 			
				if(mysql_query("INSERT INTO oldbk.`inventory`
					(`getfrom`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,
						`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
						`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
						`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
					)
					VALUES
					(30,'{$dress['id']}','{$tonick['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
					'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
					'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
					,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}' ".$sql." ,'{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','0'
					) ;"))
					{
						$good = 1;
						$new_vid=mysql_insert_id();
						$dress[id]=$new_vid;
					}
					else {
						$good = 0;
					       	$resultCode=300;
					}

			    if ($good==1)
			        {
					mysql_query("INSERT INTO oldbk.`dilerdelo` (dilerid,dilername,bank,owner,ekr,addition) values ('83','ФинБот','0','{$tonick['login']}','{$dress[ecost]}','5');");
					//new_delo
  		    			$rec['owner']=$tonick[id];
					$rec['owner_login']=$tonick[login];
					$rec['owner_balans_do']=$tonick['money'];
					$rec['owner_balans_posle']=$tonick['money'];
					$rec['target']=83;
					$rec['target_login']='Коммерческий отдел';
					$rec['type']=52;//получил ваучер 
					$rec['sum_kr']=0;
					$rec['sum_ekr']=$dress[ecost];
					$rec['sum_kom']=0;
					$rec['item_id']=get_item_fid($dress);
					$rec['item_name']=$dress[name];
					$rec['item_count']=1;
					$rec['item_type']=$dress['type'];
					$rec['item_cost']=$dress['cost'];
					$rec['item_dur']=$dress['duration'];
					$rec['item_maxdur']=$dress['maxdur'];
					$rec['item_ups']=$dress['ups'];
					$rec['item_unic']=$dress['unic'];
					$rec['item_incmagic']=$dress['includemagicname'];
					$rec['item_incmagic_count']=$dress['includemagicuses'];
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['item_proto']=$dress['prototype'];
					$rec['item_sowner']=($dress['sowner']>0?1:0);
					$rec['item_incmagic_id']=$dress['includemagic'];
					add_to_new_delo($rec); //юзеру
					
					//новая - акция
					require_once "config_ko.php";
					if ((time()>$KO_start_time8-14400) and (time()<$KO_fin_time8-14400)) 
					{
					$vau_bonus=true;
				 	$AKC[100100]=array(100005,100005);
				 	$AKC[100200]=array(100020);
				 	$AKC[100300]=array(100015,100015,100005);
				 	
 					if ( ($AKC[$item_id] >0) )
 					{
				 	$bonus_arra=$AKC[$item_id];
				 		foreach ($bonus_arra as $v)
		 				{
						$bonusdress=mysql_fetch_array(mysql_query("select * from oldbk.eshop where id='{$v}' ;"));
						mysql_query("INSERT INTO oldbk.`inventory` (`getfrom`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`, `gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`, `mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron` ) VALUES
						(30,'{$bonusdress['id']}','{$tonick['id']}','{$bonusdress['name']}','{$bonusdress['type']}',{$bonusdress['massa']},{$bonusdress['cost']},{$bonusdress['ecost']},'{$bonusdress['img']}',{$bonusdress['maxdur']},{$bonusdress['isrep']},'{$bonusdress['gsila']}','{$bonusdress['glovk']}','{$bonusdress['ginta']}','{$bonusdress['gintel']}','{$bonusdress['ghp']}','{$bonusdress['gnoj']}','{$bonusdress['gtopor']}','{$bonusdress['gdubina']}','{$bonusdress['gmech']}','{$bonusdress['gfire']}','{$bonusdress['gwater']}','{$bonusdress['gair']}','{$bonusdress['gearth']}','{$bonusdress['glight']}','{$bonusdress['ggray']}','{$bonusdress['gdark']}','{$bonusdress['needident']}','{$bonusdress['nsila']}','{$bonusdress['nlovk']}','{$bonusdress['ninta']}','{$bonusdress['nintel']}','{$bonusdress['nmudra']}','{$bonusdress['nvinos']}','{$bonusdress['nnoj']}','{$bonusdress['ntopor']}','{$bonusdress['ndubina']}','{$bonusdress['nmech']}','{$bonusdress['nfire']}','{$bonusdress['nwater']}','{$bonusdress['nair']}','{$bonusdress['nearth']}','{$bonusdress['nlight']}','{$bonusdress['ngray']}','{$bonusdress['ndark']}','{$bonusdress['mfkrit']}','{$bonusdress['mfakrit']}','{$bonusdress['mfuvorot']}','{$bonusdress['mfauvorot']}','{$bonusdress['bron1']}','{$bonusdress['bron2']}','{$bonusdress['bron3']}','{$bonusdress['bron4']}','{$bonusdress['maxu']}','{$bonusdress['minu']}','{$bonusdress['magic']}','{$bonusdress['nlevel']}','{$bonusdress['nalign']}','".(($bonusdress['goden'])?($bonusdress['goden']*24*60*60+time()):"")."','{$bonusdress['goden']}','{$bonusdress['razdel']}','{$bonusdress['gmp']}','{$bonusdress['gmeshok']}','{$bonusdress['group']}','{$bonusdress['letter']}' ".$sql." ,'{$bonusdress['ab_mf']}','{$bonusdress['ab_bron']}','{$bonusdress['ab_uron']}') ;");						
							
							
						$bonus_vid='cap'.mysql_insert_id();
						$bonus_txt.=$bonusdress['name'].", ";
							
						mysql_query("INSERT INTO oldbk.`dilerdelo` (dilerid,dilername,bank,owner,ekr,addition) values (450,'KO','0','{$tonick['login']}','{$bonusdress['ecost']}','5');");
							
	  		    			$rec['owner']=$tonick['id'];
						$rec['owner_login']=$tonick['login'];
						$rec['owner_balans_do']=$tonick['money'];
						$rec['owner_balans_posle']=$tonick['money'];
						$rec['target']=450;
						$rec['target_login']='KO';
						$rec['type']=52;//получил ваучер от диллера
						$rec['sum_kr']=0;
						$rec['sum_ekr']=$bonusdress['ecost'];
						$rec['sum_kom']=0;
						$rec['item_id']=$bonus_vid;
						$rec['item_name']=$bonusdress['name'];
						$rec['item_count']=1;
						$rec['item_type']=$bonusdress['type'];
						$rec['item_cost']=$bonusdress['cost'];
						$rec['item_dur']=$bonusdress['duration'];
						$rec['item_maxdur']=$bonusdress['maxdur'];
						$rec['item_ups']=$bonusdress['ups'];
						$rec['item_unic']=$bonusdress['unic'];
						$rec['item_incmagic']=$bonusdress['includemagicname'];
						$rec['item_incmagic_count']=$bonusdress['includemagicuses'];
						$rec['item_arsenal']='';
						$rec['bank_id']='';
						$rec['item_proto']=$bonusdress['prototype'];
						$rec['item_sowner']=($bonusdress['sowner']>0?1:0);
						$rec['item_incmagic_id']=$bonusdress['includemagic'];
						$rec['add_info']='бонус';
						add_to_new_delo($rec); //юзеру							
	 					}
 							
 					}
				 	}
				////////////////////////////////////////////////////////////////

					//бонусы за покупку  ваучеров - старый
					if ((time()>1336003201-14400) and (time()<1336089599-14400))
						{
						// бонус
						$add_bonuss_art=round(($dress[ecost]*0.1),2);
						if ($bank_id>0)
							{
							$tobank[id]=$bank_id;
							}
							else
							{						
							$tobank = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '{$tonick[id]}' LIMIT 1;"));
							}
							
							if ($tobank[id]>0)
								{
								mysql_query("UPDATE oldbk.`bank` set `ekr` = ekr+'{$add_bonuss_art}' WHERE `id` = '{$tobank[id]}' LIMIT 1;");
								mysql_query("INSERT INTO oldbk.`dilerdelo` (dilerid,dilername,bank,owner,ekr) values (450,'KO','{$tobank[id]}','{$tonick[login]}','{$add_bonuss_art}');");

								//new_delo
			  		    			$rec['owner']=$tonick[id];
								$rec['owner_login']=$tonick[login];
								$rec['owner_balans_do']=$tonick['money'];
								$rec['owner_balans_posle']=$tonick['money'];
								$rec['target']=450;
								$rec['target_login']='Коммерческий отдел';
								$rec['type']=355;//бонус 
								$rec['sum_kr']=0;
								$rec['sum_ekr']=$add_bonuss_art;
								$rec['sum_kom']=0;
								$rec['item_id']='';
								$rec['item_name']='';
								$rec['item_count']=0;
								$rec['item_type']=0;
								$rec['item_cost']=0;
								$rec['item_dur']=0;
								$rec['item_maxdur']=0;
								$rec['item_ups']=0;
								$rec['item_unic']=0;
								$rec['item_incmagic']='';
								$rec['item_incmagic_count']='';
								$rec['item_arsenal']='';
								$rec['bank_id']=$tobank[id];
								add_to_new_delo($rec); //юзеру
								$bon_ok=1;
								}
						}
					/////////////////////////////
							if ( $tonick['odate'] > (time()-60)  )
							{
							addchp('<font color=red>Внимание!</font> Вам передан <b>'.$dress['name'].'</b>. Спасибо за покупку!','{[]}'.$tonick['login'].'{[]}',$tonick['room'],$tonick['id_city']);
							if ($bon_ok==1)
								{
							addchp('<font color=red>Внимание!</font> На ваш счет №'.$tobank[id].' переведено '.$add_bonuss_art.' екр. бонус от Ком.отдела. Спасибо за покупку!','{[]}'.$tonick['login'].'{[]}',$tonick['room'],$tonick['id_city']);
								}						
	
							if ($bonus_txt!='')	
							{
							$bonus_txt=substr($bonus_txt,0,-2);
							addchp('<font color=red>Внимание!</font> Вам передан бонус от Ком.отдела <b>'.$bonus_txt.'</b>. Спасибо за покупку!','{[]}'.$tonick['login'].'{[]}',$tonick['room'],$tonick['id_city']);
							}
						
							} else {
							// если в офе
							mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$tonick['id']."','','".'<font color=red>Внимание!</font> Вам передан <b>'.$dress['name'].'</b>. Спасибо за покупку!'."');");
							if ($bon_ok==1)
							{
							mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$tonick['id']."','','".'<font color=red>Внимание!</font> На ваш счет №'.$tobank[id].' переведено '.$add_bonuss_art.' екр. бонус от Ком.отдела. Спасибо за покупку!'."');");
							}
							
							if ($bonus_txt!='')	
							{
							$bonus_txt=substr($bonus_txt,0,-2);						
							mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$tonick['id']."','','".'<font color=red>Внимание!</font> Вам передан бонус от Ком.отдела <b>'.$bonus_txt.'</b>. Спасибо за покупку!'. "');");
							}
							
							}
					
					 // Партнерка
					CheckRealPartners($telo_id,$dress[ecost],0);
					 $p_user = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`partners_users` WHERE `id` = '{$telo_id}' LIMIT 1;"));
				     	 $partner = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`partners` WHERE `id` = '{$p_user['partner']}' LIMIT 1;"));
				   	 if ($p_user['partner']!='' and $p_user['fraud']!=1)
				       {
				       	 mysql_query("INSERT INTO oldbk.`partners_delo` (dealer_id,partner_id,owner_id,ekr,bank,transfer_time) values ('83','{$partner['id']}','{$telo_id}','{$dress[ecost]}','{$tobank[id]}','".time()."');");
				      	 $bonus=round(($dress[ecost]/100*$partner['percent']),2);
				      	 mysql_query("UPDATE oldbk.`partners` set `all_ekr` = `all_ekr`+'{$dress[ecost]}', `money`=`money`+'{$bonus}' WHERE `id` = '{$partner['id']}' LIMIT 1;");
				      }					
							
					//все гуд	
				       return true;
							
				}
			 	
			   	
			  }
			  else
			  {
			  		return false;//предмет не найден
			  }
			  
			}
			else {
				return false; //логин не найден
			} 
	  
	}

////////////Премиум аккаунты - диллерка , обработчики платежных систем
    	$akkcosts[1]=5; $strtype[1]='Silver'; $exp_bonus[1]="0.1"; $eff_type[1]=4999;
    	$akkcosts[2]=20; $strtype[2]='Gold'; $exp_bonus[2]="0.15"; $eff_type[2]=5999;
    	$akkcosts[3]=35; $strtype[3]='Platinum'; $exp_bonus[3]="0.20"; $eff_type[3]=6999; 	    

    	$akks_types=array(107,114,130,207,214,230,307,314,330);//101 201 301
    			/*
				Голд-аккаунт
				1. Голд-аккаунт сроком 1 день, стоимость 2 екр
				     нет личного реликта "Невидимость" (в оригинале 4шт.)
				     нет личного реликта "Сброс статов и умений" (в оригинале 1шт.)
			*/
	$gold_set_abils[1][1]=0; 
	$gold_set_abils[1][4848]=0; 
			/*
			2. Голд-аккаунт сроком 7 дней, стоимость 8 екр
		     Личный реликт "Невидимость" 1 шт. (в оригинале 4шт.)
		     нет личного реликта "Сброс статов и умений" (в оригинале 1шт.)
		     */
	$gold_set_abils[7][1]=1; 
	$gold_set_abils[7][4848]=0; 
			/*
			3. Голд-аккаунт сроком 14 дней, стоимость 12 екр
			Личный реликт "Невидимость" 2 шт. (в оригинале 4шт.)
			нет личного реликта "Сброс статов и умений" (в оригинале 1шт.)
			*/
	$gold_set_abils[14][1]=2; 
	$gold_set_abils[14][4848]=0; 
			
			/*
			4. на 30 дней
			*/			
	$gold_set_abils[30][1]=4; 
	$gold_set_abils[30][4848]=1;    	
    		
    		/*
		    Платинум-аккаунт
	    1. Платинум-аккаунт сроком 1 день, стоимость 3$
	     не дает предмет "Пропуск к Лорду 0/1", подарком, (в оригинале 5шт.)
	     нет реликта "Невидимость" (в оригинале 4шт.)
	     нет реликта "Сброс статов и умений" (в оригинале 4шт.)
		*/
		$plat_set_abils[1][4016]=0;
		$plat_set_abils[1][1]=0;	
		$plat_set_abils[1][4848]=0;		
		/*
		2. Платинум-аккаунт сроком 7 дней, стоимость 12$
		     выдаем "Пропуск к Лорду 0/1", подарком, 1 шт (в оригинале 5шт.)
		     Реликт "Невидимость" 1 шт (в оригинале 4шт.)
		     Реликт "Сброс статов и умений" 1 шт (в оригинале 4шт.)
		*/
		$plat_set_abils[7][4016]=1;
		$plat_set_abils[7][1]=1;	
		$plat_set_abils[7][4848]=1;		
		
		/*
		3. Платинум-аккаунт сроком 14 дней, стоимость 21$
		     выдаем "Пропуск к Лорду 0/1", подарком, 2 шт (в оригинале 5шт.)
		     Реликт "Невидимость" 2 шт (в оригинале 4шт.)
		     Реликт "Сброс статов и умений" 2 шт (в оригинале 4шт.)    		
    		*/
		$plat_set_abils[14][4016]=2;
		$plat_set_abils[14][1]=2;	
		$plat_set_abils[14][4848]=2;

		/*
		4, полный на 30 дней
		*/
		$plat_set_abils[30][4016]=5;
		$plat_set_abils[30][1]=4;	
		$plat_set_abils[30][4848]=4;
    		
    	
	function setup_acc_new($telo,$acctype,$dill,$add_time=0,$kdays=30)
	{
	//установка нового любого аккаунта
	 global $akkcost,$strtype,$db_city,$exp_bonus,$eff_type,$plat_set_abils,$gold_set_abils;
    	$akkcosts[1]=5; $strtype[1]='Silver'; $exp_bonus[1]="0.1"; $eff_type[1]=4999;
    	$akkcosts[2]=20; $strtype[2]='Gold'; $exp_bonus[2]="0.15"; $eff_type[2]=5999;
    	$akkcosts[3]=35; $strtype[3]='Platinum'; $exp_bonus[3]="0.20"; $eff_type[3]=6999; 	    
	
	telepost('Bred','<font color=red>setup_acc_new_EXP_1</font>kdays:'.$kdays.'/telo id:'.$telo['id'].'/expbon:'.$exp_bonus[$acctype]); 	 	

	
	$exp=(time()+60*60*24*$kdays)+$add_time; 	 
	$sqlt="UPDATE ".$db_city[$telo[id_city]]."users set prem = {$acctype}  , expbonus=expbonus+'{$exp_bonus[$acctype]}'   WHERE id = '{$telo['id']}' LIMIT 1;";
	mysql_query($sqlt);
	
 	telepost('Bred','<font color=red>setup_acc_new</font>city:'.$db_city[$telo[id_city]].'/acctype:'.$acctype.'/expb:'.$exp_bonus[$acctype].'/teloid:'.$telo['id']);
	
	
	mysql_query("insert into ".$db_city[$telo[id_city]]."effects (`type`, `name`, `owner`, `time`) VALUES  ('{$eff_type[$acctype]}','{$strtype[$acctype]} account','".$telo[id]."','".$exp."') ;");
	
		if ($acctype==2)
			{
			//плюшки голда
			get_gold_abil($telo,$dill,$kdays);
			}
		elseif ($acctype==3)
			{
			//плюшки платины
			get_platinum_abil($telo,$dill,$kdays);
			}
	return $exp;
	}
	
	function get_gold_abil($telo,$dill,$kdays=30)
	{
 	 global $gold_set_abils;
	
	//1. 3 неведимок (разово при покупке) +1 невидимка =4 шт
		
		if ($gold_set_abils[$kdays][1] >0)
			{
			mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=1,`allcount`='{$gold_set_abils[$kdays][1]}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$gold_set_abils[$kdays][1]}' ;");
			}
			
	//2. Нападалки - 1 обычная раз в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=55,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");
	//3.Молчанки - 2шт (30мин) раз в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=15,`dailyc`=2,`daily`=2  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+2, `daily`=`daily`+2 ;");
	//8. Снятие молчанки - 1шт в сутки (только на себя и только игровой)
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=4847,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");		
	//4. 2 лотерейных билета на ближайший розыгрышь (выдаются при покупке)
	//get_bonus_bill_loto($telo,1,$dill);
		
		//6. Бесплатное обнуление статов (разово при покупке в виде кнопки в течение 30 дней, с момента покупки потом сгорает, если голд не продлен)
		if ($gold_set_abils[$kdays][4848] >0)
		{
		$exp=(time()+60*60*24*$kdays); 
		mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=4848,`allcount`='{$gold_set_abils[$kdays][4848]}', `findata`='{$exp}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$gold_set_abils[$kdays][4848]}', `findata`='{$exp}' ;");
		}
	
	
	}
	
	function get_platinum_abil($telo,$dill,$kdays=30)
	{
	 global $plat_set_abils,$premlastuseid;
	
	$abil[1]=5007152; //арес  1; // Огонь
	$abil[2]=5007154; //Подлый удар wrath_ground   2  Земля 
	$abil[3]=5007153; //Потрясение/ wrath_air 3; //Воздух (Весы, Водоле
	$abil[4]=5007155; //Отравление ядом	wrath_water  4; //Вода 
	
	$need_astih=get_mag_stih($telo); // получаем ид стихии
	$need_astih=$need_astih[0]; //на 0м месте родная стихия
		
	//3.Молчанки - 2шт (30мин) раз в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=15,`dailyc`=2,`daily`=2  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+2, `daily`=`daily`+2 ;");
		
	//2. Нападалки - 1 обычная раз в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=55,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");


	if (!$premlastuseid || $premlastuseid < 858500017) {
		//1. 2 телепорта в сутки => 1 ареса
		mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`='{$abil[$need_astih]}',`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");
	}

	//2. лечение любых травм на себя или другого - 1шт в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=57,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");
	//3. 2 кровавые напы в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=56,`dailyc`=2,`daily`=2  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+2, `daily`=`daily`+2 ;");
	//4. Вендетта - 1шт в сутки
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=2526,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");	
	
	
	//6. Бесплатное обнуление статов и умелок (кнопка в панели) - 1 использование, разово (в течение 30 дней потом сгорает если платинум не продлен)

	
	if ($plat_set_abils[$kdays][4848] > 0)
	{
	$exp=(time()+60*60*24*$kdays); 
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=4848,`allcount`='{$plat_set_abils[$kdays][4848]}', `findata`='{$exp}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$plat_set_abils[$kdays][4848]}', `findata`='{$exp}' ;");
	}

	//7. 5 лотерейных билетов на ближайший розыгрышь (разово)
	//get_bonus_bill_loto($telo,3,$dill);
	
	//8. Снятие молчанки - 5шт в сутки (только на себя и только игровой)
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=4847,`dailyc`=5,`daily`=5  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+5, `daily`=`daily`+5 ;");		
	
	//9. Запрет на получение травм - 3 дня (кнопка-абилка в панели которую когда нажмешь тогда и начнется отсчет 3 дней)
	//mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=4846,`allcount`=1  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+1 ;");
	

		if ($plat_set_abils[$kdays][1] >0)	
		{
		//10.  неведов (разово при покупке)
		mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=1,`allcount`='{$plat_set_abils[$kdays][1]}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$plat_set_abils[$kdays][1]}' ;");
		}
	
	//11. 1 перевоплот (разово при покупке)
	///mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=1111,`allcount`=1  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+1 ;");


		if ($plat_set_abils[$kdays][4016] >0 && (!$premlastuseid || $premlastuseid < 858500017))
		{
			// добавить: Пропуск к Лорду 0/1, подарком, 5 шт.
			$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='4016' ;"));
			$dress['present']='Удача';
			for ($i=0;$i<$plat_set_abils[$kdays][4016];$i++) 
						{
						by_item_bank_dil($telo,$dress,$dill,1);
						}
		}

	// добавить Личный реликт "Колодец здоровья" (5шт./сутки)
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=54,`dailyc`=5,`daily`=5  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+5, `daily`=`daily`+5 ;");
 	
 	// добавить Личный реликт "Защита от травм на один бой" (1шт./сутки)
 	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=556557 ,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");
 	
	//добавить Личный реликт "Защита от магии стихий" (1шт./сутки)
	mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$telo[id]}',`magic_id`=557561 ,`dailyc`=1,`daily`=1  ON DUPLICATE KEY UPDATE `dailyc`=`dailyc`+1, `daily`=`daily`+1 ;");
	
	}
	
	
    	function get_bonus_bill_loto($telo,$kol,$dill)
    	{
	
		$get_lot=mysql_fetch_array(mysql_query("select * from oldbk.item_loto_ras where status=1 LIMIT 1;"));
		$bilprice=2;
		
		$dill['getfrom']=(int)$dill['getfrom']; // откуда 
		
		
		if ($get_lot[id] >0)
			     {
			        for ($kkk=1;$kkk<=$kol;$kkk++)
			        	{

			        	if(mysql_query("INSERT INTO oldbk.`item_loto` SET `loto`={$get_lot[id]},`owner`={$telo[id]},`dil`={$dill[id]},`lotodate`='".date("Y-m-d H:i:s",$get_lot[lotodate])."';"))
						{
						$new_bil_id=mysql_insert_id();
						mysql_query("INSERT INTO oldbk.`inventory` (`getfrom`,`name`,`duration`,`maxdur`,`cost`,`owner`,`nlevel`,`nsila`,`nlovk`,`ninta`,`nvinos`,`nintel`,`nmudra`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nalign`,`minu`,`maxu`,`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`img`,`text`,`dressed`,`bron1`,`bron2`,`bron3`,`bron4`,`dategoden`,`magic`,`type`,`present`,`sharped`,`massa`,`goden`,`needident`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`letter`,`isrep`,`update`,`setsale`,`prototype`,`otdel`,`bs`,`gmp`,`includemagic`,`includemagicdex`,`includemagicmax`,`includemagicname`,`includemagicuses`,`includemagiccost`,`includemagicekrcost`,`gmeshok`,`tradesale`,`karman`,`stbonus`,`upfree`,`ups`,`mfbonus`,`mffree`,`type3_updated`,`bs_owner`,`nsex`,`present_text`,`add_time`,`labonly`,`labflag`,`prokat_idp`,`prokat_do`,`arsenal_klan`,`repcost`,`up_level`,`ecost`,`group`,`ekr_up`,`unik`,`add_pick`,`pick_time`,`sowner`,`idcity`,`ekr_flag`)
						VALUES ('{$dill['getfrom']}','Лотерейный билет ОлдБк',0,1,0,{$telo[id]},0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'oldbkloto.gif','',0,0,0,0,0,0,0,210,'Лотерея ОлдБК',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'"."Билет №".$new_bil_id."<br>Тираж №".$get_lot[id]."<br>Cостоится ".date("Y-m-d H:i:s",$get_lot[lotodate])."',1,'".date("Y-m-d H:i:s")."',0,33333,'6',0,0,0,0,0,'',0,0,0,0,0,0,0,{$get_lot[id]},0,0,{$new_bil_id},0,0,0,NULL,0,0,0,0,NULL,'',0,0,2,0,NULL,0,NULL,NULL,0,'{$dill[id_city]}','1');");
						$dress[id]=mysql_insert_id();
						$dress[idcity]=$dill[id_city];
						
						//new_delo
	  		    			$rec['owner']=$telo[id];
						$rec['owner_login']=$telo[login];
						$rec['owner_balans_do']=$telo['money'];
						$rec['owner_balans_posle']=$telo['money'];
						$rec['target']=$dill[id];
						$rec['target_login']='Коммерческий отдел';
						$rec['type']=56;//получил предмет от диллера в бонус
						$rec['sum_kr']=0;
						$rec['sum_ekr']=$bilprice;
						$rec['sum_kom']=0;
						$rec['item_id']=get_item_fid($dress);
						$rec['item_name']='Лотерейный билет ОлдБк';
						$rec['item_count']=1;
						$rec['item_type']=210;
						$rec['item_cost']=0;
						$rec['item_dur']=0;
						$rec['item_maxdur']=1;
						$rec['item_ups']=0;
						$rec['item_unic']=0;
						$rec['item_incmagic']='';
						$rec['item_incmagic_count']='';
						$rec['item_arsenal']='';
						$rec['bank_id']='';
						add_to_new_delo($rec); //юзеру
						$ok=true;
						}
						else 
						{
						echo mysql_error();
						$ok=false;
						}
			        	}
			        if ($ok)	
			        	{
			        	return false;
			        	}
			     }
	return false;
    	}

	function main_prem_akk($tonick,$acctype,$dill,$kdays=30) 
	{
	global $db_city, $gold_set_abils, $plat_set_abils , $premlastuseid;


	switch($tonick[prem])
				{
					case 0:
						//нету ничего
						//ставим новый
						$exp=setup_acc_new($tonick,$acctype,$dill,0,$kdays);
						break;
					case 1:
						// есть сильвер
						$prod=mysql_fetch_array(mysql_query('select * from '.$db_city[$tonick[id_city]].'effects where owner ='.$tonick[id].' AND type =4999 LIMIT 1;'));
						
						 if ($acctype==1)
						 	{
						 	//продлеваем сильвер
							if($prod[id]>0)
								{
								mysql_query("UPDATE ".$db_city[$tonick[id_city]]."effects SET `time`=`time`+(60*60*24*{$kdays}) where id={$prod[id]}");
								$exp=$prod['time']+(60*60*24*$kdays);
								}
								else
								{
								return false;
								}
						 	}
						elseif ($acctype==2)
						 		{
						 		//переходим на голд
						 		if($prod[id]>0)
							 		{
						 			$add_time=(int)(($prod[time]-time())/4);//сколько добавить времени
							 		mysql_query("DELETE from  ".$db_city[$tonick[id_city]]."effects where id='{$prod[id]}' ; "); //удаляем еффект сильвера
							 		mysql_query("UPDATE ".$db_city[$tonick[id_city]]."users SET expbonus=expbonus-0.1 where id='{$tonick[id]}'  ");
							 		$exp=setup_acc_new($tonick,2,$dill,$add_time,$kdays);
							 		}
							 		else
									{
									return false;
									}
						 		}
						 elseif ($acctype==3)
						 		{
						 		//переходим на платин
						 		if($prod[id]>0)
						 			{
						 			$add_time=(int)(($prod[time]-time())/7);//сколько добавить времени
							 		mysql_query("DELETE from  ".$db_city[$tonick[id_city]]."effects where id='{$prod[id]}' ; "); //удаляем еффект сильвера
							 		mysql_query("UPDATE ".$db_city[$tonick[id_city]]."users SET expbonus=expbonus-0.1 where id='{$tonick[id]}'  ");
							 		$exp=setup_acc_new($tonick,3,$dill,$add_time,$kdays);						 			
						 			}
						 			else
									{
									return false;								
									}
						 		}
						break;
					case 2:
					//есть голд
						$prod=mysql_fetch_array(mysql_query('select * from '.$db_city[$tonick[id_city]].'effects where owner ='.$tonick[id].' AND type =5999 LIMIT 1;'));
						if ($acctype==2)
						 		{
						 		//продлеваем голд
						 		if($prod[id]>0)
									{
									mysql_query("UPDATE ".$db_city[$tonick[id_city]]."effects SET `time`=`time`+(60*60*24*{$kdays}) where id={$prod[id]}");
									//суточные нетрогаем!!
									
										//докидываем единоразовые
										if ($gold_set_abils[$kdays][1] >0)
											{
											//1. 3 неведимок (разово при покупке)
											mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$tonick[id]}',`magic_id`=1,`allcount`='{$gold_set_abils[$kdays][1]}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$gold_set_abils[$kdays][1]}' ;");
											}
											if ($gold_set_abils[$kdays][4848] >0)
											{
											$aexp=(time()+60*60*24*$kdays); 
											mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$tonick[id]}',`magic_id`=4848,`allcount`='{$gold_set_abils[$kdays][4848]}', `findata`='{$aexp}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$gold_set_abils[$kdays][4848]}', `findata`=`findata`+(60*60*24*{$kdays}) ;");								
											}

									$exp=$prod['time']+(60*60*24*$kdays);
									}
									else
									{
									return false;								
									}
						 		}
						 elseif ($acctype==3)
						 		{
						 		//переходим на платин
						 		if($prod[id]>0)
						 				{
						 				//удаляем еффект голда
								 		mysql_query("DELETE from  ".$db_city[$tonick[id_city]]."effects where id='{$prod[id]}' ; "); //удаляем еффект голда
								 		mysql_query("UPDATE ".$db_city[$tonick[id_city]]."users SET expbonus=expbonus-0.1 where id='{$tonick[id]}'  ");								 		
							 			$add_time=(int)(($prod[time]-time())/1.75);//сколько добавить времени
						 				//удаляем плюшки голда суточные
						 				//Нападалки - 1 обычная раз в сутки
					 					mysql_query("UPDATE `oldbk`.`users_abils` SET `dailyc`=0,`daily`=`daily`-1 where `owner`='{$tonick[id]}' and `magic_id`=55;");
						 				//Молчанки - 2шт (30мин) раз в сутки
										mysql_query("UPDATE `oldbk`.`users_abils` SET `dailyc`=0,`daily`=`daily`-2 where `owner`='{$tonick[id]}' and `magic_id`=15;");						 				
										//снятие молчанки 1 шт в сутки
										mysql_query("UPDATE `oldbk`.`users_abils` SET `dailyc`=0,`daily`=`daily`-1 where `owner`='{$tonick[id]}' and `magic_id`=4847;");						 				
																				
										//ставим платину
										$exp=setup_acc_new($tonick,3,$dill,$add_time,$kdays);
						 				}
						 				else
						 				{
										return false;									
						 				}
						 		}
						break;
					case 3:
						//есть платин
						$prod=mysql_fetch_array(mysql_query('select * from '.$db_city[$tonick[id_city]].'effects where owner ='.$tonick[id].' AND type =6999 LIMIT 1;'));
						if ($acctype==3)
						 		{
						 		//продлеваем платин
							 		if($prod[id]>0)
							 			{
							 			mysql_query("UPDATE ".$db_city[$tonick[id_city]]."effects SET `time`=`time`+(60*60*24*{$kdays}) where id={$prod[id]}");
							 			//суточные нетрогаем!!
										//докидываем единоразовые
										//9. Запрет на получение травм - 3 дня (кнопка-абилка в панели которую когда нажмешь тогда и начнется отсчет 3 дней)
										//mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$tonick[id]}',`magic_id`=4846,`allcount`=1  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+1 ;");
										
						 				//Бесплатное обнуление статов (разово при покупке в виде кнопки в течение 30 дней, с момента покупки потом сгорает, если голд не продлен)
						 				if ($plat_set_abils[$kdays][4848] >0)
						 				{
										mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$tonick[id]}',`magic_id`=4848,`allcount`='{$plat_set_abils[$kdays][4848]}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$plat_set_abils[$kdays][4848]}', `findata`=`findata`+(60*60*24*{$kdays}) ;");
										}
										

										if ($plat_set_abils[$kdays][1] >0)
										{
										//  неведимок (разово при покупке)
										mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$tonick[id]}',`magic_id`=1,`allcount`='{$plat_set_abils[$kdays][1]}'  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+'{$plat_set_abils[$kdays][1]}' ;");
										}

										//11. 1 перевоплот (разово при покупке)
										///mysql_query("INSERT INTO `oldbk`.`users_abils` SET `owner`='{$tonick[id]}',`magic_id`=1111,`allcount`=1  ON DUPLICATE KEY UPDATE `allcount`=`allcount`+1 ;");
										
										//7. 5 лотерейных билетов на ближайший розыгрышь (разово)
										//get_bonus_bill_loto($tonick,3,$dill);

	telepost('Bred','<font color=red>setup_acc_new_platina_prod</font>days:'.$kdays.'/item:'.$plat_set_abils[$kdays][4016].'/teloid:'.$tonick['id']);

										if ($plat_set_abils[$kdays][4016] >0 && (!$premlastuseid || $premlastuseid < 858500017))
										{
										// добавить: Пропуск к Лорду 0/1, подарком, 5 шт.
										$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='4016' ;"));
										$dress['present']='Удача';
										for ($i=0;$i<$plat_set_abils[$kdays][4016];$i++) 
													{
													by_item_bank_dil($tonick,$dress,$dill,1);
													}
										}

							 			
										$exp=$prod['time']+(60*60*24*$kdays);
							 			}
							 			else
							 			{
										return false;								
							 			}
						 		
						 		}
						break;				
				}
	

		return $exp;
	}

	function by_prem_from_bank($tonick,$acctype,$bank,$exp,$dil=false,$sub_type) // используется только в банке
	{
	global  $new_akks_prise , $strtype;
	//начисляем +5 екр
	//mysql_query("UPDATE oldbk.`bank` set `ekr` = (ekr+5) WHERE `id` = '{$bank['id']}' LIMIT 1;");
	$dilindx[1]=7;
	$dilindx[2]=17;			
	$dilindx[3]=117;			
			
			if ($dil==false)
			{
			$dil['id']=83;
			$dil['login']='ФинБот';
			$dil['target_login']='Коммерческий отдел';
			}
			else
			{
			$dil['target_login']=$dil['login'];
			}

			
	mysql_query("INSERT INTO oldbk.`dilerdelo` (paysyst,dilerid,dilername,bank,owner,ekr,addition) values ('{$dil['paysys']}','{$dil['id']}','{$dil['login']}','{$bank['id']}','{$tonick[login]}','{$new_akks_prise[$acctype][$sub_type]}','{$dilindx[$acctype]}');");
	$id_ins_part_del=mysql_insert_id();
				//new_delo
	    			$rec['owner']=$tonick[id];
				$rec['owner_login']=$tonick[login];
				$rec['owner_balans_do']=$tonick['money'];
				$rec['owner_balans_posle']=$tonick['money'];
				$rec['target']=$dil['id'];
				$rec['target_login']=$dil['target_login'];
					$actty[1]=59;
					$actty[2]=359;
					$actty[3]=358;					
				$rec['type']=$actty[$acctype] ;//покупка silvera/gold/platinum от диллера
				$rec['sum_kr']=0;
				$rec['sum_ekr']=$new_akks_prise[$acctype][$sub_type];
				$rec['sum_kom']=0;
				$rec['item_id']='';
				$rec['item_name']='';
				$rec['item_count']=0;
				$rec['item_type']=0;
				$rec['item_cost']=0;
				$rec['item_dur']=0;
				$rec['item_maxdur']=0;
				$rec['item_ups']=0;
				$rec['item_unic']=0;
				$rec['item_incmagic']='';
				$rec['item_incmagic_count']='';
				$rec['item_arsenal']='';
				$rec['bank_id']=$bank['id'];
				$rec['add_info']=(date('d-m-Y',$exp));

				add_to_new_delo($rec); //юзеру

				//mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Получено <b>5 екр.</b> (бонус за покупку премиум аккаунта) ','{$bank['id']}');");


				// Партнерка
				CheckRealPartners($tonick['id'],$new_akks_prise[$acctype][$sub_type],0);
				$p_user = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`partners_users` WHERE `id` = '{$tonick['id']}' LIMIT 1;"));
				$partner = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`partners` WHERE `id` = '{$p_user['partner']}' LIMIT 1;"));
				if ($p_user['partner']!='' and $p_user['fraud']!=1)
				{
					mysql_query("INSERT INTO oldbk.`partners_delo` (dealer_id,partner_id,owner_id,ekr,bank,transfer_time) values ('83','{$partner['id']}','{$tonick['id']}','{$new_akks_prise[$acctype][$sub_type]}','{$bank['id']}','".time()."');");
					$bonus=round(($new_akks_prise[$acctype][$sub_type]/100*$partner['percent']),2);
					mysql_query("UPDATE oldbk.`partners` set `all_ekr` = `all_ekr`+'{$new_akks_prise[$acctype][$sub_type]}', `money`=`money`+'{$bonus}' WHERE `id` = '{$partner['id']}' LIMIT 1;");
				}

				addchp('<font color=red>Внимание!</font> Вам присвоен '.$strtype[$acctype].' account. ','{[]}'.$tonick['login'].'{[]}',$tonick['room'],$tonick['id_city']);

return true;
}


	function test_larec($btype,$telo)
	{
//	return true;		
	include "ny_events.php";
	if ((time()>$ny_events['larcistart']) and (time()<$ny_events['larciend']))
	   {
		$q = mysql_query('SELECT * FROM oldbk.boxs_history WHERE owner = '.$telo['id'].' and selldate = "'.date("d/m/Y").'" and box_type = '.$btype);
		$today_by=mysql_num_rows($q);
		if ($today_by>=50)
		{
			return false;		
		}
		else
		{
			$get_all_boxes=mysql_fetch_array(mysql_query("select box_type , count(id) as kol from oldbk.boxs where item_id=0 and box_type=".$btype));
			if ($get_all_boxes['kol']>0)
			{
			return true;		
			}
			else
			{
			return false;
			}
		}
	   }
	   else
		{
		return false;
		}
	}

//покупка предмета
function by_item_bank_dil($tonick,$dress,$dil,$msg_off=0)
{

if (is_array($dil))
	{
	$str1='от дилера '.$dil['login'];
	}
	else
	{
	$str1='';
	$dil['id']=83;
	$dil['login']='ФинБот';	
	}
	
		if ($dress['dategoden']>0)
		{
				$goden_do = $dress['dategoden'];
				$goden = $dress['goden'];		
		}
		elseif ($dress['goden']>0)
		{
				$goden_do = time()+($dress['goden']*24*3600);
				$goden = $dress['goden'];
		}
		else
			{
			$goden_do = 0;
			$goden = 0;
			}
	
	if ($dress['prototype']==0)
		{
		$dress['prototype']=$dress['id'];
		}

mysql_query("INSERT INTO oldbk.`inventory`
							(`update`,`getfrom`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`, `ecost`, `img`,`maxdur`,`isrep`,
							`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,
							`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
							`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,`otdel`,`group`,`mfbonus`,`stbonus`,`gmp`,`idcity`,`ab_mf`,`ab_bron`,`ab_uron`, `includemagic` , `includemagicdex` , `includemagicmax` , `includemagicname` , `includemagicuses` , `includemagiccost` , `includemagicekrcost`, `present`, `add_time`,`sowner`,`letter`,`ekr_flag`,`img_big`,`rareitem`,`unik`
							)
							VALUES
							('".date("Y-m-d H:i:s")."',30,'{$dress['prototype']}','{$tonick['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']}, {$dress['ecost']}, '{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
							'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}',
							'{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}','{$dress['nalign']}','".$goden_do."',
							'{$goden}','{$dress['razdel']}','{$dress['group']}','{$dress['mfbonus']}','{$dress['stbonus']}','{$dress['gmp']}','{$tonick['id_city']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$dress['includemagic']}' , '{$dress['includemagicdex']}' , '{$dress['includemagicmax']}' , '{$dress['includemagicname']}' , '{$dress['includemagicuses']}' , '{$dress['includemagiccost']}' , '{$dress['includemagicekrcost']}', '{$dress['present']}',".time().",'{$dress['sowner']}', '{$dress['letter']}', '{$dress['ekr_flag']}', '{$dress['img_big']}', '{$dress['rareitem']}','{$dress['unik']}'
							) ;");

 if (mysql_affected_rows()>0)	
						{
							$dress[id]=mysql_insert_id();
							//new_delo
		  		    			$rec['owner']=$tonick[id];
							$rec['owner_login']=$tonick[login];
							$rec['owner_balans_do']=$tonick['money'];
							$rec['owner_balans_posle']=$tonick['money'];
							$rec['target']=$dil[id];
							$rec['target_login']=$dil[login];
							$rec['type']=54;//получил предмет от диллера
							$rec['sum_kr']=0;
							$rec['sum_ekr']=$dress['ecost'];
							$rec['sum_kom']=0;
							$rec['item_id']=get_item_fid($dress);
							$rec['item_name']=$dress[name];
							$rec['item_count']=1;
							$rec['item_type']=$dress['type'];
							$rec['item_cost']=$dress['cost'];
							$rec['item_dur']=$dress['duration'];
							$rec['item_maxdur']=$dress['maxdur'];
							$rec['item_ups']=$dress['ups'];
							$rec['item_unic']=$dress['unic'];
							$rec['item_incmagic']=$dress['includemagicname'];
							$rec['item_incmagic_count']=$dress['includemagicuses'];
							$rec['item_arsenal']='';
							$rec['bank_id']='';
							$rec['item_proto']=$dress['prototype'];
							$rec['item_sowner']=($dress['sowner']>0?1:0);
							$rec['item_incmagic_id']=$dress['includemagic'];
							add_to_new_delo($rec); //юзеру
							
							if ($msg_off==0) { telepost_new($tonick,'<font color=red>Внимание!</font> Вам передан предмет <b>'.$dress[name].'</b> '.$str1.'. Спасибо за покупку!');	 }
							
						return	true;
						}
return false;
}

function present_bonus_sert($telo,$dill,$code='CP1251')
	{

			$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='541' ;"));
				if ($code!='CP1251')
				{
				$dress['present']=iconv("UTF-8","CP1251",'Удача');					
				}
				else
				{
				$dress['present']='Удача';
				}
			$dress['dategoden']=mktime(23,59,59,8,31,2016); 
			$dress['goden']=round(($dress['dategoden']-time())/60/60/24); if ($dress['goden']<1) {$dress['goden']=1;}
			for ($i=0;$i<4;$i++) 
						{
						by_item_bank_dil($telo,$dress,$dill,1);
						}
			if ($i>0)	
				{
					if ($code!='CP1251')
					{
					$mesg=iconv("UTF-8","CP1251",'Внимание!</font> Вам передан предмет');					
					}
					else
					{
					$mesg='Внимание!</font> Вам передан предмет';
					}
				
				telepost_new($telo,'<font color=red>'.$mesg.' <b>'.$dress[name].'</b> '.$i.' шт. ');	 
				}

			$dress=mysql_fetch_array(mysql_query("select * from oldbk.shop where id='540' ;"));

			if ($code!='CP1251')
				{
				$dress['present']=iconv("UTF-8","CP1251",'Удача');					
				}
				else
				{
				$dress['present']='Удача';
				}
			$dress['dategoden']=mktime(23,59,59,8,31,2016); 
			$dress['goden']=round(($dress['dategoden']-time())/60/60/24); if ($dress['goden']<1) {$dress['goden']=1;}			
			for ($i=0;$i<4;$i++) 
						{
						by_item_bank_dil($telo,$dress,$dill,1);
						}							
			if ($i>0)	
				{
					if ($code!='CP1251')
					{
					$mesg=iconv("UTF-8","CP1251",'Внимание!</font> Вам передан предмет');					
					}
					else
					{
					$mesg='Внимание!</font> Вам передан предмет';
					}
				
				telepost_new($telo,'<font color=red>'.$mesg.' <b>'.$dress[name].'</b> '.$i.' шт. ');	 
				}
	}

function act_x2bonus_limit($telo,$type,$k)
{
$stl=100+$type;
$getset=mysql_fetch_array(mysql_query("select * from oldbk.stol where owner='{$telo['id']}' and stol='{$stl}' "));
if ($getset['count']>0)
	{
	//есть зарубка для данного типа 
	return false;
	}
	else
	{
	//зарубки нет
	// лимиты типы 1- екры  2-репа  3-монеты
	//(максимум 15 екр, 9000 репутации, 300 золотых монет)
	$limits[1]=15;
	$limits[2]=9000;
	$limits[3]=300;
	$limits=$limits[$type];
	if ($k>$limits)
		{
		$k=$limits;
		}
	//делаем зарубку
	mysql_query("INSERT INTO `oldbk`.`stol` SET `owner`='{$telo['id']}' ,`stol`='{$stl}',`count`='{$k}';");
	 if (mysql_affected_rows()>0)	
	 	{
 		return $k;
	 	}	
	}
return false;
}

function get_buy_bilet($telo,$fsize,$cost,$selname)
{

	//тест кол.билетов
	$last_bil_id=mysql_fetch_array(mysql_query("select id from bilet ORDER by id desc limit 1;"));
	
	if ($last_bil_id[id]<70)
	{
				
     	 if (($telo[align] !=4) and ($telo[block] ==0) )
     	  {
     	  $ttdate=date("Y-m-d H:i:s",time());
     	  
 	    $vip=0;
 	    mysql_query("INSERT INTO `oldbk`.`bilet` SET `selname`='{$selname}',`owner_nick`='{$telo[login]}',`owner`='{$telo[id]}',`fio`='',`vip`='{$vip}',`price`='{$cost}',`sdate`='{$ttdate}', `fsize`='{$fsize}' ;");

 	    	
 	    	
	 	if (mysql_affected_rows()>0)	 	    	
 	    	 {
			$bil_id=mysql_insert_id();
			$bil_name="".(($vip>0)?"VIP ":"")."Билет №$bil_id на 8-летие ОлдБК.";
		        $bil_text="<b>".$bil_name."</b><br>Приглашаем на празднование 8-ой годовщины ОлдБК, которое состоится 20.01.2018 в 17:00 в BBQ & Grill Club \"Мустанг\" по адресу: Республика Беларусь, Минский район, Ждановичи (2км трассы Минск-Молодечно).<br><i>С уважением, Администрация ОлдБК</i>";
	        
			mysql_query("INSERT INTO oldbk.`inventory` (`owner`,`name`,`type`,`massa`,`cost`,`img`,`letter`,`maxdur`,`isrep`,`present`,  `prototype`,  `notsell`,`can_drop` )VALUES('{$telo[id]}','{$bil_name}','50',0,0,'8_year.gif','{$bil_text}',1,0,'Администрация ОлдБК', 1238, 1, 0) ;");
 	    	 
	 	    	 if (mysql_affected_rows()>0)	 	    	
	 		    	 {
				telepost_new($telo,'<font color=red>Внимание!</font> Вам передан <b>Пригласительный билет на 8-летие ОлдБК</b>!');	
				return "Выдан билет №{$bil_id}, для персонажа {$telo['login']}.";
				}
		 	    	 else
		 	    	 {
		 	    	 echo "err 2";
		 	    	 }
 	    	 }
 	    	 else
 	    	 {
 	    	 echo "err 1";
 	    	 }

 	  }
	}

return false;
}
















?>