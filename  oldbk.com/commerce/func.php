<?

$nclass_name[0]='Любой';     //неопределен = старые предметы
$nclass_name[1]='Уворотчик';
$nclass_name[2]='Критовик';
$nclass_name[3]='Танк';
$nclass_name[4]='Любой';     //любой только класс = новые предметы



function log_sql_tmp($text)
{

	$fp = fopen ("/www/kom_log.txt","a"); //открытие
	flock ($fp,LOCK_EX); //БЛОКИРОВКА ФАЙЛА
	fputs($fp , $text."\n"); //работа с файлом
	fflush ($fp); //ОЧИЩЕНИЕ ФАЙЛОВОГО БУФЕРА И ЗАПИСЬ В ФАЙЛ
	flock ($fp,LOCK_UN); //СНЯТИЕ БЛОКИРОВКИ
	fclose ($fp); //закрытие
}

function ClassToIco($class) {
	if ($class == 1) {
		return "ico_vert.gif";
	} elseif ($class == 2) {
		return "ico_krit.gif";
	} elseif ($class == 3) {
		return "ico_tank.gif";
	} else {
		return "ico_any.gif";
	}
}

function IsAdmin() {
	global $user;
	if ($user=="Архитектор" or $user=='Bred' or $user=='Подмастерье'  or $user=='Пресс-секретарь' or $user=='ICE QUEEN' or $user=='Байт' or $user == 'Анестезиолог') { //or $user=='Портной'
		return 1;
	} else {
		return false;
	}

}

function display_kazna($clan_id)
{
 $kazna=clan_kazna_have($clan_id);
  if ($kazna)
   {
   echo "<center><b>В клановой казне: <font color=#003388>".$kazna[kr]."</font> кр. и <font color=#003388>".$kazna[ekr]."</font> екр.</b></center><br>";
   return true;
   }

return false;
}

function clan_kazna_have($clan_id)
{
  $get_k=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.clans_kazna WHERE `clan_id` = '{$clan_id}' ;"));

  if ($get_k[0] >0)
   {
    if ($get_k[ban]==1)
    {
    //казна в бане
    echo "<font color=red>Внимание!Казна клана временно заморожена!</font>";
    return false;
    }
     else
     {
     return $get_k;
     }
   }
   else
   {
   return false;
   }

}



function by_from_kazna($clan_id,$type,$sum,$coment,$user)
 {

 if ($type==1)
	 {
	 //кредовя
		$ktyle='`kr`'; $str_type='кр.'; $rtype='kr';
	 }
	 elseif ($type==2)
	 {
	 //екровая
	 	$ktyle='`ekr`'; $str_type='екр.';  $rtype='ekr';
	 }
	 else
	 {
	   return false;
	 }

  $in_kaza=clan_kazna_have($clan_id);
  if ( ($in_kaza) and ($in_kaza[$rtype]>=$sum))
     {
	if (mysql_query("UPDATE oldbk.clans_kazna set {$ktyle}={$ktyle}-{$sum}   WHERE `clan_id` = '{$clan_id}' ;"))
    	{
    	  // записать в дело казны
           $txt="\"".$user['login']."\" заплатил из клан казны {$user[klan]}, ".$sum." ".$str_type." ".$coment;
           txt_to_kazna_log(2,$type,$clan_id,$txt,$user);
 	   return true;
   	 }
   	 else
   	 {
   	   return false;
   	 }
     }
     else
      {
       echo " В клановой казне недостаточно ".$str_type." для оплаты!";
   	   return false;
      }

 }

function txt_to_kazna_log($met,$type,$clan_id,$txt,$user_s)
 {
  if ( mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)
   VALUES  ('{$met}','{$type}','{$clan_id}','{$user_s[id]}','".$txt."','".time()."');"))
      {
      return true;
      }
      else
      {
      return false;
      }
 }

function addchp ($text,$who,$room=0,$city=-1) {

			$city=$city+1;
			$txt_to_file=":[".time()."]:[{$who}]:[".($text)."]:[".$room."]";
			$room=-1;
			$q = mysql_query("INSERT INTO `oldbk`.`chat` SET `text`='".mysql_real_escape_string($txt_to_file)."',`city`='".($city)."', `room`={$room} ;");
			if ($q !== FALSE) return true;
			return false;
}



function serr($text) {
	echo '<font color=red>'.$text.'</font><BR>';
}

function serre($text) {
return  '<font color=red>'.$text.'</font><BR>';
}


function systemtotelo($art_telo,$text) {
	if ($art_telo['odate'] > (time()-60)) {
		addchp('<font color=red>Внимание!</font> '.mysql_real_escape_string($text).'.','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
	} else {
		mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> ".mysql_real_escape_string($text).".');");
	}

}

function get_xitem_fid($row) {
	$c[0]='cap';
	$c[1]='ava';
	$c[2]='ang';
	$out=$c[$row['idcity']].$row[id];

	return $out;
}

function mk_yes_forart($yes_id)
{
global $user;
	   		//одобряем
	   		mysql_query("UPDATE `oldbk`.`art_prototype` SET `art_status`=2, `art_moder`='{$user}' , `art_mod_date`=NOW()  WHERE `id`='{$yes_id}' and `art_status`=1 ;");

			if (mysql_affected_rows()>0) {
		 		// Upload img to cloud

		  		// Добавляем арт в магазин в shop
		 		$get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$yes_id}'"));
				$get_proto[name]=htmlspecialchars($get_proto[name],ENT_COMPAT | ENT_HTML401,"cp1251");


				if (!(strpos($get_proto[img], 'art_temp') !== false) )
				{
				//закачка если не стандартная картинка
		 		$basedir = './upload/';
		 		CloudPut($basedir.$get_proto[img],'oldbkstatic','i/sh/');
		 		CloudSetACL('oldbkstatic','i/sh/',$get_proto[img],"public");
		 		}



				mysql_query("INSERT INTO `oldbk`.`shop` SET `id`='{$get_proto[id]}',
				  `name`='".mysql_real_escape_string($get_proto[name])."', `duration`='{$get_proto[duration]}',`maxdur`='{$get_proto[maxdur]}',
				  `cost`='{$get_proto[cost]}',`count`=0,`avacount`=0,
				  `nlevel`='{$get_proto[nlevel]}',`nsila`='{$get_proto[nsila]}',`nlovk`='{$get_proto[nsila]}',`ninta`='{$get_proto[ninta]}',`nvinos`='{$get_proto[nvinos]}',
				  `nintel`='{$get_proto[nintel]}',`nmudra`='{$get_proto[nmudra]}',`nnoj`='{$get_proto[nnoj]}',`ntopor`='{$get_proto[ntopor]}',`ndubina`='{$get_proto[ndubina]}',`nmech`='{$get_proto[nmech]}',
				  `nalign`='{$get_proto[nalign]}',`minu`='{$get_proto[minu]}',`maxu`='{$get_proto[maxu]}',
				  `gsila`='{$get_proto[gsila]}',`glovk`='{$get_proto[glovk]}',`ginta`='{$get_proto[ginta]}',`gintel`='{$get_proto[gintel]}',
				  `ghp`='{$get_proto[ghp]}',`gmp`='{$get_proto[gmp]}',`mfkrit`='{$get_proto[mfkrit]}',`mfakrit`='{$get_proto[mfakrit]}',`mfuvorot`='{$get_proto[mfuvorot]}',`mfauvorot`='{$get_proto[mfauvorot]}',
				  `gnoj`='{$get_proto[gnoj]}',`gtopor`='{$get_proto[gtopor]}',`gdubina`='{$get_proto[gdubina]}',`gmech`='{$get_proto[gmech]}',`img`='{$get_proto[img]}',
				  `shshop`=0,`bron1`='{$get_proto[bron1]}',`bron2`='{$get_proto[bron2]}',`bron3`='{$get_proto[bron3]}',`bron4`='{$get_proto[bron4]}',
				  `dategoden`=0,`magic`=0,`type`='{$get_proto[type]}',`massa`='{$get_proto[massa]}',`goden`=0,`needident`=0,
				  `nfire`='{$get_proto[nfire]}',`nwater`='{$get_proto[nwater]}',`nair`='{$get_proto[nair]}',`nearth`='{$get_proto[nearth]}',`nlight`='{$get_proto[nlight]}',
				  `ngray`='{$get_proto[ngray]}',`ndark`='{$get_proto[ndark]}',`gfire`='{$get_proto[gfire]}',`gwater`='{$get_proto[gwater]}',`gair`='{$get_proto[gwater]}',
				  `gearth`='{$get_proto[gearth]}',`glight`='{$get_proto[glight]}',`ggray`='{$get_proto[ggray]}',`gdark`='{$get_proto[gdark]}',`letter`='',
				  `isrep`=1,`razdel`='{$get_proto[otdel]}',`gmeshok`=0,`group`=0,`wopen`=0,`ab_mf`=0,`ab_bron`=0,`ab_uron`=0,`need_wins`=0,`artproto`=0, `nclass`='{$get_proto[nclass]}'  ;");

		  		// добавляем в инвентарь

				if ($get_proto[owner]==22125) {
		  			//если клан арт
		  			$kol=5; //кидаем 5 штук.
		  		} else {
		  			$kol=1; //1 шт. - не трогать
		  		}

				//ищем заказчика
		  		if ($get_proto[owner]==22125) {

		  			$art_telo=mysql_fetch_assoc(mysql_query("select * from oldbk.users where id=(select glava from oldbk.clans where short='{$get_proto[arsenal_klan]}');"));
		  			$str_type=' клановый артефакт для клана \"'.$get_proto[arsenal_klan].'\", доставлен в клановый арсенал в кол. '.$kol.' шт.';

		  			//добавляем абилки телепорта для клана
		  			$clan_id= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `short` = '".$get_proto[arsenal_klan]."'  ;"));


		  		} else {
		  			$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_proto[owner]."'  ;"));
					$str_type=' личный артефакт для персонажа \"'.$art_telo[login].'\", доставлен в инвентарь в кол. '.$kol.' шт.';
		  		}

				$i = 0;
				while ($i<$kol) {
		     			if ($get_proto[nlevel]>6) {
		     				$uplevel=$get_proto[nlevel];
		     			} else {
		     				$uplevel=6;
		     			}

					$price_item_ecost=500;//что запишет в инвентарь

					if (($get_proto['veks_flag']==2) OR ($get_proto['veks_flag']==3) OR ($get_proto['veks_flag']==5) OR ($get_proto['veks_flag']==4) OR ($get_proto['veks_flag']==9)) // выдача одинаковая для обоих вариантов
					{

						$get_old_art=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$get_proto['t_id']}' and owner=450"));
						if ($get_old_art['id']>0)
						{
							if ($get_old_art['unik']>1)
								{
								$get_proto['unik']=$get_old_art['unik'];
								if ($get_proto['unik']==2) { $get_proto['stbonus']+=1; }
								}
     		//					$get_proto['ekr_flag'] = $get_old_art['ekr_flag'];
           							$get_proto['ekr_flag'] = 0 ; //при успешном обмене в любом случае не сохранять екрфлаг на новом арте, цену ставить реповую 300000 реп.
           							$get_proto['repcost'] = 300000;
						//тут если обмен арта , надо перенести встройку со старого арта
								if ( ($get_old_art['includemagic']>0) AND ($get_old_art['includemagicuses']>0)  )
								{
									$get_proto['includemagic']=$get_old_art['includemagic'];
									$get_proto['includemagicdex']=$get_old_art['includemagicdex'];
									$get_proto['includemagicmax']=$get_old_art['includemagicmax'];
									$get_proto['includemagicname']=$get_old_art['includemagicname'];
									$get_proto['includemagicuses']=$get_old_art['includemagicuses'];
									$get_proto['includemagiccost']=$get_old_art['includemagiccost'];
									$get_proto['includemagicekrcost']=$get_old_art['includemagicekrcost'];
									$get_proto['includerechargetype']=$get_old_art['includerechargetype'];
									$get_proto['includeprototype']=$get_old_art['includeprototype'];
									$get_proto['nintel']=$get_proto['nintel']<$get_old_art['nintel']?$get_old_art['nintel']:$get_proto['nintel'];
									$get_proto['nmudra']=$get_proto['nmudra']<$get_old_art['nmudra']?$get_old_art['nmudra']:$get_proto['nmudra'];
									$get_proto['nfire']=$get_proto['nfire']<$get_old_art['nfire']?$get_old_art['nfire']:$get_proto['nfire'];
									$get_proto['nwater']=$get_proto['nwater']<$get_old_art['nwater']?$get_old_art['nwater']:$get_proto['nwater'];
									$get_proto['nair']=$get_proto['nair']<$get_old_art['nair']?$get_old_art['nair']:$get_proto['nair'];
									$get_proto['nearth']=$get_proto['nearth']<$get_old_art['nearth']?$get_old_art['nearth']:$get_proto['nearth'];
									$get_proto['nlight']=$get_proto['nlight']<$get_old_art['nlight']?$get_old_art['nlight']:$get_proto['nlight'];
									$get_proto['ngray']=$get_proto['ngray']<$get_old_art['ngray']?$get_old_art['ngray']:$get_proto['ngray'];
									$get_proto['ndark']=$get_proto['ndark']<$get_old_art['ndark']?$get_old_art['ndark']:$get_proto['ndark'];
								}
							if (($get_old_art['type']==3) and  (strpos($get_old_art['name'], '+') !== false) and ($get_old_art['sharped'] == "1")  )
								{
								// если была заточка то вернуть заточку челу

										// выдаем свиток
										// проверяем заточку
											preg_match('~\+([\d]+)~iU',$get_old_art['name'],$m);
											if (isset($m[1])) {
												// есть заточка
												// топор - 11
												// дубина - 12
												// кинжал - 1
												// мечи - 13
												$otdel = $get_old_art['otdel'];

												$z = array(
													1 => array(
														1 => 163,
														2 => 164,
														3 => 165,
														4 => 166,
													),
													11 => array(
														1 => 157157,
														2 => 156156,
														3 => 155,
														4 => 154,
													),
													12 => array(
														1 => 158,
														2 => 159,
														3 => 160,
														4 => 161,
													),
													13 => array(
														1 => 150,
														2 => 151,
														3 => 152,
														4 => 153,
													),
												);
												$zz = array(5 => 8090, 6 => 9099, 7 => 190199, 8=>190191, 9=>190192);
												/*
												точки которые привяжут
												9099 Заточка оружия +6
												190199 Заточка оружия +7

												точки которые не привяжут
												6 => 9090, 7 => 190190,

												*/
												$sowner=0;
												if (($m[1]==6) or ($m[1]==7) or ($m[1]==8) or ($m[1]==9))
												{
													$dress = mysql_query('SELECT * FROM oldbk.cshop WHERE id = '.$zz[$m[1]]) or die("Errr00011");
													$sowner=$art_telo[id];
												}
												elseif ($m[1] <= 4) {
													$dress = mysql_query('SELECT * FROM oldbk.shop WHERE id = '.$z[$get_old_art['otdel']][$m[1]]) or die("Errr0001");
												} else {
													$dress = mysql_query('SELECT * FROM oldbk.eshop WHERE id = '.$zz[$m[1]]) or die("Errr00011");
												}

												$dress = mysql_fetch_assoc($dress);

												if ($dress !== FALSE) {
													mysql_query("INSERT INTO oldbk.`inventory`
														(`present`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
														`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
														`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
														`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`,`img_big`
														)
														VALUES
														('КО','{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
														'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
														'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
														,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$sowner}','{$dress['img_big']}'
														);
													") or die();

													//new_delo
													$rec = array();
								  		    			$rec['owner']=$art_telo[id];
													$rec['owner_login']=$art_telo[login];
													$rec['owner_balans_do']=$art_telo['money'];
													$rec['owner_balans_posle']=$art_telo['money'];
													$rec['target_login']="КО";
													$rec['type']=99; // получил предмет
													$rec['sum_kr']=0;
													$rec['sum_ekr']=0;
													$rec['sum_kom']=0;
													$rec['item_id']=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id()));
													$rec['item_name']=$dress[name];
													$rec['item_count']=1;
													$rec['item_type']=$dress['type'];
													$rec['item_cost']=$dress['cost'];
													$rec['item_dur']=$dress['duration'];
													$rec['item_maxdur']=$dress['maxdur'];
													$rec['item_ups']=$dress['ups'];
													$rec['item_unic']=$dress['unic'];
													$rec['item_incmagic']=$dress['includemagicname'];
													$rec['item_incmagic_count']=$dress['includemagicuses'];
													$rec['item_arsenal']='';
													$rec['item_proto']=$dress['prototype'];
													$rec['item_sowner']=($dress['sowner']>0?1:0);
													$rec['item_incmagic_id']=$dress['includemagic'];
													if (add_to_new_delo($rec) === FALSE) die();

													$message.=serre("- успешно выдан свиток ".$dress['name']);
													systemtotelo($art_telo,"Успешно выдан свиток ".$dress['name']);
												}

												}
											}

						//удаляем старый арт
						 mysql_query("DELETE FROM `oldbk`.`inventory` WHERE `id`='{$get_old_art['id']}' LIMIT 1; ");
						}
						else
						{
						echo "<font color=red>Внимание! Старый Артефакт не найден!</font>";
						}

					}





					mysql_query("INSERT INTO `oldbk`.`inventory` SET
						`name`='".mysql_real_escape_string($get_proto[name])."',
						`duration`='{$get_proto[duration]}',`maxdur`='{$get_proto[maxdur]}',`cost`='{$get_proto[cost]}',`owner`='{$get_proto[owner]}',
						`nlevel`='{$get_proto[nlevel]}',`nsila`='{$get_proto[nsila]}',`nlovk`='{$get_proto[nlovk]}',`ninta`='{$get_proto[ninta]}',`nvinos`='{$get_proto[nvinos]}',`nintel`='{$get_proto[nintel]}',
						`nmudra`='{$get_proto[nmudra]}',`nnoj`='{$get_proto[nnoj]}',`ntopor`='{$get_proto[ntopor]}',`ndubina`='{$get_proto[ndubina]}',`nmech`='{$get_proto[nmech]}',
						`nalign`='{$get_proto[nalign]}',`minu`='{$get_proto[minu]}',`maxu`='{$get_proto[maxu]}',
						`gsila`='{$get_proto[gsila]}',`glovk`='{$get_proto[glovk]}',`ginta`='{$get_proto[ginta]}',
						`gintel`='{$get_proto[gintel]}',`ghp`='{$get_proto[ghp]}',
						`mfkrit`='{$get_proto[mfkrit]}',`mfakrit`='{$get_proto[mfakrit]}',`mfuvorot`='{$get_proto[mfuvorot]}',`mfauvorot`='{$get_proto[mfauvorot]}',
						`gnoj`='{$get_proto[gnoj]}',`gtopor`='{$get_proto[gtopor]}',`gdubina`='{$get_proto[gdubina]}',`gmech`='{$get_proto[gmech]}',
						`img`='{$get_proto[img]}',`text`='',`dressed`=0,
						`bron1`='{$get_proto[bron1]}',`bron2`='{$get_proto[bron2]}',`bron3`='{$get_proto[bron3]}',`bron4`='{$get_proto[bron4]}',
						`dategoden`=0,`magic`=0,
						`type`='{$get_proto[type]}',
						`present`='',`sharped`=0,
						`massa`='{$get_proto[massa]}',
						`goden`=0,`needident`=0,
						`nfire`='{$get_proto[nfire]}',`nwater`='{$get_proto[nwater]}',`nair`='{$get_proto[nair]}',`nearth`='{$get_proto[nearth]}',`nlight`='{$get_proto[nlight]}',`ngray`='{$get_proto[ngray]}',
						`ndark`='{$get_proto[ndark]}',`gfire`='{$get_proto[gfire]}',`gwater`='{$get_proto[gwater]}',`gair`='{$get_proto[gair]}',`gearth`='{$get_proto[gearth]}',`glight`='{$get_proto[glight]}',`ggray`='{$get_proto[ggra]}',`gdark`='{$get_proto[gdark]}',
						`letter`='',`isrep`=1,`update`=NOW(),`setsale`=0,
						`prototype`='{$get_proto[prototype]}',
						`otdel`='{$get_proto[otdel]}',`bs`=0,	`gmp`='{$get_proto[gmp]}',
						`includemagic`='{$get_proto['includemagic']}',`includemagicdex`='{$get_proto['includemagicdex']}',`includemagicmax`='{$get_proto['includemagicmax']}',`includemagicname`='{$get_proto['includemagicname']}',`includemagicuses`='{$get_proto['includemagicuses']}',`includemagiccost`='{$get_proto['includemagiccost']}',`includemagicekrcost`='{$get_proto['includemagicekrcost']}',
						`gmeshok`=0,`tradesale`=0,`karman`=0,
						`stbonus`={$get_proto[stbonus]},`upfree`=0,`ups`=5,
						`mfbonus`={$get_proto[mfbonus]},`mffree`=0,
						`type3_updated`=1,`bs_owner`=0,`nsex`=0,
						`present_text`='',`add_time`=0,`labonly`=0,`labflag`=0,`prokat_idp`=0,`prokat_do`=0,
						`arsenal_klan`='{$get_proto[arsenal_klan]}',`arsenal_owner`='{$get_proto[arsenal_owner]}',
						`repcost`='{$get_proto[repcost]}',
						`up_level`='{$uplevel}',
						`ecost`='{$price_item_ecost}',
						`group`=0,`ekr_up`='{$get_proto[ekr_up]}',
						`unik`='{$get_proto[unik]}',
						`ekr_flag`='{$get_proto[ekr_flag]}',
						`add_pick`='',`pick_time`=0,
						`sowner`='{$get_proto[sowner]}',
						`includerechargetype`='{$get_proto[includerechargetype]}',
						`includeprototype`='{$get_proto[includeprototype]}',
						`idcity`=0,`battle`=0,`t_id`=0,
						`ab_mf`='{$get_proto[ab_mf]}',`ab_bron`='{$get_proto[ab_bron]}',`ab_uron`='{$get_proto[ab_uron]}',
						`art_param` ='{$get_proto[art_param]}' , `nclass`='{$get_proto[nclass]}'  ;");



					if (mysql_affected_rows()>0)
					{




				  		if ($get_proto[owner]==22125) {
				  			//пишем в таб. арсенала+лог
				  			$inserted_id=mysql_insert_id();
							mysql_query("INSERT INTO oldbk.clans_arsenal (id_inventory, klan_name, owner_original, gift) VALUES  ('{$inserted_id}','{$get_proto[arsenal_klan]}','1','0')");
							$log_text = 'Куплен в арсенал клановый артефакт "'.$get_proto[name].'"  ['.$get_proto[duration].'/'.$get_proto[maxdur].'] [ups:'.$get_proto['ups'].'/unik:'.$get_proto['unik'].'/inc:'.$get_proto['includemagicname'].']';
							mysql_query("INSERT INTO oldbk.clans_arsenal_log (klan,pers,text,date) VALUES ('{$get_proto[arsenal_klan]}','1','{$log_text}','".time()."')");
				  		} else {
  				  			$inserted_id=mysql_insert_id();
						  	//пишем в переводы о том что чел получил арт
	  		    				$rec['owner']=$art_telo[id];
							$rec['owner_login']=$art_telo[login];
							$rec['owner_balans_do']=$art_telo['money'];
							$rec['owner_balans_posle']=$art_telo['money'];
							$rec['target']=0;
							$rec['target_login']='КО';

								if ($get_proto['veks_flag']==3)
								{
								$rec['type']=390;//получил предмет
								}
								elseif ($get_proto['veks_flag']==2)
								{
								$rec['type']=390;//получил предмет
								}
								else
								{
								$rec['type']=354;//получил предмет
								}
								$rec['sum_kr']=0;

							 	if (($art_telo['klan']=='minion') /*OR ($art_telo['klan']=='Animals')  OR ($art_telo['klan']=='LastLegion') */)
							 	{
								$rec['sum_ekr']=0;
								$rec['sum_rep']=0;
							 	}
							 	else
							 	{
								$rec['sum_ekr']=$get_proto[ecost];
								$rec['sum_rep']=$get_proto[repcost];
								}
							$rec['sum_kom']=0;
							$rec['item_id']='cap'.$inserted_id;
							$rec['item_name']=$get_proto[name];
							$rec['item_count']=$kol;
							$rec['item_type']=$get_proto[type];
							$rec['item_cost']=$get_proto[cost];
							$rec['item_dur']=$get_proto[duration];
							$rec['item_maxdur']=$get_proto[maxdur];
							$rec['item_ups']=$get_proto[ups];
							$rec['item_unic']=$get_proto[unik];
							$rec['item_incmagic']=$get_proto['includemagicname'];
							$rec['item_incmagic_count']=$get_proto['includemagicuses'];
							$rec['item_arsenal']='';
							$rec['bank_id']='';
							if ($get_old_art['id']>0)
								 {
								 $rec['add_info']="Обмен старого:".$get_old_art['name']." ".get_xitem_fid($get_old_art);

								 }
							add_to_new_delo($rec); //юзеру
						}

						//обновляем данные о прототипе
						if ($inserted_id>0)
							{
							mysql_query("UPDATE `oldbk`.`art_bonus` SET `itemid`= '{$inserted_id}'  WHERE `itemid`='{$get_proto['id']}' ");
							}

			 			$i++;
				 	}
		 		}


				//сообщение заказчику или главе клана о том что арт одобрен $kol
				if ($art_telo['odate'] > (time()-60)) {
					addchp('<font color=red>Внимание!</font> Вам одобрен '.$str_type.' ','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
				} else {
					mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вам одобрен {$str_type} ');");
				}

		 	if (($get_old_art['id']>0) and ($inserted_id>0) )
		 	{
			 	if (($art_telo['klan']=='minion') /*OR ($art_telo['klan']=='Animals')  OR ($art_telo['klan']=='LastLegion')*/ )
			 		{
					 move_art_bonus($get_old_art['id'],$inserted_id,true);
			 		}
			 		else
			 		{
					 move_art_bonus($get_old_art['id'],$inserted_id); // установка бонуса арта если он был со старого на новый
					 }
			}

		  		echo "<font color=red>Артефакт удачно одобрен!</font>";

		 	} else {
		 		echo "<font color=red>Этот артефакт уже одобрен</font>";
		 	}

}


function move_art_bonus($olditem,$newitem,$f=false)
{
//устанавливает  бонус со старого арта на новый если на старом он есть
//нужно использовать после создания нового арта ,старый арт должен быть удален
//echo "MV_D0";
	//1. сомтрим есть ли бонус
		$get_bonus=mysql_fetch_array(mysql_query("select * from oldbk.art_bonus where itemid='{$olditem}' "));
		if (($get_bonus['itemid']>0) and ($get_bonus['info']!='') )
			{

					/*
					if ($f==true)
					{

					$remb=$get_bonus['info'];
					$get_bonus['info']=str_replace('s:6:"gtopor"','s:7:"gdubina"',$get_bonus['info']);

					if ($remb!=$get_bonus['info']) {

											mysql_query("UPDATE `oldbk`.`art_bonus` SET `info`= '{$get_bonus['info']}'  WHERE `itemid`='{$olditem}' ");
											}
					}
					*/


			$bonus_array=unserialize($get_bonus['info']); // получаем масив


				if (is_array($bonus_array))
						{
						//
						$upsql="";
							 foreach($bonus_array as $blevel=>$dat)
							 	{
							 	//проход по уровням
										 foreach($dat as $k=>$v)
										 	{




												 	//проход по данным
													$upsql.=" `{$k}`=`{$k}`+{$v} ,";
									 	 	}
							 	}
							 	 $upsql= substr($upsql,0,-1);
								mysql_query("UPDATE oldbk.inventory SET $upsql WHERE id= '{$newitem}' "); // делаем апдейт на новый предмет
								if (mysql_affected_rows()>0)
									{

										//проверяем есть ли запись нового в бонусах
										$get_bonus_new_item=mysql_fetch_array(mysql_query("select * from oldbk.art_bonus where itemid='{$newitem}' "));

										if ($get_bonus_new_item['itemid']>0)
											{
											// есть - надо делать апдейт
												mysql_query("UPDATE `oldbk`.`art_bonus` SET  blevel='{$get_bonus['blevel']}' , info='{$get_bonus['info']}'  WHERE `itemid`='{$newitem}' ");
												if (mysql_affected_rows()>0)
													{
													//удаляем инфу по старому бонусу
													mysql_query("DELETE FROM `oldbk`.`art_bonus` WHERE `itemid`='{$olditem}' LIMIT 1;");

														return true;
													}
											}
											else
											{
											//в новом данных нет
											//меняем ид предмета в табл. арт_бонус на новый ид

											if (mysql_affected_rows()>0)
													{
													return true;
													}
													else
													{
													//echo "MV_D4";
													}
											}
									}
									else
									{
									//echo "MV_D3";
									}
						}
						else
						{
						//echo "MV_D2";
						}


			}
			else
			{
			//echo "MV_D1";
			}

return false;
}



function check_bank_id($bankid,$teloid)
{

	if ($bankid>0)
	{
	return $bankid;
	}
	else
	{
	$get_id_bank=mysql_fetch_array(mysql_query("select * from oldbk.bank where owner='{$teloid}' order by id desc LIMIT 1;"));
		if ($get_id_bank['id']>0)
			{
				return $get_id_bank['id'];
			}
			else
			{
			return 0;
			}
	}
}

function MK_UP_ART($dress,$nup)
{
//функа для расчета апа
$up=array();
$up[7] = array(	"level" => 7, 	"hp" => 6,	"bron" => 1,	"stat" => 1,	"mf" => 5,	"udar" => 1,	"nparam" => 1,	"duration" => 5,	"destiny" => false,	"nintel" => 0	);
$up[8] = array(	"level" => 8,	"hp" => 8,	"bron" => 1,	"stat" => 1,	"mf" => 7,	"udar" => 2,	"nparam" => 1,	"duration" => 5,	"destiny" => false,	"nintel" => 0	);
$up[9] = array(	"level" => 9,	"hp" => 10,	"bron" => 1,	"stat" => 1,	"mf" => 10,	"udar" => 3,	"nparam" => 1,	"duration" => 10,	"destiny" => false,	"nintel" => 0	);
$up[10] = array(	"level" => 10,	"hp" => 12,	"bron" => 1,	"stat" => 1,	"mf" => 12,	"udar" => 4,	"nparam" => 1,	"duration" => 10,	"destiny" => false,	"nintel" => 0	);
$up[11] = array(	"level" => 11,	"hp" => 15,	"bron" => 1,	"stat" => 1,	"mf" => 15,	"udar" => 1,	"nparam" => 1,	"duration" => 15,	"destiny" => false,	"nintel" => 0	);
$up[12] = array(	"level" => 12,	"hp" => 20,	"bron" => 1,	"stat" => 1,	"mf" => 17,	"udar" => 1,	"nparam" => 1,	"duration" => 15,	"destiny" => false,	"nintel" => 0	);
$up[13] = array(	"level" => 13,	"hp" => 27,	"bron" => 1,	"stat" => 1,	"mf" => 22,	"udar" => 2,	"nparam" => 1,	"duration" => 15,	"destiny" => false,	"nintel" => 0 ) ;
$up[14] = array(	"level" => 14, "hp" => 35,	"bron" => 1,	"stat" => 1,	"mf" => 27,	"udar" => 2,	"nparam" => 1,	"duration" => 15,	"destiny" => false,	"nintel" => 0 );

//суммируем все что должно дать
$upgrade=array();
for($i=$dress['nlevel']+1;$i<=$nup;$i++)
	{
	$upgrade['level']=$up[$i]['level'];
	$upgrade['hp']+=$up[$i]['hp'];
	$upgrade['bron']+=$up[$i]['bron'];
	$upgrade['stat']+=$up[$i]['stat'];
	$upgrade['mf']+=$up[$i]['mf'];
	$upgrade['udar']+=$up[$i]['udar'];
	$upgrade['nparam']+=$up[$i]['nparam'];
	$upgrade['duration']+=$up[$i]['duration'];
	}

//новое название
//новое название
			$sharp=explode("+",$dress['name']);
			$basename=$sharp[0];
			if ((int)($sharp[1])>0) {$is_sharp="+".$sharp[1]; } else {$is_sharp='';}
			$newname = $basename." [".$upgrade['level']."]".$is_sharp;

///новые данные шмотки
$dress['name']= $newname;
$dress['nlevel']=$upgrade['level'];
$dress['up_level']=$upgrade['level'];
$dress['maxdur']+=$upgrade['duration'];

		if ($dress['type'] == 3)
			{
			$dress['minu']+=$upgrade['udar'];
			$dress['maxu']+=$upgrade['udar'];
			}
		else
			{
		  	if ($dress['ghp'] > 0) {  $dress['ghp']+=$upgrade['hp']; }
			if ($dress['bron1'] > 0) { $dress['bron1']+=$upgrade['bron']; }
			if ($dress['bron2'] > 0) { $dress['bron2']+=$upgrade['bron']; }
			if ($dress['bron3'] > 0) { $dress['bron3']+=$upgrade['bron']; }
			if ($dress['bron4'] > 0) { $dress['bron4']+=$upgrade['bron']; }
			if (($dress['gsila'] != 0) OR ($dress['glovk']!=0) OR ($dress['ginta']!=0) OR ($dress['gintel']!=0) OR ($dress['stbonus']!=0)) { $dress['stbonus']+=$upgrade['stat']; }
			if (($dress['mfkrit'] !=0) OR ($dress['mfakrit']!=0) OR ($dress['mfuvorot']!=0) OR ($dress['mfauvorot']!=0) OR ($dress['mfbonus']!=0) ) { $dress['mfbonus']+=$upgrade['mf']; }
			}

		if ($dress['nsila'] > 0) { $dress['nsila']+=$upgrade['nparam']; }
		if ($dress['nlovk'] > 0) { $dress['nlovk']+=$upgrade['nparam']; }
		if ($dress['ninta'] > 0) { $dress['ninta']+=$upgrade['nparam']; }
		if ($dress['nvinos'] > 0) { $dress['nvinos']+=$upgrade['nparam']; }
		if ($dress['nnoj'] > 0) { $dress['nnoj']+=$upgrade['nparam']; }
		if ($dress['ntopor'] > 0) { $dress['ntopor']+=$upgrade['nparam']; }
		if ($dress['ndubina'] > 0) { $dress['ndubina']+=$upgrade['nparam']; }
		if ($dress['nmech'] > 0) { $dress['nmech']+=$upgrade['nparam']; }


return $dress;
}


function showiteme($row,$img=false)
  {
	global $nclass_name;

if ($row['nalign']==1) {$row['nalign']='1.5';}


if ($img==true)
	{
	$RET=$row['name'].' ('.get_xitem_fid(array("idcity" => $row['idcity'], "id" => $row['id'])).') ';
	if ($row['ekr_flag']>0)
		{
		$RET.="<b>$</b>";
		}
	}
	else
	{
	$RET=$row['name'].' ('.get_xitem_fid(array("idcity" => $row['idcity'], "id" => $row['id'])).') <img src=https://i.oldbk.com/i/align_'.$row['nalign'].'.gif>';

	if ($row['ekr_flag']>0)
		{

		$RET.="<img src='https://i.oldbk.com/i/berezka06.gif' > ";
		}
	}

	$RET.='<br>';

		if($row['repcost'] > 0 )
		{
		  $RET.= "<b>Цена: {$row['repcost']} реп.</b> &nbsp; &nbsp;";
		}
		else
		if($row['ecost'] > 0 )
		{
		  $RET.= "<b>Цена: {$row['ecost']} екр.</b> &nbsp; &nbsp;";
		}
		 else
		{
		   $RET.= "<b>Цена: {$row['cost']} кр.</b> &nbsp; &nbsp;";
		}

		$RET.= "<BR>Долговечность : {$row['duration']}/{$row['maxdur']}<BR>	";

	if (!$row['needident']) {

	//распаковка масива с арт параметрами
	$art_param=explode(',',$row['art_param']);


		$RET.= (($row['ups']>0)?"Подогнано:<b>{$row['ups']} раз</b><BR>":"");
		$RET.= (($row['stbonus']>0)?"Возможных увеличений:<b>{$row['stbonus']}</b><BR>":"");
		$RET.= (($row['mfbonus']>0)?"Возможных увеличений мф:<b>{$row['mfbonus']}</b><BR>":"");

		$RET.= (($row['goden'])?"Срок годности: {$row['goden']} дн. <BR>":"");
		$RET.=(($row['nsex']==1)?"• Пол: <b>Женский</b><br>":"");
		$RET.=(($row['nsex']==2)?"• Пол: <b>Мужской</b><br>":"");
		$RET.=(($row['nsila'] OR $row['nlovk'] OR $row['ninta'] OR $row['nvinos'] OR $row['nlevel'] OR $row['nintel'] OR $row['nmudra']
		OR $row['nnoj'] OR $row['ntopor'] OR $row['ndubina'] OR $row['nmech'] OR $row['nfire'] OR $row['nwater'] OR $row['nair'] OR $row['nearth'] OR $row['nearth'] OR $row['nlight'] OR $row['ngray'] OR $row['ndark'])?"Требуется минимальное:<BR>":"");
		$RET.=(($row['nsila']>0)?"• Сила: {$row['nsila']}<BR>":"");
		$RET.=(($row['nlovk']>0)?"• Ловкость: {$row['nlovk']}<BR>":"");
		$RET.=(($row['ninta']>0)?"• Интуиция: {$row['ninta']}<BR>":"");
		$RET.=(($row['nvinos']>0)?"• Выносливость: {$row['nvinos']}<BR>":"");
		$RET.=(($row['nlevel']>0)?"<font color=red>• Уровень: {$row['nlevel']}</font><BR>":"");
		$RET.=(($row['nintel']>0)?"• Интеллект: {$row['nintel']}<BR>":"");
		$RET.=(($row['nmudra']>0)?"• Мудрость: {$row['nmudra']}<BR>":"");
		$RET.=(($row['nnoj']>0)?"• Мастерство владения ножами и кастетами: {$row['nnoj']}<BR>":"");
		$RET.=(($row['ntopor']>0)?"• Мастерство владения топорами и секирами: {$row['ntopor']}<BR>":"");
		$RET.=(($row['ndubina']>0)?"• Мастерство владения дубинами и булавами: {$row['ndubina']}<BR>":"");
		$RET.=(($row['nmech']>0)?"• Мастерство владения мечами: {$row['nmech']}<BR>":"");
		$RET.=(($row['nfire']>0)?"• Мастерство владения стихией Огня: {$row['nfire']}<BR>":"");
		$RET.=(($row['nwater']>0)?"• Мастерство владения стихией Воды: {$row['nwater']}<BR>":"");
		$RET.=(($row['nair']>0)?"• Мастерство владения стихией Воздуха: {$row['nair']}<BR>":"");
		$RET.=(($row['nearth']>0)?"• Мастерство владения стихией Земли: {$row['nearth']}<BR>":"");
		$RET.=(($row['nlight']>0)?"• Мастерство владения магией Света: {$row['nlight']}<BR>":"");
		$RET.=(($row['ngray']>0)?"• Мастерство владения серой магией: {$row['ngray']}<BR>":"");
		$RET.=(($row['ndark']>0)?"• Мастерство владения магией Тьмы: {$row['ndark']}<BR>":"");
		if ($row['nclass'] >0) {
				if ($nclass_name[$row['nclass']]!='')
				{
					$RET .= "• Класс персонажа: <b>{$nclass_name[$row['nclass']]}</b><BR>";
				}
		}


		$RET.=(($row['gmeshok'] OR $row['gsila'] OR $row['mfkrit'] OR $row['mfakrit']  OR $row['mfuvorot'] OR $row['mfauvorot']  OR $row['glovk'] OR $row['ghp'] OR $row['ginta'] OR $row['gintel'] OR $row['gnoj'] OR $row['gtopor'] OR $row['gdubina'] OR $row['gmech'] OR $row['gfire'] OR $row['gwater'] OR $row['gair'] OR $row['gearth'] OR $row['gearth'] OR $row['glight'] OR $row['ggray'] OR $row['gdark'] OR $row['minu'] OR $row['maxu'] OR $row['bron1'] OR $row['bron2'] OR $row['bron3'] OR $row['bron4'])?"Действует на:<BR>":"");
		$RET.=(($row['minu'])?"• Минимальное наносимое повреждение: {$row['minu']}<BR>":"");
		$RET.=(($row['maxu'])?"• Максимальное наносимое повреждение: {$row['maxu']}<BR>":"");
		$RET.= (($row['gsila'])?"• Сила: ".(($row['gsila']>0)?"+":"")."{$row['gsila']}<br>":"");
		$RET.=(($row['glovk'])?"• Ловкость: ".(($row['glovk']>0)?"+":"")."{$row['glovk']}<br>":"");
		$RET.=(($row['ginta'])?"• Интуиция: ".(($row['ginta']>0)?"+":"")."{$row['ginta']}<br>":"");
		$RET.=(($row['gintel'])?"• Интеллект: ".(($row['gintel']>0)?"+":"")."{$row['gintel']}<br>":"");
		$RET.=(($row['gmp'])?"• Мудрость: ".(($row['gmp']>0)?"+":"")."{$row['gmp']}<br>":"");
		$RET.= (($row['ghp'])?"• Уровень жизни: +{$row['ghp']}<BR>":"");
		$RET.= (($row['mfkrit'])?"• Мф. критических ударов: ".(($row['mfkrit']>0)?"+":"")."{$row['mfkrit']}%<BR>":"");
		$RET.=(($row['mfakrit'])?"• Мф. против крит. ударов: ".(($row['mfakrit']>0)?"+":"")."{$row['mfakrit']}%<BR>":"");
		$RET.=(($row['mfuvorot'])?"• Мф. увертливости: ".(($row['mfuvorot']>0)?"+":"")."{$row['mfuvorot']}%<BR>":"");
		$RET.=(($row['mfauvorot'])?"• Мф. против увертлив.: ".(($row['mfauvorot']>0)?"+":"")."{$row['mfauvorot']}%<BR>":"");




		if($row['present']!='')
		{
			$prez=explode(':|:',$row['present']);
		}

		$RET.= (($row['gnoj'])?"• Мастерство владения ножами и кастетами: +{$row['gnoj']}<BR>":"");
		$RET.= (($row['gtopor'])?"• Мастерство владения топорами и секирами: +{$row['gtopor']}<BR>":"");
		$RET.= (($row['gdubina'])?"• Мастерство владения дубинами и булавами: +{$row['gdubina']}<BR>":"");
		$RET.= (($row['gmech'])?"• Мастерство владения мечами: +{$row['gmech']}<BR>":"");
		$RET.= (($row['gfire'])?"• Мастерство владения стихией Огня: +{$row['gfire']}<BR>":"");
		$RET.= (($row['gwater'])?"• Мастерство владения стихией Воды: +{$row['gwater']}<BR>":"");
		$RET.= (($row['gair'])?"• Мастерство владения стихией Воздуха: +{$row['gair']}<BR>":"");
		$RET.= (($row['gearth'])?"• Мастерство владения стихией Земли: +{$row['gearth']}<BR>":"");
		$RET.= (($row['glight'])?"• Мастерство владения магией Света: +{$row['glight']}<BR>":"");
		$RET.= (($row['ggray'])?"• Мастерство владения серой магией: +{$row['ggray']}<BR>":"");
		$RET.= (($row['gdark'])?"• Мастерство владения магией Тьмы: +{$row['gdark']}<BR>":"");
		$RET.= (($row['bron1'])?"• Броня головы: {$row['bron1']}<BR>":"");
		$RET.= (($row['bron2'])?"• Броня корпуса: {$row['bron2']}<BR>":"");
		$RET.= (($row['bron3'])?"• Броня пояса: {$row['bron3']}<BR>":"");
		$RET.= (($row['bron4'])?"• Броня ног: {$row['bron4']}<BR>":"")."".(($row['gmeshok'])?"• Увеличивает рюкзак: +{$row['gmeshok']}<BR>":"")."".(($row['letter'])?"Количество символов: ".strlen($row['letter'])."</div>":"")."".(($row['present'])?"<br>Подарок от: <b>".$prez[0]."</b><br>":"")."".(($row['letter'])?"На бумаге записан текст:<div style='background-color:FAF0E6;'> ".$row['letter']."</div>":"")."	".(($row['prokat_idp']>0)?"Осталось:".floor(($row['prokat_do']-time())/60/60)." ч. ".round((($row['prokat_do']-time())/60)-(floor(($row['prokat_do']-time())/3600)*60))." мин.<br>":"")."".(($magic['name'] && $row['type'] != 50)?"<font color=maroon>Наложены заклятия:</font> ".$magic['name']."<BR>":"")."".(($magic['name'] && $row['type'] == 50)?"<font color=maroon>Свойства:</font> ".$magic['name']."<BR>":"")."".(($row['text'])?"На ручке выгравирована надпись:<center>".$row['text']."</center><BR>":"")."".(($row['present_text'])?"На подарке написан текст:<br />".$row['present_text']."<BR>":"")."".(($incmagic['max'])?"	Встроено заклятие <img src=\"https://i.oldbk.com/i/magic/".$incmagic['img']."\" title=\"".$incmagic['name']."\"> ".$incmagic['cur']." шт.	<BR> ".($incmagic['nlevel']>$user['level']?"Требуемый уровень: ".$incmagic['nlevel']."":"Требуемый уровень: ".$incmagic['nlevel'])." <BR> ":"")."".(($incmagic['max'])? "К-во перезарядок: ".$incmagic['uses']."<br/>" : "")."".(($row['labonly']==1)?"<small><font color=maroon>Предмет пропадет после выхода из Лабиринта</font></small><BR>":"")."".((!$row['isrep'])?"<small><font color=maroon>Предмет не подлежит ремонту</font></small><BR>":"");

	}
		else { $RET.= "<font color=maroon><B>Свойства предмета не идентифицированы</B></font><BR>"; }

		if ($row[type]==27)
			{
			$RET.= "Особенности:<br>• может одеваться на броню<br>";
			}
			elseif ($row[type]==28)
			{
			$RET.= "Особенности:<br>• может одеваться под броню<br>";
			}

			$ekr_elka = array(55510312,55510313,55510314,55510315,55510316,55510317,55510318,55510319,55510320,55510321,55510322,55510334,55510335,55510336,55510337,55510338,55510339);
			$art_elka = array(55510323,55510324,55510325,55510326,55510327,55510340,55510341,55510342,55510343,55510344);

		if (  ( ($row[ab_mf]>0) or ($row[ab_bron]>0) or ($row[ab_uron]>0)) OR ((($row['id'] >= 55510301) AND ($row['id'] <= 55510311)) || (($row['id'] >= 55510328) AND ($row['id'] <= 55510333))) OR  (in_array($row['id'],$ekr_elka)) OR (in_array($row['id'],$art_elka)) )
		   {
		    $RET.= "Усиление:<br>";
		     if ($row[ab_mf]>0) $RET.= "• максимального мф.:+{$row[ab_mf]}%<br>";
		     if ($row[ab_bron]>0) $RET.= "• брони:+{$row[ab_bron]}%<br>";
		     if ($row[ab_uron]>0) $RET.= "• урона:+{$row[ab_uron]}%<br>";


			$elkabonus = 0;
			if ((($row['id'] >= 55510301) AND ($row['id'] <= 55510311)) || (($row['id'] >= 55510328) AND ($row['id'] <= 55510333))) {
				//кредовые елки
				$elkabonus = 1;
			} elseif (in_array($row['id'],$ekr_elka)) {
				//екровые елки
				$elkabonus = 2;
			} elseif (in_array($row['id'],$art_elka)) {
				//артовые елки
				$elkabonus = 3;
			}
			if ($elkabonus > 0) {
				$RET .= "• рунного опыта:+".$elkabonus."%<br>";
			}

		   }
		    elseif (($row[id]>=6000) AND ($row[id] <=6017))
		   {
			$runs_5lvl_param=array(
			"6000" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
			"6001" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
			"6002" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
			"6003" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
			"6004" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
			"6005" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
			"6006" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
			"6007" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
			"6008" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
			"6009" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
			"6010" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
			"6011" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
			"6012" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
			"6013" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
			"6014" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
			"6015" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
			"6016" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
			"6017" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
			);
		   //правка отображения рун в cshop
		   $ab=$runs_5lvl_param[$row[id]];
		    $RET.= "Усиление:<br>";
		     if ($ab[ab_mf]>0) $RET.= "• максимального мф.:0%<br>";
		     if ($ab[ab_bron]>0) $RET.= "• брони:0%<br>";
		     if ($ab[ab_uron]>0) $RET.= "• урона:0%<br>";
		   }

	//отображение улучшений на артах
	if (($row['bonus_info']!='') or ($row['charka']!='') )
		{
		$bohtml=array(
		'bron1' => 'Броня головы',
		'bron2' => 'Броня корпуса',
		'bron3' => 'Броня пояса',
		'bron4' => 'Броня ног',
		'ghp' =>'Уровень жизни' ,
		'mfkrit' =>'Мф. критических ударов' ,
		'mfakrit' => 'Мф. против крит. ударов' ,
		'mfuvorot' => 'Мф. увертливости',
		'mfauvorot' =>'Мф. против увертлив.',
		'gsila' =>'Сила' ,
		'glovk' => 'Ловкость' ,
		'ginta' => 'Интуиция',
		'gintel' =>'Интеллект',
		'gmp' =>'Мудрость',
		'gnoj' =>'Мастерство владения ножами и кастетами' ,
		'gtopor' =>'Мастерство владения топорами и секирами',
		'gdubina' => 'Мастерство владения дубинами, булавами',
		'gmech' =>'Мастерство владения мечами',
		'gfire' =>'Магическое мастерство cтихия огня',
		'gwater' => 'Магическое мастерство cтихия воды',
		'gair' => 'Магическое мастерство cтихия воздуха',
		'gearth' => 'Магическое мастерство cтихия земли',
		'ab_mf' =>'Усиление максимального мф',
		'ab_bron' => 'Усиление брони',
		'ab_uron' => 'Усиление урона');

		$pp=array(
		'mfkrit' =>'%' ,
		'mfakrit' => '%' ,
		'mfuvorot' => '%',
		'mfauvorot' =>'%',
		'ab_mf' =>'%',
		'ab_bron' => '%',
		'ab_uron' => '%');

			if ($row['bonus_info']!='')
			{
			$inputbonus=unserialize($row['bonus_info']); //все данные
			if (is_array($inputbonus))
				{
					$RET .= "<small><b><a onclick=\"showhide('art_{$row['id']}');\" href=\"javascript:Void();\">Список улучшений:</a></small><BR>";
					$RET .= "<div id=art_{$row['id']} style=\"display:none;\"><small><b>";
					ksort($inputbonus);
					foreach($inputbonus as $blevl => $bdata)
						{
						$RET .= "&nbsp;&nbsp;{$blevl}е улучшение:<br>";
								foreach($bdata as $k => $v)
									{
									$RET .= "&nbsp;&nbsp;• ".$bohtml[$k].": +{$v}".$pp[$k]."<br>";
									}
						}
					$RET .= "</b></small></div>";
				}
			}
			if ($row['charka']!='')
			{

			$charka=substr($row['charka'], 2,strlen($row['charka'])-1); //откидываем первые два символа
			$inputbonus=unserialize($charka); //все данные

			if (is_array($inputbonus))
				{
					$RET .= "<small><b>Список чарований:</small><BR>";
					$RET .= "<div id=art_{$row['id']}><small><b>";
					ksort($inputbonus);
					foreach($inputbonus as $blevl => $bdata)
						{
						$RET .= "&nbsp;&nbsp;{$blevl}е чарование:<br>";
								foreach($bdata as $pk => $pv)
									{
									foreach($pv as $k => $v)
										{
										$RET .= "&nbsp;&nbsp;• ".$bohtml[$k].": +{$v}".$pp[$k]."<br>";
										}
									}
						}
					$RET .= "</b></small></div>";
				}
			}



		}

		if($row['unik']==1) {
			$RET .= "<br><font color=red><small><b>Вещь с уникальной модификацией.</b></small></font>";
		}
		elseif(($row['unik']==2) and ($row['type']!=200))  {
			$RET .= "<br><font color=#990099><small><b>Вещь с улучшенной уникальной модификацией.</b></small></font>";
		}


//		$RET.= "<br></td></TR></table></CENTER>";

return $RET;
   }


function get_rur_curs()
{
$query_curs=mysql_query("select * from oldbk.variables where var='dollar' or var='euro' or var='grivna'");

	 while($row=mysql_fetch_array($query_curs))
	{
		if($row['var'] =='dollar') { $dollar = $row[value];}
		 else
		 	if($row['var'] =='euro')  { $euro = $row[value];}
		 		else
		 			if($row['var'] =='grivna') { $grivna = $row[value];}
	}
	$RUR=(round($dollar,3)+round($dollar*0.0693,3));

	if ($RUR>0)
		{
		 return	$RUR;
		}
		else return false;

}


function get_wmid_from_wmz ($wmz)
{

	$link="http://passport.webmoney.ru/asp/CertView.asp?purse=".$wmz;
				$f=@fopen($link,"r");
					if($f)
					{
					while (!feof($f))
					{

						$line=fread($f, 2048);
						 if (strpos($line, 'var wmid =') !== false)
						 {
							fclose($f);
							$line=strip_tags($line);
							$line=explode("var wmid =",$line);
							$pre=str_replace("'","",$line[1]);
							$pre=trim($pre);
							$out='';
							for ($i=0;$i<=12;$i++)
								{
								$out.=$pre[$i];
								}
							return $out;
						 }

					}
					}
return false;
}

function real_zak_cancel($zakaz,$mesg)
{
//функа по возврату  купюр при отказе
	$get_zak=mysql_fetch_array(mysql_query("select * from oldbk.com_money where id='{$zakaz}' LIMIT 1;"));
	if ($get_zak['id']>0)
		{
			$us=check_users_city_data($get_zak['owner']);
			//пишем в дело о отказе о возврате
				$rec = array();
	    			$rec['owner']=$us['id'];
				$rec['owner_login']=$us['login'];
				$rec['owner_balans_do']=$us['money'];
				$rec['owner_balans_posle']=$us['money'];
				$rec['target_login'] = "КО";
				$rec['item_id']=$get_zak['logids'];
				$rec['type'] = 415; //тип - отказ на вывод средств msum
				$rec['sum_ekr'] =$get_zak['msum'];
				$rec['add_info']='Заявка №WM'.$get_zak['id'].' , на WMZ:'.$get_zak['outwmz'];
				if (add_to_new_delo($rec) === FALSE) die();
			//возвращаем предметы c коллектора 453
			mysql_query('UPDATE oldbk.inventory  set owner='.$get_zak['owner'].', battle=0  WHERE owner=453 and battle='.$zakaz) or die();
			// пишем сообщение
			systemtotelo($us,"Вам отказано в выводе средств из игры по причине:\"".mysql_real_escape_string($mesg)."\". Все купюры возвращены Вам в инвентарь");
			return true;
		}
return false;
}

function set_bonus_ekr_kazna($telo,$zakaz)
{
	if ($zakaz[cost]>0)
	{
	$bonus=round(($zakaz[cost]*0.5),2);
	$clan_id= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `id` = '".$zakaz['klan_id']."'  ;"));
	if ($clan_id['id']>0)
		{
			  mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr+{$bonus}  WHERE `clan_id` = '{$clan_id[id]}' ;");
			  	if (mysql_affected_rows()>0)
			  	{
				  //пишем
				$txt="\"".$telo['login']."\", зачислен бонус {$bonus}  екр. от Коммерческого отдела (Акция \"Установи изображение\").";
        		   	mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)   VALUES  ('2','2','{$clan_id[id]}','{$telo[id]}','".$txt."','".time()."');");
				}
		}
	}
}

function set_bonus_ekr($telo,$zakaz)
{
//echo "Ставим бонус...";
	if ($zakaz[cost]>0)
	{
	$bonus=round(($zakaz[cost]*0.5),2);

		if ($zakaz[bank]>0)
		{
		//если есть банк
		mysql_query("UPDATE oldbk.bank set ekr=ekr+{$bonus} where id='{$zakaz[bank]}' and owner='{$telo[id]}'  ; ");
		$get_bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where id='{$zakaz[bank]}' and owner='{$telo[id]}'  ; "));
		$bank_id=$zakaz[bank];
		}
		else
		{
		//нет банка - ищем банк
		$get_bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  owner='{$telo[id]}' LIMIT 1;"));
		mysql_query("UPDATE oldbk.bank set ekr=ekr+{$bonus} where id='{$get_bank[id]}' and owner='{$telo[id]}'  ; ");
		$get_bank[ekr]+=$bonus;
		$bank_id=$get_bank[id];
		}

	if ($bank_id>0)
	  {
		if ($telo['odate'] > (time()-60) )
		{
		addchp('<font color=red>Внимание!</font> Вам на счет №'.$bank_id.' , зачислен бонус '.$bonus.' екр. от Коммерческого отдела.','{[]}'.$telo['login'].'{[]}',$telo['room'],$telo['id_city']);
		} else
		{
		mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$telo['id']."','','<font color=red>Внимание!</font>  Вам на счет №{$bank_id}, зачислен бонус {$bonus} екр. от Коммерческого отдела.');");
		}
	//пишем в дело

						      	//new_delo
  		    			$rec['owner']=$telo[id];
					$rec['owner_login']=$telo[login];
					$rec['owner_balans_do']=$telo['money'];
					$rec['owner_balans_posle']=$telo['money'];
					$rec['target']=450;
					$rec['target_login']='KO';
					$rec['type']=356;//бонус
					$rec['sum_kr']=0;
					$rec['sum_ekr']=$bonus;
					$rec['sum_kom']=0;
					$rec['item_id']='';
					$rec['item_name']='';
					$rec['item_count']=0;
					$rec['item_type']=0;
					$rec['item_cost']=0;
					$rec['item_dur']=0;
					$rec['item_maxdur']=0;
					$rec['item_ups']=0;
					$rec['item_unic']=0;
					$rec['item_incmagic']='';
					$rec['item_incmagic_count']='';
					$rec['item_arsenal']='';
					$rec['bank_id']=$bank_id;
					$rec['add_info']='Заказ КО №SC'.$zakaz[id];
					add_to_new_delo($rec); //юзеру

				mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Бонус за покупку изображения<b> {$bonus} екр.</b>,<i>(Итого: {$get_bank[cr]} кр., {$get_bank['ekr']} екр.)</i>','{$bank_id}');");

	   }
	   else
	   {
	   echo "<br>Бонус не установлен!<br>";
	   }

	}

}


function undress_img($item)
{   //снимает картинку со шмотки (любую)
        if(mysql_query('update oldbk.inventory as i
				   set i.add_pick="", i.pick_time=""
				WHERE i.id='.$item[id].' AND i.owner = '.$item[owner].';'))
	{
		if(mysql_query('update oldbk.gellery set dressed=0 where owner='.$item[owner].' AND img="'.$item[add_pick].'" AND otdel='.$item[otdel].' AND dressed >0 LIMIT 1;'))
		{
			return true;
		}
		else
		{
			return false;
		}
	}
	else
	{
		return false;
	}
}


function check_users_city_data($id)
{
    $user_city=mysql_fetch_array(mysql_query('SELECT * from oldbk.`users` where id="'.$id.'";'));
	if(!$user_city)
	{
		$user_city=FALSE;
	}
	else
    if($user_city['id_city']==1)
	{
		$user_city=mysql_fetch_array(mysql_query('SELECT * from avalon.`users` where id="'.$id.'";'));
	}
	else
    if($user_city['id_city']==2)
	{
		$user_city=mysql_fetch_array(mysql_query('SELECT * from angels.`users` where id="'.$id.'";'));
	}
    return  $user_city;
}

function check_users_city_datal($login)
{
    $user_city=mysql_fetch_array(mysql_query('SELECT * from oldbk.`users` where login="'.$login.'";'));
	if(!$user_city)
	{
		$user_city=FALSE;
	}
	else
    if($user_city['id_city']==1)
	{
		$user_city=mysql_fetch_array(mysql_query('SELECT * from avalon.`users` where login="'.$login.'";'));
	}
	else
    if($user_city['id_city']==2)
	{
		$user_city=mysql_fetch_array(mysql_query('SELECT * from angels.`users` where login="'.$login.'";'));
	}
    return  $user_city;
}



function upgrade_item($up_cost,$max_ups_left){
      	$costs[up_cost]=$up_cost;
	if($max_ups_left == 5) {
		$costs[mfbonusadd]=2;
		$costs[cur_cost]= $costs[up_cost]+round($costs[up_cost] / 2, 0);
		$costs[up_cost] = round($costs[cur_cost] / 2, 0);
		$costs[cost_add] = round($costs[cur_cost] * 0.2, 0);//cost wich will pluseed to item cost after mf
	} elseif($max_ups_left == 4) {
		$costs[mfbonusadd]=3;
		$costs[cur_cost]= $costs[up_cost]+round($costs[up_cost] / 2, 0);
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after previos UP
		$costs[up_cost] = round($costs[cur_cost] / 2, 0);
		$costs[cost_add] = round($costs[cur_cost] * 0.2, 0);//cost wich will pluseed to item cost after UP
	} elseif($max_ups_left == 3) {
		$costs[mfbonusadd]=4;
		$costs[cur_cost]= $costs[up_cost]+round($costs[up_cost] / 2, 0);
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after 1 UP
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after 2 UP
		$costs[up_cost] = round($costs[cur_cost] / 2, 0);
		$costs[cost_add] = round($costs[cur_cost] * 0.4, 0);//cost wich will pluseed to item cost after UP
	} elseif($max_ups_left == 2) {
		$costs[mfbonusadd]=6;
		$costs[cur_cost]= $costs[up_cost]+round($costs[up_cost] / 2, 0);
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after 1 UP
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after 2 UP
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.4,0); //cost after 3 UP
		$costs[up_cost] = round($costs[cur_cost] / 2, 0);
		$costs[cost_add] = round($costs[cur_cost] * 0.7, 0);//cost wich will pluseed to item cost after UP
	} elseif($max_ups_left == 1) {
		$costs[mfbonusadd]=10;
		$costs[cur_cost]= $up_cost+round($up_cost / 2, 0);
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after 1 UP
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.2,0); //cost after 2 UP
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.4,0); //cost after 3 UP
		$costs[cur_cost]=$costs[cur_cost]+round($costs[cur_cost]*0.7,0); //cost after 4 UP
		$costs[up_cost] = round($costs[cur_cost] / 2, 0);
		$costs[cost_add] = round($costs[cur_cost] * 0.1, 0);//cost wich will pluseed to item cost after UP
	}
	$costs[up_cost]=round($costs[up_cost]*0.7);
	return $costs;
}


function ExUnik() {
	global $user;
	global $EKR_TO_GOLD;
	// слот-слот
	$p1 = 10;
	$p2 = 10;
	// разнослот
	$p3 = 15;
	$p4 = 15;

	$bprice = $p1;



	$us = check_users_city_datal($user);
	$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");

	if ($us['klan']=='radminion') {
		$mainsql = '
		SELECT inventory.* FROM oldbk.inventory LEFT JOIN shop ON inventory.prototype = shop.id LEFT JOIN eshop ON inventory.prototype = eshop.id
			WHERE 	inventory.owner = '.$us['id'].'
				AND (unik = 1 or (unik = 2 and inventory.type != 200))
				AND (art_param = "" or art_param IS NULL) AND inventory.ab_uron = 0 AND inventory.ab_mf = 0 AND inventory.ab_bron = 0
				AND inventory.name NOT LIKE "%[%"
				AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""
				AND prototype NOT IN (19104,19105,19106,19107,1120)
				AND setsale=0 AND inventory.duration = 0 AND prokat_idp = 0 AND bs_owner = 0
				AND dressed = 0 and getfrom != 1 and inventory.dategoden = 0
				AND (inventory.gsila > 0 or inventory.glovk > 0 or inventory.ginta > 0 or inventory.gintel > 0 or inventory.gmp > 0)
				AND inventory.type = '.@intval($_GET['itype']).'
		';
	} else {
		$mainsql = '
		SELECT inventory.* FROM oldbk.inventory LEFT JOIN shop ON inventory.prototype = shop.id LEFT JOIN eshop ON inventory.prototype = eshop.id
			WHERE 	inventory.owner = '.$us['id'].'
				AND ((shop.nlevel = '.$us['level'].' or shop.nlevel = '.($us['level']-1).') or (eshop.nlevel = '.$us['level'].' or eshop.nlevel = '.($us['level']-1).'))
				AND (unik = 1 or (unik = 2 and inventory.type != 200))
				AND (art_param = "" or art_param IS NULL) AND inventory.ab_uron = 0 AND inventory.ab_mf = 0 AND inventory.ab_bron = 0
				AND inventory.name NOT LIKE "%[%"
				AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""
				AND prototype NOT IN (19104,19105,19106,19107,1120)
				AND setsale=0 AND inventory.duration = 0 AND prokat_idp = 0 AND bs_owner = 0
				AND dressed = 0 and getfrom != 1 and inventory.dategoden = 0
				AND (shop.nlevel is not  NULL or eshop.nlevel is not NULL)
				AND (inventory.nlevel > 6)
				AND (inventory.gsila > 0 or inventory.glovk > 0 or inventory.ginta > 0 or inventory.gintel > 0 or inventory.gmp > 0)
				AND inventory.type = '.@intval($_GET['itype']).'
		';
	}

	if ($us['klan']=='radminion') {
		$mainshopsql = '
			SELECT * FROM oldbk.shop WHERE type = '.@intval($_GET['ityper']).' and ((name NOT LIKE "%[%" and name NOT LIKE "%(%" AND img NOT LIKE "%art_%" and ab_mf = 0 and ab_uron = 0 and ab_bron = 0
			AND (gsila > 0 or glovk > 0 or ginta > 0 or gintel > 0 or gmp > 0)
			AND id NOT IN(195,2003,121121122,602,121121124,121121123) and unikflag > 0) and new_item>0 ) and id !=
		';

		$mainshopsql2 = '
			SELECT * FROM oldbk.eshop WHERE type = '.@intval($_GET['ityper']).' and ((name NOT LIKE "%[%" and name NOT LIKE "%(%" AND img NOT LIKE "%art_%" and ab_mf = 0 and ab_uron = 0 and ab_bron = 0
			AND (gsila > 0 or glovk > 0 or ginta > 0 or gintel > 0 or gmp > 0)
			AND id NOT IN(195,2003,121121122,602,121121124,121121123) and unikflag > 0) and new_item>0 ) and id !=
		';
	} else {
		//--and NOT (id > 1100000000 and id < 2000000000)
		$mainshopsql = '
			SELECT * FROM oldbk.shop WHERE nlevel = '.$us['level'].' and type = '.@intval($_GET['ityper']).' and name NOT LIKE "%[%" and name NOT LIKE "%(%" AND img NOT LIKE "%art_%" and ab_mf = 0 and ab_uron = 0 and ab_bron = 0
			AND (gsila > 0 or glovk > 0 or ginta > 0 or gintel > 0 or gmp > 0)
			AND id NOT IN(195,2003,121121122,602,121121124,121121123) and unikflag > 0 and new_item>0 and id !=
		';
		$mainshopsql2 = '
			SELECT * FROM oldbk.eshop WHERE nlevel = '.$us['level'].' and type = '.@intval($_GET['ityper']).' and name NOT LIKE "%[%" and name NOT LIKE "%(%" AND img NOT LIKE "%art_%" and ab_mf = 0 and ab_uron = 0 and ab_bron = 0
			AND (gsila > 0 or glovk > 0 or ginta > 0 or gintel > 0 or gmp > 0)
			AND id NOT IN(195,2003,121121122,602,121121124,121121123) and unikflag > 0 and new_item>0 and id !=
		';

		if ($us['level'] == 14) {
			$mainshopsql = '
				SELECT * FROM oldbk.shop WHERE nlevel = 14 and type = '.@intval($_GET['ityper']).' and name NOT LIKE "%[%" and name NOT LIKE "%(%" AND img NOT LIKE "%art_%" and ab_mf = 0 and ab_uron = 0 and ab_bron = 0
				AND (gsila > 0 or glovk > 0 or ginta > 0 or gintel > 0 or gmp > 0)
				AND id NOT IN(195,2003,121121122,602,121121124,121121123) and unikflag > 0 and new_item>0 and id !=
			';
			$mainshopsql2 = '
				SELECT * FROM oldbk.eshop WHERE nlevel = 14 and type = '.@intval($_GET['ityper']).' and name NOT LIKE "%[%" and name NOT LIKE "%(%" AND img NOT LIKE "%art_%" and ab_mf = 0 and ab_uron = 0 and ab_bron = 0
				AND (gsila > 0 or glovk > 0 or ginta > 0 or gintel > 0 or gmp > 0)
				AND id NOT IN(195,2003,121121122,602,121121124,121121123) and unikflag > 0 and new_item>0 and id !=
			';
		}
	}

	$MAXUP=5;
	$ADDMF[1]=2; $ADDCOST[1]=0.2;
	$ADDMF[2]=3; $ADDCOST[2]=0.2;
	$ADDMF[3]=4; $ADDCOST[3]=0.4;
	$ADDMF[4]=6; $ADDCOST[4]=0.7;
	$ADDMF[5]=10; $ADDCOST[5]=0.1;


	echo "<br>
<table width=\"940\" border=\"0\" align=\"left\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\"> ОБМЕН УНИКАЛЬНЫХ ВЕЩЕЙ</b></center></td></tr>
<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете обменять свои уникальные вещи на другие.</center>
<div align=left>
<p><b style=\"color:#800000\">Правила обмена уникальных вещей:</b><br>
- обмену подлежат уникальные и улучшенные уникальные вещи 7го и выше уровня <br>
- уровень вещи должен быть равен уровню Вашего персонажа или на 1 уровень ниже<br>
- при обмене можно получить вещь только уровня равного уровню Вашего персонажа и того же слота, что и старая вещь<br>
- обмену подлежат только полностью отремонтированные вещи, находящиеся в инвентаре и не одетые на персонаже<br>
- уникальные вещи обмениваются на уникальные, улучшенные уникальные вещи обмениваются на улучшенные<br>
- невозможно обменять артефакты, оружие, футболки, плащи и выведенные из Игры вещи<br></p>
<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
- выбранную Вами уникальную вещь или улучшенную уникальную вещь с сохранением модификации и количества подгонов, а также со всей встроенной магией и чарованием, которые были на старой вещи<br>
- при обмене уникальной вещи без HP на вещь, имеющую данный параметр, HP от модификации на ней будут равны 20<br>
- при обмене уникальной вещи без брони на вещь, имеющую данный параметр, параметр брони на ней будет +3</p>";

if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017))
	{
	echo "<p><b style=\"color:#800000\">Стоимость обмена:</b> <br>
	слот на слот - 0 екр. для уникальной вещи и 0 екр для улучшенной уникальной вещи<br>
	<font color=red>На время действия акции услуга обмена бесплатна.</font><br>"; //«Свобода выбора»
	}
	else
	{
	echo "<p><b style=\"color:#800000\">Стоимость обмена:</b> <br>
	слот на слот - 10 екр / 180 монет (с учётом скидки 10%) для уникальной вещи или улучшенной уникальной вещи<br>
	слот на слот (для устаревших уникальных вещей) - бесплатно<br>";
	}



echo "
	слот на другой слот - 15 екр / 270 монет (с учётом скидки 10%) для уникальной вещи или улучшенной уникальной вещи<br>
</p>
<p><table><tr valign=middle><td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами]&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td><td>[</td><td><img src=https://i.oldbk.com/i/pay_sert_unik.png border=0> </td><td>сертификат]</td></tr></table>
</p>
<p><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</div>



</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<center>
<div style='margin-bottom:20px;'>Выберите вещь для обмена и на что Вы хотите ее обменять.<br><small><b>Внимание!</b> <br>Недостающие HP и броню (до топа) всегда можно добавить рихтовкой в Ремонтной Мастерской.</small></div>
";

	if (!(mysql_num_rows($get_bank) > 0)) {
		echo '<font color=red>У вас нет доступных банковских счетов!</font>';
	} elseif ($us['level'] < 7) {
		echo '<font color=red>Обмен уникальных вещей доступен только для персонажей не ниже 7го уровня!</font>';
	} else {
		$BANKS="<select style='width:150px' name=bankid>";
		while($row = mysql_fetch_assoc($get_bank)) {
			$BANKS.="<option>".$row['id']."</option>";
		}
		$BANKS.="</select>";

		$itype = array(
			1 => 'Серьги',
			2 => 'Ожерелья',
			5 => 'Кольца',
			4 => 'Броня',
			8 => 'Шлем',
			9 => 'Перчатки',
			11 => 'Сапоги',
			10 => 'Щиты',
		);

       		echo '
		<script>
		function ChangeIType(t) {
			location.href = "?act=exunik&itype="+t.options[t.selectedIndex].value;
		}

		function ChanageIItem(t) {
			obj = document.getElementById("itype");
			location.href = "?act=exunik&itype="+obj.options[obj.selectedIndex].value+"&iid="+t.value;
		}
		function ChanageIEx(t) {
			obj = document.getElementById("itype");
			obj2 = document.getElementById("iid");
			obj3 = document.getElementById("exrazdel");
			location.href = "?act=exunik&itype="+obj.options[obj.selectedIndex].value+"&iid='.$_GET['iid'].'&iex="+t.value+"&ityper="+obj3.options[obj3.selectedIndex].value;
		}

		function ChanageIExR(t) {
			obj = document.getElementById("itype");
			obj2 = document.getElementById("iid");
			obj3 = document.getElementById("exrazdel");
			location.href = "?act=exunik&itype="+obj.options[obj.selectedIndex].value+"&ityper="+obj3.options[obj3.selectedIndex].value+"&iid='.$_GET['iid'].'";
		}

		</script>

		<table>
		<tr><td width="50%" valign="top">

		<table style="text-align:left;">
		<tr><td valign=top>
		Выберите тип вещи для обмена:
		<select id="itype" name="itype" OnChange="ChangeIType(this);">
		<option value="-1">Выбрать раздел</option>
		';

		if (isset($_GET['itype']) && !isset($itype[$_GET['itype']])) $_GET['itype'] = 1;

		while(list($k,$v) = each($itype)) {
			if (isset($_GET['itype']) &&  $k == $_GET['itype']) {
				echo '<option selected value="'.$k.'">'.$v.'</option>';
			} else {
				echo '<option value="'.$k.'">'.$v.'</option>';
			}
		}

		echo '
		</select></td></tr>
		';


		if (isset($_GET['itype'])) {
			$q = mysql_query($mainsql) or die(mysql_error());
			if (mysql_num_rows($q) > 0) {
				echo '<tr><td valign=top><select id="iid" name="iid">';
				echo '<option value="-1">Выберите вещь для обмена</option>';
				$proto = array();
				$sproto = array();
				$iarr = array();
				while($row = mysql_fetch_assoc($q)) {
					$proto[$row['prototype']] = 1;
					$iarr[] = $row;
				}
				$q = mysql_query('SELECT * FROM shop wHERE id IN ('.implode(",",array_keys($proto)).')');
				while($row = mysql_fetch_assoc($q)) {
					$sproto[$row['id']] = 1;
				}

				while(list($k,$row) = each($iarr)) {
					if (isset($sproto[$row['prototype']])) echo '<option data-imagesrc="https://i.oldbk.com/i/classes/'.ClassToIco($row['nclass']).'" '.(isset($_GET['iid']) && $_GET['iid'] == $row['id'] ? "selected" : "" ).' value="'.$row['id'].'">'.$row['name'].' ('.get_xitem_fid(array("idcity" => $row['idcity'], "id" => $row['id'])).')</option>';
				}

				echo '
				<script>
					$("#iid").ddslick({
						width:390,
						height:300,
						onSelected: function(data) {
							if (data.selectedData.value != -1 && data.selectedData.value != '.(isset($_GET['iid']) ? $_GET['iid'] : "-1").') {
								ChanageIItem(data.selectedData);
							}
						}
					});
				</script>
				';

				echo '</td></tr></select>';
			} else {
				echo '<tr><td valign=top><font color=red>В инвентаре не найдены вещи подходящие для обмена!</font></td></tr>';
			}
		}

		$ifound = false;
		$iproto = false;
		$irazdel = false;

		if (isset($_GET['iid'])) {
			$q = mysql_query($mainsql.' AND inventory.id = '.intval($_GET['iid']));
			if (mysql_num_rows($q) > 0) {
				$row = mysql_fetch_assoc($q);
				$qq = mysql_query('SELECT * FROM oldbk.shop WHERE id = '.$row['prototype']);
				if(mysql_num_rows($qq) > 0) {
					$ifound = $row;
					$iproto = mysql_fetch_assoc($qq);
					if ($iproto['unikflag'] == 0) {
						$qq = mysql_query('SELECT * FROM oldbk.eshop WHERE id = '.$row['prototype'] .' and unikflag > 0');
						if(mysql_num_rows($qq) > 0) {
							$t = mysql_fetch_assoc($qq);
							$iproto['unikflag'] = $t['unikflag'];
						}
					}
					echo '<tr><td valign=top><table style="text-align:left;" width=400><tr><td valign="top"><img src="https://i.oldbk.com/i/sh/'.$row['img'].'"></td><td>'.showiteme($row).'</td></tr></table></td></tr>';
				}
			}
		}

		echo '
		</table>


		</td>
		<td width="50%" valign="top">';

		$ifound2 = false;
		$rowready = false;
		$mfinfo = array();

		if (isset($_GET['ityper']) && isset($itype[$_GET['ityper']])) {
			$irazdel = $_GET['ityper'];
		}

		if ($ifound && $iproto) {
			echo '<table style="text-align:left;"><tr><td valign=top>Выбрать раздел для обмена: ';
			echo '<select id="exrazdel" OnChange="ChanageIExR(this);">';
			echo '<option value="-1">Выбрать раздел</option>';

			if (isset($_GET['ityper']) && !isset($itype[$_GET['ityper']])) $_GET['ityper'] = 1;

			reset($itype);
			while(list($k,$v) = each($itype)) {
				if (isset($_GET['ityper']) &&  $k == $_GET['ityper']) {
					echo '<option selected value="'.$k.'">'.$v.'</option>';
				} else {
					echo '<option value="'.$k.'">'.$v.'</option>';
				}
			}
			echo '</td></tr></table>';

		}

		if ($ifound && $iproto && $irazdel) {
			echo '<table><tr><td valign=top>';
			echo '<select id="exitem">';
			echo '<option value="-1">Выбрать вещь</option>';
			$q = mysql_query($mainshopsql.$ifound['prototype']);
			while($row = mysql_fetch_assoc($q)) {
				echo '<option data-imagesrc="https://i.oldbk.com/i/classes/'.ClassToIco($row['nclass']).'" '.(($row['id'] == $_GET['iex']) ? "selected" : "").' value="'.$row['id'].'">'.$row['name'].' ['.$row['nlevel'].']</option>';
			}
			$q = mysql_query($mainshopsql2.$ifound['prototype']);
			while($row = mysql_fetch_assoc($q)) {
				echo '<option data-imagesrc="https://i.oldbk.com/i/classes/'.ClassToIco($row['nclass']).'" '.(($row['id'] == $_GET['iex']) ? "selected" : "").' value="'.$row['id'].'">'.$row['name'].' ['.$row['nlevel'].']</option>';
			}

			echo '
			<script>
				$("#exitem").ddslick({
					height:390,
					width:310,
					onSelected: function(data) {
						if (data.selectedData.value != -1 && data.selectedData.value != '.(isset($_GET['iex']) ? $_GET['iex'] : "-1").') {
							ChanageIEx(data.selectedData);
						}
					}
				});
			</script>
			</td></tr>
			';

			if (isset($_GET['iex'])) {
				$q = mysql_query($mainshopsql.$ifound['prototype'].' AND id = '.intval($_GET['iex']));
				if (mysql_num_rows($q) == 0) $q = mysql_query($mainshopsql2.$ifound['prototype'].' AND id = '.intval($_GET['iex']));

				if (mysql_num_rows($q) > 0) {
					$row = mysql_fetch_assoc($q);
					$ifound2 = $row;

					$diffhp = $ifound['ghp']-$iproto['ghp'];
					$diffbr1 = $ifound['bron1']-$iproto['bron1'];
					$diffbr2 = $ifound['bron2']-$iproto['bron2'];
					$diffbr3 = $ifound['bron3']-$iproto['bron3'];
					$diffbr4 = $ifound['bron4']-$iproto['bron4'];

					// fix for all zones
					$bron[]=$diffbr1;$bron[]=$diffbr2;$bron[]=$diffbr3;$bron[]=$diffbr4;
					$addbron=max($bron);
					if ($addbron<1) {$addbron=3;}

					if (($diffbr1==0) and ($row['bron1']>0)) { $diffbr1=$addbron; }
					if (($diffbr2==0) and ($row['bron2']>0)) { $diffbr2=$addbron; }
					if (($diffbr3==0) and ($row['bron3']>0)) { $diffbr3=$addbron; }
					if (($diffbr4==0) and ($row['bron4']>0)) { $diffbr4=$addbron; }

					if($row['ghp'] > 0) {
						$row['ghp'] += $diffhp;
						$mfinfo['hp'] = $diffhp;
					} else {
						$mfinfo['hp'] = 0;
					}

					if ($row['bron1'] > 0 || $row['bron2'] > 0 || $row['bron3'] > 0 || $row['bron4'] > 0) {
						$mfinfo['bron'] = $addbron;
					} else {
						$mfinfo['bron'] = 0;
					}


					if($row['bron1']) $row['bron1'] += $diffbr1;
					if($row['bron2']) $row['bron2'] += $diffbr2;
					if($row['bron3']) $row['bron3'] += $diffbr3;
					if($row['bron4']) $row['bron4'] += $diffbr4;
					$row['name'] .= ' (мф)';

					$addcost = 0;

					if (!($row['gsila'] == 0 and $row['glovk'] == 0 and $row['ginta'] == 0 and $row['gintel'] == 0 and $row['gmp'] == 0)) {
						if ($ifound['unik'] == 1) {
							$row['stbonus'] = 3;
							$row['unik'] = 1;
							$bprice = $p1;
							$mfinfo['stats'] = 3;
						}
						if ($ifound['unik'] == 2) {
							$row['stbonus'] = 4;
							$row['unik'] = 2;
							$bprice = $p2;
							$mfinfo['stats'] = 4;
						}
						$addcost = round($row['cost']*0.5, 0);
					} else {
						$addcost = round(round($row['cost']*0.5, 0)*0.5,0);
					}

					$addmf = 0;
					for ($i = 1; $i < $ifound['ups']+1; $i++) {
						$addmf += $ADDMF[$i];
						$costs = upgrade_item($row['cost'],$MAXUP-$i+1);
						$addcost += $costs['cost_add'];
					}

					if ($ifound["includemagic"] > 0) {
						$qm = mysql_query('SELECT * FROM oldbk.shop WHERE magic = '.$ifound['includemagic']);
						if (mysql_num_rows($qm) > 0) {
							$qm = mysql_fetch_assoc($qm);
							if ($qm['cost'] > 0) $addcost += $qm['cost'];
								//кредовая встройка
								//если свиток требует магию , интелект или мудру
								if ($qm['nintel']>0)	$row['nintel']=$qm['nintel'];
								if ($qm['nmudra']>0)	$row['nmudra']=$qm['nmudra'];
								if ($qm['ngray']>0)	$row['ngray']=$qm['ngray'];
								if ($qm['ndark']>0)	$row['ndark']=$qm['ndark'];
								if ($qm['nlight']>0)	$row['nlight']=$qm['nlight'];
						} else {
							$qm = mysql_query('SELECT * FROM oldbk.eshop WHERE magic = '.$ifound['includemagic']);
							if (mysql_num_rows($qm) > 0) {
								$qm = mysql_fetch_assoc($qm);
								if ($qm['cost'] > 0) $addcost += $qm['cost'];
							}
						}
						$row['massa']++;
					}

					$row['cost'] += $addcost;

					if ($row['mfkrit'] || $row['mfakrit'] || $row['mfuvorot'] || $mf['mfauvorot']) $row['mfbonus'] += $addmf;
					$row['ups'] = $ifound['ups'];

					//показ чарки со старого передмета на новом
					if ($ifound['charka'] != '') {
						if (($us['klan']=='minion')) {
							$row['charka']=str_replace('s:6:"gtopor"','s:7:"gdubina"',$ifound['charka']);
						} else {
							$row['charka']=$ifound['charka'];
						}

						$charka = substr($row['charka'], 2,strlen($row['charka'])-1); //откидываем первые два символа
						$inputbonus=unserialize($charka); //все данные

						if (is_array($inputbonus)) {
							ksort($inputbonus);
							foreach($inputbonus as $blevl => $bdata) {
								foreach($bdata as $pk => $pv) {
									foreach($pv as $k => $v) {
										if (($k=='ghp') and ($row['ghp'] > 0)) {
											//разница на хп уже учтена
											if ($mfinfo['hp'] > 0) $mfinfo['hp'] -= $v;
										} else {
											$row[$k] +=$v;
										}
									}
								}
							}
						}
					}

					$row['ekr_flag'] = $ifound['ekr_flag'];

					// подарок и привязку тоже переносим
					$row['present'] = $ifound['present'];
					$row['sowner'] = $ifound['sowner'];

					// фиксим цену если разнослот
					if ($ifound['type'] != $row['type']) {
						if ($ifound['unik'] == 1) $bprice = $p3;
						if ($ifound['unik'] == 2) $bprice = $p4;
					} else {
						// обмен одно слот старой шмотки на новую
						if (($iproto['id'] == 39000 || $iproto['id'] == 39001) || $iproto['new_item'] == 0 && $ifound2['new_item'] == 1) {
							$bprice = 0;
						}
					}


					$rowready = $row;

					if (!($rowready['ecost']>0)) {
						//костыль на екост
					 	$ecost=mysql_fetch_assoc(mysql_query("select id, unikflag from oldbk.eshop where id='{$rowready['id']}'"));
					 	if ($ecost['unikflag']>0) {
							$rowready['ecost'] = $ecost['unikflag'];
					 	} else {
							$ecost = mysql_fetch_assoc(mysql_query("select id, unikflag from oldbk.shop where id='{$rowready['id']}'"));
							if ($ecost['unikflag'] > 0) {
								$rowready['ecost']=$ecost['unikflag'];
					 		}
				 		}
					}

					if ($rowready['ekr_flag'] == 0) {
						$rowready['ecost'] = 0;
					}


					echo '<tr><td valign=top><table style="text-align:left;" width=400><tr><td valign="top"><img src="https://i.oldbk.com/i/sh/'.$row['img'].'"></td><td valign=top>'.showiteme($rowready).'</td></tr></table></td></tr>';
				}
			}
			echo '</table>';
		}



		// ifound = вещь на обмен
		// iproto = прототип вещи на обмен
		// ifound2 = прототип новой вещи
		// rowready - новая вещь подсчитанная выше

		// 20 хп, 3 брони. +3 стата просто уник или +4 стата супер уник
		// нам надо знать разницу только хп и брони

		if (($iproto['ghp']==0) AND ($ifound2['ghp']>0)) {
			//  на прототипе нет хп - а нановой будет хп
			/// модификации для хп, там будет либо 10-20,
			$tmp = 20; //10-20
			$rowready['ghp'] += $tmp;
			$mfinfo['hp'] = $tmp;
		}

		//echo '</td></tr>';
		if ($ifound && $ifound2 && $iproto) {
			echo '<tr><td colspan=2>';
			if ($ifound['ups'] > $MAXUP) {
				echo 'Произошла ошибка, обратитесь к администрации.';die();
			}

			$diffhp = $ifound['ghp']-$iproto['ghp'];
			$diffbr1 = $ifound['bron1']-$iproto['bron1'];
			$diffbr2 = $ifound['bron2']-$iproto['bron2'];
			$diffbr3 = $ifound['bron3']-$iproto['bron3'];
			$diffbr4 = $ifound['bron4']-$iproto['bron4'];

			$addcost1 = 0;
			$addcost2 = 0;


			// считаем цену
			if ($ifound['ekr_flag'] == 0) {
				if (!($iproto['gsila'] == 0 and $iproto['glovk'] == 0 and $iproto['ginta'] == 0 and $iproto['gintel'] == 0 and $iproto['gmp'] == 0)) {
					$addcost1 = round($iproto['cost']*0.5, 0);
				} else {
					$addcost1 = round(round($iproto['cost']*0.5, 0)*0.5,0);
				}


				if (!($ifound2['gsila'] == 0 and $ifound2['glovk'] == 0 and $ifound2['ginta'] == 0 and $ifound2['gintel'] == 0 and $ifound2['gmp'] == 0)) {
					$addcost2 = round($ifound2['cost']*0.5, 0);
				} else {
					$addcost1 = round(round($iproto['cost']*0.5, 0)*0.5,0);
				}
			}

			$addmf = 0;
			for ($i = 1; $i < $ifound['ups']+1; $i++) {
				$addmf += $ADDMF[$i];

				$costs1 = upgrade_item($iproto['cost'],$MAXUP-$i+1);
				$costs2 = upgrade_item($ifound2['cost'],$MAXUP-$i+1);

				$addcost1 += $costs1['up_cost'];
				$addcost2 += $costs2['up_cost'];
			}


			if ($ifound['ekr_flag'] == 0) {
				$addcost1 += $iproto['cost'];
				$addcost2 += $ifound2['cost'];
			}


//			if ($ifound2['mfkrit'] || $ifound2['mfakrit'] || $ifound2['mfuvorot'] || $ifound2['mfauvorot']) echo ' Доп МФ: '.$addmf;
			$diffprice = round($addcost1-$addcost2,0);
			$diffprice = $diffprice * -1;

			if($ifound2['ghp']) {
//				echo ' Доп хп: '.$diffhp;
			}
			if($ifound2['bron1']) {
//				echo ' Доп БР1: '.$diffbr1;
			}
			if($ifound2['bron2']) {
//				echo ' Доп БР2: '.$diffbr2;
			}
			if($ifound2['bron3']) {
//				echo ' Доп БР3: '.$diffbr3;
			}

			if($ifound2['bron4']) {
//				echo ' Доп БР4: '.$diffbr4;
			}



			if (!($ifound2['gsila'] == 0 and $ifound2['glovk'] == 0 and $ifound2['ginta'] == 0 and $ifound2['gintel'] == 0 and $ifound2['gmp'] == 0)) {
//				if ($ifound['unik'] == 1) echo ' Доп стат: 3';
//				if ($ifound['unik'] == 2) echo ' Доп стат: 4';
			}

//			echo ' Разница цены: '.($addcost1-$addcost2).'<br><br>';
/*
			if (($us['klan']=='minion')  OR ($us['klan']=='Animals')  OR ($us['klan']=='LastLegion')  )
				{
				$bprice=0;
				$diffprice=0;
				}
*/

			//бесплатный обмен изза смены брони


			if(time()>mktime(12,0,0,5,25,2016) && time()<mktime(23,59,59,5,27,2016)) {
				if ($bprice == $p1 || $bprice == $p2) {
					$bprice = 0;
				}
			}

			if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017))
			{
				if ($bprice == $p1 || $bprice == $p2) {
					$bprice = 0;
				}
			}


			if ($iproto['unikflag'] > 0 && $rowready['unikflag'] > 0 && $rowready['ekr_flag'] > 0) {
				$diffekrprice = $rowready['unikflag'] - $iproto['unikflag'];
				if ($diffekrprice < 0) $diffekrprice = 0;
			} else {
				$diffekrprice = 0;
			}

			if ($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['paytype'])) {
				$paytype = $_POST['paytype'];
				if (!in_array($paytype,[0,1,2])) die();

				$good = true;

				if ($paytype == 0 || $diffekrprice > 0) {
					if ($_POST['bankpass'] == '' || $_POST['bankid'] == '') {
						serr("Вы не указали пароль от банковского счета!");
						$good = false;
					} else {
						$bankid=(int)($_POST['bankid']);
						$bankpas=$_POST['bankpass'];
						$bank = mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
						if ($bank['id']>0) {
							if ($paytype == 0) {
								if ($bank['ekr'] < $bprice+$diffekrprice)  {
									serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".($bprice+$diffekrprice)." екр.");
									$good = false;
								}
							}
							if ($diffekrprice > 0) {
								if ($bank['ekr'] < $diffekrprice)  {
									serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".($diffekrprice)." екр.");
									$good = false;
								}
							}
						} else {
							serr('Ошибка! Не верный пароль от банковского счета!');
							$good = false;
						}

					}
				}



				if ($paytype == 2) {
					$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' and prototype = 540 and (sowner = 0 or sowner = '.$us['id'].') and setsale = 0 LIMIT 1');
					if (mysql_num_rows($q)) {
						$sert = mysql_fetch_assoc($q);
					} else {
						serr('Сертификат не найден');
						$good = false;
					}
				}

				if ($diffprice > 0) {
					if ($us['money'] < $diffprice) {
						serr('Недостаточно кр на персонаже.');
						$good = false;
					}
				}



				// все проверки прошли
				if ($good) {
	       				// отнимаем кр, переносим вещь на делитера, добавляем вещь, пишем в дело
					$q = mysql_query('START TRANSACTION') or die();

					// снимаем бабки
					$tmp = 0;
					$needm = 0;
					if ($paytype == 0 || $diffekrprice > 0) {
						if ($paytype == 0) $tmp += $bprice;
						if ($diffekrprice > 0) $tmp += $diffekrprice;

						if ($tmp > 0) {
							mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$tmp}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'") or die(mysql_error());
							//  пишем в хистори банка
							$bank['ekr']-=$tmp;
							mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die(mysql_error());
						}
					}

					if ($paytype == 1) {
						$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
						if ($needm > 0) {
							mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - ".$needm." WHERE `id`= '{$us['id']}'") or die(mysql_error());
							$us['gold'] -= $needm;
						}
					}

					if ($paytype == 2) {
						mysql_query('DELETE FROM oldbk.inventory WHERE owner = "'.$us['id'].'" AND id = '.$sert['id']) or die();
					}

					if ($diffprice > 0) {
						mysql_query("UPDATE `oldbk`.`users` SET `money` = `money` - ".$diffprice." WHERE `id`= '{$us['id']}'") or die(mysql_error());
						$us['money'] -= $diffprice;
					}

					// выдаём шмот
					if (count($mfinfo)) {
						$mfinfo = mysql_real_escape_string(serialize($mfinfo));
					} else {
						$mfinfo = "";
					}


					mysql_query("INSERT INTO oldbk.`inventory`
					(`prototype`,`sowner`,`present`,`owner`,`name`,`type`,`massa`,`cost`,`img`,`maxdur`,`isrep`,`nclass`,
					`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
					`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,`idcity`,`ab_mf`,  `ab_bron` ,  `ab_uron`,
					`otdel`,`gmp`,`gmeshok`, `group`,`letter`,
					`mfbonus`,`stbonus`,`ups`,`unik`,`charka`,
					`includemagic`,`includemagicdex`,`includemagicmax`,`includemagicname`,`includemagicuses`,`includemagiccost`,`includemagicekrcost`,`ekr_flag`,`ecost`,`mfinfo`,`includerechargetype`,`includeprototype`
					)
					VALUES
					('{$rowready['id']}','{$rowready['sowner']}','{$rowready['present']}','{$_SESSION['uid']}','{$rowready['name']}','{$rowready['type']}',{$rowready['massa']},{$rowready['cost']},'{$rowready['img']}',{$rowready['maxdur']},{$rowready['isrep']},'{$rowready['nclass']}', '{$rowready['gsila']}','{$rowready['glovk']}','{$rowready['ginta']}','{$rowready['gintel']}','{$rowready['ghp']}','{$rowready['gnoj']}','{$rowready['gtopor']}','{$rowready['gdubina']}','{$rowready['gmech']}','{$rowready['gfire']}','{$rowready['gwater']}','{$rowready['gair']}','{$rowready['gearth']}','{$rowready['glight']}','{$rowready['ggray']}','{$rowready['gdark']}','{$rowready['needident']}','{$rowready['nsila']}','{$rowready['nlovk']}','{$rowready['ninta']}','{$rowready['nintel']}','{$rowready['nmudra']}','{$rowready['nvinos']}','{$rowready['nnoj']}','{$rowready['ntopor']}','{$rowready['ndubina']}','{$rowready['nmech']}','{$rowready['nfire']}','{$rowready['nwater']}','{$rowready['nair']}','{$rowready['nearth']}','{$rowready['nlight']}','{$rowready['ngray']}','{$rowready['ndark']}',
					'{$rowready['mfkrit']}','{$rowready['mfakrit']}','{$rowready['mfuvorot']}','{$rowready['mfauvorot']}','{$rowready['bron1']}','{$rowready['bron2']}','{$rowready['bron3']}','{$rowready['bron4']}','{$rowready['maxu']}','{$rowready['minu']}','{$rowready['magic']}','{$rowready['nlevel']}',
					'{$rowready['nalign']}',0,0,'{$us[id_city]}','{$rowready['ab_mf']}',  '{$rowready['ab_bron']}','{$rowready['ab_uron']}'
					,'{$rowready['razdel']}','{$rowready['gmp']}','{$rowready['gmeshok']}','{$rowready['group']}','{$rowready['letter']}',
					'{$rowready['mfbonus']}','{$rowready['stbonus']}','{$rowready['ups']}','{$rowready['unik']}','{$rowready['charka']}',
					'{$ifound['includemagic']}','{$ifound['includemagicdex']}','{$ifound['includemagicmax']}','{$ifound['includemagicname']}','{$ifound['includemagicuses']}','{$ifound['includemagiccost']}','{$ifound['includemagicekrcost']}','{$rowready['ekr_flag']}','{$rowready['ecost']}','{$mfinfo}','{$ifound['includerechargetype']}','{$ifound['includeprototype']}'
					) ;") or die(mysql_error());


					//пишем в дело
					$rec = array();
  		    			$rec['owner']=$us['id'];
					$rec['owner_login']=$us['login'];
					$rec['owner_balans_do']=$diffprice > 0 ? $us['money']+$diffprice : $us['money'];
					$rec['owner_balans_posle']=$us['money'];
					$rec['target_login']="КО";
					$rec['type']=1315;
					$rec['sum_kr'] = $diffprice > 0 ? $diffprice : 0;
					$rec['sum_ekr']=$tmp;
					$rec['sum_kom']=0;//комиссия
					$rec['sum_rep']=0;
					$rec['item_id']=get_xitem_fid(array('id' => mysql_insert_id(), 'idcity' => 0));
					$rec['item_name']=$rowready['name'];
					$rec['item_count']=1;
					$rec['item_type']=$rowready['type'];
					$rec['item_cost']=$rowready['cost'];
					$rec['item_dur']=$rowready['duration'];
					$rec['item_maxdur']=$rowready['maxdur'];
					$rec['item_ups']=$rowready['ups'];
					$rec['item_unic']=0;
					$rec['item_incmagic']='';
					$rec['item_incmagic_count']='';
					$rec['item_arsenal']='';
					$rec['bank_id']=$bank['id'];
					if ($paytype == 1 && $needm > 0) {
						$rec['add_info']='Обмен уникального предмета:'.get_xitem_fid($ifound).':'.$ifound[name].':'.$us['gold'].':'.$needm;
					} else {
						$rec['add_info']='Обмен уникального предмета:'.get_xitem_fid($ifound).':'.$ifound[name];
					}
					add_to_new_delo($rec) or die(mysql_error()); //юзеру

					//  если была картинка то снимаем
					if($ifound['add_pick'] != '') {
						undress_img($ifound);
					}

					mysql_query('UPDATE oldbk.inventory SET owner = 450 WHERE owner = "'.$us['id'].'" AND id = '.$ifound['id']) or die();

					$q = mysql_query('COMMIT') or die();

					//пишем системку
					systemtotelo($us,'Вы получили <b>'.$rowready['name'].'</b>, в обмен на <b>'.$ifound['name'].'</b>.');
					serr("Вы получили новую вещь: ".$rowready["name"]);
					echo'</td></tr>
						</table>
						</center><br><br><br>
					';
					return;
				}
			}


			echo '<br><form method="POST"><b>Стоимость обмена:</b><br>';
			echo '<div id="bankinfo"><input type="radio" name="paytype" value="0"><font color=red><b>'.$bprice.' екр</font></b> Банковский счет: '.$BANKS.' пароль <input type=password size=8 name=bankpass></div>';
			echo '<div id="goldinfo"><input type="radio" name="paytype" value="1"><font color=red><b>'.round(($bprice*$EKR_TO_GOLD)*0.9).' монет (с учетом скидки 10%)</font></b> (в наличии <b>'.$us['gold'].'</b> монет)</div>';
			$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' and prototype = 540 and (sowner = 0 or sowner = '.$us['id'].') and setsale = 0 LIMIT 1');
			if (mysql_num_rows($q)) {
				$sert = mysql_fetch_assoc($q);
				echo '<div id="sertinfo"><input type="radio" name="paytype" value="2">Использовать сертификат <img width=15 height=15 src="https://i.oldbk.com/i/sh/'.$sert['img'].'"> (cap'.$sert['id'].')</div>';
			}
			echo '<br><br>';
			// ifound = вещь на обмен
			// iproto = прототип вещи на обмен
			// ifound2 = прототип новой вещи
			// rowready - новая вещь подсчитанная выше


			if (($iproto['unikflag'] > 0 && $rowready['unikflag'] > 0 && $rowready['ekr_flag'] > 0) || $diffprice > 0) {
				$tmp = $rowready['unikflag'] - $iproto['unikflag'];
				if ($tmp < 0) $tmp = 0;

				if ($tmp > 0 || $diffprice > 0) {
					echo '<span style="width:100px;"><b>Доплата:</b> ';

					if ($diffprice > 0) {
						echo '<font color=red><b>'.$diffprice.' кр</font></b>';
					}

					if ($tmp > 0 && $rowready['ekr_flag'] > 0) {
						if ($diffprice > 0) echo ' и ';
						echo '<font color=red><b>'.$tmp.' екр, не забудьте выбрать банковский счёт</font></b>';
					}
					echo '</span>';
				}
			}
			echo '<br><br>';

			echo '<input type="submit" value="Обменять вещь" class="button2" name="Обменять вещь"><br>';
			echo '</form><br>';

			echo '</td></tr>';
		}

		echo'
		</table>
		</center>
		';
	}
}

function ShowDelRuns() {
	require_once('runs_exp_table.php');

	global $user;
	global $EKR_TO_GOLD;

	if ($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['mkrunsids']) && isset($_POST['newruns']) && isset($_POST['paytype'])) {
		$paytype = $_POST['paytype'];
		if (!in_array($paytype,[0,1])) die();

		$ids = explode(",",$_POST['mkrunsids']);
		$new_runa=(int)($_POST['newruns']);

		if (count($ids) > 0 && !empty($ids[0])) {
			while(list($k,$v) = each($ids)) {
				$ids[$k] = intval($v);
			}

			$us = check_users_city_datal($user);
			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ((bs_owner=0 AND goden=0 AND prokat_idp=0 AND dressed = 0 AND setsale = 0 AND sowner = '.$us['id'].'  AND type=30)  )  ) AND id IN('.implode(",",$ids).') ');
			$ekrnum = 0;
			$artnum = 0;
			$artid = 0;
			$artinfo = array();
			$ekrids = array();
			$useditems = "";
			$bprice = 0;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

				if ($i['type'] == "30") {
					//руна
					$artnum++;
					$artinfo = $i;
					$artid = $i['id'];

					if ($i['up_level'] <= "9") {
						if ($i['up_level'] <= "5") {
							$bprice = 5;
						} else {
							$bprice = 10;
						}
					} else {
						$bprice = 15;
					}


					if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
						$bprice = 0;
					}
				}
			}

			$get_new_run=mysql_fetch_array(mysql_query("select * from oldbk.cshop where id='{$new_runa}' and type=30 LIMIT 1"));

			if (!($get_new_run>0)) {
				serr("Ошибка выбора новой руны!");
			} elseif ($get_new_run['id']==$artinfo['prototype']) {
				serr("Нет смысла менять руну на такую же!");
			} elseif ($artnum != 1) {
				serr("Одновременно можно обменять только одну руну!");
			} else {
				$good = true;
				if ($paytype == 0) {
					if (($_POST['bankpass']=='') OR ($_POST['bankid']=='')) {
						serr("Вы не указали пароль от банковского счета!");
						$good = false;
					} else {
						$bankid=(int)($_POST['bankid']);
						$bankpas=$_POST['bankpass'];
						$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
						if ($bank['id']>0) {
							if (($bank['ekr']) < $bprice) {
								serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
								$good = false;
							}
						} else {
							serr('Ошибка! Не верный пароль от банковского счета!');
							$good = false;
						}
					}
				}
				if ($paytype == 1) {
					$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
					if ($us['gold'] < $needm) {
						serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
						$good = false;
					}
				}

				if ($good) {
					// всё ок - начинаем
					if($artinfo['add_pick'] != '') {
						undress_img($artinfo);
					}

					serr("Вы удачно сдали старую руну: ".$artinfo["name"]);
					systemtotelo($us,"Вы удачно сдали руну \"".$artinfo["name"]."\"");
					$q = mysql_query('START TRANSACTION') or die();

					if ($paytype == 0) {
						$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
						if (!(mysql_num_rows($get_bank) > 0)) {
							die();
						} else {
							$bank = mysql_fetch_assoc($get_bank);

							mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
							//  пишем в хистори банка
							$bank['ekr']-=$bprice;
							mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
						}
					}

					if ($paytype == 1) {
						$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
						if ($needm > 0) {
							mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - ".$needm." WHERE `id`= '{$us['id']}'") or die(mysql_error());
							$us['gold'] -= $needm;
						}
					}

					mysql_query('DELETE FROM oldbk.inventory WHERE id ='.$artid.'  ') or die();

					//выдаем нужную руну

					$dress=$get_new_run;
					$newlvl=$artinfo['up_level'];

					for ($i=1;$i<=$newlvl;$i++) {
						$add_cost+=30;
						//готовим нужные статы и параметры
						$pre=$runs_exp_table[$i];
						foreach($pre as $k=>$v)	{
							$new_data[$k]+=$v;
						}
					}

					$dress['cost']+=$add_cost;
					$dress['ghp']+=$new_data[ghp];
					$dress['bron1']+=$new_data[bron];
					$dress['bron2']+=$new_data[bron];
					$dress['bron3']+=$new_data[bron];
					$dress['bron4']+=$new_data[bron];
					$dress['gfire']+=$new_data[smast];
					$dress['gwater']+=$new_data[smast];
					$dress['gair']+=$new_data[smast];
					$dress['gearth']+=$new_data[smast];
					$dress['gmp']+=$new_data[gmp];
					$dress['gintel']+=$new_data[gintel];
					$dress['minu']+=$new_data[minu];
					$dress['maxu']+=$new_data[maxu];
					$dress['stbonus']+=$new_data[stbonus];
					$dress['mfbonus']+=$new_data[mfbonus];
					$dress['add_time']=$artinfo['add_time'];
					$dress['ups']=$artinfo['ups'];
					$dress['up_level']=$newlvl;

					if ($newlvl >= 5) {
						$arr_add_param=$runs_5lvl_param[$get_new_run[id]];
					} else {
						$arr_add_param = array('ab_mf' => 0, 'ab_bron' => 0, 'ab_uron' => 0);
					}

					if ($newlvl==30) {
	 	  				//бонус 30 левел +1% (к даваемым изначально рунным усилкам)
	 	  				$arr_add_param[ab_mf]=($arr_add_param[ab_mf]>0)?$arr_add_param[ab_mf]+1:0;
	 	  				$arr_add_param[ab_bron]=($arr_add_param[ab_bron]>0)?$arr_add_param[ab_bron]+1:0;
	 	  				$arr_add_param[ab_uron]=($arr_add_param[ab_uron]>0)?$arr_add_param[ab_uron]+1:0;
 	  				}

		 	  		$dress['ab_mf']=$arr_add_param[ab_mf];
					$dress['ab_bron']=$arr_add_param[ab_bron];
					$dress['ab_uron']=$arr_add_param[ab_uron];


					//создаем новую сразу персу
					mysql_query("INSERT INTO oldbk.`inventory`
						(`prototype`,`owner`,`name`,`type`,`massa`,`cost`, `repcost`, `img`,`maxdur`,`isrep`,`nclass`,
							`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,
							`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,
							`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,
							`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`otdel`,`group` ,`gmp`,`gmeshok`,`ecost`,`mfbonus`,`sowner`,`up_level`,`idcity`,`ab_mf`,`ab_bron`,`ab_uron` ,`add_time` , `present` ,`stbonus`, `ups`
						)
						VALUES
						('{$dress['id']}','{$us['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']}, {$dress['repcost']},
						'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}',
						'{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}',
						'{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}',
						'{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}',
						'{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}',
						'{$dress['ngray']}','{$dress['ndark']}', '{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}',
						'{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}',
						'{$dress['nlevel']}','{$dress['nalign']}','{$dress['razdel']}','{$dress['group']}' ,
						'{$dress['gmp']}','{$dress['gmeshok']}','{$dress['ecost']}','{$dress['mfbonus']}','{$us['id']}','{$dress['up_level']}','0','{$dress['ab_mf']}',
						'{$dress['ab_bron']}','{$dress['ab_uron']}', '{$dress['add_time']}' , 'Мироздатель' , '{$dress['stbonus']}', '{$dress['ups']}') ");

					$dress['id']=mysql_insert_id();

					//пишем лог
					mysql_query("INSERT INTO `oldbk`.`obmen_run` SET `komu`='{$us[id]}',`kto`='450',`chto`='".get_xitem_fid($artinfo).":".$artinfo[name].":".$artinfo[up_level].":".$artinfo[ups]."',`nachto`='cap".$dress['id'].":".$dress['name'].":".$dress['up_level'].":".$dress['ups']."';");

					//пишем в дело
					$rec = array();
  		    			$rec['owner']=$us['id'];
					$rec['owner_login']=$us['login'];
					$rec['owner_balans_do']=$us['money'];
					$rec['owner_balans_posle']=$us['money'];
					$rec['target_login']="КО";
					$rec['type']=1314;
					$rec['sum_kr']=0;
					if ($paytype == 0) $rec['sum_ekr']=$bprice; // стоимость обмена
					$rec['sum_kom']=0;//комиссия
					$rec['sum_rep']=$dress['repcost'];
					$rec['item_id']=get_xitem_fid($dress);
					$rec['item_name']=$dress['name'];
					$rec['item_count']=1;
					$rec['item_type']=$dress['type'];
					$rec['item_cost']=$dress['cost'];
					$rec['item_dur']=$dress['duration'];
					$rec['item_maxdur']=$dress['maxdur'];
					$rec['item_ups']=$dress['ups'];
					$rec['item_unic']=0;
					$rec['item_incmagic']='';
					$rec['item_incmagic_count']='';
					$rec['item_arsenal']='';
					$rec['bank_id']=$bank['id'];
					if ($paytype == 1) {
						$rec['add_info']='Обмен руны: '.get_xitem_fid($artinfo).':'.$artinfo[name].':'.$artinfo[up_level].':'.$artinfo[ups].':'.$us['gold'].':'.$needm;
					} else {
						$rec['add_info']='Обмен руны: '.get_xitem_fid($artinfo).':'.$artinfo[name].':'.$artinfo[up_level].':'.$artinfo[ups];
					}
					add_to_new_delo($rec); //юзеру

					//пишем системку
					serr("Вы получили новую руну: ".$dress["name"]);
					systemtotelo($us,'Вы получили <b>'.$dress['name'].'</b>, в обмен на <b>'.$artinfo['name'].'</b>.');

					echo '<br><br>';
					// всё ок, закончили
					$q = mysql_query('COMMIT') or die();
				}
			}
		}
	}


	echo "<br>
		<table width=\"940\" border=\"0\" align=\"left\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> ОБМЕН РУН</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете обменять свои руны на другие, но только если Ваши руны не ниже 5 уровня.</center>
		<div align=left>
		<p><b style=\"color:#800000\">Требования для обмена руны:</b><br>
		- руна должна быть не одета<br></p>
		<p><b style=\"color:#800000\">При обмене руны вы получаете:</b><br>

		- другую руну того же уровня и с тем же количеством рунного опыта, что и старая<br></p>
		<p><b style=\"color:#800000\">Стоимость обмена:</b><br>
			 руны до 5-го уровня - 5 екр / 90 монет (с учетом скидки 10%)<br>
			 руны 6-9 уровня - 10 екр / 180 монет (с учетом скидки 10%)<br>
			 руны 10-го уровня и выше - 15 екр / 270 монет (с учетом скидки 10%).<br>";

	if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
		echo "<font color=red>На время действия акции услуга обмена бесплатна.</font><br>";//«Свобода выбора»
	}

	echo "</p>
		<p><table><tr valign=middle><td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами]&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></p>
		<p><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
		</div>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>
	";

	$us = check_users_city_datal($user);


	$BANKS = "";

	$get_bank = mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
	if (mysql_num_rows($get_bank)) {
		$BANKS = "<select style='width:150px' name=bankid>";
		while($row = mysql_fetch_assoc($get_bank)) {
			$BANKS.="<option>".$row['id']."</option>";
		}
		$BANKS .= "</select>";
	}

	echo '
		<style>
		#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
		</style><br><br><br>
		<center>Рун: <span id="artnum" style="font-weight:bold;">0</span> шт.

		<br><font style="color:#800000">Стоимость обмена этой руны: <span id="needekr" style="font-weight:bold;">0</span> екр или <span id="needgold" style="font-weight:bold;">0</span> монет</font>
		<br><br>

		<div id="allconstr">
			<div id="snaptarget">
				Переместите сюда руну для обмена
			</div><br><form id="mkdart" method="POST">
	';

	echo 'Выберите новую руну:
		<select name="newruns" id="newruns">
		<option value=0 selected >------------------------------------------------------------</option>
	';

	$get_r = mysql_query("select * from cshop where type=30 order by id");
	while ($r = mysql_fetch_assoc($get_r)) {
		echo "<option value='{$r[id]}'>{$r[name]}</option>";
	}
	echo '</select><br><br><br>';

	echo '<input type="hidden" id="mkrunsids" name="mkrunsids" value="">
		<table>
	';

	if (strlen($BANKS)) echo '<tr><td><input type="radio" name="paytype" value="0"></td><td>Банковский счет: '.$BANKS.' пароль <input type=password size=8 name=bankpass></td></tr>';

	echo	'<tr><td><input type="radio" name="paytype" value="1"></td><td>Золотыми монетами, у вас в наличии <b>'.$us['gold'].'</b> монет</td></tr></table><br>
		<input type="button" value="ОБМЕНЯТЬ РУНУ" class="button2" name="Сдать артефакт(ы)" OnClick="CheckF();"></form><br>
	';

	$ids = array();

	$us = check_users_city_datal($user);
	$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND ((bs_owner=0 AND goden=0 and prokat_idp=0 AND dressed = 0 AND setsale = 0 AND sowner = '.$us['id'].'  AND type=30)  ) ORDER BY ecost DESC');

	if (mysql_num_rows($q) > 0) {
		while($i = mysql_fetch_assoc($q)) {
			$ids[] = $i['id'];

			if ($i['type']==30) {
				echo '<span name="rlev'.$i['up_level'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="«'.$i['name'].'» Уровень:'.$i['up_level'].' Опыт: '.$i['ups'].' " title="«'.$i['name'].'» Уровень:'.$i['up_level'].' Опыт: '.$i['ups'].' " src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
			} else {
				echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
			}
		}


		echo '
			<script>
			var spans = [];
			var artnum = 0;

			var bprice = 0;
			var arttype = 0;

			function CheckF() {
				if (spans.length == 0) {
					alert("Вы ничего не положили");
					return;
				}

				if (artnum > 1) {
					alert("За раз можно обменять только одну руну");
					return;
				}

				if (artnum < 1) {
					alert("Нужно перенести руну для обмена");
					return;
				}

				if (document.getElementById("newruns").value==0) {
					alert("Нужно выбрать новую руну для обмена");
					return;
				}


				if (confirm("Вы уверены?")) {
					document.getElementById("mkdart").submit();
				}

			}

			$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
			$("#allconstr span" ).bind( "dragstop", function(event, ui) {
			spans.splice(0,spans.length);


			$("#allconstr span").each(function(index,item) {
				m = $("#allconstr").offset().top;

				if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
					spans.push(item);
				}
			});

			artnum = 0;

			var ids = new Array();

			for (key in spans) {
				var n = spans[key];
				itemid = n.id;
				itemid = itemid.substring(4);
				itemproto = $("#"+n.id).attr("name");
				itemproto = itemproto.substr(4);
				ids.push(itemid);


				if (itemproto<=9) {
					bprice = 10
					if (itemproto<=5) {
						bprice = 5;
					}
				} else {
					bprice = 15;
				}
		';

		if(time()>mktime(15,0,0,8,16,2016) && time()<mktime(23,59,59,8,21,2016)) {
				echo 'bprice = bprice / 2;';
		}

		if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
				echo 'bprice = 0;';
		}

		echo '
				artnum++;
			}

			document.getElementById("mkrunsids").value = ids.join();
			document.getElementById("needekr").innerHTML = bprice;
			document.getElementById("needgold").innerHTML = Math.round(bprice*'.$EKR_TO_GOLD.'*0.9);
			document.getElementById("artnum").innerHTML = artnum;


			});
			</script>
		';
	} else {
		echo 'У вас нет рун или они одеты на вас';
	}
	echo '</div></center></div>';
}


function ShowArtChMenu()
{

echo "<br><br>

<table width=\"650\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=650 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><br><a href=?act=mkartch><b style=\"color:#800000\">ДЛЯ ПОДНЯТИЯ ЛИЧНОГО АРТЕФАКТА НА БОЛЕЕ ВЫСОКИЙ УРОВЕНЬ (тот же слот) НАЖМИТЕ ЗДЕСЬ</b></a><br><br></center></td></tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br>

<table width=\"650\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=650 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><br><a href=?act=mkartch2><b style=\"color:#800000\">ДЛЯ ОБМЕНА ЛИЧНОГО АРТЕФАКТА НА ДРУГОЙ СЛОТ ИЛИ ПЕРЕСОЗДАНИЕ В ТОМ ЖЕ СЛОТЕ НАЖМИТЕ ЗДЕСЬ </b></a><br><br></center></td></tr>

<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>

<br>
<table width=\"650\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=650 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><br><a href=?act=mkartchf><b style=\"color:#800000\">ДЛЯ ОБМЕНА ЛИЧНОГО АПНУТОГО АРТЕФАКТА (устаревшая вещь) НАЖМИТЕ ЗДЕСЬ</b></a><br><br></center></td></tr>

<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br>
<table width=\"650\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=650 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><br><a href=?act=chhramart><b style=\"color:#800000\"> ДЛЯ ОБМЕНА ХРАМОВОГО АРТЕФАКТА НА ДРУГОЙ ХРАМОВЫЙ АРТЕФАКТ НАЖМИТЕ ЗДЕСЬ</b></a><br><br></center></td></tr>

<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br>
<table width=\"650\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=650 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><br><a href=?act=mkartch3><b style=\"color:#800000\">ДЛЯ ОБМЕНА ХРАМОВОГО АРТЕФАКТА НА ЛИЧНЫЙ АРТЕФАКТ НАЖМИТЕ ЗДЕСЬ</b></a><br><br></center></td></tr>

<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>

<br>





";

}


function CHHramArt(){
	global $user;
	global $EKR_TO_GOLD;

	$bprice = 5;

	if(($_SERVER['REQUEST_METHOD'] == "POST" ) AND (($_POST['mkdartids'])OR($_POST['my_oldart'])))  {
		if ($_POST['mkdartids']) {
			$ids[]=(int)($_POST['mkdartids']);
		}

		$myold=(int)($_POST['my_oldart']);
		if ($myold>0) {
			$ids[]=$myold;
		}

		$us = check_users_city_datal($user);
		$q = mysql_query('SELECT * FROM oldbk.inventory WHERE (owner = '.$us['id'].' AND ( (setsale=0 AND bs_owner=0 AND dressed = 0  AND (sowner = '.$us['id'].'  OR sowner=0) AND arsenal_klan="" AND prototype in (2000,2001,2002,260,262,284,283,18210,18229,18247,18527) ) OR (setsale=0 and prototype=100000) OR (setsale=0 and prototype=541) ))  AND id IN('.implode(",",$ids).') ');

		$ekrnum = 0;
		$artnum = 0;
		$artid = 0;
		$artinfo = array();
		$ekrids = array();
		$useditems = "";

		while($i = mysql_fetch_assoc($q)) {
			$useditems .= get_xitem_fid($i).",";
			if ($i['prototype'] == "100000") {
				$pay_vau_ko=true;
				$pay_vau_id = $i['id'];
				$pay_vau_any=false;
			} elseif ($i['prototype'] == "541") {
				$pay_vau_ko=true;
				$pay_vau_any=true;
				$pay_vau_id = $i['id'];
			} else {
				$artnum++;
				$artinfo = $i;
				$_SESSION['artinfo_old']=$artinfo;
				$artid = $i['id'];

				if ($_POST['new_art_proto']) {
					$new_pro=(int)$_POST['new_art_proto'];
					$my_new_art=mysql_fetch_assoc(mysql_query("select * from oldbk.eshop where id in (2000,2001,2002,260,262,284,283,18210,18229,18247,18527) and id={$new_pro} and id!='{$artinfo['prototype']}'  "));
					if (!($my_new_art['id']>0)) {
						unset($_POST['new_art_proto']);
					}
				}

				//понимаем какая стоимость обмена - если есть уже
				if ($my_new_art['id']>0) {
					if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
						$bprice = 0;
					} else {

						if ($my_new_art['type']==$artinfo['type']) {
							// пушка на пушу или броня на броню, это стоит 40 ваучеров
							//$bprice = 5; //40
						} else {
							//$bprice = 5; //80
						}
					}

				 	if (($my_new_art['type']==$artinfo['type'] && $artinfo['type']==3 && $pay_vau_ko==true) || $pay_vau_any == true) {
					 	 // возможно оплата бамажкой
				 	} else {
					 	$pay_vau_ko=false;
				 	}
				}
			}
		}

                $repair_cost=calc_repair_cost($us,$artinfo);
		//if (($us['klan']=='minion')  /*OR ($us['klan']=='Animals')  OR ($us['klan']=='LastLegion') */ )	{$bprice = 0;}

		$needm = 0;

		if ($my_new_art['id']>0 && (isset($_POST['paytype']) || $pay_vau_ko)) {
			if (!$pay_vau_ko) {
				if (!in_array($_POST['paytype'],[0,1])) die();
				$paytype = $_POST['paytype'];
			}

			if ($artnum != 1) {
				serr("За раз можно сдать только один артефакт");
			} else {
				if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='') ) AND ($pay_vau_ko==false) && $paytype == 0) {
					serr("Вы не указали пароль от банковского счета!");
				} elseif ($pay_vau_ko==false && $paytype == 0) {
					//если оплата не бамажкой
					$bankid=(int)($_POST['bankid']);
					$bankpas=$_POST['bankpass'];
					$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

					if ($bank['id']>0) {
						if (($repair_cost>0) and ($us['money']<$repair_cost)) {
							serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
						} elseif (($bank['ekr']) < $bprice) {
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else {
							// всё ок
							$bankok=true;
						}
					} else {
						serr('Ошибка! Не верный пароль от банковского счета!');
					}
				} elseif ($paytype == 1) {
					if (($repair_cost>0) and ($us['money']<$repair_cost)) {
						serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
					} else {
						$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
						if ($us['gold'] < $needm) {
							serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
						} else {
							$goldgood = true;
						}
					}
				} elseif ($pay_vau_ko==true) {
					if (($repair_cost>0) and ($us['money']<$repair_cost)) {
						serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
						$pay_vau_ko = false;
					}
				}



				if ($bankok==true || $pay_vau_ko==true || $goldgood == true) {
					//есть ид нового арта
					// всё ок - начинаем обмен
					if($artinfo['add_pick'] != '') 	{
						undress_img($artinfo);
					}

					//ремонт старого
					if ($artinfo['duration']>0) {
						$q = mysql_query('START TRANSACTION') or die("e9");
						if (repair_old_art($artinfo,$us)) {
							$artinfo['duration']=0;
						}
						$q = mysql_query('COMMIT') or die("e10");
					}


					//echo "всё ок - начинаем обмен....";
					$q = mysql_query('START TRANSACTION') or die("Errr1");
					// сносим все вещи и арт

					if ($pay_vau_ko==true)	{
						//если ваучер ко то удаляем ваучер и арт
						mysql_query('DELETE FROM oldbk.inventory WHERE id IN ('.$pay_vau_id.','.$artid.')') or die("Errr2");
					} elseif ($paytype == 1) {
						mysql_query('DELETE FROM oldbk.inventory WHERE id='.$artid) or die("Errr22");
						$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
						if ($needm > 0) {
							mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - ".$needm." WHERE `id`= '{$us['id']}'") or die(mysql_error());
							$us['gold'] -= $needm;
						}
					} elseif ($paytype == 0) {
						//удаляем только арт
						mysql_query('DELETE FROM oldbk.inventory WHERE id='.$artid) or die("Errr22");

						$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
						if (!(mysql_num_rows($get_bank) > 0)) {
							die();
						} else {
							$bank = mysql_fetch_assoc($get_bank);

							mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
							//  пишем в хистори банка
							$bank['ekr']-=$bprice;
							mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
						}

					} else {
						die();
					}

					$message .= serre("Вы удачно сдали артефакт: ".$artinfo["name"]);
					systemtotelo($us,"Вы удачно сдали артефакт \"".$artinfo["name"]."\"");


					//перенос гребаного АПА
					if ($artinfo['nlevel']>$my_new_art['nlevel']) {
						$my_new_art=MK_UP_ART($my_new_art,$artinfo['nlevel']);
					}


					if (($artinfo['type']==3) AND ($my_new_art['type']==3) and  (strpos($artinfo['name'], '+') !== false) and ($artinfo['sharped'] == "1"))	{
						//переносим точку в новую пуху
						// проверяем заточку
						preg_match('~\+([\d]+)~iU',$artinfo['name'],$m);
						$sharp=$m[1];
						if ($sharp > 0) {
							$sharp=$m[1];
							$my_new_art['minu']+=$sharp;
							$my_new_art['maxu']+=$sharp;
							$my_new_art['cost']+=30;
							$my_new_art['name']=$my_new_art['name']."+".$sharp;
							$my_new_art['sharped']=1;

							$my_new_art['otdel']=$my_new_art['razdel'];//т.к. новый из магаза

							if ($my_new_art['otdel']==1)  {
								$my_new_art['nnoj']+=$sharp;
								$my_new_art['ninta']+=$sharp;
							} elseif ($my_new_art['otdel']==11) {
								$my_new_art['ntopor']+=$sharp;
								$my_new_art['nsila']+=$sharp;
							} elseif ($my_new_art['otdel']==12) {
								$my_new_art['ndubina']+=$sharp;
								$my_new_art['nlovk']+=$sharp;
							} elseif ($my_new_art['otdel']==13) {
								$my_new_art['nmech']+=$sharp;
								$my_new_art['nvinos']+=$sharp;
							}
						}
					} elseif (($artinfo['type']==3) AND ($my_new_art['type']!=3) and  (strpos($artinfo['name'], '+') !== false) and ($artinfo['sharped'] == "1")) {
						// выдаем свиток
						// проверяем заточку
						preg_match('~\+([\d]+)~iU',$artinfo['name'],$m);
						if (isset($m[1])) {
							// есть заточка
							// топор - 11
							// дубина - 12
							// кинжал - 1
							// мечи - 13
							$otdel = $artinfo['otdel'];

							$z = array(
								1 => array(
									1 => 163,
									2 => 164,
									3 => 165,
									4 => 166,
								),
								11 => array(
									1 => 157157,
									2 => 156156,
									3 => 155,
									4 => 154,
								),
								12 => array(
									1 => 158,
									2 => 159,
									3 => 160,
									4 => 161,
								),
								13 => array(
									1 => 150,
									2 => 151,
									3 => 152,
									4 => 153,
								),
							);
							$zz = array(5 => 8090, 6 => 9099, 7 => 190199, 8=>190191, 9=>190192);

							$sowner=0;
							if (($m[1]==6) or ($m[1]==7) or ($m[1]==8) or ($m[1]==9)) {
								$dress = mysql_query('SELECT * FROM oldbk.cshop WHERE id = '.$zz[$m[1]]) or die("Errr00011");
								$sowner=$us['id'];
							} elseif ($m[1] <= 4) {
								$dress = mysql_query('SELECT * FROM oldbk.shop WHERE id = '.$z[$artinfo['otdel']][$m[1]]) or die("Errr0001");
							} else {
								$dress = mysql_query('SELECT * FROM oldbk.eshop WHERE id = '.$zz[$m[1]]) or die("Errr00011");
							}

							$dress = mysql_fetch_assoc($dress);

							if ($dress !== FALSE) {
								mysql_query("INSERT INTO oldbk.`inventory`
									(`present`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
									`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
									`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
									`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`, `img_big`
									)
									VALUES
									('КО','{$dress['id']}','{$us['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
									'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
									'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
									,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$sowner}', '{$dress['img_big']}'
									);
								") or die();

								//new_delo
								$rec = array();
			  		    			$rec['owner']=$us[id];
								$rec['owner_login']=$us[login];
								$rec['owner_balans_do']=$us['money'];
								$rec['owner_balans_posle']=$us['money'];
								$rec['target_login']="КО";
								$rec['type']=99; // получил предмет
								$rec['sum_kr']=0;
								$rec['sum_ekr']=0;
								$rec['sum_kom']=0;
								$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => mysql_insert_id()));
								$rec['item_name']=$dress[name];
								$rec['item_count']=1;
								$rec['item_type']=$dress['type'];
								$rec['item_cost']=$dress['cost'];
								$rec['item_dur']=$dress['duration'];
								$rec['item_maxdur']=$dress['maxdur'];
								$rec['item_ups']=$dress['ups'];
								$rec['item_unic']=$dress['unic'];
								$rec['item_incmagic']=$dress['includemagicname'];
								$rec['item_incmagic_count']=$dress['includemagicuses'];
								$rec['item_arsenal']='';
								$rec['item_proto']=$dress['prototype'];
								$rec['item_sowner']=($dress['sowner']>0?1:0);
								$rec['item_incmagic_id']=$dress['includemagic'];
								if (add_to_new_delo($rec) === FALSE) die();

								$message.=serre("- успешно выдан свиток ".$dress['name']);
								systemtotelo($us,"Успешно выдан свиток ".$dress['name']);
							}

						}
					}

					//теперь перебиваем встройку
					if ( ($artinfo['includemagic']>0) AND ($artinfo['includemagicuses']>0)) {
						///перенос встроек из старого арта
						$my_new_art['includemagic']=$artinfo['includemagic'];
						$my_new_art['includemagicdex']=$artinfo['includemagicdex'];
						$my_new_art['includemagicmax']=$artinfo['includemagicmax'];
						$my_new_art['includemagicname']=$artinfo['includemagicname'];
						$my_new_art['includemagicuses']=$artinfo['includemagicuses'];
						$my_new_art['includemagiccost']=$artinfo['includemagiccost'];
						$my_new_art['includemagicekrcost']=$artinfo['includemagicekrcost'];
						$my_new_art['includerechargetype']=$artinfo['includerechargetype'];
						$my_new_art['includeprototype']=$artinfo['includeprototype'];
						$my_new_art['nintel']=$my_new_art['nintel']<$artinfo['nintel']?$artinfo['nintel']:$my_new_art['nintel'];
						$my_new_art['nmudra']=$my_new_art['nmudra']<$artinfo['nmudra']?$artinfo['nmudra']:$my_new_art['nmudra'];
						$my_new_art['nfire']=$my_new_art['nfire']<$artinfo['nfire']?$artinfo['nfire']:$my_new_art['nfire'];
						$my_new_art['nwater']=$my_new_art['nwater']<$artinfo['nwater']?$artinfo['nwater']:$my_new_art['nwater'];
						$my_new_art['nair']=$my_new_art['nair']<$artinfo['nair']?$artinfo['nair']:$my_new_art['nair'];
						$my_new_art['nearth']=$my_new_art['nearth']<$artinfo['nearth']?$artinfo['nearth']:$my_new_art['nearth'];
						$my_new_art['nlight']=$my_new_art['nlight']<$artinfo['nlight']?$artinfo['nlight']:$my_new_art['nlight'];
						$my_new_art['ngray']=$my_new_art['ngray']<$artinfo['ngray']?$artinfo['ngray']:$my_new_art['ngray'];
						$my_new_art['ndark']=$my_new_art['ndark']<$artinfo['ndark']?$artinfo['ndark']:$my_new_art['ndark'];
					}

					//переносим  важные вещи :)
					$my_new_art['sowner']=$artinfo['sowner'];
					$my_new_art['present']=$artinfo['present'];
					$my_new_art['repcost']=$artinfo['repcost'];

					// перенос екр флага
					$my_new_art['ekr_flag'] = $artinfo['ekr_flag'];

					$item_proto=$my_new_art['id'];


					//теперь инсертим новый арт
					$str=''; $sql='';
					if($my_new_art['nlevel']>6)  { $str=",`up_level` "; 	$sql=",'".$my_new_art['nlevel']."' "; 	}

					mysql_query("INSERT INTO oldbk.`inventory`
						(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
						`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
						`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
						`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`ekr_flag`, `includerechargetype`,`includeprototype`
						)
						VALUES
						('{$my_new_art['id']}','{$us['id']}','{$my_new_art['name']}','{$my_new_art['type']}',{$my_new_art['massa']},{$my_new_art['cost']},{$my_new_art['ecost']},'{$my_new_art['img']}',{$my_new_art['maxdur']},{$my_new_art['isrep']},'{$my_new_art['nclass']}','{$my_new_art['gsila']}','{$my_new_art['glovk']}','{$my_new_art['ginta']}','{$my_new_art['gintel']}','{$my_new_art['ghp']}','{$my_new_art['gnoj']}','{$my_new_art['gtopor']}','{$my_new_art['gdubina']}','{$my_new_art['gmech']}','{$my_new_art['gfire']}','{$my_new_art['gwater']}','{$my_new_art['gair']}','{$my_new_art['gearth']}','{$my_new_art['glight']}','{$my_new_art['ggray']}','{$my_new_art['gdark']}','{$my_new_art['needident']}','{$my_new_art['nsila']}','{$my_new_art['nlovk']}','{$my_new_art['ninta']}','{$my_new_art['nintel']}','{$my_new_art['nmudra']}','{$my_new_art['nvinos']}','{$my_new_art['nnoj']}','{$my_new_art['ntopor']}','{$my_new_art['ndubina']}','{$my_new_art['nmech']}','{$my_new_art['nfire']}','{$my_new_art['nwater']}','{$my_new_art['nair']}','{$my_new_art['nearth']}','{$my_new_art['nlight']}','{$my_new_art['ngray']}','{$my_new_art['ndark']}',
						'{$my_new_art['mfkrit']}','{$my_new_art['mfakrit']}','{$my_new_art['mfuvorot']}','{$my_new_art['mfauvorot']}','{$my_new_art['bron1']}','{$my_new_art['bron2']}','{$my_new_art['bron3']}','{$my_new_art['bron4']}','{$my_new_art['maxu']}','{$my_new_art['minu']}','{$my_new_art['magic']}','{$my_new_art['nlevel']}',
						'{$my_new_art['nalign']}','".(($my_new_art['goden'])?($my_new_art['goden']*24*60*60+time()):"")."','{$my_new_art['goden']}'
						,'{$my_new_art['razdel']}','{$my_new_art['gmp']}','{$my_new_art['gmeshok']}','{$my_new_art['group']}','{$my_new_art['letter']}' ".$sql." ,'{$my_new_art['ab_mf']}','{$my_new_art['ab_bron']}','{$my_new_art['ab_uron']}',
						'{$my_new_art['present']}','{$my_new_art['includemagic']}','{$my_new_art['includemagicdex']}','{$my_new_art['includemagicmax']}','{$my_new_art['includemagicname']}','{$my_new_art['includemagicuses']}','{$my_new_art['includemagiccost']}','{$my_new_art['includemagicekrcost']}','{$my_new_art['sowner']}','{$my_new_art['sharped']}','{$my_new_art['repcost']}','{$my_new_art['stbonus']}','{$my_new_art['mfbonus']}','{$my_new_art['ekr_flag']}','{$my_new_art['includerechargetype']}','{$my_new_art['includeprototype']}'
					) ;");

					$my_new_art['id']=mysql_insert_id();;

					//пишем в дело и системку
					//new_delo
					$rec = array();
  		    			$rec['owner']=$us['id'];
					$rec['owner_login']=$us['login'];
					$rec['owner_balans_do']=$us['money'];
					$rec['owner_balans_posle']=$us['money'];
					$rec['target_login']="КО";
					$rec['type']=1378; // обмен арта
					$rec['sum_kr']=0;

					if ($pay_vau_ko==true) {
						$rec['sum_ekr']=0;
						$addmes='. Оплата ваучером ко.id'.$pay_vau_id;
					} elseif ($paytype == 1) {
						$rec['sum_ekr']=0;
						$addmes='. Оплата монетами:'.$us['gold'].":".$needm;
					} elseif ($paytype == 0) {
						$rec['sum_ekr']=$bprice;
						$addmes='. Оплата со счета';
						$rec['bank_id']=$bank['id'];
					}

					$rec['sum_kom']=0;
					$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $my_new_art['id']));
					$rec['item_name']=$my_new_art['name'];
					$rec['item_count']=1;
					$rec['item_type']=$my_new_art['type'];
					$rec['item_cost']=$my_new_art['cost'];
					$rec['item_ecost']=$my_new_art['ecost'];
					$rec['item_dur']=$my_new_art['duration'];
					$rec['item_proto']=$item_proto;
					$rec['item_maxdur']=$my_new_art['maxdur'];
					$rec['item_ups']=$my_new_art['ups'];
					$rec['item_unic']=$my_new_art['unic'];
					$rec['item_incmagic']=$my_new_art['includemagicname'];
					$rec['item_incmagic_count']=$my_new_art['includemagicuses'];
					$rec['item_arsenal']='';
					$rec['item_proto']=$my_new_art['prototype'];
					$rec['item_sowner']=($my_new_art['sowner']>0?1:0);
					$rec['item_incmagic_id']=$my_new_art['includemagic'];
					$rec['add_info']="(id:".$artinfo['id'].")".$artinfo['name'].$addmes;
					if (add_to_new_delo($rec) === FALSE) die();

					$message.=serre("Успешно выдан ".$my_new_art['name']);
					systemtotelo($us,"Успешно выдан ".$my_new_art['name']);

					// всё ок, закончили
					$q = mysql_query('COMMIT') or die();
					unset($_SESSION['artinfo_old']);
					$ALL_IS_GOOD=true;
				} else {
					$SHOW_NEW_ART_MENU=TRUE;
				}
			}
		} else {
			$SHOW_NEW_ART_MENU=TRUE;
		}
	}

	echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> ОБМЕН ХРАМОВОГО АРТЕФАКТА</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<center>Здесь Вы можете обменять свой храмовый артефакт на другой храмовый артефакт</center>
		<table align=center><tr align=left><td>

		<p><b style=\"color:#800000\">Правила обмена храмового артефакта:</b><br>
		- встройка/заточка/ап со старого артефакта автоматически переносится на новый<br>
		- в случае обмена оружия на другой слот, заточка возвращается в инвентарь подарком<br>
		- привязанный/подаренный артефакт менятся на привязанный/подаренный<br>
		</p>";

	if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
		echo "<p><b style=\"color:#800000\">Стоимость обмена храмового артефакта</b> - 0екр<br>
		<font color=red>На время действия акции услуга обмена бесплатна.</font><br>";//«Свобода выбора»
	} else {
		echo "<p><b style=\"color:#800000\">Стоимость обмена храмового артефакта</b> - ".$bprice." екр или ".(round($bprice*$EKR_TO_GOLD*0.9))." монет (с учетом скидки 10%)<br>";
	}

	echo "</p>
	<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты.";
	if ($artinfo['duration']>0) {
		$us = check_users_city_datal($user);
 		echo " Стоимость починки старого артефакта: <b> ".calc_repair_cost($us,$artinfo)." кр.</b>";
	}
	echo " </p>
		<p>После оплаты новый артефакт окажется у Вас в рюкзаке.<br>
		</p>
		<p><b style=\"color:#800000\">В случае обмена оружия на оружие:</b> принимается также оплата \"Храмовым ваучером в ком.отдел\".</p>


		<table><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата монетами]&nbsp;&nbsp;</td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/comm2_pay2.png border=0> </td><td> храмовый ваучер]  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td><td>[</td><td><img src=https://i.oldbk.com/i/pay_sert_art.png border=0> </td><td>сертификат]</td></tr></table>
		<p><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

	if ($ALL_IS_GOOD==true)	{
		echo $message;
	} elseif ($SHOW_NEW_ART_MENU==TRUE) {
		echo "<script>
	        	function request(artid){
		            hax({url:'https://oldbk.com/commerce/getitem44.php?id='+artid, id:'idiv', anticache:1})
		        }
			</script>";

		echo '<table align=center border=0 cellpadding=5><tr align=left valign=top><td>';
		echo 'Выберите желаемый артефакт: </td><td>';
		echo "<input type=hidden name='mkdartids' value='{$_POST['mkdartids']}'>";
		echo '<select name="new_art_proto" id="new_art_proto" onChange="request(this.value)">';
		echo '<option class="select" value="0">------------------------------------------------------------</option> ';
		$get_proto=mysql_query("select * from oldbk.eshop where id in (2000,2001,2002,260,262,284,283,18210,18229,18247,18527) and id!='{$artinfo['prototype']}' order by nlevel,cost");
		while ($row=mysql_fetch_array($get_proto)) {
			echo '<option class="otdel_'.$row[razdel].'" value="'.$row[id].'_'.$row['type'].'">'.$row[name].'['.$artinfo['nlevel'].']</option>';
			echo "\n";
		}
		echo '</select></td></tr></table><br>';
		echo '<div id="idiv"></div>';
		echo "<script> request('1_0'); </script> ";

	} else {
		echo '
			<style>
			#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
			</style>
			<center><font color=red>Артефактов:</font> <span id="artnum" style="font-weight:bold;color:red;">0</span> <font color=red>шт.</font>
			<br><br>

			<div id="allconstr">
				<div id="snaptarget">
					Переместите сюда артефакт для обмена
				</div><br><form id="mkdart" method="POST"><input type="hidden" id="mkdartids" name="mkdartids" value=""> <input type="button" value="ПРОДОЛЖИТЬ" class="button2" name="Обменять артефакт" OnClick="CheckF();"></form><br>
		';

		$ids = array();

		$us = check_users_city_datal($user);
		//храм арты привязаные или нет , не надеты
		$q = mysql_query('SELECT * FROM oldbk.inventory WHERE owner = '.$us['id'].' AND ( (setsale=0 AND bs_owner=0 AND dressed = 0  AND (sowner = '.$us['id'].'  OR sowner=0) AND arsenal_klan="" AND prototype in (2000,2001,2002,260,262,284,283,18210,18229,18247,18527) ) ) ORDER BY ecost DESC');

		if (mysql_num_rows($q) > 0) {
			while($i = mysql_fetch_assoc($q)) {
				$ids[] = $i['id'];
				echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
			}

			echo '
				<script>
				var spans = [];
				var artnum = 0;


				function CheckF() {
					if (spans.length == 0) {
						alert("Вы ничего не положили");
						return;
					}
					if (artnum > 1) {
						alert("За раз можно сдать только один артефакт");
						return;
					}
					document.getElementById("mkdart").submit();
				}

				$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
				$("#allconstr span" ).bind( "dragstop", function(event, ui) {
					spans.splice(0,spans.length);


					$("#allconstr span").each(function(index,item){
						m = $("#allconstr").offset().top;

						if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
							spans.push(item);
						}
					});

					artnum = 0;

					var ids = new Array();

					for (key in spans) {
						var n = spans[key];
						itemid = n.id;
						itemid = itemid.substring(4);
						itemproto = $("#"+n.id).attr("name");
						itemproto = itemproto.substr(4);
						ids.push(itemid);

						artnum++;
					}

					document.getElementById("mkdartids").value = ids.join();
					document.getElementById("artnum").innerHTML = artnum;


				});
				</script>';
		} else {
			echo 'У вас нет Храмовых артефактов или они одеты на вас';
		}
		echo '</div></center></div>';
	}

}

function calc_repair_cost($telo,$item) {
	$repair_cost=0;

	if ($item['duration']>0)  {
		$repair_cost=$item['duration'];
		/*
		Скидка на починку артефактов
		сильвер 5%
		голд 10%
		платина 15%
		*/
		$bonus[1]=0.95;
		$bonus[2]=0.9;
		$bonus[3]=0.85;

		if (($telo['prem']>0) and ($telo['prem']<=3)) {
			$repair_cost=$repair_cost*$bonus[$telo['prem']];
		}
	}

	return $repair_cost;
}


function repair_old_art($item,$telo) {
	mysql_query("UPDATE oldbk.`inventory` SET `duration` = 0  WHERE `id` = ".$item['id'].' LIMIT 1') or die("e1");
	if (mysql_affected_rows()>0) {
		$price=calc_repair_cost($telo,$item);
		mysql_query("UPDATE `users` set `money` = money-'".$price."' WHERE id = ".$telo['id'].' LIMIT 1') or die("e2");

		if (mysql_affected_rows()>0) {
			$rec['owner']=$telo['id'];
			$rec['owner_login']=$telo['login'];
			$rec['owner_balans_do']=$telo['money'];
			$telo['money'] -= $price;
			$rec['owner_balans_posle']=$telo['money'];
			$rec['target']=0;
			$rec['target_login'] = "КО";
			$rec['type']=191;//Ремонт предмета
			$rec['sum_kr'] = $price;
			$rec['sum_ekr'] = 0;
			$rec['sum_kom']=0;
			$rec['item_id']=get_xitem_fid($item);
			$rec['item_name']=$item['name'];
			$rec['item_count']=1;
			$rec['item_type']=$item['type'];
			$rec['item_cost']=$item['cost'];
			$rec['item_dur']=0;
			$rec['item_maxdur']=$item['maxdur'];
			$rec['item_ups']=$item['ups'];
			$rec['item_unic']=$item['unik'];
			$rec['item_incmagic']=$item['includemagicname'];
			$rec['item_incmagic_count']=$item['includemagicuses'];
			$rec['item_arsenal']=$item['arsenal_klan'];
			if (add_to_new_delo($rec) === FALSE) die("e3");
			return true;
		}
	}

	return false;
}



function ShowMKArtChSlotFromHram() {
	global $user;

	unset($_SESSION['mkartch']);
	unset($_SESSION['ekrids']);
	unset($_SESSION['mkartch_free']);
	unset($_SESSION['save_proto_memory']);
	unset($_SESSION['mkartch_new_slot']);
	unset($_SESSION['mkartch_new_slot_from_hram']);
	unset($_SESSION['mkartch2_pay_vau']);
	unset($_SESSION['mkartch2_pay_vau_ids']);
	unset($_SESSION['mkartch_paytype']);

	$returnrep = 135000;
	$bprice = 15;
	$bpricegold = 4320;
	$paytype = -1;

	if ($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['mkdartids']) && isset($_POST['paytype'])) {
		if (!in_array($_POST['paytype'],[0,1])) die();
		$paytype = $_POST['paytype'];

		$ids = explode(",",$_POST['mkdartids']);
		if (count($ids) > 0 && !empty($ids[0])) {
			while(list($k,$v) = each($ids)) {
				$ids[$k] = intval($v);
			}

			$us = check_users_city_datal($user);
			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ((arsenal_klan = "" AND bs_owner=0 AND prokat_idp=0 AND dressed = 0 AND setsale = 0 AND (sowner = '.$us['id'].' OR sowner = 0)  AND prototype in (260,262,2000,2001,2002,283,284,18210,18229,18247,18527))   )) AND id IN('.implode(",",$ids).') ');	//AND duration = 0

			$ekrnum = 0;
			$artnum = 0;
			$artid = 0;
			$artinfo = array();
			$ekrids = array();
			$useditems = "";
			$bprice = 0;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";
				$artnum++;
				$artinfo = $i;
				$artid = $i['id'];
			}

			$repair_cost=calc_repair_cost($us,$artinfo);


			$good = false;

			if ($paytype == 0) {
				if ($us['repmoney'] < $returnrep) {
					serr("Недостаточно репутации покупок для сдачи храмового артефакта");
				} elseif ($artnum != 1) {
					serr("За раз можно сдать только один артефакт");
				} else {
					if (($_POST['bankpass']=='') OR ($_POST['bankid']=='')) {
						serr("Вы не указали пароль от банковского счета!");
					} else {
						$bankid=(int)($_POST['bankid']);
						$bankpas=$_POST['bankpass'];
						$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

						if ($bank['id']>0) {
							if (($repair_cost>0) and ($us['money']<$repair_cost)) {
								serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
							} elseif (($bank['ekr']) < ($bprice) ) {
								serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".($bprice)." екр.");
							} else {
								$good = true;
							}
						} else {
							serr('Ошибка! Не верный пароль от банковского счета!');
						}
					}
				}
			}
			if ($paytype == 1) {
				if (($repair_cost>0) and ($us['money']<$repair_cost)) {
					serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
				} elseif ($us['gold'] < $bpricegold) {
					serr("Недостаточно монет для совершения операции. Необходимая сумма ".($bpricegold)." монет.");
				} else {
					$good = true;
				}
			}

			if ($good) {
				// всё ок - начинаем
				$_SESSION['bankid']=$bankid;
				// всё ок - начинаем
				if($artinfo['add_pick'] != '') {
					undress_img($artinfo);
				}
				$STEP_ART=true;
			}
		}
	}

	echo "<br>
	<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
	<tr>
	<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
	</tr>
	<tr>
	<td class=\"cont_bg\">
	<center><b style=\"color:#800000\"> ОБМЕН СТАНДАРТНОГО АРТЕФАКТА НА ЛИЧНЫЙ</b></center></td></tr>
	<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете сдать свой стандартный артефакт и сделать заявку на личный артефакт.</center>
	<table align=center><tr align=left><td>

	<p><b style=\"color:#800000\">Правила обмена артефакта:</b><br>

	<b>- новый артефакт создается на базе вещей любого уровня и любого слота<br>
	- изображение и название на новый артефакт будет установлено по-умолчанию, изменить их нельзя<br>
	- встройка со старого артефакта автоматически переносится на новый<br>
	- cвиток заточки выдается подарком, после использования предмет будет привязан к персонажу.</b></p>

	<br>
	<b style=\"color:RED\">Заточка со старого артефакта (если была) автоматически возвращается в инвентарь подарком при получении нового артефакта.<br>
	<p><b style=\"color:#800000\">Стоимость обмена артефакта:</b><br>
	15екр + 135000 репутации покупки или 4320 монет  (с учетом скидки 10%)</p>
	<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. Оплатить стоимость починки вы можете при замене артефакта.</p>


	После оплаты артефакт появится в Вашем инвентаре и надеть его сможете только Вы.<br><br>
	<b style=\"color:#800000\">В случае отказа по заявке, Вам будет возвращен Ваш старый артефакт.</b><br><br>
	</p>

	<table><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата монетами]&nbsp;&nbsp;</td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_repa.png border=0></td><td> репутация покупки] &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table>
	<p><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
	</td></tr></table>
	</td>
	</tr>
	<tr>
	<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
	</tr>
	</table>
	<br><br>";

	if ($STEP_ART) {
		$_SESSION['mkartch']=$artinfo;
		$_SESSION['ekrids']=$ekrids;
		$_SESSION['mkartch_new_slot']=true;
		$_SESSION['mkartch_new_slot_from_hram']=true;
		$_SESSION['mkartch_paytype'] = $paytype;

		echo "Проверка данных...";
		echo '<script>location.href = "index.php?act=mkpersonalart";</script>';
	} else {
		$us = check_users_city_datal($user);

		$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");

		$BANKS = "";
		if (mysql_num_rows($get_bank) > 0) {
			$BANKS="<select style='width:150px' name=bankid>";
			while($row = mysql_fetch_assoc($get_bank)) {
				$BANKS.="<option>".$row['id']."</option>";
			}
			$BANKS.="</select>";
		}


		echo '
		<style>
		#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
		</style>
		<center>Артефактов: <span id="artnum" style="font-weight:bold;">0</span> шт.<br><br>';

		echo '<br><br>
			<div id="allconstr">
			<div id="snaptarget">
				Переместите сюда артефакт для обмена
			</div><br><form id="mkdart" method="POST">
			<input type="hidden" id="mkdartids" name="mkdartids" value="">
			<table>
		';

		if (strlen($BANKS)) echo '<tr><td><input type="radio" name="paytype" value="0"></td><td>Банковский счет: '.$BANKS.' пароль <input type=password size=8 name=bankpass></td></tr>';

		echo	'<tr><td><input type="radio" name="paytype" value="1"></td><td>Золотыми монетами, у вас в наличии <b>'.$us['gold'].'</b> монет</td></tr></table><br>

				<input type="button" value="ОБМЕН АРТЕФАКТА" class="button2" name="Обменять артефакт" OnClick="CheckF();"></form><br>
		';
		$ids = array();

		$us = check_users_city_datal($user);

		//стандартные арты + ваучеры
		$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND ((arsenal_klan = "" AND bs_owner=0 AND prokat_idp=0 AND dressed = 0 AND setsale = 0 AND (sowner = '.$us['id'].' OR sowner = 0)  AND prototype in (260,262,2000,2001,2002,283,284,18210,18229,18247,18527))  ) ORDER BY ecost DESC');

		if (mysql_num_rows($q) > 0) {
			while($i = mysql_fetch_assoc($q)) {
				$ids[] = $i['id'];
				echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
			}

			$haverep = 0;
			if ($us['repmoney'] >= $returnrep) $haverep = 1;

			echo '
				<script>
				var spans = [];
				var artnum = 0;
				var bprice = '.$bprice.';
				var arttype = 0;

				function CheckF() {
					if (spans.length == 0) {
						alert("Вы ничего не положили");
						return;
					}
					if (artnum > 1) {
						alert("За раз можно сдать только один артефакт");
						return;
					}
					if (confirm("Вы уверены?")) {
						document.getElementById("mkdart").submit();
					}

				}

				$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
				$("#allconstr span" ).bind( "dragstop", function(event, ui) {
					spans.splice(0,spans.length);


					$("#allconstr span").each(function(index,item){
						m = $("#allconstr").offset().top;

						if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
							spans.push(item);
						}
					});

					artnum = 0;

					var ids = new Array();

					for (key in spans) {
						var n = spans[key];
						itemid = n.id;
						itemid = itemid.substring(4);
						itemproto = $("#"+n.id).attr("name");
						itemproto = itemproto.substr(4);
						ids.push(itemid);

						if (itemproto == "260" || itemproto == "262" || itemproto == "2000" || itemproto == "2001" || itemproto == "2002" || itemproto == "283" || itemproto == "284" || itemproto == "18210" || itemproto == "18229" || itemproto == "18247" || itemproto == "18527"  ) {
							arttype = 1;
							artnum++;
						}
					}
					document.getElementById("mkdartids").value = ids.join();
					document.getElementById("artnum").innerHTML = artnum;


				});
				</script>
			';
		} else {
			echo 'У вас нет личных артов или они одеты на вас';
		}
		echo '</div></center></div>';
	}
}


function ShowMKArtChSlot() {
	global $user;
	global $EKR_TO_GOLD;

	unset($_SESSION['mkartch']);
	unset($_SESSION['ekrids']);
	unset($_SESSION['mkartch_free']);
	unset($_SESSION['save_proto_memory']);
	unset($_SESSION['mkartch_new_slot']);
	unset($_SESSION['mkartch_new_slot_from_hram']);
	unset($_SESSION['mkartch2_pay_vau']);
	unset($_SESSION['mkartch2_pay_vau_ids']);
	unset($_SESSION['mkartch_paytype']);

	$bprice = 15;

	if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
		$bprice = 0;
	}


	if ($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['mkdartids'])) {
		$ids = explode(",",$_POST['mkdartids']);
		if (count($ids) > 0 && !empty($ids[0])) {
			while(list($k,$v) = each($ids)) {
				$ids[$k] = intval($v);
			}

			$us = check_users_city_datal($user);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ((dressed = 0 AND art_param != ""   AND sowner = '.$us['id'].') OR (setsale=0 and prototype = 541))) AND id IN('.implode(",",$ids).') '); //AND duration = 0

			$ekrnum = 0;
			$artnum = 0;
			$artid = 0;
			$artinfo = array();
			$ekrids = array();
			$useditems = "";
			$pay_vau = false;
			$pay_vau_ids = false;
			$free=false;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";
				if ($i['prototype'] == "541") {
					$pay_vau = true;
					$pay_vau_ids = $i['id'];
				} else {
					$artnum++;
					$artinfo = $i;
					$artid = $i['id'];

					if ($artinfo['nclass'] == 0 && $artinfo['type'] != 3 && $artinfo['nlevel'] >= 8) {
						$bprice = 0;
					}
				}
			}

			$repair_cost=calc_repair_cost($us,$artinfo);


			if ($artnum != 1) {
				serr("За раз можно сдать только один артефакт");
			} else {
			        if (($pay_vau) and ($_POST['otype']==2)) {
					if (($repair_cost>0) and ($us['money']<$repair_cost)) {
						serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
					} else {
						$bprice = 0;
						if($artinfo['add_pick'] != '') {
							undress_img($artinfo);
						}
						$STEP_ART=true;
						$_SESSION['mkartch_paytype'] = 2;
					}
				} elseif ($_POST['otype']==1) {
					if (($_POST['bankpass']=='') OR ($_POST['bankid']=='')) {
						serr("Вы не указали пароль от банковского счета!");
					} else {
						$bankid=(int)($_POST['bankid']);
						$bankpas=$_POST['bankpass'];
						$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

						if ($bank['id']>0) {
							if (($repair_cost>0) and ($us['money']<$repair_cost)) {
								serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
							} elseif ($bank['ekr'] < $bprice) {
								serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".($bprice)." екр.");
							} else {
								// всё ок - начинаем
								$_SESSION['bankid']=$bankid;
								// всё ок - начинаем
								if($artinfo['add_pick'] != '') {
									undress_img($artinfo);
								}
								$_SESSION['mkartch_paytype'] = 0;
								$STEP_ART=true;
							}
						} else {
							serr('Ошибка! Не верный пароль от банковского счета!');
						}
					}
				} elseif ($_POST['otype'] == 3) {
					$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
					if ($us['gold'] < $needm) {
						serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
					} else {
						if (($repair_cost>0) and ($us['money']<$repair_cost)) {
							serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
						} else {
							// всё ок - начинаем
							$_SESSION['bankid']=$bankid;
							// всё ок - начинаем
							if($artinfo['add_pick'] != '') {
								undress_img($artinfo);
							}
							$STEP_ART=true;
							$_SESSION['mkartch_paytype'] = 1;
						}
					}
				}
			}
		}
	}

	echo "
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> ОБМЕН ЛИЧНОГО АРТЕФАКТА НА ДРУГОЙ СЛОТ ИЛИ ПЕРЕСОЗДАНИЕ В ТОМ ЖЕ СЛОТЕ</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
		<br><center>Здесь Вы можете пересоздать свой личный артефакт на другой слот или пересоздать его в том же слоте.</center>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила смены слота личного артефакта:</b><br>
		<b>- новый артефакт создается только на базе вещей того же уровня, что и уровень старого артефакта<br>
		- улучшение уникального предмета и прочие улучшения со старого артефакта автоматически переносится на новый<br>
		- встройка со старого артефакта автоматически переносится на новый<br>
		- cвиток заточки выдается подарком, после использования предмет будет привязан к персонажу.</b></p>";
		if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
			echo "<p><b style=\"color:#800000\">Стоимость обмена личного артефакта: 0 екр</b> <font color=red>На время действия акции услуга обмена бесплатна.</font> <br>";//«Свобода выбора»
		} else {
			echo "<p><b style=\"color:#800000\">Стоимость обмена личного артефакта: ".$bprice." екр или ".round($bprice*$EKR_TO_GOLD*0.9)." монет (с учетом скидки 10%)</b><br>";
			echo "<p><b style=\"color:#800000\"><font color='red'>Стоимость обмена устаревших бесклассовых артефактов на артефакты классов слот-в-слот: 0 екр.</font><br>";
		}
	echo "
		</p>
		<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. Оплатить стоимость починки вы можете при замене артефакта.</p>
		<p><b style=\"color:#800000\">После оплаты артефакт появится в Вашем инвентаре и надеть его сможете только Вы.<br>
		<b style=\"color:#800000\">В случае отказа по заявке, Вам будет возвращен Ваш старый артефакт.</b><br>
		<br>
		<b style=\"color:RED\">Заточка со старого артефакта (если была) автоматически возвращается в инвентарь подарком при получении нового артефакта.<br>
		<br>
		<p><table><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами]&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td> <td>[</td><td><img src=https://i.oldbk.com/i/pay_sert_art.png border=0> </td><td>сертификат]</td></tr></table></p>
		<p><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>
	";

	if ($STEP_ART)	{
		$_SESSION['mkartch']=$artinfo;
		$_SESSION['ekrids']=$ekrids;
		if ($pay_vau) {
			$_SESSION['mkartch2_pay_vau']=true;
			$_SESSION['mkartch2_pay_vau_ids']=$pay_vau_ids;
		}
		$_SESSION['mkartch_new_slot']=true;
		echo "Проверка данных...";
		echo '<script>location.href = "index.php?act=mkpersonalart";</script>';
	} else {
		$us = check_users_city_datal($user);

		$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");

		$BANKS = "";
		if (mysql_num_rows($get_bank) > 0) {
			$BANKS="<select style='width:150px' name=bankid>";
			while($row = mysql_fetch_assoc($get_bank)) {
				$BANKS.="<option>".$row['id']."</option>";
			}
			$BANKS.="</select>";
		}


		echo '
			<style>
			#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
			</style>';

		echo '<div id="oplata">';
		echo "<center><b>Выберите один из способов оплаты:</b><br><br></center><div align=center><table border=0><tr><td align=left>";
		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"1\" id=\"paymethod_1\" OnClick=\"document.getElementById('otype').value=1;\" />&nbsp;&nbsp;Оплатить в екр.</label><br />";
		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"2\" id=\"paymethod_2\" OnClick=\"document.getElementById('otype').value=2;\" />&nbsp;&nbsp;Оплатить сертификатом</label><br />";
		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"3\" id=\"paymethod_5\" OnClick=\"document.getElementById('otype').value=3;\" />&nbsp;&nbsp;Оплатить золотыми монетами</label><br /><br><br>";
		echo '<input type="button" value="Продолжить" class="button2" OnClick="Select_oplata();"></td></tr></table>';

		echo '</div></div>';
		echo '<div id=step2 style="display:none;">';
		echo '<center>Вещей: <span id="artnum" style="font-weight:bold;">0</span> шт.<br><br>';
		echo '<div id="allconstr" >
			<div id="snaptarget">
				Переместите сюда артефакт для обмена.
				<div id=ekrinfo style="display:none;">Если вы хотите оплатить обмен сертификатом, то вернитесь к <a href="/commerce/index.php?act=mkartch2">выбору вариантов оплаты</a>.</div>
				<div id=sertinfo><font color="red">При наличии сертификата на обмен артефакта необходимо добавить сертификат в обмен вместе с артефактом.</font></div>
				</div><br><form id="mkdart" method="POST">
				<input type="hidden" id="otype" name="otype" value="0">';

if (($user=='Bred')  or ($user=='Десятый' ) )
		{
		echo 	' <input type="text" id="mkdartids" name="mkdartids" value=""> ';
		}
		else
		{
		echo '		<input type="hidden" id="mkdartids" name="mkdartids" value=""> ';
		}

		echo'

				<div id=obank style="display:none;">Банковский счет: '.$BANKS.' пароль <input type=password size=8 name=bankpass></div>
				<div id=ogold style="display:none;">У вас в наличии <b>'.$us['gold'].'</b> монет</div>
				<br><br>
				<input type="button" value="ОБМЕН АРТЕФАКТА" class="button2" name="Обменять артефакт" OnClick="CheckF();"></form><br>
		';

		$ids = array();
		$q = mysql_query('SELECT * FROM oldbk.inventory WHERE owner = '.$us['id'].' AND ((dressed = 0  AND art_param != ""  AND sowner = '.$us['id'].') or (setsale = 0 and prototype = 541)) ORDER BY ecost DESC'); //AND duration = 0

		if (mysql_num_rows($q) > 0) {
			while($i = mysql_fetch_assoc($q)) {
				$ids[] = $i['id'];
				if ($i['nclass'] == 0 && $i['type'] != 3 && $i['nlevel'] >= 8) {
					echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].' (устаревшая вещь)" title="'.$i['name'].' (устаревшая вещь)" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
				} else {
					echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
				}
			}

			echo '
				<script>
				var spans = [];
				var artnum = 0;

				var bprice = '.$bprice.';

				function CheckF() {
					if (spans.length == 0) {
						alert("Вы ничего не положили");
						return;
					}
					if (artnum > 1) {
						alert("За раз можно сдать только один артефакт");
						return;
					}

					if (confirm("Вы уверены?")) {
						document.getElementById("mkdart").submit();
					}

				}

				$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
				$("#allconstr span" ).bind( "dragstop", function(event, ui) {
					spans.splice(0,spans.length);

					$("#allconstr span").each(function(index,item){
						m = $("#allconstr").offset().top;

						if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
							spans.push(item);
						}
					});

					var artnum = 0;
					var ids = new Array();

					for (key in spans) {

						var n = spans[key];
						itemid = n.id;
						itemid = itemid.substring(4);
						itemproto = $("#"+n.id).attr("name");
						itemproto = itemproto.substr(4);

						if ((itemproto == 541) && (document.getElementById("otype").value!=2) )
						{
							continue;
						}

						ids.push(itemid);

						artnum++;

					}
					document.getElementById("mkdartids").value = ids.join();
					document.getElementById("artnum").innerHTML = artnum;


				});
				</script>
			';
		} else {
			echo 'У вас нет личных артефактов или они одеты на вас';
		}
		echo '</div></center></div></div>';
	}
}



function ShowMKArtCh() {
	global $user;
	global $EKR_TO_GOLD;

	unset($_SESSION['mkartch']);
	unset($_SESSION['ekrids']);
	unset($_SESSION['mkartch_free']);
	unset($_SESSION['save_proto_memory']);
	unset($_SESSION['mkartch_new_slot']);
	unset($_SESSION['mkartch_new_slot_from_hram']);
	unset($_SESSION['mkartch2_pay_vau']);
	unset($_SESSION['mkartch2_pay_vau_ids']);
	unset($_SESSION['mkartch_paytype']);

	$bprice = 10;

	if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
				$bprice = 0;
	}

	if ($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['mkdartids']) && isset($_POST['paytype'])) {
		if (!in_array($_POST['paytype'],[0,1])) die();
		$paytype = $_POST['paytype'];

		$ids = explode(",",$_POST['mkdartids']);
		if (count($ids) > 0 && !empty($ids[0])) {
			while(list($k,$v) = each($ids)) {
				$ids[$k] = intval($v);
			}

			$us = check_users_city_datal($user);
			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ( (dressed = 0 AND  art_param != "" AND   nlevel<'.$us['level'].'  AND sowner = '.$us['id'].')   )) AND id IN('.implode(",",$ids).') ');//duration = 0

			$ekrnum = 0;
			$artnum = 0;
			$artid = 0;
			$artinfo = array();
			$ekrids = array();
			$useditems = "";
			$bprice = 0;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";
				$artnum++;
				$artinfo = $i;
				$artid = $i['id'];
			}

			$repair_cost=calc_repair_cost($us,$artinfo);


			if ($artnum != 1) {
				serr("За раз можно сдать только один артефакт");
			} else {
				if ($paytype == 0) {
					if (($_POST['bankpass']=='') OR ($_POST['bankid']==''))	{
						serr("Вы не указали пароль от банковского счета!");
					} else {
						$bankid=(int)($_POST['bankid']);
						$bankpas=$_POST['bankpass'];
						$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

						if ($bank['id']>0) {
							if (($repair_cost>0) and ($us['money']<$repair_cost)) {
								serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
							} elseif (($bank['ekr']) < $bprice) {
								serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
							} else {
								// всё ок - начинаем
								$_SESSION['bankid'] = $bankid;

								if($artinfo['add_pick'] != '') {
									undress_img($artinfo);
								}

								$STEP_ART=true;
							}
						} else {
							serr('Ошибка! Не верный пароль от банковского счета!');
						}
					}
				}
				if ($paytype == 1) {
					if (($repair_cost>0) and ($us['money']<$repair_cost)) {
						serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
					} else {
						$needm = round(($bprice*$EKR_TO_GOLD)*0.9);
						if ($us['gold'] < $needm) {
							serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
						} else {
							// всё ок - начинаем
							$_SESSION['bankid'] = $bankid;

							if($artinfo['add_pick'] != '') {
								undress_img($artinfo);
							}

							$STEP_ART=true;
						}
					}
				}
			}
		}
	}

	echo "
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> ПОДНЯТИЕ ЛИЧНОГО АРТЕФАКТА НА БОЛЕЕ ВЫСОКИЙ УРОВЕНЬ (тот же слот)</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
		<br><center>Если Ваш уровень выше чем уровень личного артефакта, здесь Вы можете обменять его на другой, созданный из вещи Вашего уровня</center>
		<table align=center><tr align=left><td>

		<p><b style=\"color:#800000\">Правила обмена личного артефакта:</b><br>
		<b>- новый артефакт создается только из вещи того же слота, что и старый<br>
		- новый артефакт создается только на базе вещей Вашего уровня<br>
		- изображение со старого артефакта автоматически переносится на новый<br>
		- улучшение уникального предмета и прочие улучшения со старого артефакта автоматически переносится на новый <br>
		- встройка/заточка со старого артефакта автоматически переносится на новый</b></p>";

		if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
			echo "<p><b style=\"color:#800000\">Стоимость обмена личного артефакта: 0 екр  </b><br>
			<font color=red>На время действия акции  услуга обмена бесплатна.</font><br>";//«Свобода выбора»
		} else {
			echo "<p><b style=\"color:#800000\">Стоимость обмена личного артефакта: ".$bprice." екр или ".round($bprice*$EKR_TO_GOLD*0.9)." монет (с учетом скидки 10%).</b><br>";
		}

	echo "
		</p>
		<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. Оплатить стоимость починки вы можете при замене артефакта.</p>
		<p>После оплаты новый артефакт окажется у Вас в рюкзаке.<br></p>

		<p><table><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами]&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>Списать екр. со счета в Банке]</td></tr></table></p>
		<p><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>
	";

	if ($STEP_ART)	{
		$_SESSION['mkartch']=$artinfo;
		$_SESSION['ekrids']=$ekrids;
		$_SESSION['mkartch_paytype'] = $paytype;
		echo "Проверка данных...";
		echo '<script>location.href = "index.php?act=mkpersonalart";</script>';
	} else {
		$us = check_users_city_datal($user);

		$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");

		$BANKS = "";
		if (mysql_num_rows($get_bank) > 0) {
			$BANKS="<select style='width:150px' name=bankid>";
			while($row = mysql_fetch_assoc($get_bank)) {
				$BANKS.="<option>".$row['id']."</option>";
			}
			$BANKS.="</select>";
		}

		echo '
			<style>
			#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
			</style>
			<center>Артефактов: <span id="artnum" style="font-weight:bold;">0</span> шт.<br><br>
			<div id="allconstr">
				<div id="snaptarget">
					Переместите сюда артефакт для обмена
				</div><br>
				<form id="mkdart" method="POST">
				<input type="hidden" id="mkdartids" name="mkdartids" value="">

			<table>
		';

		if (strlen($BANKS)) echo '<tr><td><input type="radio" name="paytype" value="0"></td><td>Банковский счет: '.$BANKS.' пароль <input type=password size=8 name=bankpass></td></tr>';
		echo	'<tr><td><input type="radio" name="paytype" value="1"></td><td>Золотыми монетами, у вас в наличии <b>'.$us['gold'].'</b> монет</td></tr></table><br>
				<input type="button" value="ОБМЕН АРТЕФАКТА" class="button2" name="Обменять артефакт" OnClick="CheckF();">
				</form><br>
		';

		$ids = array();

		$q = mysql_query('SELECT * FROM oldbk.inventory WHERE owner = '.$us['id'].' AND ((dressed = 0 AND art_param != ""  AND nlevel<'.$us['level'].'  AND sowner = '.$us['id'].')  ) ORDER BY ecost DESC');

		if (mysql_num_rows($q) > 0) {
			while($i = mysql_fetch_assoc($q)) {
				$ids[] = $i['id'];
				echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
			}

			echo '
				<script>
				var spans = [];
				var artnum = 0;

				function CheckF() {
					if (spans.length == 0) {
						alert("Вы ничего не положили");
						return;
					}
					if (artnum > 1) {
						alert("За раз можно сдать только один артефакт");
						return;
					}

					if (confirm("Вы уверены?")) {
						document.getElementById("mkdart").submit();
					}

				}

				$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
				$("#allconstr span" ).bind( "dragstop", function(event, ui) {
					spans.splice(0,spans.length);


					$("#allconstr span").each(function(index,item){
						m = $("#allconstr").offset().top;

						if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
							spans.push(item);
						}
					});

					artnum = 0;

					var ids = new Array();

					for (key in spans) {
						var n = spans[key];
						itemid = n.id;
						itemid = itemid.substring(4);
						itemproto = $("#"+n.id).attr("name");
						itemproto = itemproto.substr(4);
						ids.push(itemid);
						artnum++;

					}
					document.getElementById("mkdartids").value = ids.join();

					document.getElementById("artnum").innerHTML = artnum;


				});
				</script>
			';
		} else {
			echo 'У вас нет личных артефактов или они одеты на вас<br><br>';
		}

		echo '</div></center></div>';
	}
}


function ShowMKArtChFree() {
	global $user;
	//бесплатный обмен
	//- обмен апнутой лички (созданной из старых вещей) на новую личку из новых вещей. бесплатно
	//и без проверки. автоматически. только тот же слот. и картинка передвигается на новое.
	//тогоже уроыня что и старый арт

	unset($_SESSION['mkartch']);
	unset($_SESSION['ekrids']);
	unset($_SESSION['mkartch_free']);
	unset($_SESSION['save_proto_memory']);
	unset($_SESSION['mkartch_new_slot']);
	unset($_SESSION['mkartch_new_slot_from_hram']);
	unset($_SESSION['mkartch2_pay_vau']);
	unset($_SESSION['mkartch2_pay_vau_ids']);


	if ($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['mkdartids'])) {

		$ids = explode(",",$_POST['mkdartids']);
		if (count($ids) > 0 && !empty($ids[0])) {
			while(list($k,$v) = each($ids)) {
				$ids[$k] = intval($v);
			}

			$us = check_users_city_datal($user);
			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND dressed = 0 AND present = "" AND art_param != ""  AND sowner = '.$us['id'].' and name like "%[%"  ) AND id IN('.implode(",",$ids).') ');

			$artnum = 0;
			$artid = 0;
			$artinfo = array();
			$useditems = "";
			$bprice = 0;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";
					$artnum++;
					$artinfo = $i;
					$artid = $i['id'];
			}

			//делаем тест - а старый ли арт?olditem - в таблице артов


			$repair_cost=calc_repair_cost($us,$artinfo);

			if (($repair_cost>0) and ($us['money']<$repair_cost) )
			{
			serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
			}
			else
			if ($artnum != 1) {
				serr("За раз можно сдать только один артефакт");
			} else
			{
					// всё ок - начинаем
					if($artinfo[add_pick] != '')
					{
					undress_img($artinfo);
					}
					$STEP_ART=true;




			}
		}
	}

echo "<br>
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\">ОБМЕН ЛИЧНОГО АПНУТОГО АРТЕФАКТА (устаревшая вещь)</b></center></td></tr>
<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете обменять свой старый личный артефакт на другой, созданный на базе новых вещей</center>
<table align=center><tr align=left><td>
<p><b style=\"color:#800000\">Правила обмена личного артефакта:</b><br>
<b>- новый артефакт создается только из вещи того же слота, что и старый<br>
- новый артефакт создается только на базе новых вещей того же уровня, что и уровень старого артефакта<br>
- изображение со старого артефакта автоматически переносится на новый<br>
- встройка/заточка со старого артефакта автоматически переносится на новый</b></p>

<p><b style=\"color:#800000\">Стоимость обмена личного артефакта:</b><br>
Обмен производится бесплатно</p>
<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. Оплатить стоимость починки вы можете при замене артефакта.</p>
<p>После оплаты новый артефакт окажется у Вас в рюкзаке.<br></p>
<p>Возможные способы оплаты:&nbsp;[обмен производится бесплатно]</p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br><br>";




			if ($STEP_ART)
			{
			$_SESSION['mkartch']=$artinfo;
			$_SESSION['mkartch_free']=true;
			echo "Проверка данных...";
			echo '<script>location.href = "index.php?act=mkpersonalart";</script>';
			}
			else
			{
					echo '
					<style>
					#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
					</style>
					<center>Артефактов: <span id="artnum" style="font-weight:bold;">0</span> шт.


					<div id="allconstr">
						<div id="snaptarget">
							Переместите сюда артефакт для обмена
						</div><br><form id="mkdart" method="POST"><input type="hidden" id="mkdartids" name="mkdartids" value=""> <input type="button" value="ОБМЕН АРТЕФАКТА" class="button2" name="Обменять артефакт" OnClick="CheckF();"></form><br>
					';
					$ids = array();

					$us = check_users_city_datal($user);
					$q = mysql_query('SELECT * FROM oldbk.inventory WHERE owner = '.$us['id'].' AND dressed = 0 AND art_param != ""  AND sowner = '.$us['id'].' and name like "%[%" ORDER BY ecost DESC');


					if (mysql_num_rows($q) > 0) {
						while($i = mysql_fetch_assoc($q)) {
							$ids[] = $i['id'];
							echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
						}

						echo '
						<script>
						var spans = [];
						var artnum = 0;
						var ekrnum = 0;
						var bprice = 40;


						function CheckF() {
							if (spans.length == 0) {
								alert("Вы ничего не положили");
								return;
							}
							if (artnum > 1) {
								alert("За раз можно сдать только один артефакт");
								return;
							}

							if (confirm("Вы уверены?")) {
								document.getElementById("mkdart").submit();
							}

						}

						$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
						$("#allconstr span" ).bind( "dragstop", function(event, ui) {
							spans.splice(0,spans.length);


							$("#allconstr span").each(function(index,item){
								m = $("#allconstr").offset().top;

								if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
									spans.push(item);
								}
							});

							artnum = 0;
							ekrnum = 0;
							var ids = new Array();

							for (key in spans) {
								var n = spans[key];
								itemid = n.id;
								itemid = itemid.substring(4);
								itemproto = $("#"+n.id).attr("name");
								itemproto = itemproto.substr(4);
								ids.push(itemid);

								artnum++;

							}
							document.getElementById("mkdartids").value = ids.join();

							document.getElementById("artnum").innerHTML = artnum;


						});
						</script>';
					} else {
						echo 'У вас нет личных артефактов или они одеты на вас';
					}
					echo '</div></center></div>';

			}


}



function ShowRemoveMainKlan() {

		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">ОТСОЕДИНИТЬ КЛАН-ОСНОВУ</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\"> Отсоединение от клан-основы невозможно. Разъеденить кланы может только глава клана основы.";

		echo "
		<br><br>
		<center>
		<a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
		<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
	        <script>//setTimeout('this.document.location.href=\'index.php\'',60000);</script></center>";

		echo "</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;";



echo "</td>
		</tr>
		</table>
		<br><br>";


}
//не используется
function ShowRemoveRekrut() {
	global $user;
	global $PRICE;

	$us = check_users_city_datal($user);
	$isglava = false;
	$kkr = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}

			if ($kk['rekrut_klan'] > 0) {
				$q = mysql_query('SELECT * FROM oldbk.clans WHERE id = "'.$kk['rekrut_klan'].'"');
				$kkr = mysql_fetch_assoc($q);
			}

		}
	}

	if (!$isglava || $kk['base_klan'] != 0 || $kk['rekrut_klan'] == 0 || !$kkr) die();


	$get_wars = mysql_fetch_array(mysql_query("select cw.* , cy.clanid , cy.clan_txt, cy.agressor as allyagr, cy.defender as allydef  from oldbk.clans_war_new  cw LEFT join oldbk.clans_war_new_ally cy on cy.warid=cw.id and cy.active=1 where cw.winner=0 and (cw.agressor='{$kk['id']}' or cw.defender='{$kk['id']}' or cy.clanid='{$kk['id']}')"));
	if ($get_wars['id']>0) {
		echo "<br>
			<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
			<tr>
			<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
			</tr>
			<tr>
			<td class=\"cont_bg\">
			<center><b style=\"color:#800000\">ОТСОЕДИНИТЬ РЕКРУТ-КЛАН</b></center></td></tr>
			<tr><td class=\"cont_bg\">
			<tr><td class=\"text1 cont_bg\"><br>
			<table align=center><tr align=left><td>
		";

		echo 'Во время войны отсоединение рекрутов невозможно.';

		echo "</td></tr></table>
		<br>
		<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
		</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
		</div>
	        <script>//setTimeout('this.document.location.href=\'index.php\'',60000);</script>";
	        die();
	}


	if (isset($_POST['mkecids'])) {

			$us = check_users_city_datal($user);

			$ekrnum = 0;
			$bprice = $PRICE[106][cost];
			$useditems = "";

			if ($_POST['kaznapass']=='')
			{
			serr("Вы не указали пароль от екровой казны клана!");
			}
			else
			{
				$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
				$clan_id=$clan_id['id'];
				$kazna=clan_kazna_have($clan_id);

				if  (($kazna) and ($kazna['ekr_pass']==mysql_real_escape_string($_POST['kaznapass'])) )
					{
						if (($kazna['ekr']) < $bprice)
						{
							serr("Суммы на екровом счету казны  недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
								//оплачиваем
								if (by_from_kazna($clan_id,2,$bprice,'Отсоединение рекрут-клана',$us))
								{
								// всё ок - начинаем
								$q = mysql_query('START TRANSACTION') or die();



								$messtel="Ваша заявка по отсоединению рекрут-клана удовлетворена.";
								if ($us['odate'] > (time()-60)) {
									addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
								} else  {
									mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
								}


								// пишем в ком отдел заявку
								$now=date("d.m.y H:i",time());
								$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`addinfo`,`ip`,`status`) VALUES ('".time()."','".$user."', 'Отсоединить рекрут-клан', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','','".ip2long(REMIP)."','Сделано ".$now."');";
								mysql_query($query) or die();

								mysql_query('UPDATE oldbk.`clans` set base_klan = 0 WHERE id = '.$kkr['id']) or die();
							        mysql_query('UPDATE oldbk.`clans` set rekrut_klan = 0 WHERE id = '.$kk['id']) or die();

								// всё ок, закончили
								$q = mysql_query('COMMIT') or die();
								echo "<font color=red><b>Успешно отсоединён рекрут-клан</b></font>";


									// системка главе рекрутов
									$r = check_users_city_data($kkr['glava']);

									if ($r !== FALSE) {
										$messtel = 'Ваш клан отсоединён от клана-основы '.$us['klan'].'.';

										if ($r['odate'] > (time()-60)) {
											addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$r['login'].'{[]}',$r['room'],$r['id_city']);
										} else {
											mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$r['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
										}
									}

								}
						}

				}
				else
						{
						serr('Ошибка! Не верный пароль от екровой казны клана!');
						}
				}
			echo "
			<br>
			<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
			</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
			</div>
		        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

			echo "</td></tr>";
		}
	 else {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">ОТСОЕДИНИТЬ РЕКРУТ-КЛАН</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Ваш рекрут клан: {$kkr['short']} - {$kkr['name']} </b>


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$us = check_users_city_datal($user);
					$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
					$clan_id=$clan_id['id'];
					if (display_kazna($clan_id))
					{


									echo '
							                <form id="mkec" method="POST" enctype="multipart/form-data"><br><br><br>
									<center>
									К оплате сумма: '.$PRICE[106][cost].' екр.<br><br>
									Пароль от екровой казны клана <input type=password size=8 name=kaznapass><br><br>
									<input type="hidden" id="mkecids" name="mkecids" value="Yes">
									<input type="hidden" id="services" name="services" value="Отсоединить рекрут-клан"><br>
									';
									echo '</center></div>';
										echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>
										';
					}


	}
}


function ShowAddRekrut() {
	global $user;
	global $PRICE;

	$us = check_users_city_datal($user);
	$isglava = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}
		}
	}
$view=true;

	if (!$isglava || $kk['base_klan'] != 0 || $kk['rekrut_klan'] != 0) die();


	if (isset($_POST['mkecids']) && intval($_POST['rekrut_klan']) > 0) {

			$us = check_users_city_datal($user);
			$_POST['rekrut_klan'] = intval($_POST['rekrut_klan']);

	                $data = mysql_query('SELECT * FROM oldbk.clans where short <> "'.$us['klan'].'" AND rekrut_klan = 0 AND base_klan = 0 AND align = "'.intval($us['align']).'" and id = "'.$_POST['rekrut_klan'].'"') or die();
			if (mysql_num_rows($data) == 0) die();
			$data = mysql_fetch_assoc($data);



			$bprice = $PRICE[105][cost];
			$useditems = "";

			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем
									serr("Вы удачно оплатили заявку на присоединение рекрут-клана");

									$q = mysql_query('START TRANSACTION') or die();

									// оплата
									$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
									if (!(mysql_num_rows($get_bank) > 0) )
									{
									die();
									}
									else
									{
									$bank = mysql_fetch_assoc($get_bank);

									mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
									//  пишем в хистори банка
									$bank['ekr']-=$bprice;
									mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
									}

									$rec = array();
						    			$rec['owner']=$us[id];
									$rec['owner_login']=$us[login];
									$rec['owner_balans_do']=$us['money'];
									$rec['owner_balans_posle']=$us['money'];
									$rec['owner_rep_do']=$us['repmoney'];
									$rec['target_login'] = "КО";
									$rec['owner_rep_posle']=$us['repmoney'];
									$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
									$rec['type'] = 2282;
									$rec['sum_ekr']=$bprice;
									$rec['bank_id']=$bank['id'];
									if (add_to_new_delo($rec) === FALSE) die();


									// пишем в ком отдел заявку
									$now=date("d.m.y H:i",time());
									$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`addinfo`,`ip`,`bank_id`) VALUES ('".time()."','".$user."', 'Присоединить рекрут-клан', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','0/".$data['id']."','".ip2long(REMIP)."','{$bank['id']}');";
									mysql_query($query) or die();

									// всё ок, закончили
									$q = mysql_query('COMMIT') or die();


									// системка главе рекрутов
									$r = check_users_city_data($data['glava']);

									if ($r !== FALSE)
										{
										$messtel = 'На ваш клан подана заявка на присоединение к клану "'.$us['klan'].'". Для подтверждения или отклонения заявки необходимо зайти в Коммерческий Отдел раздел "Мои заявки".';

										if ($r['odate'] > (time()-60)) {
											addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$r['login'].'{[]}',$r['room'],$r['id_city']);
										} else {
											mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$r['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
										}
										}

										echo "
										<br>
										<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
										</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
										</div>
									        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
										echo "</td></tr>";
										$view=false;
						}
					}
						else
						{
						serr('Ошибка! Не верный пароль от банковского счета!');
						}

			}

	}

	if ($view==true)
	{
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">ПРИСОЕДИНИТЬ РЕКРУТ-КЛАН</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$us = check_users_city_datal($user);
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";


										echo '
								                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
										<center>
										Вы можете сделать рекрутом следующие кланы
											<select size="1" name="rekrut_klan">
										';

								                $data = mysql_query('SELECT id, short FROM oldbk.clans where short <> "'.$us['klan'].'" AND rekrut_klan = 0 AND base_klan = 0 AND align = "'.intval($us['align']).'" ORDER BY short') or die();
										while($base_klan = mysql_fetch_assoc($data)) {
											echo '<option value='.$base_klan['id'].'>'.$base_klan['short'].'</option>';
										}
										echo '</select>
										<br><br>
											К оплате сумма: '.$PRICE[105][cost].' екр.<br><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<input type="hidden" id="mkecids" name="mkecids" value="Yes">
											<input type="hidden" id="services" name="services" value="Присоединить рекрут-клан"><br>
										';
										echo '</center></div>';
										echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>
										';
					}
	}
}

function ShowChangeKlanImage() {
	global $user;
	global $PRICE;

	$us = check_users_city_datal($user);
	$isglava = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}
		}
	}
$view=true;

	if (!$isglava) die();

	if (isset($_POST['mkecids'],$_POST['wimage']) && strlen($_POST['wimage']) > 0) {

			$us = check_users_city_datal($user);
			$bprice = $PRICE[102][cost];
			$useditems = "";

			$good = false;
			$upfilename = "";
			$mess_time = time();
			$imgtype = "big";

			if ($_POST['wimage'] == "big") {
				$maxsize = 10*1024;
				$maxw = 100;
				$maxh = 99;
			} else {
				$maxw = 24;
				$maxh = 15;
				$maxsize = 4*1024;
				$imgtype = "small";
			}

			if (isset($_FILES['upfile'])) {
				if ($_FILES['upfile']['error'] == UPLOAD_ERR_OK) {
					$imageinfo = @getimagesize($_FILES['upfile']['tmp_name']);
					if ($imageinfo !== FALSE && ($imageinfo[2] == IMAGETYPE_GIF)) {
						if($_FILES['upfile']['size'] <= $maxsize) {
							if ($imageinfo[0] != $maxw || $imageinfo[1] != $maxh) {
								serr('Неверный размер изображения');
							} else {
								if ($imageinfo[2] == IMAGETYPE_GIF) $ext = "gif";

								$upfilename = './uploadimg/'.md5($mess_time.$us['id'])."_".$us['id']."_2.".$ext;
								$newfilename = md5($mess_time.$us['id'])."_".$us['id']."_2.".$ext;

								if (move_uploaded_file($_FILES['upfile']['tmp_name'],$upfilename)) {
									$good = true;
								}
							}
						} else {
							serr('Размер файла превышен');
						}
					} else {
						serr('Загружен неверный формат');
					}
				} else {
					serr('Ошибка загрузки файла');
				}
			}


			if ($good) {

			if ($_POST['kaznapass']=='')
			{
			serr("Вы не указали пароль от екровой казны клана!");
			}
			else
			{
				$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
				$clan_id=$clan_id['id'];
				$kazna=clan_kazna_have($clan_id);

				if  (($kazna) and ($kazna['ekr_pass']==mysql_real_escape_string($_POST['kaznapass'])) )
					{
						if (($kazna['ekr']) < $bprice)
						{
							serr("Суммы на екровом счету казны  недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									//оплачиваем
								if (by_from_kazna($clan_id,2,$bprice,$PRICE[102]['desc'],$us))
								{
									// всё ок - начинаем
											serr("Вы удачно оплатили изменение картинки клана");

											$q = mysql_query('START TRANSACTION') or die();



											// пишем в ком отдел
											mk_img_rec(102,1,5,$imgtype,$newfilename);

											// всё ок, закончили
											$q = mysql_query('COMMIT') or die();
											serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");
											$view=false;
											echo "
											<br>
											<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
											</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
											</div>
										        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

											echo "</td></tr>";
								}
						}
					}
					else
					{
					serr('Ошибка! Не верный пароль от екровой казны клана!');
					}
			}

			} else
			{
				serr("Ошибка загрузки картинки");
				}

	}

if ($view==true)
	{
		if (isset($_POST['comemail'])) $_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СМЕНА ЗНАЧКА КЛАНА</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<script>
		function ChgImgW(t) {
			if (t == 0) {
				document.getElementById(\"wimage\").src = \"https://i.oldbk.com/i/klan/".$kk['short'].".gif\";
				document.getElementById(\"timage\").innerHTML = \"(не более 4кб, размеры 24x15, gif)\";
			}
			if (t == 1) {
				document.getElementById(\"wimage\").src = \"https://i.oldbk.com/i/klan/".$kk['short']."_big.gif\";
				document.getElementById(\"timage\").innerHTML = \"(не более 10кб, размеры 100x99, gif)\";
			}
		}
		</script>
		<br><br>";


					$us = check_users_city_datal($user);
					$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
					$clan_id=$clan_id['id'];
					if (display_kazna($clan_id))
					{



									echo '
							                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
									<center>
									<b>Укажите какой значок Вы меняете:</b><br><br>
									<table align=center border=0><tr><td align=left><input checked OnClick="ChgImgW(0);" type="radio" name="wimage" value="small"> маленький значок </td></tr>
									<tr align=left><td><input OnClick="ChgImgW(1);" type="radio" name="wimage" value="big"> большой значок </td></tr></table>
									<br>
									<center><img id="wimage" src="https://i.oldbk.com/i/klan/'.$kk['short'].'.gif"></center><br><br>
									<table align=center border=0><tr><td>Загрузите новый значок: <input type="file" name="upfile" class="button2" style="background-color:white;color:black;width:500px;"><br></td></tr>
									<tr align=left><td align=left><span style="font-weight:bold;" id="timage">(не более 4кб, размеры 24x15, gif)</span></td></tr></table><br><br>
									<br><br>

										К оплате сумма: '.$PRICE[102][cost].' екр.<br>
										Пароль от екровой казны клана <input type=password size=8 name=kaznapass><br><br>
										<input type="hidden" id="mkecids" name="mkecids" value="yes">
										<input type="hidden" id="services" name="services" value="Смена значка клана"><br>
									';


									echo '</center></div>';
									echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
									echo '</form>

														<script>
																function CheckF() {
																if (confirm("Вы уверены?")) {
																	document.getElementById("mkec").submit();
																}

															}
														</script>
														';
					}
	}
}

function ShowChangeKlanAlign() {
	global $user;
	global $PRICE;

	$us = check_users_city_datal($user);
	$isglava = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}
		}
	}
$view=true;
	if (!$isglava || $kk['base_klan'] > 0) die();


	if (isset($_POST['mkecids']) && strlen($_POST['newalign']) > 0) {
		$_POST['newalign'] = intval($_POST['newalign']);
		if ($_POST['newalign'] != 2 && $_POST['newalign'] != 3 && $_POST['newalign'] != 6) die();
			if ($kk['rekrut_klan'] > 0) {
				$PRICE[101][cost] = $PRICE[101][cost] * 2;
			}

$bprice=$PRICE[101][cost];

			if ($_POST['kaznapass']=='')
			{
			serr("Вы не указали пароль от екровой казны клана!");
			}
			else
			{
				$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
				$clan_id=$clan_id['id'];
				$kazna=clan_kazna_have($clan_id);

				if  (($kazna) and ($kazna['ekr_pass']==mysql_real_escape_string($_POST['kaznapass'])) )
					{
						if (($kazna['ekr']) < $bprice)
						{
							serr("Суммы на екровом счету казны  недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									//оплачиваем
								if (by_from_kazna($clan_id,2,$bprice,'Смена склонности клана и соклановцам',$us))
								{
									// всё ок - начинаем
									serr("Вы удачно оплатили смену склонности клана");

									$q = mysql_query('START TRANSACTION') or die();

										// пишем в ком отдел
										$now=date("d.m.y H:i",time());
										$addinfo = array();
										$addinfo['klanid'] = $kk['id'];
										$addinfo['klanalign'] = $_POST['newalign'];
										$addinfo = mysql_real_escape_string(serialize($addinfo));

										$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`addinfo`,`ip`,`bank_id`) VALUES ('".time()."','".$user."', 'Смена склонности клана и соклановцам', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".$addinfo."','".ip2long(REMIP)."','{$bank['id']}');";
										mysql_query($query) or die();

										// всё ок, закончили
										$q = mysql_query('COMMIT') or die();
										echo "
										<br>
										<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
										</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
										</div>
									        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
										echo "</td></tr>";
										$view=false;
								}



						  }
					}
					else
					{
					serr('Ошибка! Не верный пароль от екровой казны клана!');
					}

		}
	}
	else
	if (isset($_POST['mkecids']))
		{
			echo '<center><font color=red>Вы не указали склонность</font></center><br>';
		}

	if ($view==true)
		{
		if (isset($_POST['comemail'])) $_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Смена склонности клана и соклановцам</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";


		echo '
                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
		<center>
		Новая склонность: <br>
		';
		$align = intval($kk['align']);

		if ($align != 2) {
			echo '<input type="radio" name="newalign" value="2"> Нейтральная склонность<br>';
		}
		if ($align != 3) {
			echo '<input type="radio" name="newalign" value="3"> Тёмная склонность<br>';
		}
		if ($align != 6) {
			echo '<input type="radio" name="newalign" value="6"> Светлая склонность<br>';
		}

		echo '<br><br>Ваш клан: <img src="https://i.oldbk.com/i/align_'.$kk['align'].'.gif"> '.$kk['short'].'<br>';
		if ($kk['rekrut_klan'] > 0) {
			$PRICE[101][cost] = $PRICE[101][cost] * 2;
			$kkr = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.clans WHERE id = '.$kk['rekrut_klan']));
			echo 'Рекрут клан: <img src="https://i.oldbk.com/i/align_'.$kkr['align'].'.gif"> '.$kkr['short'].'<br><br>';
		}

					$us = check_users_city_datal($user);
					$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
					$clan_id=$clan_id['id'];
					if (display_kazna($clan_id))
					{


									echo '
									</center><br><br>
									<center>
									К оплате сумма: '.$PRICE[101][cost].' екр.
									<br><br>
									Пароль от екровой казны клана <input type=password size=8 name=kaznapass><br><br>
									<br><input type="hidden" id="mkecids" name="mkecids" value="Yes">
									<input type="hidden" id="services" name="services" value="Смена склонности клана и соклановцам"><br>
									';

									echo '</center></div>';
									echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
									echo '</form>

														<script>
																function CheckF() {
																if (confirm("Вы уверены?")) {
																	document.getElementById("mkec").submit();
																}

															}
														</script>
														';
					}
		}
}

function ShowResetKlanPass() {
	global $user;
	global $PRICE;

	$us = check_users_city_datal($user);
	$isglava = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}
		}
	}
$view=true;
	if (!$isglava) die();

	if ( strlen($_POST['newpass']) > 0)
	{
			$us = check_users_city_datal($user);
			$bprice = $PRICE[100][cost];
			$useditems = "";


				$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
				$clan_id=$clan_id['id'];
				$kazna=clan_kazna_have($clan_id);

				if  ($kazna)
					{
						if (($kazna['ekr']) < $bprice)
						{
							serr("Суммы на екровом счету казны  недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{


								if (by_from_kazna($clan_id,2,$bprice,'Смена пароля на казну клана',$us))
								{
									// всё ок - начинаем
									serr("Вы удачно оплатили и изменили пароль на казну");

									$q = mysql_query('START TRANSACTION') or die();

									//оплачиваем





									// пишем в ком отдел
									$now=date("d.m.y H:i",time());
									$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`status`,`ip`,`bank_id`) VALUES ('".time()."','".$user."', 'Смена пароля на казну клана', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','Сделано ".$now."','".ip2long(REMIP)."','{$bank['id']}');";
									mysql_query($query) or die();

									// меняем пароль

									if ($_POST['whatkazna'] == "ekr") {
										mysql_query('UPDATE oldbk.clans_kazna SET ekr_pass = "'.mysql_real_escape_string($_POST['newpass']).'" WHERE clan_id = '.$kk['id']) or die();
										$messtel = 'Вы удачно сменили пароль на екровую клановую казну за '.$bprice.' екр!';
									} else {
										mysql_query('UPDATE oldbk.clans_kazna SET kr_pass = "'.mysql_real_escape_string($_POST['newpass']).'" WHERE clan_id = '.$kk['id']) or die();
										$messtel = 'Вы удачно сменили пароль на кредовую клановую казну за '.$bprice.' екр!';
									}

									// всё ок, закончили
									$q = mysql_query('COMMIT') or die();

									if ($us['odate'] > (time()-60)) {
										addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
									} else  {
										mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
									}

									echo "
									<br>
									<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
									</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
									</div>
								        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
									echo "</td></tr>";
									$view=false;
								}

						  }
					}
					else
					{
					serr('Ошибка казны клана!');
					}


	}

if ($view==true)
	{
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СМЕНА ПАРОЛЯ НА КАЗНУ КЛАНА</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$us = check_users_city_datal($user);
					$clan_id=mysql_fetch_assoc(mysql_query("SELECT * from oldbk.clans where short='{$us['klan']}' "));
					$clan_id=$clan_id['id'];
					if (display_kazna($clan_id))
					{

								echo '
						                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
								<center>
								<input type="radio" checked name="whatkazna" value="ekr"> Екр. казна
								<input type="radio" name="whatkazna" value="kr"> Кр. казна<br><br>
								Новый пароль: <input type="text" id="newpass" name="newpass">
								</center><br><br>
								<style>
								#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
								</style>
								<center>
									К оплате сумма: '.$PRICE[100][cost].' екр.
									<br>
									<input type="hidden" id="mkecids" name="mkecids" value="">
									<input type="hidden" id="services" name="services" value="Смена пароля на казну клана"><br>';
								echo '</center></div>';
								echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
								echo '</form>

														<script>
																function CheckF() {
																if (confirm("Вы уверены?")) {
																	document.getElementById("mkec").submit();
																}

															}
														</script>
														';
						}
						else
						{
						//echo "--";
						}
	}
}

function ShowFindPers() {
	echo 'Обратитесь в игре к персонажам <b>Подмастерье</b> <a href="http://capitalcity.oldbk.com/inf.php?182783" target="_blank"><img src="https://i.oldbk.com/i/inf.gif"></a> или <b>Портной</b> <a href="http://capitalcity.oldbk.com/inf.php?457757" target="_blank"><img src="https://i.oldbk.com/i/inf.gif"></a>';
}

function ResetRune($item) {
	require_once('runs_exp_table.php');
	if ($item) {
		$q = mysql_query('SELECT * FROM oldbk.cshop WHERE id = '.$item['prototype']);
		if ($q === FALSE) die(mysql_error());
		$proto = mysql_fetch_assoc($q);
		if ($proto) {
			$sql = "";
			if ($proto['gsila'] > 0) $sql .= "gsila = ".$proto['gsila'].",";
			if ($proto['glovk'] > 0) $sql .= "glovk = ".$proto['glovk'].",";
			if ($proto['ginta'] > 0) $sql .= "ginta = ".$proto['ginta'].",";
			if ($proto['gintel'] > 0) $sql .= "gintel = ".$proto['gintel'].",";
			if ($proto['gmp'] > 0) $sql .= "gmp = ".$proto['gmp'].",";

			if ($proto['mfkrit'] > 0) $sql .= "mfkrit = ".$proto['mfkrit'].",";
			if ($proto['mfakrit'] > 0) $sql .= "mfakrit = ".$proto['mfakrit'].",";
			if ($proto['mfuvorot'] > 0) $sql .= "mfuvorot = ".$proto['mfuvorot'].",";
			if ($proto['mfauvorot'] > 0) $sql .= "mfauvorot = ".$proto['mfauvorot'].",";

			if (strlen($sql)) {
				mysql_query('UPDATE oldbk.inventory SET gsila = 0, glovk = 0, ginta = 0, gintel = 0, gmp = 0, mfkrit = 0, mfakrit = 0, mfuvorot = 0, mfauvorot = 0 WHERE id = '.$item['id']) or die();
				$sql = substr($sql,0,strlen($sql)-1);
				mysql_query('UPDATE oldbk.inventory SET '.$sql.' WHERE id = '.$item['id']) or die();

				$sql = "";
				$stbonus = 0;
				$mfbonus = 0;
				$gintel = 0;
				$gmp = 0;

				for ($i = 0; $i <= $item['up_level']; $i++) {
					if ($runs_exp_table[$i]["stbonus"] > 0) $stbonus += $runs_exp_table[$i]["stbonus"];
					if ($runs_exp_table[$i]["mfbonus"] > 0) $mfbonus += $runs_exp_table[$i]["mfbonus"];
					if ($runs_exp_table[$i]["gintel"] > 0) $gintel += $runs_exp_table[$i]["gintel"];
					if ($runs_exp_table[$i]["gmp"] > 0) $gmp += $runs_exp_table[$i]["gmp"];
				}

				$sql .= "stbonus = ".$stbonus.",";
				$sql .= "mfbonus = ".$mfbonus.",";
				if ($gintel > 0) $sql .= "gintel = gintel + ".$gintel.",";
				if ($gmp > 0) $sql .= "gmp = gmp + ".$gmp.",";

				$sql = substr($sql,0,strlen($sql)-1);
				mysql_query('UPDATE oldbk.inventory SET '.$sql.' WHERE id = '.$item['id']) or die();
			} else die();

		} else die();
	}

}

function ShowResetRune() {
	global $ny_events;
	global $user;
	global $PRICE;
	global $start_volna,$end_volna;



	if ((time()>$ny_events['nghaosstart']) and (time()<$ny_events['nghaosend'])) {
		$PRICE[221][cost] = 0;
	}

	if ((time()>$ny_events['hbhaosstart']) and (time()<$ny_events['hbhaosend'])) {
		$PRICE[221][cost] = 0;
	}

	if ((time()>$start_volna) and (time()<$end_volna)) {
		$PRICE[221][cost] = 0;
	}

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and type = 30))) AND id ='.$ids);

			$bprice = $PRICE[221][cost];
			$useditems = "";
			$artid = 0;
			$artinfo = "";

			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";
					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo =$i;
					} else
					{
						die();
					}
			}

			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='') ) and ($bprice > 0)  )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if (($bank[id]>0) or ($bprice == 0) )
					{
						if ( (($bank['ekr']) < $bprice) and ($bprice > 0) )
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем
													serr("Вы удачно обнулили модификаторы и статы у руны.");

													$q = mysql_query('START TRANSACTION') or die();

													// сносим все вещи и арты
													if ($bprice > 0)
													{
													//оплата если платно
													//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=$us['money'];
														$rec['owner_rep_do']=$us['repmoney'];
														$rec['target_login'] = "КО";
														$rec['owner_rep_posle']=$us['repmoney'];
														$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
														$rec['type'] = 2282;
														$rec['sum_ekr']=$bprice;
														$rec['bank_id']=$bank['id'];
														if (add_to_new_delo($rec) === FALSE) die();
													}

													ResetRune($artinfo);

													// пишем в ком отдел
													$m = '"'.$us['login'].'" сбросил статы/мф с "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр.';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
													echo "</td></tr>";
													$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
			}

	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СБРОС МОДИФИКАТОРОВ И СТАТОВ ДЛЯ РУН</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		<p><table align=left><tr valign=middle><td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></p>
		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";
									echo '
							                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
									<style>
									#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
									</style>
									<center>
									К оплате сумма: '.$PRICE[221][cost].' екр.<br><br>';
									if ($PRICE[221][cost]>0)
									{
									echo 'Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>';
									}
									echo '<div id="allconstr">
										<div id="snaptarget">
										Переместите сюда руну, которой хотите обнулить статы/мф
										</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
										<input type="hidden" id="services" name="services" value="Сброс модификаторов и статов для рун"><br>
									';

									$ids = array();
									$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND  (setsale = 0 and dressed = 0 and type = 30) ORDER BY ecost DESC');

									if (mysql_num_rows($q) > 0) {
										while($i = mysql_fetch_assoc($q)) {
											$ids[] = $i['id'];
											if ($i['type'] == 30) {
												echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].' Уровень: '.$i['up_level'].' ('.get_xitem_fid(array("idcity" => $i['idcity'], "id" => $i['id'])).')" title="'.$i['name'].' Уровень: '.$i['up_level'].' ('.get_xitem_fid(array("idcity" => $i['idcity'], "id" => $i['id'])).')" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
											} else {
												echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
											}
										}
										echo '
										<script>
										var spans = [];
										var artnum = 0;

										function CheckF() {
											if (spans.length == 0) {
												alert("Вы ничего не положили");
												return;
											}

											if (artnum < 1) {
												alert("Вы не положили ни одной руны");
												return;
											}

											if (artnum > 1) {
												alert("За раз можно обнулить только одноу руну");
												return;
											}

											if (confirm("Вы уверены?")) {
												document.getElementById("mkec").submit();
											}

										}

										$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
										$("#allconstr span" ).bind( "dragstop", function(event, ui) {
											spans.splice(0,spans.length);


											$("#allconstr span").each(function(index,item){
												m = $("#allconstr").offset().top;

												if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
													spans.push(item);
												}
											});

								                        artnum = 0;

											var ids = new Array();

											for (key in spans) {
												var n = spans[key];
												itemid = n.id;
												itemid = itemid.substring(4);
												itemproto = $("#"+n.id).attr("name");
												itemproto = itemproto.substr(4);
												ids.push(itemid);


													artnum++;

											}
											document.getElementById("mkecids").value = ids.join();
										});
										</script>';
									} else {
										echo 'У вас нет доступный рун!';
									}
									echo '</div></center></div>';
									echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';
					}
	}
}

function ShowReset_cloack_hero()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=7002 and unik>=0 and stbonus=0 ))) AND id='.$ids);

			$bprice = $PRICE[223][cost];
			$useditems = "";
			$artid = 0;
			$artinfo = "";

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;
					} else {
						die();
					}
			}

			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				if ($artid>0)
					{
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем

													serr("Вы удачно обнулили статы для Плащ героя");


													$q = mysql_query('START TRANSACTION') or die();

													// сносим ваучеры
													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=$us['money'];
														$rec['owner_rep_do']=$us['repmoney'];
														$rec['target_login'] = "КО";
														$rec['owner_rep_posle']=$us['repmoney'];
														$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
														$rec['type'] = 2282;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														if (add_to_new_delo($rec) === FALSE) die();

													}


												if ($artinfo['unik']==2)
													{
													// Делаем сброс
													mysql_query("UPDATE `oldbk`.`inventory` SET `gsila`=3,`glovk`=3,`ginta`=3,`gintel`=3,`stbonus`=4 WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and prototype=7002 and unik=2 LIMIT 1;");
													}
													else
													{
													// Делаем сброс
													mysql_query("UPDATE `oldbk`.`inventory` SET `gsila`=3,`glovk`=3,`ginta`=3,`gintel`=3,`stbonus`=3 WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and prototype=7002  LIMIT 1;");
													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" сбросил статы/мф с "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр.';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
					}
					else
					{
					serr('Ошибка предмета!');
					}
		}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Сброс статов для уникальных Плащей героя</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма: '.$PRICE[223][cost].' екр.<br><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Плащ героя, которому хотите сбросить статы
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="Сброс статов для уникальных Плащей героя"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype=7002 and unik>0 and stbonus=0) ORDER BY ecost DESC');

											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] == 7002) {
														echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src="https://i.oldbk.com/i/sh/'.$i['img'].'"  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i).'\')"></span> ';
													} else {
														echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща героя");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плаща героя");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();

												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей Героя';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}




function ShowChenge_bank()
{
	global $user;
	global $PRICE;
	$bprice = $PRICE[225][cost];
$us = check_users_city_datal($user);
$view=true;



		if ((isset($_POST['bankpass']) ) and (isset($_POST['bankid'])) )
		{

			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{

				//основной или первый счет
				$bank = mysql_fetch_array(mysql_query("select * from oldbk.bank where owner='{$us['id']}' order by def desc,id limit 1"));
				$bankpas=$_POST['bankpass'];

				$bankid=(int)($_POST['bankid']);//счет который восстанавливаем
				$rebank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' "));

				if (($bank[id]>0) and ($bank['pass']==md5($bankpas) ) and ($rebank['id']>0) )
					{
						if ( (($bank['ekr']) < $bprice) and ($bprice >0) )
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
							$q = mysql_query('START TRANSACTION') or die();

							//Делаем апдейт счета
							mysql_query("UPDATE `oldbk`.`bank` SET `pass`='{$bank['pass']}' WHERE `id`='{$rebank['id']}'");

							 if (mysql_affected_rows()>0)
								{
								serr("Вы удачно установили пароль на счет №{$rebank['id']}  ");
								if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}


														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=$us['money'];
														$rec['owner_rep_do']=$us['repmoney'];
														$rec['target_login'] = "КО";
														$rec['owner_rep_posle']=$us['repmoney'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['add_info']="Установка пароля на счет:".$rebank['id'];
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m =" \"{$us['login']}\" установил пароль на счет: {$rebank['id']}  за {$bprice} екр. со счета {$bank['id']}";
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Вы удачно установили пароль на счет №{$rebank['id']}.");
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
								 }
								 else
								 {
								serr('Пароль не установлен, возможно он уже такой же как от основного счета!');
								 }
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Cменить пароль от не основного счета на такой же как основной</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>";


		echo "<br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}'  order by def desc,id ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$k=1;
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
									if (($k==1) and ($row[def]==1))
										{
										$def_bank='Основной банковский счет:<b>'.$row['id'].'</b> пароль:<input type=password size=8 name=bankpass><br><br>' ;
										}
										elseif ($k==1)	{$def_bank='Не основной, но первый счет:<b>'.$row['id'].'</b> пароль:<input type=password size=8 name=bankpass><br><br>' ;}
										else
										{
										$BANKS.="<option>".$row['id']."</option>";
										}
								$k++;
								}
									$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" ><br>

											<center>
											К оплате сумма: '.$PRICE[225][cost].' екр.<br><br>
											'.$def_bank.'
											Счет для установки пароля:'.$BANKS;
											echo '</center>';
											echo '<br><center><input type="hidden" id="services" name="services" value="Cменить пароль от не основного счета на такой же как основной"><input type="submit" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ"></center></form>';

					}
	}
}



function ShowChenge_fb_to_lfb()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=100028  AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""   and stbonus=0 and mfbonus=0 and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[232][cost];
			$bprice_kr = $PRICE[232][cost_add_kr];
			$useditems = "";
			$artid = 0;
			$artinfo = "";
//echo "D1";
			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo = $i;

						if ($i['unik']==1)
							{
							$bprice = $PRICE[232][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif ($i['unik']>=2)
							{
							$bprice = $PRICE[232][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
					} else {
						die("DDE");
					}
			}
///echo "D2";
			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
//echo "D3";
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die("1");
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and (setsale = 0 and dressed = 0 and prototype=100028 and stbonus=0 and mfbonus=0) ") or die('2');
							 if (mysql_affected_rows()>0)
								{
								//echo "D4";
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=100030')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100028')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];
								$i['ecost']=$i['unikflag'];
								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = $artinfo['gold'];
								$i['getfrom']=$artinfo['getfrom'];


								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									$i['ecost']=floor($i['ecost'] / 2);
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Футболка ОлдБК (мф) на Легендарную футболку ОлдБК (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die();
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Легендарную футболку ОлдБК (мф) ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[232]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
<table align=center><tr align=left><td>

	<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>
      - обмену подлежат обычные модифицированные, уникальные или улучшенные уникальные футболки ОлдБК<br>
      - обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
      - обычные модифицированные футболки обмениваются на обычные модифицированные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>
      		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранную Вами обычную модифицированную, уникальную или улучшенную уникальную Легендарную футболку ОлдБК с сохранением модификации</p>
		<br>";
echo "</p>
		<p><b style=\"color:#800000\">  Стоимость обмена Футболки ОлдБК (мф) на Легендарную футболку ОлдБК (мф):</b><br>
		".$PRICE[232]['cost']." екр + ".$PRICE[232]['cost_add_kr']." кр для обычной модифицированной<br>
		".$PRICE[232]['cost_unik_ekr']." екр. для уникальной или улучшенной уникальной<br><br></p>
<p><table align=left><tr valign=middle><td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
		<br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span> екр <span id="krnum" style="font-weight:bold;"></span><br>
											<br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются вещи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Футболку ОлдБК, которую хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[232]['desc'].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype =100028 and bs_owner=0 AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and   stbonus=0 and mfbonus=0 and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';

													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного предмета");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один предмет");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


														if (itemproto == 1) {
															ekrnum = '.$PRICE[232][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[232][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[232][cost].';
															krnum="+'.$PRICE[232][cost_add_kr].' кр";
															}

															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML = ekrnum;
													document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящей Футболки ОлдБК';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}




function ShowChenge_fu_to_lfb()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=100029  AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""   and stbonus=0 and mfbonus=0 and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[231][cost];
			$bprice_kr = $PRICE[231][cost_add_kr];
			$useditems = "";
			$artid = 0;
			$artinfo = "";
//echo "D1";
			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo = $i;

						if ($i['unik']==1)
							{
							$bprice = $PRICE[231][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif ($i['unik']>=2)
							{
							$bprice = $PRICE[231][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
					} else {
						die("DDE");
					}
			}
///echo "D2";
			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
//echo "D3";
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die("1");
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and (setsale = 0 and dressed = 0 and prototype=100029 and stbonus=0 and mfbonus=0) ") or die('2');
							 if (mysql_affected_rows()>0)
								{
								//echo "D4";
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=100030')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100029')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];
								$i['ecost']=$i['unikflag'];
								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = $artinfo['gold'];
								$i['getfrom']=$artinfo['getfrom'];



								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									$i['ecost']=floor($i['ecost'] / 2);
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Футболку Учителей (мф) на Легендарную футболку ОлдБК (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die();
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Легендарную футболку ОлдБК (мф) ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[231]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
<table align=center><tr align=left><td>

	<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>
      - обмену подлежат обычные модифицированные, уникальные или улучшенные уникальные Футболку Учителей (мф)<br>
      - обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
      - обычные модифицированные футболки обмениваются на обычные модифицированные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>
      		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранную Вами обычную модифицированную, уникальную или улучшенную уникальную Легендарную футболку ОлдБК с сохранением модификации</p>
		<br>";
echo "</p>
		<p><b style=\"color:#800000\">  Стоимость обмена Футболку Учителей (мф) на Легендарную футболку ОлдБК (мф):</b><br>
		".$PRICE[231]['cost']." екр + ".$PRICE[231]['cost_add_kr']." кр для обычной модифицированной<br>
		".$PRICE[231]['cost_unik_ekr']." екр. для уникальной или улучшенной уникальной<br><br></p>
<p><table align=left><tr valign=middle><td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
		<br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span> екр <span id="krnum" style="font-weight:bold;"></span><br>
											<br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются вещи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Футболку ОлдБК, которую хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[231]['desc'].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype =100029 and bs_owner=0 AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and   stbonus=0 and mfbonus=0 and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';

													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного предмета");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один предмет");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


														if (itemproto == 1) {
															ekrnum = '.$PRICE[231][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[231][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[231][cost].';
															krnum="+'.$PRICE[231][cost_add_kr].' кр";
															}

															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML = ekrnum;
													document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящей Футболки Учителей (мф)';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}



function ShowChenge_fb_to_lgu2()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=100029  AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""   and stbonus=0 and unik>0 and mfbonus=0 and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[234][cost];
			$bprice_kr = $PRICE[234][cost_add_kr];
			$useditems = "";
			$artid = 0;
			$artinfo = "";
			$bprice_gold=0;

			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo = $i;

							if (($i['unik']>=1) and ($PRICE[234][cost_unik_gold]>0) )
							{
							$bprice = 0;//екр
							$bprice_kr = 0;
							$bprice_gold=$PRICE[234][cost_unik_gold];
							}
							elseif (($i['unik']==1) and ($PRICE[234][cost_unik_ekr]>0 ))
							{
							$bprice = $PRICE[234][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif (($i['unik']>=2)  and ($PRICE[234][cost_unik_ekr]>0 ))
							{
							$bprice = $PRICE[234][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
					} else {
						die("DDE");
					}
			}

			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='')) AND ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				if ($bprice>0)
				{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				}

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if (($us['gold']<$bprice_gold) and ($bprice_gold>0))
					{
						serr("У Вас не достаточно золотых монет для компенсации. Необходимая сумма ".$bprice_gold." монет.");
					}
				else
				if ( (($bank[id]>0) and ($bprice>0)) OR ($bprice_gold>0) )
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die("1");
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and (setsale = 0 and dressed = 0 and prototype=100029 and stbonus=0 and mfbonus=0) ") or die('2');
							 if (mysql_affected_rows()>0)
								{
								//echo "D4";
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=100031')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100029')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=130; // 130екр Легендарная футболка Учителей

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = 2600;
								$i['getfrom']=$artinfo['getfrom'];



								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									if ($i['ecost']>0)  { $i['ecost']=80; }
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Футболку Учителей (мф) на Легендарную футболку Учителей (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die();
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}

													if ($bprice_gold>0)
														{
															//оплата в золоте
															mysql_query("UPDATE users SET `gold` = `gold` - '{$bprice_gold}' WHERE `id`= '{$us['id']}'  ") or die();
															$us['gold'] -= $bprice_gold;
															$rec = array();
												    			$rec['owner']=$us[id];
															$rec['owner_login']=$us[login];
															$rec['owner_balans_do']=$us['money'];
															$rec['owner_balans_posle']=($us['money']-$bprice_kr);
															$rec['target_login'] = "КО";
															$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
															$rec['item_name']=$i['name'];
															$rec['type'] = 2284;
															$rec['bank_id']=$bank['id'];
															$rec['sum_ekr']=$bprice;
															$rec['sum_kr']=$bprice_kr;
															$rec['bank_id']=$bank['id'];
															$rec['add_info'] = $us['gold'].'/'.$bprice_gold;
															$rec['add_info'].="/Старый предмет:".get_xitem_fid($artinfo);
															if (add_to_new_delo($rec) === FALSE) die();

														}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Легендарную футболку ОлдБК (мф) ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
	 /*
      - обмену подлежат обычные модифицированные, уникальные или улучшенные уникальные Футболку Учителей (мф)<br>
      - обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
      - обычные модифицированные футболки обмениваются на обычные модифицированные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные
	 */
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[234]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
<table align=center><tr align=left><td>

	<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>
      - Обменять на Легендарную футболку учителей (мф) можно только уникальную или улучшенную уникальную футболку.
	<br></p>
      		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранную Вами уникальную или улучшенную уникальную Легендарную футболку Учителей с сохранением модификации</p>
		<br>";
echo "</p>
		<p><b style=\"color:#800000\">  Стоимость обмена Футболки Учителей (мф) на Легендарную футболку Учителей (мф):</b><br>	";
//	".$PRICE[234]['cost']." екр + ".$PRICE[234]['cost_add_kr']." кр для обычной модифицированной<br>";


		if ($PRICE[234][cost_unik_gold]>0) { echo $PRICE[234][cost_unik_gold]." золотых монет для уникальной или улучшенной уникальной<br><br></p>";}
		elseif ($PRICE[234][cost_unik_ekr]>0) { echo $PRICE[234][cost_unik_ekr]." екр. для уникальной или улучшенной уникальной<br><br></p>";}

echo "
<p><table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table></p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
		<br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span><span id="krnum" style="font-weight:bold;"></span><span id="goldnum" style="font-weight:bold;"></span><br>
											<span id="bankau">Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass></span><br><br>
											<font color=red>Отображаются вещи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Футболку ОлдБК, которую хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[234]['desc'].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype =100029 and bs_owner=0 AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and   stbonus=0 and unik>0 and mfbonus=0 and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';

													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;
												var goldnum="";

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного предмета");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один предмет");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);
														';

														if ($PRICE[234][cost_unik_gold]>0)
														{
														echo '
														if (itemproto >= 1) {
															goldnum = '.$PRICE[234][cost_unik_gold].';
															ekrnum="";
															krnum="";
														}
														else
															{
															goldnum="";
															ekrnum = '.$PRICE[234][cost].';
															krnum="+'.$PRICE[234][cost_add_kr].' кр";
															}
														';
														}
														else
														{
														echo '
														if (itemproto == 1) {
															ekrnum = '.$PRICE[234][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[234][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[234][cost].';
															krnum="+'.$PRICE[234][cost_add_kr].' кр";
															}
														';
														}
													echo '
															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML ="";
													document.getElementById("goldnum").innerHTML ="";
													document.getElementById("krnum").innerHTML ="";

													if (goldnum!="")
															{
															document.getElementById("goldnum").innerHTML = goldnum +" золотых монет";
															document.getElementById("bankau").style.display="none";
															}

													if (ekrnum!="") {
															document.getElementById("ekrnum").innerHTML = ekrnum + " екр.";
															document.getElementById("bankau").style.display="block";
													 		}

													if (krnum!="") document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящей Футболку Учителей';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}

function ShowChenge_fb_to_fu()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=100028  AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""   and stbonus=0 and mfbonus=0 and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[226][cost];
			$bprice_kr = $PRICE[226][cost_add_kr];
			$useditems = "";
			$artid = 0;
			$artinfo = "";
//echo "D1";
			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo = $i;

						if ($i['unik']==1)
							{
							$bprice = $PRICE[226][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif ($i['unik']>=2)
							{
							$bprice = $PRICE[226][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
					} else {
						die("DDE");
					}
			}
///echo "D2";
			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
//echo "D3";
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die("1");
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and (setsale = 0 and dressed = 0 and prototype=100028 and stbonus=0 and mfbonus=0) ") or die('2');
							 if (mysql_affected_rows()>0)
								{
								//echo "D4";
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100029')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100028')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];
								$i['ecost']=$i['unikflag'];
								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = $artinfo['gold'];
								$i['getfrom']=$artinfo['getfrom'];


								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									$i['ecost']=floor($i['ecost'] / 2);
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Футболка ОлдБК (мф) на Футболка Учителей (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die();
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Футболка Учителей (мф) ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[226]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
<table align=center><tr align=left><td>

<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>
<b>- обмену подлежат обычные, уникальные и улучшенные уникальные Футболки ОлдБК<br>
- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не одетые на персонаже<br>
- обычные футболки обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные обмениваются на улучшенные</b><br></p>

<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
- выбранную Вами обычную, уникальную или улучшенную уникальную Футболку Учителей с сохранением модификации<br><br><br>";

echo "</p>

<p><b style=\"color:#800000\">Стоимость обмена: </b><br>
".$PRICE[226]['cost']." екр + ".$PRICE[226]['cost_add_kr']." кр для обычной футболки <br>
".$PRICE[226]['cost_unik_ekr']." екр. для уникальной или улучшенной уникальной футболки<br><br></p>


<p><table align=left><tr valign=middle><td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
		<br>";





					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span> екр <span id="krnum" style="font-weight:bold;"></span><br>
											<br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются вещи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Футболку ОлдБК, которую хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[226]['desc'].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype =100028 and bs_owner=0 AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and   stbonus=0 and mfbonus=0 and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
//														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\'test\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного предмета");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один предмет");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


														if (itemproto == 1) {
															ekrnum = '.$PRICE[226][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[226][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[226][cost].';
															krnum="+'.$PRICE[226][cost_add_kr].' кр";
															}

															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML = ekrnum;
													document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящей Футболки ОлдБК (мф)';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}



function ShowChenge_fb_to_lgu1()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=100030  AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""   and stbonus=0 and unik>0  and mfbonus=0 and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[233][cost];
			$bprice_kr = $PRICE[233][cost_add_kr];
			$useditems = "";
			$artid = 0;
			$artinfo = "";

			$bprice_gold=0;

			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo = $i;

						if (($i['unik']>=1) and ($PRICE[233][cost_unik_gold]>0) )
							{
							$bprice = 0;//екр
							$bprice_kr = 0;
							$bprice_gold=$PRICE[233][cost_unik_gold];
							}
						elseif (($i['unik']==1) and ($PRICE[233][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[233][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif (($i['unik']>=2) and ($PRICE[233][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[233][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
					} else {
						die("DDE");
					}
			}

			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='')) AND ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				if ($bprice>0)
				{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				}

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if (($us['gold']<$bprice_gold) and ($bprice_gold>0))
					{
						serr("У Вас не достаточно золотых монет для компенсации. Необходимая сумма ".$bprice_gold." монет.");
					}
				else
				if ( (($bank[id]>0) and ($bprice>0)) OR ($bprice_gold>0) )
					{

						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die("1");
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and (setsale = 0 and dressed = 0 and prototype=100030 and stbonus=0 and mfbonus=0) ") or die('2');
							 if (mysql_affected_rows()>0)
								{
								//echo "D4";
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=100031')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100030')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=130; // 130екр Легендарная футболка Учителей

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = 2600;
								$i['getfrom']=$artinfo['getfrom'];


								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									if ($i['ecost']>0)  { $i['ecost']=80; }
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Легендарную футболку ОлдБК (мф) на Легендарную футболку Учителей (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die();
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}

													if ($bprice_gold>0)
														{
															//оплата в золоте
															mysql_query("UPDATE users SET `gold` = `gold` - '{$bprice_gold}' WHERE `id`= '{$us['id']}'  ") or die();
															$us['gold'] -= $bprice_gold;
															$rec = array();
												    			$rec['owner']=$us[id];
															$rec['owner_login']=$us[login];
															$rec['owner_balans_do']=$us['money'];
															$rec['owner_balans_posle']=($us['money']-$bprice_kr);
															$rec['target_login'] = "КО";
															$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
															$rec['item_name']=$i['name'];
															$rec['type'] = 2284;
															$rec['bank_id']=$bank['id'];
															$rec['sum_ekr']=$bprice;
															$rec['sum_kr']=$bprice_kr;
															$rec['bank_id']=$bank['id'];
															$rec['add_info'] = $us['gold'].'/'.$bprice_gold;
															$rec['add_info'].="/Старый предмет:".get_xitem_fid($artinfo);
															if (add_to_new_delo($rec) === FALSE) die();

														}

													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Футболка Учителей (мф) ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
	 /*
- обмену подлежат обычные, уникальные и улучшенные уникальные Легендарные футболки ОлдБК<br>
- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не одетые на персонаже<br>
- обычные футболки обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные обмениваются на улучшенные</b>
	 */
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[233]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
<table align=center><tr align=left><td>

<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>
      - Обменять на Легендарную футболку учителей (мф) можно только уникальную или улучшенную уникальную футболку.
<br></p>

<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
- выбранную Вами уникальную или улучшенную уникальную Легендарную футболку Учителей с сохранением модификации<br><br><br>";

echo "</p>

<p><b style=\"color:#800000\">Стоимость обмена: </b><br>";
//".$PRICE[233]['cost']." екр + ".$PRICE[233]['cost_add_kr']." кр для обычной футболки <br>";

	if ($PRICE[233][cost_unik_gold]>0) { echo $PRICE[233][cost_unik_gold]." золотых монет для уникальной или улучшенной уникальной<br><br></p>";}
	elseif ($PRICE[233][cost_unik_ekr]>0) { echo $PRICE[233][cost_unik_ekr]." екр. для уникальной или улучшенной уникальной<br><br></p>";}


echo "
<p>	<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table></p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
		<br>";





					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span><span id="krnum" style="font-weight:bold;"></span><span id="goldnum" style="font-weight:bold;"></span><br>
											<span id="bankau">Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass></span><br><br>
											<font color=red>Отображаются вещи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Легендарную футболку ОлдБК (мф), которую хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[233]['desc'].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype =100030 and bs_owner=0 AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and   stbonus=0 and unik>0 and mfbonus=0 and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;
												var goldnum="";

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного предмета");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один предмет");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);
														';

														if ($PRICE[233][cost_unik_gold]>0)
														{
														echo '
														if (itemproto >= 1) {
															goldnum = '.$PRICE[233][cost_unik_gold].';
															ekrnum="";
															krnum="";
														}
														else
															{
															goldnum="";
															ekrnum = '.$PRICE[233][cost].';
															krnum="+'.$PRICE[233][cost_add_kr].' кр";
															}
														';
														}
														else
														{
														echo '
														if (itemproto == 1) {
															ekrnum = '.$PRICE[233][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[233][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[233][cost].';
															krnum="+'.$PRICE[233][cost_add_kr].' кр";
															}
														';
														}
													echo '
															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML ="";
													document.getElementById("goldnum").innerHTML ="";
													document.getElementById("krnum").innerHTML ="";

													if (goldnum!="")
															{
															document.getElementById("goldnum").innerHTML = goldnum +" золотых монет";
															document.getElementById("bankau").style.display="none";
															}

													if (ekrnum!="") {
															document.getElementById("ekrnum").innerHTML = ekrnum + " екр.";
															document.getElementById("bankau").style.display="block";
													 		}

													if (krnum!="") document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящей Легендарной футболки ОлдБК (мф)';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}




function ShowChenge_fb_to_lgu3()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {
		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND  ((setsale = 0 and dressed = 0 and prototype=100028  AND present!="Арендная лавка" and bs_owner=0  AND `prokat_idp`=0 AND arsenal_klan = ""   and stbonus=0 and unik>0 and mfbonus=0 and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[235][cost];
			$bprice_kr = $PRICE[235][cost_add_kr];
			$useditems = "";
			$artid = 0;
			$artinfo = "";

			$bprice_gold=0;


			while($i = mysql_fetch_assoc($q))
			{
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0)
					{
						$artid = $i['id'];
						$artinfo = $i;


							if (($i['unik']>=1) and ($PRICE[235][cost_unik_gold]>0) )
							{
							$bprice = 0;//екр
							$bprice_kr = 0;
							$bprice_gold=$PRICE[235][cost_unik_gold];
							}
							elseif (($i['unik']==1) and ($PRICE[235][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[235][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif (($i['unik']>=2) and ($PRICE[235][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[235][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
					} else {
						die("DDE");
					}
			}

			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='')) AND ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				if ($bprice>0)
				{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				}

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if (($us['gold']<$bprice_gold) and ($bprice_gold>0))
					{
						serr("У Вас не достаточно золотых монет для компенсации. Необходимая сумма ".$bprice_gold." монет.");
					}
				else
				if ( (($bank[id]>0) and ($bprice>0)) OR ($bprice_gold>0) )
					{
					//echo "S1/";
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die("1");
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and (setsale = 0 and dressed = 0 and prototype=100028 and stbonus=0 and mfbonus=0) ") or die('2');
							 if (mysql_affected_rows()>0)
								{
								//echo "D4";
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=100031')) or die("error id=100031 ");
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=100028')) or die("error id=100028");

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=130; // 130екр Легендарная футболка Учителей

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = 2600;
								$i['getfrom']=$artinfo['getfrom'];


								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									if ($i['ecost']>0)  { $i['ecost']=80; }
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Футболка ОлдБК (мф) на Легендарную футболку Учителей (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die();
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}

														if ($bprice_gold>0)
														{
															//оплата в золоте
															mysql_query("UPDATE users SET `gold` = `gold` - '{$bprice_gold}' WHERE `id`= '{$us['id']}'  ") or die();
															$us['gold'] -= $bprice_gold;
															$rec = array();
												    			$rec['owner']=$us[id];
															$rec['owner_login']=$us[login];
															$rec['owner_balans_do']=$us['money'];
															$rec['owner_balans_posle']=($us['money']-$bprice_kr);
															$rec['target_login'] = "КО";
															$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
															$rec['item_name']=$i['name'];
															$rec['type'] = 2284;
															$rec['bank_id']=$bank['id'];
															$rec['sum_ekr']=$bprice;
															$rec['sum_kr']=$bprice_kr;
															$rec['bank_id']=$bank['id'];
															$rec['add_info'] = $us['gold'].'/'.$bprice_gold;
															$rec['add_info'].="/Старый предмет:".get_xitem_fid($artinfo);
															if (add_to_new_delo($rec) === FALSE) die();

														}

													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Футболка Учителей (мф) ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}
	}
if ($view==true)
	 {
	 /*
<b>- обмену подлежат обычные, уникальные и улучшенные уникальные Футболки ОлдБК<br>
- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не одетые на персонаже<br>
- обычные футболки обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные обмениваются на улучшенные</b>
	 */
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[235]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">
<table align=center><tr align=left><td>

<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>
      - Обменять на Легендарную футболку учителей (мф) можно только уникальную или улучшенную уникальную футболку.
<br></p>

<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
- выбранную Вами уникальную или улучшенную уникальную Легендарную футболку Учителей с сохранением модификации<br><br><br>";

echo "</p>

<p><b style=\"color:#800000\">Стоимость обмена: </b><br>";
//".$PRICE[235]['cost']." екр + ".$PRICE[235]['cost_add_kr']." кр для обычной футболки <br>";

	if ($PRICE[235][cost_unik_gold]>0) { echo $PRICE[235][cost_unik_gold]." золотых монет для уникальной или улучшенной уникальной<br><br></p>";}
	elseif ($PRICE[235][cost_unik_ekr]>0) { echo $PRICE[235][cost_unik_ekr]." екр. для уникальной или улучшенной уникальной<br><br></p>";}


echo "
<p><table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table></p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
		<br>";





					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span><span id="krnum" style="font-weight:bold;"></span><span id="goldnum" style="font-weight:bold;"></span><br>
											<span id="bankau">Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass></span><br><br>
											<font color=red>Отображаются вещи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Футболку ОлдБК, которую хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[235]['desc'].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale = 0 and dressed = 0 and prototype =100028 and bs_owner=0 AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and   stbonus=0 and unik>0 and mfbonus=0 and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;
												var goldnum="";

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного предмета");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один предмет");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);
														';
													if ($PRICE[235][cost_unik_gold]>0)
														{
														echo '
														if (itemproto >= 1) {
															goldnum = '.$PRICE[235][cost_unik_gold].';
															ekrnum="";
															krnum="";
														}
														else
															{
															goldnum="";
															ekrnum = '.$PRICE[235][cost].';
															krnum="+'.$PRICE[235][cost_add_kr].' кр";
															}
														';
														}
														else
														{
														echo '
														if (itemproto == 1) {
															ekrnum = '.$PRICE[235][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[235][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[235][cost].';
															krnum="+'.$PRICE[235][cost_add_kr].' кр";
															}
														';
														}
													echo '
															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML ="";
													document.getElementById("goldnum").innerHTML ="";
													document.getElementById("krnum").innerHTML ="";

													if (goldnum!="")
															{
															document.getElementById("goldnum").innerHTML = goldnum +" золотых монет";
															document.getElementById("bankau").style.display="none";
															}

													if (ekrnum!="") {
															document.getElementById("ekrnum").innerHTML = ekrnum + " екр.";
															document.getElementById("bankau").style.display="block";
													 		}

													if (krnum!="") document.getElementById("krnum").innerHTML = krnum;
												});
												</script>';
											} else {
												echo 'У Вас нет подходящей Футболки ОлдБК';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}


function ShowChenge_cloack_legend_r()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {

		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" AND  ((setsale = 0 and dressed = 0 and prototype in (5103,7002) and bs_owner=0 and stbonus=0  and (sowner=0 or sowner=owner) and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[229][cost];

			$useditems = "";
			$artid = 0;
			$artinfo = "";

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;

							if ($i['unik']==0)
							{
							$bprice = $PRICE[229][cost];//екр
							$bprice_kr = $PRICE[229][cost_add_kr];	//4000 кр
							}
							elseif ($i['unik']==1)
							{
							$bprice = $PRICE[229][cost_unik_ekr];//40 екр
							$bprice_kr = 0;
							}
							elseif ($i['unik']>=2)
							{
							$bprice = $PRICE[229][cost_unik_ekr];// 40 екр
							$bprice_kr = 0;
							}
					} else {
						die();
					}
			}


			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{

				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}
							$q = mysql_query('START TRANSACTION') or die();
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and present!='Арендная лавка'  AND `prokat_idp`=0 AND arsenal_klan = '' and (setsale = 0 and dressed = 0 and prototype in (5103,7002) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) ) LIMIT 1;");

							 if (mysql_affected_rows()>0)
								{
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=7005')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7002')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=$i['unikflag'];
								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = $artinfo['gold'];
								$i['getfrom']=$artinfo['getfrom'];

								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];



								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									$i['ecost']=60; // не уник 60 екр
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Плащ героя на Плащ легендарного рыцаря");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['bank_id']=$bank['id'];
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Плащ легендарного рыцаря ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
									else
									{
									echo "Error del old item";
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}

	}

if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[229][desc]."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
		- обмену подлежат модифицированные, уникальные или улучшенные уникальные Плащи Героя<br>
		- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
		- обычные плащи обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>
		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранный Вами обычный, уникальный или улучшенный уникальный Плащ легендарного рыцаря с сохранением модификации</p>
		<br>
		<p><b style=\"color:#800000\"> Стоимость обмена Плаща героя на Плащ легендарного рыцаря:</b><br>
		".$PRICE[229][cost]." екр + ".$PRICE[229][cost_add_kr]." кр для обычного плаща<br>
		".$PRICE[229][cost_unik_ekr]." екр. для уникального или улучшенного уникального плаща<br><br></p>


		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table>

		</td></tr></table><br>";




		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span> екр <span id="krnum" style="font-weight:bold;"></span><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Плащ героя, который хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[229][desc].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and (setsale = 0 and dressed = 0 and prototype in (5103,7002) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща героя");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плаща героя");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


														if (itemproto == 1) {
															ekrnum = '.$PRICE[229][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[229][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[229][cost].';
															krnum="+'.$PRICE[229][cost_add_kr].' кр";
															}

															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML = ekrnum;
													document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей героя';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}



function ShowChenge_cloack_legend_g1()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {

		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" AND  ((setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and unik>0  and (sowner=0 or sowner=owner) and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[241][cost];

			$useditems = "";
			$artid = 0;
			$artinfo = "";
			$bprice_kr=0;
			$bprice_gold=0;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;

							if ($i['unik']==0)
							{
							$bprice = $PRICE[241][cost]; // екр
							$bprice_kr = $PRICE[241][cost_add_kr];
							}
							elseif (($i['unik']>=1) and ($PRICE[241][cost_unik_gold]>0) )
							{
							$bprice = 0;//екр
							$bprice_kr = 0;
							$bprice_gold=$PRICE[241][cost_unik_gold];
							}
							elseif (($i['unik']==1) and ($PRICE[241][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[241][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif ( ($i['unik']>=2) and ($PRICE[241][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[241][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}

					} else {
						die();
					}
			}


			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='')) AND ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				if ($bprice>0)
				{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				}

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if (($us['gold']<$bprice_gold) and ($bprice_gold>0))
					{
						serr("У Вас не достаточно золотых монет для компенсации. Необходимая сумма ".$bprice_gold." монет.");
					}
				else
				if ( (($bank[id]>0) and ($bprice>0)) OR ($bprice_gold>0) )
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
							// если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die();
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and present!='Арендная лавка'  AND `prokat_idp`=0 AND arsenal_klan = '' and (setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) ) LIMIT 1;");

							 if (mysql_affected_rows()>0)
								{
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=7006')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7001')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=130; // Плащ легендарного героя
								$i['repcost']=81000; //реп

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;

								$i['gold']=0;

								if ($artinfo['gold'] > 0) $i['gold']=2600; //гос в золоте

								$i['getfrom']=$artinfo['getfrom'];


								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									if ($i['ecost']>0) { $i['ecost']=80; }
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Плащ рыцаря (мф) на Плащ легендарного героя (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['bank_id']=$bank['id'];
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}

													if ($bprice_gold>0)
														{
															//оплата в золоте
															mysql_query("UPDATE users SET `gold` = `gold` - '{$bprice_gold}' WHERE `id`= '{$us['id']}'  ") or die();
															$us['gold'] -= $bprice_gold;
															$rec = array();
												    			$rec['owner']=$us[id];
															$rec['owner_login']=$us[login];
															$rec['owner_balans_do']=$us['money'];
															$rec['owner_balans_posle']=($us['money']-$bprice_kr);
															$rec['target_login'] = "КО";
															$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
															$rec['item_name']=$i['name'];
															$rec['type'] = 2284;
															$rec['bank_id']=$bank['id'];
															$rec['sum_ekr']=$bprice;
															$rec['sum_kr']=$bprice_kr;
															$rec['bank_id']=$bank['id'];
															$rec['add_info'] = $us['gold'].'/'.$bprice_gold;
															$rec['add_info'].="/Старый предмет:".get_xitem_fid($artinfo);
															if (add_to_new_delo($rec) === FALSE) die();

														}

													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Плащ легендарного рыцаря ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
									else
									{
									echo "Error del old item";
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}

	}

if ($view==true)
	 {
	 /*
	 - обмену подлежат модифицированные, уникальные или улучшенные уникальные Плащи Рыцаря<br>
		- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
		- обычные плащи обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>
	 */

		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[241][desc]."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
		- Обменять на Плащ легендарного героя (мф) можно только уникальные или улучшенные уникальные плащи.<br></p>
		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранный Вами уникальный или улучшенный уникальный Плащ легендарного героя с сохранением модификации</p>
		<br>
		<p><b style=\"color:#800000\">Стоимость обмена:</b><br>						";
//		".$PRICE[241][cost]." екр + ".$PRICE[241][cost_add_kr]." кр для обычного плаща<br>";

		if ($PRICE[241][cost_unik_gold]>0) { echo $PRICE[241][cost_unik_gold]." золотых монет для уникального или улучшенного уникального плаща<br><br></p>";}
		elseif ($PRICE[241][cost_unik_ekr]>0) { echo $PRICE[241][cost_unik_ekr]." екр. для уникального или улучшенного уникального плаща<br><br></p>";}

		echo "
		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table>

		</td></tr></table><br>";




		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span><span id="krnum" style="font-weight:bold;"></span><span id="goldnum" style="font-weight:bold;"></span><br>
											<span id="bankau">Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass></span><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Плащ рыцаря, который хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[241][desc].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and (setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and unik>0 and (sowner=0 or sowner=owner) and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;
												var goldnum="";

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща рыцаря");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плаща рыцаря");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);

																	';

													if ($PRICE[241][cost_unik_gold]>0)
														{
														echo '
														if (itemproto >= 1) {
															goldnum = '.$PRICE[241][cost_unik_gold].';
															ekrnum="";
															krnum="";
														}
														else
															{
															goldnum="";
															ekrnum = '.$PRICE[241][cost].';
															krnum="+'.$PRICE[241][cost_add_kr].' кр";
															}
														';
														}
														else
														{
														echo '
														if (itemproto == 1) {
															ekrnum = '.$PRICE[241][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[241][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[241][cost].';
															krnum="+'.$PRICE[241][cost_add_kr].' кр";
															}
														';
														}

													echo '


															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML ="";
													document.getElementById("goldnum").innerHTML ="";
													document.getElementById("krnum").innerHTML ="";

													if (goldnum!="")
															{
															document.getElementById("goldnum").innerHTML = goldnum +" золотых монет";
															document.getElementById("bankau").style.display="none";
															}

													if (ekrnum!="") {
															document.getElementById("ekrnum").innerHTML = ekrnum + " екр.";
															document.getElementById("bankau").style.display="block";
													 		}

													if (krnum!="") document.getElementById("krnum").innerHTML = krnum;
												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей рыцаря';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}

}



function ShowChenge_cloack_legend_g2()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {

		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" AND  ((setsale = 0 and dressed = 0 and prototype in (5103,7002) and bs_owner=0 and stbonus=0 and unik>0  and (sowner=0 or sowner=owner) and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[242][cost];

			$useditems = "";
			$artid = 0;
			$artinfo = "";
			$bprice_kr=0;
			$bprice_gold=0;


			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;

							if ($i['unik']==0)
							{
							$bprice = $PRICE[242][cost];//екр
							$bprice_kr = $PRICE[242][cost_add_kr];	//кр
							}
							elseif (($i['unik']>=1) and ($PRICE[242][cost_unik_gold]>0) )
							{
							$bprice = 0;//екр
							$bprice_kr = 0;
							$bprice_gold=$PRICE[242][cost_unik_gold];
							}
							elseif ( ($i['unik']==1) and ($PRICE[242][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[242][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif ( ($i['unik']>=2) and ($PRICE[242][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[242][cost_unik_ekr];// екр
							$bprice_kr = 0;
							}
					} else {
						die();
					}
			}


			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='')) AND ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{

				if ($bprice>0)
				{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				}

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if (($us['gold']<$bprice_gold) and ($bprice_gold>0))
					{
						serr("У Вас не достаточно золотых монет для компенсации. Необходимая сумма ".$bprice_gold." монет.");
					}
				else
				if ( (($bank[id]>0) and ($bprice>0)) OR ($bprice_gold>0) )
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}
							$q = mysql_query('START TRANSACTION') or die();
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and present!='Арендная лавка'  AND `prokat_idp`=0 AND arsenal_klan = '' and (setsale = 0 and dressed = 0 and prototype in (5103,7002) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) ) LIMIT 1;");

							 if (mysql_affected_rows()>0)
								{
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=7006')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7002')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=130; // Плащ легендарного героя
								$i['repcost']=81000; //реп

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;

								if ($artinfo['gold'] > 0) $i['gold']=2600; //гос в золоте

								$i['getfrom']=$artinfo['getfrom'];

								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];



								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									if ($i['ecost']>0) { $i['ecost']=80; }
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Плащ героя (МФ) на Плащ легендарного героя (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['bank_id']=$bank['id'];
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}

													if ($bprice_gold>0)
														{
															//оплата в золоте
															mysql_query("UPDATE users SET `gold` = `gold` - '{$bprice_gold}' WHERE `id`= '{$us['id']}'  ") or die();
															$us['gold'] -= $bprice_gold;
															$rec = array();
												    			$rec['owner']=$us[id];
															$rec['owner_login']=$us[login];
															$rec['owner_balans_do']=$us['money'];
															$rec['owner_balans_posle']=($us['money']-$bprice_kr);
															$rec['target_login'] = "КО";
															$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
															$rec['item_name']=$i['name'];
															$rec['type'] = 2284;
															$rec['bank_id']=$bank['id'];
															$rec['sum_ekr']=$bprice;
															$rec['sum_kr']=$bprice_kr;
															$rec['bank_id']=$bank['id'];
															$rec['add_info'] = $us['gold'].'/'.$bprice_gold;
															$rec['add_info'].="/Старый предмет:".get_xitem_fid($artinfo);
															if (add_to_new_delo($rec) === FALSE) die();

														}

													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Плащ легендарного рыцаря ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
									else
									{
									echo "Error del old item";
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}

	}

if ($view==true)
	 {
	 /*
		- обмену подлежат модифицированные, уникальные или улучшенные уникальные Плащи Героя<br>
		- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
		- обычные плащи обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>
	 */
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[242][desc]."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
		- Обменять на Плащ легендарного героя (мф) можно только уникальные или улучшенные уникальные плащи.<br></p>
		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранный Вами уникальный или улучшенный уникальный Плащ легендарного героя с сохранением модификации</p>
		<br>
		<p><b style=\"color:#800000\"> Стоимость обмена Плаща героя на Плащ легендарного рыцаря:</b><br>	";
//		".$PRICE[242][cost]." екр + ".$PRICE[242][cost_add_kr]." кр для обычного плаща<br>";

		if ($PRICE[242][cost_unik_gold]>0) { echo $PRICE[242][cost_unik_gold]." золотых монет для уникального или улучшенного уникального плаща<br><br></p>";}
		elseif ($PRICE[242][cost_unik_ekr]>0) { echo $PRICE[242][cost_unik_ekr]." екр. для уникального или улучшенного уникального плаща<br><br></p>";}

		echo "
		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table>

		</td></tr></table><br>";




		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span><span id="krnum" style="font-weight:bold;"></span><span id="goldnum" style="font-weight:bold;"></span><br>
											<span id="bankau">Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass></span><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда плащ, который хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[242][desc].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and (setsale = 0 and dressed = 0 and prototype in (5103,7002) and bs_owner=0 and stbonus=0 and unik>0 and (sowner=0 or sowner=owner) and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;
												var goldnum="";

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща героя");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плаща героя");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);

																	';

													if ($PRICE[242][cost_unik_gold]>0)
														{
														echo '
														if (itemproto >= 1) {
															goldnum = '.$PRICE[242][cost_unik_gold].';
															ekrnum="";
															krnum="";
														}
														else
															{
															goldnum="";
															ekrnum = '.$PRICE[242][cost].';
															krnum="+'.$PRICE[242][cost_add_kr].' кр";
															}
														';
														}
														else
														{
														echo '
														if (itemproto == 1) {
															ekrnum = '.$PRICE[242][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[242][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[242][cost].';
															krnum="+'.$PRICE[242][cost_add_kr].' кр";
															}
														';
														}

													 echo '


															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML ="";
													document.getElementById("goldnum").innerHTML ="";
													document.getElementById("krnum").innerHTML ="";

													if (goldnum!="")
															{
															document.getElementById("goldnum").innerHTML = goldnum +" золотых монет";
															document.getElementById("bankau").style.display="none";
															}

													if (ekrnum!="") {
															document.getElementById("ekrnum").innerHTML = ekrnum + " екр.";
															document.getElementById("bankau").style.display="block";
													 		}

													if (krnum!="") document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей героя';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}



function ShowChenge_cloack_legend_g3()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {

		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" AND  ((setsale = 0 and dressed = 0 and prototype=7005 and bs_owner=0 and stbonus=0 and unik>0 and (sowner=0 or sowner=owner) and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[243][cost];

			$useditems = "";
			$artid = 0;
			$artinfo = "";
			$bprice_kr=0;
			$bprice_gold=0;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;

							if ($i['unik']==0)
							{
							$bprice = $PRICE[243][cost];//екр
							$bprice_kr = $PRICE[243][cost_add_kr];	//кр
							}
							elseif (($i['unik']>=1) and ($PRICE[243][cost_unik_gold]>0) )
							{
							$bprice = 0;//екр
							$bprice_kr = 0;
							$bprice_gold=$PRICE[243][cost_unik_gold];
							}
							elseif (($i['unik']==1) and ($PRICE[243][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[243][cost_unik_ekr];//екр
							$bprice_kr = 0;
							}
							elseif (($i['unik']>=2) and ($PRICE[243][cost_unik_ekr]>0) )
							{
							$bprice = $PRICE[243][cost_unik_ekr];// екр
							$bprice_kr = 0;
							}
					} else {
						die();
					}
			}


			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='')) AND ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{

				if ($bprice>0)
				{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
				}

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if (($us['gold']<$bprice_gold) and ($bprice_gold>0))
					{
						serr("У Вас не достаточно золотых монет для компенсации. Необходимая сумма ".$bprice_gold." монет.");
					}
				else
				if ( (($bank[id]>0) and ($bprice>0)) OR ($bprice_gold>0) )
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}
							$q = mysql_query('START TRANSACTION') or die();
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and present!='Арендная лавка'  AND `prokat_idp`=0 AND arsenal_klan = '' and (setsale = 0 and dressed = 0 and prototype=7005 and bs_owner=0 and stbonus=0 and unik>0 and (sowner=0 or sowner=owner) ) LIMIT 1;");

							 if (mysql_affected_rows()>0)
								{
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=7006')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7005')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];

								$i['ecost']=130; // Плащ легендарного героя
								$i['repcost']=81000; //реп

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;


								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold']=2600; //гос в золоте
								$i['getfrom']=$artinfo['getfrom'];

								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];



								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									if ($i['ecost']>0) { $i['ecost']=80; }
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Плащ легендарного рыцаря (мф) на Плащ легендарного героя (мф)");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0)
													{
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['bank_id']=$bank['id'];
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();
													}

													if ($bprice_gold>0)
														{
															//оплата в золоте
															mysql_query("UPDATE users SET `gold` = `gold` - '{$bprice_gold}' WHERE `id`= '{$us['id']}'  ") or die();
															$us['gold'] -= $bprice_gold;
															$rec = array();
												    			$rec['owner']=$us[id];
															$rec['owner_login']=$us[login];
															$rec['owner_balans_do']=$us['money'];
															$rec['owner_balans_posle']=($us['money']-$bprice_kr);
															$rec['target_login'] = "КО";
															$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
															$rec['item_name']=$i['name'];
															$rec['type'] = 2284;
															$rec['bank_id']=$bank['id'];
															$rec['sum_ekr']=$bprice;
															$rec['sum_kr']=$bprice_kr;
															$rec['bank_id']=$bank['id'];
															$rec['add_info'] = $us['gold'].'/'.$bprice_gold;
															$rec['add_info'].="/Старый предмет:".get_xitem_fid($artinfo);
															if (add_to_new_delo($rec) === FALSE) die();

														}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Плащ легендарного рыцаря ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
									else
									{
									echo "Error del old item";
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}

	}

if ($view==true)
	 {
	 /*
		- обмену подлежат модифицированные, уникальные или улучшенные уникальные Плащи легендарного рыцаря<br>
		- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
		- обычные плащи обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>

	 */
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[243][desc]."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
		- Обменять на Плащ легендарного героя (мф) можно только уникальные или улучшенные уникальные плащи.<br></p>
		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранный Вами уникальный или улучшенный уникальный Плащ легендарного героя с сохранением модификации</p>
		<br>
		<p><b style=\"color:#800000\"> Стоимость обмена Плаща легендарного рыцаря (мф) на Плащ легендарного героя (мф):</b><br>	";
//		".$PRICE[243][cost]." екр + ".$PRICE[243][cost_add_kr]." кр для обычного плаща<br>";

		if ($PRICE[243][cost_unik_gold]>0) { echo $PRICE[243][cost_unik_gold]." золотых монет для уникального или улучшенного уникального плаща<br><br></p>";}
		elseif ($PRICE[243][cost_unik_ekr]>0) { echo $PRICE[243][cost_unik_ekr]." екр. для уникального или улучшенного уникального плаща<br><br></p>";}

		echo "
		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table>

		</td></tr></table><br>";




		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span><span id="krnum" style="font-weight:bold;"></span><span id="goldnum" style="font-weight:bold;"></span><br>
											<span id="bankau">Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass></span><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда плащ, который хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[243][desc].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and (setsale = 0 and dressed = 0 and prototype=7005 and bs_owner=0 and stbonus=0 and unik>0 and (sowner=0 or sowner=owner) and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var goldnum="";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща легендарного рыцаря");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плащ легендарного рыцаря");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);
																	';

													if ($PRICE[243][cost_unik_gold]>0)
														{
														echo '
														if (itemproto >= 1) {
															goldnum = '.$PRICE[243][cost_unik_gold].';
															ekrnum="";
															krnum="";
														}
														else
															{
															goldnum="";
															ekrnum = '.$PRICE[243][cost].';
															krnum="+'.$PRICE[243][cost_add_kr].' кр";
															}
														';
														}
														else
														{
														echo '
														if (itemproto == 1) {
															ekrnum = '.$PRICE[243][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[243][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[243][cost].';
															krnum="+'.$PRICE[243][cost_add_kr].' кр";
															}
														';
														}

													echo '
															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML ="";
													document.getElementById("goldnum").innerHTML ="";
													document.getElementById("krnum").innerHTML ="";

													if (goldnum!="")
															{
															document.getElementById("goldnum").innerHTML = goldnum +" золотых монет";
															document.getElementById("bankau").style.display="none";
															}

													if (ekrnum!="") {
															document.getElementById("ekrnum").innerHTML = ekrnum + " екр.";
															document.getElementById("bankau").style.display="block";
													 		}

													if (krnum!="") document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей легендарного рыцаря';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}




function ShowChenge_cloack_legend_r2()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {

		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" AND  ((setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0  and (sowner=0 or sowner=owner) and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[230][cost];

			$useditems = "";
			$artid = 0;
			$artinfo = "";

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;

							if ($i['unik']==0)
							{
							$bprice = $PRICE[230][cost]; // 10 екр
							$bprice_kr = $PRICE[230][cost_add_kr]; //8000
							}
							elseif ($i['unik']==1)
							{
							$bprice = $PRICE[230][cost_unik_ekr];//80екр
							$bprice_kr = 0;
							}
							elseif ($i['unik']>=2)
							{
							$bprice = $PRICE[230][cost_unik_ekr];//80екр
							$bprice_kr = 0;
							}
					} else {
						die();
					}
			}


			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
							// если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}

							$q = mysql_query('START TRANSACTION') or die();
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and present!='Арендная лавка'  AND `prokat_idp`=0 AND arsenal_klan = '' and (setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) ) LIMIT 1;");

							 if (mysql_affected_rows()>0)
								{
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.shop where id=7005')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7001')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];
								$i['ecost']=$i['unikflag'];

								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = $artinfo['gold'];
								$i['getfrom']=$artinfo['getfrom'];


								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									$i['ecost']=floor($i['ecost'] / 2);
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Плащ рыцаря на Плащ легендарного рыцаря");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['bank_id']=$bank['id'];
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Плащ легендарного рыцаря ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
									else
									{
									echo "Error del old item";
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}

	}

if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[230][desc]."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
		- обмену подлежат модифицированные, уникальные или улучшенные уникальные Плащи Рыцаря<br>
		- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
		- обычные плащи обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>
		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		     выбранный Вами обычный, уникальный или улучшенный уникальный Плащ легендарного рыцаря с сохранением модификации</p>
		<br>
		<p><b style=\"color:#800000\">Стоимость обмена:</b><br>
		".$PRICE[230][cost]." екр + ".$PRICE[230][cost_add_kr]." кр для обычного плаща<br>
		".$PRICE[230][cost_unik_ekr]." екр. для уникального или улучшенного уникального плаща<br><br></p>

		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table>

		</td></tr></table><br>";




		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span> екр <span id="krnum" style="font-weight:bold;"></span><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Плащ рыцаря, который хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[230][desc].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and (setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща рыцаря");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плаща рыцаря");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


														if (itemproto == 1) {
															ekrnum = '.$PRICE[230][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[230][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[230][cost].';
															krnum="+'.$PRICE[230][cost_add_kr].' кр";
															}

															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML = ekrnum;
													document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей рыцаря';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}


function ShowChenge_fb_menu()
{
	global $user;
	global $PRICE;


		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Обмен футболок (мф)</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
	<p><b style=\"color:#800000\">Правила обмена футболок:</b><br>

     - обмену подлежат обычные модифицированные, уникальные или улучшенные уникальные Футболки ОлдБК, Футболки Учителей и Легендарные Футболки ОлдБК<br>
     - обмену подлежат только полностью отремонтированные вещи с распределенными параметрами, находящиеся в инвентаре и не надетые на персонаже<br>
     - обычные модифицированные футболки обмениваются на обычные модифицированные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>


      		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		выбранную Вами обычную модифицированную, уникальную или улучшенную уникальную Футболку Учителей, Легендарную футболку ОлдБК или Легендарную футболку Учителей с сохранением модификации
     		</p>
		<br>
		<p><b style=\"color:#800000\"> Стоимость обмена Футболки ОлдБК (мф) на Футболку Учителей (мф):</b><br>
		5 екр + 4000 кр для обычной модифицированной<br>
		40 екр. для уникальной или улучшенной уникальной<br><br></p>

		<p><b style=\"color:#800000\">  Стоимость обмена Футболки Учителей (мф) на Легендарную футболку ОлдБК (мф):</b><br>
		5 екр + 4000 кр для обычной модифицированной<br>
		40 екр. для уникальной или улучшенной уникальной<br>
		<br></p>

		<p><b style=\"color:#800000\">  Стоимость обмена Футболки ОлдБК (мф) на Легендарную футболку ОлдБК (мф):</b><br>
		10 екр + 8000 кр для обычной модифицированной<br>
		80 екр. для уникальной или улучшенной уникальной<br>
		<br></p>


		<p><b style=\"color:#800000\">  Стоимость обмена Легендарной футболки ОлдБК (мф) на Легендарную футболку Учителей (мф):</b><br>";

//		{$PRICE[233][cost]} екр + {$PRICE[233][cost_add_kr]} кр для обычной модифицированной<br>
echo "		{$PRICE[233][cost_unik_gold]} золотых монет для уникальной или улучшенной уникальной<br>
		<br></p>
		<p><b style=\"color:#800000\">  Стоимость обмена Футболки Учителей (мф) на Легендарную футболку Учителей (мф):</b><br>";

//		{$PRICE[234][cost]} екр + {$PRICE[234][cost_add_kr]} кр для обычной модифицированной<br>
echo "		{$PRICE[234][cost_unik_gold]} золотых монет для уникальной или улучшенной уникальной<br>
		<br></p>

		<p><b style=\"color:#800000\">  Стоимость обмена Футболки ОлдБК (мф) на Легендарную футболку Учителей (мф):</b><br>";

//		{$PRICE[235][cost]} екр + {$PRICE[235][cost_add_kr]} кр для обычной модифицированной<br>
echo "		{$PRICE[235][cost_unik_gold]} золотых монет для уникальной или улучшенной уникальной<br>
		<br></p>


	<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table>

		</td></tr></table><br>";


		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
echo "<center><strong>Варианты обмена:</strong></center><br><br>";

echo'<form method=post id="mainform" >
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">';


	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;

	$list=array(226,231,232,233,234,235);

	 foreach($list as $k=>$ii)
	{
		if ($PRICE[$ii][desc])
	      	{
		echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"><input OnClick="document.forms[0].submit();" name="services" value="'.$PRICE[$ii][desc].'" type="radio" class="tbl_inside"></td>';
		echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b></td><td width="150" align="center"><b>';
		echo "цена варьируется";
		echo '</b></td></tr>';
	      	if ($c==1) {$c=2;} else {$c=1;}
		}
	}

echo '
	<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"></td>
	<td ></td>
	<td width="150" align="center"></td></tr>
	</table><br><br><br>';

}


function ShowChenge_cloack_menu()
{
	global $user;
	global $PRICE;


		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Обмен Плащей (мф)</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
	<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
         - обмену подлежат обычные модифицированные, уникальные или улучшенные уникальные Плащи рыцаря, Плащи героя и Плащи легендарного рыцаря<br>
         - обмену подлежат только полностью отремонтированные вещи с распределенными параметрами, находящиеся в инвентаре и не надетые на персонаже<br>
         - обычные модифицированные плащи обмениваются на обычные модифицированные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>

      		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
         выбранный Вами обычный модифицированный, уникальный или улучшенный уникальную Плащ героя, Плащ легендарного рыцаря или Плащ легендарного героя с сохранением модификации</p>
		<br>

		<p><b style=\"color:#800000\"> Стоимость обмена Плаща рыцаря на Плащ Героя (или Плащ героя на Плащ легендарного рыцаря):</b><br>
		5 екр + 4000 кр для обычного плаща<br>
		40 екр. для уникального или  улучшенного уникального плаща<br>
		<br></p>

		<p><b style=\"color:#800000\">Стоимость обмена Плаща рыцаря (мф) на Плащ легендарного рыцаря (мф):</b><br>
		10 екр + 8000 кр для обычного плаща<br>
		80 екр. для уникального или улучшенного уникального  плаща<br>
		<br></p>


		<p><b style=\"color:#800000\">Стоимость обмена Плаща легендарного рыцаря (мф) на Плащ легендарного героя (мф):</b><br>";
//		{$PRICE[243][cost]} екр + {$PRICE[243][cost_add_kr]} кр для обычного плаща<br>
echo "		{$PRICE[243][cost_unik_gold]} золотых монет для уникального или  улучшенного уникального плаща<br>
		<br></p>

		<p><b style=\"color:#800000\">Стоимость обмена Плаща героя (мф) на Плащ легендарного героя (мф):</b><br>";
//	        {$PRICE[242][cost]} екр + {$PRICE[242][cost_add_kr]} кр для обычного плаща<br>
echo "        	{$PRICE[242][cost_unik_gold]} золотых монет для уникального или улучшенного уникального плаща<br>
		<br></p>

		<p><b style=\"color:#800000\">Стоимость обмена Плаща рыцаря (мф) на Плащ легендарного героя (мф):</b><br>";
//		{$PRICE[241][cost]} екр + {$PRICE[241][cost_add_kr]} кр для обычного плаща<br>
echo "		{$PRICE[241][cost_unik_gold]} золотых монет для уникального или улучшенного уникального плаща<br>
		<br></p>

		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table>

		</td></tr></table><br>";


		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
echo "<center><strong>Варианты обмена:</strong></center><br><br>";

echo'<form method=post id="mainform" >
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">';


	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;

	$list=array(224,229,230,241,242,243);

	 foreach($list as $k=>$ii)
	{
		if ($PRICE[$ii][desc])
	      	{
		echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"><input OnClick="document.forms[0].submit();" name="services" value="'.$PRICE[$ii][desc].'" type="radio" class="tbl_inside"></td>';
		echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b></td><td width="150" align="center"><b>';
		echo "цена варьируется";
		echo '</b></td></tr>';
	      	if ($c==1) {$c=2;} else {$c=1;}
		}
	}

echo '
	<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"></td>
	<td ></td>
	<td width="150" align="center"></td></tr>
	</table><br><br><br>';

}




function ShowChenge_cloack_hero()
{
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {

		$ids = (int)($_POST['mkecids']);

			$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" AND  ((setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0  and (sowner=0 or sowner=owner) and name like "%(мф)" ))) AND id='.$ids);

			$bprice = $PRICE[224][cost];

			$useditems = "";
			$artid = 0;
			$artinfo = "";

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

					if ($artid == 0) {
						$artid = $i['id'];
						$artinfo = $i;

							if ($i['unik']==0)
							{
							$bprice = $PRICE[224][cost];// 5 екр
							$bprice_kr = $PRICE[224][cost_add_kr]; //4000 кр
							}
							elseif ($i['unik']==1)
							{
							$bprice = $PRICE[224][cost_unik_ekr];// 40 екр
							$bprice_kr = 0;
							}
							elseif ($i['unik']>=2)
							{
							$bprice = $PRICE[224][cost_unik_ekr];//40 екр
							$bprice_kr = 0;
							}
					} else {
						die();
					}
			}


			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($us['money']<$bprice_kr)
					{
						serr("У Вас не достаточно кр для компенсации. Необходимая сумма ".$bprice_kr." кр.");
					}
				else
				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{

							//  если была картинка то снимаем
							if($artinfo[add_pick] != '')
							{
							undress_img($artinfo);
							}


							$q = mysql_query('START TRANSACTION') or die();
							//сносим старый

							mysql_query("DELETE from `oldbk`.`inventory` WHERE `id`='{$artinfo['id']}' and owner=".$us['id']." and present!='Арендная лавка'  AND `prokat_idp`=0 AND arsenal_klan = '' and (setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) ) LIMIT 1;");

							 if (mysql_affected_rows()>0)
								{
								$i = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7002')) or die();
								$prototype = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.eshop where id=7001')) or die();

								$mfinfo = array();

								$i['name'].=' (мф)';
								$i['cost']+=round($i['cost']/2);
								$i['ghp']+=$artinfo['ghp']-$prototype['ghp'];
								$i['unik']=$artinfo['unik'];
								$i['ecost']=$i['unikflag'];
								//если нет екоста то не переносим
								if (!($artinfo['ecost'] > 0)) $i['ecost'] = 0;
								$i['ekr_flag']=$artinfo['ekr_flag'];
								//если нет реп цены то 0 иначе из прото
								if (!($artinfo['repcost'] > 0)) $i['repcost'] = 0;
								$i['gold']=0;
								if ($artinfo['gold'] > 0) $i['gold'] = $artinfo['gold'];
								$i['getfrom']=$artinfo['getfrom'];
								$i['includerechargetype']=$artinfo['includerechargetype'];
								$i['includeprototype']=$artinfo['includeprototype'];

								$mfinfo['hp'] = $artinfo['ghp']-$prototype['ghp'];

								$i['present']=$artinfo['present'];

								if ($i['unik']==0)
									{
									$i['stbonus']=2;
									$mfinfo['stats'] = 2;
									$i['ecost']=floor($i['ecost'] / 2);
									}
								elseif ($i['unik']==1)
									{
									$i['stbonus']=3;
									$mfinfo['stats'] = 3;
									}
								elseif ($i['unik']>=2)
									{
									$i['stbonus']=4;
									$mfinfo['stats'] = 4;
									}

								$i['bron1']+=$artinfo['bron1']-$prototype['bron1'];
								$i['bron2']+=$artinfo['bron2']-$prototype['bron2'];
								$i['bron3']+=$artinfo['bron3']-$prototype['bron3'];
								$i['bron4']+=$artinfo['bron4']-$prototype['bron4'];

								if ($artinfo['bron1']-$prototype['bron1'] > 0) {
									$mfinfo['bron'] = $artinfo['bron1']-$prototype['bron1'];
								}
								if ($artinfo['bron2']-$prototype['bron2'] > 0) {
									$mfinfo['bron'] = $artinfo['bron2']-$prototype['bron2'];
								}
								if ($artinfo['bron3']-$prototype['bron3'] > 0) {
									$mfinfo['bron'] = $artinfo['bron3']-$prototype['bron3'];
								}
								if ($artinfo['bron4']-$prototype['bron4'] > 0) {
									$mfinfo['bron'] = $artinfo['bron4']-$prototype['bron4'];
								}




								$i['sowner']=$artinfo['sowner'];

								if ($artinfo['charka'] !='')
										{
										//перенос чарки
										$i['charka']=$artinfo['charka'];
														$charka=substr($i['charka'], 2,strlen($i['charka'])-1); //откидываем первые два символа
														$inputbonus=unserialize($charka); //все данные

														if (is_array($inputbonus))
															{
																ksort($inputbonus);
																foreach($inputbonus as $blevl => $bdata)
																	{
																			foreach($bdata as $pk => $pv)
																				{
																				foreach($pv as $k => $v)
																					{
																					$i[$k] +=$v;
																					}
																				}
																	}
															}
										}


								if (count($mfinfo)) {
									$mfinfo = mysql_real_escape_string(serialize($mfinfo));
								} else {
									$mfinfo = "";
								}


								//даем новый
								mysql_query("INSERT INTO oldbk.`inventory`
									(`getfrom`,`gold`,`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter` ".$str." , `ab_mf`,`ab_bron`,`ab_uron`, `present`, `includemagic`, `includemagicdex`, `includemagicmax`, `includemagicname`, `includemagicuses`,`includemagiccost` ,`includemagicekrcost`, `sowner` ,`sharped`, `repcost`,`stbonus`,`mfbonus`,`unik`,`charka`,`ekr_flag`,`mfinfo`,`includerechargetype`,`includeprototype`
									)
									VALUES
									('{$i['getfrom']}','{$i['gold']}','{$i['id']}','{$us['id']}','{$i['name']}','{$i['type']}',{$i['massa']},{$i['cost']},{$i['ecost']},'{$i['img']}',{$i['maxdur']},{$i['isrep']},'{$i['nclass']}','{$i['gsila']}','{$i['glovk']}','{$i['ginta']}','{$i['gintel']}','{$i['ghp']}','{$i['gnoj']}','{$i['gtopor']}','{$i['gdubina']}','{$i['gmech']}','{$i['gfire']}','{$i['gwater']}','{$i['gair']}','{$i['gearth']}','{$i['glight']}','{$i['ggray']}','{$i['gdark']}','{$i['needident']}','{$i['nsila']}','{$i['nlovk']}','{$i['ninta']}','{$i['nintel']}','{$i['nmudra']}','{$i['nvinos']}','{$i['nnoj']}','{$i['ntopor']}','{$i['ndubina']}','{$i['nmech']}','{$i['nfire']}','{$i['nwater']}','{$i['nair']}','{$i['nearth']}','{$i['nlight']}','{$i['ngray']}','{$i['ndark']}',
									'{$i['mfkrit']}','{$i['mfakrit']}','{$i['mfuvorot']}','{$i['mfauvorot']}','{$i['bron1']}','{$i['bron2']}','{$i['bron3']}','{$i['bron4']}','{$i['maxu']}','{$i['minu']}','{$i['magic']}','{$i['nlevel']}',
									'{$i['nalign']}','".(($i['goden'])?($i['goden']*24*60*60+time()):"")."','{$i['goden']}'
									,'{$i['razdel']}','{$i['gmp']}','{$i['gmeshok']}','{$i['group']}','{$i['letter']}' ".$sql." ,'{$i['ab_mf']}','{$i['ab_bron']}','{$i['ab_uron']}',
									'{$i['present']}','{$i['includemagic']}','{$i['includemagicdex']}','{$i['includemagicmax']}','{$i['includemagicname']}','{$i['includemagicuses']}','{$i['includemagiccost']}','{$i['includemagicekrcost']}','{$i['sowner']}','{$i['sharped']}','{$i['repcost']}','{$i['stbonus']}','{$i['mfbonus']}','{$i['unik']}','{$i['charka']}','{$i['ekr_flag']}','{$mfinfo}','{$i['includerechargetype']}','{$i['includeprototype']}'
									) ;") or die();

									$i['id']=mysql_insert_id();

													serr("Вы удачно обменяли Плащ рыцаря на Плащ героя");


													if ($bprice_kr > 0)
														{
														mysql_query("UPDATE users SET `money` = `money` - '{$bprice_kr}' WHERE `id`= '{$us['id']}'  ") or die();
														}

													if ($bprice > 0) {
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank_was_ekr=$bank['ekr'];
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}

														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=($us['money']-$bprice_kr);
														$rec['target_login'] = "КО";
														$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => $i['id'] ));
														$rec['item_name']=$i['name'];
														$rec['type'] = 2283;
														$rec['bank_id']=$bank['id'];
														$rec['sum_ekr']=$bprice;
														$rec['sum_kr']=$bprice_kr;
														$rec['bank_id']=$bank['id'];
														$rec['add_info']='Баланс до '.$bank_was_ekr. 'екр. после ' .$bank[ekr].'екр. ';
														$rec['add_info'].="Старый предмет:".get_xitem_fid($artinfo);
														if (add_to_new_delo($rec) === FALSE) die();

													}


													// пишем в ком отдел
													$m = '"'.$us['login'].'" обмен "'.$artinfo['name'].'" ('.get_xitem_fid(array("idcity" => $artinfo['idcity'], "id" => $artinfo['id'])).') за '.$bprice.' екр. на Плащ героя ('.$rec['item_id'].')';
													mysql_query('INSERT INTO oldbk.`com_logs` (time,type,text) VALUES ("'.time().'","2","'.mysql_real_escape_string($m).'") ') or die();

													systemtotelo($us,"Успешно выдан ".$i['name']);
													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
									}
									else
									{
									echo "Error del old item";
									}
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

		}

	}

if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[224][desc]."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\">

		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">Правила обмена плащей:</b><br>
		- обмену подлежат модифицированные, уникальные или улучшенные уникальные Плащи Рыцаря<br>
		- обмену подлежат только полностью отремонтированные вещи с раскинутыми статами, находящиеся в инвентаре и не надетые на персонаже<br>
		- обычные плащи обмениваются на обычные, уникальные обмениваются на уникальные, улучшенные уникальные на улучшенные уникальные<br></p>

		<br>
		<p><b style=\"color:#800000\">При обмене вы получаете:</b><br>
		 выбранный Вами обычный, уникальный или улучшенный уникальный Плащ Героя с сохранением модификации</p>
		<br>
		<p><b style=\"color:#800000\">Стоимость обмена:</b><br>
		".$PRICE[224][cost]." екр + ".$PRICE[224][cost_add_kr]." кр для обычного плаща<br>
		".$PRICE[224][cost_unik_ekr]." екр. для уникального или улучшенного уникального плаща<br><br></p>

		<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table>

		</td></tr></table><br>";




		echo "<br>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<style>
											#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
											</style>
											<center>
											К оплате сумма:<span id="ekrnum" style="font-weight:bold;">0</span> екр <span id="krnum" style="font-weight:bold;"></span><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<font color=red>Отображаются плащи только со всеми разбросанными статами!</font>

											<div id="allconstr">
												<div id="snaptarget">
												Переместите сюда Плащ рыцаря, который хотите обменять
												</div><br><input type="hidden" id="mkecids" name="mkecids" value="">
												<input type="hidden" id="services" name="services" value="'.$PRICE[224][desc].'"><br>
											';
											$ids = array();

											$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND present!="Арендная лавка"  AND `prokat_idp`=0 AND arsenal_klan = "" and (setsale = 0 and dressed = 0 and prototype in (5101,7001) and bs_owner=0 and stbonus=0 and (sowner=0 or sowner=owner) and name like "%(мф)" ) ORDER BY ecost DESC');


											if (mysql_num_rows($q) > 0) {
												while($i = mysql_fetch_assoc($q)) {
													$ids[] = $i['id'];
													if ($i['prototype'] >0)
													{
														echo '<span name="prot'.$i['unik'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img src=https://i.oldbk.com/i/sh/'.$i['img'].'  onMouseOut="HideThing(this)" onMouseOver="ShowThing(this,35,25,\''.showiteme($i,true).'\')"></span> ';
													}
												}
												echo '
												<script>
												var spans = [];
												var ekrnum = 0;
												var krnum = "";
												var artnum = 0;

												function CheckF() {
													if (spans.length == 0) {
														alert("Вы ничего не положили");
														return;
													}

													if (artnum < 1) {
														alert("Вы не положили ни одного Плаща рыцаря");
														return;
													}

													if (artnum > 1) {
														alert("За раз можно только один Плаща рыцаря");
														return;
													}

													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}

												$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
												$("#allconstr span" ).bind( "dragstop", function(event, ui) {
													spans.splice(0,spans.length);


													$("#allconstr span").each(function(index,item){
														m = $("#allconstr").offset().top;

														if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
															spans.push(item);
														}
													});

										                        artnum = 0;

													var ids = new Array();

													for (key in spans) {
														var n = spans[key];
														itemid = n.id;
														itemid = itemid.substring(4);
														itemproto = $("#"+n.id).attr("name");
														itemproto = itemproto.substr(4);
														ids.push(itemid);


														if (itemproto == 1) {
															ekrnum = '.$PRICE[224][cost_unik_ekr].';
															krnum="";
														} else if (itemproto >= 2) {
															ekrnum = '.$PRICE[224][cost_unik_ekr].';
															krnum="";
														}
														else
															{
															ekrnum = '.$PRICE[224][cost].';
															krnum="+'.$PRICE[224][cost_add_kr].' кр";
															}

															artnum++;

													}
													document.getElementById("mkecids").value = ids.join();
													document.getElementById("ekrnum").innerHTML = ekrnum;
													document.getElementById("krnum").innerHTML = krnum;

												});
												</script>';
											} else {
												echo 'У Вас нет подходящих Плащей рыцаря';
											}
											echo '</div></center></div>';
											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center></form>';

					}
	}
}



function ShowResetEmail() {
	global $user;
	global $PRICE;

$us = check_users_city_datal($user);
$view=true;

	if (isset($_POST['mkecids'])) {


			$bprice = $PRICE[214][cost];
			$useditems = "";

			$good = true;

			$upfilename = "";
			$mess_time = time();
			/*
			if (isset($_FILES['upfile'])) {
				if ($_FILES['upfile']['error'] == UPLOAD_ERR_OK) {
					$imageinfo = @getimagesize($_FILES['upfile']['tmp_name']);
					if ($imageinfo !== FALSE && ($imageinfo[2] == IMAGETYPE_GIF || $imageinfo[2] == IMAGETYPE_PNG || $imageinfo[2] == IMAGETYPE_JPEG || $imageinfo[2] == IMAGETYPE_BMP)) {
						if($_FILES['upfile']['size'] <= 3*1024*1024) {
							if ($imageinfo[2] == IMAGETYPE_GIF) $ext = "gif";
							if ($imageinfo[2] == IMAGETYPE_PNG) $ext = "png";
							if ($imageinfo[2] == IMAGETYPE_JPEG) $ext = "jpeg";
							if ($imageinfo[2] == IMAGETYPE_BMP) $ext = "bmp";

							$upfilename = './uploadscan/'.md5($mess_time.$us['id'])."_".$us['id']."_1.".$ext;

							if (move_uploaded_file($_FILES['upfile']['tmp_name'],$upfilename)) {
								$good = true;
							}
						} else {
							serr('Размер файла превышаем 3МБ');
						}
					} else {
						serr('Загружен неверный формат');
					}
				} else {
					serr('Ошибка загрузки файла');
				}
			}
			*/

			if ($good) {
				if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
												// всё ок - начинаем

												serr("Вы удачно оплатили смену емейла");

												$q = mysql_query('START TRANSACTION') or die();

												//оплата
													$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
													if (!(mysql_num_rows($get_bank) > 0) )
													{
													die();
													}
													else
													{
													$bank = mysql_fetch_assoc($get_bank);

													mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
													//  пишем в хистори банка
													$bank['ekr']-=$bprice;
													mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
													}


												$rec = array();
									    			$rec['owner']=$us[id];
												$rec['owner_login']=$us[login];
												$rec['owner_balans_do']=$us['money'];
												$rec['owner_balans_posle']=$us['money'];
												$rec['owner_rep_do']=$us['repmoney'];
												$rec['target_login'] = "КО";
												$rec['owner_rep_posle']=$us['repmoney'];
												$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
												$rec['type'] = 2282;
												$rec['sum_ekr']=$bprice;
												$rec['bank_id']=$bank['id'];
												if (add_to_new_delo($rec) === FALSE) die();


												// пишем в ком отдел
												$now=date("d.m.y H:i",time());
												$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`addinfo`,`ip`,`bank_id`) VALUES ('".$mess_time."','".$user."', 'Смена емейла персонажа', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".serialize(array($_POST['oldemail'],$_POST['newemail']))."','".ip2long(REMIP)."','{$bank['id']}');";
												mysql_query($query) or die();


												// всё ок, закончили
												$q = mysql_query('COMMIT') or die();
												serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");
												echo "
												<br>
												<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
												</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
												</div>
											        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
												echo "</td></tr>";
												$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}

				}
			} else {
				serr("Ошибка загрузки скана пасспорта");
			}

	}
if ($view==true)
 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СМЕНА ЕМЕЙЛА ПЕРСОНАЖА</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

								echo '<form id="mkec" method="POST" ><br><center>';
								/*
								echo '
						                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
								<center>Загрузите скан паспорта: <input type="file" id="upfile" name="upfile" class="button2" style="background-color:white;color:black;width:500px;"><br>
								<b>(не более 3МБ, формат jpeg/gif/bmp/png)</b><br><br>';
								*/
								echo 'Старый емейл: <input type="text" id="oldemail" name="oldemail"> Новый емейл: <input id="newemail" type="text" name="newemail">
								<BR><BR>
								К оплате сумма: '.$PRICE[214][cost].' екр.<br><br>
								Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
									<br><input type="hidden" id="mkecids" name="mkecids" value="Yes">
									<input type="hidden" id="services" name="services" value="Смена емейла персонажа"><br>
								';
								echo '<input  id="upsubmit" type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
								echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>';
								/*echo '
								<script>
									$("#upfile").bind("change", function() {
						            			var size = this.files[0].size/1024/1024;
										if (size > 3) {
											alert("Размер изображения не должен превышать 3 MB")
											$("#upsubmit").attr("disabled", "disabled");
										} else {
											$("#upsubmit").removeAttr("disabled");
										}
						        		});
								</script>'; */

								echo '<style>
								input[type="button"][disabled] {
					   				color: gray;
								}
								</style>

										';

					}
  }
}


function ShowPayTravm() {
	global $user;
	global $PRICE;

	$view=true;

	if (isset($_POST['mkecids'])) {
			$us = check_users_city_datal($user);

			$bprice = (int)($_POST['pencost']);
			$useditems = "";

			$mess_time = time();

					if ( (($us['gold']) < $bprice)  and ($bprice>0))
						{
							serr("Недостаточно монет! Выберите другую сумму или пополните счет.");
						} elseif ($bprice>0)
						{
											// всё ок - начинаем
											serr("Вы удачно оплатили штраф.");

											$q = mysql_query('START TRANSACTION') or die();

											//оплата
											$u=mysql_query("SELECT * FROM oldbk.`users` WHERE `id`= '".$us['id']."' AND gold>='".$bprice."'  FOR UPDATE ;");
											if (!(mysql_num_rows($u) > 0) )
											{
											die();
											}
											else
											{
											$ua = mysql_fetch_assoc($u);

											mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - '{$bprice}' WHERE `id`= '{$us['id']}' ");
											//  пишем в хистори банка
											$us['gold']-=$bprice;

											$rec = array();

											$rec['owner']=$us[id];
											$rec['owner_login']=$us[login];
											$rec['owner_balans_do']=$us[money];
											$rec['owner_balans_posle']=$us[money];
											$rec['target']=0;
											$rec['target_login']='КО';
											$rec['type']=577;
											$rec['sum_kr']=0;
											$rec['sum_ekr']=0;
											$rec['sum_kom']=0;
											$rec['add_info'] = $bprice."/".($us['gold']-$bprice);

											if (add_to_new_delo($rec) === FALSE) die();

											// пишем в ком отдел
											$now=date("d.m.y H:i",time());
											$_SESSION['mkecadd']['comment'].=". Оплатил: ".$bprice." монет";
											$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`) VALUES ('".$mess_time."','".$user."', '".$PRICE[227]['desc']."', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."');";
											mysql_query($query) or die();


											// всё ок, закончили
											$q = mysql_query('COMMIT') or die();
											serr("Заявка будет рассмотрена в ближайшие время.");
											echo "
											<br>
											<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
											</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
											</div>
										        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
											echo "</td></tr>";
											$view=false;
											}
							}
							else
							{
							serr("Ошибка суммы!");
							}



	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[228]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>
		<div align=center>";
				$us = check_users_city_datal($user);
				$get_travma=mysql_query("select * from effects where type=14 and owner='{$us['id']}' ");
				if (mysql_num_rows($get_travma) > 0)
				{
					$RUR=get_rur_curs();
					echo "Сумма к оплате: <strong>".$PRICE[228][cost]."$ </strong>  = ".round($PRICE[228][cost]*$RUR,2)." руб." ;
					print_paysyst();
				}
				else
				{
					echo "У Вас нет такой травмы!";
				}
		echo "</div>";

	}
}


function print_paysyst()
{
		echo '<p><b><font color="red">Выберите способ оплаты: </font></b></p>';
		echo "<fieldset style=\"text-align:justify; width:500px; height:180;\">";
		echo "<div align=center>";

		echo "<table border=0 cellspacing=5 cellpadding=0> <tr>";
		echo "<td>";

		echo "<a href=\"#\" onClick=\"getformdata(45,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_yandex.gif title='Оплатить с помощью системы \"Yandex Деньги\"' >";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(37,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_wmr.gif title='Оплатить с помощью WMR' ></a>"; // наш
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(38,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_wmz.gif title='Оплатить с помощью WMZ' ></a>"; // наш
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(46,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_qiwi.gif title='Оплатить с помощью \"QIWI - кошелек\"' ></a>";
		echo "</td></tr><tr><td>";

		echo "<a href=\"#\" onClick=\"getformdata(41,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_mts.gif title='Оплатить с помощью \"МТС\"' ></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(42,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_tele2.gif title='Оплатить с помощью \"Tele2\"'></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(43,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_beeline.gif title='Оплатить с помощью \"Beeline\"' ></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(44,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_megafon.gif title='Оплатить с помощью \"Мегафон\"' ></a>";
		echo "</td></tr><tr><td>";


		echo "<a href=\"#\" onClick=\"getformdata(47,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_aclick.gif title='Оплатить с помощью \"Альфа-Клик\"' ></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(48,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_sberbank.gif title='Оплатить с помощью \"Сбербанк\"' ></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(39,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_visa_k.gif title='Оплатить с помощью \"Банковская карта\"' ></a>";	//LiqPay
		echo "</td><td>";

		echo "<a href=\"#\" onClick=\"getformdata(54,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_promsvyazbank.gif title='Оплатить с помощью \"Промсвязьбанк\"' ></a>";
		echo "</td></tr><tr><td>";

		echo "<a href=\"#\" onClick=\"getformdata(51,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_bitcoin.gif title='Оплатить с помощью \"Bitcoin\"' ></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(52,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_moneypolo.gif title='Оплатить с помощью системы \"Money Polo\"' ></a>";
		echo "</td><td>";
		echo "<a href=\"#\" onClick=\"getformdata(53,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_w1.gif title='Оплатить с помощью \"W1\"' ></a>";
		echo "</td><td>";
//		echo "<a href=\"#\" onClick=\"getformdata(23,1001,event);\"><img src=https://i.oldbk.com/i/bank/knopka_paypal.gif title='Оплатить с помощью системы \"PayPal\"' ></a>";
		echo "</td></tr></table>";

		echo "</div>";
		echo "</fieldset>";

}

function ShowPayPenalty() {
	global $user;
	global $PRICE;

	$view=true;

	if (isset($_POST['mkecids'])) {
			$us = check_users_city_datal($user);

			$bprice = (int)($_POST['pencost']);
			$useditems = "";

			$mess_time = time();

					if ( (($us['gold']) < $bprice)  and ($bprice>0))
						{
							serr("Недостаточно монет! Выберите другую сумму или пополните счет.");
						} elseif ($bprice>0)
						{
											// всё ок - начинаем
											serr("Вы удачно оплатили штраф.");

											$q = mysql_query('START TRANSACTION') or die();

											//оплата
											$u=mysql_query("SELECT * FROM oldbk.`users` WHERE `id`= '".$us['id']."' AND gold>='".$bprice."'  FOR UPDATE ;");
											if (!(mysql_num_rows($u) > 0) )
											{
											die();
											}
											else
											{
											$ua = mysql_fetch_assoc($u);

											mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - '{$bprice}' WHERE `id`= '{$us['id']}' ");
											//  пишем в хистори банка
											$us['gold']-=$bprice;

											$rec = array();

											$rec['owner']=$us[id];
											$rec['owner_login']=$us[login];
											$rec['owner_balans_do']=$us[money];
											$rec['owner_balans_posle']=$us[money];
											$rec['target']=0;
											$rec['target_login']='КО';
											$rec['type']=577;
											$rec['sum_kr']=0;
											$rec['sum_ekr']=0;
											$rec['sum_kom']=0;
											$rec['add_info'] = $bprice."/".($us['gold']-$bprice);

											if (add_to_new_delo($rec) === FALSE) die();

											// пишем в ком отдел
											$now=date("d.m.y H:i",time());
											$_SESSION['mkecadd']['comment'].=". Оплатил: ".$bprice." монет";
											$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`) VALUES ('".$mess_time."','".$user."', '".$PRICE[227]['desc']."', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."');";
											mysql_query($query) or die();


											// всё ок, закончили
											$q = mysql_query('COMMIT') or die();
											serr("Заявка будет рассмотрена в ближайшие время.");
											echo "
											<br>
											<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
											</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
											</div>
										        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
											echo "</td></tr>";
											$view=false;
											}
							}
							else
							{
							serr("Ошибка суммы!");
							}



	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">".$PRICE[227]['desc']."</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">

		После оплаты штрафа ваша заявка передается на рассмотрение и будет обработана в течение 3 рабочих дней. Уточнить сумму штрафа необходимо заранее через <a href=https://oldbk.com/commerce/index.php?act=sendmess>обратную связь</a> Коммерческого отдела.


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$us = check_users_city_datal($user);


								echo '<form id="mkec" method="POST" ><br>';
											echo '<center>
											<br>
											У Вас в наличии: <strong>'.$us['gold'].'</strong> монет<br><br>
											Введите сумму штрафа в монетах:<input type="text"  name="pencost" value="0" size=7><br>
											<input type="hidden" id="mkecids" name="mkecids" value="Yes">
											<input type="hidden" id="services" name="services" value="'.$PRICE[227][desc].'"><br>
											';
										echo '<br><input  id="upsubmit" type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>';


										echo '<style>
										input[type="button"][disabled] {
							   				color: gray;
										}
										</style>

										';

	}
}


function ShowResetSecond() {
	global $user;
	global $PRICE;

$view=true;

$bprice = $PRICE[203][cost];

	if (isset($_POST['mkecids'])) {


			$us = check_users_city_datal($user);


			$useditems = "";

			$good = true;
			$upfilename = "";
			$mess_time = time();
			/*
			if (isset($_FILES['upfile'])) {
				if ($_FILES['upfile']['error'] == UPLOAD_ERR_OK) {
					$imageinfo = @getimagesize($_FILES['upfile']['tmp_name']);
					if ($imageinfo !== FALSE && ($imageinfo[2] == IMAGETYPE_GIF || $imageinfo[2] == IMAGETYPE_PNG || $imageinfo[2] == IMAGETYPE_JPEG || $imageinfo[2] == IMAGETYPE_BMP)) {
						if($_FILES['upfile']['size'] <= 3*1024*1024) {
							if ($imageinfo[2] == IMAGETYPE_GIF) $ext = "gif";
							if ($imageinfo[2] == IMAGETYPE_PNG) $ext = "png";
							if ($imageinfo[2] == IMAGETYPE_JPEG) $ext = "jpeg";
							if ($imageinfo[2] == IMAGETYPE_BMP) $ext = "bmp";

							$upfilename = './uploadscan/'.md5($mess_time.$us['id'])."_".$us['id'].".".$ext;

							if (move_uploaded_file($_FILES['upfile']['tmp_name'],$upfilename)) {
								$good = true;
							}
						} else {
							serr('Размер файла превышаем 3МБ');
						}
					} else {
						serr('Загружен неверный формат');
					}
				} else {
					serr('Ошибка загрузки файла');
				}
			}
			*/

			if ($good) {
			if ((($_POST['bankpass']=='') OR ($_POST['bankid']=='') ) and ($bprice>0) )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{

				if ($bprice==0)
				{

				// бесплатно и автоматом



											$q = mysql_query('START TRANSACTION') or die();

											if (mysql_query("UPDATE oldbk.`users` SET second_password = '' WHERE id = '{$us['id']}'  limit 1"))
											{
											$now=date("d.m.y H:i",time());
											$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`bank_id`,`status`) VALUES ('".$mess_time."','".$user."', 'Сброс второго пароля персонажа', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Бесплатно','".ip2long(REMIP)."','0','Сделано ".$now." (авто)');";
											mysql_query($query) or die();

											// всё ок, закончили
											$q = mysql_query('COMMIT') or die();
											serr("Второй пароль удален!");
											echo "
											<br>
											<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
											</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
											</div>
										        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
											echo "</td></tr>";
											$view=false;
											}


				}
				else
				{
				//платно и через модерацию
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем
											serr("Вы удачно оплатили сброс второго пароля");

											$q = mysql_query('START TRANSACTION') or die();

											//оплата
											$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
											if (!(mysql_num_rows($get_bank) > 0) )
											{
											die();
											}
											else
											{
											$bank = mysql_fetch_assoc($get_bank);

											mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
											//  пишем в хистори банка
											$bank['ekr']-=$bprice;
											mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
											}

											$rec = array();
								    			$rec['owner']=$us[id];
											$rec['owner_login']=$us[login];
											$rec['owner_balans_do']=$us['money'];
											$rec['owner_balans_posle']=$us['money'];
											$rec['owner_rep_do']=$us['repmoney'];
											$rec['target_login'] = "КО";
											$rec['owner_rep_posle']=$us['repmoney'];
											$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
											$rec['type'] = 2282;
											$rec['sum_ekr']=$bprice;
											$rec['bank_id']=$bank['id'];
											if (add_to_new_delo($rec) === FALSE) die();




											// пишем в ком отдел
											$now=date("d.m.y H:i",time());
											$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`bank_id`) VALUES ('".$mess_time."','".$user."', 'Сброс второго пароля персонажа', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','{$bank['id']}');";
											mysql_query($query) or die();


											// всё ок, закончили
											$q = mysql_query('COMMIT') or die();
											serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");
											echo "
											<br>
											<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
											</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
											</div>
										        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
											echo "</td></tr>";
											$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
				}
			}
			} else {
				serr("Ошибка загрузки скана пасспорта");
			}

	}


if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СБРОС ВТОРОГО ПАРОЛЯ ПЕРСОНАЖА!</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$us = check_users_city_datal($user);

					if ($bprice==0)
					{
										echo '<form id="mkec" method="POST" ><br>';
										echo '<center><br><input  id="upsubmit" type="button" value="Сброс второго пароля" class="button2"  OnClick="CheckF();"></center>
										<input type="hidden" id="services" name="services" value="Сброс второго пароля персонажа">
										<input type="hidden" id="mkecids" name="mkecids" value="Yes"><br>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>';
					}
					else
					{
						$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
						if (!(mysql_num_rows($get_bank) > 0) )
							{
							echo '<font color=red>У вас нет доступных банковских счетов!</font>';
							}
						else
						{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

								echo '<form id="mkec" method="POST" ><br>';
											/*
											echo '
									                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
											<center>Загрузите скан паспорта: <input id="upfile" type="file" name="upfile" class="button2" style="background-color:white;color:black;width:500px;"><br>
											<b>(не более 3МБ, формат jpeg/gif/bmp/png)</b></center><br><br>';
											*/
											echo '<center>
											К оплате сумма: '.$PRICE[203][cost].' екр.<br><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<input type="hidden" id="mkecids" name="mkecids" value="Yes">
											<input type="hidden" id="services" name="services" value="Сброс второго пароля персонажа"><br>
											';
										echo '<br><input  id="upsubmit" type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>';

										/*echo '<script>
											$("#upfile").bind("change", function() {
								            			var size = this.files[0].size/1024/1024;
												if (size > 3) {
													alert("Размер изображения не должен превышать 3 MB")
													$("#upsubmit").attr("disabled", "disabled");
												} else {
													$("#upsubmit").removeAttr("disabled");
												}
								        		});
										</script>';
										*/

										echo '<style>
										input[type="button"][disabled] {
							   				color: gray;
										}
										</style>

										';
						}
					}
	}
}


function ShowChangeSex() {
	global $user;
	global $PRICE;


$view=true;
	if (isset($_POST['mkecids'])) {

			$us = check_users_city_datal($user);

			$bprice = $PRICE[204][cost];
			$useditems = "";
			$good = true;


			if ($good) {
			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем

											serr("Вы удачно оплатили смену пола персонажа");

											$q = mysql_query('START TRANSACTION') or die();

											//оплата
											$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
											if (!(mysql_num_rows($get_bank) > 0) )
											{
											die();
											}
											else
											{
											$bank = mysql_fetch_assoc($get_bank);

											mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
											//  пишем в хистори банка
											$bank['ekr']-=$bprice;
											mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
											}


												$rec = array();
									    			$rec['owner']=$us[id];
												$rec['owner_login']=$us[login];
												$rec['owner_balans_do']=$us['money'];
												$rec['owner_balans_posle']=$us['money'];
												$rec['owner_rep_do']=$us['repmoney'];
												$rec['target_login'] = "КО";
												$rec['owner_rep_posle']=$us['repmoney'];
												$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
												$rec['type'] = 2282;
												$rec['sum_ekr']=$bprice;
												$rec['bank_id']=$bank['id'];
												if (add_to_new_delo($rec) === FALSE) die();




												// пишем в ком отдел
												$now=date("d.m.y H:i",time());
												$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`bank_id`) VALUES ('".$mess_time."','".$user."', 'Смена пола персонажа', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','{$bank['id']}');";
												mysql_query($query) or die();


												// всё ок, закончили
												$q = mysql_query('COMMIT') or die();
												serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");

												echo "
												<br>
												<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
												</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
												</div>
											        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
												echo "</td></tr>";
												$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
			}
		}
	}

if ($view==true)
	{
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СМЕНА ПОЛА ПЕРСОНАЖА</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
					$us = check_users_city_datal($user);
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";
										echo '
								                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
										<center>
											К оплате сумма: '.$PRICE[204][cost].' екр.<br><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<input type="hidden" id="mkecids" name="mkecids" value="Yes">
											<input type="hidden" id="services" name="services" value="Смена пола персонажа"><br>
										';
										echo '<br><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>
										';
					}
	}
}


function ShowResetBD() {
	global $user;
	global $PRICE;


$view=true;
	if (isset($_POST['mkecids'])) {

			$us = check_users_city_datal($user);

			$bprice = $PRICE[201][cost];
			$useditems = "";
			$good = false;
			$upfilename = "";
			$mess_time = time();
			if (isset($_FILES['upfile'])) {
				if ($_FILES['upfile']['error'] == UPLOAD_ERR_OK) {
					$imageinfo = @getimagesize($_FILES['upfile']['tmp_name']);
					if ($imageinfo !== FALSE && ($imageinfo[2] == IMAGETYPE_GIF || $imageinfo[2] == IMAGETYPE_PNG || $imageinfo[2] == IMAGETYPE_JPEG || $imageinfo[2] == IMAGETYPE_BMP)) {
						if($_FILES['upfile']['size'] <= 3*1024*1024) {
							if ($imageinfo[2] == IMAGETYPE_GIF) $ext = "gif";
							if ($imageinfo[2] == IMAGETYPE_PNG) $ext = "png";
							if ($imageinfo[2] == IMAGETYPE_JPEG) $ext = "jpeg";
							if ($imageinfo[2] == IMAGETYPE_BMP) $ext = "bmp";

							$upfilename = './uploadscan/'.md5($mess_time.$us['id'])."_".$us['id'].".".$ext;

							if (move_uploaded_file($_FILES['upfile']['tmp_name'],$upfilename)) {
								$good = true;
							}
						} else {
							serr('Размер файла превышаем 3МБ');
						}
					} else {
						serr('Загружен неверный формат');
					}
				} else {
					serr('Ошибка загрузки файла');
				}
			}


			if ($good) {

			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем

										serr("Вы удачно оплатили смену ДР персонажа");

										$q = mysql_query('START TRANSACTION') or die();

											//  оплата
											$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
											if (!(mysql_num_rows($get_bank) > 0) )
											{
											die();
											}
											else
											{
											$bank = mysql_fetch_assoc($get_bank);

											mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
											//  пишем в хистори банка
											$bank['ekr']-=$bprice;
											mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
											}


										$rec = array();
							    			$rec['owner']=$us[id];
										$rec['owner_login']=$us[login];
										$rec['owner_balans_do']=$us['money'];
										$rec['owner_balans_posle']=$us['money'];
										$rec['owner_rep_do']=$us['repmoney'];
										$rec['target_login'] = "КО";
										$rec['owner_rep_posle']=$us['repmoney'];
										$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
										$rec['type'] = 2282;
										$rec['sum_ekr']=$bprice;
										$rec['bank_id']=$bank['id'];
										if (add_to_new_delo($rec) === FALSE) die();


										// пишем в ком отдел
										$now=date("d.m.y H:i",time());
										$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`addinfo`,`bank_id`) VALUES ('".$mess_time."','".$user."', 'Смена даты рождения персонажа', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','".$_POST['newbd']."','{$bank['id']}');";
										mysql_query($query) or die();

										// всё ок, закончили
										$q = mysql_query('COMMIT') or die();
										serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");
										echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

										echo "</td></tr>";
										$view=false;
						}
					}
						else
						{
						serr('Ошибка! Не верный пароль от банковского счета!');
						}
				}
			} else {
				serr("Ошибка загрузки скана пасспорта");
			}

		}
	if ($view==true)
	{
		$_SESSION['mkecadd'] = $_POST;
		$us = check_users_city_datal($user);
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">СМЕНА ДАТЫ РОЖДЕНИЯ ПЕРСОНАЖА</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
	$us = check_users_city_datal($user);
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";
										echo '
								                <form id="mkec" method="POST" enctype="multipart/form-data"><br>
										<center>Загрузите скан паспорта: <input id="upfile" type="file" name="upfile" class="button2" style="background-color:white;color:black;width:500px;"><br>
										<b>(не более 3МБ, формат jpeg/gif/bmp/png)</b><br><br>
										Выставьте новый ДР персонажа: <input id="calendar-inputField1" size=9 readonly=true type="text" value="'.$us['borndate'].'" name="newbd"> <input type=button id="calendar-trigger1" value=\'...\'><br><br>
										<script>
										var cal = Calendar.setup({
											onSelect   : function() { this.hide() }
										});
										cal.manageFields("calendar-trigger1", "calendar-inputField1", "%d-%m-%Y");
										</script>
										<br>
										</center>

										<center>
											К оплате сумма: '.$PRICE[201][cost].' екр.<br><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
											<br><input type="hidden" id="mkecids" name="mkecids" value="Yes">
											<input type="hidden" id="services" name="services" value="Смена даты рождения персонажа"><br>
										';
										echo '<input disabled="disabled" id="upsubmit" type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
										echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>

										<script>
											$("#upfile").bind("change", function() {
								            			var size = this.files[0].size/1024/1024;
												if (size > 3) {
													alert("Размер изображения не должен превышать 3 MB")
													$("#upsubmit").attr("disabled", "disabled");
												} else {
													$("#upsubmit").removeAttr("disabled");
												}
								        		});
										</script>
										<style>
										input[type="button"][disabled] {
							   				color: gray;
										}
										</style>

										';
					}
	}
}

function ShowResetWMZ()
{
	global $user;
	global $PRICE;
	$us = check_users_city_datal($user);


	/////////QIWI
	if (isset($_POST[qiwimkbill]))
	{
	$qiwi_to=(int)($_POST[to]);
	$qiwi_ekr=25;
	$RUR=get_rur_curs();
	$am_rub=round($qiwi_ekr*$RUR);



			if (($qiwi_to > 0) AND ($am_rub>0))
			{

			//создаем счет в базе для киви
			mysql_query("INSERT INTO `oldbk`.`trader_balance_qiwi` SET `owner`='{$us[login]}',`owner_id`='{$us[id]}', `param`=222,`sum_ekr`='{$qiwi_ekr}',`sum_rub`='{$am_rub}',`qiwi`='{$qiwi_to}';");
				 if (mysql_affected_rows()>0)
				{

				 $txn_id=mysql_insert_id();
				$linkqiwi="http://w.qiwi.ru/setInetBill.do?frm=1&from=6920&lifetime=0.0&check_agt=false&com=".urlencode("Оплата услуг oldbk.com для персонажа {$us['login']} на {$qiwi_ekr} екр.")."&to={$qiwi_to}&txn_id={$txn_id}&amount_rub={$am_rub}";
					$f=@fopen($linkqiwi,"r");
						if($f)
						{
						fclose($f);
						serr('Счет удачно выставлен!  Сумма платежа '.$am_rub.'р. ');
						}
						else
						{
						serr('Счет не выставлен, повторите позже!');
						}
				}
			}

	}
/////////





	echo "
	<script>

			function getformdata(id,param,event)
			{
				if (window.event)
				{
					event = window.event;
				}
				if (event )
				{

				       $.get('payform.php?id='+id+'&param='+param+'', function(data) {
					  $('#pl').html(data);
					  $('#pl').show(200, function() {
						});
					});

				 $('#pl').css({ position:'absolute',left: ($(window).width()-$('#pl').outerWidth())/2, top: '500px'  });


				}

			}

			function closeinfo()
			{
			  	$('#pl').hide(200);
			}

$(window).resize(function() {
 $('#pl').css({ position:'absolute',left: ($(window).width()-$('#pl').outerWidth())/2, top: '500px'  });
});

</script>";




		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Смена WMZ кошелька для вывода денежных средств</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">
		<p>После оплаты услуги ранее установленный Вами WMZ кошелек обнуляется и предоставляется возможность повторного ввода.</p>
		<table align=left><tr valign=middle><td> </td><td> </td><td> </td></tr></table>
		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
	echo "<div align=center><br>";
//проверяем  есть или нет
	$wmz=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`users_money`  WHERE `owner` = '{$us['id']}' LIMIT 1;"));
	if ($wmz['owner']>0)
		{
		$showpay=true;
			$now=date("d.m.y H:i",time());
			//ищем заявку  - может уже есть такая  ищим последнюю
			$get_com_wm=mysql_fetch_array(mysql_query("select * from com_requests where charid='{$us['id']}' and `type`='Смена WMZ кошелька для вывода денежных средств' and `status`='Ожидается оплата' order by id desc limit 1"));
			if (!($get_com_wm['Id']>0))
			{
			//если нету - инсертим новую

				if (isset($_POST['comment']))
				{
					$query="INSERT into com_requests (`mess_time`, `login`, `type`, `status` ,`comment`, `charid`,`email`,`addinfo`,`ip`) VALUES ('".time()."','".$us['login']."', 'Смена WMZ кошелька для вывода денежных средств', 'Ожидается оплата' , '".mysql_real_escape_string(htmlspecialchars($_POST['comment'],ENT_COMPAT | ENT_HTML401,"cp1251"))."', '".$us['id']."', '".mysql_real_escape_string(htmlspecialchars($_POST['comemail'],ENT_COMPAT | ENT_HTML401,"cp1251"))."','','".ip2long(REMIP)."');";
					mysql_query($query) or die();
				}
				else
				{
				echo "<b>Вы не указали обязательный комментарии к заявке!</b>";
				$showpay=false;
				}
			}

					if ($showpay)
					{
					echo "<a href=\"#\" onClick=\"getformdata(1,0,event);\"><img src=https://i.oldbk.com/i/bank/knopka_qiwi.gif title='Оплатить  с помощью QiWi' ></a>&nbsp;";
					echo "<a href=\"#\" onClick=\"getformdata(2,0,event);\"><img src=https://i.oldbk.com/i/bank/knopka_wmz.gif title='Оплатить с помощью WMZ' ></a><br>";
					echo "<a href=\"#\" onClick=\"getformdata(3,0,event);\"><img src=https://i.oldbk.com/i/bank/knopka_wmr.gif title='Оплатить с помощью WMR' ></a>&nbsp;";
					//echo "<a href=\"#\" onClick=\"getformdata(4,0,event);\"><img src=https://i.oldbk.com/i/bank/knopka_aclick.gif title='Оплатить с помощью \"Альфа-Клик\"' ></a>";
					}
		}
		else
		{
		echo "<b>У Вас WMZ-кошелек и так не установлен!</b>";
		}
	echo "</div>";

}

function ShowItemReturn()
{
	global $user;
	global $PRICE;

$view=true;
$us = check_users_city_datal($user);

	if (isset($_POST['mkecids'])) {
			$bprice = $PRICE[205][cost];
			$useditems = "";

			$good = false;
			$mess_time = time();
			$item_id=intval($_POST['itemid']);

			if ($item_id>0)
						{
						$get_test_id=mysql_fetch_array(mysql_query("select * from oldbk.inventory_aftr_del where id='{$item_id}' and owner='{$us['id']}'  order by did DESC LIMIT 1;"));
						//ищим последний удаленный предмет по этому ид
							if ($get_test_id['id']>0)
							{ 		//есть такой предмет в удаленных

								$get_invid=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$item_id}' LIMIT 1;"));
								//проверяем чтоб не было такого ид в игре
								if (!($get_invid['id']>0))
									{
									//нету
									$good = true;
									}
							}
						}






			if ($good) {
			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем

											serr("Вы удачно оплатили возврат вещи!");

											$q = mysql_query('START TRANSACTION') or die();

											//оплата
											$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
											if (!(mysql_num_rows($get_bank) > 0) )
											{
											die();
											}
											else
											{
											$bank = mysql_fetch_assoc($get_bank);

											mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
											//  пишем в хистори банка
											$bank['ekr']-=$bprice;
											mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
											}


											$rec = array();
								    			$rec['owner']=$us[id];
											$rec['owner_login']=$us[login];
											$rec['owner_balans_do']=$us['money'];
											$rec['owner_balans_posle']=$us['money'];
											$rec['owner_rep_do']=$us['repmoney'];
											$rec['target_login'] = "КО";
											$rec['owner_rep_posle']=$us['repmoney'];
											$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
											$rec['type'] = 2282;
											$rec['sum_ekr']=$bprice;
											$rec['bank_id']=$bank['id'];

											if (add_to_new_delo($rec) === FALSE) die();

											// пишем в ком отдел
											$now=date("d.m.y H:i",time());
											$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`addinfo`,`bank_id`) VALUES ('".$mess_time."','".$user."', 'Возврат вещи, в случае, если вещь продана в магазин или выкинута по ошибке', '".$_SESSION['mkecadd']['comment']." - ИД Предмета:".$get_test_id['id']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','".$get_test_id['id']."','{$bank['id']}');";
											mysql_query($query) or die();

												//тут можем сделать код по возврату предмета

											// всё ок, закончили
											$q = mysql_query('COMMIT') or die();
											serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");
											echo "
											<br>
											<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
											</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
											</div>
										        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

											echo "</td></tr>";
											$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
				}
			} else {
				serr("Такой предмет не найден");
			}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Возврат вещи</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">
		<p>Возврат вещи, в случае, если вещь продана в магазин или выкинута по ошибке...</p>

		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
					$us = check_users_city_datal($user);
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";
									echo '
							                <form id="mkec" method="POST" ><br>
									<center>Введите ID Предмета: <input type="text" name="itemid" id="itemid" class="button2" style="background-color:white;color:black;width:100px;">&nbsp;<a style="cursor: pointer; color: red;" title="Можно получить у любого паладина" alt="Можно получить у любого паладина">(?)</a><br>
									<BR><BR>
									К оплате сумма: '.$PRICE[205][cost].' екр.<br><br>
									Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
									<input type="hidden" id="mkecids" name="mkecids" value="Yes">
									<input type="hidden" id="services" name="services" value="Возврат вещи, в случае, если вещь продана в магазин или выкинута по ошибке"><br>
									';
									echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
									echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>
										';
					}
	}
}

function ShowDPItem()
{
	global $user;
	global $PRICE;

$view=true;
$us = check_users_city_datal($user);
	if (isset($_POST['mkecids'])) {


			$bprice = $PRICE[206][cost];
			$useditems = "";

			$good = false;
			$mess_time = time();
			$item_id=intval($_POST['itemid']);

					//ищим предмет у себя
					$get_invid=mysql_fetch_array(mysql_query("select * from oldbk.inventory where owner='{$us['id']}'  and id='{$item_id}'  LIMIT 1;"));
					//проверяем подарок
					if ( ($get_invid['id']>0) and ($get_invid['present']!='') )
					{
					$good = true;
					}
					//делаем потом заявку




			if ($good) {
			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
														// всё ок - начинаем
														serr("Вы удачно оплатили - Снятие подарка с вещи");

														$q = mysql_query('START TRANSACTION') or die();
														//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}


														$rec = array();
											    			$rec['owner']=$us[id];
														$rec['owner_login']=$us[login];
														$rec['owner_balans_do']=$us['money'];
														$rec['owner_balans_posle']=$us['money'];
														$rec['owner_rep_do']=$us['repmoney'];
														$rec['target_login'] = "КО";
														$rec['owner_rep_posle']=$us['repmoney'];
														$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
														$rec['type'] = 2282;
														$rec['sum_ekr']=$bprice;
														$rec['bank_id']=$bank['id'];
														if (add_to_new_delo($rec) === FALSE) die();

														// пишем в ком отдел
														$now=date("d.m.y H:i",time());
														$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`addinfo`,`bank_id`) VALUES ('".$mess_time."','".$user."', 'Снятие подарка с вещи, в случае, если вещь подарена по ошибке', '".$_SESSION['mkecadd']['comment']." - ИД предмета:".$get_invid['id']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','".$get_invid."','{$bank['id']}');";
														mysql_query($query) or die();


														// всё ок, закончили
														$q = mysql_query('COMMIT') or die();
														serr("Заявка будет рассмотрена в ближайшие 3-5 дней.");
														echo "
														<br>
														<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
														</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
														</div>
													        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
														echo "</td></tr>";
														$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
			}
			} else {
				serr("Ошибка Предмета!");
			}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\">Снятие подарка с вещи, в случае, если вещь подарена по ошибке</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";
					$us = check_users_city_datal($user);
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

											echo '
									                <form id="mkec" method="POST" ><br>
											<center>Введите ID Предмета: <input type="text" name="itemid" id="itemid" class="button2" style="background-color:white;color:black;width:100px;">&nbsp;<a style="cursor: pointer; color: red;" title="Можно получить у любого паладина" alt="Можно получить у любого паладина">(?)</a><br>
											<BR>
											К оплате сумма: '.$PRICE[206][cost].' екр.<br><br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
												<br><input type="hidden" id="mkecids" name="mkecids" value="Yes">
												<input type="hidden" id="services" name="services" value="Снятие подарка с вещи, в случае, если вещь подарена по ошибке"><br>
											';

											echo '<br><center><input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
											echo '</form>
											<script>
													function CheckF() {
													if (confirm("Вы уверены?")) {
														document.getElementById("mkec").submit();
													}

												}
											</script>
											';

					}
	}
}


function ShowExpressClear() {
	global $user;
	global $PRICE;

$view=true;
$us = check_users_city_datal($user);

	if (isset($_POST['mkecids'])) {

	$bprice = $PRICE[207][cost];
	$useditems = "";

	if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем
						serr("Вы удачно оплатили экспресс проверку на чистоту");
													$q = mysql_query('START TRANSACTION') or die();

													//оплата
													$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
													if (!(mysql_num_rows($get_bank) > 0) )
													{
													die();
													}
													else
													{
													$bank = mysql_fetch_assoc($get_bank);

													mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
													//  пишем в хистори банка
													$bank['ekr']-=$bprice;
													mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
													}

													$rec = array();
										    			$rec['owner']=$us[id];
													$rec['owner_login']=$us[login];
													$rec['owner_balans_do']=$us['money'];
													$rec['owner_balans_posle']=$us['money'];
													$rec['owner_rep_do']=$us['repmoney'];
													$rec['target_login'] = "КО";
													$rec['owner_rep_posle']=$us['repmoney'];
													$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
													$rec['type'] = 2282;
													$rec['sum_ekr']=$bprice;
													$rec['bank_id']=$bank['id'];

													if (add_to_new_delo($rec) === FALSE) die();

													// пишем в ком отдел
													$now=date("d.m.y H:i",time());
													$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`bank_id`) VALUES ('".time()."','".$user."', 'Экспресс проверка на чистоту', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','{$bank['id']}');";
													mysql_query($query) or die();


													// всё ок, закончили
													$q = mysql_query('COMMIT') or die();
													echo "
													<br>
													<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
													</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
													</div>
												        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

													echo "</td></tr>";
													$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
		}
	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> ЭКСПРЕСС ПРОВЕРКА НА ЧИСТОТУ</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

								echo '
									<center>
							                <form id="mkec" method="POST" ><br>
									К оплате сумма: '.$PRICE[207][cost].' екр.<br><br>
									Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
										</div><br><form id="mkec" method="POST">
										<input type="hidden" id="mkecids" name="mkecids" value="Yes">
										<input type="hidden" id="services" name="services" value="Экспресс проверка на чистоту">
										<input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
									echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>
										';
					}
	}
}

function HMenu() {
	global $user;
	$datauser = check_users_city_datal($user);
	$q = mysql_query('SELECT * FROM com_requests WHERE charid = '.$datauser['id'].' AND showed = 0');
	if (mysql_num_rows($q) > 0) {
		$show = ' <font color=red>('.mysql_num_rows($q).')</font> ';
	} else {
		$show = "";
	}
	echo '<td height="50" align="center" valign="top" class="zagolovok">Добро пожаловать, '.$user.' ! :: <a href=index.php>[Главная]</a> :: <a  href=index.php?act=myrequest>[Мои заявки'.$show.']</a> :: <a  href=index.php?act=logout>[Выйти]</a> '.(IsAdmin() ? " :: <a  href=index.php?changeadmmode>[Режим Администратора]</a>" : "").' </td>';
}

function PutComMessage()	{
	global $user, $_POST;

	//echo HMenu();

	if ($_GET[act]!='sendmess')
	{
	echo '</tr>';
	echo "<tr><td>";
	}

	if ($_GET[act]=='clanservice')
	{
		 ClanServ(false);
	}
	else if ($_GET[act]=='other')
	{
	OtherServ(false);
	}
	else if ($_GET[act]=='sendmess')
	{
	SendMess(false);
	}



	if (isset($_POST['services'])) {
		$us = check_users_city_datal($user);
		$q = mysql_query('SELECT * FROM oldbk.com_requests WHERE charid = '.$us['id'].' and `comment` NOT LIKE "%<font color=red>%" AND status = "" LIMIT 3');
		if (mysql_num_rows($q) < 3) {
			echo "<center><b style=\"color:#800000\">Ваш запрос ";
			$r = "";
			$service = $_POST['services'];
			$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`ip`) VALUES ('".time()."','".$user."', '".$service."', '".$_POST['comment']."', '".$_SESSION['uid']."', '".$_POST['comemail']."','".ip2long(REMIP)."');";
			$r .= '"'.$service.'", ';
			mysql_query($query);
			echo substr($r,0,strlen($r)-2);
		 	echo " добавлен.<br>Представитель коммерческого отдела свяжется с вами в течение 5ти дней.</font>";
		}
	}

	echo "
	<br>
	<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
	</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
	</div>
        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

	echo "</td></tr>";


	if ($_GET[act]=='sendmess')   	{ echo "<tr><td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td></tr></table><br><br>"; 	}


}


function ComAdminView($act, $id)	{
	global $user, $isadmin, $_REQUEST, $_GET, $PRICE, $EKR_TO_GOLD;
	global $KO_start_time2;
	global $KO_fin_time2;
	$_GET['search']=urldecode($_GET['search']);
	$_GET['field']=urldecode($_GET['field']);

	if ($_REQUEST['doned']=='yes') {
		$addon='?act=done';
	}
	if ($_REQUEST['whatdeclared']=='yes') {
		$addon='?act=whatdeclared';
	}
	if ($_REQUEST['whatpaid']=='yes') {
		$addon='?act=whatpaid';
	}

	$now=date("d.m.y H:i",time());
	if ($isadmin==1)
		{
	echo "
		<form method=post><input type=text id=inp1 name=search> &nbsp; <select name=field><option>Ник заявителя</option><option>Тип заявки</option><option>Комментарий</option></select> &nbsp; <input type=submit id=enter1 value=Искать></form> &nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?changeadmmode\">[Режим игрока]</a><br>
		<br><center>
		<button id=enter1  onClick=\"location.href='index.php'\">Невыполненные заявки</button>
		<button id=enter1  onClick=\"location.href='index.php?act=done'\">Выполненные заявки</button>
		<button id=enter1  onClick=\"location.href='index.php?act=whatpaid'\">Оплаченные заявки</button>
		<button id=enter1  onClick=\"location.href='index.php?act=whatdeclared'\">Переданные заявки</button>
		<button id=enter1  onClick=\"location.href='index.php?price=yes'\">Прайс</button>
		<br></center>";
		}

	if (($isadmin==1) OR ($isadmin==2)) echo "<center>";

	if (($isadmin==1) /*and ($user != "Мастер")*/)
	{
	echo "<br>
	<button id=enter1  onClick=\"location.href='index.php?act=look_art_mod'\">Артефакты на утверждение</button>
	<button id=enter1  onClick=\"location.href='index.php?act=look_art_prep'\">Не оплаченные Артефакты</button>
	<button id=enter1  onClick=\"location.href='index.php?act=look_art_hist'\">История утвержденных Артефактов</button>";
	}
	if ( (($isadmin==1) OR ($isadmin==2)) /*and ($user != "Мастер")*/)
	{
	echo "	<button id=enter1  onClick=\"location.href='index.php?act=look_art_prep_mod'\">Артефакты за репу. премодерация</button>";
	}
	if ($isadmin==1)  {
		echo "<br><br>
		<button id=enter1  onClick=\"location.href='index.php?act=look_img_mod'\">Картинки,образы,подарки на утверждение</button>
		<button id=enter1  onClick=\"location.href='index.php?act=look_img_prep'\">Не оплаченные Картинки</button>
		<button id=enter1  onClick=\"location.href='index.php?act=look_img_hist'\">История утвержденных Картинок</button>
		<button id=enter1  onClick=\"location.href='index.php?act=look_clear_hist'\">История проверок</button> ";
	if (($user == "Архитектор")  OR ($user == "Bred"))
		{
			echo "<button id=enter1  onClick=\"location.href='index.php?act=look_unikhist'\">Уник лог</button><br>";
			echo "<br><button id=enter1  onClick=\"location.href='index.php?act=look_money_zayav'\">Заявки на вывод</button> ";
			echo "<button id=enter1  onClick=\"location.href='index.php?act=look_money_hist'\">История выплат</button>";
		}
	if (($isadmin==1) OR ($isadmin==2))
	{
	echo "	<button id=enter1  onClick=\"location.href='index.php?act=look_money_prep_mod'\">Заявки на вывод премодерация</button>";
	}

	}
	if (($isadmin==1) OR ($isadmin==2)) echo "</center><hr>";



	if (($act=='look_art_mod') /* and ($user != "Мастер")*/)
	{
		$view_form_look=1;
		echo "<div align=center><h3>Артефакты на утверждение</h3></div><br><br>";
	   	if ($_GET[yes_id])
	   	{
	   	//одобряеем
	   	mk_yes_forart($_GET[yes_id]);

	   	} elseif (($_GET[no_id])and($_GET[coment])and($_GET[send])) {
			$_GET[no_id]=(int)($_GET[no_id]);
			// echo "Удаляем что надо!";
		 	//ищем заявку и владельца + отправляем сообщение
			$get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$_GET[no_id]}'"));
			if (($get_proto[art_status]==1) and ($get_proto)) {
			if ($get_proto[owner]==22125)
		 	{
		 	//ищим главу клана
		 	$art_telo=mysql_fetch_assoc(mysql_query("select * from oldbk.users where id=(select glava from oldbk.clans where short='{$get_proto[arsenal_klan]}');"));
			$str_type=' кланового артефакта для клана \"'.$get_proto[arsenal_klan].'\"';
			//Возврат денег в клан казну
			  $clan_id= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `short` = '".$get_proto[arsenal_klan]."'  ;"));

			  mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr+{$get_proto[ecost]}  WHERE `clan_id` = '{$clan_id[id]}' ;");
			  //пишем возврат
			$txt="\"".$art_telo['login']."\", возващено {$get_proto[ecost]}  екр. При отказе на счет №{$get_proto[id]}, на покупку кланового артефакта.";
        	   	mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)   VALUES  ('2','2','{$clan_id[id]}','{$art_telo[id]}','".$txt."','".time()."');");
			$add_str='Возвращено '.$get_proto[ecost].' екр. в клан казну.';

			}
			else
			{
			$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_proto[owner]."'  ;"));
			$str_type=' личного артефакта для персонажа \"'.$art_telo[login].'\"';

			 if (($get_proto[repcost]>0) AND ($get_proto[veks_flag]==0))  { $add_str='Возвращено '.$get_proto[repcost].' репутации.'; }
			 elseif ($get_proto[veks_flag]==1) { $add_str='Возвращен Вексель на получение личного артефакта';}
	 		 elseif ($get_proto[veks_flag]==2) { $add_str='Возвращены ваучеры на сумму 50 екр';}
 	 		 elseif ($get_proto[veks_flag]==3) { $add_str='Возвращены ваучеры на сумму 100 екр';}
	 		 elseif ($get_proto[veks_flag]==4) { $add_str='Возвращены 25 екр на банковский счет';}
 	 		 elseif ($get_proto[veks_flag]==5) { $add_str='Возвращены 25 екр на банковский счет';}   else {$add_str=''; }

			}
		  	if ($art_telo[id_city]==1) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$art_telo[id]."'  ;")); }
	  		elseif ($art_telo[id_city]==2) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$art_telo[id]."'  ;")); }
			if ($art_telo['odate'] > (time()-60) )
			{
			addchp('<font color=red>Внимание!</font> Вам отказано в создании '.$str_type.', счет №'.$get_proto[id].'.'.$add_str.' Причина:'.mysql_real_escape_string($_GET[coment]).'.','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
			} else {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вам отказано в создании {$str_type}, счет №".$get_proto[id].". Причина:".mysql_real_escape_string($_GET[coment]).".');");
			}


			mysql_query("UPDATE oldbk.art_prototype set  art_status=100, `art_moder`='{$user}' , `art_mod_date`=NOW() , del_comm='".mysql_real_escape_string($_GET['coment'])."'  where id='{$get_proto[id]}' and art_status=1;");
			if (mysql_affected_rows()>0)
					{
					//удаляем картинку с сервера

						if (!(strpos($row[img], 'art_temp') !== false) )
								{
									unlink('./upload/'.$get_proto[img]);
								}




				if (($get_proto['veks_flag']==3) OR ($get_proto['veks_flag']==5) )
		  		{


		  		if ($get_proto['veks_flag']==3)
		  		{
				// возвращаем ваучеры 25*4 екр=100
				$t = mysql_query('select * from oldbk.eshop where id = 100025') or die();
				$dress = mysql_fetch_array($t);
				if ($dress['id'] > 0) {

								for ($k=1;$k<=4;$k++)
									{
									mysql_query("INSERT INTO oldbk.`inventory`
										(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
										)
										VALUES
										('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
										'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
										'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
										,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$art_telo['id']}'
										);
										") or die();
									$ekid.=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id())).",";
									}


					//new_delo
					$rec = array();
					$rec['owner']=$art_telo[id];
					$rec['owner_login']=$art_telo[login];
					$rec['owner_balans_do']=$art_telo['money'];
					$rec['owner_balans_posle']=$art_telo['money'];
					$rec['target_login']="КО";
					$rec['type']=280;//получил ваучер
					$rec['sum_kr']=0;
					$rec['sum_ekr']=100;
					$rec['sum_kom']=0;
					$rec['item_id']=$ekid;
					$rec['item_name']=$dress[name];
					$rec['item_count']=2;
					$rec['item_type']=$dress['type'];
					$rec['item_cost']=$dress['cost'];
					$rec['item_dur']=$dress['duration'];
					$rec['item_maxdur']=$dress['maxdur'];
					$rec['item_ups']=$dress['ups'];
					$rec['item_unic']=$dress['unic'];
					$rec['item_incmagic']=$dress['includemagicname'];
					$rec['item_incmagic_count']=$dress['includemagicuses'];
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['item_proto']=$dress['prototype'];
					$rec['item_sowner']=($dress['sowner']>0?1:0);
					$rec['item_incmagic_id']=$dress['includemagic'];
					if (add_to_new_delo($rec) === FALSE) die();

		  						}
		  		}
		  		else if ($get_proto['veks_flag']==5)
		  		{
				   		//возврат 25 екрами
						   		$bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  `id`= '{$get_proto['bankid']}' "));
								mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + 25  WHERE `id`= '{$get_proto['bankid']}' ");
								//  пишем в хистори банка
								$bank['ekr']+=25;
								mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе услуг Коммерческого отдела <b>25 екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$get_proto['bankid']}');");

										//new_delo
										$rec = array();
										$rec['owner']=$art_telo[id];
										$rec['owner_login']=$art_telo[login];
										$rec['owner_balans_do']=$art_telo['money'];
										$rec['owner_balans_posle']=$art_telo['money'];
										$rec['target_login']="КО";
										$rec['type']=1280;//получил екр назад
										$rec['sum_kr']=0;
										$rec['sum_ekr']=25;
										$rec['sum_kom']=0;
										$rec['item_id']=$ekid;
										$rec['item_name']=$dress[name];
										$rec['item_count']=2;
										$rec['item_type']=$dress['type'];
										$rec['item_cost']=$dress['cost'];
										$rec['item_dur']=$dress['duration'];
										$rec['item_maxdur']=$dress['maxdur'];
										$rec['item_ups']=$dress['ups'];
										$rec['item_unic']=$dress['unic'];
										$rec['item_incmagic']=$dress['includemagicname'];
										$rec['item_incmagic_count']=$dress['includemagicuses'];
										$rec['item_arsenal']='';
										$rec['bank_id']=$get_proto['bankid'];
										$rec['item_proto']=$dress['prototype'];
										$rec['item_sowner']=($dress['sowner']>0?1:0);
										$rec['item_incmagic_id']=$dress['includemagic'];
										if (add_to_new_delo($rec) === FALSE) die();


		  		}
		  			//возвращаем старый арт

					  			$old_art=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$get_proto['t_id']}' and owner=450"));
								if ($old_art['id']>0)
					  			{
								mysql_query("UPDATE `oldbk`.`inventory` SET `owner`='{$get_proto['owner']}' WHERE id='{$old_art['id']}' ") or die();

								  	//пишем в переводы о том что чел отдал арт на замену
								  	$rec=array();
			  		    				$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=380;//возврат обмена
									$rec['sum_kr']=0;
									$rec['sum_ekr']=0;
									$rec['sum_rep']=0;
									$rec['sum_kom']=0;
									$rec['item_id']=get_xitem_fid($old_art);
									$rec['item_name']=$old_art[name];
									$rec['item_count']=1;
									$rec['item_type']=$old_art[type];
									$rec['item_cost']=$old_art[cost];
									$rec['item_dur']=$old_art[duration];
									$rec['item_maxdur']=$old_art[maxdur];
									$rec['item_ups']=$old_art[ups];
									$rec['item_unic']=$old_art[unik];
									$rec['item_incmagic']=$old_art['includemagicname'];
									$rec['item_incmagic_count']=$old_art['includemagicuses'];
									$rec['add_info']='Возврат по отказу в обмене';
									add_to_new_delo($rec); //юзеру
									$add_str_oldart='Ваш артефакт "'.$old_art['name'].'" возвращен, при отказе в обмене ';


									//возвращаем репутацию
									//возврат репутации
//									$returnrep = 270000;
									$returnrep = 135000;
									//возращаем репу челу и пишем в дело
										$db_city[0]='oldbk.';
										$db_city[1]='avalon.';
										$db_city[2]='angels.';
									mysql_query("UPDATE {$db_city[$art_telo[id_city]]}users set repmoney=repmoney+{$returnrep} where id={$get_proto[owner]} and id_city={$art_telo[id_city]} ;");

									if (mysql_affected_rows()>0)
									{
									//пишем в дело о возврате репы
									//new_delo
									$rec=array();
				  		    			$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['owner_rep_do']=$art_telo['repmoney'];
									$rec['owner_rep_posle']=$art_telo['repmoney'] + $returnrep;
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=360;
									$rec['sum_kr']=0;
									$rec['sum_ekr']=0;
									$rec['sum_rep']=$returnrep;
									$rec['sum_kom']=0;
									$rec['item_id']='';
									$rec['item_name']=$get_proto[name];
									$rec['item_count']=1;
									$rec['item_type']=$get_proto[type];
									$rec['item_cost']=$get_proto[cost];
									$rec['item_dur']=$get_proto[duration];
									$rec['item_maxdur']=$get_proto[maxdur];
									$rec['item_ups']=$get_proto[ups];
									$rec['item_unic']=$get_proto[unik];
									$rec['item_incmagic']='';
									$rec['item_incmagic_count']='';
									$rec['item_arsenal']='';
									$rec['bank_id']='';
									$rec['add_info']='Счет №'.$get_proto[id];
									add_to_new_delo($rec); //юзеру
									$add_str_oldart.='. Возвращено '.$returnrep.' репутации';
									}



									if ($art_telo['odate'] > (time()-60) )
												{
												addchp('<font color=red>Внимание!</font> '.$add_str_oldart.', счет №'.$get_proto[id],'{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
												} else {
												mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> ".$add_str_oldart.", счет №".$get_proto[id].".');");
												}
		  						}
		  						else
		  						{
		  						 echo "Ошибка: Старый артефакт не найден!";
		  						}



		  		}
		  		elseif (($get_proto['veks_flag']==2) || ($get_proto['veks_flag']==4) || ($get_proto['veks_flag']==9) )
		  		{
				if ($get_proto['veks_flag']==2)
				{
				$t = mysql_query('select * from oldbk.eshop where id = 100025') or die();
				$dress = mysql_fetch_array($t);
				if ($dress['id'] > 0) {

								for ($k=1;$k<=2;$k++)
									{
									mysql_query("INSERT INTO oldbk.`inventory`
										(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
										)
										VALUES
										('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
										'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
										'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
										,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$art_telo['id']}'
										);
										") or die();
									$ekid.=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id())).",";
									}


					//new_delo
					$rec = array();
					$rec['owner']=$art_telo[id];
					$rec['owner_login']=$art_telo[login];
					$rec['owner_balans_do']=$art_telo['money'];
					$rec['owner_balans_posle']=$art_telo['money'];
					$rec['target_login']="КО";
					$rec['type']=280;//получил ваучер
					$rec['sum_kr']=0;
					$rec['sum_ekr']=50;
					$rec['sum_kom']=0;
					$rec['item_id']=$ekid;
					$rec['item_name']=$dress[name];
					$rec['item_count']=2;
					$rec['item_type']=$dress['type'];
					$rec['item_cost']=$dress['cost'];
					$rec['item_dur']=$dress['duration'];
					$rec['item_maxdur']=$dress['maxdur'];
					$rec['item_ups']=$dress['ups'];
					$rec['item_unic']=$dress['unic'];
					$rec['item_incmagic']=$dress['includemagicname'];
					$rec['item_incmagic_count']=$dress['includemagicuses'];
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['item_proto']=$dress['prototype'];
					$rec['item_sowner']=($dress['sowner']>0?1:0);
					$rec['item_incmagic_id']=$dress['includemagic'];
					if (add_to_new_delo($rec) === FALSE) die();

		  						}
		  			}
		  				elseif ($get_proto[veks_flag]==4  || $get_proto[veks_flag]==9)
				   		{

								if ($get_proto[veks_flag]==4) {
					   				//возврат 25 екрами
							   		$bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  `id`= '{$get_proto['bankid']}' "));
									mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + 25  WHERE `id`= '{$get_proto['bankid']}' ");
									//  пишем в хистори банка
									$bank['ekr']+=25;
									mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе услуг Коммерческого отдела <b>25 екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$get_proto['bankid']}');");

										//new_delo
										$rec = array();
										$rec['owner']=$art_telo[id];
										$rec['owner_login']=$art_telo[login];
										$rec['owner_balans_do']=$art_telo['money'];
										$rec['owner_balans_posle']=$art_telo['money'];
										$rec['target_login']="КО";
										$rec['type']=1280;//получил екр назад
										$rec['sum_kr']=0;
										$rec['sum_ekr']=25;
										$rec['sum_kom']=0;
										$rec['item_id']=$ekid;
										$rec['item_name']=$dress[name];
										$rec['item_count']=2;
										$rec['item_type']=$dress['type'];
										$rec['item_cost']=$dress['cost'];
										$rec['item_dur']=$dress['duration'];
										$rec['item_maxdur']=$dress['maxdur'];
										$rec['item_ups']=$dress['ups'];
										$rec['item_unic']=$dress['unic'];
										$rec['item_incmagic']=$dress['includemagicname'];
										$rec['item_incmagic_count']=$dress['includemagicuses'];
										$rec['item_arsenal']='';
										$rec['bank_id']=$get_proto['bankid'];
										$rec['item_proto']=$dress['prototype'];
										$rec['item_sowner']=($dress['sowner']>0?1:0);
										$rec['item_incmagic_id']=$dress['includemagic'];
										if (add_to_new_delo($rec) === FALSE) die();
								}
				   		}


		  			//возвращаем старый арт

					  			$old_art=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$get_proto['t_id']}' and owner=450"));
								if ($old_art['id']>0)
					  			{
								mysql_query("UPDATE `oldbk`.`inventory` SET `owner`='{$get_proto['owner']}' WHERE id='{$old_art['id']}' ") or die();

								  	//пишем в переводы о том что чел отдал арт на замену
								  	$rec=array();
			  		    				$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=380;//возврат обмена
									$rec['sum_kr']=0;
									$rec['sum_ekr']=0;
									$rec['sum_rep']=0;
									$rec['sum_kom']=0;
									$rec['item_id']=get_xitem_fid($old_art);
									$rec['item_name']=$old_art[name];
									$rec['item_count']=1;
									$rec['item_type']=$old_art[type];
									$rec['item_cost']=$old_art[cost];
									$rec['item_dur']=$old_art[duration];
									$rec['item_maxdur']=$old_art[maxdur];
									$rec['item_ups']=$old_art[ups];
									$rec['item_unic']=$old_art[unik];
									$rec['item_incmagic']=$old_art['includemagicname'];
									$rec['item_incmagic_count']=$old_art['includemagicuses'];
									$rec['add_info']='Возврат по отказу в обмене';
									add_to_new_delo($rec); //юзеру
									$add_str_oldart='Ваш артефакт "'.$old_art['name'].'" возвращен, при отказе в обмене ';

									if ($art_telo['odate'] > (time()-60) )
												{
												addchp('<font color=red>Внимание!</font> '.$add_str_oldart.', счет №'.$get_proto[id],'{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
												} else {
												mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> ".$add_str_oldart.", счет №".$get_proto[id].".');");
												}
		  						}
		  						else
		  						{
		  						 echo "Ошибка: Старый артефакт не найден!";
		  						}



		  			}
					elseif (($get_proto[repcost]>0) and ($get_proto[owner]!=22125) and ($get_proto[veks_flag]==0) )
					{
						//возращаем репу челу и пишем в дело
						$db_city[0]='oldbk.';
						$db_city[1]='avalon.';
						$db_city[2]='angels.';
						mysql_query("UPDATE {$db_city[$art_telo[id_city]]}users set repmoney=repmoney+{$get_proto[repcost]} where id={$get_proto[owner]} and id_city={$art_telo[id_city]} ;");

						if (mysql_affected_rows()>0)
							{
							//пишем в дело о возврате репы
					//new_delo

  		    			$rec['owner']=$art_telo[id];
					$rec['owner_login']=$art_telo[login];
					$rec['owner_balans_do']=$art_telo['money'];
					$rec['owner_balans_posle']=$art_telo['money'];
					$rec['owner_rep_do']=$art_telo['repmoney'];
					$rec['owner_rep_posle']=$art_telo['repmoney'] + $get_proto[repcost];
					$rec['target']=0;
					$rec['target_login']='КО';
					$rec['type']=360;
					$rec['sum_kr']=0;
					$rec['sum_ekr']=0;
					$rec['sum_rep']=$get_proto[repcost];
					$rec['sum_kom']=0;
					$rec['item_id']='';
					$rec['item_name']=$get_proto[name];
					$rec['item_count']=1;
					$rec['item_type']=$get_proto[type];
					$rec['item_cost']=$get_proto[cost];
					$rec['item_dur']=$get_proto[duration];
					$rec['item_maxdur']=$get_proto[maxdur];
					$rec['item_ups']=$get_proto[ups];
					$rec['item_unic']=$get_proto[unik];
					$rec['item_incmagic']='';
					$rec['item_incmagic_count']='';
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['add_info']='Счет №'.$get_proto[id];
					add_to_new_delo($rec); //юзеру

							}
					}
					else	if ( (($get_proto[repcost]>0) and ($get_proto[owner]!=22125) and ($get_proto[veks_flag]==1) ) OR ($get_proto['dil']>0) )
					{
						//вертаем взад - вексель
		  			$dress = mysql_query('SELECT * FROM oldbk.shop WHERE id = 3005000') or die();
					$dress = mysql_fetch_assoc($dress);
					if ($dress !== FALSE) {
						mysql_query("INSERT INTO oldbk.`inventory`
							(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
							`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
							`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
							`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`,`present`
							)
							VALUES
							('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
							'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
							'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
							,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','0','Коммерческий отдел'
							);
						") or die();

						//new_delo
						$rec = array();
	  		    			$rec['owner']=$art_telo[id];
						$rec['owner_login']=$art_telo[login];
						$rec['owner_balans_do']=$art_telo['money'];
						$rec['owner_balans_posle']=$art_telo['money'];
						$rec['target_login']="КО";
						$rec['type']=99; // получил предмет
						$rec['sum_kr']=0;
						$rec['sum_ekr']=0;
						$rec['sum_kom']=0;
						$rec['item_id']=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id()));
						$rec['item_name']=$dress[name];
						$rec['item_count']=1;
						$rec['item_type']=$dress['type'];
						$rec['item_cost']=$dress['cost'];
						$rec['item_dur']=$dress['duration'];
						$rec['item_maxdur']=$dress['maxdur'];
						$rec['item_ups']=$dress['ups'];
						$rec['item_unic']=$dress['unic'];
						$rec['item_incmagic']=$dress['includemagicname'];
						$rec['item_incmagic_count']=$dress['includemagicuses'];
						$rec['item_arsenal']='';
						$rec['item_proto']=$dress['prototype'];
						$rec['item_sowner']=($dress['sowner']>0?1:0);
						$rec['item_incmagic_id']=$dress['includemagic'];
						if (add_to_new_delo($rec) === FALSE) die();

						serr("- успешно выдан ".$dress['name']);
						systemtotelo($art_telo,"Успешно выдан ".$dress['name']);
					}


					}



					echo "<br><font color=red>Счет удачно удален!</font>";
					}
					else
					{
					echo "<br><font color=red>Ошибка удаления!</font>";
					}
			}
		}
		else
 		if ($_GET[no_id])
 		{
 		//надо проверить чем платили

			$view_form_look=0;
			echo "<br><br>Отказ счета №".(int)($_GET[no_id]);
	 		echo "<form method=GET>";
	 		echo "<input type=hidden name=act value='look_art_mod'>";
	 		echo "<input type=hidden name=no_id value='".(int)($_GET[no_id])."'>";
	 		echo " Комментарий: <input type=text name=coment>";
	 		echo "<input type=submit name=send value='Отказать в создании артефакта'>";
 		}

	if ($view_form_look==1)
	   {
		$get_ut_arts=mysql_query("select * from oldbk.art_prototype where art_status=1 order by battle DESC, art_zakdate DESC");
		$j=0;
		while ($row=mysql_fetch_array($get_ut_arts))
		{
		$j++;
		echo "<table border=0>";
		ShowAitAdmin($row,1);
		echo "</table>";
		echo "<hr>";
		}
		if ($j==0) { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	  }

	}
else if (($act=='look_art_prep') /*and ($user != "Мастер")*/)
	{
	echo "<div align=center><h3>Артефакты не оплаченые</h3></div><br><br>";
	$view_form_look=1;
		if (($_GET[no_id])and($_GET[coment])and($_GET[send]))
		{
		$_GET[no_id]=(int)($_GET[no_id]);
		// echo "Удаляем что надо!";
		 //ищем заявку и владельца + отправляем сообщение

		$get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$_GET[no_id]}'"));

		if (($get_proto[art_status]==0) and ($get_proto))
		{
			if ($get_proto[owner]==22125)
		 	{
		 	$art_telo=mysql_fetch_assoc(mysql_query("select * from oldbk.users where id=(select glava from oldbk.clans where short='{$get_proto[arsenal_klan]}');"));
			$str_type=' кланового артефакта для клана \"'.$get_proto[arsenal_klan].'\"';
			}
			else
			{
			$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_proto[owner]."'  ;"));
			$str_type=' личного артефакта для персонажа \"'.$art_telo[login].'\"';
			}
		  	if ($art_telo[id_city]==1) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$art_telo[id]."'  ;")); }
		  	elseif ($art_telo[id_city]==2) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$art_telo[id]."'  ;")); }
			if ($art_telo['odate'] > (time()-60) )
			{
			addchp('<font color=red>Внимание!</font> Вам отказано в создании '.$str_type.', счет №'.$get_proto[id].'. Причина:'.mysql_real_escape_string($_GET[coment]).'.','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
			} else {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вам отказано в создании {$str_type}, счет №".$get_proto[id].". Причина:".mysql_real_escape_string($_GET[coment]).".');");
			}

//		mysql_query("DELETE FROM oldbk.art_prototype where id='{$get_proto[id]}' and art_status=0;");
		mysql_query("UPDATE oldbk.art_prototype set  art_status=100, `art_moder`='{$user}' , `art_mod_date`=NOW() ,  del_comm='".mysql_real_escape_string($_GET['coment'])."'  where id='{$get_proto[id]}' and art_status=0;");
		if (mysql_affected_rows()>0)
					{
					//удаляем картинку с сервера
					unlink('./upload/'.$get_proto[img]);
					echo "<br><font color=red>Счет удачно удален!</font>";
					}
					else
					{
					echo "<br><font color=red>Ошибка удаления!</font>";
					}


		} else { echo "<br><font color=red>Такой счет не найден в не оплеченых!</font>"; }



		}
		else
 		if ($_GET[no_id])
 		{
		$view_form_look=0;
		echo "<br><br>Отказ счета №".(int)($_GET[no_id]);
 		echo "<form method=GET>";
 		echo "<input type=hidden name=act value='look_art_prep'>";
 		echo "<input type=hidden name=no_id value='".(int)($_GET[no_id])."'>";
 		echo " Комментарий: <input type=text name=coment>";
 		echo "<input type=submit name=send value='Отказать в создании артефакта'>";
 		}
 		else if ($_GET[yes_id])
 		 {
 		 $_GET[yes_id]=(int)($_GET[yes_id]);
 		  //ставим флаг что утвержден рассмотрен и можно оплачивать
 		  $get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$_GET[yes_id]}' and art_status=0 and art_mess=0 ;"));

			if ($get_proto)
		    {
			if ($get_proto[owner]==22125)
		 	{
		 	$art_telo=mysql_fetch_assoc(mysql_query("select * from oldbk.users where id=(select glava from oldbk.clans where short='{$get_proto[arsenal_klan]}');"));
			$str_type=' кланового артефакта для клана \"'.$get_proto[arsenal_klan].'\"';
			}
			else
			{
			$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_proto[owner]."'  ;"));
			$str_type=' личного артефакта для персонажа \"'.$art_telo[login].'\"';
			}
		  	if ($art_telo[id_city]==1) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$art_telo[id]."'  ;")); }
		  	elseif ($art_telo[id_city]==2) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$art_telo[id]."'  ;")); }
			if ($art_telo['odate'] > (time()-60) )
			{
			addchp('<font color=red>Внимание!</font> Вам одобрено в создании '.$str_type.', счет №'.$get_proto[id].'. Можете оплатить счет.','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
			} else {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вам одобрено в создании {$str_type}, счет №".$get_proto[id].". Можете оплатить счет.');");
			}

			mysql_query("UPDATE oldbk.art_prototype SET art_mess=1 where id='{$get_proto[id]}' and art_status=0 and art_mess=0 ; ");

		   }
		    else
		     {
		     echo "<br><font color=red>Такой счет не найден или уже одобрен!</font>";
		     }



 		 }


	if ($view_form_look==1)
	   {
		$get_ut_arts=mysql_query("select * from oldbk.art_prototype where art_status=0 order by art_zakdate DESC");
		$j=0;
		while ($row=mysql_fetch_array($get_ut_arts))
		{
		$j++;
		echo "<table border=0>";
		ShowAitAdmin($row,2);
		echo "</table>";
		echo "<hr>";
		}
		if ($j==0) { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	   }
	}
else if (($act=='look_art_prep_mod') /*and ($user != "Мастер")*/)
	{
	echo "<div align=center><h3>Артефакты оплаченые репутацией - премодерация</h3></div><br><br>";
	$view_form_look=1;
		if (($_GET[no_id])and($_GET[coment])and($_GET[send]))
		{
		$_GET[no_id]=(int)($_GET[no_id]);
		// echo "Удаляем что надо!";
		 //ищем заявку и владельца + отправляем сообщение

		$get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$_GET[no_id]}'"));

		if (($get_proto[art_status]==-1) and ($get_proto))
		{
			if ($get_proto[owner]==22125)
		 	{
		 	 echo "Ошибка: Арт данного типа не может быть клановым!";
			}
			else
			{
			$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_proto[owner]."'  ;"));
			$str_type=' личного артефакта для персонажа \"'.$art_telo[login].'\"';
			}


		  	if ($art_telo[id_city]==1) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$art_telo[id]."'  ;")); }
		  	elseif ($art_telo[id_city]==2) { $art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$art_telo[id]."'  ;")); }


		if ($get_proto[veks_flag]==0)
			{
			//оплата чистой репой

		  	$returnrep=$get_proto[repcost];
		  	if ($art_telo['id_city'] == 0)
		  			{
	                                        mysql_query('UPDATE oldbk.`users` SET `repmoney` = `repmoney` + '.$returnrep.'  WHERE `id` = '.$art_telo['id']) or die();
					} elseif ($art_telo['id_city'] == 1) {
	                                        mysql_query('UPDATE avalon.`users` SET `repmoney` = `repmoney` + '.$returnrep.'  WHERE `id` = '.$art_telo['id']) or die();
					} elseif ($art_telo['id_city'] == 2) {
	                                        mysql_query('UPDATE angels.`users` SET `repmoney` = `repmoney` + '.$returnrep.'  WHERE `id` = '.$art_telo['id']) or die();
					}

		  			if (mysql_affected_rows()>0)
							{
							//пишем в дело о возврате репы
					//new_delo

  		    			$rec['owner']=$art_telo[id];
					$rec['owner_login']=$art_telo[login];
					$rec['owner_balans_do']=$art_telo['money'];
					$rec['owner_balans_posle']=$art_telo['money'];
					$rec['owner_rep_do']=$art_telo['repmoney'];
					$rec['owner_rep_posle']=$art_telo['repmoney'] + $get_proto[repcost];
					$rec['target']=0;
					$rec['target_login']='КО';
					$rec['type']=360;
					$rec['sum_kr']=0;
					$rec['sum_ekr']=0;
					$rec['sum_rep']=$get_proto[repcost];
					$rec['sum_kom']=0;
					$rec['item_id']='';
					$rec['item_name']=$get_proto[name];
					$rec['item_count']=1;
					$rec['item_type']=$get_proto[type];
					$rec['item_cost']=$get_proto[cost];
					$rec['item_dur']=$get_proto[duration];
					$rec['item_maxdur']=$get_proto[maxdur];
					$rec['item_ups']=$get_proto[ups];
					$rec['item_unic']=$get_proto[unik];
					$rec['item_incmagic']='';
					$rec['item_incmagic_count']='';
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['add_info']='Счет №'.$get_proto[id];
					add_to_new_delo($rec); //юзеру

							}
		  		}
		  		elseif (($get_proto[veks_flag]==2) OR ($get_proto[veks_flag]==4) OR ($get_proto[veks_flag]==9))
		  		{


				if ($get_proto[veks_flag]==2)
					{
				// возвращаем ваучеры 25*2 екр=50
				$t = mysql_query('select * from oldbk.eshop where id = 100025') or die();
				$dress = mysql_fetch_array($t);
						if ($dress['id'] > 0)
						{

										for ($k=1;$k<=2;$k++)
											{
											mysql_query("INSERT INTO oldbk.`inventory`
												(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
												`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
												`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
												`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
												)
												VALUES
												('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
												'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
												'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
												,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$art_telo['id']}'
												);
												") or die();
											$ekid.=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id())).",";
											}

										//new_delo
								$rec = array();
								$rec['owner']=$art_telo[id];
								$rec['owner_login']=$art_telo[login];
								$rec['owner_balans_do']=$art_telo['money'];
								$rec['owner_balans_posle']=$art_telo['money'];
								$rec['target_login']="КО";
								$rec['type']=280;//получил ваучер
								$rec['sum_kr']=0;
								$rec['sum_ekr']=50;
								$rec['sum_kom']=0;
								$rec['item_id']=$ekid;
								$rec['item_name']=$dress[name];
								$rec['item_count']=2;
								$rec['item_type']=$dress['type'];
								$rec['item_cost']=$dress['cost'];
								$rec['item_dur']=$dress['duration'];
								$rec['item_maxdur']=$dress['maxdur'];
								$rec['item_ups']=$dress['ups'];
								$rec['item_unic']=$dress['unic'];
								$rec['item_incmagic']=$dress['includemagicname'];
								$rec['item_incmagic_count']=$dress['includemagicuses'];
								$rec['item_arsenal']='';
								$rec['bank_id']='';
								$rec['item_proto']=$dress['prototype'];
								$rec['item_sowner']=($dress['sowner']>0?1:0);
								$rec['item_incmagic_id']=$dress['includemagic'];
								if (add_to_new_delo($rec) === FALSE) die();
						}
				   	}
				   	elseif ($get_proto[veks_flag]==4 || $get_proto[veks_flag]==9)
				   		{
				   		//возврат  екрами
								if ($get_proto[veks_flag]==9) {

									$t = mysql_query('select * from oldbk.shop where id = 541') or die();
									$dress = mysql_fetch_array($t);
									if ($dress['id'] > 0) {
											mysql_query("INSERT INTO oldbk.`inventory`
												(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
												`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
												`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
												`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
												)
												VALUES
												('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
												'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
												'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
												,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$art_telo['id']}'
												);
												") or die();
									}


								} else {

							   		$bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  `id`= '{$get_proto['bankid']}' "));
									mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + 25  WHERE `id`= '{$get_proto['bankid']}' ");
									//  пишем в хистори банка
									$bank['ekr']+=25;
									mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе услуг Коммерческого отдела <b>25 екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$get_proto['bankid']}');");

										//new_delo
										$rec = array();
										$rec['owner']=$art_telo[id];
										$rec['owner_login']=$art_telo[login];
										$rec['owner_balans_do']=$art_telo['money'];
										$rec['owner_balans_posle']=$art_telo['money'];
										$rec['target_login']="КО";
										$rec['type']=1280;//получил екр назад
										$rec['sum_kr']=0;
										$rec['sum_ekr']=25;
										$rec['sum_kom']=0;
										$rec['item_id']=$ekid;
										$rec['item_name']=$dress[name];
										$rec['item_count']=2;
										$rec['item_type']=$dress['type'];
										$rec['item_cost']=$dress['cost'];
										$rec['item_dur']=$dress['duration'];
										$rec['item_maxdur']=$dress['maxdur'];
										$rec['item_ups']=$dress['ups'];
										$rec['item_unic']=$dress['unic'];
										$rec['item_incmagic']=$dress['includemagicname'];
										$rec['item_incmagic_count']=$dress['includemagicuses'];
										$rec['item_arsenal']='';
										$rec['bank_id']=$get_proto['bankid'];
										$rec['item_proto']=$dress['prototype'];
										$rec['item_sowner']=($dress['sowner']>0?1:0);
										$rec['item_incmagic_id']=$dress['includemagic'];
										if (add_to_new_delo($rec) === FALSE) die();
								}
				   		}





		  			//возвращаем старый арт

					  			$old_art=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$get_proto['t_id']}' and owner=450"));
								if ($old_art['id']>0)
					  			{
								mysql_query("UPDATE `oldbk`.`inventory` SET `owner`='{$get_proto['owner']}' WHERE id='{$old_art['id']}' ") or die();

								  	//пишем в переводы о том что чел отдал арт на замену
								  	$rec=array();
			  		    				$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=380;//возврат обмена
									$rec['sum_kr']=0;
									$rec['sum_ekr']=0;
									$rec['sum_rep']=0;
									$rec['sum_kom']=0;
									$rec['item_id']=get_xitem_fid($old_art);
									$rec['item_name']=$old_art[name];
									$rec['item_count']=1;
									$rec['item_type']=$old_art[type];
									$rec['item_cost']=$old_art[cost];
									$rec['item_dur']=$old_art[duration];
									$rec['item_maxdur']=$old_art[maxdur];
									$rec['item_ups']=$old_art[ups];
									$rec['item_unic']=$old_art[unik];
									$rec['item_incmagic']=$old_art['includemagicname'];
									$rec['item_incmagic_count']=$old_art['includemagicuses'];
									$rec['add_info']='Возврат по отказу в обмене';
									add_to_new_delo($rec); //юзеру
									$add_str_oldart='Ваш артефакт "'.$old_art['name'].'" возвращен, при отказе в обмене ';

									if ($art_telo['odate'] > (time()-60) )
												{
												addchp('<font color=red>Внимание!</font> '.$add_str_oldart.', счет №'.$get_proto[id],'{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
												} else {
												mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> ".$add_str_oldart.", счет №".$get_proto[id].".');");
												}
		  						}
		  						else
		  						{
		  						 echo "Ошибка: Старый артефакт не найден!";
		  						}



		  		}
				elseif  ( ($get_proto[veks_flag]==3) OR ($get_proto[veks_flag]==5) )
		  		{


				if ($get_proto[veks_flag]==3)
				{
				// возвращаем ваучеры 100
				$t = mysql_query('select * from oldbk.eshop where id = 100025') or die();
				$dress = mysql_fetch_array($t);
				if ($dress['id'] > 0) {

								for ($k=1;$k<=4;$k++)
									{
									mysql_query("INSERT INTO oldbk.`inventory`
										(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
										`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
										`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
										`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
										)
										VALUES
										('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
										'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
										'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
										,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$art_telo['id']}'
										);
										") or die();
									$ekid.=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id())).",";
									}


					//new_delo
					$rec = array();
					$rec['owner']=$art_telo[id];
					$rec['owner_login']=$art_telo[login];
					$rec['owner_balans_do']=$art_telo['money'];
					$rec['owner_balans_posle']=$art_telo['money'];
					$rec['target_login']="КО";
					$rec['type']=280;//получил ваучер
					$rec['sum_kr']=0;
					$rec['sum_ekr']=100;
					$rec['sum_kom']=0;
					$rec['item_id']=$ekid;
					$rec['item_name']=$dress[name];
					$rec['item_count']=2;
					$rec['item_type']=$dress['type'];
					$rec['item_cost']=$dress['cost'];
					$rec['item_dur']=$dress['duration'];
					$rec['item_maxdur']=$dress['maxdur'];
					$rec['item_ups']=$dress['ups'];
					$rec['item_unic']=$dress['unic'];
					$rec['item_incmagic']=$dress['includemagicname'];
					$rec['item_incmagic_count']=$dress['includemagicuses'];
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['item_proto']=$dress['prototype'];
					$rec['item_sowner']=($dress['sowner']>0?1:0);
					$rec['item_incmagic_id']=$dress['includemagic'];
					if (add_to_new_delo($rec) === FALSE) die();

		  						}
		  			}
		  			else
		  			if ($get_proto[veks_flag]==5)
		  				{
				   		//возврат екрами
						   		$bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  `id`= '{$get_proto['bankid']}' "));
								mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + 25  WHERE `id`= '{$get_proto['bankid']}' ");
								//  пишем в хистори банка
								$bank['ekr']+=25;
								mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе услуг Коммерческого отдела <b>25 екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$get_proto['bankid']}');");

										//new_delo
										$rec = array();
										$rec['owner']=$art_telo[id];
										$rec['owner_login']=$art_telo[login];
										$rec['owner_balans_do']=$art_telo['money'];
										$rec['owner_balans_posle']=$art_telo['money'];
										$rec['target_login']="КО";
										$rec['type']=1280;//получил екр назад
										$rec['sum_kr']=0;
										$rec['sum_ekr']=25;
										$rec['sum_kom']=0;
										$rec['item_id']=$ekid;
										$rec['item_name']=$dress[name];
										$rec['item_count']=2;
										$rec['item_type']=$dress['type'];
										$rec['item_cost']=$dress['cost'];
										$rec['item_dur']=$dress['duration'];
										$rec['item_maxdur']=$dress['maxdur'];
										$rec['item_ups']=$dress['ups'];
										$rec['item_unic']=$dress['unic'];
										$rec['item_incmagic']=$dress['includemagicname'];
										$rec['item_incmagic_count']=$dress['includemagicuses'];
										$rec['item_arsenal']='';
										$rec['bank_id']=$get_proto['bankid'];
										$rec['item_proto']=$dress['prototype'];
										$rec['item_sowner']=($dress['sowner']>0?1:0);
										$rec['item_incmagic_id']=$dress['includemagic'];
										if (add_to_new_delo($rec) === FALSE) die();


		  				}
		  			//возвращаем старый арт

					  			$old_art=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$get_proto['t_id']}' and owner=450"));
								if ($old_art['id']>0)
					  			{
								mysql_query("UPDATE `oldbk`.`inventory` SET `owner`='{$get_proto['owner']}' WHERE id='{$old_art['id']}' ") or die();

								  	//пишем в переводы о том что чел отдал арт на замену
								  	$rec=array();
			  		    				$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=380;//возврат обмена
									$rec['sum_kr']=0;
									$rec['sum_ekr']=0;
									$rec['sum_rep']=0;
									$rec['sum_kom']=0;
									$rec['item_id']=get_xitem_fid($old_art);
									$rec['item_name']=$old_art[name];
									$rec['item_count']=1;
									$rec['item_type']=$old_art[type];
									$rec['item_cost']=$old_art[cost];
									$rec['item_dur']=$old_art[duration];
									$rec['item_maxdur']=$old_art[maxdur];
									$rec['item_ups']=$old_art[ups];
									$rec['item_unic']=$old_art[unik];
									$rec['item_incmagic']=$old_art['includemagicname'];
									$rec['item_incmagic_count']=$old_art['includemagicuses'];
									$rec['add_info']='Возврат по отказу в обмене';
									add_to_new_delo($rec); //юзеру
									$add_str_oldart='Ваш артефакт "'.$old_art['name'].'" возвращен, при отказе в обмене ';


									//возврат репутации
//									$returnrep = 270000;
									$returnrep = 135000;
									//возращаем репу челу и пишем в дело
										$db_city[0]='oldbk.';
										$db_city[1]='avalon.';
										$db_city[2]='angels.';
									mysql_query("UPDATE {$db_city[$art_telo[id_city]]}users set repmoney=repmoney+{$returnrep} where id={$get_proto[owner]} and id_city={$art_telo[id_city]} ;");

									if (mysql_affected_rows()>0)
									{
									//пишем в дело о возврате репы
									//new_delo
									$rec=array();
				  		    			$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['owner_rep_do']=$art_telo['repmoney'];
									$rec['owner_rep_posle']=$art_telo['repmoney'] + $returnrep;
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=360;
									$rec['sum_kr']=0;
									$rec['sum_ekr']=0;
									$rec['sum_rep']=$returnrep;
									$rec['sum_kom']=0;
									$rec['item_id']='';
									$rec['item_name']=$get_proto[name];
									$rec['item_count']=1;
									$rec['item_type']=$get_proto[type];
									$rec['item_cost']=$get_proto[cost];
									$rec['item_dur']=$get_proto[duration];
									$rec['item_maxdur']=$get_proto[maxdur];
									$rec['item_ups']=$get_proto[ups];
									$rec['item_unic']=$get_proto[unik];
									$rec['item_incmagic']='';
									$rec['item_incmagic_count']='';
									$rec['item_arsenal']='';
									$rec['bank_id']='';
									$rec['add_info']='Счет №'.$get_proto[id];
									add_to_new_delo($rec); //юзеру
									$add_str_oldart.='. Возвращено '.$returnrep.' репутации';
									}





									if ($art_telo['odate'] > (time()-60) )
												{
												addchp('<font color=red>Внимание!</font> '.$add_str_oldart.', счет №'.$get_proto[id],'{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
												} else {
												mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> ".$add_str_oldart.", счет №".$get_proto[id].".');");
												}
		  						}
		  						else
		  						{
		  						 echo "Ошибка: Старый артефакт не найден!";
		  						}



		  		}
		  		else
		  		{
		  		//оплата грязной аля вексель
		  		//возврат векселя
		  			$dress = mysql_query('SELECT * FROM oldbk.shop WHERE id = 3005000') or die();
					$dress = mysql_fetch_assoc($dress);
					if ($dress !== FALSE) {
						mysql_query("INSERT INTO oldbk.`inventory`
							(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
							`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
							`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
							`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`,`present`
							)
							VALUES
							('{$dress['id']}','{$art_telo['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
							'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
							'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
							,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','0','Коммерческий отдел'
							);
						") or die();

						//new_delo
						$rec = array();
	  		    			$rec['owner']=$art_telo[id];
						$rec['owner_login']=$art_telo[login];
						$rec['owner_balans_do']=$art_telo['money'];
						$rec['owner_balans_posle']=$art_telo['money'];
						$rec['target_login']="КО";
						$rec['type']=99; // получил предмет
						$rec['sum_kr']=0;
						$rec['sum_ekr']=0;
						$rec['sum_kom']=0;
						$rec['item_id']=get_xitem_fid(array("idcity" => $art_telo['id_city'], "id" => mysql_insert_id()));
						$rec['item_name']=$dress[name];
						$rec['item_count']=1;
						$rec['item_type']=$dress['type'];
						$rec['item_cost']=$dress['cost'];
						$rec['item_dur']=$dress['duration'];
						$rec['item_maxdur']=$dress['maxdur'];
						$rec['item_ups']=$dress['ups'];
						$rec['item_unic']=$dress['unic'];
						$rec['item_incmagic']=$dress['includemagicname'];
						$rec['item_incmagic_count']=$dress['includemagicuses'];
						$rec['item_arsenal']='';
						$rec['item_proto']=$dress['prototype'];
						$rec['item_sowner']=($dress['sowner']>0?1:0);
						$rec['item_incmagic_id']=$dress['includemagic'];
						if (add_to_new_delo($rec) === FALSE) die();

						serr("- успешно выдан ".$dress['name']);
						systemtotelo($art_telo,"Успешно выдан ".$dress['name']);
					}



		  		}


			if ($art_telo['odate'] > (time()-60) )
			{
			addchp('<font color=red>Внимание!</font> Вам отказано в создании '.$str_type.', счет №'.$get_proto[id].'. Причина:'.mysql_real_escape_string($_GET[coment]).'.','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
			} else {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вам отказано в создании {$str_type}, счет №".$get_proto[id].". Причина:".mysql_real_escape_string($_GET[coment]).".');");
			}

			if ($get_proto['battle'] == 1) {
				/*
				$us = $art_telo;

				// возвращаем ваучер 15 екр

				$t = mysql_query('select * from oldbk.eshop where id = 100015') or die();
				$dress = mysql_fetch_array($t);
				if ($dress['id'] > 0) {
					mysql_query("INSERT INTO oldbk.`inventory`
						(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,
						`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
						`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
						`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
						)
						VALUES
						('{$dress['id']}','{$us['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
						'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
						'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
						,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$us['id']}'
						);
						") or die();

					//new_delo
					$rec = array();
					$rec['owner']=$us[id];
					$rec['owner_login']=$us[login];
					$rec['owner_balans_do']=$us['money'];
					$rec['owner_balans_posle']=$us['money'];
					$rec['target_login']="КО";
					$rec['type']=280;//получил ваучер
					$rec['sum_kr']=0;
					$rec['sum_ekr']=15;
					$rec['sum_kom']=0;
					$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => mysql_insert_id()));
					$rec['item_name']=$dress[name];
					$rec['item_count']=1;
					$rec['item_type']=$dress['type'];
					$rec['item_cost']=$dress['cost'];
					$rec['item_dur']=$dress['duration'];
					$rec['item_maxdur']=$dress['maxdur'];
					$rec['item_ups']=$dress['ups'];
					$rec['item_unic']=$dress['unic'];
					$rec['item_incmagic']=$dress['includemagicname'];
					$rec['item_incmagic_count']=$dress['includemagicuses'];
					$rec['item_arsenal']='';
					$rec['bank_id']='';
					$rec['item_proto']=$dress['prototype'];
					$rec['item_sowner']=($dress['sowner']>0?1:0);
					$rec['item_incmagic_id']=$dress['includemagic'];
					if (add_to_new_delo($rec) === FALSE) die();
				}
				*/
			}


//		mysql_query("DELETE FROM oldbk.art_prototype where id='{$get_proto[id]}' and art_status=-1;");
		mysql_query("UPDATE oldbk.art_prototype set art_status=100, `art_moder`='{$user}' , `art_mod_date`=NOW() , del_comm='".mysql_real_escape_string($_GET['coment'])."'  where id='{$get_proto[id]}' and art_status=-1;");
		if (mysql_affected_rows()>0)
					{
					//удаляем картинку с сервера
					unlink('./upload/'.$get_proto[img]);
					echo "<br><font color=red>Счет удачно удален!</font>";
					}
					else
					{
					echo "<br><font color=red>Ошибка удаления!</font>";
					}


		} else { echo "<br><font color=red>Такой счет не найден !</font>"; }



		}
		else
 		if ($_GET[no_id])
 		{
		$view_form_look=0;
		echo "<br><br>Отказ счета №".(int)($_GET[no_id]);
 		echo "<form method=GET>";
 		echo "<input type=hidden name=act value='look_art_prep_mod'>";
 		echo "<input type=hidden name=no_id value='".(int)($_GET[no_id])."'>";
 		echo " Комментарий: <input type=text name=coment>";
 		echo "<input type=submit name=send value='Отказать в создании артефакта'>";
 		}
 		else if ($_GET[yes_id])
 		 {
 		 $_GET[yes_id]=(int)($_GET[yes_id]);
 		  //ставим флаг что утвержден рассмотрен и можно оплачивать
 		  $get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$_GET[yes_id]}' and art_status=-1 and art_mess=0 ;"));

			if ($get_proto)
		    {
			if ($get_proto[owner]==22125)
		 	{
 			 	 echo "Ошибка: Арт данного типа не может быть клановым!";
			}
			else
			{
			mysql_query("UPDATE oldbk.art_prototype SET art_status=1 where id='{$get_proto[id]}' and art_status=-1 and art_mess=0 ; ");
			}

		   }
		    else
		     {
		     echo "<br><font color=red>Такой счет не найден или уже одобрен!</font>";
		     }



 		 }


	if ($view_form_look==1)
	   {
		$get_ut_arts=mysql_query("select * from oldbk.art_prototype where art_status=-1 and (repcost>0 OR veks_flag>0) order by battle DESC, art_zakdate DESC");
		$j=0;
		while ($row=mysql_fetch_array($get_ut_arts))
		{
		$j++;
		echo "<table border=0>";
		ShowAitAdmin($row,4);
		echo "</table>";
		echo "<hr>";
		}
		if ($j==0) { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	   }
	}



else if (($act=='look_art_hist') /*and ($user != "Мастер")*/)
	{
	echo "<div align=center><h3>История утвержденных артефактов</h3></div><br><br>";

	if  ((isset($_POST['field'])) and (isset($_POST['search'])))
		{
		//	print_r($_POST);
		$get_all_a=mysql_fetch_array(mysql_query("select count(*) from oldbk.art_prototype where art_status>1 and owner=(select id from oldbk.users where login='".mysql_real_escape_string($_POST['search'])."' )  "));
		echo "Поиск по нику:<b>".$_POST['search']."</b><br>";
		}
		else
		{
		$get_all_a=mysql_fetch_array(mysql_query("select count(*) from oldbk.art_prototype where art_status>1  "));
		}



	$st=(int)($_GET[p]);
	 if ($st>$get_all_a) { $st=0; }

	if ($get_all_a[0] > 0)
		{

			if  ((isset($_POST['field'])) and (isset($_POST['search'])))
			{
			$get_ut_arts=mysql_query("select * from oldbk.art_prototype where art_status>1 and owner=(select id from oldbk.users where login='".mysql_real_escape_string($_POST['search'])."' )   order by art_zakdate DESC ");
			$view_all=true;
			}
			else
			{
			$get_ut_arts=mysql_query("select * from oldbk.art_prototype where art_status>1  order by art_zakdate DESC LIMIT ".($st*10).",10 ");
			}


		$j=0;
		while ($row=mysql_fetch_array($get_ut_arts))
		{
		$j++;
		echo "<table border=0>";
		ShowAitAdmin($row,3);
		echo "</table>";
		echo "<hr>";
		}


			$pcs=0;

			if ($view_all!=true)
				{
					$allp=(int)($get_all_a[0]/10);
					if ($allp<($get_all_a[0]/10)) { $allp++;}
					echo "Страницы: ";
					for ($jj=1;$jj<=($allp);$jj++)
						{
						 if ($st==($jj-1))
						 	{
							echo "<b>[{$jj}]</b> ";
							}
							else
							{
							$pcs++;
								if (($jj>$st-10) and ($jj<$st+10) )
									{
									echo "<a href=?act=look_art_hist&p=".($jj-1).">[".$jj."]</a> ";
									}
							}

						}
						echo "... <a href=?act=look_art_hist&p=".($jj-1).">[".$jj."]</a> ";
				}

		}
		else { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	}
else if (($act=='look_art_hist_del') /*and ($user != "Мастер")*/)
	{
	echo "<div align=center><h3>История удаленных артефактов</h3></div><br><br>";
	$get_all_a=mysql_fetch_array(mysql_query("select count(*) from oldbk.art_prototype where art_status=100"));
	$st=(int)($_GET[p]);
	 if ($st>$get_all_a) { $st=0; }

	if ($get_all_a[0] > 0)
		{
		$get_ut_arts=mysql_query("select * from oldbk.art_prototype where art_status=100 order by art_zakdate DESC LIMIT ".($st*10).",10 ");
		$j=0;
		while ($row=mysql_fetch_array($get_ut_arts))
		{
		$j++;
		echo "<table border=0>";
		ShowAitAdmin($row,3);
		echo "</table>";
		echo "<hr>";
		}

		$allp=(int)($get_all_a[0]/10);
		if ($allp<($get_all_a[0]/10)) { $allp++;}
		echo "Страницы: ";
		for ($jj=1;$jj<=($allp);$jj++)
			{
			 if ($st==($jj-1))
			 	{
				echo "<b>[{$jj}]</b> ";
				}
				else
				{
				echo "<a href=?act=look_art_hist_del&p=".($jj-1).">[".$jj."]</a> ";
				}

			}

		}
		else { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	}
else if ($act=='look_img_mod')
	{
	$view_form_look=1;
			echo "<div align=center><h3>Картинки,образы,подарки на утверждение</h3></div><br><br>";

			if ($_GET[yes])
				{
				$sc_id=(int)($_GET[yes]);
				//1. Ищем
				$get_sev=mysql_fetch_array(mysql_query("select  *, UNIX_TIMESTAMP(mtime) as mtimeunix from oldbk.com_service where stat=1 and id='{$sc_id}' and (isnull(group_id) OR group_id=id)  "));
				if ($get_sev[id]>0)
					{
				///1.1 данные по заказчику
				$img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_sev[owner]."'  ;"));
				 if ($img_telo[id_city]==1) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$img_telo[id]."'  ;")); }
				 elseif ($img_telo[id_city]==2) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$img_telo[id]."'  ;")); }


						//2. определяем что за тип
						if (($get_sev[type]>=1) AND ($get_sev[type] <=4) )
						{
						//Устанавливаем	 сувениры
						//закачиваем на клауд картинку
						 CloudPut('./uploadimg/'.$get_sev[img],'oldbkstatic','i/sh/');
						 CloudSetACL('oldbkstatic','i/sh/',$get_sev[img],"public");
						//получаем новый ид для сувенира
						$new_suv_id=GetSuvenirID();

							if (($get_sev[type]==1) OR ($get_sev[type]==2))
							{

							if ($get_sev[target]!='')
								{
								$suv_owner=$get_sev[target];
								}
								else
								{
								$suv_owner=$get_sev[owner];
								}
							}
							else
							{
							$suv_owner=0;
							}

							if (($get_sev[type]==3) OR ($get_sev[type]==4))
							{
							$get_klan_name=mysql_fetch_array(mysql_query("select * from oldbk.clans where id='{$get_sev[klan_id]}'"));
							$suv_klan=$get_klan_name[short];
							}
							else
							{
							$suv_klan='';
							}

						//определяем цену для магазина
							if ($PRICE[$get_sev[type]][anim]==true)
								{
								$ppc=20;
								}
								else
								{
								$ppc=10;
								}


						$action=1;
    						if ((time()>$KO_start_time2) and (time()<$KO_fin_time2)) {
    							$action=2;
    						}

						$ncount = round(($PRICE[$get_sev['type']]['cost']*$action*EKR_TO_KR) / 50);
						mysql_query("INSERT INTO oldbk.eshop  (id,name,maxdur,cost,ecost,img,count,avacount,angcount,type,massa,razdel,owner,klan,isrep,goden,ekr_flag) VALUES  ('".$new_suv_id."','".$get_sev[param]."','1','{$ppc}','0','".$get_sev[img]."','".$ncount."','".$ncount."','".$ncount."','200','0.1','72','".$suv_owner."','".$suv_klan."','0','0','0');");
						$OK=1;
						//удаляем
						unlink('./uploadimg/'.$get_sev[img]);
						}
						else if (($get_sev[type]>=5) AND ($get_sev[type] <=10) )
							{
							//работа с образами

							if (($get_sev[type]==5) OR ($get_sev[type]==6))
								{
							//личные
							//закачиваем на клауд картинку
						 	CloudPut('./uploadimg/'.$get_sev[img],'oldbkstatic','i/shadow/');
						 	CloudSetACL('oldbkstatic','i/shadow/',$get_sev[img],"public");
							$no_gif=explode(".gif",$get_sev[img]);
							$no_gif=$no_gif[0];

								if ($get_sev[target]!='')
								{
								$obraz_owner=$get_sev[target];
								}
								else
								{
								$obraz_owner=$img_telo[id];
								}
							mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '{$no_gif}', sex=".$img_telo[sex].", owner=".$obraz_owner.", type=2;");
							//удаляем
							unlink('./uploadimg/'.$get_sev[img]);
								}
							else if (($get_sev[type]==7) OR ($get_sev[type]==9))
								{
								//клановый 1 штука или м или Ж
								$no_gif=explode(".gif",$get_sev[img]);
								$no_gif=$no_gif[0];
								//закачиваем на клауд картинку
								 if ($get_sev[param]=='Ж')
								 	{
								 	$sex_pref='g';
									mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '".$no_gif."', sex=0, klan=".$get_sev[klan_id].", type=1;");
								 	}
								 	else
								 	{
								 	$sex_pref='m';
			 						mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '".$no_gif."', sex=1, klan=".$get_sev[klan_id].", type=1;");
								 	}
								//переименовываем локально для закачки
								rename('./uploadimg/'.$get_sev[img],'./uploadimg/'.$sex_pref.$get_sev[img]);
							 	CloudPut('./uploadimg/'.$sex_pref.$get_sev[img],'oldbkstatic','i/shadow/');
							 	CloudSetACL('oldbkstatic','i/shadow/',$sex_pref.$get_sev[img],"public");
								//удаляем
								unlink('./uploadimg/'.$sex_pref.$get_sev[img]);
								}
								else if (($get_sev[type]==8) OR ($get_sev[type]==10))
								{
								//клановый 2 штуки и М и Ж
									$no_gif=explode(".gif",$get_sev[img]);
									$no_gif=$no_gif[0];
									//переименовываем локально для закачки
								rename('./uploadimg/'.$get_sev[img],'./uploadimg/'."m".$get_sev[img]);
							 	CloudPut('./uploadimg/'."m".$get_sev[img],'oldbkstatic','i/shadow/');
							 	CloudSetACL('oldbkstatic','i/shadow/',"m".$get_sev[img],"public");

								rename('./uploadimg/'."m".$get_sev[img],'./uploadimg/'."g".$get_sev[img]);
							 	CloudPut('./uploadimg/'."g".$get_sev[img],'oldbkstatic','i/shadow/');
							 	CloudSetACL('oldbkstatic','i/shadow/',"g".$get_sev[img],"public");

							 	//удаляем
								unlink('./uploadimg/'."g".$get_sev[img]);

								mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '".$no_gif."', sex=0, klan=".$get_sev[klan_id].", type=1;");
								mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '".$no_gif."', sex=1, klan=".$get_sev[klan_id].", type=1;");
								}
							$OK=1;
							}
						else if (($get_sev[type]==81) OR ($get_sev[type]==82))
							{
								//загружаем все оптовые
								$get_opt_img=mysql_query("select * from oldbk.com_service where stat=1 and group_id='{$get_sev[group_id]}'  ");
									while ($orow=mysql_fetch_array($get_opt_img))
									{
									$no_gif=explode(".gif",$orow[img]);
									$no_gif=$no_gif[0];
									//закачиваем на клауд картинку
									 if (($orow[param]==7) OR ($orow[param]==9))
									 	{
									 	$sex_pref='g';
										mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '".$no_gif."', sex=0, klan=".$orow[klan_id].", type=1;");
									 	}
									 	elseif (($orow[param]==107) OR ($orow[param]==109))
								 		{
									 	$sex_pref='m';
			 							mysql_query("INSERT INTO oldbk.users_shadows SET `name` = '".$no_gif."', sex=1, klan=".$orow[klan_id].", type=1;");
									 	}
									//переименовываем локально для закачки
									rename('./uploadimg/'.$orow[img],'./uploadimg/'.$sex_pref.$orow[img]);
								 	CloudPut('./uploadimg/'.$sex_pref.$orow[img],'oldbkstatic','i/shadow/');
								 	CloudSetACL('oldbkstatic','i/shadow/',$sex_pref.$orow[img],"public");
									//удаляем
									unlink('./uploadimg/'.$sex_pref.$orow[img]);
									$OK=1;
									}
							}
						else if ( (($get_sev[type]>=11) AND ($get_sev[type] <=16) ) OR ($get_sev[type]==603) OR ($get_sev[type]==602) OR ($get_sev[type]==600) OR ($get_sev[type]==601) OR ($get_sev[type]==83) OR ($get_sev[type]==612) OR ($get_sev[type]==613) OR ($get_sev[type]==614) )
							{
							//перезаливка
								if (($get_sev[type]==11) OR ($get_sev[type]==83))
								{
								//перезаливка образа личного
								//или перезаливка на анимацию 83
								$get_reload_img=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.users_shadows  where id='{$get_sev[param]}' ;"));
								if ($get_reload_img[id]>0)
									{
									//переименовываем локально для закачки
									rename('./uploadimg/'.$get_sev[img],'./uploadimg/'.$get_reload_img[name].'.gif');
									//заливаем
									CloudPut('./uploadimg/'.$get_reload_img[name].'.gif','oldbkstatic','i/shadow/');
									CloudSetACL('oldbkstatic','i/shadow/',$get_reload_img[name].'.gif',"public");
									CloudFlush('i/shadow/'.$get_reload_img[name].'.gif');
									$addtext='Новое изображение станет доступно через 24 часа.';
									$OK=1;
									unlink('./uploadimg/'.$get_reload_img[name].'.gif'); //удаляем с этого сервера
									}
								}
								else if ($get_sev[type]==12 || $get_sev[type]==612)
								{
								//Перезаливка кланового образа
								$get_reload_img=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.users_shadows  where id='{$get_sev[param]}' ;"));
								if ($get_reload_img[id]>0)
									{
										if ($get_reload_img[sex]==0)
										{
										$flushname = 'g'.$get_reload_img[name].'.gif';
										$img_need_name= './uploadimg/g'.$get_reload_img[name].'.gif';
										}
										else
										{
										$flushname = 'm'.$get_reload_img[name].'.gif';
										$img_need_name= './uploadimg/m'.$get_reload_img[name].'.gif';
										}
										rename('./uploadimg/'.$get_sev[img],$img_need_name);
									//заливаем
									CloudPut($img_need_name,'oldbkstatic','i/shadow/');
									CloudSetACL('oldbkstatic','i/shadow/',$flushname,"public");
									CloudFlush('i/shadow/'.$flushname);
									$addtext='Новое изображение станет доступно через 24 часа.';
									$OK=1;
									unlink($img_need_name); //удаляем с этого сервера
									}
								}
								else if (($get_sev[type]==13) OR ($get_sev[type]==14))
								{
									$get_reload_img=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.eshop  where id='{$get_sev[param]}'  ;"));
									if ($get_reload_img[id]>0)
										{
										rename('./uploadimg/'.$get_sev[img],'./uploadimg/'.$get_reload_img[img]);
										//заливаем
										CloudPut('./uploadimg/'.$get_reload_img[img],'oldbkstatic','i/sh/');
										CloudSetACL('oldbkstatic','i/sh/',$get_reload_img[img],"public");
										CloudFlush('i/sh/'.$get_reload_img[img]);
										$addtext='Новое изображение станет доступно через 24 часа.';
										$OK=1;
										unlink('./uploadimg/'.$get_reload_img[img]); //удаляем с этого сервера
										}
								}
								else if ($get_sev[type]==15 || $get_sev[type]== 600 || $get_sev[type]==601)
								{
								$get_reload_img=mysql_fetch_assoc(mysql_query("SELECT * FROM gellery where  id='{$get_sev[param]}'  ;"));
									if ($get_reload_img[id]>0)
										{
										rename('./uploadimg/'.$get_sev[img],'./uploadimg/'.$get_reload_img[img]);
										//заливаем
										CloudPut('./uploadimg/'.$get_reload_img[img],'oldbkstatic','i/sh/');
										CloudSetACL('oldbkstatic','i/sh/',$get_reload_img[img],"public");
										CloudFlush('i/sh/'.$get_reload_img[img]);
										$addtext='Новое изображение станет доступно через 24 часа.';
										$OK=1;
										unlink('./uploadimg/'.$get_reload_img[img]); //удаляем с этого сервера
										}
								}
								else if ($get_sev[type]== 613 || $get_sev[type]==614)
								{
								$get_reload_img=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.inventory WHERE id='{$get_sev[param]}' AND owner='{$get_sev[owner]}'  AND setsale=0 AND bs_owner=0  AND sowner = '{$get_sev[owner]}'  AND arsenal_klan='' AND art_param !=''  "));
									if ($get_reload_img[id]>0)
										{
										rename('./uploadimg/'.$get_sev[img],'./uploadimg/'.$get_reload_img[img]);
										//заливаем
										CloudPut('./uploadimg/'.$get_reload_img[img],'oldbkstatic','i/sh/');
										CloudSetACL('oldbkstatic','i/sh/',$get_reload_img[img],"public");
										CloudFlush('i/sh/'.$get_reload_img[img]);
										$addtext='Новое изображение станет доступно через 24 часа.';
										$OK=1;
										unlink('./uploadimg/'.$get_reload_img[img]); //удаляем с этого сервера
										}
								}
								else if ($get_sev[type]==16 || $get_sev[type]==602 || $get_sev[type]==603)
								{
								$get_reload_img=mysql_fetch_assoc(mysql_query("SELECT * FROM gellery_prot where  id='{$get_sev[param]}}'  ;"));
									if ($get_reload_img[id]>0)
										{
										rename('./uploadimg/'.$get_sev[img],'./uploadimg/'.$get_reload_img[img]);
										//заливаем
										CloudPut('./uploadimg/'.$get_reload_img[img],'oldbkstatic','i/sh/');
										CloudSetACL('oldbkstatic','i/sh/',$get_reload_img[img],"public");
										CloudFlush('oldbkstatic','i/sh/'.$get_reload_img[img]);
										$addtext='Новое изображение станет доступно через 24 часа.';
										$OK=1;
										unlink('./uploadimg/'.$get_reload_img[img]); //удаляем с этого сервера
										}

								}




							}
						else if ( (($get_sev[type]>=17) AND ($get_sev[type] <=20) ) and ($get_sev[group_id]==$get_sev[id]) )
						{
						//оптовая закачка
							if (($get_sev[type]>=17) AND ($get_sev[type] <=18) )
								{
								//личн
								//загружаем все оптовые заявки
									$get_opt_img=mysql_query("select * from oldbk.com_service where group_id='{$get_sev[group_id]}'  ");
									while ($orow=mysql_fetch_array($get_opt_img))
										{
										if (($orow[param]==1031) or ($orow[param]==1131) or ($orow[param]==1231) )    {$orow[param]=31;}
										if (($orow[param]==1046) or ($orow[param]==1146) or ($orow[param]==1246) )    {$orow[param]=46;}

										if ($PRICE[$orow[param]][razdel] > 0)
											{
											CloudPut('./uploadimg/'.$orow[img],'oldbkstatic','i/sh/');
										 	CloudSetACL('oldbkstatic','i/sh/',$orow[img],"public");
										 	//ставим личную картинку чару.

										 	if ($orow[target]!='')
											{
										 	$owner_img=$orow[target];
											}
											else
											{
										 	$owner_img=$orow[owner];
										 	}

											mysql_query('insert into oldbk.gellery set owner="'.$owner_img.'",img="'.$orow[img].'", exp_date="1999999999",otdel="'.$PRICE[$orow[param]][razdel].'" ;');
											//удаляем
											$OK=1;
											unlink('./uploadimg/'.$orow[img]);
											}
											else
											{
											echo "Ошибка раздела!?...";
											}
										}
								}
								else if (($get_sev[type]>=19) AND ($get_sev[type] <=20) )
								{
								//клановые
								$get_opt_img=mysql_query("select * from oldbk.com_service where  group_id='{$get_sev[group_id]}'  ");
									while ($orow=mysql_fetch_array($get_opt_img))
										{
										if (($orow[param]==1061) or ($orow[param]==1161) or ($orow[param]==1261) )    {$orow[param]=61;}
										if (($orow[param]==1076) or ($orow[param]==1176) or ($orow[param]==1276) )    {$orow[param]=76;}
										if ($PRICE[$orow[param]][razdel] > 0)
											{
											CloudPut('./uploadimg/'.$orow[img],'oldbkstatic','i/sh/');
									 		CloudSetACL('oldbkstatic','i/sh/',$orow[img],"public");
										 	//добавили в клановую галерею
											mysql_query('insert into oldbk.gellery_prot set klan_owner="'.$orow[klan_id].'",img="'.$orow[img].'",exp_date="1999999999",otdel="'.$PRICE[$orow[param]][razdel].'";');
											//и каждому соклану в личку
											$data=mysql_query('select u.* from oldbk.users u left join oldbk.clans c  on u.klan = c.short 	where c.id="'.$get_sev[klan_id].'"');
									        	while($row=mysql_fetch_array($data))
									 		       {
							        				mysql_query('insert into oldbk.gellery set owner="'.$row[id].'",img="'.$orow[img].'",exp_date="1999999999",otdel="'.$PRICE[$orow[param]][razdel].'";');
							        			        }
											$OK=1;
											//удаляем
											unlink('./uploadimg/'.$orow[img]);
											}
											else
											{
											echo "Ошибка раздела!?...";
											}
										}
								}
						}
						else if ((($get_sev[type]>=21) AND ($get_sev[type] <=80)) || ($get_sev[type]>=500) AND ($get_sev[type] <=503))
							{
							//работа с изображением вещей
								if ((($get_sev[type]>=21) AND ($get_sev[type] <=50)) || ($get_sev[type]>=500) AND ($get_sev[type] <=503))
									{
									if ($PRICE[$get_sev[type]][razdel] > 0 )
										{
										//личные вещи чара
										//закачиваем на клауд картинку
									 	CloudPut('./uploadimg/'.$get_sev[img],'oldbkstatic','i/sh/');
									 	CloudSetACL('oldbkstatic','i/sh/',$get_sev[img],"public");
									 	//ставим личную картинку чару

									 	if ($get_sev[target]!='')
									 	{
									 	$owner_img=$get_sev[target];
									 	}
									 	else
									 	{
									 	$owner_img=$get_sev[owner];
									 	}

										if (($get_sev[type]>=500) AND ($get_sev[type] <=503)) {
											$u1 = check_users_city_data($get_sev[owner]);
											$u2 = check_users_city_data($u1['married']);

											if ($u1['married'] && $u2['married']) {
												if ($get_sev[type] == 500 || $get_sev[type] == 502) {
													// одна картинка на одного
													if ($get_sev[param] == "М") {
														if ($u1["sex"] == 1) {
															$owner_img = $u1['id'];
														}
														if ($u2["sex"] == 1) {
															$owner_img = $u2['id'];
														}
													}

													if ($get_sev[param] == "Ж") {
														if ($u1["sex"] == 0) {
															$owner_img = $u1['id'];
														}
														if ($u2["sex"] == 0) {
															$owner_img = $u2['id'];
														}
													}

													mysql_query('UPDATE oldbk.gellery set dressed = 0 WHERE owner = "'.$owner_img.'" and otdel = 99');
													mysql_query('insert into oldbk.gellery set owner="'.$owner_img.'", dressed = 1, img="'.$get_sev[img].'", exp_date="1999999999",otdel="'.$PRICE[$get_sev[type]][razdel].'" ;');
												}
												if ($get_sev[type] == 501 || $get_sev[type] == 503) {
													// одна картинка двоим
													mysql_query('UPDATE oldbk.gellery set dressed = 0 WHERE owner = "'.$u1['id'].'" and otdel = 99');
													mysql_query('UPDATE oldbk.gellery set dressed = 0 WHERE owner = "'.$u2['id'].'" and otdel = 99');

													mysql_query('insert into oldbk.gellery set owner="'.$u1['id'].'", dressed = 1, img="'.$get_sev[img].'", exp_date="1999999999",otdel="'.$PRICE[$get_sev[type]][razdel].'" ;');
													mysql_query('insert into oldbk.gellery set owner="'.$u2['id'].'", dressed = 1, img="'.$get_sev[img].'", exp_date="1999999999",otdel="'.$PRICE[$get_sev[type]][razdel].'" ;');
												}
											}
										} else {
											mysql_query('insert into oldbk.gellery set owner="'.$owner_img.'",img="'.$get_sev[img].'", exp_date="1999999999",otdel="'.$PRICE[$get_sev[type]][razdel].'" ;');
										}

										$OK=1;
										//удаляем
										unlink('./uploadimg/'.$get_sev[img]);
										}
										else
										{
										echo "Ошибка раздела!?...";
										}
									}
								else if (($get_sev[type]>=51) AND ($get_sev[type] <=80) )
									{
									// fix раздел
									if ($PRICE[$get_sev[type]][razdel] > 0 )
										{
										//клановые картинки на шмотки
										//закачиваем на клауд картинку
									 	CloudPut('./uploadimg/'.$get_sev[img],'oldbkstatic','i/sh/');
									 	CloudSetACL('oldbkstatic','i/sh/',$get_sev[img],"public");
									 	//добавили в клановую галерею
										mysql_query('insert into oldbk.gellery_prot set klan_owner="'.$get_sev[klan_id].'",img="'.$get_sev[img].'",exp_date="1999999999",otdel="'.$PRICE[$get_sev[type]][razdel].'";');
										//и каждому соклану в личку
										$data=mysql_query('select u.* from oldbk.users u left join oldbk.clans c  on u.klan = c.short 	where c.id="'.$get_sev[klan_id].'"');
									        	while($row=mysql_fetch_array($data))
								 		       {
						        				mysql_query('insert into oldbk.gellery set owner="'.$row[id].'",img="'.$get_sev[img].'",exp_date="1999999999",otdel="'.$PRICE[$get_sev[type]][razdel].'";');
						        			        }
										$OK=1;
										//удаляем
										unlink('./uploadimg/'.$get_sev[img]);
										}
										else
										{
										echo "Ошибка раздела!?...";
										}
									}
							}
							else if ($get_sev[type]==90)
							{
							//смайлики личные
							// кидаем в базу и получаем нов.ид
								if ($get_sev[target]!='')
									{
									$owner_img=$get_sev[target];
								 	}
								 	else
								 	{
								 	$owner_img=$get_sev[owner];
								 	}
							//размеры картинки
								$type_upload = GetImageSize('./uploadimg/'.$get_sev[img]);
								if (($type_upload[0]>1)	and ($type_upload[1]>1))
								{
								mysql_query("INSERT INTO `oldbk`.`smiles` SET `owner`='{$owner_img}',`name`='".time()."',`w`='{$type_upload[0]}',`h`='{$type_upload[1]}',`klan`='';");
									$smile_id=mysql_insert_id();
									if ($smile_id>1)
										{
										mysql_query("UPDATE `oldbk`.`smiles` SET `name`='sm{$smile_id}' WHERE `id`='{$smile_id}';");
											if (mysql_affected_rows()>0)
											{
											//переименовываем
											rename('./uploadimg/'.$get_sev[img],'./uploadimg/sm'.$smile_id.'.gif');
											//заливаем
											CloudPut('./uploadimg/sm'.$smile_id.'.gif','oldbkstatic','i/smiles/');
											CloudSetACL('oldbkstatic','i/smiles/','sm'.$smile_id.'.gif',"public");
											$OK=1;
											unlink('./uploadimg/sm'.$smile_id.'.gif'); //удаляем с этого сервера
											//поправляем в заказе название картинки
											mysql_query("UPDATE `oldbk`.`com_service` SET `img`='sm{$smile_id}.gif' WHERE `id`='{$get_sev[id]}';");
											}
											else
											{
										 	echo "Ошиба обновления данных в таблице смайлов!";
											}

										}
										else
										{
										 echo "Ошиба вставки данных в таблицу смайлов!";
										}
								}
								else
								{
								echo "Ошибка изображения!";
								}


							} else if ($get_sev[type]==102) {
								$us = check_users_city_data($get_sev['owner']);
								if (strlen($us['klan'])) {
									if ($get_sev['param'] == "small") {
										$newfn = $us['klan'].".gif";
										CloudPut("./uploadimg/".$get_sev['img'],'oldbkstatic','i/klan/'.$newfn);
										CloudSetACL('oldbkstatic','i/klan/',$newfn,"public");
									} elseif ($get_sev['param'] == "big") {
										$newfn = $us['klan']."_big.gif";
										CloudPut("./uploadimg/".$get_sev['img'],'oldbkstatic','i/klan/'.$newfn);
										CloudSetACL('oldbkstatic','i/klan/',$newfn,"public");
									}
                                                                        unlink('./uploadimg/'.$get_sev['img']);
									$OK = 1;
								} else {
									echo "Персонаж не в клане!";
								}
							} else if ($get_sev[type]==91)
							{
							//смайлики личные
							// кидаем в базу и получаем нов.ид
							//размеры картинки
								$type_upload = GetImageSize('./uploadimg/'.$get_sev[img]);
								if (($type_upload[0]>1)	and ($type_upload[1]>1))
								{
									$get_klan_name=mysql_fetch_array(mysql_query("select * from oldbk.clans where id='{$get_sev[klan_id]}'"));
									 if ($get_klan_name[id]>0)
									 {
									mysql_query("INSERT INTO `oldbk`.`smiles` SET `owner`='0',`name`='".time()."',`w`='{$type_upload[0]}',`h`='{$type_upload[1]}',`klan`='{$get_klan_name[short]}';");
									$smile_id=mysql_insert_id();
									if ($smile_id>1)
										{
										mysql_query("UPDATE `oldbk`.`smiles` SET `name`='sm{$smile_id}' WHERE `id`='{$smile_id}';");
											if (mysql_affected_rows()>0)
											{
											//переименовываем
											rename('./uploadimg/'.$get_sev[img],'./uploadimg/sm'.$smile_id.'.gif');
											//заливаем
											CloudPut('./uploadimg/sm'.$smile_id.'.gif','oldbkstatic','i/smiles/');
											CloudSetACL('oldbkstatic','i/smiles/','sm'.$smile_id.'.gif',"public");
											$OK=1;
											unlink('./uploadimg/sm'.$smile_id.'.gif'); //удаляем с этого сервера
											//поправляем в заказе название картинки
											mysql_query("UPDATE `oldbk`.`com_service` SET `img`='sm{$smile_id}.gif' WHERE `id`='{$get_sev[id]}';");
											}
											else
											{
										 	echo "Ошиба обновления данных в таблице смайлов!";
											}

										}
										else
										{
										 echo "Ошиба вставки данных в таблицу смайлов!";
										}
									}
									else
									{
									 echo "Ошиба такой клан не найден в базе!";
									}
								}
								else
								{
								echo "Ошибка изображения!";
								}


							}
							else
							{
							echo "<font color=red>Данный тип заявки не определен!</font>";
							}




					 if ($OK==1)
					 	{
						//отправлем телегу о том что удачно обработали
						if ($img_telo['odate'] > (time()-60) )
						{
						addchp('<font color=red>Внимание!</font> Ваш запрос в Коммерческий отдел №SC'.$get_sev[id].' - '.$PRICE[$get_sev[type]][desc].' - одобрен. '.$addtext.'  ','{[]}'.$img_telo['login'].'{[]}',$img_telo['room'],$img_telo['id_city']);
						} else {
						mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$img_telo['id']."','','<font color=red>Внимание!</font> Ваш запрос в Коммерческий отдел №SC{$get_sev[id]} - ".$PRICE[$get_sev[type]][desc]." - одобрен.".$addtext."');");
						}
						//обновляемся
						 if ($get_sev[group_id]>0)
						 {
						mysql_query("UPDATE oldbk.com_service set stat=2, moder='{$_SESSION['uid']}' where  group_id='{$sc_id}'");
						 }
						 else
						 {
						mysql_query("UPDATE oldbk.com_service set stat=2, moder='{$_SESSION['uid']}' where id='{$sc_id}'");
						 }

					  	echo "<font color=red>Запрос  удачно одобрен!</font>";
					  	//тут вешаем бонус на установку всех изображений


								/*
								  if ($get_sev['cost_type']!=6) // оплата не ваучерами
								  {
								  //смотрим не текущую дату , а время создания заявки в юних формате

							  		if ( (($get_sev['mtimeunix']>$KO_start_time2) and ($get_sev['mtimeunix']<$KO_fin_time2)) and ($get_sev['cost_type']==1) and ($get_sev['klan_id']>0) )
							  		{
							  		//была оплата из клан казны бонус туда
						  			set_bonus_ekr_kazna($img_telo,$get_sev);
							  		}
								  	elseif (($get_sev['mtimeunix']>$KO_start_time2) and ($get_sev['mtimeunix']<$KO_fin_time2))
									{
									set_bonus_ekr($img_telo,$get_sev);
									}
									else
										{
									//	echo "Не бонус";
										}
								  }
								  */

					  	}
					}
				}
			else if ($_GET[no])
				{

				if ($_GET[coment])
					{

					//1. ищим
					$sc_id=(int)($_GET[no]);
					$get_sev=mysql_fetch_array(mysql_query("select * from oldbk.com_service where stat=1 and id='{$sc_id}' and (isnull(group_id) OR group_id=id) "));
					if ($get_sev[id]>0)
						{
							//2. определяем тип оплаты
							if (($get_sev[cost_type]==1) and  ($get_sev[klan_id]>0))   //Казна клана
							{
								//ищим клан
								//$get_test_clan=mysql_fetch_array(mysql_query("select * from clans where id='{$get_sev[klan_id]}'"));
								mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr+{$get_sev[cost]}  WHERE `clan_id` = '{$get_sev[klan_id]}'  ;");
								if (mysql_affected_rows()>0)
								  	{
									$txt="Возврат {$get_sev[cost]} екр. при отказе по счету Коммерческого отдела №SC{$get_sev[id]}. Причина:".mysql_real_escape_string($_GET[coment]);
							           	mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)   VALUES  ('2','2','{$get_sev[klan_id]}','{$_SESSION['uid']}','".$txt."','".time()."');");
	  								$send=1;
								  	}
								  	else
								  	{
									echo "<font color=red>Ошибка возврата в клан казну!</font>";
								  	}

							}
							else if (($get_sev[cost_type]==6))   // вернуть сертификат
							{
								$item = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.inventory WHERE owner = 453 and id = '.$get_sev['addinfo']));
								if ($item) {
									$goden='';
									if ($item['add_time']<(time()+604800))
										{
										//был срок годности который окончинтся меньше чем за 7 дней
										// то ставим новый на 7 дней
										$goden=" , dategoden='".(time()+604800)."' , goden=7  "; //7 д.
										}
										else
										{
										$goden=" , dategoden='".$item['add_time']."' , goden='".round(($item['add_time']-time())/60/60/24)."'  "; //старая дата
										}

									mysql_query("UPDATE oldbk.inventory SET owner = ".$get_sev['owner']." ".$goden."  WHERE owner = 453 and id = ".$item['id']);
									if (mysql_affected_rows()>0) {
										$send = 1;
										$add_string="Возвращен сертификат (".$item['id'].")";

										$us = check_users_city_data($get_sev['owner']);

										$rec = array();
							    			$rec['owner']=$us[id];
										$rec['owner_login']=$us[login];
										$rec['owner_balans_do']=$us['money'];
										$rec['owner_balans_posle']=$us['money'];
										$rec['owner_rep_do']=$us['repmoney'];
										$rec['target_login'] = "КО";
										$rec['owner_rep_posle']=$us['repmoney'];
										$rec['item_id'] = get_xitem_fid($item);
										$rec['type'] = 389;
										if (add_to_new_delo($rec) === FALSE) die();

									} else {
										echo "<font color=red>Ошибка базы возврата сертификата, сертификат не найден!</font>";
									}
								} else {
									echo "<font color=red>Ошибка возврата сертификата, сертификат не найден!</font>";
								}
							}
							else if ($get_sev[cost_type]==3)
								{ //отказ монетами
								$us = check_users_city_data($get_sev['owner']);

								if ($get_sev[cost_gold]>0)
									{
									//если есть данные то возврат по данным
									$pr = $get_sev[cost_gold];
									}
									else
									{
									//если нет то по курсу
									$pr = ($get_sev[cost]*$EKR_TO_GOLD);
									}

								mysqL_query('UPDATE oldbk.users SET gold = gold + '.$pr.' WHERE id = '.$us['id'].' LIMIT 1');

								$rec['owner']=$us[id];
								$rec['owner_login']=$us[login];
								$rec['owner_balans_do']=$us[money];
								$rec['owner_balans_posle']=$us[money];
								$rec['target']=0;
								$rec['target_login']='КО';
								$rec['type']=506;
								$rec['sum_kr']=0;
								$rec['sum_ekr']=0;
								$rec['sum_kom']=0;
								$rec['add_info'] = $pr."/".($us['gold']);
								add_to_new_delo($rec);
								$send = 1;
								$add_string='Монеты возвращены.';
							} else if ($get_sev[cost_type]==2)   //Банк игры
							{
							//возврат в банк
							//1. ищим счет в банке чара на который надо отправить деньги
							  if ($get_sev[bank]>0)
							  	{
								$get_bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  owner='{$get_sev[owner]}' and id='{$get_sev[bank]}' LIMIT 1;"));
								}
								else
								{
								$get_bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  owner='{$get_sev[owner]}' LIMIT 1;"));
								}

								if ($get_bank[id] > 0)
									{
									//отправляем
									mysql_query("UPDATE oldbk.bank set ekr=ekr+{$get_sev[cost]} where id='{$get_bank[id]}' and owner='{$get_sev[owner]}'  ; ");
				      	  				   	if (mysql_affected_rows()>0)
				      	  				   		{
				      	  				   		//все ок пишим в хистори
				      	  				   		mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе  услуг Коммерческого отдела  №<b>SC{$get_sev[id]} , Сумма: {$get_sev[cost]} екр.</b>, <i>(Итого: ".($get_bank[ekr]+$get_sev[cost])." екр.)</i>','{$get_bank[id]}');");
				      	  				   		$isbank=1;
				      	  				   		$send=1;
				      	  				   		}
											else
											{
											echo "<font color=red>Ошибка возврата в банк!</font>";
											}

									}
									else
									{
									echo "<font color=red>Ошибка возврата в банк у чара нет счета в банке!</font>";
									}

							}
							else if  ($get_sev[cost_type]==5)    //была оплата ваучерами
							{
							//echo "TEST 5";
							////////////////////////////////////////////////////
							$img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_sev[owner]."'  ;"));
							 if ($img_telo[id_city]==1) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$img_telo[id]."'  ;")); }
							 elseif ($img_telo[id_city]==2) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$img_telo[id]."'  ;")); }

							$vch = array (	5   => 100005,	15  => 100015,	20  => 100020,	25  => 100025,	40  => 100040,	100 => 100100,	200 => 100200,	300 => 100300	);

							$retmoney = $get_sev[cost] ;//сколько вернуть
							$nominals = array(300,200,100,40,25,20,15,5);
							$newret = array();

									while(list($k,$v) = each($nominals))
									{
										$z = floor($retmoney / $v);
										if ($z > 0) {
											$newret[$v] = $z;
											$retmoney = $retmoney - ($z*$v);
										}
									}

							$vdress = array();
							$nomlist = "";
							while(list($k,$v) = each($newret))
							{
										if (!isset($vdress[$k]))
										{
											$t = mysql_query('select * from oldbk.eshop where id = '.$vch[$k]) or die();
											$vdress[$k] = mysql_fetch_array($t);
										}
							$dress = $vdress[$k];
							if ($dress['id'] > 0)
							{
							for($i = 0; $i < $v; $i++)
								{
									$nomlist .= $k."екр, ";
									mysql_query("INSERT INTO oldbk.`inventory`
									(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
									`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
									`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
									`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
									)
									VALUES
									('{$dress['id']}','{$img_telo[id]}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
									'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
									'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
									,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$img_telo[id]}'
									);
								") or die();

								//new_delo
								$rec = array();
			  		    			$rec['owner']=$img_telo[id];
								$rec['owner_login']=$img_telo[login];
								$rec['owner_balans_do']=$img_telo['money'];
								$rec['owner_balans_posle']=$img_telo['money'];
								$rec['target_login']="КО";
								$rec['type']=283;//получил ваучер при отказе
								$rec['sum_kr']=0;
								$rec['sum_ekr']=$k;
								$rec['sum_kom']=0;
								$rec['item_id']=get_xitem_fid(array("idcity" => $img_telo['id_city'], "id" => mysql_insert_id()));
								$rec['item_name']=$dress[name];
								$rec['item_count']=1;
								$rec['item_type']=$dress['type'];
								$rec['item_cost']=$dress['cost'];
								$rec['item_dur']=$dress['duration'];
								$rec['item_maxdur']=$dress['maxdur'];
								$rec['item_ups']=$dress['ups'];
								$rec['item_unic']=$dress['unic'];
								$rec['item_incmagic']=$dress['includemagicname'];
								$rec['item_incmagic_count']=$dress['includemagicuses'];
								$rec['item_arsenal']='';
								$rec['bank_id']='';
								$rec['add_info']='Возврат при отказе в Коммерческом отделе';
								$rec['item_proto']=$dress['prototype'];
								$rec['item_sowner']=($dress['sowner']>0?1:0);
								$rec['item_incmagic_id']=$dress['includemagic'];
								if (add_to_new_delo($rec) === FALSE) die();
								$send=1;

								if (strlen($nomlist))
								{
		 					 	$nomlist = substr($nomlist,0,strlen($nomlist)-2);
								serr("- успешно выдана сдача - ваучер(ы) на ".$nomlist);
								$add_string="Возвращены ваучер(ы) на ".$nomlist;
								}



								}
							   }
							}





							////////////////////////////////////////////////////
							}
							else
							{
							echo "<font color=red>Ошибка типа оплаты!</font>";
							}

						//чат
							if ($send==1)
							{
							 $atelo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_sev[owner]."'  ;"));
							if ($atelo[id_city]==1) { $atelo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$atelo[id]."'  ;")); }
							elseif ($atelo[id_city]==2) { $atelo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$atelo[id]."'  ;")); }

								if ($isbank)
									{
											//new_delo
				  		    					$rec['owner']=$atelo[id];
											$rec['owner_login']=$atelo[login];
											$rec['owner_balans_do']=$atelo['money'];
											$rec['owner_balans_posle']=$atelo['money'];
											$rec['target']=0;
											$rec['target_login']='Банк';
											$rec['type']=311;//возврат КО
											$rec['sum_kr']=0;
											$rec['sum_ekr']=$get_sev[cost];
											$rec['sum_kom']=0;
											$rec['item_id']='';
											$rec['item_name']='';
											$rec['item_count']=0;
											$rec['item_type']=0;
											$rec['item_cost']=0;
											$rec['item_dur']=0;
											$rec['item_maxdur']=0;
											$rec['item_ups']=0;
											$rec['item_unic']=0;
											$rec['item_incmagic']='';
											$rec['item_incmagic_count']='';
											$rec['item_arsenal']='';
											$rec['bank_id']=$get_bank[id];
											$rec['add_info']=$get_sev[id];
											add_to_new_delo($rec); //юзеру

											$add_string='Средства переведены на ваш счет в банке №'.$get_bank[id];
									}


								if ($atelo['odate'] > (time()-60) )
								{
									$str_type=$PRICE[$get_sev[type]][desc];
									addchp('<font color=red>Внимание!</font> Вам отказано в услуге «'.$str_type.'», счет №SC'.$get_sev[id].'.'.$add_string.' Причина: '.mysql_real_escape_string($_GET[coment]).'.','{[]}'.$atelo['login'].'{[]}',$atelo['room'],$atelo['id_city']);
								} else {
									$str_type=$PRICE[$get_sev[type]][desc];
									mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$atelo['id']."','','<font color=red>Внимание!</font> Вам отказано в услуге «{$str_type}», счет №SC".$get_sev[id]." ".$add_string." Причина: ".mysql_real_escape_string($_GET[coment]).".');");
								}
							//оптовый отказ
							 if ($get_sev[group_id]>0)
							 	{
								//меняем статус на отказ - опту
								mysql_query("UPDATE oldbk.com_service set stat=100, moder='{$_SESSION['uid']}' , del_comm='".mysql_real_escape_string($_GET['coment'])."'  where  group_id='{$sc_id}'");
							 	}
							 	else
							 	{
 								//меняем статус на отказ - обычный
								mysql_query("UPDATE oldbk.com_service set stat=100, moder='{$_SESSION['uid']}'  , del_comm='".mysql_real_escape_string($_GET['coment'])."'   where stat=1 and id='{$sc_id}'");
							 	}

						  	echo "<font color=red>Запрос удачно отклонен!</font>";

							}

						}
						else
						{
						echo "<font color=red>Счет не найден!</font>";
						}
					}
					else
					{
					echo "<br><br>Отказ счета №".(int)($_GET[no]);
			 		echo "<form method=GET>";
			 		echo "<input type=hidden name=act value='look_img_mod'>";
	 				echo "<input type=hidden name=no value='".(int)($_GET[no])."'>";
	 				echo " Комментарий: <input type=text name=coment>";
		 			echo "<input type=submit name=send value='Отказать'>";
		 			$view_form_look=0;
		 			}
				}


		if ($view_form_look==1)
	   {
		$get_ut_img=mysql_query("select * from oldbk.com_service where stat=1  and (isnull(group_id) OR group_id=id) order by mtime DESC");
		$j=0;
		while ($row=mysql_fetch_array($get_ut_img))
		{
		$j++;
		echo "<table border=0>";
		AdminShow_img($row,$act,1);
		echo "</table>";
		echo "<hr>";
		}
		if ($j==0) { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	   }


	}
else if ($act=='look_img_prep')
	{
	$view_form_look=1;
			echo "<div align=center><h3>Не оплаченные Картинки,образы,подарки</h3></div><br><br>";

			if ($_GET['delete'])
				{
				$_GET['no']=(int)$_GET['delete'];
				$_GET['coment']='Просрочена оплата';
				}


			if (($user=="Архитектор" or $user=='Bred' ) AND ($_GET[apay]) )
			{
				$sc_id=(int)($_GET[apay]);
				$get_sev=mysql_fetch_array(mysql_query("select * from oldbk.com_service where stat=0 and id='{$sc_id}' and (isnull(group_id) OR group_id=id) "));
					if ($get_sev[id]>0)
						{

						//обновляемся
						if ($get_sev[group_id]>0)
						 {
						mysql_query("UPDATE oldbk.com_service set stat=1, moder='{$_SESSION['uid']}' where stat=0 and group_id='{$sc_id}'");
						 }
						 else
						{
						mysql_query("UPDATE oldbk.com_service set stat=1, moder='{$_SESSION['uid']}' where stat=0 and id='{$sc_id}'");
						}
					  	echo "<font color=red>Запрос  удачно оплачен!</font>";
						}
						else
						{
						echo "<font color=red>Счет не найден!</font>";
						}
			}
			else
			if ($_GET[yes])
			{
				$sc_id=(int)($_GET[yes]);
				$get_sev=mysql_fetch_array(mysql_query("select * from oldbk.com_service where stat=0 and id='{$sc_id}' and (isnull(group_id) OR group_id=id) "));
					if ($get_sev[id]>0)
						{
						$img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_sev[owner]."'  ;"));
						if ($img_telo[id_city]==1) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$img_telo[id]."'  ;")); }
					elseif ($img_telo[id_city]==2) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$img_telo[id]."'  ;")); }
						if ($img_telo['odate'] > (time()-60) )
						{
						addchp('<font color=red>Внимание!</font> Ваш запрос в Коммерческий отдел №SC'.$get_sev[id].' - '.$PRICE[$get_sev[type]][desc].' - одобрен. Можете оплатить счет!'.$addtext.'  ','{[]}'.$img_telo['login'].'{[]}',$img_telo['room'],$img_telo['id_city']);
						} else {
						mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$img_telo['id']."','','<font color=red>Внимание!</font> Ваш запрос в Коммерческий отдел №SC{$get_sev[id]} - ".$PRICE[$get_sev[type]][desc]." - одобрен.  Можете оплатить счет!".$addtext."');");
						}
						//обновляемся
						if ($get_sev[group_id]>0)
						 {
						mysql_query("UPDATE oldbk.com_service set mess=1, moder='{$_SESSION['uid']}' where stat=0 and group_id='{$sc_id}'");
						 }
						 else
						{
						mysql_query("UPDATE oldbk.com_service set mess=1, moder='{$_SESSION['uid']}' where stat=0 and id='{$sc_id}'");
						}
					  	echo "<font color=red>Запрос  удачно одобрен!</font>";
						}
						else
						{
						echo "<font color=red>Счет не найден!</font>";
						}
			}
			else
			if ($_GET[no])
				{

				if ($_GET[coment])
					{
				//1. ищим
					$sc_id=(int)($_GET[no]);
					$get_sev=mysql_fetch_array(mysql_query("select * from oldbk.com_service where stat=0 and id='{$sc_id}' and (isnull(group_id) OR group_id=id) "));
					if ($get_sev[id]>0)
						{
							$atelo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_sev[owner]."'  ;"));
							if ($atelo[id_city]==1) { $atelo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$atelo[id]."'  ;")); }
						elseif ($atelo[id_city]==2) { $atelo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$atelo[id]."'  ;")); }

						//оптовый отказ
							 if ($get_sev[group_id]>0)
							 	{
								//меняем статус на отказ - опту
								mysql_query("UPDATE oldbk.com_service set stat=100, moder='{$_SESSION['uid']}'   where  group_id='{$sc_id}'");
							 	}
							 	else
							 	{
 								//меняем статус на отказ - обычный
								mysql_query("UPDATE oldbk.com_service set stat=100, moder='{$_SESSION['uid']}'   where stat=0 and id='{$sc_id}'");
							 	}

								if ($_GET['delete']!='')
								{
								//системка для удаления
								if ($atelo['odate'] > (time()-60) )
								{
								$str_type=$PRICE[$get_sev[type]][desc];
								addchp('<font color=red>Внимание!</font> Ваша заявка по услуге «'.$str_type.'», счет №SC'.$get_sev[id].'.'.$add_string.'- удалена. Причина:'.mysql_real_escape_string($_GET[coment]).'.','{[]}'.$atelo['login'].'{[]}',$atelo['room'],$atelo['id_city']);
								} else {
								$str_type=$PRICE[$get_sev[type]][desc];
								mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$atelo['id']."','','<font color=red>Внимание!</font> Ваша заявка по услуге «{$str_type}», счет №SC".$get_sev[id]." ".$add_string."- удалена. Причина:".mysql_real_escape_string($_GET[coment]).".');");
								}
						  		echo "<font color=red>Запрос удачно удален!</font>";
								}
								else
								{
								//системка для отклонения
								if ($atelo['odate'] > (time()-60) )
								{
								$str_type=$PRICE[$get_sev[type]][desc];
								addchp('<font color=red>Внимание!</font> Вам отказано в услуге «'.$str_type.'», счет №SC'.$get_sev[id].'.'.$add_string.' Причина:'.mysql_real_escape_string($_GET[coment]).'.','{[]}'.$atelo['login'].'{[]}',$atelo['room'],$atelo['id_city']);
								} else {
								$str_type=$PRICE[$get_sev[type]][desc];
								mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$atelo['id']."','','<font color=red>Внимание!</font> Вам отказано в услуге «{$str_type}», счет №SC".$get_sev[id]." ".$add_string." Причина:".mysql_real_escape_string($_GET[coment]).".');");
								}
						  		echo "<font color=red>Запрос удачно отклонен!</font>";
						  		}
						}
						else
						{
						echo "<font color=red>Счет не найден!</font>";
						}
					}
					else
					{
					echo "<br><br>Отказ счета №".(int)($_GET[no]);
			 		echo "<form method=GET>";
			 		echo "<input type=hidden name=act value='look_img_prep'>";
	 				echo "<input type=hidden name=no value='".(int)($_GET[no])."'>";
	 				echo " Комментарий: <input type=text name=coment>";
		 			echo "<input type=submit name=send value='Отказать'>";
		 			$view_form_look=0;
					}
				}



		if ($view_form_look==1)
	   {
		$get_ut_img=mysql_query("select * from oldbk.com_service where stat=0 and (isnull(group_id) OR group_id=id) order by mtime DESC");
		$j=0;
		while ($row=mysql_fetch_array($get_ut_img))
		{
		$j++;
		echo "<table border=0>";
		AdminShow_img($row,$act,2);
		echo "</table>";
		echo "<hr>";
		}
		if ($j==0) { echo "<br><br><font color=red>Заказов нет!</font><br>"; }
	   }




}
else if ($act=='look_money_prep_mod' )
{

///показ заявок на вывод денег
	echo "<div align=center><h3>Заявки на вывод премодерация:</h3></div>";

		//print_r($_POST);

		if (($_POST['zyes']) and ((int)($_POST['mzid'])>0))
		{
		$zid=(int)($_POST['mzid']);
			//ставим что проверили - и переводим в нормальный статус
			mysql_query("UPDATE oldbk.com_money SET  stat=0 , odobtime=NOW()   where stat=-1 and id='{$zid}' LIMIT 1;");
			if (mysql_affected_rows()>0)
				{
				echo "<font color=red>Удачно одобрено!</font>";
				}
		}
		elseif  (($_POST['zotkaz']) and ((int)($_POST['mzid'])>0))
		{
			if ($_POST['nomsg'])
			{
			$zid=(int)($_POST['mzid']);
				mysql_query("UPDATE oldbk.com_money SET  stat=3, paydate=NOW() , prim='".mysql_real_escape_string($_POST['nomsg'])."'   where stat=-1 and id='{$zid}' LIMIT 1;");
				if (mysql_affected_rows()>0)
				{
					//функа возврата купюр персу
					if (real_zak_cancel($zid,$_POST['nomsg']))
					{
					echo "<font color=red>Удачно отказано!</font>";
					}
					else
					{
					echo "<font color=red>Ошибка отказа!</font>";
					}
				}
			}
			else
			{
				echo "<font color=red>Введите причину отказа!</font>";
			}
		}


	$zak_m=mysql_query("select cm.*, u.login from oldbk.com_money cm LEFT JOIN oldbk.users u ON cm.owner=u.id where cm.stat=-1 order by id ;");

if (mysql_num_rows($zak_m)>0)
	{
	$c=1;

	echo "<table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]'><td>";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Информация</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата заявки</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Действие</b></center>";
		echo "</td></tr>";

	while ($arow=mysql_fetch_array($zak_m))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]' ><td align=center>";
		echo "WM".$arow['id'];
		echo "</td>";
		echo "<td>";
			echo "<div class=text4>Персонаж: <b>".$arow['login']."</b> <a href=\"http://capitalcity.oldbk.com/inf.php?{$arow['owner']}\" target=\"_blank\"><img src=\"https://i.oldbk.com/i/inf.gif\"></a>.<br>Запрос вывода средств на сумму: <b>".$arow['msum']." $ => ".round(($arow['msum']*$arow['kof']),2)." WMZ </b>.<br>WMZ: <b>".$arow['outwmz']."</b><br>IP: <b>".$arow['logip']."</b> </div>";
		echo "</td>";
		echo "<td align=center>";
		echo "<div class=text4 >".$arow['mktime']."</div>";
		echo "</td>";
		echo "<td align=right>";
			echo "<div class=text4 align=right>";
				echo "<form method=POST action='?act=look_money_prep_mod'>";
				echo '<input type=hidden name=mzid value="'.$arow['id'].'">';
				echo 'Причина:<input type="text" name=nomsg>';
				echo '<button id="enter1" onclick="this.name=\'zotkaz\'; this.value=\'yes\'" type="submit">Отказать</button><br><br>';
				echo '<button id="enter1" onclick="this.name=\'zyes\'; this.value=\'yes\'" type="submit">Одобрить заявку</button>';
				echo "</form>";
			echo "</div>";
		echo "</td></tr>";

		}

	echo "</table><br><br>";

	}
	else
	{
		echo "<font color=red>Пока нет заявок на вывод средств!</font>";
	}

/////////////////////////////

}
else if ($act=='look_money_zayav' && (($user == "Архитектор") OR ($user == "Bred")))
{
///показ заявок на вывод денег
	echo "<div align=center><h3>Заявки на вывод:</h3></div>";

		if (($_POST['zayid']) AND ($_POST[make_payout]=='yes'))
		{
		//не выводим буфер
		// а выводит текст cvs
		    ob_clean();
		     header("Content-Type: text/plain;charset=utf-8");
			header("Content-Disposition: inline; filename=\"payout_date_".date("YmdH").".csv\"");
			header("Content-Type: application/force-download");
			header("Content-Type: application/octet-stream");
			header("Content-Type: application/download");
			header("Content-Description: File Transfer");

			$string="\xEF\xBB\xBF"; // UTF-8 BOM
			$idss='';
				foreach ($_POST['zayid'] as $i => $v )
				{
				$idss.=$i.",";
				}
			$idss=substr($idss,0,strlen($idss)-1);

			$get_pay_out=mysql_query("select * from oldbk.com_money where stat=0 and id in (".$idss.")");
				while($irow = mysql_fetch_assoc($get_pay_out))
				{

				$ust=check_users_city_data($irow['owner']);
				$string.=$irow['outwmz'].";".round(($irow['msum']*$irow['kof']),2).";".iconv("WINDOWS-1251", "UTF-8", "Вывод средств из oldbk.com по заявке #".$irow['id']." для персонажа ".$ust['login'])." ;".$irow['id']."\n";


				}


			header("Content-Length: ".mb_strlen($string, '8bit'));

			echo $string;
    			exit;
		}
		elseif (($_POST['zayid']) AND ($_POST[make_payok]=='yes'))
		{
				$idss='';
				foreach ($_POST['zayid'] as $i => $v )
				{
				$idss.=$i.",";
				}
				$idss=substr($idss,0,strlen($idss)-1);

			mysql_query("UPDATE oldbk.com_money SET  stat=2, paydate=NOW() where stat=0 and id in (".$idss.")");
			if (mysql_affected_rows()>0)
				{
				echo "<font color=red>Удачно помечено как выплачено для выбраных запросов!</font>";
				}
		}
		else if ($_GET['otkaz'])
		{
		$idotkaz=(int)($_GET['otkaz']);
			mysql_query("UPDATE oldbk.com_money SET  stat=3, paydate=NOW(), prim='".mysql_real_escape_string($_GET['nomsg'])."'   where stat=0 and id='{$idotkaz}' LIMIT 1;");
			if (mysql_affected_rows()>0)
				{
				//nomsg

				//функа отказа
					if (real_zak_cancel($idotkaz,$_GET['nomsg']))
					{
					echo "<font color=red>Удачно отказано!</font>";
					}
				}
		}

	$zak_m=mysql_query("select cm.*, u.login from oldbk.com_money cm LEFT JOIN oldbk.users u ON cm.owner=u.id where cm.stat=0 order by  odobtime  ;");

if (mysql_num_rows($zak_m)>0)
	{
	$c=1;
	echo "<table border=0><tr><td valign=top>";
	echo "<form method=POST action='?act=look_money_zayav'>";
	echo "<table width=\"750\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]'><td >";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Информация</b></center>";
		echo "</td>";
		echo "<td width=200>";
		echo "<center><b>Дата</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Действие</b></center>";
		echo "</td></tr>";
	$arids=array();
      $totalekr=0;
      $totalwmz=0;
	while ($arow=mysql_fetch_array($zak_m))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		$arids[]=$arow['id'];

	      $totalekr+=$arow['msum'];
	      $totalwmz+=round(($arow['msum']*$arow['kof']),2);
		echo "<tr bgcolor='$co[$c]' ><td align=center height=70>";
		echo "WM".$arow['id'];
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>Персонаж: <b>".$arow['login']."</b> <a href=\"http://capitalcity.oldbk.com/inf.php?{$arow['owner']}\" target=\"_blank\"><img src=\"https://i.oldbk.com/i/inf.gif\"></a>.<br>Запрос вывода средств на сумму: <b>".$arow['msum']." $ => ".round(($arow['msum']*$arow['kof']),2)." WMZ</b>.<br>WMZ: <b>".$arow['outwmz']."</b><br>IP: <b>".$arow['logip']."</b></div>";
		echo "</td>";
		echo "<td align=center>";
		echo "<div class=text4 >Дата заявки: <small>".date ("d.m.Y H:i:s" ,  strtotime($arow['mktime']) )."</small>";
				if ($arow['odobtime']!='0000-00-00 00:00:00')
					{
					echo "<br>Дата одобрения: <small>".date ("d.m.Y H:i:s" ,  strtotime($arow['odobtime']) )."</small>";
					}
		echo "</div>";
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>";
		echo '<input type="checkbox" name=zayid['.$arow['id'].']> - Пометить для выплаты <br><br> ';
		echo "</div>";
		echo "</td></tr>";
		}
		echo "<tr><td colspan=4> ";
		echo "Итого на вывод: <b>".$totalekr." $ => ".$totalwmz." WMZ</b>";
		echo "</td></tr>";

		echo "<tr><td colspan=2> ";
		echo '<center><button id="enter1" onclick="this.form.target=\'_blank\'; this.name=\'make_payout\'; this.value=\'yes\'" type="submit">ШАГ 1. Скачать CSV-файл для олпты</button> ';
		echo "</td>";

		echo "<td colspan=2> ";
		echo '<button id="enter1" onclick="this.form.target=\'_self\'; this.name=\'make_payok\'; this.value=\'yes\'" type="submit">ШАГ 2. Отметить выбраныое как оплачено</button></center>';
		echo "</td></tr>";
		echo "</table>";
		echo "</form>";
		echo "</td><td valign=top>";

				echo "<table  align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";
				$c=1;
				echo "<tr class=text3 bgcolor='$co[$c]'><td height=10 ><center><b>Действие</b></center></td></tr>";

				foreach($arids as $k=>$v)
					{
				      if ($c==1) {$c=2;} else {$c=1;}
						echo "<tr><td height=70>";
						echo '<form method=GET >';
						echo '<input type=hidden name=act value=look_money_zayav>';
						echo '<input type=hidden name=otkaz value='.$v.'>';
						echo '<input type="text" name=nomsg><br>';
						echo '<button id="enter1" onclick="this.name=\'zotkaz\'; this.value=\'yes\'" type="submit">Отказать</button></form>';
						echo "</td></tr>";

					}
/*				echo "<tr><td height=10>";
				echo "&nbsp;";
				echo "</td></tr>";
				echo "<tr><td height=10>";
				echo "&nbsp;";
				echo "</td></tr>";	*/
				echo "</table>";

	echo "</td></tr>";

	echo "</table>";

	}
	else
	{
		echo "<font color=red>Пока нет заявок на вывод средств!</font>";
	}

/////////////////////////////






} else if ($act=='look_money_hist' && (($user == "Архитектор") OR ($user == "Bred")))
{

					$view = 50; // кол. на страницу
					$limit = "";
					if (isset($_GET['page']))
					{
						$page = intval($_GET['page']);
						$limit .= ' LIMIT '.($page*$view).','.$view.' ';
					} else {
					$page = 0;
					$limit .= ' LIMIT '.$view.' ';
					}

					if (isset($_GET['mon']))
					{
					$mon=(int)($_GET['mon']);
					}
					$ddat="";
					if ($mon>0)
					{
					$ddat="and paydate>='".date("Y")."-".$mon."-01 00:00:00' and paydate<='".date("Y")."-".$mon."-31 23:59:59' ";
					}

//показ хистори вывода денег
	echo "<div align=center><h3>Исторя выплат:</h3></div><br>";

	echo "<center><FORM METHOD=GET ><input type=hidden name='act' value='look_money_hist'>";
	$arr_mon=array("----------","Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь");
	echo "<SELECT name=mon>";
	foreach($arr_mon as $k=>$v)
		{
		echo "<OPTION value=".$k." ".($mon==$k?"selected":"").">".$v."</OPTION>";
		}
	echo '</SELECT><button id="enter1" type="submit">Показать</button></FORM></center>';

	echo "<form method=post> Поиск по нику:<input type=text name=snick value='".$_POST['snick']."' ><button id=\"enter1\" type=\"submit\">Найти</button></form>&nbsp;&nbsp;&nbsp;";
	echo "<form method=post> Поиск по WMZ:<input type=text name=swmz value='".$_POST['swmz']."' ><button id=\"enter1\" type=\"submit\">Найти</button></form>";

	if ($_POST['snick'])
	{
	$zak_m=mysql_query("SELECT SQL_CALC_FOUND_ROWS cm.*, u.login from oldbk.com_money cm LEFT JOIN oldbk.users u ON cm.owner=u.id where  (cm.stat=2 OR  cm.stat=3)  and login='".mysql_real_escape_string($_POST['snick'])."' order by id DESC ".$limit);
	}
elseif ($_POST['swmz'])
	{
	$zak_m=mysql_query("SELECT SQL_CALC_FOUND_ROWS cm.*, u.login from oldbk.com_money cm LEFT JOIN oldbk.users u ON cm.owner=u.id where  (cm.stat=2 OR  cm.stat=3)  and outwmz='".mysql_real_escape_string($_POST['swmz'])."' order by id DESC ".$limit);
	}
	else
	{
	$zak_m=mysql_query("SELECT SQL_CALC_FOUND_ROWS cm.*, u.login from oldbk.com_money cm LEFT JOIN oldbk.users u ON cm.owner=u.id where  (cm.stat=2 OR  cm.stat=3)   ".$ddat." order by id DESC ".$limit);
	}

	$q2 = mysql_query('SELECT FOUND_ROWS() AS `allcount`') or die();


				$allcount = mysql_fetch_assoc($q2);
				$allcount = $allcount['allcount'];

				$pages = " Страницы:";
				for ($i = 0; $i < ceil($allcount/$view); $i++) {
					if ($page == $i) {
						$pages .= '<b> '.($i+1).'</b> ';
	                                } else {
						$pages .= ' <a href="?act=look_money_hist&page='.$i.'">'.($i+1).'</a>';
					}
				}


	if (mysql_num_rows($zak_m)>0)
	{
	$c=1;

	echo "<table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]'><td>";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Информация</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата заявки</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Статус</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата статуса</b></center>";
		echo "</td></tr>";

	while ($arow=mysql_fetch_array($zak_m))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]' ><td align=center>";
		echo "WM".$arow['id'];
		echo "</td>";
		echo "<td>";
			echo "<div class=text4>Персонаж: <b>".$arow['login']."</b> <a href=\"http://capitalcity.oldbk.com/inf.php?{$arow['owner']}\" target=\"_blank\"><img src=\"https://i.oldbk.com/i/inf.gif\"></a>.<br>Запрос вывода средств на сумму: <b>".$arow['msum']." $</b>.<br>WMZ: <b>".$arow['outwmz']."</b>";

			if ($arow['stat']==3)
				{
				echo "<br><font color=red>".$arow['prim']."</font>";
				}

			echo "</div>";
		echo "</td>";
		echo "<td align=center>";
		echo "<div class=text4 >".$arow['mktime']."</div>";
		echo "</td>";
		echo "<td>";
				echo "<div class=text4>";
				switch ($arow['stat'])
				{
					case "0":
					echo "На рассмотрении";
					break;
					case "-1":
					echo "На проверке";
					break;
					case "1":
					echo "Утверждено";
					break;
					case "2":
					echo "Выполнено";
					break;
					case "3":
					echo "Отказ";
					break;
				}
			echo "</div>";
		echo "</td>";

		echo "<td align=center>";
		if ($arow['paydate']!='') echo "<div class=text4 >".$arow['paydate']."</div>";
		echo "</td></tr>";


		}

	echo "</table><br><center>".$pages."</center><br>";
	}
	else
	{
		echo "<font color=red>Пока нет истории!</font><br>";
	}

	$get_all_sum=mysql_fetch_array(mysql_query("select sum(msum) from oldbk.com_money  where stat=2  ;"));
	if ($get_all_sum[0]>0)
	{
	echo "<b> Суммарно выведено:".$get_all_sum[0]." $</b><br>";
	}



}
 else if ($act=='look_unikhist' && $user == "Архитектор") {
	echo "<div align=center><h3>Уник лог</h3></div><br><br>";
	echo '<form method="POST"> Выберите период: <select name="m">';
	$m = array(
		1 => "Январь",
		2 => "Февраль",
		3 => "Март",
		4 => "Апрель",
		5 => "Май",
		6 => "Июнь",
		7 => "Июль",
		8 => "Август",
		9 => "Сентябрь",
		10 => "Октябрь",
		11 => "Ноябрь",
		12 => "Декабрь",
	);

	while(list($k,$v) = each($m)) {
		if ($k == date("m")) {
			echo '<option selected value="'.$k.'">'.$k.' '.$v.'</option>';
		} else {
			echo '<option value="'.$k.'">'.$k.' '.$v.'</option>';
		}
	}

	echo '
	</select> &nbsp;&nbsp;<select name="y">';

	for ($i = 2013; $i < 2020 ; $i++) {
		echo '<option value="'.$i.'">'.$i.'</option>';
	}



	echo '
	</select>&nbsp;&nbsp;&nbsp;<input id="enter1" type="submit" value="Выбрать">
	</form><br><br>
	';

	if ($_SERVER['REQUEST_METHOD'] == "POST") {
		$m1 = $_POST['m'];
		$y1 = $_POST['y'];

		$d1 = mktime(0,0,0,$m1,1,$y1);
		$d2 = mktime(23,59,59,$m1+1,0,$y1);

		$q = mysql_query('SELECT * FROM oldbk.com_logs WHERE `time` BETWEEN '.$d1.' AND '.$d2.' AND type = 1');
		$ekr = 0;
		while($c = mysql_fetch_assoc($q)) {
			preg_match('~за ([\d]{1,}) екр~iU',$c['text'],$m);
			if (isset($m[1])) {
				$ekr += $m[1];
			}
		}
		echo 'Продано <b>'.mysql_num_rows($q).'</b> уников на сумму: <b>'.$ekr.'</b> екр.<br>';

	}


	echo '<br><br><table>';
	$q = mysql_query('SELECT * FROM com_logs WHERE type = 1 ORDER BY time DESC');
	$i = mysql_num_rows($q);
	while($l = mysql_fetch_assoc($q)) {
		preg_match('~"(.*)" купил~iU',$l['text'],$m);
		echo '<tr><td><B>'.$i--.'.</b></td><td>'.date("d/m/Y H:i",$l['time']).'</td><td><a href="http://capitalcity.oldbk.com/inf.php?login='.htmlspecialchars($m[1],ENT_QUOTES | ENT_COMPAT | ENT_HTML401,"cp1251").'" target=_blank title="Инф. о '.htmlspecialchars($m[1],ENT_QUOTES | ENT_COMPAT | ENT_HTML401,"cp1251").'"><IMG SRC="https://i.oldbk.com/i/inf.gif" WIDTH=12 HEIGHT=11 BORDER=0></a> '.$l['text'].'</td></tr>';
	}
	echo '</table>';
} else if ($act=='look_clear_hist') {
	echo "<div align=center><h3>История проверок</h3></div><br><br>";
	echo '<form method="POST"> Выберите период: <select name="m">';
	$m = array(
		1 => "Январь",
		2 => "Февраль",
		3 => "Март",
		4 => "Апрель",
		5 => "Май",
		6 => "Июнь",
		7 => "Июль",
		8 => "Август",
		9 => "Сентябрь",
		10 => "Октябрь",
		11 => "Ноябрь",
		12 => "Декабрь",
	);

	while(list($k,$v) = each($m)) {
		if ($k == date("m")) {
			echo '<option selected value="'.$k.'">'.$k.' '.$v.'</option>';
		} else {
			echo '<option value="'.$k.'">'.$k.' '.$v.'</option>';
		}
	}

	echo '
	</select> &nbsp;&nbsp;<select name="y">';

	for ($i = 2013; $i < 2020 ; $i++) {
		echo '<option value="'.$i.'">'.$i.'</option>';
	}



	echo '
	</select>&nbsp;&nbsp;&nbsp;<input id="enter1" type="submit" value="Выбрать">
	</form><br><br>
	';

	if ($_SERVER['REQUEST_METHOD'] == "POST") {
		$m1 = $_POST['m'];
		$y1 = $_POST['y'];

		$d1 = mktime(0,0,0,$m1,1,$y1);
		$d2 = mktime(23,59,59,$m1+1,0,$y1);


		$arr = array();
		$q = mysql_query('SELECT * FROM oldbk.com_requests WHERE mess_time BETWEEN '.$d1.' AND '.$d2.' AND type = "Экспресс проверка на чистоту" AND status != ""');
		while($c = mysql_fetch_assoc($q)) {
			$nick = substr($c['status'],23);
			if (strlen($nick) > 1) {
				$arr[$nick]++;
			}
		}

		if ($user == "Архитектор" || $user == "Пресс-секретарь") {
			while(list($k,$v) = each($arr)) {
				echo '<b>'.$k.'</b>: '.$v.'<br>';
			}
		} else {
			while(list($k,$v) = each($arr)) {
				if ($k == $user) echo "<b>".$k."</b>: ".$v.'<br>';
			}
		}

	}
} else if ($act=='look_img_hist')
	{
			echo "<div align=center><h3>История утвержденных Картинок,образов,подарков</h3></div><br><br>";


	if  ((isset($_POST['field'])) and (isset($_POST['search'])))
		{
		$get_all_a=mysql_fetch_array(mysql_query("select count(*) from oldbk.com_service where stat>1 and stat !=100 and (isnull(group_id) OR group_id=id) and owner=(select id from oldbk.users where login='".mysql_real_escape_string($_POST['search'])."' )   "));
		echo "Поиск по нику:<b>".$_POST['search']."</b><br>";
		}
		else
		{
		$get_all_a=mysql_fetch_array(mysql_query("select count(*) from oldbk.com_service where stat>1 and stat !=100 and (isnull(group_id) OR group_id=id)  "));
		}


	$st=(int)($_GET[p]);
	 if ($st>$get_all_a) { $st=0; }

	if ($get_all_a[0] > 0)
		{
			if  ((isset($_POST['field'])) and (isset($_POST['search'])))
			{
			$get_ut_img=mysql_query("select * from oldbk.com_service where stat>1 and stat !=100 and (isnull(group_id) OR group_id=id) and owner=(select id from oldbk.users where login='".mysql_real_escape_string($_POST['search'])."' )  order by mtime DESC   ");
			$view_all=true;
			}
			else
			{
			$get_ut_img=mysql_query("select * from oldbk.com_service where stat>1 and stat !=100 and (isnull(group_id) OR group_id=id)  order by mtime DESC  LIMIT ".($st*10).",10 ");
			}

		$j=0;
		while ($row=mysql_fetch_array($get_ut_img))
		{
		$j++;
		echo "<table border=0>";
		AdminShow_img($row,$act,3);
		echo "</table>";
		echo "<hr>";
		}

			if($view_all!=true)
			{
				$allp=(int)($get_all_a[0]/10);
				if ($allp<($get_all_a[0]/10)) { $allp++;}
				echo "Страницы: ";
				for ($jj=1;$jj<=($allp);$jj++)
					{
					 if ($st==($jj-1))
					 	{
						echo "<b>[{$jj}]</b> ";
						}
						else
						{
						echo "<a href=?act=look_img_hist&p=".($jj-1).">[".$jj."]</a> ";
						}

					}
			}
		}
		else { echo "<br><br><font color=red>Заказов нет!</font><br>"; }

	}
else
{
if ($act=='done')
	{
	 $where="WHERE `status`!='' and  `status`!='Ожидается оплата' ";
	 $page='doned';
	}
else {$where="WHERE `status` IS NULL";}

if ($act=='whatdeclared')
	{
	 $where="WHERE `whodoit`!=''";
	 $page='whatdeclared';
	}
if ($act=='whatpaid')
	{
	 $where="WHERE `paid`!=''";
	 $page='whatpaid';
	}
// Поиск
if ($_REQUEST['field']!='')
	{
	 if ($_REQUEST['field']=='Ник заявителя')
	 	{$field='login';}
	 if ($_REQUEST['field']=='Тип заявки')
	 	{$field='type';}
	 if ($_REQUEST['field']=='Комментарий')
	 	{$field='comment';}
	 $where="WHERE `".$field."` LIKE '%".$_REQUEST['search']."%'" ;

	}


if ($isadmin==2)
	{$where.=" AND `whodoit`='2'";}
if ($act=='makedone' and $id !='') {
	///
	$get_id_char=mysql_fetch_array(mysql_query('SELECT charid FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($get_id_char[charid]>0)
	  {
            mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values
                         ('".$get_id_char[charid]."','','<font color=red><i>Ответ от Коммерческого отдела на заявку №".$id."</i>: </font>".$_REQUEST['coment']."');");
	  }
	 mysql_query("UPDATE com_requests SET `status`='Сделано ".$now."<br> Комментарий: ".$_REQUEST['coment']."' WHERE `Id`=".$id);
	 echo "<script>this.document.location.href='index.php';</script>";
	 page_bottom();
	 exit;
}

if ($act=='makepnotclear' and $id !='' and $isadmin==1) {
	mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.' '.$user.'" WHERE Id = '.$id);
	$act = "answer";
	$skipanswbottom = 1;
}


if ($act=='makeclose' and $id !='' and $isadmin==1) {
	mysql_query('UPDATE oldbk.`com_requests` SET status = "Закрыто '.$now.' '.$user.'" WHERE id = '.$id);
	$skipanswbottom = 1;
}

if ($act=='makereset' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$tar = check_users_city_data($comr['charid']);
		$db_city[0]='oldbk.';
		$db_city[1]='avalon.';
		$db_city[2]='angels.';

		if (mysql_query("UPDATE ".$db_city[$tar[id_city]]."`users` SET second_password = '' WHERE id = ".$tar['id'])) {
			mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.' '.$user.'" WHERE id = '.$id);
			echo "<font color=red><b>Успешно обнулён второй пароль персонажу ".$tar['login']."</b></font>";
$aa = '
Здравствуйте '.$tar['login'].'!

Второй пароль для персонажа "'.$tar['login'].'" успешно удален

С уважением,
Коммерческий отдел OLDBK.COM';

			mailnew($tar['email'],"OLDBK.COM Ответ / ".$comr['type']." (".$comr['Id'].")",$aa, false);
		}
	}
}

if ($act=='makechangesex' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$tar = check_users_city_data($comr['charid']);
		$db_city[0]='oldbk.';
		$db_city[1]='avalon.';
		$db_city[2]='angels.';

		if ($tar['sex']) $tar['sex'] = 0; else $tar['sex'] = 1;

		if (mysql_query("UPDATE ".$db_city[$tar[id_city]]."`users` SET sex = '".$tar['sex']."' WHERE id = ".$tar['id'])) {
			mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.' '.$user.'" WHERE id = '.$id);
			echo "<font color=red><b>Успешно изменён пол персонажу ".$tar['login']."</b></font>";
$aa = '
Здравствуйте '.$tar['login'].'!

Успешно изменён пол для персонажа "'.$tar['login'].'"

С уважением,
Коммерческий отдел OLDBK.COM';

			mailnew($tar['email'],"OLDBK.COM Ответ / ".$comr['type']." (".$comr['Id'].")",$aa, false);
		}
	}
}


if ($act=='makeresetbd' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$tar = check_users_city_data($comr['charid']);
		$db_city[0]='oldbk.';
		$db_city[1]='avalon.';
		$db_city[2]='angels.';

		if (mysql_query("UPDATE ".$db_city[$tar[id_city]]."`users` SET borndate = '".$comr['addinfo']."' WHERE id = ".$tar['id'])) {
			mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.' '.$user.'" WHERE id = '.$id);
			echo "<font color=red><b>Успешно изменён ДР у персонажа ".$tar['login']."</b></font>";
$aa = '
Здравствуйте '.$tar['login'].'!

ДР для персонажа "'.$tar['login'].'" успешно изменён

С уважением,
Коммерческий отдел OLDBK.COM';

			$mess = "Смена ДР через КО.";
			mysql_query("INSERT INTO oldbk.`lichka`(`id`,`pers`,`text`,`date`) VALUES ('','".$tar['id']."','$mess','".time()."');") or die();


			mailnew($tar['email'],"OLDBK.COM Ответ / ".$comr['type']." (".$comr['Id'].")",$aa, false);
		}
	}
}


if ($act=='makeresetemail' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$tar = check_users_city_data($comr['charid']);
		$db_city[0]='oldbk.';
		$db_city[1]='avalon.';
		$db_city[2]='angels.';

		$email = unserialize($comr['addinfo']);

		if (mysql_query("UPDATE ".$db_city[$tar[id_city]]."`users` SET email = '".$email[1]."' WHERE id = ".$tar['id'])) {
			$tar['email']  = $email[1];
			mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.' '.$user.'" WHERE id = '.$id);
			echo "<font color=red><b>Успешно изменен емейл персонажу ".$tar['login']."</b></font>";
$aa = '
Здравствуйте '.$tar['login'].'!

Емейл для персрнажа "'.$tar['login'].'" успешно изменён

С уважением,
Коммерческий отдел OLDBK.COM';

			mailnew($tar['email'],"OLDBK.COM Ответ / ".$comr['type']." (".$comr['Id'].")",$aa, false);
		}
	}
}

if ($act=='makenreset' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);

		$q = mysql_query('START TRANSACTION') or die();

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[203][cost],$us['id'],$comr['bank_id']);


		$q = mysql_query('COMMIT') or die();

		$act = "answer";
		$skipanswbottom = 1;
	}
}


if ($act=='makenchangesex' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);


		$q = mysql_query('START TRANSACTION') or die();

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[204][cost],$us['id'],$comr['bank_id']);

		$q = mysql_query('COMMIT') or die();

		$act = "answer";
		$skipanswbottom = 1;
	}
}


if ($act=='makenresetbd' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);

		$q = mysql_query('START TRANSACTION') or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[201][cost],$us['id'],$comr['bank_id']);
		mysql_query('UPDATE oldbk.`com_requests` SET status = "Отказано '.$now.'" WHERE id = '.$id) or die();
		$q = mysql_query('COMMIT') or die();

		$act = "answer";
		$skipanswbottom = 1;
	}
}


if ($act=='makenaddrekrut' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);


		$q = mysql_query('START TRANSACTION') or die();

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[105][cost],$us['id'],$comr['bank_id']);

		$q = mysql_query('COMMIT') or die();

		$messtel="Вам отказано в присоединении рекрут-клана, оплата возвращена на счет №{$comr['bank_id']}.";
		if ($us['odate'] > (time()-60)) {
			addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
		} else  {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
		}


		$act = "answer";
		$skipanswbottom = 1;
	}
}

if ($act=='makenremoverekrut' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);


		$q = mysql_query('START TRANSACTION') or die();

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[106][cost],$us['id'],$comr['bank_id']);

		$q = mysql_query('COMMIT') or die();

		$messtel="Вам отказано в отсоеденении рекрут-клана, оплата возвращена на счет №{$comr['bank_id']}.";
		if ($us['odate'] > (time()-60)) {
			addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
		} else  {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
		}


		$act = "answer";
		$skipanswbottom = 1;
	}
}



if ($act=='makenresetemail' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);

		$q = mysql_query('START TRANSACTION') or die();

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[214][cost],$us['id'],$comr['bank_id']);

		$q = mysql_query('COMMIT') or die();

		$messtel="Вам отказано в изменении емейла, оплата возвращена на счет №{$comr['bank_id']}.";
		if ($us['odate'] > (time()-60)) {
			addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
		} else  {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
		}

		$act = "answer";
		$skipanswbottom = 1;
		$emailfromusers = 1;
	}
}

else
if ($act=='makenklanchange' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);

		if (strlen($us['klan'])) {
			$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
			$kk = mysql_fetch_assoc($q);
			if ($kk['rekrut_klan'] > 0) {
				$howmuch += 2;
			}
		}

		$q = mysql_query('START TRANSACTION') or die();

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
		ReturnVauchToTelo($PRICE[101][cost],$us['id'],$comr['bank_id']);


		$q = mysql_query('COMMIT') or die();

		$messtel="Вам отказано в изменении склонности клана, оплата возвращена на счет №{$comr['bank_id']}.";
		if ($us['odate'] > (time()-60)) {
			addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
		} else  {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
		}

		$act = "answer";
		$skipanswbottom = 1;
		$emailfromusers = 1;
	}
}
else
if ($act=='makeaddrekrut' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);

		$comr['addinfo'] = explode("/",$comr['addinfo']);

		$kk = false;
		$kkr = false;
		if (strlen($us['klan'])) {
			$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
			$kk = mysql_fetch_assoc($q);

			$q = mysql_query('SELECT * FROM oldbk.clans WHERE id = "'.$comr['addinfo'][1].'"');
			$kkr = mysql_fetch_assoc($q);
		}

		if (!$kk || $kk['base_klan'] > 0 || $kk['rekrut_klan'] > 0 || $kk['glava'] != $us['id'] || !$kkr || $kkr['base_klan'] > 0 || $kkr['rekrut_klan'] > 0) {
			echo "<font color=red><b>Ошибка! Невозможно присоединить кланы!</b></font>";
		} else {
			$get_wars = mysql_fetch_array(mysql_query("select cw.* , cy.clanid , cy.clan_txt, cy.agressor as allyagr, cy.defender as allydef  from oldbk.clans_war_new  cw LEFT join oldbk.clans_war_new_ally cy on cy.warid=cw.id and cy.active=1 where cw.winner=0 and (cw.agressor='{$kk['id']}' or cw.defender='{$kk['id']}' or cy.clanid='{$kk['id']}')"));
			if ($get_wars['id']>0) {
				echo "<font color=red><b>Ошибка! Невозможно присоединить кланы, идёт война!</b></font>";
			} else {
				$q = mysql_query('START TRANSACTION') or die();

				mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

				mysql_query('UPDATE oldbk.`clans` set base_klan = '.$kk['id'].', tax_date = '.$kk['tax_date'].' WHERE id = '.$kkr['id']) or die();
			        mysql_query('UPDATE oldbk.`clans` set rekrut_klan = '.$kkr['id'].' WHERE id = '.$kk['id']) or die();


				$q = mysql_query('COMMIT') or die();

				$messtel="Ваша заявка по присоединению рекрут-клана удовлетворена.";
				if ($us['odate'] > (time()-60)) {
					addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
				} else  {
					mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
				}

				echo "<font color=red><b>Успешно присоединён рекрут-клан</b></font>";
			}
		}
	}
}
else
if ($act=='makeglavacancel' and $id !='' and $isadmin==1)
{
	/*print_r($_GET);
	echo "ОТКАЗ";
	print_r($_POST);
	*/

	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$sok = check_users_city_data($comr['charid']);
		if($sok[id]>0)
		{
			mysql_query('UPDATE oldbk.`com_requests` SET status = "Отказанно '.$now.'" WHERE id = '.$id) or die();
			$us = $sok;
			$messtel="Ваша заявка по изменению главы клана отклонена. Причина:".mysql_real_escape_string($_POST['coment']);

								//возврат 100 екрами
					   		$bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  `id`= '{$comr['bank_id']}' "));
							if ($bank[id]>0)
							{
								mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + 10  WHERE `id`= '{$bank[id]}' ");
								//  пишем в хистори банка
								$bank['ekr']+=10;
								mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе услуг Коммерческого отдела <b>10 екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank[id]}');");

										//new_delo
										$rec = array();
										$rec['owner']=$us[id];
										$rec['owner_login']=$us[login];
										$rec['owner_balans_do']=$us['money'];
										$rec['owner_balans_posle']=$us['money'];
										$rec['target_login']="КО";
										$rec['type']=1280;//получил екр назад
										$rec['sum_ekr']=10;
										$rec['bank_id']=$bank[id];
										if (add_to_new_delo($rec) === FALSE) die();
								}


			if ($us['odate'] > (time()-60)) {
				addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
			} else  {
				mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
			}

			echo "<font color=red><b>Отказанно в смене главы!</b></font>";
		}
	}

}
else
if ($act=='makeglavachange' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$sok = check_users_city_data($comr['charid']);
		$kk = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$sok['klan'].'"'));

		$fromuser = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.users WHERE id = '.$kk['glava']));

		if($sok[id] && !empty($sok['klan']) && $kk && $fromuser) {
			$polno = unserialize($kk['vozm']);

			unset($polno[$sok[id]]);

			$polno[$kk['glava']][0]=0;
			$polno[$kk['glava']][1]=0;

			$polno[$sok['id']][0]=1;
			$polno[$sok['id']][1]=1;

			mysql_query('update oldbk.`clans` set `glava` = \''.$sok['id'].'\', vozm = "'.mysql_real_escape_string(serialize($polno)).'" WHERE `id` = '.$kk['id'].';');

			mysql_query('update avalon.`users` set `status` = \'<font color=#008080><b>Глава клана</b></font>\' WHERE `id` = '.$sok['id'].';');
			mysql_query('update oldbk.`users` set `status` = \'<font color=#008080><b>Глава клана</b></font>\' WHERE `id` = '.$sok['id'].';');


			mysql_query("INSERT INTO oldbk.`lichka`(`id`,`pers`,`text`,`date`) VALUES ('','".$sok['id']."','Передано главенство клана ".$kk['short']." от ".$fromuser['login']." к ".$sok['login']." (КО)','".time()."');");
			mysql_query("INSERT INTO oldbk.`lichka`(`id`,`pers`,`text`,`date`) VALUES ('','".$kk['glava']."','Передано главенство клана ".$kk['short']." от ".$fromuser['login']." к ".$sok['login']." (КО)','".time()."');");

			$new_room=$fromuser[room];

			$new_room=((int)$fromuser[room]==18?17:$new_room);
	                $new_room=((int)$fromuser[room]==56?36:$new_room);
	                $new_room=((int)$fromuser[room]==55?54:$new_room);

            		mysql_query('update oldbk.`users` set `status` = \'Боец\', room='.$new_room.' WHERE `id` = '.$fromuser['id'].';');
			//mysql_query('update avalon.`users` set `status` = \'Боец\', room='.$new_room.' WHERE `id` = '.$fromuser['id'].';');
			$del_channel='DELETE FROM oldbk.`chanels` WHERE user = "'.$fromuser[id].'"';
            		mysql_query($del_channel);

			mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

			$us = $sok;

			$messtel="Ваша заявка по изменению главы клана удовлетворена.";
			if ($us['odate'] > (time()-60)) {
				addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
			} else  {
				mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
			}

			echo "<font color=red><b>Глава клана успешно изменён</b></font>";
		} else {
			echo "<font color=red><b>Ошибка изменения главы клана</b></font>";
		}
	}
}
else
if ($act=='makeklanchange' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$us = check_users_city_data($comr['charid']);

		$kk = false;
		$kkr = false;
		if (strlen($us['klan'])) {
			$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
			$kk = mysql_fetch_assoc($q);
			if ($kk['rekrut_klan'] > 0) {
				$q = mysql_query('SELECT * FROM oldbk.clans WHERE id = "'.$kk['rekrut_klan'].'"');
				$kkr = mysql_fetch_assoc($q);
			}
		}

		if (!$kk || $kk['base_klan'] > 0 || $kk['glava'] != $us['id']) {
			echo "<font color=red><b>Ошибка! Не найден клан заявителя или это глава рекрут клана или это уже не глава!</b></font>";
		} else {

		$q = mysql_query('START TRANSACTION') or die();
		$comr['addinfo'] = unserialize($comr['addinfo']);

		mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$id) or die();

		// обновляем кланинфу
		mysql_query('UPDATE oldbk.`clans` SET align = "'.$comr['addinfo']['klanalign'].'" WHERE id = '.$kk['id']) or die();
		if ($kkr) mysql_query('UPDATE oldbk.`clans` SET align = "'.$comr['addinfo']['klanalign'].'" WHERE id = '.$kkr['id']) or die();

		// обновляем тела
		mysql_query('UPDATE oldbk.users SET align = "'.$comr['addinfo']['klanalign'].'" WHERE klan = "'.$kk['short'].'" and id_city = 0') or die();
		mysql_query('UPDATE avalon.users SET align = "'.$comr['addinfo']['klanalign'].'" WHERE klan = "'.$kk['short'].'" and id_city = 1') or die();
		mysql_query('UPDATE angels.users SET align = "'.$comr['addinfo']['klanalign'].'" WHERE klan = "'.$kk['short'].'" and id_city = 2') or die();

		if ($kkr) {
			mysql_query('UPDATE oldbk.users SET align = "'.$comr['addinfo']['klanalign'].'" WHERE klan = "'.$kkr['short'].'" and id_city = 0') or die();
			mysql_query('UPDATE avalon.users SET align = "'.$comr['addinfo']['klanalign'].'" WHERE klan = "'.$kkr['short'].'" and id_city = 1') or die();
			mysql_query('UPDATE angels.users SET align = "'.$comr['addinfo']['klanalign'].'" WHERE klan = "'.$kkr['short'].'" and id_city = 2') or die();
		}

		$q = mysql_query('COMMIT') or die();

		$messtel="Ваша заявка по изменению склонности клана удовлетворена.";
		if ($us['odate'] > (time()-60)) {
			addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
		} else  {
			mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
		}

		echo "<font color=red><b>Успешно изменена склонность</b></font>";
		}
	}
}
else
if ($act=='makepclear' and $id !='' and $isadmin==1) {
	$comr = mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($comr !== FALSE && $comr['paid'] != "") {
		$tar = check_users_city_data($comr['charid']);
		if ($tar['klan']!='' ) {
			echo "<font color=red><b>Персонаж \"".$tar['login']."\" состоит в клане!</b></font>";
		} else {
			$db_city[0]='oldbk.';
			$db_city[1]='avalon.';
			$db_city[2]='angels.';

			$magictime=time()+604800;

			if (mysql_query("INSERT INTO ".$db_city[$tar[id_city]]."`effects` (`owner`,`name`,`time`,`type`) values ('".$tar['id']."','Паладинская проверка','".$magictime."','20');")) {
				$messtel="Помечено, что персонаж чист перед законом";
				if ($tar['odate'] > (time()-60)) {
					addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$tar['login'].'{[]}',$tar['room'],$tar['id_city']);
				} else  {
					mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$tar['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
				}


				$mess = $user." сделал пометку что ".$tar['login']." чист перед законом (КО)";
				mysql_query("INSERT INTO oldbk.`lichka`(`id`,`pers`,`text`,`date`) VALUES ('','".$tar['id']."','$mess','".time()."');");

				mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.' '.$user.'" WHERE id = '.$id);

				echo "<font color=red><b>Успешно поставлена проверка персонажу ".$tar['login']."</b></font>";
			}

		}

	}
}
else
if ($act=='answer' and $id !='')
	{

	$get_id_char=mysql_fetch_array(mysql_query('SELECT * FROM `com_requests` WHERE `Id` = \''.$id.'\' LIMIT 1;'));
	if ($get_id_char[charid]>0)
	  {
            mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values
                         ('".$get_id_char[charid]."','','<font color=red><i>Ответ от Коммерческого отдела на заявку №".$id."</i>:</font>".$_REQUEST['coment']."');");

$aa = '
Здравствуйте '.$get_id_char['login'].'!

В коммерческом отделе OLDBK.COM появился ответ на Ваш запрос:
https://oldbk.com/commerce/

'.$_REQUEST['coment'].'

С уважением,
Коммерческий отдел OLDBK.COM';

		if ($emailfromusers == 1) {
			$tar = check_users_city_data($get_id_char['charid']);
			$get_id_char['email'] = $tar['email'];
		}
		mailnew($get_id_char['email'],"OLDBK.COM Ответ / ".$get_id_char['type']." (".$get_id_char['Id'].")",$aa, false);
	  }

	$modername='[:'.$user.':] ';

	$addsql = "";
	if ($_REQUEST['act'] == "answer" && $get_id_char['status'] !='Ожидается оплата' && $get_id_char['status'] != '') $addsql = ', status = NULL ';

	 mysql_query("UPDATE com_requests SET showed = 0, `comment`=CONCAT(`comment`,'<br><font color=red> ".$now.": ".$modername.$_REQUEST['coment']."</font>') ".$addsql." WHERE `Id`=".$id);

	 if (!$skipanswbottom) {
		 echo "<script>this.document.location.href='index.php';</script>";
		 page_bottom();
		 exit;
	 }
	}
else
if ($act=='declare' and $id !='' and $isadmin==1)
{
	mysql_query("UPDATE com_requests SET `whodoit`='2' WHERE `Id`=".$id); echo "<script>this.document.location.href='index.php';</script>"; exit();
}
else
if ($act=='paid' and $id !='' and $isadmin==1)
{
	 mysql_query("UPDATE com_requests SET `paid`='Оплачено ".$now."' WHERE `Id`=".$id);
	 echo "<script>this.document.location.href='index.php';</script>";
	page_bottom();
	exit;
}
else
if ($act=='del' and $id !='' and $isadmin==1)
{
	mysql_query("DELETE FROM com_requests WHERE `Id`=".$id); echo "<script>this.document.location.href='index.php".$addon."';</script>";
	page_bottom();
	exit;
}

$query="SELECT Id from com_requests ".$where.";";
//echo $query;
$res=mysql_query($query);
$quant=mysql_num_rows($res);
if (is_int(intval($_REQUEST['page'])))
	{
	 $page_num=intval($_REQUEST['page']);
	 if ($page_num==0) {$page_num=1;}
	}
else	{$page_num=1;}
$start_id=($page_num-1)*10; // Кол-во на странице

$query="SELECT * from com_requests ".$where." order by `utime` DESC, `id` desc limit ".$start_id.",10;";
$res=mysql_query($query);
while ($r=mysql_fetch_array($res))
	{
	 echo "<form method=post>
	 <input type=hidden name='id' value='".$r['Id']."'>
	 <div class='item'><b>".date("d.m.y H:i",$r['mess_time'])."</b> ";
	 echo "Заявка от <b>".$r['login']."<a href=http://capitalcity.oldbk.com/inf.php?".$r['charid']." target=_blank><IMG SRC=https://i.oldbk.com/i/inf.gif></a></b><br>";
	 echo "Тип заявки: ".$r['type'];
	 if ($r['type'] == "Присоединить рекрут-клан") {
		$r['addinfo'] = explode("/",$r['addinfo']);
		$q = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.clans WHERE id = '.intval($r['addinfo'][1])));
		if ($q) {
			echo ' <b>'.$q['short'].'</b>';
		} else {
			echo '<font color=red>ОШИБКА!!!</font>';
		}
	 }

	 if ($r['type'] == "Смена склонности клана и соклановцам") {
		$r['addinfo'] = unserialize($r['addinfo']);
		echo ' на <img src="https://i.oldbk.com/i/align_'.$r['addinfo']['klanalign'].'.gif">';
	 }
	 echo "<br>";
	 echo "<b>Номер заявки</b>: ".$r['Id']."<br>";


	if ($isadmin)
	 {
 	 echo "Комментарий заявителя: ".$r['comment']."<br>";
 	 }
 	 else
 	 {
	$string=$r['comment'] ;
	$string=preg_replace("!\[\:(.*?)\:\]!si","",$string);
 	 echo "Комментарий заявителя: ".$string."<br>";
 	 }

  	 if (!empty($r['email'])) echo "<b>Email:</b> ".$r['email']."<br>";
  	 if ($r['ip'] != 0) echo "<b>IP:</b> <a href=https://apps.db.ripe.net/search/query.html?searchtext=".long2ip($r['ip'])."+&search%3AdoSearch=Search target=_blank>".long2ip($r['ip'])."</a><br>";
  	 echo "Оплата заявки: ".$r['paid']."<br>";
	 if ($r['whodoit']!='') {$whodoit='Младший админ';}
  	 echo "Кто выполняет: ".$whodoit."<br>";
	 if ($r['status']!='')
		{echo "Статус заявки: ".$r['status']."<br>";}
	 echo "<br>";
	 echo "Действия: &nbsp;";
	 if ($isadmin==1)
	 	{
		 if ($r['paid'] !='')	{$but_status=' disabled="disabled" ';} else {$but_status='';}
		 if ($page=='whatpaid')	{echo "<input type=hidden name='whatpaid' value='yes'>";}
		 echo "<button id='enter1' type=submit ".$but_status." onClick='this.name=\"act\"; this.value=\"paid\"'>Оплачено</button> &nbsp;";
		 if ($r['whodoit'] !='' or $act=='done')	{$but_status=' disabled="disabled" ';} else {$but_status='';}
		 if ($page=='whatdeclared')	{echo "<input type=hidden name='whatdeclared' value='yes'>";}
		 echo "<button id='enter1' type=submit ".$but_status." onClick='this.name=\"act\"; this.value=\"declare\"'>Передать</button> &nbsp;";
		 if ($page=='doned')	{echo "<input type=hidden name='doned' value='yes'>";}
		 echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"del\"'>Удалить</button> &nbsp;";
//		 echo "<a href=index.php?act=paid&id=".$r['Id'].">Оплачено</a>
//	 	 <a href=index.php?act=declare&id=".$r['Id'].">Передать</a>
//	 	 <a href=index.php?act=del&id=".$r['Id'].">Удалить</a>";
		}
	if ($r['paid']!='')
		{
		 if ($r['status'] !='')	{$but_status=' disabled="disabled" ';} else {$but_status='';}
		 if ($r['type'] != "Смена емейла персонажа" && $r['type'] != "Сброс второго пароля персонажа" && $r['type'] != "Экспресс проверка на чистоту") {
			 echo "<button id='enter1' type=button ".$but_status." onClick='javascript:new_runmagic(this,".$r['Id'].",1);'>Сделано</button> &nbsp;";
		}
//		 echo "<a href=index.php?act=makedone&id=".$r['Id'].">Сделано</a> <br><br></div></form>";
	} else {
		 echo "<button id='enter1' type=submit disabled='disabled' onClick='this.name=\"act\"; this.value=\"makedone\"'>Не оплачено</button> &nbsp;";
//		 echo "<font color=red>Заявка еще не оплачена!</font><br><br></div></form>";
	}

	if ($r['type'] == "Смена главы клана") {
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeglavachange\"'>Изменить главу</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",11);'>Отказать</button>";

	}

	if ($r['type'] == "Смена склонности клана и соклановцам") {
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeklanchange\"'>Изменить склонность</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",6);'>Отказать в склонности</button> &nbsp;";
	}

	if ($r['type'] == "Экспресс проверка на чистоту" && $r['status'] == '') {
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makepclear\"'>Поставить проверку</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",3);'>Отклонить</button> &nbsp;";
	}

	if ($r['type'] == "Присоединить рекрут-клан" && $r['status'] == '') {
		if ($r['addinfo'][0] == 0) {
			echo '<font color=red>Нет ответа от главы</font> ';
		}
		if ($r['addinfo'][0] == 1) {
			echo '<font color=green>Одобрено главой</font> ';
		}
		if ($r['addinfo'][0] == 2) {
			echo '<font color=red><b>Отказано главой</b></font> ';
		}
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeaddrekrut\"'>Присоединить</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",7);'>Отклонить</button> &nbsp;";
	}

	/*
	if ($r['type'] == "Отсоединить рекрут-клан" && $r['status'] == '') {
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeremoverekrut\"'>Отсоединить</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",8);'>Отклонить</button> &nbsp;";
	}*/


	if ($r['type'] == "Сброс второго пароля персонажа" && $r['status'] == '') {
		$fname = md5($r['mess_time'].$r['charid'])."_".$r['charid'].".";
		if (file_exists('./uploadscan/'.$fname."jpeg")) $fname .= "jpeg";
		if (file_exists('./uploadscan/'.$fname."gif")) $fname .= "gif";
		if (file_exists('./uploadscan/'.$fname."png")) $fname .= "png";
		if (file_exists('./uploadscan/'.$fname."bmp")) $fname .= "bmp";
		echo '<a href="./uploadscan/'.$fname.'" target="_blank">Скан</a> &nbsp;';
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makereset\"'>Обнулить</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",4);'>Отклонить</button> &nbsp;";
	}

	if ($r['type'] == "Смена пола персонажа" && $r['status'] == '') {
		$usinfo = check_users_city_data($r['charid']);
		$wht = ($usinfo['sex'] == 1 ? "женский" : "мужской");
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makechangesex\"'>Сменить пол на ".$wht."</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",10);'>Отклонить</button> &nbsp;";
	}


	if ($r['type'] == "Смена даты рождения персонажа" && $r['status'] == '') {
		$fname = md5($r['mess_time'].$r['charid'])."_".$r['charid'].".";
		if (file_exists('./uploadscan/'.$fname."jpeg")) $fname .= "jpeg";
		if (file_exists('./uploadscan/'.$fname."gif")) $fname .= "gif";
		if (file_exists('./uploadscan/'.$fname."png")) $fname .= "png";
		if (file_exists('./uploadscan/'.$fname."bmp")) $fname .= "bmp";
		echo '<a href="./uploadscan/'.$fname.'" target="_blank">Скан</a> &nbsp;';
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeresetbd\"'>Сменить на ".$r['addinfo']."</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",9);'>Отклонить</button> &nbsp;";
	}


	if ($r['type'] == "Смена емейла персонажа" && $r['status'] == '') {
		$fname = md5($r['mess_time'].$r['charid'])."_".$r['charid']."_1.";
		if (file_exists('./uploadscan/'.$fname."jpeg")) $fname .= "jpeg";
		if (file_exists('./uploadscan/'.$fname."gif")) $fname .= "gif";
		if (file_exists('./uploadscan/'.$fname."png")) $fname .= "png";
		if (file_exists('./uploadscan/'.$fname."bmp")) $fname .= "bmp";
		$re = unserialize($r['addinfo']);
		$fc1 = $fc2 = "";
		$tar = check_users_city_data($r['charid']);
		if ($r[0] != $tar['email']) {
			$fc1 = "<font color=red>";
			$fc2 = "</font>";
		}

		echo '<a href="./uploadscan/'.$fname.'" target="_blank">Скан</a> (<b>'.$fc1.$re[0].$fc2.'</b> / <b>'.$re[1].'</b>) &nbsp;';
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeresetemail\"'>Сменить</button> &nbsp;";
		echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",5);'>Отклонить</button> &nbsp;";
	}

	if (empty($r['status'])) {
		echo "<button id='enter1' type=submit onClick='this.name=\"act\"; this.value=\"makeclose\"'>Закрыть</button> &nbsp;";
	}

	echo "<button id='enter1' type=button onClick='javascript:new_runmagic(this,".$r['Id'].",2);'>Ответить</button><br><br></div></form><hr width=100% height=2><hr width=100% height=2>";
}
$_REQUEST['search']=urlencode($_REQUEST['search']);
$_REQUEST['field']=urlencode($_REQUEST['field']);
$pages=ceil($quant/10); // Кол-во на странице
echo "<br><center>...";
for($i=1; $i<$pages+1; $i++)
	{
	 if ($i>$page_num-10 and $i<$page_num+10)
		{
		 if ($i==$page_num)
			{echo " <b>$i</b>";}
		 else	{echo " <a href=?page=$i&act=$act&search=".$_REQUEST['search']."&field=".$_REQUEST['field'].">$i</a>";}
		}
	}
echo "...</center>";
 }



}

function ShowAuthForm()	{
//не авторизованый пользователь
	if ($_REQUEST['act']=='needlogin')
	{
	needauth();
	}


?>
</table>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="text1 cont_bg">

<br>
Введите свой игровой ник и игровой пароль
<form method="post"  action="index.php">
<input type="text" name="login" class="inp1" value="Логин" onfocus="javascript:this.value='';" />
<input type="password" name="psw" class="input" value="Пароль" onfocus="javascript:this.value='';" />
<input type="submit" id="enter"   value="Войти" class="button" style="border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 12px;  height:22px;font-family:Tahoma;font-weight:bold;" /></form>


<p>Коммерческий отдел ОлдБК поможет Вашему персонажу или клану усилиться и обрести уникальность,<br>
а также, окажет посильную помощь в решении некоторых проблемных ситуаций.</p>
<p>Оставьте заявку на любую из услуг Коммерческого отдела и в течение 3-5 дней Ваша заявка будет рассмотрена.</p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<?
ShowVitrina();

}
function ShowComMessageForm()	{
global $user;

ShowVitrina(true);
/*
<form method="post" action="index.php" id="mainform">
<input type="hidden" name="nick" value="<?php echo $user;?>" >
<div class="item"></div>
ShowMKArt();
print_price();
</form>
*/

}



function ShowGlavaChange() {
	global $user;
	global $PRICE;

$view=true;

	if (isset($_POST['mkecids'])) {
			$us = check_users_city_datal($user);
			$bprice = $PRICE[104][cost];
			$useditems = "";

			$usgl=mysql_fetch_assoc(mysql_query("select * from users where id=(select glava from oldbk.clans where short='{$us['klan']}')"));
		if (((time()-$usgl['ldate'])>=5184000) or ($usgl['klan']!=$us['klan']) )  // Если глава активный персонаж, тобишь был в клубе последние 60 дней - скрываем форму оплаты заявки, пишем - "Глава клана "Название_Клана" активный персонаж".
		{

			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			elseif ($_POST['comment']=='')
			{
			serr("Вы не указали причину!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем
									serr("Вы удачно оплатили запрос на смену главы клана");

									$q = mysql_query('START TRANSACTION') or die();

									//  оплата
									$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
									if (!(mysql_num_rows($get_bank) > 0) )
									{
									die();
									}
									else
									{
									$bank = mysql_fetch_assoc($get_bank);

									mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
									//  пишем в хистори банка
									$bank['ekr']-=$bprice;
									mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
									}

									$rec = array();
						    			$rec['owner']=$us[id];
									$rec['owner_login']=$us[login];
									$rec['owner_balans_do']=$us['money'];
									$rec['owner_balans_posle']=$us['money'];
									$rec['owner_rep_do']=$us['repmoney'];
									$rec['target_login'] = "КО";
									$rec['owner_rep_posle']=$us['repmoney'];
									$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
									$rec['type'] = 2282;
									$rec['sum_ekr']=$bprice;
									$rec['bank_id']=$bank['id'];
									if (add_to_new_delo($rec) === FALSE) die();

									// пишем в ком отдел

									$now=date("d.m.y H:i",time());
									$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`bank_id`) VALUES ('".time()."','".$user."', 'Смена главы клана', '".mysql_real_escape_string($_POST['comment'])."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','{$bank['id']}');";
									mysql_query($query) or die();
									// всё ок, закончили
									$q = mysql_query('COMMIT') or die();
									echo "
										<br>
										<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
										</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
										</div>
									        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";
										echo "</td></tr>";
									$view=false;
						}
					}
						else
						{
						serr('Ошибка! Не верный пароль от банковского счета!');
						}
		}
	    }
	}

if ($view==true)
	{
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> Смена главы клана</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$us = check_users_city_datal($user);
					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";

								$usgl=mysql_fetch_assoc(mysql_query("select * from users where id=(select glava from oldbk.clans where short='{$us['klan']}')"));
								if (((time()-$usgl['ldate'])>=5184000) or ($usgl['klan']!=$us['klan']) )  // Если глава активный персонаж, тобишь был в клубе последние 60 дней - скрываем форму оплаты заявки, пишем - "Глава клана "Название_Клана" активный персонаж".
									{
									echo '
									<center>
									К оплате сумма: '.$PRICE[104][cost].' екр.<br>
									<br><form id="mkec" method="POST">
									Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
									Причина:<input type="text" id="comment" name="comment" value=""><br>
										<input type="hidden" id="mkecids" name="mkecids" value="Yes">
										<input type="hidden" id="services" name="services" value="Смена главы клана">
										<input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();">';
									echo '</center>';
									echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>';
									}
									else
									{
									echo '<center><br><b>Глава клана "'.$us['klan'].'" - активный персонаж.</b>';
									echo '</center>';
									}
					}
	}
}



function ShowClanRestore() {
	global $user;
	global $PRICE;

$view=true;
$us = check_users_city_datal($user);

	if (isset($_POST['mkecids'])) {


			$bprice = $PRICE[215][cost];
			$useditems = "";


			if (($_POST['bankpass']=='') OR ($_POST['bankid']=='') )
			{
			serr("Вы не указали пароль от банковского счета!");
			}
			else
			{
				$bankid=(int)($_POST['bankid']);
				$bankpas=$_POST['bankpass'];
				$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

				if ($bank[id]>0)
					{
						if (($bank['ekr']) < $bprice)
						{
							serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$bprice." екр.");
						} else
						{
									// всё ок - начинаем

											serr("Вы удачно оплатили запрос на восстановление клана после расформирования (при неуплате налога)");

												$q = mysql_query('START TRANSACTION') or die();

												//оплата
														$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$bprice."  FOR UPDATE ;");
														if (!(mysql_num_rows($get_bank) > 0) )
														{
														die();
														}
														else
														{
														$bank = mysql_fetch_assoc($get_bank);

														mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
														//  пишем в хистори банка
														$bank['ekr']-=$bprice;
														mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
														}


												$rec = array();
									    			$rec['owner']=$us[id];
												$rec['owner_login']=$us[login];
												$rec['owner_balans_do']=$us['money'];
												$rec['owner_balans_posle']=$us['money'];
												$rec['owner_rep_do']=$us['repmoney'];
												$rec['target_login'] = "КО";
												$rec['owner_rep_posle']=$us['repmoney'];
												$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
												$rec['type'] = 2282;
												$rec['sum_ekr']=$bprice;
												$rec['bank_id']=$bank['id'];
												if (add_to_new_delo($rec) === FALSE) die();


												// пишем в ком отдел

												$now=date("d.m.y H:i",time());
												$query="INSERT into com_requests (`mess_time`, `login`, `type`, `comment`, `charid`,`email`,`paid`,`ip`,`bank_id`) VALUES ('".time()."','".$user."', 'Восстановление клана после расформирования (при неуплате налога)', '".$_SESSION['mkecadd']['comment']."', '".$_SESSION['uid']."', '".$_SESSION['mkecadd']['comemail']."','Оплачено ".$now."','".ip2long(REMIP)."','{$bank['id']}');";
												mysql_query($query) or die();



												// всё ок, закончили
												$q = mysql_query('COMMIT') or die();
												echo "
												<br>
												<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
												</center><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
												</div>
											        <script>//setTimeout('this.document.location.href=\'index.php\'',5000);</script>";

												echo "</td></tr>";
												$view=false;
							}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					}
			}

	}
if ($view==true)
	 {
		$_SESSION['mkecadd'] = $_POST;
		echo "<br>
		<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
		<tr>
		<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
		</tr>
		<tr>
		<td class=\"cont_bg\">
		<center><b style=\"color:#800000\"> Восстановление клана после расформирования (при неуплате налога)</b></center></td></tr>
		<tr><td class=\"text1 cont_bg\"><br>
		<table align=center><tr align=left><td>
		<p><b style=\"color:#800000\">


		</td></tr></table>
		</td>
		</tr>
		<tr>
		<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
		</tr>
		</table>
		<br><br>";

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";
								echo '
										<center>
										<form id="mkec" method="POST">
										К оплате сумма: '.$PRICE[215][cost].' екр.<br><br>
										Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
										<input type="hidden" id="mkecids" name="mkecids" value="Yes">
										<input type="hidden" id="services" name="services" value="Восстановление клана после расформирования (при неуплате налога)">
										<input type="button" value="ОПЛАТИТЬ" class="button2" name="ОПЛАТИТЬ" OnClick="CheckF();"></center>';
								echo '</form>
										<script>
												function CheckF() {
												if (confirm("Вы уверены?")) {
													document.getElementById("mkec").submit();
												}

											}
										</script>
										';

					}
	}
}




function needauth()
{
echo '
		<tr>
		<td height="50" align="center" valign="top" class="zagolovok"><b>Для входа в раздел необходимо авторизироваться!</b></td>
		</tr>';
}


function ShowPrice()	{
	echo "<br><br><a href=index.php>Невыполненные заявки</a> | <a href=index.php?act=done>Выполненные заявки</a> | <a href=index.php?act=whatpaid>Оплаченные заявки</a> | <a href=index.php?act=whatdeclared>Переданные заявки</a> | <a href=index.php?price=yes>Прайс</a>";

	print_price();
}

// Функция быстрой авторизации по первому паролю для ком отдела, позволяет авторизоваться даже блокнутым.
// На входе: Логин, пароль; На выходе Ллогин авторизовавшегося или FALSE
function AuthorizeToCommerce($user,$pass,$uid,$alog)	{
    //session_start();
    $aflag=false;
    if ($user && $pass)
    {
        $aflag=true;
        require_once "/www/oldbk.com/alg.php";
        require_once "/www/oldbk.com/libs/asp.php";

        $tmp = [];

        foreach($__psarr as $k=>$v) {
            $tmp[strtolowermy($k)] = $v;
        }

        $mylog = trim($user);
        $mylog = strtolowermy($mylog);

        if (isset($tmp[$mylog])) {
            if ($tmp[$mylog]['p'] === $pass) {
                $data = mysql_fetch_assoc(mysql_query("SELECT * FROM `users` WHERE id='{$tmp[$mylog]['i']}' and `login` = '".mysql_real_escape_string($mylog)."' LIMIT 1;"));
            } else {
                $data = false;
            }
        } else {
            $data = false;
            /** @var \components\Eloquent\User $_User */
            $_User = \components\Eloquent\User::where('login', '=', $user)->first();
            if($_User && $_User->validatePassword($pass) === true) {
                $data = $_User->toArray();
            }
        }

    }
    else
        if ($uid && isset($_SESSION['uid']))
        {
            $data=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`users` WHERE `id` = ".intval($_SESSION['uid'])));

        }
        else
        {
            return false;
        }

    if (!($data[id]>0)) {


        echo '
		<tr>
		<td height="50" align="center" valign="top" class="zagolovok"><b>Неверный логин или пароль!</b></td>
		</tr>';


        unset($_SESSION['uid']);
        unset($_SESSION['uid2']);
        unset($_SESSION['KO_login']);
        unset($_SESSION['sid']);
        unset($_SESSION['view']);
        unset($_SESSION['chpass']);
        unset($_SESSION['oldalg']);
        unset($_SESSION['save_proto_memory']);
        unset($_SESSION['usrmail']);
        unset($_SESSION);
        ShowAuthForm();
        page_bottom();
        exit;
    }
    else
    {

        if (($data['login']!='') and ($data[id]>0))
        {

            if (!empty($_SERVER['HTTP_CF_CONNECTING_IP'])) {
                $myip = $_SERVER['HTTP_CF_CONNECTING_IP'];
            } else {
                $myip = $_SERVER['REMOTE_ADDR'];
            }


            mysql_query("INSERT INTO `iplog`
			    (owner,ip,date)
			    values
			    ('".$data['id']."','$myip','".time()."');");

            $_SESSION['sid'] = session_id();
            $_SESSION['view'] = $data['level'];
            $_SESSION['uid'] = $data['id'];

            if ($aflag)
            {
                $_SESSION['KO_login'] = true;
            }

            $_SESSION['ip']=REMIP;
            $_SESSION['usrmail'] =$data['email'];
            return $data['login'];
        }
        else
        {
            return false;
        }
    }
}

function get_text_stat($s,$m)
{

	if ($s==-1)
	{
	$out='На проверке';
	}
	else
	if ($s==0)
	{
	$out='Ожидается оплата';
		if ($m>0) echo "<br>(Одобрен)";
	}
	else if ($s==1)
	{
	$out='Ожидается установка';
		if ($m>0) echo "<br>(Одобрен)";
	}
	else if ($s==2)
	{
	$out='Выполнен';
	}
	else if ($s==100)
	{
	$out='Удален';
	}

if ($out)
	{
	return $out;
	}
	else
	{
	return 'Неизвестен';
	}
}

function ReturnVauchToTelo($howmany, $telo_id,$bank_id)
{
	$art_telo = mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$telo_id."'  ;"));

	if ($art_telo['id']>0)
		{

						   		$bank=mysql_fetch_array(mysql_query("select * from oldbk.bank  where  `id`= '{$bank_id}' "));
								mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` + {$howmany}  WHERE `id`= '{$bank_id}' ");
								//  пишем в хистори банка
								$bank['ekr']+=$howmany;
								mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Возврат при отказе услуг Коммерческого отдела <b>{$howmany} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank_id}');");

										//new_delo
										$rec = array();
										$rec['owner']=$art_telo[id];
										$rec['owner_login']=$art_telo[login];
										$rec['owner_balans_do']=$art_telo['money'];
										$rec['owner_balans_posle']=$art_telo['money'];
										$rec['target_login']="КО";
										$rec['type']=1280;//получил екр назад
										$rec['sum_kr']=0;
										$rec['sum_ekr']=$howmany;
										$rec['sum_kom']=0;
										$rec['bank_id']=$bank_id;
										if (add_to_new_delo($rec) === FALSE) die();
		}
		else
		{
		echo "<br>Внимание персонаж с таким ID в базе не найден!<br>";
		}

if ($bank_id==0)
	{
	echo "<br>Внимание ошибка банковкого счета!!!<br>";
	}

}

function ReturnVauchToTelo_old_function_off($howmany, $telo_id) {
	if ($howmany < 5) return;
	$img_telo = mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$telo_id."'  ;"));
	if ($img_telo[id_city]==1) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$img_telo[id]."'  ;")); }
	elseif ($img_telo[id_city]==2) { $img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$img_telo[id]."'  ;")); }

	$vch = array (	5   => 100005,	15  => 100015,	20  => 100020,	25  => 100025,	40  => 100040,	100 => 100100,	200 => 100200,	300 => 100300	);

	$retmoney = $howmany; //сколько вернуть
	$nominals = array(300,200,100,40,25,20,15,5);
	$newret = array();

	while(list($k,$v) = each($nominals)) {
		$z = floor($retmoney / $v);
		if ($z > 0) {
			$newret[$v] = $z;
			$retmoney = $retmoney - ($z*$v);
		}
	}

	$vdress = array();

	$nomlist = "";

	while(list($k,$v) = each($newret)) {
		if (!isset($vdress[$k])) {
			$t = mysql_query('select * from oldbk.eshop where id = '.$vch[$k]) or die();
			$vdress[$k] = mysql_fetch_array($t);
		}

		$dress = $vdress[$k];
		if ($dress['id'] > 0) {
			for($i = 0; $i < $v; $i++) {
				$nomlist .= $k."екр, ";
				mysql_query("INSERT INTO oldbk.`inventory`
					(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
					`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
					`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
					`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
					)
					VALUES
					('{$dress['id']}','{$img_telo[id]}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
					'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
					'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
					,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$img_telo[id]}'
					);
				") or die();

				//new_delo
				$rec = array();
	    			$rec['owner']=$img_telo[id];
				$rec['owner_login']=$img_telo[login];
				$rec['owner_balans_do']=$img_telo['money'];
				$rec['owner_balans_posle']=$img_telo['money'];
				$rec['target_login']="КО";
				$rec['type']=283;//получил ваучер при отказе
				$rec['sum_kr']=0;
				$rec['sum_ekr']=$k;
				$rec['sum_kom']=0;
				$rec['item_id']=get_xitem_fid(array("idcity" => $img_telo['id_city'], "id" => mysql_insert_id()));
				$rec['item_name']=$dress[name];
				$rec['item_count']=1;
				$rec['item_type']=$dress['type'];
				$rec['item_cost']=$dress['cost'];
				$rec['item_dur']=$dress['duration'];
				$rec['item_maxdur']=$dress['maxdur'];
				$rec['item_ups']=$dress['ups'];
				$rec['item_unic']=$dress['unic'];
				$rec['item_incmagic']=$dress['includemagicname'];
				$rec['item_incmagic_count']=$dress['includemagicuses'];
				$rec['item_arsenal']='';
				$rec['bank_id']='';
				$rec['add_info']='Возврат при отказе в Коммерческом отделе';
				$rec['item_proto']=$dress['prototype'];
				$rec['item_sowner']=($dress['sowner']>0?1:0);
				$rec['item_incmagic_id']=$dress['includemagic'];
				if (add_to_new_delo($rec) === FALSE) die();
				$send=1;

			}
		}
	}
}



function ShowMyRequests()
{
global $PRICE,$user;

	if ($_GET['express'])
	{
	$ide=(int)($_GET['express']);
	$zak_art=mysql_fetch_array(mysql_query("SELECT * from oldbk.art_prototype WHERE `owner`='".$_SESSION['uid']."'  and id='{$ide}';"));
	$us = check_users_city_datal($user);

	if (($zak_art['id']>0) and ($zak_art['battle']==0))
		{
				if ($_SERVER['REQUEST_METHOD'] == "POST")
				{
				//обработка

								if (($_POST['bankpass']=="") OR ($_POST['bankid']=="") )
								{
								$err_stop="Вы не указали пароль от банковского счета для оплаты экспресс рассмотрение заявки!";
								}
								else
								{

									$bankid=(int)($_POST['bankid']);
									$bankpas=$_POST['bankpass'];
									$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

									if ($bank[id]>0)
										{

											if (($bank['ekr']) < $PRICE[207][cost] )
											{
												$err_stop=("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$PRICE[207][cost]." екр.");
											} else
											{
												// всё ок
												//снимаем деньги за оплату експерсс
												$q = mysql_query('START TRANSACTION') or die();
												//оплачиваем
												$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$PRICE[207][cost]."  FOR UPDATE ;");
												if (!(mysql_num_rows($get_bank) > 0) )
												{
												die();
												}
												else
												{
												$bank = mysql_fetch_assoc($get_bank);

												mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$PRICE[207][cost]}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ") or die() ;
												//  пишем в хистори банка
												$bank['ekr']-=$PRICE[207][cost];
												mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$PRICE[207][cost]} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');") or die();
												}
												$rec = array();
									    			$rec['owner']=$us[id];
												$rec['owner_login']=$us[login];
												$rec['owner_balans_do']=$us['money'];
												$rec['owner_balans_posle']=$us['money'];
												$rec['owner_rep_do']=$us['repmoney'];
												$rec['target_login'] = "КО";
												$rec['owner_rep_posle']=$us['repmoney'];
												$rec['type'] = 2282;
												$rec['sum_ekr']=$PRICE[207][cost];
												$rec['bank_id']=$bank['id'];
												$rec['add_info']='Оплата заявки на утверждение артефакта №'.$ide;
												if (add_to_new_delo($rec) === FALSE) die();

												mysql_query("UPDATE oldbk.art_prototype SET battle=1 WHERE `owner`='".$_SESSION['uid']."'  and id='{$ide}';") or die();

												$q = mysql_query('COMMIT') or die();
												$noprint_bank_form=true;
												$err_stop='Заявка на утверждение артефакта №'.$ide.' удачно оплачена!';
											}
										}
										else
										{
										$err_stop='Ошибка! Не верный пароль от банковского счета, для оплаты экспресс рассмотрение заявки!';
										}
								}
				////////////////////
				}

				echo "	<table width=\"880\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" >";
				echo "<tr><td align=center><br><br><b style=\"color:#800000\"> ОПЛАТА ЭКСПРЕСС ПРОВЕРКИ </b>";
				echo "<br><br><br>
				<table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

					echo "<tr class=text3 bgcolor='$co[$c]'><td>";
					echo "<center><b>Заказ №";
					echo $zak_art[id];
					echo "</b></center>";
					echo "</td>";
					echo "<td>";


					if ($zak_art[sowner] > 0)
					{
					echo "<div class=text4>Личный артефакт - ";
					}
					else
					{
					echo "<div class=text4>Клановый артефакт (клан ".$zak_art[arsenal_klan]." ) - ";
					}
					echo "«".$zak_art[name]."»</div>";
					echo "</td>";
					echo "<td>";
					echo "<center><div class=text4> Дата: ".$zak_art[art_zakdate]."</div></center>";
					echo "</td></tr>";

					echo "<tr><td colspan=3>";


					if ($err_stop) echo "<center><font color=red><b>$err_stop</b></font></center><br>";

					if ($noprint_bank_form!=true)
					{
						   	echo "<form id=\"form1\" name=\"form1\" method=POST >";

								$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
								if (!(mysql_num_rows($get_bank) > 0) )
										{
										echo '<font color=red>У вас нет доступных банковских счетов!</font>';
										}
							else
							{
												$BANKS="<select style='width:150px' name=bankid>";
												while($row = mysql_fetch_assoc($get_bank))
												{
												$BANKS.="<option>".$row['id']."</option>";
												}
												$BANKS.="</select>";

										echo '<center>
										Оплатить <b>'.$PRICE[207][cost].' екр</b> для  экспресс проверки:<br>

										<div id="allconstr">

											<br>
											Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass>  ';
							}

						echo "<input type=submit name=payexpr class=button2 value='Оплатить'>";
						echo "</div></center></form>";
					}

					echo "</td></tr>";

					echo "<br><br></td></tr></TABLE>";
		 }
		 else
		 {
		 	echo "	<table width=\"880\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" > Ошибка!";
		 }
	}
else
{
$us = check_users_city_datal($user);
mysql_query('UPDATE com_requests SET showed = 1 WHERE charid = '.$us['id']);

$kk = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"'));

if ($_SERVER['REQUEST_METHOD'] == "POST") {
	if (isset($_POST['addrekrutid'])) {
		if (strlen($us['klan']) > 0 && $us['id'] == $kk['glava']) {
			$zak_rekrut=mysql_query('SELECT * from oldbk.com_requests WHERE type = "Присоединить рекрут-клан" and (status = "" or status is null) and addinfo = "0/'.$kk['id'].'" and Id ='.intval($_POST['addrekrutid']));
			if (mysql_num_rows($zak_rekrut)>0) {
				$zak_rekrut = mysql_fetch_assoc($zak_rekrut);
				$zak_rekrut['addinfo'] = explode('/',$zak_rekrut['addinfo']);
				if (isset($_POST['addrekrut_ok'])) {
					$zak_rekrut['addinfo'][0] = 1;
					echo '<font color=red>Вы одобрили присоединение к клану-основе.</font><br><br>';
				}
				if (isset($_POST['addrekrut_bad'])) {
					$zak_rekrut['addinfo'][0] = 2;
					echo '<font color=red>Вы отказали в присоединение к клану-основе.</font><br><br>';

					$comr = $zak_rekrut;
					$us = check_users_city_data($comr['charid']);

					$q = mysql_query('START TRANSACTION') or die();

					mysql_query('UPDATE oldbk.`com_requests` SET status = "Сделано '.$now.'" WHERE id = '.$comr['Id']) or die();

					$comr['bank_id']=check_bank_id($comr['bank_id'],$us['id']);
					ReturnVauchToTelo($PRICE[105][cost],$comr['charid'],$comr['bank_id']);

					$q = mysql_query('COMMIT') or die();

					$messtel="Вам отказано в присоединении рекрут-клана, оплата возвращена на счет №{$comr['bank_id']}.";
					if ($us['odate'] > (time()-60)) {
						addchp('<font color=red>Внимание!</font> '.$messtel,'{[]}'.$us['login'].'{[]}',$us['room'],$us['id_city']);
					} else  {
						mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$us['id']."','','<font color=red>Внимание!</font> ".$messtel."');");
					}

				}
				$zak_rekrut['addinfo'] = implode('/',$zak_rekrut['addinfo']);
				mysql_query('UPDATE oldbk.com_requests SET addinfo = "'.$zak_rekrut['addinfo'].'" WHERE Id = '.intval($_POST['addrekrutid']));
			}
		}
	}
}

$co[1]='#f4f2e9';
$co[2]='#f9f7ee';
$c=2;
echo "	<table width=\"880\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" >";

if ($us['klan'] && $us['id'] == $kk['glava']) {
$zak_rekrut=mysql_query('SELECT * from oldbk.com_requests WHERE type = "Присоединить рекрут-клан" and (status = "" or status is null) and addinfo = "0/'.$kk['id'].'"');

if (mysql_num_rows($zak_rekrut)>0)
	{

	echo "<tr><td align=center><br><br><b style=\"color:#800000\"> ЗАЯВКИ НА ПРИСОЕДИНЕНИЕ </b>";
	echo "<br><br><br><table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]'><td>";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Название клана-основы</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Действие</b></center>";
		echo "</td></tr>";


	while ($zak=mysql_fetch_array($zak_rekrut))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]'><td>";
		echo $zak['Id'];
		echo "</td>";
		echo "<td>";

		$us2 = check_users_city_data($zak['charid']);
		echo $us2['klan'];

		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".date("d.m.y H:i",$zak['mess_time'])."</div>";
		echo "</td>";
		echo "<td>";
		echo '<div class=text4 style="text-align:center;"><form method="POST"> <input type="hidden" name="addrekrutid" value="'.$zak['Id'].'"><input type="submit" id="button3" name="addrekrut_ok" value="Одобрить"> <input type="submit" name="addrekrut_bad" id="button3" value="Отказать"> </form></div>';
		echo "</td></tr>";

		}

	echo "</table><br><br></td></tr>";
	}
}
/////////////////////////////

$zak_m=mysql_query("SELECT * from oldbk.com_money WHERE `owner`='".$_SESSION['uid']."'  order by id desc;");

if ((mysql_num_rows($zak_m)>0) AND ($_SESSION['uid']!=56267) )
	{

	echo "<tr><td align=center><br><br><b style=\"color:#800000\"> ВАШИ ЗАЯВКИ НА ВЫВОД СРЕДСТВ</b>";
	echo "<br><br><br><table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]'><td>";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Информация</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Статус заявки</b></center>";
		echo "</td></tr>";

	while ($arow=mysql_fetch_array($zak_m))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]' align=center><td>";
		echo "WM".$arow['id'];
		echo "</td>";
		echo "<td>";
			echo "<div class=text4>Запрос вывода средств на сумму: <b>".$arow['msum']." $ OldBK => ".round(($arow['msum']*$arow['kof']),2)." WMZ</b>. <br>Курс: 1$ OldBK => ".$arow['kof']." WMZ <br> WMZ: ".$arow['outwmz'];

			if (($arow['stat']==3) AND ($arow['prim']!=''))
			{
			echo "<br><b>Причина отказа:</b><font color=red>".$arow['prim']."</font>";
			}

			echo "</div>";
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>";
		echo "<div class=text4 >заявка: <small>".date ("d.m.Y H:i:s" ,  strtotime($arow['mktime']) )."</small>";
				if ($arow['odobtime']!='0000-00-00 00:00:00')
					{
					echo "<br>проверка: <small>".date ("d.m.Y H:i:s" ,  strtotime($arow['odobtime']) )."</small>";
					}
		echo "</div>";
		echo "</td>";
		echo "<td>";
			echo "<div class=text4>";
				switch ($arow['stat'])
				{
					case "-1":
					echo "На проверке";
					break;
					case "0":
					echo "На рассмотрении";
					break;
					case "1":
					echo "Утверждено";
					break;
					case "2":
					echo "Выполнено";
					break;
					case "3":
					echo "Отказ";
					break;
				}
			echo "</div>";
		echo "</td></tr>";

		}

	echo "</table><br><br></td></tr>";
	}

/////////////////////////////


/////////////////////////////


$zak_art=mysql_query("SELECT * from oldbk.art_prototype WHERE `owner`='".$_SESSION['uid']."'  order by art_zakdate desc;");

if (mysql_num_rows($zak_art)>0)
	{

	echo "<tr><td align=center><br><br><b style=\"color:#800000\"> ВАШИ ЗАЯВКИ НА УСТАНОВКУ АРТЕФАКТОВ</b>";
	echo "<br><br><br><table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]' align=center ><td>";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Название</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Статус заказа</b></center>";
		echo "</td></tr>";

	while ($artit=mysql_fetch_array($zak_art))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]'><td>";
			echo $artit[id];
		echo "</td>";
		echo "<td>";

		if ($artit[sowner] > 0)
			{
			echo "<div class=text4>Личный артефакт - ";
			}
			else
			{
			echo "<div class=text4>Клановый артефакт (клан ".$artit[arsenal_klan]." ) - ";
			}
			echo "«".$artit[name]."»</div>";

		if (($artit['art_status']==100) AND ($artit['del_comm']!=''))
			{
			echo "<br><b>Причина отказа:</b><font color=red>".$artit['del_comm']."</font>";
			}
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".$artit[art_zakdate]."</div>";
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".get_text_stat($artit[art_status],$artit[art_mess])."</div>";
		if (($artit[art_status]==-1) and ($artit[battle]==0))
				{
				echo "<input type=button id=\"enter1\"  value='Сделать экспресс' onClick=\"location.href='?act=myrequest&express=".$artit['id']."';\">";
				}
		echo "</td></tr>";

		}

	echo "</table><br><br></td></tr>";
	}

/////////////////////////////

$zak_com=mysql_query("SELECT * from oldbk.com_service WHERE `owner`='".$_SESSION['uid']."' and (isnull(group_id) OR group_id=id) order by mtime DESC;");

if (mysql_num_rows($zak_com)>0)
	{
	$c=2;
	echo "<tr><td align=center><br><br><b style=\"color:#800000\"> ВАШИ ЗАКАЗЫ</b>";
	echo "<br><br><br><table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";

		echo "<tr class=text3 bgcolor='$co[$c]'><td>";
		echo "<center><b>№ заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Название услуги</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата заказа</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Статус заказа</b></center>";
		echo "</td></tr>";

	while ($zcom=mysql_fetch_array($zak_com))
		{
	      if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]'><td>";
		echo "<div class=text4>SC".$zcom[id]."</div>";
		echo "</td>";
		echo "<td>";

		echo "<div class=text4>".$PRICE[$zcom['type']][desc]."</div>";
		if (($zcom['stat']==100) AND ($zcom['del_comm']!=''))
			{
			echo "<br><b>Причина отказа:</b><font color=red>".$zcom['del_comm']."</font>";
			}
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".$zcom[mtime]."</div>";
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".get_text_stat($zcom[stat],$zcom[mess])."</div>";
		echo "</td></tr>";

		}

	echo "</table><br><br></td></tr>";
	}

////////////////

$res=mysql_query("SELECT * from com_requests WHERE `charid`='".$_SESSION['uid']."'  order by Id desc;");

	if (mysql_num_rows($res)>0)
	{
	echo "<tr><td>";
	echo '<form method="POST">';
	echo "<tr><td align=center><br><br><b style=\"color:#800000\"> ВАШИ ЗАЯВКИ</b>";
	echo "<br><br><br><table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"tbl_inside\">";
	$c=2;
	echo "<tr class=text3 bgcolor='$co[$c]'><td>";
		echo "<center><b>№ Заявки</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Тип заявки</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Комментарии</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Дата Заявки</b></center>";
		echo "</td>";
		echo "<td>";
		echo "<center><b>Статус заказа</b></center>";
		echo "</td></tr>";

	while ($r=mysql_fetch_array($res))
		{
		 if ($c==1) {$c=2;} else {$c=1;}
		echo "<tr bgcolor='$co[$c]'><td>";
		echo "<div class=text4>".$r['Id']."</div>";
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".$r['type']."</div>";
		echo "</td>";
		echo "<td>";
		$string=$r['comment'] ;
		$string=preg_replace("!\[\:(.*?)\:\]!si","",$string);
	 	echo "<div class=text4>".$string."<br>";

		echo "<br><center><button  id='button3' type=button  onClick='javascript:new_runmagic(this,".$r['Id'].",2);'>Добавить комментарий</button></center></div>";
		echo "</td>";
		echo "<td>";
		echo "<div class=text4>".date("d.m.y H:i",$r['mess_time'])."</div>";
		echo "</td>";
		echo "<td>";
	  	 //echo "<b>Оплата заявки:</b> ".$r['paid']."<br>";

	  	 if ($r['status']=='Ожидается оплата')
	  	 	{
	  	 	echo "<form action='https://oldbk.com/commerce/index.php?act=other' method=post><input type=hidden value=\"Смена WMZ кошелька для вывода денежных средств\" name=\"services\"><button id='button3'  type=button onClick='submit();'>Ожидается оплата</button></form>";
	  	 	}
	  	 elseif ($r['status']!='')	{echo substr($r['status'],0,23);} else { echo "в обработке"; }
		echo "</td>";
		echo "</tr>";


		}

	echo "</table></form><br><br><br></td></tr>";
	}
}
echo "</table>";

echo "<center><br><br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br>
	</center><br><br>";

}

function ShowMKArt()
{
global $KO_start_time26, $KO_fin_time26, $EKR_TO_GOLD;

$glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));

echo "<h1>Создание и заказ артефакта:</h1>";
 if ($glava_test[id]>0)
 {
  echo "<div class='item'>
  <a href=index.php?act=mkclanart>Создание Кланового артефакта</a><br><br>
  &nbsp;&nbsp;&nbsp;Вы являетесь главой клана, и вам доступно создание кланового артефакта со своим изображением, названием, и уникальными парметрами, в количестве 5 штук на клан на одном прототипе.<br>
&nbsp;&nbsp;&nbsp;Оплатить стоимость кланового артефакта можно только через клан казну вашего клана или золотыми монетами.<br>
&nbsp;&nbsp;&nbsp;Оплата из клановой казны происходит в момент подачи заявки.<br>
&nbsp;&nbsp;&nbsp;Если заявка не будет одобрена Администрацией (некорректное: название,изображение и т.д.) средства будут возвращены в казну клана.<br>
&nbsp;&nbsp;&nbsp;После одобрения и оплаты вы получите в арсенал вашего клана 5 артефактов данного типа, которые могут быть использованы вашими соклановцами, на ваше усмотрение.<br>
&nbsp;&nbsp;&nbsp;Стоимость кланового артефакта (5 единиц одного вида в арсенал) - 5000екр.<br>
<br><a class=\"button\" href=index.php?act=mkdart>Возврат артефакта</a><br><br>
Вы можете вернуть свой артефакт. При возврате нужно иметь ваучеры на сумму 40екр или более екр ( сдача будет возвращена ваучерами владельцу) и артефакт должен находиться в инвентаре персонажа.<br>
За <b>40екр</b> можно сдать - Доспех Сумеречных Теней, Латы Безумной Крови, Секиру Сумеречных Теней, Меч Безумной Крови, Молот Ярости Титанов, Кольцо Магистра.<br>
За <b>50екр</b> можно сдать - любой Личный артефакт.<br>
Все апы, свиток встройки, встроенный свиток и заточка(если это оружие) будут возвращены владельцу и могут быть использованы в будущем.<br>
Репутация в полной мере возвращается персонажу и в будущем может быть использована в любых целях.<br>
   </div>" ;
 }



if ((time()>$KO_start_time26) and (time()<$KO_fin_time26))
 {
 $real_cost=250;
 }
 else
 {
 $real_cost=500;
 }

  echo "<div class='item'>
  <a class='button' href=index.php?act=mkpersonalart>Создание Личного артефакта</a><br><br>
&nbsp;&nbsp;&nbsp;Вы можете создать свой уникальный личный артефакт, загрузив свое изображение<font color=red>*</font> и распределив доступные параметры.<br>
&nbsp;&nbsp;&nbsp;Личный артефакт может быть оплачен репутацией или золотыми монетами.<br>
&nbsp;&nbsp;&nbsp;Оплата репутацией производится в момент подачи заявки.<br>
&nbsp;&nbsp;&nbsp;Стоимость личного артефакта - ".($real_cost*$EKR_TO_GOLD)." золотых монет или 300000 репутации<font color=red>**</font>.<br><br>

<font color=red>*&nbsp;&nbsp;&nbsp;&nbsp;Требования к изображению: прозрачный фон, размеры в точности должны совпадать с размерами изображений в проекте, вес не более 100К, формат gif, не должно нарушать тематику проекта. </font><br>
<font color=red>**&nbsp;&nbsp;&nbsp;Обращаем Ваше внимание, что перед тем, как продать Вам личные артефакты за репутацию, сотрудники Коммерческого отдела проводят проверку баланса переводов Вашего персонажа.
Чтобы иметь возможность купить личные артефакты за репутацию вам необходимо свести баланс со всеми персонажами, в т.ч. кланом, супругом и не иметь открытых сделок. В противном случае в покупке Вам может быть отказано.</font><br>
<br><a class=\"button\" href=index.php?act=mkdart>Возврат артефакта</a><br><br>
Вы можете вернуть свой артефакт. При возврате нужно иметь ваучеры на сумму 40екр или более екр ( сдача будет возвращена ваучерами владельцу) и артефакт должен находиться в инвентаре персонажа.<br>
За <b>40екр</b> можно сдать - Доспех Сумеречных Теней, Латы Безумной Крови, Секиру Сумеречных Теней, Меч Безумной Крови, Молот Ярости Титанов, Кольцо Магистра.<br>
За <b>50екр</b> можно сдать - любой Личный артефакт.<br>
Все апы, свиток встройки, встроенный свиток и заточка(если это оружие) будут возвращены владельцу и могут быть использованы в будущем.<br>
Репутация в полной мере возвращается персонажу и в будущем может быть использована в любых целях.<br>
   </div>" ;
}


function  ShowMKPersonArt()
{
global $user, $KO_start_time26, $KO_fin_time26,$EKR_TO_GOLD;
global $EKR_TO_GOLD;
$form_view=1;
$form_pay=0;
//$price_rep=600000;
$price_rep=300000;
$price_klan_ekr=5000;

if ((time()>$KO_start_time26) and (time()<$KO_fin_time26))
 {
$price_pers_ekr=250;
 }
 else
 {
$price_pers_ekr=500;
 }




if (($_GET[act]=='mkpersonalart') OR ($_GET[act]=='mkclanart'))
 {
  if ($_GET[act]=='mkclanart')
  	{
  	$glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
  	if ($glava_test[id]>0)
  	  {
  	  $action='mkclanart';
  	  }
  	  else
  	  {
		?>
		<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
		<tr>
		<td width="27" height="30">&nbsp;</td>
		<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
		</tr>
		</table>
		<?
		return false;
  	  }
  	}
 $action=$_GET[act];
 }
 else
 {
 $action='';
 }

//print_r($_SESSION);

if ($_SESSION['mkartch_new_slot_from_hram']==true)
{
echo "<br>
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\"> ОБМЕН СТАНДАРТНОГО АРТЕФАКТА НА ЛИЧНЫЙ</b></center></td></tr>
<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете сдать свой стандартный артефакт и сделать заявку на личный артефакт.</center>
<table align=center><tr align=left><td>

<p><b style=\"color:#800000\">Правила обмена артефакта:</b><br>

<b>- новый артефакт создается на базе вещей любого уровня и любого слота<br>
- изображение и название на новый артефакт будет установлено по-умолчанию, изменить их нельзя<br>
- встройка со старого артефакта автоматически переносится на новый<br>
- cвиток заточки выдается подарком, после использования предмет будет привязан к персонажу.</b></p>

<b style=\"color:RED\">Заточка со старого артефакта (если была) автоматически возвращается в инвентарь подарком при получении нового артефакта.<br>
<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. " ;
if ($_SESSION['mkartch']['duration']>0)
 		{
		$us = check_users_city_datal($user);
 		echo "Стоимость починки старого артефакта: <b> ".calc_repair_cost($us,$_SESSION['mkartch'])." кр.</b>";
 		}
echo "</p>
После оплаты артефакт появится в Вашем инвентаре и надеть его сможете только Вы.<br><br>
<b style=\"color:#800000\">В случае отказа по заявке, Вам будет возвращен Ваш старый артефакт.</b><br><br>
</p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br><br>";
}
elseif ($_SESSION['mkartch_new_slot']==true)
{
	echo "
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\"> ОБМЕН ЛИЧНОГО АРТЕФАКТА НА ДРУГОЙ СЛОТ ИЛИ ПЕРЕСОЗДАНИЕ В ТОМ ЖЕ СЛОТЕ</b></center></td></tr>
<tr><td class=\"text1 cont_bg\">

<br><center>Здесь Вы можете пересоздать свой личный артефакт на другой слот или пересоздать его в том же слоте.</center>
<table align=center><tr align=left><td>

<p><b style=\"color:#800000\">Правила смены слота личного артефакта:</b><br>
<b>- новый артефакт создается только на базе вещей того же уровня, что и уровень старого артефакта<br>
- улучшение уникального предмета и прочие улучшения со старого артефакта автоматически переносится на новый<br>
- встройка со старого артефакта автоматически переносится на новый<br>
- cвиток заточки выдается подарком, после использования предмет будет привязан к персонажу.</b></p>

<b style=\"color:RED\">Заточка со старого артефакта (если была) автоматически возвращается в инвентарь подарком при получении нового артефакта.<br>";
echo "</p>
<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. " ;
if ($_SESSION['mkartch']['duration']>0)
 		{
		$us = check_users_city_datal($user);
 		echo "Стоимость починки старого артефакта: <b> ".calc_repair_cost($us,$_SESSION['mkartch'])." кр.</b>";
 		}
echo "</p>
<p><b style=\"color:#800000\">После оплаты артефакт появится в Вашем инвентаре и надеть его сможете только Вы.<br>
<b style=\"color:#800000\">В случае отказа по заявке, Вам будет возвращен Ваш старый артефакт.</b><br>
<br>
</p>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br><br>";
//<b style=\"color:#800000\">В случае, если на артефакте имеется улучшенная уникальная модификация, при обмене она пропадает.</b><br>
}
else
 if ((is_array($_SESSION['mkartch'])) and ($_SESSION['mkartch_free']!=true) )
 {
 //текстовка замены 1
	echo "<br>
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\"> ОБМЕН ЛИЧНОГО АРТЕФАКТА</b></center></td></tr>
<tr><td class=\"text1 cont_bg\">



<br><center>Если Ваш уровень выше чем уровень личного артефакта, здесь Вы можете обменять его на другой, созданный из вещи Вашего уровня</center>
<table align=center><tr align=left><td>

<p><b style=\"color:#800000\">Правила обмена личного артефакта:</b><br>
<b>- новый артефакт создается только из вещи того же слота, что и старый<br>
- новый артефакт создается только на базе вещей Вашего уровня<br>
- изображение со старого артефакта автоматически переносится на новый<br>
- встройка/заточка со старого артефакта автоматически переносится на новый</b></p>";

echo "
</p>
<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. " ;
if ($_SESSION['mkartch']['duration']>0)
 		{
		$us = check_users_city_datal($user);
 		echo "Стоимость починки старого артефакта: <b> ".calc_repair_cost($us,$_SESSION['mkartch'])." кр.</b>";
 		}
echo "</p>
<p>Новый артефакт устанавливается на месте без проверок и одобрений, и сразу после создания окажется у Вас в рюкзаке.<br>
</p>

</td></tr></table>



</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>

<table width=\"800\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=800 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><a href=?act=mkartchf><b style=\"color:#800000\">ДЛЯ ОБМЕНА ЛИЧНОГО АПНУТОГО АРТЕФАКТА (устаревшая вещь) НАЖМИТЕ ЗДЕСЬ</b></a></center></td></tr>

<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>

<br><br>";
  }
 elseif (($_SESSION['mkartch']) and ($_SESSION['mkartch_free']==true))
 {
  //текстовка замены 2
echo "<br>
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\">ОБМЕН ЛИЧНОГО АПНУТОГО АРТЕФАКТА (устаревшая вещь)</b></center></td></tr>
<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете обменять свой старый личный артефакт на другой, созданный на базе новых вещей</center>
<table align=center><tr align=left><td>
<p><b style=\"color:#800000\">Правила обмена личного артефакта:</b><br>
<b>- новый артефакт создается только из вещи того же слота, что и старый<br>
- новый артефакт создается только на базе новых вещей того же уровня, что и уровень старого артефакта<br>
- изображение со старого артефакта автоматически переносится на новый<br>

- встройка/заточка со старого артефакта автоматически переносится на новый</b></p>

<p><b style=\"color:#800000\">Стоимость обмена личного артефакта:</b><br>
Обмен производится бесплатно</p>
<p><b style=\"color:#800000\">Обмену подлежат:</b> только <u>полностью</u> починенные артефакты. " ;
if ($_SESSION['mkartch']['duration']>0)
 		{
		$us = check_users_city_datal($user);
 		echo "Стоимость починки старого артефакта: <b> ".calc_repair_cost($us,$_SESSION['mkartch'])." кр.</b>";
 		}
echo "</p>
<p>После оплаты новый артефакт окажется у Вас в рюкзаке.<br></p>
<table align=left><tr valign=middle><td>Возможные способы оплаты:&nbsp;&nbsp;&nbsp;[обмен производится бесплатно]&nbsp;&nbsp;&nbsp;</td></tr></table>
</td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br><br>";

 }
 elseif ($action=='mkclanart')
{
echo "<br>
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\"> СОЗДАНИЕ КЛАНОВОГО АРТЕФАКТА</b></center></td></tr>
<tr><td class=\"text1 cont_bg\"><br><center>Здесь Вы можете подать заявку на создание кланового артефакта загрузив свое изображение и распределив доступные параметры.</center><br>
<table align=center><tr align=left><td><b style=\"color:#800000\">Требования к изображению артефакта:</b><br>
- формат: GIF файл размером - кольцо 20х20, серьги и кулон 60х20, оружие и щит и шлем 60х60, броня и плащ 60х80, перчи и сапоги 60х40.  <br>
- фон: прозрачный, либо фоновое изображение (в случае \"полного образа\", т.е. когда образ вместе с вещами создают одну картину).<br>
- вес:  не более  100Кб<br>
- рамка: шириной 1px - справа и снизу черная, слева и сверху белая (в случае \"полного образа\" рамка требуется только вокруг общей картины)
<p><b style=\"color:#800000\">Запрещены к установке:</b><br>- картинки низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой; уникальные и стандартные картинки из ББК;<br>
- не подходящие к тематике игры (исключение может быть сделано в случае, если картинка по смыслу сочетается с ником или образом персонажа);<br>
- артефакты содержащие спец. символы в названии</p>

<p>После одобрения Администрацией, 5 единиц артефакта появятся в арсенале Вашего клана.<br>
Права на использование кланового артефакта устанавливаются Главой клана в клановой панели.<br>
Оплата из клановой казны происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены в казну.</p>
<p>Стоимость 5ти единиц кланового артефакта - 5000$.</p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_kazna.png border=0></td><td> списать екр. из клановой казны]</td></tr></table></td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br><br>";
}
else
{

if ((time()>$KO_start_time26) and (time()<$KO_fin_time26))
 {
 $real_cost=250;
 }
 else
 {
 $real_cost=500;
 }

echo  "<br>
<table width=\"940\" border=\"0\" align=\"center\" cellpadding=0 cellspacing=0>
<tr>
<td valign=\"bottom\" class=\"cont_up\" width=940 height=18>&nbsp;</td>
</tr>
<tr>
<td class=\"cont_bg\">
<center><b style=\"color:#800000\"> СОЗДАНИЕ ЛИЧНОГО АРТЕФАКТА</b></center></td></tr>
<tr><td class=\"text1 cont_bg\"><br><center>Здесь вы можете самостоятельно создать личный артефакт и получить его сразу же после оплаты.<br>
Название и картинка для личного артефакта подставляются по-умолчанию.<br>
<table align=center><tr align=left><td>
<p>При оплате репутацией списание производится в момент подачи заявки. В случае отказа по заявке, репутация будет Вам полностью возвращена.</p>
<p>После оплаты артефакт появится в Вашем инвентаре и надеть его сможете только Вы.<br>
Стоимость личного артефакта - ".($real_cost*$EKR_TO_GOLD)." золотых монет или 300000 репутации.</p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_repa.png border=0></td><td> списать репутацию покупки] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_artveksel.png border=0></td><td> оплатить векселем]</td></tr></table></td></tr></table>
</td>
</tr>
<tr>
<td valign=\"top\" class=\"cont_dwn\" height=\"18\">&nbsp;</td>
</tr>
</table>
<br><br>";
}
//alina end

if (($_GET[edit]) and ($_SESSION['save_proto_memory']))
  {

	if (($_GET['sila']) and ($_SESSION['save_proto_memory'][gsila] !=0) and ($_SESSION['save_proto_memory'][stbonus] > 0))
	{
	$_SESSION['save_proto_memory'][gsila]++;
	$_SESSION['save_proto_memory'][stbonus]--;
	}
	else
		if (($_GET['lovk']) and ($_SESSION['save_proto_memory'][glovk] !=0 ) and ($_SESSION['save_proto_memory'][stbonus] > 0))
	{
	$_SESSION['save_proto_memory'][glovk]++;
	$_SESSION['save_proto_memory'][stbonus]--;
	}
	else
		if (($_GET['inta']) and ($_SESSION['save_proto_memory'][ginta] !=0 ) and ($_SESSION['save_proto_memory'][stbonus] > 0))
	{
	$_SESSION['save_proto_memory'][ginta]++;
	$_SESSION['save_proto_memory'][stbonus]--;
	}
	else
		if (($_GET['intel']) and ($_SESSION['save_proto_memory'][gintel] != 0) and ($_SESSION['save_proto_memory'][stbonus] > 0))
	{
	$_SESSION['save_proto_memory'][gintel]++;
	$_SESSION['save_proto_memory'][stbonus]--;
	}
	else
		if (($_GET['gmp']) and ($_SESSION['save_proto_memory'][gmp] != 0) and ($_SESSION['save_proto_memory'][stbonus] > 0))
	{
	$_SESSION['save_proto_memory'][gmp]++;
	$_SESSION['save_proto_memory'][stbonus]--;
	}
	else
		if (($_GET['akrit']) and ($_SESSION['save_proto_memory'][mfakrit] != 0) and ($_SESSION['save_proto_memory'][mfbonus] >= $_GET['akrit']))
	{
	$_SESSION['save_proto_memory'][mfakrit]+=(int)($_GET['akrit']);
	$_SESSION['save_proto_memory'][mfbonus]-=(int)($_GET['akrit']);
	}
	else
		if (($_GET['akrit']) and ($_SESSION['save_proto_memory'][mfakrit] != 0) and ($_SESSION['save_proto_memory'][mfbonus] < $_GET['akrit']))
	{
		echo '<center><b style="color:#800000">Ошибка! Не хватает свободных модификаторов!</b></center><br>';
	}
	else if (($_GET['krit']) AND (($_SESSION['save_proto_memory']['nclass']==1) OR ($_SESSION['save_proto_memory']['nclass']==3)) )
	{
		echo '<center><b style="color:#800000">Ошибка! Этому классу не доступен крит!</b></center><br>';
	}
	else if (($_GET['uvorot']) AND (($_SESSION['save_proto_memory']['nclass']==2) OR ($_SESSION['save_proto_memory']['nclass']==3)) )
	{
		echo '<center><b style="color:#800000">Ошибка! Этому классу не доступен уворот!</b></center><br>';
	}
	else
		if (($_GET['krit']) and ($_SESSION['save_proto_memory'][mfkrit] != 0) and ($_SESSION['save_proto_memory'][mfbonus] >= $_GET['krit']))
	{
	$_SESSION['save_proto_memory'][mfkrit]+=(int)($_GET['krit']);
	$_SESSION['save_proto_memory'][mfbonus]-=(int)($_GET['krit']);
	}
	else
		if (($_GET['krit']) and ($_SESSION['save_proto_memory'][mfkrit] != 0) and ($_SESSION['save_proto_memory'][mfbonus] < $_GET['krit']))
	{
		echo '<center><b style="color:#800000">Ошибка! Не хватает свободных модификаторов!</b></center><br>';
	}
	else
		if (($_GET['auvorot']) and ($_SESSION['save_proto_memory'][mfauvorot] != 0) and ($_SESSION['save_proto_memory'][mfbonus] >= $_GET['auvorot']))
	{
	$_SESSION['save_proto_memory'][mfauvorot]+=(int)($_GET['auvorot']);
	$_SESSION['save_proto_memory'][mfbonus]-=(int)($_GET['auvorot']);
	}
	else
		if (($_GET['auvorot']) and ($_SESSION['save_proto_memory'][mfauvorot] != 0) and ($_SESSION['save_proto_memory'][mfbonus] < $_GET['auvorot']))
	{
		echo '<center><b style="color:#800000">Ошибка! Не хватает свободных модификаторов!</b></center><br>';
	}
	else
		if (($_GET['uvorot']) and ($_SESSION['save_proto_memory'][mfuvorot] != 0) and ($_SESSION['save_proto_memory'][mfbonus] >= $_GET['uvorot']))
	{
	$_SESSION['save_proto_memory'][mfuvorot]+=(int)($_GET['uvorot']);
	$_SESSION['save_proto_memory'][mfbonus]-=(int)($_GET['uvorot']);
	}
	else
		if (($_GET['uvorot']) and ($_SESSION['save_proto_memory'][mfuvorot] != 0) and ($_SESSION['save_proto_memory'][mfbonus] < $_GET['uvorot']))
	{
		echo '<center><b style="color:#800000">Ошибка! Не хватает свободных модификаторов!</b></center><br>';
	}
	else
		if (($_GET['arthp']) and ($_SESSION['save_proto_memory'][isart] == 1) and ($_SESSION['save_proto_memory'][artbron1] > 0))
		{
	  	$_SESSION['save_proto_memory'][ghp]+=5;   	$_SESSION['save_proto_memory'][artghp]+=5;
	  	$_SESSION['save_proto_memory'][bron1]-=1;	$_SESSION['save_proto_memory'][artbron1]-=1;
  		$_SESSION['save_proto_memory'][bron2]-=1;  	$_SESSION['save_proto_memory'][artbron2]-=1;
	  	$_SESSION['save_proto_memory'][bron3]-=1;  	$_SESSION['save_proto_memory'][artbron3]-=1;
	  	$_SESSION['save_proto_memory'][bron4]-=1;  	$_SESSION['save_proto_memory'][artbron4]-=1;
		}
	else
		if (($_GET['arthp']) and ($_SESSION['save_proto_memory'][isart] == 1) and ($_SESSION['save_proto_memory'][artbron1] <= 0))
		{
		echo '<center><b style="color:#800000">Ошибка! Не хватает доступных модификаторов!</b></center><br>';
		}
	else
		if (($_GET['arthpd']) and ($_SESSION['save_proto_memory'][isart] == 1) and ($_SESSION['save_proto_memory'][artghp] >=5 ))
		{
	  	$_SESSION['save_proto_memory'][ghp]-=5;   	$_SESSION['save_proto_memory'][artghp]-=5;
	  	$_SESSION['save_proto_memory'][bron1]+=1;	$_SESSION['save_proto_memory'][artbron1]+=1;
  		$_SESSION['save_proto_memory'][bron2]+=1;  	$_SESSION['save_proto_memory'][artbron2]+=1;
	  	$_SESSION['save_proto_memory'][bron3]+=1;  	$_SESSION['save_proto_memory'][artbron3]+=1;
	  	$_SESSION['save_proto_memory'][bron4]+=1;  	$_SESSION['save_proto_memory'][artbron4]+=1;
		}
	else
		if (($_GET['arthpd']) and ($_SESSION['save_proto_memory'][isart] == 1) and ($_SESSION['save_proto_memory'][artghp] < 5))
		{
		echo '<center><b style="color:#800000">Ошибка! Не хватает доступных модификаторов!</b></center><br>';
		}

  }
  else
  if (($_GET[saveproto]) and ($_SESSION['save_proto_memory'])and ($_SESSION['save_proto_memory'][isart]!=1) )
  {
  	//1. проверяем все ли распределено
  	if (($_SESSION['save_proto_memory'][mfbonus]==0) and ($_SESSION['save_proto_memory'][stbonus]==0))
  	{
  	echo '<center><b style="color:#800000">Прототип сохранен! Распределите параметры артефакта!</b></center><br>';
  	$_SESSION['save_proto_memory'][stbonus]=6;
  	$_SESSION['save_proto_memory'][mfbonus]=70;
  	$_SESSION['save_proto_memory'][ghp]+=0;   	$_SESSION['save_proto_memory'][artghp]=0;

  	$_SESSION['save_proto_memory'][bron1]+=13;	$_SESSION['save_proto_memory'][artbron1]=13;
  	$_SESSION['save_proto_memory'][bron2]+=13;  	$_SESSION['save_proto_memory'][artbron2]=13;
  	$_SESSION['save_proto_memory'][bron3]+=13;  	$_SESSION['save_proto_memory'][artbron3]=13;
  	$_SESSION['save_proto_memory'][bron4]+=13;  	$_SESSION['save_proto_memory'][artbron4]=13;

  	$_SESSION['save_proto_memory'][minu]+=2;  	$_SESSION['save_proto_memory'][artminu]=2;
  	$_SESSION['save_proto_memory'][maxu]+=2;  	$_SESSION['save_proto_memory'][artmaxu]=2;

  	$_SESSION['save_proto_memory'][isart]=1;

  	}
  	else
  	{
		echo '<center><b style="color:#800000">Ошибка! Не все статы и модификаторы распределены!</b></center><br>';
  	}


  }
  else if ((($_GET[saveart]) OR ($_GET[pay]) ) and ($_SESSION['save_proto_memory'])and ($_SESSION['save_proto_memory'][isart]==1) )
   {
   $form_pay=1;
   $mark_st=0;

   if ($_SESSION['save_proto_memory'][mark_sila]) { $art_st='art_st'.(($mark_st>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_st]='sila'; $mark_st++;}
   if ($_SESSION['save_proto_memory'][mark_lovk]) { $art_st='art_st'.(($mark_st>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_st]='lovk'; $mark_st++;}
   if ($_SESSION['save_proto_memory'][mark_inta]) { $art_st='art_st'.(($mark_st>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_st]='inta'; $mark_st++;}
   if ($_SESSION['save_proto_memory'][mark_intel]) { $art_st='art_st'.(($mark_st>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_st]='intel'; $mark_st++;}
   if ($_SESSION['save_proto_memory'][mark_gmp]) { $art_st='art_st'.(($mark_st>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_st]='gmp'; $mark_st++;}

   $mark_mf=0;

   if ($_SESSION['save_proto_memory'][mark_krit]) { $art_st='art_mf'.(($mark_mf>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_mf]='mfkrit'; $mark_mf++;}
   if ($_SESSION['save_proto_memory'][mark_akrit]) { $art_st='art_mf'.(($mark_mf>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_mf]='mfakrit'; $mark_mf++;}
   if ($_SESSION['save_proto_memory'][mark_uvorot]) { $art_st='art_mf'.(($mark_mf>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_mf]='mfuvorot'; $mark_mf++;}
   if ($_SESSION['save_proto_memory'][mark_auvorot]) { $art_st='art_mf'.(($mark_mf>1)?"2":"1"); $_SESSION['save_proto_memory'][$art_mf]='mfauvorot'; $mark_mf++;}


   include "art_templ.php";
   $_SESSION['save_proto_memory'][new_art_name]=$art_tmpl[$_SESSION['save_proto_memory']['razdel']];

   	if ( (!(is_array($_SESSION['mkartch']))) OR ( ($_SESSION['mkartch_new_slot']==true)  ) )
      {

	   $_SESSION['save_proto_memory'][new_art_img]="art_templ_{$_SESSION['save_proto_memory']['razdel']}.gif";
      }




      //echo '<center><b style="color:red">Ошибка! Укажите название артефакта!</b></center><br>';


      if (preg_match('~[a-z]~iU',$_SESSION['save_proto_memory'][new_art_name]) && preg_match('~[а-я]~iU',$_SESSION['save_proto_memory'][new_art_name])) {
      		echo '<center><b style="color:red">Ошибка! Название артефакта содержит русские и английские буквы одновременно!</b></center><br>';
      }
      elseif (!((strlen($_SESSION['save_proto_memory'][new_art_name])>5) and (strlen($_SESSION['save_proto_memory'][new_art_name])<50))  )
      {
      	echo '<center><b style="color:red">Ошибка! Название артефакта должно быть от 5 до 50 символов!</b></center><br>';
      }
	elseif (preg_match("/[^(\w)|(\x7F-\xFF)|(\s)]/",$_SESSION['save_proto_memory'][new_art_name]))
	{
	echo '<center><b style="color:red">Ошибка! В название артефакта можно использовать строчные и прописные латинские или русские буквы, цифры, пробел или знак подчерк!</b></center><br>';
	}
       elseif (($_GET[art_bonus]!=1) AND ($_GET[art_bonus]!=2) AND ($_GET[art_bonus]!=3) )
      {
      	echo '<center><b style="color:red">Ошибка! Необходимо выбрать один из 3х бонусов!</b></center><br>';
      }
      elseif ((!($_SESSION['save_proto_memory'][new_art_img])) AND (!(is_array($_SESSION['mkartch']))) )
      {
      //если не обмен арта
      	echo '<center><b style="color:red">Загрузите изображение в gif формате!!</b></center><br>';
      }
      elseif ((!($_SESSION['save_proto_memory'][new_art_img])) AND ($_SESSION['mkartch_new_slot']==true)  )
      {
      //если обмен арта слота и нет картинки
      	echo '<center><b style="color:red">Загрузите изображение в gif формате!!</b></center><br>';
      }
      elseif ($mark_st!=2)
      {
      	echo '<center><b style="color:red">Ошибка! Необходимо пометить два стата которые будут доступны для распределения!</b></center><br>'.$mark_st;
      }
      elseif ($mark_mf!=2)
      {
      	echo '<center><b style="color:red">Ошибка! Необходимо пометить два модификатора которые будут доступны для распределения!</b></center><br>';
      }
      else
       {



   	//Устанавливаем бонусы


   	if ($_GET[art_bonus]==1)
   		{
   		$_SESSION['save_proto_memory'][ab_bron]=10;
   		$_SESSION['save_proto_memory'][ab_mf]=0;
   		$_SESSION['save_proto_memory'][ab_uron]=0;
   		}
   	else if ($_GET[art_bonus]==2)
   		{
   		$_SESSION['save_proto_memory'][ab_bron]=0;
   		$_SESSION['save_proto_memory'][ab_mf]=5;
   		$_SESSION['save_proto_memory'][ab_uron]=0;
   		}
   	else if ($_GET[art_bonus]==3)
   		{
   		$_SESSION['save_proto_memory'][ab_bron]=0;
   		$_SESSION['save_proto_memory'][ab_mf]=3;
   		$_SESSION['save_proto_memory'][ab_uron]=1;
   		}

	if  (is_array($_SESSION['mkartch'])) {
		//если пришли с обмена артов то
		if (is_array($_SESSION['ekrids'])) {
			//		$_SESSION['ekrids'] -
			//проверить еще раз арт на замену - если все ок то удалить его
			//если нада оплата то
			// проверить оплату - и выдасть сдачу если надо

			$us = check_users_city_datal($user);
			$ids=$_SESSION['ekrids'];

			$repair_cost=calc_repair_cost($us,$_SESSION['mkartch']);

			if (($repair_cost>0) and ($us['money']<$repair_cost)) {
				serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
			} else {
				//ремонт старого если надо
				if ($repair_cost>0) {
				$q = mysql_query('START TRANSACTION') or die("e7");
				if (repair_old_art($_SESSION['mkartch'],$us)) {
					$_SESSION['mkartch']['duration']=0;
				}
				$q = mysql_query('COMMIT') or die("e8");
			}

			$ids[]=$_SESSION['mkartch']['id']; //добавляем в идшки ид арта


			if ($_SESSION['mkartch_new_slot_from_hram']==true) {
				//обмен стандарта на заявку лички
				$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ( (dressed = 0 AND duration = 0  AND (sowner = '.$us['id'].' OR sowner = 0)  AND prototype in (260,262,2000,2001,2002,283,284,18210,18229,18247,18527)    )  )) AND id IN('.implode(",",$ids).') ');
			} elseif ($_SESSION['mkartch_new_slot']==true) {
				if (isset($_SESSION['mkartch2_pay_vau_ids']) && !empty($_SESSION['mkartch2_pay_vau_ids'])) {
					// для обмена слота с ваучером
					$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ((setsale = 0 and prototype = 541) or (dressed = 0  AND art_param != "" AND duration = 0  AND sowner = '.$us['id'].'))) AND id IN('.$_SESSION['mkartch2_pay_vau_ids'].','.implode(",",$ids).') ');
				} else {
					//для обмена слота
					$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ( (dressed = 0  AND art_param != "" AND duration = 0  AND sowner = '.$us['id'].'))) AND id IN('.implode(",",$ids).') ');
				}

			} else {
				$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ( (dressed = 0  AND art_param != "" AND duration = 0 AND  nlevel<'.$us['level'].'  AND sowner = '.$us['id'].')   )) AND id IN('.implode(",",$ids).') ');
			}


			$ekrnum = 0;
			$artnum = 0;
			$artid = 0;
			$artinfo = array();
			$ekrids = array();
			$useditems = "";
			$bprice = 0;
			$returnrep = 135000;

			while($i = mysql_fetch_assoc($q)) {
				$useditems .= get_xitem_fid($i).",";

				if ($i['prototype'] == "541" && isset($_SESSION['mkartch2_pay_vau_ids'])) {
					$mKartch2_pay_vau=true;
					$mkartch2_pay_vau_ids=$i['id'];
				} else {
					$artnum++;
					$artinfo = $i;
					$artid = $i['id'];
				}
			}

			if ($_SESSION['mkartch_new_slot_from_hram']==true) {
				$bprice = 15;	//оплата за смену  стандартного на личку
			} elseif (isset($_SESSION['mkartch2_pay_vau_ids']) && !empty($_SESSION['mkartch2_pay_vau_ids'])) {
				$bprice = 0;
			} elseif ($_SESSION['mkartch_new_slot']==true)  {
				if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
					$bprice=0;
				} else {
					$bprice = 15;	//оплата за смену арта слота
				}

				if ($_SESSION['mkartch']['nclass'] == 0 && $_SESSION['mkartch']['type'] != 3 && $_SESSION['mkartch']['nlevel'] >= 8 && $_SESSION['mkartch']['type'] == $_SESSION['save_proto_memory']['type']) {
					//бесплатный обмен старого
					$bprice = 0;
					$CH_OK=true;
				}

			} else {
				if(time()>mktime(17,0,0,5,29,2017) && time()<mktime(23,59,59,6,9,2017)) {
					$bprice=0;
					$CH_OK=true;
				} else {
					$bprice = 10;
				}

				if ( (is_array($_SESSION['mkartch'])) and ($_SESSION['mkartch_free']!=true)) {
					//if ($_SESSION['mkartch']['unik']==2) $bprice+=5;
				}
			}

			if (($us['repmoney'] < $returnrep) AND ($_SESSION['mkartch_new_slot_from_hram']==true && ($_SESSION['mkartch_paytype'] != 1))) {
				serr("Недостаточно репутации покупок для сдачи храмового артефакта");
			} elseif ($artnum != 1) {
				serr("За раз можно сдать только один артефакт");
			} elseif (($_SESSION['save_proto_memory']['type']!=$artinfo['type']) AND ($_SESSION['mkartch_new_slot']!=true)) {
				serr("Ошибка! на этот прототип нельзя выполнить обмен вашего артефакта!");
			} else {
				mysql_query('START TRANSACTION') or die("error start transaction");
				/*if($mKartch2_pay_vau) {
					// удаляем ваучер если обмен с ваучера
					mysql_query('DELETE FROM oldbk.inventory WHERE id = '.$mkartch2_pay_vau_ids);
				}
				*/
				if (isset($_SESSION['mkartch_paytype']) && $_SESSION['mkartch_paytype'] == 1) {
					// оплата монетами !!!!!!!!!!!!!!
					$needm = round(($bprice*$EKR_TO_GOLD)*0.9);

					if ($_SESSION['mkartch_new_slot_from_hram']==true && $_SESSION['mkartch_paytype'] == 1) {
						$needm = 4320; // хардкодом
					}

					if ($us['gold'] < $needm) {
						serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
					} else {
						mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - ".$needm." WHERE `id`= '{$us['id']}'") or die(mysql_error());

						$us['gold'] -= $needm;

						//оплата и предмет для обмена ок
						$rec = array();
					    	$rec['owner']=$us[id];
						$rec['owner_login']=$us[login];
						$rec['owner_balans_do']=$us['money'];
						$rec['owner_balans_posle']=$us['money'];
						$rec['owner_rep_do']=$us['repmoney'];
						$rec['target_login'] = "КО";
						$rec['owner_rep_posle']=$us['repmoney'];
						$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
						$rec['type'] = 2284; // оплата екр с банка за КО
						$rec['add_info'] = $us['gold'].'/'.$needm;

						if (add_to_new_delo($rec) === FALSE) die();

						$CH_OK=true;
					}
				} else {
				        // оплата всем остальным
					if ($bprice >0) {
						if (!($_SESSION['bankid']>0)) { die("no session bank"); }

						$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$_SESSION['bankid']."' AND ekr>=".$bprice."  FOR UPDATE ;");
						if (!(mysql_num_rows($get_bank) > 0) ) {
							serr("Сумма на вашем счету должна быть ".$bprice." екр или больше");
						} else {
							$bank = mysql_fetch_assoc($get_bank);
							//echo "Платный обмен";
							//снимаем деньги зи банка
							mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$bprice}' WHERE `id`= '{$_SESSION['bankid']}' and owner='{$us['id']}'  ");
							//  пишем в хистори банка
							$bank['ekr']-=$bprice;
							mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$bprice} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$_SESSION['bankid']}');");
							unset($_SESSION['bankid']);

							//оплата и предмет для обмена ок
							$rec = array();
						    	$rec['owner']=$us[id];
							$rec['owner_login']=$us[login];
							$rec['owner_balans_do']=$us['money'];
							$rec['owner_balans_posle']=$us['money'];
							$rec['owner_rep_do']=$us['repmoney'];
							$rec['target_login'] = "КО";
							$rec['owner_rep_posle']=$us['repmoney'];
							$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
							$rec['type'] = 2282; // оплата екр с банка за КО
							$rec['bank_id'] = $bank['id'];
							$rec['sum_ekr'] = $bprice;

							if (add_to_new_delo($rec) === FALSE) die();
							$CH_OK=true;
						}

					}
					else if ($mKartch2_pay_vau)
						{
						//будет оплата ваучером
						$CH_OK=true;
						}




					if ($_SESSION['mkartch_new_slot_from_hram']==true) {
						//списываем репутацию покупки
						// снимаем 270к репы

	                                        mysql_query('UPDATE oldbk.`users` SET `repmoney` = `repmoney` - '.$returnrep.'  WHERE `id` = '.$us['id']) or die();

						$rec = array();
			    			$rec['owner']=$us[id];
						$rec['owner_login']=$us[login];
						$rec['owner_balans_do']=$us['money'];
						$rec['owner_balans_posle']=$us['money'];
						$rec['owner_rep_do']=$us['repmoney'];
						$rec['target_login'] = "КО";
						$rec['owner_rep_posle']=$us['repmoney']-$returnrep;
						$rec['sum_rep'] = $returnrep;
						$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
						$rec['type'] = 384;
						if (add_to_new_delo($rec) === FALSE) die();

						serr("- успешно снято ".$returnrep." репутации покупок");
						systemtotelo($us,"Успешно снято ".$returnrep." репутации покупок");
						$CH_OK=true;
					}
				}
				mysql_query('COMMIT') or die("err commit");
			}
		}
	} else {
		//echo "бесплатный обмен";
		$us = check_users_city_datal($user);


		$repair_cost=calc_repair_cost($us,$_SESSION['mkartch']);

		if (($repair_cost>0) and ($us['money']<$repair_cost) ) 	{
			serr("Суммы на вашем персонаже недостаточно для оплаты ремонта старого артефакта. Необходимая сумма ".($repair_cost)." кр.");
		} else {
			//ремонт старого если надо
			if ($repair_cost>0) {
				$q = mysql_query('START TRANSACTION') or die("e5");
				if (repair_old_art($_SESSION['mkartch'],$us)) {
					$_SESSION['mkartch']['duration']=0;
				}
				$q = mysql_query('COMMIT') or die("e6");
			}

			$artinfo=mysql_fetch_array(mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND ( (dressed = 0  AND art_param != "" AND duration = 0 AND  name like "%[%"   AND sowner = '.$us['id'].'))) AND id='.$_SESSION['mkartch']['id']));

			$artid = $artinfo['id'];
			$useditems = "";

			if ($artid>0) {
				if ($_SESSION['save_proto_memory']['type']!=$artinfo['type']) {
					serr("Ошибка! на этот прототип нельзя выполнить обмен вашего артефакта!");
				} elseif ($_SESSION['save_proto_memory']['nlevel']!=$artinfo['nlevel']) {
					serr("Ошибка! Прототип нового артефакта не соотвествует уровню вашего артефакта, бесплатно обмениваются только одного уровня! ");
				} else {
					$CH_OK=true;
				}
			} else {
				serr("Ошибка! Старый Артефакт не найден! Обмен отменен!");
			}

		}
	}

	//делаем обмен

	if ($CH_OK==true)
		{

		//тут пишем в дело что отдали старый арт

		if ($_SESSION['mkartch_new_slot']!=true)
		{
		//подставляем старую картинку если режим не смены слота
		$_SESSION['save_proto_memory'][new_art_img]=$_SESSION['mkartch']['img'];
		}

		//подставляем страрый тип оплаты
		if ($_SESSION['mkartch']['repcost']>0)
		{
		$pym='rep';
		$prise=$_SESSION['mkartch']['repcost'];
		}
		else
		{
		$pym='ekr';
		$prise=$_SESSION['mkartch']['ecost'];
		}

		if ($_SESSION['mkartch_new_slot']==true)
		{
			//обмен с модерацией но новый слот

			//создаем арт
			if ($_SESSION['mkartch_new_slot_from_hram']==true) { $pym='rep'; } // правка для храм арта т.к. доплата идет репой

			$mk_art=mk_art_rec($_SESSION['save_proto_memory'],$pym,$prise,1,'mkpersonalart');
			if ($mk_art>0)
			{

					if($mKartch2_pay_vau)
					{
						// удаляем ваучер если обмен с ваучера
						mysql_query('DELETE FROM oldbk.inventory WHERE id = '.$mkartch2_pay_vau_ids);
					}

					if ($_SESSION['mkartch_paytype'] == 1) {
						$bprice = 0;
						$vksflag = 9; // костыль
					}

					//ставим флаг - о обмене в  veks_flag=2 в поле t_id запоминаем ид старого арта
					if ($_SESSION['mkartch_new_slot_from_hram']==true)
							{
							//3 сдали храмовый арт
					   		mysql_query("UPDATE `oldbk`.`art_prototype` SET {$add_express} art_status=1 ,veks_flag=5, bankid='{$bank['id']}' , t_id='{$artid}'  WHERE `id`='{$mk_art}' ;"); // art_status=-1
							}
							else
							{
							//2 сдали личку

							if ($mKartch2_pay_vau) {
								$vksflag = 9;
							} else {
								$vksflag = 4;
							}
					   		mysql_query("UPDATE `oldbk`.`art_prototype` SET   {$add_express} art_status=1 , veks_flag=".$vksflag.",  bankid='{$bank['id']}' ,  t_id='{$artid}'  WHERE `id`='{$mk_art}' ;"); //4- оплата екрами art_status=-1
					   		}
					if (mysql_affected_rows()>0)
							{
								//перетягиваем арт - на КО
								mysql_query('UPDATE `oldbk`.`inventory` SET `owner`=450 WHERE id='.$artid) or die();
								$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['mkartch'][owner]."'  ;"));
								  	//пишем в переводы о том что чел отдал арт на замену
								  	$rec=array();
			  		    				$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=1379;//отдал арт для обмена
									$rec['sum_kr']=0;
									if ($_SESSION['mkartch_new_slot_from_hram']==true && $_SESSION['mkartch_paytype'] == 1) {
										$rec['sum_ekr']=0;
									} else {
										$rec['sum_ekr']=$bprice;
									}
									$rec['sum_rep']=0;
									$rec['sum_kom']=0;
									$rec['item_id']=get_xitem_fid($_SESSION['mkartch']);
									$rec['item_name']=$_SESSION['mkartch'][name];
									$rec['item_count']=1;
									$rec['item_type']=$_SESSION['mkartch'][type];
									$rec['item_cost']=$_SESSION['mkartch'][cost];
									$rec['item_dur']=$_SESSION['mkartch'][duration];
									$rec['item_maxdur']=$_SESSION['mkartch'][maxdur];
									$rec['item_ups']=$_SESSION['mkartch'][ups];
									$rec['item_unic']=$_SESSION['mkartch'][unik];
									$rec['item_incmagic']=$_SESSION['mkartch']['includemagicname'];
									$rec['item_incmagic_count']=$_SESSION['mkartch']['includemagicuses'];
									$rec['item_arsenal']='';
									$rec['bank_id'] = $bank['id'];
									$rec['add_info']='Оплата Из Банка';

									add_to_new_delo($rec); //юзеру

									if ($art_telo['odate'] > (time()-60)) {
										addchp('<font color=red>Внимание!</font> Вы отдали на обмен личный артефакт "'.$_SESSION['mkartch']['name'].'" ','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
									} else {
									mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вы отдали на обмен личный артефакт \"{$_SESSION['mkartch']['name']}\"');");
									}
							  		echo "<font color=red>Заявка на обмен личного артефакта принята!</font>";

							  		unset($_SESSION['mkartch']);
									unset($_SESSION['ekrids']);
									unset($_SESSION['mkartch_free']);
									unset($_SESSION['save_proto_memory']);
									unset($_SESSION['mkartch_new_slot']);
									unset($_SESSION['mkartch_new_slot_from_hram']);
						 	}


			}
			else
			{
			echo "Ошибка! Что-то пошло не так...Попробуйте еще раз!";
			}

		}
		else
		{
		//обмен с установкой сразу
		$mk_art=mk_art_rec($_SESSION['save_proto_memory'],$pym,$prise,2,'mkpersonalart'); // статус 2 - установлен
		if ($mk_art>0)
			{
			//выдать новый арт сразу в инвентарь и шоп
			// сделать запись в таблицу арта - что утвердилось автоматически т.к. обмен
			//сделать отметку что арт уже новый
			//echo "Сделали арт!";
			///пишем в дело о обмене

					 //одобряем
			   		mysql_query("UPDATE `oldbk`.`art_prototype` SET `art_status`=2, `art_moder`='Авто-обмен' , `art_mod_date`=NOW()  WHERE `id`='{$mk_art}' ;");

					if (mysql_affected_rows()>0)
					{
			 		$get_proto=mysql_fetch_array(mysql_query("select * from oldbk.art_prototype where id='{$mk_art}'"));
					$get_proto[name]=htmlspecialchars($get_proto[name],ENT_COMPAT | ENT_HTML401,"cp1251");


				mysql_query("INSERT INTO `oldbk`.`shop` SET `id`='{$get_proto[id]}',
				  `name`='".mysql_real_escape_string($get_proto[name])."', `duration`='{$get_proto[duration]}',`maxdur`='{$get_proto[maxdur]}',
				  `cost`='{$get_proto[cost]}',`count`=0,`avacount`=0,
				  `nlevel`='{$get_proto[nlevel]}',`nsila`='{$get_proto[nsila]}',`nlovk`='{$get_proto[nsila]}',`ninta`='{$get_proto[ninta]}',`nvinos`='{$get_proto[nvinos]}',
				  `nintel`='{$get_proto[nintel]}',`nmudra`='{$get_proto[nmudra]}',`nnoj`='{$get_proto[nnoj]}',`ntopor`='{$get_proto[ntopor]}',`ndubina`='{$get_proto[ndubina]}',`nmech`='{$get_proto[nmech]}',
				  `nalign`='{$get_proto[nalign]}',`minu`='{$get_proto[minu]}',`maxu`='{$get_proto[maxu]}',
				  `gsila`='{$get_proto[gsila]}',`glovk`='{$get_proto[glovk]}',`ginta`='{$get_proto[ginta]}',`gintel`='{$get_proto[gintel]}',
				  `ghp`='{$get_proto[ghp]}',`gmp`='{$get_proto[gmp]}',`mfkrit`='{$get_proto[mfkrit]}',`mfakrit`='{$get_proto[mfakrit]}',`mfuvorot`='{$get_proto[mfuvorot]}',`mfauvorot`='{$get_proto[mfauvorot]}',
				  `gnoj`='{$get_proto[gnoj]}',`gtopor`='{$get_proto[gtopor]}',`gdubina`='{$get_proto[gdubina]}',`gmech`='{$get_proto[gmech]}',`img`='{$get_proto[img]}',
				  `shshop`=0,`bron1`='{$get_proto[bron1]}',`bron2`='{$get_proto[bron2]}',`bron3`='{$get_proto[bron3]}',`bron4`='{$get_proto[bron4]}',
				  `dategoden`=0,`magic`=0,`type`='{$get_proto[type]}',`massa`='{$get_proto[massa]}',`goden`=0,`needident`=0,
				  `nfire`='{$get_proto[nfire]}',`nwater`='{$get_proto[nwater]}',`nair`='{$get_proto[nair]}',`nearth`='{$get_proto[nearth]}',`nlight`='{$get_proto[nlight]}',
				  `ngray`='{$get_proto[ngray]}',`ndark`='{$get_proto[ndark]}',`gfire`='{$get_proto[gfire]}',`gwater`='{$get_proto[gwater]}',`gair`='{$get_proto[gwater]}',
				  `gearth`='{$get_proto[gearth]}',`glight`='{$get_proto[glight]}',`ggray`='{$get_proto[ggray]}',`gdark`='{$get_proto[gdark]}',`letter`='',
				  `isrep`=1,`razdel`='{$get_proto[otdel]}',`gmeshok`=0,`group`=0,`wopen`=0,`ab_mf`=0,`ab_bron`=0,`ab_uron`=0,`need_wins`=0,`artproto`=0, `nclass`='{$get_proto[nclass]}' ;");


		  			$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$get_proto[owner]."'  ;"));
					$str_type=' личный артефакт для персонажа \"'.$art_telo[login].'\", доставлен в инвентарь в кол. 1 шт.';



		     			if ($get_proto[nlevel]>6) {
		     				$uplevel=$get_proto[nlevel];
		     			} else {
		     				$uplevel=6;
		     			}
					$price_item_ecost=500;//что запишет в инвентарь

	 	    			//если пушка
					if ($_SESSION['mkartch']['type']==3)
					{
						//если заточка
						if (strpos($_SESSION['mkartch']['name'], '+') !== false)
						{
						$tempa=explode("+",$_SESSION['mkartch']['name']);
						$sharp=(int)($tempa[1]);

							if ($sharp>0)
							{
					 		 $get_proto['minu']+=$sharp;
					 		 $get_proto['maxu']+=$sharp;
					 		 $get_proto['cost']+=30;
					 		 $get_proto['name']=$get_proto['name']."+".$sharp;
					 		 $get_proto['sharped']=1;

								 if ($get_proto['otdel']==1)
								 		{
								 		$get_proto['nnoj']+=$sharp;
								 		$get_proto['ninta']+=$sharp;
								 		}
								 else
								 if ($get_proto['otdel']==11)
								 		{
					 					$get_proto['ntopor']+=$sharp;
					 					$get_proto['nsila']+=$sharp;
								 		}
								 else
								 if ($get_proto['otdel']==12)
								 		{
										$get_proto['ndubina']+=$sharp;
										$get_proto['nlovk']+=$sharp;
										}
								else
					 			 if ($get_proto['otdel']==13)
					 			 		{
									 	$get_proto['nmech']+=$sharp;
									 	$get_proto['nvinos']+=$sharp;
									 	}
							}
						}
					}


	 	    			///перенос встроек из старого арта
	 	    								//встройки:
					if ( ($_SESSION['mkartch']['includemagic']>0) AND ($_SESSION['mkartch']['includemagicuses']>0)  )
					{
						$get_proto['includemagic']=$_SESSION['mkartch']['includemagic'];
						$get_proto['includemagicdex']=$_SESSION['mkartch']['includemagicdex'];
						$get_proto['includemagicmax']=$_SESSION['mkartch']['includemagicmax'];
						$get_proto['includemagicname']=$_SESSION['mkartch']['includemagicname'];
						$get_proto['includemagicuses']=$_SESSION['mkartch']['includemagicuses'];
						$get_proto['includemagiccost']=$_SESSION['mkartch']['includemagiccost'];
						$get_proto['includemagicekrcost']=$_SESSION['mkartch']['includemagicekrcost'];
						$get_proto['includerechargetype']=$_SESSION['mkartch']['includerechargetype'];
						$get_proto['includeprototype']=$_SESSION['mkartch']['includeprototype'];
						$get_proto['nintel']=$get_proto['nintel']<$_SESSION['mkartch']['nintel']?$_SESSION['mkartch']['nintel']:$get_proto['nintel'];
						$get_proto['nmudra']=$get_proto['nmudra']<$_SESSION['mkartch']['nmudra']?$_SESSION['mkartch']['nmudra']:$get_proto['nmudra'];
						$get_proto['nfire']=$get_proto['nfire']<$_SESSION['mkartch']['nfire']?$_SESSION['mkartch']['nfire']:$get_proto['nfire'];
						$get_proto['nwater']=$get_proto['nwater']<$_SESSION['mkartch']['nwater']?$_SESSION['mkartch']['nwater']:$get_proto['nwater'];
						$get_proto['nair']=$get_proto['nair']<$_SESSION['mkartch']['nair']?$_SESSION['mkartch']['nair']:$get_proto['nair'];
						$get_proto['nearth']=$get_proto['nearth']<$_SESSION['mkartch']['nearth']?$_SESSION['mkartch']['nearth']:$get_proto['nearth'];
						$get_proto['nlight']=$get_proto['nlight']<$_SESSION['mkartch']['nlight']?$_SESSION['mkartch']['nlight']:$get_proto['nlight'];
						$get_proto['ngray']=$get_proto['ngray']<$_SESSION['mkartch']['ngray']?$_SESSION['mkartch']['ngray']:$get_proto['ngray'];
						$get_proto['ndark']=$get_proto['ndark']<$_SESSION['mkartch']['ndark']?$_SESSION['mkartch']['ndark']:$get_proto['ndark'];
					}


	 	    			//перенос УУ для бесстатовых прототипов
	 	    			if ($get_proto['unik']==2)
							{
							$get_proto[stbonus]+=1;
							}

	 	    			// перенос подарка
	 	    			$get_proto['present']=$_SESSION['mkartch']['present'];

					mysql_query("INSERT INTO `oldbk`.`inventory` SET
						`name`='".mysql_real_escape_string($get_proto[name])."',
						`duration`='{$get_proto[duration]}',`maxdur`='{$get_proto[maxdur]}',`cost`='{$get_proto[cost]}',`owner`='{$get_proto[owner]}',
						`nlevel`='{$get_proto[nlevel]}',`nsila`='{$get_proto[nsila]}',`nlovk`='{$get_proto[nlovk]}',`ninta`='{$get_proto[ninta]}',`nvinos`='{$get_proto[nvinos]}',`nintel`='{$get_proto[nintel]}',
						`nmudra`='{$get_proto[nmudra]}',`nnoj`='{$get_proto[nnoj]}',`ntopor`='{$get_proto[ntopor]}',`ndubina`='{$get_proto[ndubina]}',`nmech`='{$get_proto[nmech]}',
						`nalign`='{$get_proto[nalign]}',`minu`='{$get_proto[minu]}',`maxu`='{$get_proto[maxu]}',
						`gsila`='{$get_proto[gsila]}',`glovk`='{$get_proto[glovk]}',`ginta`='{$get_proto[ginta]}',
						`gintel`='{$get_proto[gintel]}',`ghp`='{$get_proto[ghp]}',
						`mfkrit`='{$get_proto[mfkrit]}',`mfakrit`='{$get_proto[mfakrit]}',`mfuvorot`='{$get_proto[mfuvorot]}',`mfauvorot`='{$get_proto[mfauvorot]}',
						`gnoj`='{$get_proto[gnoj]}',`gtopor`='{$get_proto[gtopor]}',`gdubina`='{$get_proto[gdubina]}',`gmech`='{$get_proto[gmech]}',
						`img`='{$get_proto[img]}',`text`='',`dressed`=0,
						`bron1`='{$get_proto[bron1]}',`bron2`='{$get_proto[bron2]}',`bron3`='{$get_proto[bron3]}',`bron4`='{$get_proto[bron4]}',
						`dategoden`=0,`magic`=0,
						`type`='{$get_proto[type]}',
						`present`='{$get_proto['present']}',`sharped`='{$get_proto[sharped]}',
						`massa`='{$get_proto[massa]}',
						`goden`=0,`needident`=0,
						`nfire`='{$get_proto[nfire]}',`nwater`='{$get_proto[nwater]}',`nair`='{$get_proto[nair]}',`nearth`='{$get_proto[nearth]}',`nlight`='{$get_proto[nlight]}',`ngray`='{$get_proto[ngray]}',
						`ndark`='{$get_proto[ndark]}',`gfire`='{$get_proto[gfire]}',`gwater`='{$get_proto[gwater]}',`gair`='{$get_proto[gair]}',`gearth`='{$get_proto[gearth]}',`glight`='{$get_proto[glight]}',`ggray`='{$get_proto[ggra]}',`gdark`='{$get_proto[gdark]}',
						`letter`='',`isrep`=1,`update`=NOW(),`setsale`=0,
						`prototype`='{$get_proto[prototype]}',
						`otdel`='{$get_proto[otdel]}',`bs`=0,	`gmp`='{$get_proto[gmp]}',
						`includemagic`='{$get_proto['includemagic']}',
						`includemagicdex`='{$get_proto['includemagicdex']}',
						`includemagicmax`='{$get_proto['includemagicmax']}',
						`includemagicname`='{$get_proto['includemagicname']}',
						`includemagicuses`='{$get_proto['includemagicuses']}',
						`includemagiccost`='{$get_proto['includemagiccost']}',
						`includemagicekrcost`='{$get_proto['includemagicekrcost']}',
						`includerechargetype`='{$get_proto['includerechargetype']}',
						`includeprototype`='{$get_proto['includeprototype']}',
						`gmeshok`=0,`tradesale`=0,`karman`=0,
						`stbonus`={$get_proto[stbonus]},`upfree`=0,`ups`=5,
						`mfbonus`={$get_proto[mfbonus]},`mffree`=0,
						`type3_updated`=1,`bs_owner`=0,`nsex`=0,
						`present_text`='',`add_time`=0,`labonly`=0,`labflag`=0,`prokat_idp`=0,`prokat_do`=0,
						`arsenal_klan`='{$get_proto[arsenal_klan]}',`arsenal_owner`='{$get_proto[arsenal_owner]}',
						`repcost`='{$get_proto[repcost]}',
						`up_level`='{$uplevel}',
						`ecost`='{$price_item_ecost}',
						`group`=0,`ekr_up`='{$get_proto[ekr_up]}',
						`unik`={$_SESSION['mkartch'][unik]},
						`add_pick`='',`pick_time`=0,
						`sowner`='{$get_proto[sowner]}',
						`idcity`=0,`battle`=0,`t_id`=0,
						`ab_mf`='{$get_proto[ab_mf]}',`ab_bron`='{$get_proto[ab_bron]}',`ab_uron`='{$get_proto[ab_uron]}',
						`art_param` ='{$get_proto[art_param]}' , `nclass`='{$get_proto[nclass]}' ;");

 				  			$inserted_id=mysql_insert_id();

							if (mysql_affected_rows()>0)
							{


							mysql_query('DELETE FROM oldbk.inventory WHERE id='.$artid) or die();

								  	//пишем в переводы о том что чел получил арт
			  		    				$rec['owner']=$art_telo[id];
									$rec['owner_login']=$art_telo[login];
									$rec['owner_balans_do']=$art_telo['money'];
									$rec['owner_balans_posle']=$art_telo['money'];
									$rec['target']=0;
									$rec['target_login']='КО';
									$rec['type']=377;//получил предмет при обмене!!
									$rec['sum_kr']=0;
									$rec['sum_ekr']=$get_proto[ecost];
									$rec['sum_rep']=$get_proto[repcost];;
									$rec['sum_kom']=0;
									$rec['item_id']='cap'.$inserted_id;
									$rec['item_name']=$get_proto[name];
									$rec['item_count']=1;
									$rec['item_type']=$get_proto[type];
									$rec['item_cost']=$get_proto[cost];
									$rec['item_dur']=$get_proto[duration];
									$rec['item_maxdur']=$get_proto[maxdur];
									$rec['item_ups']=$get_proto[ups];
									$rec['item_unic']=$_SESSION['mkartch'][unik];
									$rec['item_incmagic']=$get_proto['includemagicname'];
									$rec['item_incmagic_count']=$get_proto['includemagicmax'];
									$rec['item_arsenal']='';
									$rec['bank_id']='';
									$rec['add_info']="(id:".$artinfo['id'].")".$artinfo['name'];
									add_to_new_delo($rec); //юзеру

									if ($art_telo['odate'] > (time()-60)) {
										addchp('<font color=red>Внимание!</font> Вам одобрен при обмене '.$str_type.' ','{[]}'.$art_telo['login'].'{[]}',$art_telo['room'],$art_telo['id_city']);
									} else {
										mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$art_telo['id']."','','<font color=red>Внимание!</font> Вам одобрен при обмене {$str_type} ');");
									}
							  		echo "<font color=red>Артефакты удачно обменяны!</font>";



									//обновляем данные о прототипе
									if ($inserted_id>0)
										{
										mysql_query("UPDATE `oldbk`.`art_bonus` SET `itemid`= '{$inserted_id}'  WHERE `itemid`='{$get_proto['id']}' ");
										}

							 		if ( ($artinfo['id']>0 ) and ($inserted_id>0) )
							 		{
									 move_art_bonus($artinfo['id'],$inserted_id); // установка бонуса арта если он был со старого на новый
									 }
									 else
									 {
									// echo "NS";
									 }

							  		unset($_SESSION['mkartch']);
									unset($_SESSION['ekrids']);
									unset($_SESSION['mkartch_free']);
									unset($_SESSION['save_proto_memory']);
									unset($_SESSION['mkartch_new_slot']);
									unset($_SESSION['mkartch_new_slot_from_hram']);
						 	}
					}



			}
			else
			{
			echo "Ошибка не сделали арт...";
			}
			}
	  	}
	 $form_pay=0;
	$form_view=0;

	}
	else
   	 if ( ($_GET[pay]) and  ( ((int)($_GET[paymethod])==0) OR ((int)($_GET[paymethod])>5)))
      	{
      		echo '<center><b style="color:#800000">Ошибка! Необходимо выбрать способ оплаты!</b></center><br>';
      	}
      	else if ( ($_GET[pay]) and  ( ((int)($_GET[paymethod])==1) and ($action!='mkclanart')) )
      	{
      		echo '<center><b style="color:#800000">Этот способ оплаты недопустим для оплаты личного артефакта!</b></center><br>';
      	}
      	else if ( ($_GET[pay]) and  ( (($_GET[paymethod]!=1)AND($_GET[paymethod]!=3))  and ($action=='mkclanart')) )
      	{
      		echo '<center><b style="color:#800000">Ошибка! Этот способ оплаты недопустим для оплаты кланового артефакта!</b></center><br>';
      	}
      	else if ( ($_GET[pay]) and  ( ((int)($_GET[paymethod])>=1) OR ((int)($_GET[paymethod])<=4)))
      	{
      	$form_pay=0;
      	$form_view=0;
      	  		if (($_GET[paymethod]==1) and ($action=='mkclanart'))
      	  		{
      	  		//оплата через казну, ввод пароля от казны клана
			  $glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
			  if ($glava_test[id]>0)
			  {
      	  		echo "<table width=\"100%\" border=\"0\"  ><tr><td width=5% >&nbsp;</td><td>&nbsp;";
			  //да я глава
			  $form_kazna=1;
			  if (($_POST[kaznapass]) OR ($_SESSION['kaznapass']))
			  	{
			  	if (isset($_SESSION['kaznapass'])) {$klan_pass=$_SESSION['kaznapass']; } else {$klan_pass=$_POST[kaznapass]; }
				$kaznadata = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`clans_kazna` WHERE `clan_id` = '".$glava_test[id]."' AND `ekr_pass`= '".mysql_real_escape_string($klan_pass)."' ;"));
			  	 if ($kaznadata[clan_id]>0)
			  	   {
			  	   $_SESSION['kaznapass']=$kaznadata[ekr_pass];
			  	   // удачный вход
			  	   	echo "<br><br><CENTER>В клановой казне:<b>{$kaznadata['ekr']} екр.</b><br>";
      	  				echo "<br>Сумма к оплате:<b>{$price_klan_ekr} екр.</b><br></CENTER>";
					if ($price_klan_ekr > $kaznadata['ekr'])
      	  				{
      	  				echo "<center><b style=\"color:#800000\">Ошибка! У Вас недостаточно средств для оплаты!</b></center><br>";
					echo "<br><br><br><center><a href=?saveart=1&act=mkclanart class=button2>ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>";
      	  				}
      	  				else
      	  				{
      	  				 if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]!=1) )
      	  						{
 		     	  				 if (mk_clan_kazna_pay($price_klan_ekr,$kaznadata[clan_id],$glava_test[short]))
      	  				 		{
      	  				 		echo "<center><b>Оплата произведена успешно!</b></center>";
								echo "<br><br><center><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br>";
      	  				 		$_SESSION['save_proto_memory'][billok]=1;
      	  				 		unset($_SESSION['save_proto_memory']);
      	  				 		}
      	  				 		else
      	  				 		{
      	  				 		echo "<center><b style=\"color:#800000\">Ошибка при оплате!</b></center>";
      	  				 		}
      	  						}
      	  					 	else if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]==1) )
      	  				 		{
      	  			 			echo "<center><b style=\"color:#800000\">Ошибка! Этот артефакт уже оплачен!</b></center>";
      		  			 		}
	      	  			 		else
      	  			 		{
      	  					echo "<br><form id=\"form1\" name=\"form1\" method=get action=index.php>";
	 					echo "<input type=hidden name=act value='mkclanart'><input type=hidden name=art_bonus value='".(int)($_GET[art_bonus])."'><input type=hidden name=paymethod value='1'><input type=hidden name=userok value='1'>
	 					<center><input type=submit name=pay value='ПОДТВЕРДИТЬ ОПЛАТУ' class='button2'; ></center>
					  	</p></form><br>";
						echo "<br><br><br><a href=?saveart=1&act=mkclanart class=button2>ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a><br>";
					  	}
      	  				}

      	  				$form_kazna=0;
			  	   }
			  	   else
			  	   {
			  	   unset($_SESSION['kaznapass']);
					echo '<center><b style="color:#800000">Ошибка! Неверный пароль екр. казны клана, либо у клана нет клановой казны!</b></center><br>';
			  	   }
			  	}
			  if ($form_kazna==1)
			  {
				echo "<center><form method=post>";
				echo "<fieldset style=\"width:300px; height:130px;\">";
				echo "<legend><b>Войти в клановую казну</b></legend><BR>";
				echo "<BR> &nbsp; Пароль от екровой казны клана: <input type=password name=kaznapass size=16>";
				echo "<BR><BR><BR>";
				echo "<center><input type=submit name='enter' value='ВОЙТИ' class='button2'; >";
				echo "</form>";
			  }
			echo "</td></tr></table>";
	  		 }
      	  		}
      	else
      	  		if ($_GET[paymethod]==2)
      	  		{
      	  		echo "<center><b style=\"color:#800000\">Ошибка выбора метода!</b></center><br>";
      	  		/*
      	  		$form_bank_login=1;
      	  		//оплата через банк екрами , выбор номера + ввод пароля
      	  		echo "<br><table width=\"100%\" border=\"0\"  ><tr><td width=5% >&nbsp;</td><td>&nbsp;";

      	  			if (($_GET[cbnk]) and ($_SESSION['bankid']))
      	  			{
      	  			unset($_SESSION['bankid']);
      	  			unset($_SESSION['bank_ekr']);
      	  			}
      	  			else
      	  			if (($_POST[bankid]) and ($_POST[bankpass]) and (!($_SESSION['bankid'])) )
      	  			{
				$bnkdata = mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$_SESSION['uid']."' AND `id`= '".(int)($_POST[bankid])."' AND `pass` = '".md5($_POST['bankpass'])."';");
				$bnkdata = mysql_fetch_array($bnkdata);
					if($bnkdata)
					{
		      	  		$form_bank_login=0;
					$_SESSION['bankid'] = $bnkdata[id];
					$_SESSION['bank_ekr'] = $bnkdata[ekr];
					echo "Удачный вход";
					}
					else
					{
					echo '<br><font color=red>Неверный пароль от банковского счета!</font><br>';
					}
      	  			}

      	  			if ($_SESSION['bankid'])
      	  				{
      	  				// уже залогинились
      	  				echo "<br><br>У Вас на счету:<b>{$_SESSION['bank_ekr']} екр.</b><br>";
      	  				echo "<br>Сумма к оплате:<b>{$price_pers_ekr} екр.</b><br>";

      	  				 if ($price_pers_ekr > $_SESSION['bank_ekr'])
      	  				    {
      	  				echo "<br><font color=red><b>У Вас недостаточно средств для оплаты!</b></font><br<br>";
      	  				    }
      	  				    else
      	  				    {
      	  				echo "<br><form id=\"form1\" name=\"form1\" method=get action=index.php>";
	 				echo "<input type=hidden name=act value='mkpersonalart'><input type=hidden name=paymethod value='2'><input type=hidden name=userok value='1'>
 					<input type=submit name=pay value='Подтвердить' style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'; >
				  	</p></form><br>";
      	  				    }

      	  				echo "<br><br><a href=?paymethod=2&act=mkpersonalart&pay=1&cbnk=1>Выбрать другой счет</a><br>";
      	  				echo "<br><a href=?saveart=1&act=mkpersonalart>Выбрать другой способ оплаты!</a><br>";
      	  				$form_bank_login=0;
      	  				}

			 if ($form_bank_login==1)
			 	{
				echo "<br><form method=post>";
				echo "<fieldset style=\"width:200px; height:130px;\">";
				echo "<legend>Войти в счет</legend><BR> &nbsp; №";
				$banks = mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$_SESSION['uid']."';");
				echo "<select style='width:155px' name=bankid>";
				while ($rah = mysql_fetch_array($banks)) {
								echo "<option>",$rah['id'],"</option>";
								}
				echo "</select>";
				echo "<BR> &nbsp; Пароль <input type=password name=bankpass size=16>";
				echo "<BR><BR>";
				echo "<center><input type=submit name='enter' value='Войти' style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'; >";
				echo "</form>";
				echo "</fieldset>";
  				echo "<br><a href=?saveart=1&act=mkpersonalart>Выбрать другой способ оплаты!</a><br>";
				}
			echo "</td></tr></table>";
			*/
      	  		}
      	else
      	  		if ($_GET[paymethod]==3) {
	      	  		// списываем монеты
				echo "<br><table width=\"100%\" border=\"0\"  >
	      	  		<tr><td width=5% >&nbsp;</td>
	      	  		<td>&nbsp;<p>";
	      	  		//тут две суммы зависимости от типа арта
	      	  		if ($action=='mkclanart') { $rez_prise=$price_klan_ekr ; } else {$rez_prise=$price_pers_ekr; }
				$us = check_users_city_datal($user);
				$rez_prise = $rez_prise * $EKR_TO_GOLD;

      	  			echo "<center><br> Сумма к оплате: <b style=\"color:#800000\">{$rez_prise} золотых монет.</b><br> У вас в наличии <b>".$us['gold']."</b> монет.<br><br>";

				if (($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]!=1)) {

					if ($us['gold'] >= $rez_prise) {
						$pr = $rez_prise;
						mysqL_query('UPDATE oldbk.users SET gold = gold - '.$pr.' WHERE id = '.$us['id'].' LIMIT 1');

						$rec['owner']=$us[id];
						$rec['owner_login']=$us[login];
						$rec['owner_balans_do']=$us[money];
						$rec['owner_balans_posle']=$us[money];
						$rec['target']=0;
						$rec['target_login']='КО';
						$rec['type']=507;
						$rec['sum_kr']=0;
						$rec['sum_ekr']=0;
						$rec['sum_kom']=0;
						$rec['add_info'] = $pr."/".($us['gold']-$pr);
						add_to_new_delo($rec);

						if (mk_pay_bill($rez_prise,$action,1)) {
	     	  				 	echo "<center><b style=\"color:#800000\">Золотые монеты списаны. Ожидайте получения.</b></center>";
							echo "<br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br>";
	      	  				 	$_SESSION['save_proto_memory'][billok]=1;
						} else {
							echo "<center><b style=\"color:#800000\">Ошибка при оплате монетами!</b></center><br>";
						}
					} else {
      	  				 	echo "<center><b style=\"color:#800000\">Недостаточно монет для оплаты!</b></center><br>";
					}
      	  			} else if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]==1)) {
					echo "<center><b style=\"color:#800000\">Ошибка! Этот артефакт уже оплачен!</b></center><br>";
				} else {
		  			echo "<form id=\"form1\" name=\"form1\" method=get action=index.php>";
 					echo "<input type=hidden name=act value='{$action}'><input type=hidden name=art_bonus value='".(int)($_GET[art_bonus])."'><input type=hidden name=paymethod value='3'><input type=hidden name=userok value='1'>";
					if ($us['gold'] >= $rez_prise) {
				 		echo "<center><br><br><input type=submit name=pay value='ПОДТВЕРДИТЬ ОПЛАТУ' class=\"button2\"; ></center>";
					}
					echo "<br><br><br><center><a href=?saveart=1&act={$action} class=\"button2\">ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br></p></form><br>";
				}
      	  			echo "</td></tr></table>";
      	  		}
      	else
      	  		if ($_GET[paymethod]==4)
      	  		{
      	  		//РЕпутация
      	  		$telo=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.users where id='{$_SESSION['uid']}'; "));
      	  		if ($telo[id_city]==1) { $telo=mysql_fetch_array(mysql_query("SELECT * FROM avalon.users where id='{$_SESSION['uid']}'; ")); }
      	  		elseif ($telo[id_city]==2) { $telo=mysql_fetch_array(mysql_query("SELECT * FROM angels.users where id='{$_SESSION['uid']}'; ")); }

      	  		echo "<br><table width=\"100%\" border=\"0\"  >
      	  		<tr><td width=5% >&nbsp;</td>
      	  		<td>&nbsp;<p>";

      	  		echo "<CENTER>У Вас на счету:<b>{$telo[repmoney]}</b> репутации покупки.<br>";
      	  		echo "<br> Сумма к оплате:<b>{$price_rep}</b> репутации покупки.<br><br>";
			if (isset($_GET['mkec2ids'])) {
			//оплата проверки из банка
			global $PRICE;
				if (($_GET['bankpass']=="") OR ($_GET['bankid']=="") )
				{
				serr("Вы не указали пароль от банковского счета для оплаты экспресс рассмотрение заявки!");
				$err_stop=true;
				}
				else
				{

					$bankid=(int)($_GET['bankid']);
					$bankpas=$_GET['bankpass'];
					$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$telo['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

					if ($bank[id]>0)
						{

							if (($bank['ekr']) < $PRICE[207][cost] )
							{
								serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$PRICE[207][cost]." екр.");
								$err_stop=true;
							} else
							{
								// всё ок
							}
						}
						else
						{
						serr('Ошибка! Не верный пароль от банковского счета, для оплаты экспресс рассмотрение заявки!');
						$err_stop=true;
						}
				}

				////////////////////
			}
			echo '<br>';

			if ($err_stop==true)
				{
				echo "<br><br><center><a href=?saveart=1&act=mkpersonalart class=\"button2\">ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>";
				}
			else
				{
      	  		if ($price_rep>$telo[repmoney])
      	  			{
      	  			echo "<center><b style=\"color:#800000\">Ошибка! У Вас недостаточно репутации для оплаты!</b></center><br>
      	  			<br><br><center><a href=?saveart=1&act=mkpersonalart class=\"button2\">ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>";
      	  			}
      	  			else
      	  			{
      	  			if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]!=1)) {
					global $PRICE;
					$echeck = false;
					if (isset($_GET['mkec2ids']))
					{
					//снимаем деньги за оплату експерсс
									$q = mysql_query('START TRANSACTION') or die();

									//оплачиваем
									$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$telo['id']}'  AND ekr>=".$PRICE[207][cost]."  FOR UPDATE ;");
									if (!(mysql_num_rows($get_bank) > 0) )
									{
									die();
									}
									else
									{
									$bank = mysql_fetch_assoc($get_bank);

									mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$PRICE[207][cost]}' WHERE `id`= '{$bank['id']}' and owner='{$telo['id']}'  ");
									//  пишем в хистори банка
									$bank['ekr']-=$PRICE[207][cost];
									mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$PRICE[207][cost]} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
									}
									$rec = array();
						    			$rec['owner']=$telo[id];
									$rec['owner_login']=$telo[login];
									$rec['owner_balans_do']=$telo['money'];
									$rec['owner_balans_posle']=$telo['money'];
									$rec['owner_rep_do']=$telo['repmoney'];
									$rec['target_login'] = "КО";
									$rec['owner_rep_posle']=$telo['repmoney'];
									$rec['type'] = 2282;
									$rec['sum_ekr']=$PRICE[207][cost];
									$rec['bank_id']=$bank['id'];
									if (add_to_new_delo($rec) === FALSE) die();
									$q = mysql_query('COMMIT') or die();
									$echeck = true;
      	  				}

     	  				if (mk_pay_rep($price_rep,$echeck)) {
      	  				 	echo "Оплата произведена успешно!";
      	  				 	$_SESSION['save_proto_memory'][billok]=1;
  				 		unset($_SESSION['save_proto_memory']);
					} else {
						echo "Ошибка оплаты!";
					}
				}
      	  			 else if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]==1) )
      	  			 	{
      	  			 		echo "Этот артефакт уже оплачен!";
      	  			 	}
      	  			 	else
      	  			 	{
	      	  			echo "<form id=\"form1\" name=\"form1\" method=get action=index.php>";
					if (isset($_GET['mkec2ids']))
						{
						echo '<b>Оплата 15 екр экспресс рассмотрение заявки со счета №'.$bankid.' </b><br><br><br>';
						echo '<input type="hidden" name="mkec2ids" value="yes">';
						echo '<input type="hidden" name="bankid" value="'.$bankid.'">';
						echo '<input type="hidden" name="bankpass" value="'.$bankpas.'">';
						}

 					echo "<input type=hidden name=act value='mkpersonalart'><input type=hidden name=art_bonus value='".(int)($_GET[art_bonus])."'><input type=hidden name=paymethod value='4'><input type=hidden name=userok value='1'>
 					<input type=submit name=pay value='Подтвердить' style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'; >
 					<br><br><br><br><center><a href=?saveart=1&act=mkpersonalart class=button2>ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>
			  		</p></form><br>";
			  		}

      	  			}
      	  			}
			echo "</td></tr></table>";
      	  		}
			else
      	  		if ($_GET[paymethod]==5)
      	  		{
      	  		// за вексель и тут оплата
      	  				      	  		$telo=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.users where id='{$_SESSION['uid']}'; "));
					      	  		if ($telo[id_city]==1) { $telo=mysql_fetch_array(mysql_query("SELECT * FROM avalon.users where id='{$_SESSION['uid']}'; ")); }
					      	  		elseif ($telo[id_city]==2) { $telo=mysql_fetch_array(mysql_query("SELECT * FROM angels.users where id='{$_SESSION['uid']}'; ")); }
			if (isset($_GET['mkec2ids']))
			{
			//оплата проверки из банка
			global $PRICE;
				if (($_GET['bankpass']=="") OR ($_GET['bankid']=="") )
				{
				serr("Вы не указали пароль от банковского счета для оплаты экспресс рассмотрение заявки!");
				$err_stop=true;
				}
				else
				{

					$bankid=(int)($_GET['bankid']);
					$bankpas=$_GET['bankpass'];
					$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$telo['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));

					if ($bank[id]>0)
						{

							if (($bank['ekr']) < $PRICE[207][cost] )
							{
								serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$PRICE[207][cost]." екр.");
								$err_stop=true;
							} else
							{
								// всё ок
							}
						}
						else
						{
						serr('Ошибка! Не верный пароль от банковского счета, для оплаты экспресс рассмотрение заявки!');
						$err_stop=true;
						}
				}

				////////////////////
			}
						if ($err_stop==true)
						{
							echo "<br><br><center><a href=?saveart=1&act=mkpersonalart class=\"button2\">ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>";
						}
						else
						{
					      	//ищем вексель
					      	$get_veks= mysql_fetch_array(mysql_query("select * from oldbk.inventory where owner='{$_SESSION['uid']}' and prototype=3005000 and setsale=0 LIMIT 1"));
					      	if ($get_veks[id]>0)
					      	{
					      	//есть вексель
					      if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]!=1))
					   	 {
					      //непосредственно  оплата + ваучеры на экспрес проверку хз
					 global $PRICE;
					$echeck = false;
					if (isset($_GET['mkec2ids']))
					{
					//снимаем деньги за оплату експерсс
									$q = mysql_query('START TRANSACTION') or die();
									//оплачиваем
									$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$telo['id']}'  AND ekr>=".$PRICE[207][cost]."  FOR UPDATE ;");
									if (!(mysql_num_rows($get_bank) > 0) )
									{
									die();
									}
									else
									{
									$bank = mysql_fetch_assoc($get_bank);

									mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$PRICE[207][cost]}' WHERE `id`= '{$bank['id']}' and owner='{$telo['id']}'  ");
									//  пишем в хистори банка
									$bank['ekr']-=$PRICE[207][cost];
									mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела <b>{$PRICE[207][cost]} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
									}
									$rec = array();
						    			$rec['owner']=$telo[id];
									$rec['owner_login']=$telo[login];
									$rec['owner_balans_do']=$telo['money'];
									$rec['owner_balans_posle']=$telo['money'];
									$rec['owner_rep_do']=$telo['repmoney'];
									$rec['target_login'] = "КО";
									$rec['owner_rep_posle']=$telo['repmoney'];
									$rec['type'] = 2282;
									$rec['sum_ekr']=$PRICE[207][cost];
									$rec['bank_id']=$bank['id'];
									if (add_to_new_delo($rec) === FALSE) die();
									$q = mysql_query('COMMIT') or die();
									$echeck = true;
      	  				}

						 	     	  				if (mk_pay_veks($price_rep,$echeck))
						 	     	  				{
						      	  				 	echo "Оплата произведена успешно!";
						      	  				 	$_SESSION['save_proto_memory'][billok]=1;
						  				 		unset($_SESSION['save_proto_memory']);
												}
												else
												{
												echo "Ошибка оплаты!";
												}
					      						}
					      		else if ( ($_GET[userok]==1) and ($_SESSION['save_proto_memory'][billok]==1) )
		      	  			 	{
      	  				 		echo "Этот артефакт уже оплачен!";
      	  					 	}
		      	  			 	else
      	  					 	{
		      	  			echo "<center><form id=\"form1\" name=\"form1\" method=get action=index.php>";
		      	  			echo '<b>Оплата личного аретефакта - векселем<br><br>';
						if (isset($_GET['mkec2ids']))
						{
						echo '<b>Оплата 15 екр экспресс рассмотрение заявки со счета №'.$bankid.' </b><br><br><br>';
						echo '<input type="hidden" name="mkec2ids" value="yes">';
						echo '<input type="hidden" name="bankid" value="'.$bankid.'">';
						echo '<input type="hidden" name="bankpass" value="'.$bankpas.'">';
						}
	 					echo "<input type=hidden name=act value='mkpersonalart'><input type=hidden name=art_bonus value='".(int)($_GET[art_bonus])."'><input type=hidden name=paymethod value='5'><input type=hidden name=userok value='1'>
 						<input type=submit name=pay value='Подтвердить' style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'; >
	 					<br><br><br><br><center><a href=?saveart=1&act=mkpersonalart class=button2>ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>
				  		</p></form><br></center>";
			  				}

					      	}
					      	else
					      	{
					      	//нету векселя
					      	echo "<center><b style=\"color:#800000\">Ошибка! У Вас нет векселей для оплаты!</b></center><br>
		      	  			<br><br><center><a href=?saveart=1&act=mkpersonalart class=\"button2\">ВЫБРАТЬ ДРУГОЙ СПОСОБ ОПЛАТЫ</a></center><br>";
					      	}
					      	}






      	  		}




      		//echo "Обработка выбранного метода оплаты....";


      	}



	if ($form_pay==1)
      	  {
   	echo "<br>
   	<form id=\"form1\" name=\"form1\" method=get action=index.php>
	<table align=center width=\"450\" border=\"0\"  >
  	<tr>
	<td>&nbsp;<p>";

	echo "<center><b>Выберите один из способов оплаты:</b></center><br><br><script>var pmethod = 0;</script>";

	  	if ($action=='mkclanart')
  		{
    		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"3\" id=\"paymethod_3\" />&nbsp;&nbsp; Списать ".($price_pers_ekr*$EKR_TO_GOLD)." золотых монет.</label><br />";
  		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"1\" id=\"paymethod_1\" checked=\"checked\" />&nbsp;&nbsp;Списать ".$price_klan_ekr." екр. из казны клана </label><br />";
  		}
  		else
  		{
		echo '<script>

			function ChShow(id) {
				document.getElementById(id).style.display = "";
			}
			function ChHide(id) {
				document.getElementById(id).style.display = "none";
			}
			function ChSel(t) {
				ChHide("chsel3");
				ChHide("chsel4");
				ChHide("chsel5");
				ChShow("chsel"+parseInt(t.value));
				pmethod = 4;
			}
			function ChSel4(t) {
				if (t.checked) {
					ChShow("chselv4");
				} else {
					ChHide("chselv4");
				}
			}
		</script>';
    		echo "<label><input OnChange=\"ChSel(this);\" type=\"radio\" name=\"paymethod\" value=\"3\" id=\"paymethod_3\" />&nbsp;&nbsp;Списать ".($price_pers_ekr*$EKR_TO_GOLD)." золотых монет.</label><br />";
//    		echo '<div style="display:none;margin-left:48px;" id="chsel3"><input type="checkbox" disabled checked> экспресс рассмотрение заявки 15 <b>екр</b>. (включено в стоимость)</div>';
	    	//echo "<label><input type=\"radio\" name=\"paymethod\" value=\"2\" id=\"paymethod_2\" />&nbsp;&nbsp;Оплата екр из банковского счета (".$price_pers_ekr." екр.) </label><br />";
	    	echo "<label><input OnChange=\"ChSel(this);\" type=\"radio\" name=\"paymethod\" value=\"4\" id=\"paymethod_4\" />&nbsp;&nbsp;Списать ".$price_rep." репутации покупки с Вашего персонажа </label><br />";
//    		echo '<div style="display:none;margin-left:48px;" id="chsel4"><input id="clearflag4" OnChange="ChSel4(this);" type="checkbox" name="mkec2ids"> экспресс рассмотрение заявки 15 <b>екр</b>.<a style="cursor: pointer; color: red;" title="При отказе ваучеры за экспресс проверку не возвращаются" alt="При отказе ваучеры за экспресс проверку не возвращаются">(!)</a></div>';

	    	echo "<label><input OnChange=\"ChSel(this);\" type=\"radio\" name=\"paymethod\" value=\"5\" id=\"paymethod_5\" />&nbsp;&nbsp;Оплатить векселем </label>";
//    		echo '<div style="display:none;margin-left:48px;" id="chsel5"><input id="clearflag5" OnChange="ChSel4(this);" type="checkbox" name="mkec2ids"> экспресс рассмотрение заявки 15 <b>екр</b>.<a style="cursor: pointer; color: red;" title="При отказе ваучеры за экспресс проверку не возвращаются" alt="При отказе ваучеры за экспресс проверку не возвращаются">(!)</a></div>';

    		echo '<div style="display:none;m" id="chselv4">';

		global $PRICE;

						$us = check_users_city_datal($user);
						$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
						if (!(mysql_num_rows($get_bank) > 0) )
								{
								echo '<font color=red>У вас нет доступных банковских счетов!</font>';
								}
					else
					{
										$BANKS="<select style='width:150px' name=bankid>";
										while($row = mysql_fetch_assoc($get_bank))
										{
										$BANKS.="<option>".$row['id']."</option>";
										}
										$BANKS.="</select>";

								echo '
								<center>
								<div id="allconstr">
									<br>
									Банковский счет:'.$BANKS.' пароль <input type=password size=8 name=bankpass><br><br>
								';

									echo '
									<script>

									function CheckF() {

										if (confirm("Вы уверены?")) {
											return true;
										}

									}

									function CheckArtAll() {
										if (pmethod == 4 && document.getElementById("clearflag4").checked) {
											if (CheckF()) {
												document.getElementById("form1").submit();
											} else {
												return false;
											}
										} else {
											document.getElementById("form1").submit();
										}

										document.getElementById("form1").submit();
									}
									</script>';
				}

		echo '</div></center></div>

		</div></div>';
		echo "<br />    <br />    <br />";
	    	}
	echo "<input type=hidden name=act value='{$action}'><input type=hidden name=art_bonus value='".(int)($_GET[art_bonus])."'></td></tr></table> <br><center>
    	<input type=submit name=pay OnClick=\"return CheckArtAll();\" value='ОПЛАТИТЬ' class='button2';  >
  	</center></p>
	</form>	";
   	$form_view=0;
   	}
    }
}

if ($form_view==1)

{
echo "
<script>
        function request(artid){
            hax({url:'https://oldbk.com/commerce/getitem1.php?act={$action}&art_bonus=".(int)($_GET[art_bonus])."&artid='+artid, id:'idiv', anticache:1})
        }
</script>
     ";

if ((is_array($_SESSION['mkartch'])) AND ($_SESSION['mkartch_new_slot']==true) )
{

		$old_art=$_SESSION['mkartch'];
		echo '<br>
		<table align=center border=0 cellpadding=5><tr align=left valign=top><td>
		Выберите тип вещи: </td><td>
		<select name="arttype" id="arttype" >
		<option value="select">--------------------------------</option>
		<option value="11">Оружие:топоры</option>
		<option value="12">Оружие:дубины,булавы</option>
		<option value="13">Оружие:мечи</option>
		<option value="2">Сапоги</option>
		<option value="21">Перчатки</option>
		<option value="23">Тяжелая броня</option>
		<option value="24">Шлемы</option>
		<option value="3">Щиты</option>
		<option value="4">Cерьги</option>
		<option value="41">Ожерелья</option>
		    </select>
		    </td></tr><tr align=left valign=top><td>Выберите название вещи: </td><td>
		    <select name="artproto" id="artproto" onChange="request(this.value)">
		        <option class="select" value="0">--------------------------------</option> ';

			$get_user_alig=mysql_fetch_array(mysql_query("select  id,login,align, klan, level  from oldbk.users where id='{$_SESSION['uid']}' "));

		        if ($get_user_alig['klan']=='pal')
		        {
		        $add_align="nalign=6 or nalign=1 or ";
		        }
		        else if ($get_user_alig['align']>0)
		        {
		        $ali=(int)($get_user_alig['align']);
		        $add_align="nalign={$ali} or ";
		        }
		        else
		        {
		        $add_align="";
		        }

		//выбираем новые доступные для обмена
				if ($_SESSION['mkartch_new_slot_from_hram']==true)
				{
				$nlvlsql=""; // любой уровень
				}
				elseif ($get_user_alig['level']>=14)
				{
				$nlvlsql="and  nlevel='14' ";
				}
				else
				{
				$nlvlsql="and  nlevel='{$get_user_alig['level']}' ";
				}


			$get_proto=mysql_query("SELECT id,name,razdel,cost,nlevel,nclass, 0 as type FROM oldbk.shop where  (new_item>0 or (type = 3 and nlevel >= 7)) and artproto > 0 AND ({$add_align} nalign=0) {$nlvlsql} order by nlevel,cost");  //любой слот

}
else
if (is_array($_SESSION['mkartch']))
	{

	//режим обмена
	$old_art=$_SESSION['mkartch'];
			$otdel_arr[1]="Оружие:кастеты,ножи";
			$otdel_arr[11]="Оружие:топоры";
			$otdel_arr[12]="Оружие:дубины,булавы";
			$otdel_arr[13]="Оружие:мечи";
			$otdel_arr[2]="Сапоги";
			$otdel_arr[21]="Перчатки";
			$otdel_arr[22]="Легкая броня";
			$otdel_arr[23]="Тяжелая броня";
			$otdel_arr[24]="Шлемы";
			$otdel_arr[3]="Щиты";
			$otdel_arr[4]="Cерьги";
			$otdel_arr[41]="Ожерелья";


		echo '<br>
		<br>
		<table align=center border=0 cellpadding=5><tr align=left valign=top><td>
		Выберите тип вещи: </td><td>
		<select name="arttype" id="arttype" ';

			if (($_SESSION['mkartch']['type']==3) )  // если пушка
			{
			echo '>';
			}
			else
			{
			//во всех остальнвх случаях
			echo 'disabled>';
			}
		echo '<option value="select">--------------------------------</option>';

			if (($_SESSION['mkartch']['type']==3) )  // если пушка
			{
			echo '  <option value="1" '; if ($old_art['otdel']==1) { echo ' selected="TRUE" '; }   echo '>Оружие:кастеты,ножи</option>';
			echo '  <option value="11"'; if ($old_art['otdel']==11) { echo ' selected="TRUE" '; }   echo '>Оружие:топоры</option>';
			echo '  <option value="12"'; if ($old_art['otdel']==12) { echo ' selected="TRUE" '; }   echo '>Оружие:дубины,булавы</option>';
			echo '  <option value="13"'; if ($old_art['otdel']==13) { echo ' selected="TRUE" '; }   echo '>Оружие:мечи</option>';
			}
			else
			{
			echo '  <option value="'.$old_art['otdel'].'" selected="TRUE" >'.$otdel_arr[$old_art['otdel']].'</option>';
			}
         	$forceartrazdel = $old_art['otdel'];
		echo '</select>
		    </td></tr><tr align=left valign=top><td>Выберите название вещи: </td><td>
		    <select name="artproto" id="artproto" onChange="request(this.value)">
		        <option class="select" value="0">--------------------------------</option> ';

			$get_user_alig=mysql_fetch_array(mysql_query("select  id,login,align, klan, level  from oldbk.users where id='{$_SESSION['uid']}' "));

		        if ($get_user_alig['klan']=='pal')
		        {
		        $add_align="nalign=6 or nalign=1 or ";
		        }
		        else if ($get_user_alig['align']>0)
		        {
		        $ali=(int)($get_user_alig['align']);
		        $add_align="nalign={$ali} or ";
		        }
		        else
		        {
		        $add_align="";
		        }

		//выбираем новые доступные для обмена
		if (is_array($_SESSION['ekrids']))
		{
		//платный
			if ($get_user_alig['level']>=14)
				{
				$nlvlsql="and  nlevel='14' ";
				}
				else
				{
				$nlvlsql="and  nlevel='{$get_user_alig['level']}' ";
				}

		$get_proto=mysql_query("SELECT id,name,razdel,cost,nlevel,nclass, 0 as type FROM oldbk.shop where (new_item > 0 or (type = 3 and nlevel >= 7)) and artproto>0  AND ({$add_align} nalign=0) {$nlvlsql}  and type={$old_art['type']} order by nlevel,cost");
		}
		else
		{
		//бесплатный
	        $add_align="nalign={$old_art['nalign']} or ";
		$get_proto=mysql_query("SELECT id,name,razdel,cost,nlevel,nclass, 0 as type FROM oldbk.shop where artproto>0 and (new_item > 0 or (type = 3 and nlevel >= 7)) AND ({$add_align} nalign=0) and nlevel='{$old_art['nlevel']}'  and type={$old_art['type']}  order by nlevel,cost");

		}

	}
	else
	{
	//режим содания арта
		echo '<br>
		<br>
		<table align=center border=0 cellpadding=5><tr align=left valign=top><td>
		Выберите тип вещи: </td><td>
		<select name="arttype" id="arttype" >
		<option value="select">--------------------------------</option>
		<option value="11">Оружие:топоры</option>
		<option value="12">Оружие:дубины,булавы</option>
		<option value="13">Оружие:мечи</option>
		<option value="2">Сапоги</option>
		<option value="21">Перчатки</option>
		<option value="23">Тяжелая броня</option>
		<option value="24">Шлемы</option>
		<option value="3">Щиты</option>
		<option value="4">Cерьги</option>
		<option value="41">Ожерелья</option>
		    </select> </td></tr><tr align=left valign=top><td>Выберите название вещи: </td><td>
		    <select name="artproto" id="artproto">
		        <option class="select" value="0">--------------------------------</option> ';

			$get_user_alig=mysql_fetch_array(mysql_query("select  id,login,align, klan, level  from oldbk.users where id='{$_SESSION['uid']}'"));

		        if ($get_user_alig['klan']=='pal')
		        {
		        $add_align="nalign=6 or nalign=1 or ";
		        }
		        else if ($get_user_alig['align']>0)
		        {
		        $ali=(int)($get_user_alig['align']);
		        $add_align="nalign={$ali} or ";
		        }
		        else
		        {
		        $add_align="";
		        }

		        $add_SQL=" and  nlevel <='{$get_user_alig['level']}' ";

		$get_proto=mysql_query("SELECT * FROM oldbk.shop where (new_item>0 or (type = 3 and nlevel >= 7)) and artproto > 0 and  ({$add_align} nalign=0) ".$add_SQL." order by nlevel,cost");
	}


	echo '</select></td></tr></table>';

	echo '<script>
		var artrazdel = -1;
		var needdestroy = false;
		var firstrun = false;

		function sortbynlevel (a,b) {
			return a.nlevel-b.nlevel;
		}

		function MakeItems(selectedpr) {
			if (needdestroy) {
				$("#artproto").ddslick("destroy");
			}
			var ddData = new Array();
			artlist.forEach(function(ar, key) {
				if (artrazdel != ar[0]) return;

				var sel = false;
				if (selectedpr == key) sel = true;

				ddData.push({
					text: ar[2],
					value: key,
					imageSrc: ar[1],
					selected: sel,
					nlevel: ar[3]
				});
			});

			ddData.sort(sortbynlevel);

			needdestroy = true;
			$("#artproto").ddslick({
				width:270,
				height:300,
				data:ddData,
				onSelected: function(data) {
					if (firstrun) {
						request(0);
						firstrun = false;
					} else {
						request(data.selectedData.value);
					}
				}
			});
		}

		$("#arttype").change(function() {
			artrazdel = parseInt($( this ).val());
			MakeItems(-1);
		});
		var artlist = new Array();
	';

	if (isset($forceartrazdel)) echo 'artrazdel = '.$forceartrazdel.';';

	while ($row=mysql_fetch_assoc($get_proto))
	{
		echo 'artlist['.$row['id'].'] = new Array('.$row['razdel'].',"https://i.oldbk.com/i/classes/'.ClassToIco($row['nclass']).'","'.$row['name'].' ['.$row['nlevel'].']","'.$row['nlevel'].'");';
	}

	echo '</script>';


	if ($_SESSION['save_proto_memory'])
 	{
 	echo '
 	<script>
	for (var i = 0; i <= document.getElementById("arttype").options.length - 1; i++) {
	if (document.getElementById("arttype").options[i].value == "'.$_SESSION['save_proto_memory']['razdel'].'") {
	  document.getElementById("arttype").selectedIndex = i;
	  break;
	 }
	}

	artrazdel = '.$_SESSION['save_proto_memory']['razdel'].';
	firstrun = true;
	MakeItems('.$_SESSION['save_proto_memory']['id'].');
 	';
	} else {
		echo '<script>MakeItems(-1);';
	}

echo '</script><br><br><div id="idiv"></div>';
}


}

function mk_artid()
{
#$art_unick_id="1".mt_rand(10,99).date("m").date("d").mt_rand(1,9).date("s");
//ищем свободный ид в таблице шопа в нужном диапазоне
$get_free_id= mysql_fetch_assoc(mysql_query("select t1.id+1 as freeid from shop t1 where id>1100130858 and id<1991226255 and (not exists (select 1 from shop t2 where t2.id=t1.id+1)) and (not exists (select 1 from art_prototype t2 where t2.id=t1.id+1))  order by t1.id limit 1"));
$art_unick_id=$get_free_id['freeid'];
return $art_unick_id;
}

function mk_art_rec($row,$pay_type,$cost,$art_status,$art_type, $echeck = false) {
	global $EKR_TO_GOLD;

	$fp = fopen ("/www/kolock.txt","a"); //открытие
	if ($fp)
	{
	if (flock($fp, LOCK_EX))
	{
		$new_art_id=mk_artid();

	$add_veks_flag="";

	if ($echeck) $echeck = 1; else $echeck = 0;

				if ($art_type=='mkclanart')
					 {
					 $glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
				  	 if ($glava_test[id]>0)
				  	  {
						$owner=22125;
						$sowner=0;
						$arsenal_klan=$glava_test[short];
					 	$arsenal_owner=1;
					 	$repcost=0;
						$ecost=$cost;
				  	  }
				  	  else
				  	  {
				  	  return false;
				  	  }
					 }
				else if ($art_type=='mkpersonalart')
					{
					$owner=$_SESSION['uid'];
					$sowner=$_SESSION['uid'];
					$arsenal_klan='';
					$arsenal_owner=0;

						if ($pay_type=='rep')
							{
							$repcost=$cost;
							$ecost=0;
							$art_status=-1;
							}
						else if ($pay_type=='ekr')
							{
							$repcost=0;
							$ecost=$cost;
							}
						else if ($pay_type=='veks')
							{
							$repcost=$cost;
							$ecost=0;
							$art_status=-1;
							$add_veks_flag="  veks_flag=1, ";
							}
						else if ($pay_type=='gold') {
							$repcost=0;
							$ecost=$cost / $EKR_TO_GOLD;
						}

						else return false;

					}
				else return false;

	 $art_param=array();
	 if ($row['mark_sila']) {$art_param[]='gsila';}
	 if ($row['mark_lovk']) {$art_param[]='glovk';}
	 if ($row['mark_inta']) {$art_param[]='ginta';}
	 if ($row['mark_intel']) {$art_param[]='gintel';}
	 if ($row['mark_gmp']) {$art_param[]='gmp';}
	 if ($row['mark_krit']) {$art_param[]='mfkrit';}
	 if ($row['mark_akrit']) {$art_param[]='mfakrit';}
	 if ($row['mark_uvorot']) {$art_param[]='mfuvorot';}
	 if ($row['mark_auvorot']) {$art_param[]='mfauvorot';}

//echo "С:".$row[nalign];
$row[new_art_name]=trim($row[new_art_name]);
$row[new_art_name]=htmlspecialchars($row[new_art_name],ENT_COMPAT | ENT_HTML401,"cp1251");
$row[new_art_name] = str_ireplace("'", "&#39;", $row[new_art_name]);
$row[new_art_name] = str_ireplace("|", "&#0124;", $row[new_art_name]);
$row[new_art_name] = str_ireplace("`", "&#96;", $row[new_art_name]);
$row[new_art_name] = str_ireplace("’", "&#146;", $row[new_art_name]);
$row[new_art_name] = str_ireplace("'", "&rsquo;", $row[new_art_name]);


mysql_query("INSERT INTO `oldbk`.`art_prototype` SET
		`id`='{$new_art_id}',
		`name`='{$row[new_art_name]}',
		`duration`='{$row[duration]}',`maxdur`='{$row[maxdur]}',`cost`='{$row[cost]}',`owner`='{$owner}',
		`nlevel`='{$row[nlevel]}',`nsila`='{$row[nsila]}',`nlovk`='{$row[nlovk]}',`ninta`='{$row[ninta]}',`nvinos`='{$row[nvinos]}',`nintel`='{$row[nintel]}',
		`nmudra`='{$row[nmudra]}',`nnoj`='{$row[nnoj]}',`ntopor`='{$row[ntopor]}',`ndubina`='{$row[ndubina]}',`nmech`='{$row[nmech]}',
		`nalign`='{$row[nalign]}',`minu`='{$row[minu]}',`maxu`='{$row[maxu]}',
		`gsila`='{$row[gsila]}',`glovk`='{$row[glovk]}',`ginta`='{$row[ginta]}',
		`gintel`='{$row[gintel]}',`ghp`='{$row[ghp]}',
		`mfkrit`='{$row[mfkrit]}',`mfakrit`='{$row[mfakrit]}',`mfuvorot`='{$row[mfuvorot]}',`mfauvorot`='{$row[mfauvorot]}',
		`gnoj`='{$row[gnoj]}',`gtopor`='{$row[gtopor]}',`gdubina`='{$row[gdubina]}',`gmech`='{$row[gmech]}',
		`img`='{$row[new_art_img]}',`text`='',`dressed`=0,
		`bron1`='{$row[bron1]}',`bron2`='{$row[bron2]}',`bron3`='{$row[bron3]}',`bron4`='{$row[bron4]}',
		`dategoden`=0,`magic`=0,
		`type`='{$row[type]}',
		`present`='',`sharped`=0,
		`massa`='{$row[massa]}',
		`goden`=0,`needident`=0,
		`nfire`='{$row[nfire]}',`nwater`='{$row[nwater]}',`nair`='{$row[nair]}',`nearth`='{$row[nearth]}',`nlight`='{$row[nlight]}',`ngray`='{$row[ngray]}',
		`ndark`='{$row[ndark]}',`gfire`='{$row[gfire]}',`gwater`='{$row[gwater]}',`gair`='{$row[gair]}',`gearth`='{$row[gearth]}',`glight`='{$row[glight]}',`ggray`='{$row[ggra]}',`gdark`='{$row[gdark]}',
		`letter`='',`isrep`=1,`update`='',`setsale`=0,
		`prototype`='{$new_art_id}',
		`otdel`='{$row[razdel]}',`bs`=0,	`gmp`='{$row[gmp]}',
		`includemagic`=0,`includemagicdex`=0,`includemagicmax`=0,`includemagicname`='',`includemagicuses`=0,`includemagiccost`=0,`includemagicekrcost`=0,
		`gmeshok`=0,`tradesale`=0,`karman`=0,
		`stbonus`={$row[stbonus]},`upfree`=0,`ups`=5,
		`mfbonus`={$row[mfbonus]},`mffree`=0,
		`type3_updated`=1,`bs_owner`=0,`nsex`=0,
		`present_text`='',`add_time`=0,`labonly`=0,`labflag`=0,`prokat_idp`=0,`prokat_do`=0,
		`arsenal_klan`='{$arsenal_klan}',`arsenal_owner`='{$arsenal_owner}',
		`repcost`='{$repcost}',
		`up_level`='{$row[nlevel]}',
		`ecost`='{$ecost}',
		`group`=0,`ekr_up`='{$row[ekr_up]}',
		`unik`='{$row[unik]}',
		`add_pick`='',`pick_time`=0,
		`sowner`='{$sowner}', ".$add_veks_flag."
		`idcity`=0,`battle`= '{$echeck}',`t_id`=0,
		`ab_mf`='{$row[ab_mf]}',`ab_bron`='{$row[ab_bron]}',`ab_uron`='{$row[ab_uron]}',
		`art_status`='{$art_status}', `nclass`='{$row[nclass]}' ,
		`art_param` ='".implode(",",$art_param)."' ;");

	flock ($fp,LOCK_UN); //СНЯТИЕ БЛОКИРОВКИ
	fclose ($fp); //закрытие

							if (mysql_affected_rows()>0)
								{

									$proto_build=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.shop where id='{$row['id']}' "));
									mysql_query("INSERT INTO `oldbk`.`art_bonus` SET `itemid`='{$new_art_id}',`blevel`=0,`info`='',`art_proto`='{$proto_build['id']}',`art_proto_name`='{$proto_build['name']}',`art_proto_img`='{$proto_build['img']}';");

								// отправляяем телеграмму Арху
								/*
								$get_admin=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '8540'  ;"));
								if ($get_admin[id_city]==1) { $get_admin=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$get_admin[id]."'  ;")); }
								elseif ($get_admin[id_city]==2) { $get_admin=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$get_admin[id]."'  ;")); }
								if ($get_admin['odate'] > (time()-60) )
										{
										addchp('<font color=red>Внимание!</font> Новый Заказ на Артефакт в Коммерческом отделе! ','{[]}'.$get_admin['login'].'{[]}',$get_admin['room'],$get_admin['id_city']);
										} else {
										mysql_query("INSERT INTO oldbk.`telegraph` (`owner`,`date`,`text`) values ('".$get_admin['id']."','','<font color=red>Внимание!</font> Новый Заказ на Артефакт в Коммерческом отделе! ');");
										}
								*/
								return $new_art_id;

								}
								else
								{
								$log_sql="INSERT INTO `oldbk`.`art_prototype` SET
									`id`='{$new_art_id}',
									`name`='{$row[new_art_name]}',
									`duration`='{$row[duration]}',`maxdur`='{$row[maxdur]}',`cost`='{$row[cost]}',`owner`='{$owner}',
									`nlevel`='{$row[nlevel]}',`nsila`='{$row[nsila]}',`nlovk`='{$row[nlovk]}',`ninta`='{$row[ninta]}',`nvinos`='{$row[nvinos]}',`nintel`='{$row[nintel]}',
									`nmudra`='{$row[nmudra]}',`nnoj`='{$row[nnoj]}',`ntopor`='{$row[ntopor]}',`ndubina`='{$row[ndubina]}',`nmech`='{$row[nmech]}',
									`nalign`='{$row[nalign]}',`minu`='{$row[minu]}',`maxu`='{$row[maxu]}',
									`gsila`='{$row[gsila]}',`glovk`='{$row[glovk]}',`ginta`='{$row[ginta]}',
									`gintel`='{$row[gintel]}',`ghp`='{$row[ghp]}',
									`mfkrit`='{$row[mfkrit]}',`mfakrit`='{$row[mfakrit]}',`mfuvorot`='{$row[mfuvorot]}',`mfauvorot`='{$row[mfauvorot]}',
									`gnoj`='{$row[gnoj]}',`gtopor`='{$row[gtopor]}',`gdubina`='{$row[gdubina]}',`gmech`='{$row[gmech]}',
									`img`='{$row[new_art_img]}',`text`='',`dressed`=0,
									`bron1`='{$row[bron1]}',`bron2`='{$row[bron2]}',`bron3`='{$row[bron3]}',`bron4`='{$row[bron4]}',
									`dategoden`=0,`magic`=0,
									`type`='{$row[type]}',
									`present`='',`sharped`=0,
									`massa`='{$row[massa]}',
									`goden`=0,`needident`=0,
									`nfire`='{$row[nfire]}',`nwater`='{$row[nwater]}',`nair`='{$row[nair]}',`nearth`='{$row[nearth]}',`nlight`='{$row[nlight]}',`ngray`='{$row[ngray]}',
									`ndark`='{$row[ndark]}',`gfire`='{$row[gfire]}',`gwater`='{$row[gwater]}',`gair`='{$row[gair]}',`gearth`='{$row[gearth]}',`glight`='{$row[glight]}',`ggray`='{$row[ggra]}',`gdark`='{$row[gdark]}',
									`letter`='',`isrep`=1,`update`='',`setsale`=0,
									`prototype`='{$new_art_id}',
									`otdel`='{$row[razdel]}',`bs`=0,	`gmp`='{$row[gmp]}',
									`includemagic`=0,`includemagicdex`=0,`includemagicmax`=0,`includemagicname`='',`includemagicuses`=0,`includemagiccost`=0,`includemagicekrcost`=0,
									`gmeshok`=0,`tradesale`=0,`karman`=0,
									`stbonus`={$row[stbonus]},`upfree`=0,`ups`=5,
									`mfbonus`={$row[mfbonus]},`mffree`=0,
									`type3_updated`=1,`bs_owner`=0,`nsex`=0,
									`present_text`='',`add_time`=0,`labonly`=0,`labflag`=0,`prokat_idp`=0,`prokat_do`=0,
									`arsenal_klan`='{$arsenal_klan}',`arsenal_owner`='{$arsenal_owner}',
									`repcost`='{$repcost}',
									`up_level`='{$row[nlevel]}',
									`ecost`='{$ecost}',
									`group`=0,`ekr_up`='{$row[ekr_up]}',
									`unik`='{$row[unik]}',
									`add_pick`='',`pick_time`=0,
									`sowner`='{$sowner}', ".$add_veks_flag."
									`idcity`=0,`battle`= '{$echeck}',`t_id`=0,
									`ab_mf`='{$row[ab_mf]}',`ab_bron`='{$row[ab_bron]}',`ab_uron`='{$row[ab_uron]}',
									`art_status`='{$art_status}', `nclass`='{$row[nclass]}' ,
									`art_param` ='".implode(",",$art_param)."' ;";


								$log_text=date("d.m.y H:i:s",time()).":".$log_sql."\n".mysql_error()."\n";
								log_sql_tmp($log_text);
								return false;
								}
	}
	else
		{
		fclose ($fp); //закрытие
		$log_text=date("d.m.y H:i:s",time()).":ERROR MAKE lock \n";
		log_sql_tmp($log_text);
		}
	}
	else
	{
	$log_text=date("d.m.y H:i:s",time()).":ERROR OPEN lock \n";
	log_sql_tmp($log_text);
	}
return false;
}

function mk_pay_rep($prise,$echeck = false)
{

	$bdcity[0]='oldbk.';
	$bdcity[1]='avalon.';
	$bdcity[2]='angels.';
	$telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
	if ($telo_test[id_city]==1) { $telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$_SESSION['uid']."'  ;")); 	}
	elseif ($telo_test[id_city]==2) { $telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$_SESSION['uid']."'  ;")); 	}
	if ($telo_test[id]>0)
	{
	mysql_query("UPDATE {$bdcity[$telo_test[id_city]]}users SET repmoney=repmoney-{$prise} where id='".$_SESSION['uid']."' and id_city='".$telo_test[id_city]."' and repmoney>={$prise} ;");
	 if (mysql_affected_rows()>0)
		{
		$mk_art=mk_art_rec($_SESSION['save_proto_memory'],'rep',$prise,1,'mkpersonalart',$echeck);//=-1

		 if ( mk_bill($prise,'rep','mkpersonalart',$mk_art,0) and ($mk_art>0) )
		 	{
		 	//пишем в дело о списании реп-мани
		 			$rec['owner']=$telo_test[id];
					$rec['owner_login']=$telo_test[login];
					$rec['owner_balans_do']=$telo_test[money];
					$rec['owner_balans_posle']=$telo_test[money];
					$rec['owner_rep_do']=$telo_test['repmoney'];
					$rec['owner_rep_posle']=$telo_test['repmoney'] - $prise;
					$rec['target']=0;
					$rec['target_login']='артефакт.заказ.';
					$rec['type']=372;//оплата репутацией
					$rec['sum_kr']=0;
					$rec['sum_ekr']=0;
					$rec['sum_kom']=0;
					$rec['sum_rep']=$prise;
					$rec['item_id']='';
					$rec['item_name']=$_SESSION['save_proto_memory']['new_art_name'];
					$rec['item_count']=1;
					$rec['item_type']=$_SESSION['save_proto_memory']['type'];
					$rec['item_cost']=$_SESSION['save_proto_memory']['cost'];
					$rec['item_dur']=$_SESSION['save_proto_memory']['duration'];
					$rec['item_maxdur']=$_SESSION['save_proto_memory']['maxdur'];
					$rec['item_ups']=0;
					$rec['item_unic']=1;
					$rec['item_incmagic']='';
					$rec['add_info']='заказ №'.$mk_art;
					$rec['item_incmagic_count']='';
					add_to_new_delo($rec);

		 	return true;
		 	}
		 	else
		 	{
		 	//откат
			mysql_query("UPDATE {$bdcity[$telo_test[id_city]]}users SET repmoney=repmoney+{$prise} where id='".$_SESSION['uid']."' and id_city='".$telo_test[id_city]."' ;");
			return false;
		 	}

		}
		else
		{
		 	return false;
		}
	}
	else {
		 return false;
		 }


}


function mk_pay_veks($prise,$echeck = false)
{

$bdcity[0]='oldbk.';
$bdcity[1]='avalon.';
$bdcity[2]='angels.';
	$telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
	if ($telo_test[id_city]==1) { $telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$_SESSION['uid']."'  ;")); 	}
	elseif ($telo_test[id_city]==2) { $telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$_SESSION['uid']."'  ;")); 	}
	if ($telo_test[id]>0)
	{
	//удаляем 1шт. векселя на персе
	mysql_query("DELETE from oldbk.inventory where owner='{$telo_test[id]}' and prototype=3005000 LIMIT 1;");
	 if (mysql_affected_rows()>0)
		{
		$mk_art=mk_art_rec($_SESSION['save_proto_memory'],'veks',$prise,1,'mkpersonalart',$echeck);//-1

		 if ( mk_bill($prise,'veks','mkpersonalart',$mk_art,0) and ($mk_art>0) )
		 	{
		 	//пишем в дело о оплате
		 			$rec['owner']=$telo_test[id];
					$rec['owner_login']=$telo_test[login];
					$rec['owner_balans_do']=$telo_test[money];
					$rec['owner_balans_posle']=$telo_test[money];
					$rec['owner_rep_do']=$telo_test['repmoney'];
					$rec['owner_rep_posle']=$telo_test['repmoney'];
					$rec['target']=0;
					$rec['target_login']='артефакт.заказ.';
					$rec['type']=376;//оплата репутацией -векселем
					$rec['sum_kr']=0;
					$rec['sum_ekr']=0;
					$rec['sum_kom']=0;
					$rec['sum_rep']=$prise;
					$rec['item_id']='';
					$rec['item_name']=$_SESSION['save_proto_memory']['new_art_name'];
					$rec['item_count']=1;
					$rec['item_type']=$_SESSION['save_proto_memory']['type'];
					$rec['item_cost']=$_SESSION['save_proto_memory']['cost'];
					$rec['item_dur']=$_SESSION['save_proto_memory']['duration'];
					$rec['item_maxdur']=$_SESSION['save_proto_memory']['maxdur'];
					$rec['item_ups']=0;
					$rec['item_unic']=1;
					$rec['item_incmagic']='';
					$rec['add_info']='заказ №'.$mk_art;
					$rec['item_incmagic_count']='';
					add_to_new_delo($rec);

		 	return true;
		 	}
		 	else
		 	{
			return false;
		 	}

		}
		else
		{
		 	return false;
		}
	}
	else {
		 return false;
		 }


}

function mk_clan_kazna_pay($prise,$clan_id,$clan_name)
{
$telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
if ($telo_test[id]>0)
 {
	mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr-{$prise}  WHERE `clan_id` = '{$clan_id}' and ekr>={$prise} ;");
	if (mysql_affected_rows()>0)
  	{
	  	$mk_art=mk_art_rec($_SESSION['save_proto_memory'],'ekr',$prise,1,'mkclanart');
		if ( mk_bill($prise,'ekr','mkclanart',$mk_art,1) and ($mk_art>0) )
		{
  		// записать в дело казны
        	$txt="\"".$telo_test['login']."\", заплатил из клан казны {$clan_name}, ".$prise." екр. за покупку 5 ед. кланового артефакта \"{$_SESSION['save_proto_memory']['new_art_name']}\". Счет №{$mk_art}.";
           	mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)   VALUES  ('2','2','{$clan_id}','{$telo_test[id]}','".$txt."','".time()."');");
		return true;
           	}
           	else
           	{
           	//откат
       		mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr+{$prise}  WHERE `clan_id` = '{$clan_id}' ;");
           	return false;
           	}
	}
	else
	{
	return false;
	}
 }
 else
 {
 return false;
 }

}

function mk_pay_bill($prise,$art_type,$isgold = 0) {
	// выписка чека
	if ($art_type=='mkclanart') {
   		//выписка на клан
		if ($isgold) return mk_art_rec($_SESSION['save_proto_memory'],'gold',$prise,1,'mkclanart');

   		$mk_art=mk_art_rec($_SESSION['save_proto_memory'],'ekr',$prise,0,'mkclanart');
   		if ( mk_bill($prise,'ekr','mkclanart',$mk_art,0) and ($mk_art>0)) {
   			return true;
   		}
   		return false;
   	} else {
   		// личный
		if ($isgold) return mk_art_rec($_SESSION['save_proto_memory'],'gold',$prise,1,'mkpersonalart');

   		$mk_art=mk_art_rec($_SESSION['save_proto_memory'],'ekr',$prise,0,'mkpersonalart');
   		if (mk_bill($prise,'ekr','mkpersonalart',$mk_art,0) and ($mk_art>0)) {
   			return true;
   		}
   		return false;
   	}
}


function mk_bill($cost,$pay_type,$art_type,$mk_art_id,$from_kazna)
{
if ($mk_art_id)
{
if ($art_type=='mkclanart')
	 {
	 $glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
  	 if ($glava_test[id]>0)
  	  {
  	  $str_type=' кланового артефакта для клана \"'.$glava_test[short].'\" ';
	   if ($pay_type=='ekr')
			{
			$str_pay=$cost.' екр. ';
			 if ($from_kazna==1) { $str_pay.='- <b>Оплачено.</b>';}
			}
  	  }
  	  else
  	  {
  	  return false;
  	  }
	 }
else if ($art_type=='mkpersonalart')
	{
	$telo_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
	 if ($telo_test[id]>0)
	  {
  	  $str_type=' личного артефакта для персонажа \"'.$telo_test[login].'\"';

		if ($pay_type=='rep')
			{
			$str_pay=$cost.' репутации. - <b>Оплачено.</b> ';
			}
		else if ($pay_type=='ekr')
			{
			$str_pay=$cost.' екр. ';
			}
		else if ($pay_type=='veks')
			{
			$str_pay=$cost.' репутации. - <b>Оплачено векселем.</b> ';
			}
		else {  return false; }
	  }
	  else {  return false; }

	}

mysql_query("INSERT INTO oldbk.`inventory` (`owner`,`name`,`type`,`massa`,`cost`,`img`,`letter`,`maxdur`,`isrep`,`present`)
	VALUES('{$_SESSION['uid']}','Счет на оплату артефакта','50',0,0,'paper100.gif','Счет на оплату {$str_type}:<br>\n Сумма:{$str_pay} <br>\n Номер счета:<b>{$mk_art_id}</b> ',1,0,'Коммерческий отдел') ;");

if (mysql_affected_rows()>0)
	{
	return true;
	}
	else
	{
	return false;
	}
  }
return false;
}

function add_to_new_delo($rec)
{
		$q = mysql_query("INSERT INTO `oldbk`.`new_delo` SET `owner`='{$rec['owner']}',
						`owner_login`='{$rec['owner_login']}',
						`owner_balans_do`='{$rec['owner_balans_do']}',
						`owner_balans_posle`='{$rec['owner_balans_posle']}',
						`owner_rep_do`='{$rec['owner_rep_do']}',
						`owner_rep_posle`='{$rec['owner_rep_posle']}',
						`target`='{$rec['target']}',
						`target_login`='{$rec['target_login']}',
						`type`='{$rec['type']}',
						`sdate`='".time()."',
						`sum_kr`='{$rec['sum_kr']}',
						`sum_ekr`='{$rec['sum_ekr']}',
						`sum_kom`='{$rec['sum_kom']}',
						`sum_rep`='{$rec['sum_rep']}',
						`item_id`='{$rec['item_id']}',
						`aitem_id`='{$rec['aitem_id']}',
						`add_info`='{$rec['add_info']}',
						`item_name`='{$rec['item_name']}',
						`item_count`='{$rec['item_count']}',
						`item_type`='{$rec['item_type']}',
						`item_cost`='{$rec['item_cost']}',
						`item_dur`='{$rec['item_dur']}',
						`item_maxdur`='{$rec['item_maxdur']}',
						`item_ups`='{$rec['item_ups']}',
						`item_unic`='{$rec['item_unic']}',
						`item_incmagic_id`='{$rec['item_incmagic_id']}',
                    	`item_ecost`='{$rec['item_ecost']}',
                    	`item_sowner`='{$rec['item_sowner']}',
						`item_proto`='{$rec['item_proto']}',
						`item_incmagic`='{$rec['item_incmagic']}',
						`item_incmagic_count`='{$rec['item_incmagic_count']}',
						`item_arsenal`='{$rec['item_arsenal']}',
						`battle`='{$rec['battle']}',
						`bank_id`='{$rec['bank_id']}' ;");
		if ($q === FALSE) return false;

	        $d_id=mysql_insert_id();
		if(($rec['item_type']>0 && $rec['item_type']<12 || $rec['item_type']==28 || $rec['item_type']==27) && $rec['type']!=32 && $rec['type']!=33)
		{
			$it=explode(',',$rec['item_id']);
			$sql="INSERT INTO `oldbk`.`new_delo_it_index` (`item_id`,`delo_id`) VALUES ";
            for($j=0;$j<count($it);$j++)
            {
            	$sql.="('".trim($it[$j])."','".$d_id."'),";
            }
            $sql=substr($sql,0,-1).";";
            mysql_query($sql);
	}
	return true;
}



function ShowAitAdmin($row,$buttons)
{
//распаковка параметров
$art_param=explode(',',$row[art_param]);

///отрисовка шмотки
echo "<TR >
		<td align=center width=150 valign=top>";

			if (strpos($row[img], 'art_temp') !== false)
				{
				echo "<img src=https://i.oldbk.com/i/arts/$row[img]>";
				}
				else
				{
				echo "<img src=upload/$row[img]>";
				}

		echo "</td>
		<TD align=left width=550 ".($ch==1?((($row['maxdur']-2)<=$row['duration']  && $row['duration'] > 2)?" style='background-image:url(https://i.oldbk.com/i/blink.gif);' ":""):"")." >";

		if ($row['nalign']==1) {$row['nalign']='1.5';}


			if ($row['art_moder']!='')
			{
			echo "<b>Утвердил: ".$row['art_moder']."</b> Дата:".$row['art_mod_date']."<br>";
			}

			if ($row['del_comm']!='')
			{
			echo "<font color=red><b>Комментарий удаления: </b>".$row['del_comm']."</font><br>";
			}

		echo "<b>".$row['name']."</b>";



		echo "<img src=https://i.oldbk.com/i/align_{$row['nalign']}.gif> (Масса: {$row['massa']})".(($row['present'])?' <IMG SRC="https://i.oldbk.com/i/podarok.gif" WIDTH="16" HEIGHT="18" BORDER=0 TITLE="Этот предмет вам подарил '.$row['present'].'. Вы не сможете передать этот предмет кому-либо еще." ALT="Этот предмет вам подарил '.$row['present'].'. Вы не сможете передать этот предмет кому-либо еще.">':"")."<BR>";

		echo "<BR> <b>Гос.Цена: {$row[cost]} кр. </b><br>";
		if ($row[ecost]>0) { echo "<b>Стоимость: {$row[ecost]} екр.</b><br>"; }
		if ($row[repcost]>0) {
						 echo "<b>Стоимость: {$row[repcost]} реп.</b><br>";
						 }
						 		if ($row[veks_flag]==5)
						 		{
								 echo "<b>Обмен старого храмового арта (оплата екр)</b><br>";
						 		}
						 		else
						 		if ($row[veks_flag]==4 || $row[veks_flag]==9)
						 		{
								 echo "<b>Обмен старого личного арта (оплата екр)</b><br>";
						 		}
						 		else
						 		if ($row[veks_flag]==3)
						 		{
								 echo "<b>Обмен старого храмового арта</b><br>";
						 		}
						 		elseif ($row[veks_flag]==2)
						 		{
								 echo "<b>Обмен старого личного арта</b><br>";
						 		}
						 		elseif ($row[veks_flag]>0)
						 		{
								 echo "<b>Оплата векселем</b><br>";
						 		}
		if ($row[arsenal_klan]!='') { echo "<b>Клановый артефакт: <img src=https://i.oldbk.com/i/klan/{$row[arsenal_klan]}.gif>$row[arsenal_klan]</b><br>"; }


		if ($row[owner]==22125)
		{
		$art_telo=mysql_fetch_assoc(mysql_query("select * from oldbk.users where id=(select glava from oldbk.clans where short='{$row[arsenal_klan]}');"));
		}
		else
		{
		$art_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$row[owner]."'  ;"));
		}
		echo "Чар: <b>{$art_telo[login]}</b><a href=http://capitalcity.oldbk.com/inf.php?{$art_telo[id]} target=_blank><IMG SRC=https://i.oldbk.com/i/inf.gif WIDTH=12 HEIGHT=11></a>";
		echo "<br>";
		echo "Дата заказа:<b>$row[art_zakdate]</b>";
		echo "<br>";

		echo "<BR>Долговечность : {$row['duration']}/{$row['maxdur']}<BR>";
		echo (($row['ups']>0)?"Подогнано:<b>{$row['ups']} раз</b><BR>":"");
		echo (($row['stbonus']>0)?"Возможных увеличений: <b>{$row['stbonus']}</b><BR>":"");
		echo (($row['mfbonus']>0)?"Возможных увеличений мф: <b>{$row['mfbonus']}</b><BR>":"");

		echo (($magic['chanse'])?"Вероятность срабатывания: ".$magic['chanse']."%<BR>":"")."
		".(($magic['time'])?"Продолжительность действия магии: ".$magic['time']." мин.<BR>":"")."
		".(($row['goden'])?"Срок годности: {$row['goden']} дн. <BR>":"")."
		".(($row['nsex']==1)?"• Пол: <b>Женский</b><br>":"")."
		".(($row['nsex']==2)?"• Пол: <b>Мужской</b><br>":"")."
		".(($row['nsila'] OR $row['nlovk'] OR $row['ninta'] OR $row['nvinos'] OR $row['nlevel'] OR $row['nintel'] OR $row['nmudra'] OR $row['nnoj'] OR $row['ntopor'] OR $row['ndubina'] OR $row['nmech'] OR $row['nfire'] OR $row['nwater'] OR $row['nair'] OR $row['nearth'] OR $row['nearth'] OR $row['nlight'] OR $row['ngray'] OR $row['ndark'])?"Требуется минимальное:<BR>":"")."
		".(($row['nsila']>0)?"• Сила: {$row['nsila']}</font><BR>":"")."
		".(($row['nlovk']>0)?"• Ловкость: {$row['nlovk']}</font><BR>":"")."
		".(($row['ninta']>0)?"• Интуиция: {$row['ninta']}</font><BR>":"")."
		".(($row['nvinos']>0)?"• Выносливость: {$row['nvinos']}</font><BR>":"")."
		".(($row['nlevel']>0)?"• Уровень: {$row['nlevel']}</font><BR>":"")."
		".(($row['nintel']>0)?"• Интеллект: {$row['nintel']}</font><BR>":"")."
		".(($row['nmudra']>0)?"• Мудрость: {$row['nmudra']}</font><BR>":"")."
		".(($row['nnoj']>0)?"• Мастерство владения ножами и кастетами: {$row['nnoj']}</font><BR>":"")."
		".(($row['ntopor']>0)?"• Мастерство владения топорами и секирами: {$row['ntopor']}</font><BR>":"")."
		".(($row['ndubina']>0)?"• Мастерство владения дубинами и булавами: {$row['ndubina']}</font><BR>":"")."
		".(($row['nmech']>0)?"• Мастерство владения мечами: {$row['nmech']}</font><BR>":"")."
		".(($row['nfire']>0)?"• Мастерство владения стихией Огня: {$row['nfire']}</font><BR>":"")."
		".(($row['nwater']>0)?"• Мастерство владения стихией Воды: {$row['nwater']}</font><BR>":"")."
		".(($row['nair']>0)?"• Мастерство владения стихией Воздуха: {$row['nair']}</font><BR>":"")."
		".(($row['nearth']>0)?"• Мастерство владения стихией Земли: {$row['nearth']}</font><BR>":"")."
		".(($row['nlight']>0)?"• Мастерство владения магией Света: {$row['nlight']}</font><BR>":"")."
		".(($row['ngray']>0)?"• Мастерство владения серой магией: {$row['ngray']}</font><BR>":"")."
		".(($row['ndark']>0)?"• Мастерство владения магией Тьмы: {$row['ndark']}</font><BR>":"")."
		".(($row['gmeshok'] OR $row['gsila'] OR $row['mfkrit'] OR $row['mfakrit']  OR $row['mfuvorot'] OR $row['mfauvorot']  OR $row['glovk'] OR $row['ghp'] OR $row['ginta'] OR $row['gintel'] OR $row['gnoj'] OR $row['gtopor'] OR $row['gdubina'] OR $row['gmech'] OR $row['gfire'] OR $row['gwater'] OR $row['gair'] OR $row['gearth'] OR $row['gearth'] OR $row['glight'] OR $row['ggray'] OR $row['gdark'] OR $row['minu'] OR $row['maxu'] OR $row['bron1'] OR $row['bron2'] OR $row['bron3'] OR $row['bron4'])?"Действует на:<BR>":"")."
		".(($row['minu'])?"• Минимальное наносимое повреждение: ".($row[type]==3?"":"+")."{$row['minu']} ".($artun==1?"<font color=red> Добавлено артовых (+{$row[artminu]})</font>":"")."<BR>":"")."
		".(($row['maxu'])?"• Максимальное наносимое повреждение: ".($row[type]==3?"":"+")."{$row['maxu']} ".($artun==1?"<font color=red> Добавлено артовых (+{$row[artmaxu]})</font>":"")."<BR>":"");

	echo '<table  border="0" cellspacing="0" cellpadding="0">';

	      echo ((($row['gsila']) or in_array('gsila', $art_param) )?"<tr><td>• Сила: ".(($row['gsila']>0 )?"+":"")."{$row['gsila']}</td><td>":"")."
		".((($row['gsila'])  or in_array('gsila', $art_param) )?"".(in_array('gsila', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['glovk'])  or in_array('glovk', $art_param))?"<tr><td>• Ловкость: ".(($row['glovk']>0)?"+":"")."{$row['glovk']}</td><td>":"")."
		".((($row['glovk'])  or in_array('glovk', $art_param) )?"".(in_array('glovk', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['ginta'])  or in_array('ginta', $art_param) )?"<tr><td>• Интуиция: ".(($row['ginta']>0)?"+":"")."{$row['ginta']}</td><td>":"")."
		".((($row['ginta'])  or in_array('ginta', $art_param) )?"".(in_array('ginta', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['gintel']) or in_array('gintel', $art_param) )?"<tr><td>• Интеллект: ".(($row['gintel']>0)?"+":"")."{$row['gintel']}</td><td>":"")."
		".((($row['gintel']) or in_array('gintel', $art_param) )?"".(in_array('gintel', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['gmp']) or in_array('gmp', $art_param) )?"<tr><td>• Мудрость: ".(($row['gmp']>0)?"+":"")."{$row['gmp']}</td><td>":"")."
		".((($row['gmp']) or in_array('gmp', $art_param) )?"".(in_array('gmp', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"");
	echo "</table>";

	echo ((($row['ghp']))?"• Уровень жизни: +{$row['ghp']} <BR>":"");


	echo '<table  border="0" cellspacing="0" cellpadding="0">';
		echo ((($row['mfkrit']) or in_array('mfkrit', $art_param) )?"<tr><td>• Мф. критических ударов: ".(($row['mfkrit']>0)?"+":"")."{$row['mfkrit']}%</td><td>":"")."
		".((($row['mfkrit']) or in_array('mfkrit', $art_param) )?"".(in_array('mfkrit', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['mfakrit']) or in_array('mfakrit', $art_param) )?"<tr><td>• Мф. против крит. ударов: ".(($row['mfakrit']>0)?"+":"")."{$row['mfakrit']}%</td><td>":"")."
		".((($row['mfakrit']) or in_array('mfakrit', $art_param) )?"".(in_array('mfakrit', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['mfuvorot']) or in_array('mfuvorot', $art_param) )?"<tr><td>• Мф. увертливости: ".(($row['mfuvorot']>0)?"+":"")."{$row['mfuvorot']}%</td><td>":"")."
		".((($row['mfuvorot']) or in_array('mfuvorot', $art_param) )?"".(in_array('mfuvorot', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"")."
		".((($row['mfauvorot']) or in_array('mfauvorot', $art_param) )?"<tr><td>• Мф. против увертлив.: ".(($row['mfauvorot']>0)?"+":"")."{$row['mfauvorot']}%</td><td>":"")."
		".((($row['mfauvorot']) or in_array('mfauvorot', $art_param) )?"".(in_array('mfauvorot', $art_param)?"&nbsp;<font color=red><small>Помечено для распределения</small></font> ":"")."</td></tr>":"");

	echo "</table>";


echo (($row['gnoj'])?"• Мастерство владения ножами и кастетами: +{$row['gnoj']}<BR>":"")."
		".(($row['gtopor'])?"• Мастерство владения топорами и секирами: +{$row['gtopor']}<BR>":"")."
		".(($row['gdubina'])?"• Мастерство владения дубинами и булавами: +{$row['gdubina']}<BR>":"")."
		".(($row['gmech'])?"• Мастерство владения мечами: +{$row['gmech']}<BR>":"")."
		".(($row['gfire'])?"• Мастерство владения стихией Огня: +{$row['gfire']}<BR>":"")."
		".(($row['gwater'])?"• Мастерство владения стихией Воды: +{$row['gwater']}<BR>":"")."
		".(($row['gair'])?"• Мастерство владения стихией Воздуха: +{$row['gair']}<BR>":"")."
		".(($row['gearth'])?"• Мастерство владения стихией Земли: +{$row['gearth']}<BR>":"")."
		".(($row['glight'])?"• Мастерство владения магией Света: +{$row['glight']}<BR>":"")."
		".(($row['ggray'])?"• Мастерство владения серой магией: +{$row['ggray']}<BR>":"")."
		".(($row['gdark'])?"• Мастерство владения магией Тьмы: +{$row['gdark']}<BR>":"")."
		".(($row['bron1'])?"• Броня головы: {$row['bron1']} ".($artun==1?"<font color=red> Добавлено артовых (+{$row[artbron1]})</font>":"")." <BR>":"")."
		".(($row['bron2'])?"• Броня корпуса: {$row['bron2']} ".($artun==1?"<font color=red> Добавлено артовых (+{$row[artbron2]})</font>":"")."<BR>":"")."
		".(($row['bron3'])?"• Броня пояса: {$row['bron3']} ".($artun==1?"<font color=red> Добавлено артовых (+{$row[artbron3]})</font>":"")."<BR>":"")."
		".(($row['bron4'])?"• Броня ног: {$row['bron4']} ".($artun==1?"<font color=red> Добавлено артовых (+{$row[artbron4]})</font>":"")."<BR>":"")."
		".(($row['gmeshok'])?"• Увеличивает рюкзак: +{$row['gmeshok']}<BR>":"")."
		".(($row['letter'])?"Количество символов: ".strlen($row['letter'])."</div>":"")."
		".(($row['present'])?"<br>Подарок от: <b>".$row['present']."</b><br>":"")."
		".(($row['letter'])?"На бумаге записан текст:<div style='background-color:FAF0E6;'> ".$row['letter']."</div>":"")."
		".(($row['prokat_idp']>0)?"Осталось:".floor(($row['prokat_do']-time())/60/60)." ч. ".round((($row['prokat_do']-time())/60)-(floor(($row['prokat_do']-time())/3600)*60))." мин.<br>":"")."
		".(($magic['name'] && $row['type'] != 50)?"<font color=maroon>Наложены заклятия:</font> ".$magic['name']."<BR>":"")."
		".(($magic['name'] && $row['type'] == 50)?"<font color=maroon>Свойства:</font> ".$magic['name']."<BR>":"")."
		".(($row['text'])?"На ручке выгравирована надпись:<center>".$row['text']."</center><BR>":"")."
		".(($row['present_text'])?"На подарке написан текст:<br />".$row['present_text']."<BR>":"")."
		".(($incmagic['max'])?"	Встроено заклятие <img src=\"https://i.oldbk.com/i/magic/".$incmagic['img']."\" title=\"".$incmagic['name']."\"> ".$incmagic['cur']." шт.	<BR> "."Требуемый уровень: ".$incmagic['nlevel']." <BR> ":"")."
		".(($incmagic['max'])? "К-во перезарядок: ".$incmagic['uses']."<br/>" : "")."
		".(($row['labonly']==1)?"<small><font color=maroon>Предмет пропадет после выхода из Лабиринта</font></small><BR>":"")."
		".((!$row['isrep'])?"<small><font color=maroon>Предмет не подлежит ремонту</font></small><BR>":"");

if ($row[type]==27)
			{
			echo "Особенности:<br>• может одеваться на броню<br>";
			}
			elseif ($row[type]==28)
			{
			echo "Особенности:<br>• может одеваться под броню<br>";
			}

		if  ( ($row[ab_mf]>0) or ($row[ab_bron]>0) or ($row[ab_uron]>0))
		   {
		    echo "Усиление:<br>";
		     if ($row[ab_mf]>0) echo "• максимального мф.:+{$row[ab_mf]}%<br>";
		     if ($row[ab_bron]>0) echo "• брони:+{$row[ab_bron]}%<br>";
		     if ($row[ab_uron]>0) echo "• урона:+{$row[ab_uron]}%<br>";
		   }

		if($row[unik]==1)
		{
			echo "<br><font color=red><small><b>Вещь с уникальной модификацией.</b></small></font>";
		}
		echo "<br><br><br><b>Счет № {$row[id]}</b><br>";
		if ($row['battle'] == 1) {
			echo '<br><font color=green><b>Экспресс проверка!!!</b>';
			if ($row['express_date'] !='' )
				{
				//$PhpDate = strtotime($row['express_date']);
				//$FormattedPhpDate = date('M d, Y', $PhpDate );
				echo  ' ('.$row['express_date'].") ";
				}

			echo '</font><br><br>';
		}

		if ($buttons==1) { echo "<br><br><br><a href=?act=look_art_mod&yes_id={$row[id]}>Установить</a> |  <a href=?act=look_art_mod&no_id={$row[id]}>Отказать</a> <br>"; }
		if ($buttons==2)
			{
			echo "<br><br><br>";
			if ($row[art_mess]==0) { echo "<a href=?act=look_art_prep&yes_id={$row[id]}>Одобрить</a> |  "; }
			if ($row[art_mess]==1) { echo "<b>одобрено</b> |  "; }
			echo "<a href=?act=look_art_prep&no_id={$row[id]}>Отказать</a> <br>";
			}
		if ($buttons==4)
			{
			echo "<br><br><br>";
			if ($row[art_mess]==0) { echo "<a href=?act=look_art_prep_mod&yes_id={$row[id]}>Одобрить</a> |  "; }
			if ($row[art_mess]==1) { echo "<b>одобрено</b> |  "; }
			echo "<a href=?act=look_art_prep_mod&no_id={$row[id]}>Отказать</a> <br>";
			}


		echo "
		</td></TR>";




}

function ShowServ()
	{
	global $PRICE, $user, $ny_events, $start_volna, $end_volna,$EKR_TO_GOLD;
	$menu=(int)($_GET['menu']);


	if ((time()>$ny_events['nghaosstart']) and (time()<$ny_events['nghaosend'])) {
		$PRICE[221][cost] = 0;
	}

	if ((time()>$ny_events['hbhaosstart']) and (time()<$ny_events['hbhaosend'])) {
		$PRICE[221][cost] = 0;
	}

	if ((time()>$start_volna) and (time()<$end_volna)) {
		$PRICE[221][cost] = 0;
	}


	//чистим данные если меню поменялось
	if ($_SESSION[select_menu]!=$menu)
		{
	 	unset($_SESSION['new_serv_img']);
	 	unset($_SESSION['new_serv_img_size']);
	 	unset($_SESSION[select_present]);
		}

$print_form=1;

	if ($PRICE[$menu][desc]!='')
		{
		$_SESSION[select_menu]=$menu;
		$_SESSION[select_array]=$PRICE[$menu];

		//описания
		if (  ($menu==5) OR ($menu==6) OR ($menu==11) OR ($menu==83))
		{
		ShowPObraz(false);
		}
		elseif  (  (($menu>=21) and ($menu<=35)) OR ($menu==17) OR ($menu==600) OR ($menu==601) OR ($menu==15) OR ($menu==18) OR (($menu>=36) and ($menu<=50)) )
		{
		PersImgs(false);
		}
		elseif (  ($menu==1) OR ($menu==2) OR ($menu==13) )
		{
		PersPres(false);
		}
		elseif  (  (($menu>=7) and ($menu<=10)) OR ($menu==81) OR ($menu==82))
		{
		KlanObraz(false);
		}
		elseif  (  (($menu>=51) and ($menu<=65)) OR ($menu==19) OR ($menu==20) OR ($menu==602) OR ($menu==603) OR ($menu==16) OR (($menu>=66) and ($menu<=80)) )
		{
		ClanImgs(false);
		}
		elseif (  ($menu==3) OR ($menu==4) OR ($menu==14) )
		{
		ClanPres(false);
		}
		elseif (  ($menu==90)  )
		{
		PersSmile(false);
		}
		elseif (  ($menu==91)  )
		{
			ClanSmile(false);
		}
		elseif (  ($menu >=500 && $menu <= 503)  )
		{
			MarServ(false);
		}
		elseif (  ($menu ==613 || $menu == 614)  )
		{
			PersARTSImgs(false);
		}


		echo "<center><b style=\"color:#800000\">Заказ услуги: ".$PRICE[$menu][desc]."</b></center>";
		echo "<br><br>";

		if ( ($PRICE[$menu][present]==true) and (!($_SESSION[select_present])) )
		{
		//форма выбора кому ставится или себе
		$form_target=1;
			if ($_POST[traget])
				{
				//ищим кому ставить потом будем
				 if ($_POST[traget]==$_SESSION['uid'])
				 	{
				 	//ставим картинку себе
					$_SESSION[select_present]=$_POST[traget];
					$form_target=0;
					$print_form=1;
					}
					else
					{
					//ищим кому ставить
					$get_test_target=mysql_fetch_assoc(mysql_query("select * from oldbk.users where login='".mysql_real_escape_string($_POST[traget])."';"));
					if ($get_test_target[id] > 0)
						{
						$_SESSION[select_present]=$get_test_target[id];
						$form_target=0;
						$print_form=1;
						}
						else
						{
						echo "<font color=red>Такой персонаж не найден!</font>";
						$form_target=1;
						$print_form=0;
						}
					}
				}


			if ($form_target==1)
				{
				$print_form=0;
				echo "<center><b>Выберите, для кого будет установлено изображение:<br><br><table align=center><tr><td>";
				echo "<form method=post><center><input type=hidden name=traget value='{$_SESSION['uid']}'><input type=submit value=' Установка изображения для себя ' class=\"button2\" ></form></center> <br><br><center>или</center><br><br>";
				echo "<form method=post><b>Впишите ник: </b> <input type=text name=traget > <br><br> <input type=submit value=' Установка изображения для этого персонажа ' class=\"button2\" ></form><br><br>";
				echo "</td><tr></table></center>";
				}
		}
		else
		if ($_GET[next])
			{

				//дополнительная проверка параметра для замены
				if (($menu==11)OR($menu==83))
				{
				$param=(int)($_GET[param]);
				 if ($param>0)
				 	{
					$get_sh=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.users_shadows  where owner='{$_SESSION['uid']}' and type=2 and id='{$param}' ;"));
					 if ($get_sh[id]!=$param)
					 	{
 						$error_img_ch='Изображение для замены не найдено!';
					 	}
					}
					else
					{
					$error_img_ch='Выберите изображение для замены!';
					}
				}
				else if ($menu==12 || $menu == 612)
				{
				$param=(int)($_GET[param]);
				 $glava_test_clear=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
				 if ($glava_test_clear[id]>0)
				  	{
				  	 $get_sh=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.users_shadows  where klan='{$glava_test_clear[id]}' and type=1 and id='{$param}' ;"));
					  	 if ($get_sh[id]!=$param)
						 	{
 							$error_img_ch='Изображение для замены не найдено!';
						 	}
				  	}
				  	else
				  	{
					$error_img_ch='Ошибка!';
				  	}
				}
				else if ($menu==13)
				{
				$param=(int)($_GET[param]);
				$get_sh=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.eshop  where owner='{$_SESSION['uid']}' and type=200 and razdel=72 and id='{$param}'  ;"));
					if (!($get_sh[id]>0))
					{
					$error_img_ch='Изображение для замены не найдено!';
					}
				}
				else if ($menu==14)
				{
				$param=(int)($_GET[param]);
				$glava_test_clear=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
				  	if ($glava_test_clear[id]>0)
				 	{
					  $get_sh=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.eshop  where klan='{$glava_test_clear[short]}' and type=200 and razdel=72 and id='{$param}'  ;"));
						if (!($get_sh[id]>0))
						{
						$error_img_ch='Изображение для замены не найдено!';
						}
					}
					else
					{
					$error_img_ch='Ошибка!';
					}

				}
				else if ($menu==15 || $menu==600 || $menu==601)
				{
				$param=(int)($_GET[param]);
				$test_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
				  	 if ($test_telo[id]>0)
				  	 {
							$addsql = "";
							if ($menu == 600) $addsql = " and otdel != 42 ";
							if ($menu == 601) $addsql = " and otdel = 42 ";


				  	 		if ($test_telo[klan]!='')
				  	 		{
				  	 		$get_klan=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `short` = '".$test_telo[klan]."'  ;"));
			  	 			$get_sh=mysql_fetch_array(mysql_query("SELECT * FROM gellery where owner='{$test_telo[id]}' and id='{$param}' and otdel != 99 and img not in (select img from gellery_prot where klan_owner='{$get_klan[id]}') ".$addsql));
				  	 		}
				  	 		else
				  	 		{
							$get_sh=mysql_fetch_array(mysql_query("SELECT * FROM gellery where owner='{$test_telo[id]}' and id='{$param}'  and otdel != 99 ".$addsql));
				  	 		}

						if (!($get_sh[id]>0))
						{
						$error_img_ch='Изображение для замены не найдено!';
						}

					}
					else
					{
					$error_img_ch='Ошибка!';
					}
				}
				else if ($menu==613 || $menu==614)
				{
				$param=(int)($_GET[param]);
				$test_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
				  	 if ($test_telo[id]>0)
				  	 {

					$get_sh=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.inventory WHERE owner='{$test_telo[id]}'  AND setsale=0 AND bs_owner=0  AND sowner = '{$test_telo[id]}'  AND arsenal_klan='' AND art_param != ''  "));

						if (!($get_sh[id]>0))
						{
						$error_img_ch='Изображение для замены не найдено!';
						}

					}
					else
					{
					$error_img_ch='Ошибка!';
					}
				}
				else if ($menu==16 || $menu==602 || $menu==603)
				{
				$param=(int)($_GET[param]);
					$test_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
				  	 if ($test_telo[id]>0)
				  	 {
							$addsql = "";
							if ($menu == 602) $addsql = " and otdel != 42 ";
							if ($menu == 603) $addsql = " and otdel = 42 ";

				  	 		if ($test_telo[klan]!='')
				  	 		{
				  	 		$get_klan=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `short` = '".$test_telo[klan]."'  ;"));
				  	 		$get_sh=mysql_fetch_array(mysql_query("select * from gellery_prot where klan_owner='{$get_klan[id]}' and id='{$param}' ".$addsql));
				  	 		if (!($get_sh[id]>0))
								{
								$error_img_ch='Изображение для замены не найдено!';
								}
							}
							else
							{
							$error_img_ch='Ошибка!';
							}
					}
					else
					{
					$error_img_ch='Ошибка!';
					}
				}



				if (!($_SESSION['new_serv_img']))
				{
				 echo "<center><b style=\"color:#800000\">Вы не загрузили изображение!</b></center><br>";
				}
				elseif ( (!($_GET[param])) and ($PRICE[$menu][param])  and (!(is_array($PRICE[$menu][param])) ) )
				{
				 echo "<center><b style=\"color:#800000\">Вы не заполнили необходимое поле!</b></center><br>";
				}
				elseif ( ( (is_array($PRICE[$menu][param])) and   ((count($_SESSION['new_serv_img']))!=11)) and ($menu!=81) and ($menu!=82)  )
				{
				 echo "<center><b style=\"color:#800000\">Вы не загрузили все необходимые изображения!</b></center><br>";
				}
				elseif ( ( (is_array($PRICE[$menu][param])) and   ((count($_SESSION['new_serv_img']))!=2)) and (($menu==81) or ($menu==82))  )
				{
				 echo "<center><b style=\"color:#800000\">Вы не загрузили все необходимые изображения!</b></center><br>";
				}
				elseif($error_img_ch)
				{
				 echo "<center><b style=\"color:#800000\">$error_img_ch</b></center><br>";
				}
				else
				{
				$escaped_param=mysql_real_escape_string($_GET[param]);
			 	$_GET[param]=htmlspecialchars($escaped_param,ENT_COMPAT | ENT_HTML401,"cp1251");
				$print_form=0;

		if ($_GET[pay])
			{

			if ( ($PRICE[$menu][size_prise]>0) AND (($_SESSION['new_serv_img_size']/1024)>$PRICE[$menu][size]) )
			 {
			 //если есть параметр стоимость за 1 кб и размер $valsize больше допустимого  $array[size]  , то цена из конфига за каждый КБ
			 $PRICE[$menu][cost]=round($_SESSION['new_serv_img_size']/1024*$PRICE[$menu][size_prise]);
			 }


				if ($_GET[paymethod])
				{
					if (($menu==1||$menu==2||$menu==5||$menu==6||$menu==90|| ($menu>=21 and $menu<=50)) and ($_SESSION[select_present] != $_SESSION['uid']))
				   	{
				   	//убираем возможность оплаты екрами при установке другому игроку
				   	//Установка статичного личного образа
					//Установка анимированного личного образа
				   	$PRICE[$menu]['ekr']=false;
				   	$PRICE[$menu]['sert']=false;
				   	}

					//проверка способов оплаты
						if (($PRICE[$menu][ekr]==true) and ($_GET[paymethod]==2))
							{
							//все в порядке для этого типа можно этот метод
				      	  		$form_bank_login=1;
		//оплата через банк екрами , выбор номера + ввод пароля
      	  		echo "<table  width=\"400\" align=center cellpadding=0 cellspacing=0 class=\"tbl_inside\"><tr bgcolor=\"#f4f2e9\"><td>&nbsp;";

      	  			if (($_GET[cbnk]) and ($_SESSION['bankid']))
      	  			{
      	  			unset($_SESSION['bankid']);
      	  			unset($_SESSION['bank_ekr']);
      	  			}
      	  			else
      	  			if (($_POST[bankid]) and ($_POST[bankpass]) and (!($_SESSION['bankid'])) )
      	  			{
				$bnkdata = mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$_SESSION['uid']."' AND `id`= '".(int)($_POST[bankid])."' AND `pass` = '".md5($_POST['bankpass'])."';");
				$bnkdata = mysql_fetch_array($bnkdata);
					if($bnkdata)
					{
		      	  		$form_bank_login=0;
					$_SESSION['bankid'] = $bnkdata[id];
					$_SESSION['bank_ekr'] = $bnkdata[ekr];
					echo "<br><center><b style=\"color:#800000\">Удачный вход</b></center><br>";
					}
					else
					{
					echo '<br><center><b style="color:#800000">Неверный пароль от банковского счета!</b></center><br>';
					}
      	  			}

      	  			if ($_SESSION['bankid'])
      	  				{
      	  				// уже залогинились
      	  				//обовляем данные банка
      	  				$bnkdata = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$_SESSION['uid']."' AND `id`= '".(int)($_SESSION['bankid'])."' ;"));
					$_SESSION['bank_ekr'] = $bnkdata[ekr];


      	  				 if ($PRICE[$menu][cost] > $_SESSION['bank_ekr'])
      	  				    {
      	  				echo "<br><center><b style=\"color:#800000\">У Вас недостаточно средств для оплаты!!!</b></center><br<br>";
						echo "<br><br><br><center><a href='/commerce/' class='button2'> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br><br>";
      	  				    }
      	  				   elseif ($_GET[userok] ==1)
      	  				   	{
      	  				   	//пробуем оплатить
      	  				   	$form_bank_login=0;

      	  				   	mysql_query("UPDATE oldbk.bank set ekr=ekr-{$PRICE[$menu][cost]} where id='{$_SESSION['bankid']}' and owner='{$_SESSION['uid']}' and ekr>='{$PRICE[$menu][cost]}' ; ");
      	  				   	if (mysql_affected_rows()>0)
      	  				   			{
      	  				   			$id_bill=mk_img_rec($menu,1,2,$_GET[param],$_SESSION['new_serv_img']);
								 if ($id_bill)
								 	{
								 	$user=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
								 	if ($user[id_city]==1) { $user=mysql_fetch_assoc(mysql_query("SELECT * FROM avalon.users WHERE `id` = '".$_SESSION['uid']."'  ;")); }
								 	elseif ($user[id_city]==2) { $user=mysql_fetch_assoc(mysql_query("SELECT * FROM angels.users WHERE `id` = '".$_SESSION['uid']."'  ;")); }
								 	//пишем в банковские операции
								 	//new_delo
				  		    			$rec['owner']=$user[id];
									$rec['owner_login']=$user[login];
									$rec['owner_balans_do']=$user['money'];
									$rec['owner_balans_posle']=$user['money'];
									$rec['target']=0;
									$rec['target_login']='Банк';
									$rec['type']=310;//оплата КО
									$rec['sum_kr']=0;
									$rec['sum_ekr']=$PRICE[$menu][cost];
									$rec['sum_kom']=0;
									$rec['item_id']='';
									$rec['item_name']='';
									$rec['item_count']=0;
									$rec['item_type']=0;
									$rec['item_cost']=0;
									$rec['item_dur']=0;
									$rec['item_maxdur']=0;
									$rec['item_ups']=0;
									$rec['item_unic']=0;
									$rec['item_incmagic']='';
									$rec['item_incmagic_count']='';
									$rec['item_arsenal']='';
									$rec['bank_id']=$_SESSION['bankid'];
									$rec['add_info']=$id_bill;
									add_to_new_delo($rec); //юзеру
								 	//в банк хистори
 	      	  				   			$_SESSION['bank_ekr']-=$PRICE[$menu][cost];
								 	mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Оплата услуг Коммерческого отдела  №<b>{$id_bill} , Сумма: {$PRICE[$menu][cost]} екр.</b>, <i>(Итого: {$_SESSION['bank_ekr']} екр.)</i>','{$_SESSION['bankid']}');");

								 	echo "<br><center><b style=\"color:#800000\">Успешно оплачено!</b></center><br>";
								 	unset($_SESSION['bankid']);
								 	unset($_SESSION['bank_ekr']);
								 	unset($_SESSION['new_serv_img']);
								 	unset($_SESSION['new_serv_img_size']);
								 	unset($_SESSION['select_menu']);
								 	unset($_SESSION['select_array']);
								 	echo "<br><br><center><a href='/commerce/' class='button2'> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br><br>";
								 	}
      	  				   			}
      	  				   	}
      	  				    else
      	  				    {
      	  				$PRINT_OUT="<CENTER>У Вас на счету:<b> {$_SESSION['bank_ekr']} екр.</b><br><br>";
      	  				$PRINT_OUT.="Сумма к оплате: <b>{$PRICE[$menu][cost]} екр.</b><br><br><br>";
      	  				$PRINT_OUT.= "<br><form id=\"form1\" name=\"form1\" method=get >";
	 				$PRINT_OUT.= "<input type=hidden name=act value='service'><input type=hidden name=param value='{$_GET[param]}'><input type=hidden name=menu value='{$menu}'>
	 				<input type=hidden name=userok value='1'>
	 				<input type=hidden name=paymethod value='2'><input type=hidden name=next value='1'>
 					<input type=submit name=pay value=' ПОДТВЕРДИТЬ ОПЛАТУ ' class='button2'; >
				  	</p></form></center>";
      	  				    }

					echo $PRINT_OUT;
      	  				$form_bank_login=0;
      	  				}

			 if ($form_bank_login==1)
			 	{
				echo "<center><form method=post>";
				echo "<fieldset style=\"width:200px; height:130px;\">";
				echo "<legend><b>Войти в счет</b></legend><BR> &nbsp; №";
				$banks = mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$_SESSION['uid']."';");
				echo "<select style='width:155px' name=bankid>";
				while ($rah = mysql_fetch_array($banks)) {
								echo "<option>",$rah['id'],"</option>";
								}
				echo "</select>";
				echo "<BR><BR> &nbsp; Пароль <input type=password name=bankpass size=16>";
				echo "<BR><BR><BR>";
				echo "<center><input type=submit name='enter' value='ВОЙТИ' class='button2'; >";
				echo "</form>";
				echo "</fieldset></center><br>";

				}
			echo "</td></tr></table>";


							}
			elseif (($PRICE[$menu][sert] > 0) and ($_GET[paymethod]==6)) {
				$item = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.inventory WHERE owner = '.$_SESSION['uid'].' and prototype = '.$PRICE[$menu][sert]));

				if ($item) {
					if ( ($_GET[userok]==1)) {
						$id_bill = mk_img_rec($menu,1,6,$_GET[param],$_SESSION['new_serv_img'],$item['id']);
						if ($id_bill) {
							$us = check_users_city_data($_SESSION['uid']);

							$rec = array();
				    			$rec['owner']=$us[id];
							$rec['owner_login']=$us[login];
							$rec['owner_balans_do']=$us['money'];
							$rec['owner_balans_posle']=$us['money'];
							$rec['owner_rep_do']=$us['repmoney'];
							$rec['target_login'] = "КО";
							$rec['owner_rep_posle']=$us['repmoney'];
							$rec['item_id'] = get_xitem_fid($item);
							$rec['type'] = 388;
							if (add_to_new_delo($rec) === FALSE) die();


							mysql_query('UPDATE oldbk.inventory SET owner = 453, add_time=dategoden, dategoden=0 WHERE id = '.$item['id']); //запоминаем дату годности если етсь, настоящую убиваем

						 	echo "<br><center><b style=\"color:#800000\">Успешно оплачено сертификатом!</b></center><br>";
						 	unset($_SESSION['bankid']);
						 	unset($_SESSION['bank_ekr']);
						 	unset($_SESSION['new_serv_img']);
						 	unset($_SESSION['new_serv_img_size']);
						 	unset($_SESSION['select_menu']);
						 	unset($_SESSION['select_array']);
						 	echo "<br><br><center><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><BR>";
						}

					} else {
						echo "<table width=\"100%\" border=\"0\"  >
			      	  		<tr align=center><td width=5% >&nbsp;</td>
			      	  		<td>&nbsp;<p>";
			      	  		echo "<b>К оплате: </b><b style=\"color:#800000\">".$item['name']." (id ".$item['id']." будет автоматически изъят из извентаря)</b><br>";

			  			echo "<form id=\"form1\" name=\"form1\" method=get >";
	 					echo "<input type=hidden name=act value='service'><input type=hidden name=param value='{$_GET[param]}'><input type=hidden name=menu value='{$menu}'>
		 				<input type=hidden name=userok value='1'><input type=hidden name=paymethod value='6'><input type=hidden name=next value='1'>
		 				<input type=submit name=pay value='Подтвердить' class='button2'; >
	 					<br><br><br>
					  	</p></form><br>";
		  				echo "</td></tr></table>";
					}

				}
			}


			elseif (($PRICE[$menu][real]==true) and ($_GET[paymethod]==3)) {
	      	  		// списываем монеты
				echo "<table width=\"100%\" border=\"0\"  >
	      	  		<tr align=center><td width=5% >&nbsp;</td>
	      	  		<td>&nbsp;<p>";
				$us = check_users_city_datal($user);

				$pr = round(($PRICE[$menu][cost]*$EKR_TO_GOLD)*0.9); // скидка 10%


	      	  		echo "<b>Сумма к оплате: </b><b style=\"color:#800000\">".$pr." монет.</b><br><br> У вас в наличии <b>".$us['gold']."</b> монет.<br>";

				if ($_GET[userok]==1) {
					if ($us['gold'] >= $pr) {

						mysqL_query('UPDATE oldbk.users SET gold = gold - '.$pr.' WHERE id = '.$us['id'].' LIMIT 1');

						$rec['owner']=$us[id];
						$rec['owner_login']=$us[login];
						$rec['owner_balans_do']=$us[money];
						$rec['owner_balans_posle']=$us[money];
						$rec['target']=0;
						$rec['target_login']='КО';
						$rec['type']=507;
						$rec['sum_kr']=0;
						$rec['sum_ekr']=0;
						$rec['sum_kom']=0;
						$rec['add_info'] = $pr."/".($us['gold']-$pr);
						add_to_new_delo($rec);

						$id_bill = mk_img_rec($menu,1,3,$_GET['param'],$_SESSION['new_serv_img']);
						if ($id_bill) {
	     	  				 	echo "<br><center><b style=\"color:#800000\">Золотые монеты списаны. Ожидайте утверждения.</b></center>";
	      	  				 	unset($_SESSION['bankid']);
						 	unset($_SESSION['bank_ekr']);
						 	unset($_SESSION['new_serv_img']);
						 	unset($_SESSION['new_serv_img_size']);
						 	unset($_SESSION['select_menu']);
						 	unset($_SESSION['select_array']);
						 	echo "<br><br><center><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><BR>";
						} else {
	      	  				 	echo "<center><b style=\"color:#800000\">Ошибка при оплате монетами!</b></center><br>";
	     	  				}
					} else {
      	  				 	echo "<center><b style=\"color:#800000\">Недостаточно монет для оплаты!</b></center><br>";
					}
				} else {
		  			echo "<form id=\"form1\" name=\"form1\" method=get >";
 					echo "<input type=hidden name=act value='service'><input type=hidden name=param value='{$_GET[param]}'><input type=hidden name=menu value='{$menu}'>
	 				<input type=hidden name=userok value='1'><input type=hidden name=paymethod value='3'><input type=hidden name=next value='1'>";
					if ($us['gold'] >= $pr) {
		 				echo "<input type=submit name=pay value='Подтвердить' class='button2'; >";
					}
					echo "<br><br><br></p></form><br>";
				}



	      	  		echo "</td></tr></table>";
			}
						elseif (($PRICE[$menu][klan]==true) and ($_GET[paymethod]==1))
							{


      	  		//оплата через казну, ввод пароля от казны клана
			  $glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
			  if ($glava_test[id]>0)
			  {
      	  		echo "<table width=\"100%\" border=\"0\"  ><tr><td width=5% >&nbsp;</td><td>&nbsp;";
			  //да я глава
			  $form_kazna=1;
			  if (($_POST[kaznapass]) OR ($_SESSION['kaznapass']))
			  	{
			  	if (isset($_SESSION['kaznapass'])) {$klan_pass=$_SESSION['kaznapass']; } else {$klan_pass=$_POST[kaznapass]; }
				$kaznadata = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`clans_kazna` WHERE `clan_id` = '".$glava_test[id]."' AND `ekr_pass`= '".mysql_real_escape_string($klan_pass)."' ;"));
			  	 if ($kaznadata[clan_id]>0)
			  	   {
			  	   $_SESSION['kaznapass']=$kaznadata[ekr_pass];
			  	   // удачный вход
			  	   	echo "<br><br><CENTER>В клановой казне:<b>{$kaznadata['ekr']} екр.</b><br>";
      	  				echo "<br>Сумма к оплате:<b>{$PRICE[$menu][cost]} екр.</b><br></CENTER>";
					if ($PRICE[$menu][cost] > $kaznadata['ekr'])
      	  				{
      	  				echo "<center><b style=\"color:#800000\">Ошибка! У Вас недостаточно средств для оплаты!</b></center><br>";
      	  				}
      	  				else
      	  				{
      	  				 if ($_GET[userok]==1)
      	  						{

 		     	  				//1. снимаем деньги
							mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr-{$PRICE[$menu][cost]}  WHERE `clan_id` = '{$kaznadata[clan_id]}' and ekr>={$PRICE[$menu][cost]} ;");
							if (mysql_affected_rows()>0)
 		     	  				{
 		     	  				$id_bill=mk_img_rec($menu,1,1,$_GET[param],$_SESSION['new_serv_img']);
							 if ($id_bill)
      	  					 		{
      	  					 		//
      	  					 		// записать в дело казны
						        	$txt="Оплата из клан казны, ".$PRICE[$menu][cost]." екр. за услуги Коммерческого отдела: \"{$PRICE[$menu][desc]}\". Счет №{$id_bill}.";
						           	mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)   VALUES  ('2','2','{$kaznadata[clan_id]}','{$glava_test[id]}','".$txt."','".time()."');");
      	  					 		echo "<center><b>Оплата произведена успешно!</b></center>";

		      	  				 		unset($_SESSION['bankid']);
								 	unset($_SESSION['bank_ekr']);
								 	unset($_SESSION['new_serv_img']);
								 	unset($_SESSION['new_serv_img_size']);
								 	unset($_SESSION['select_menu']);
								 	unset($_SESSION['select_array']);
								 	echo "<br><br><center><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><BR>";
      	  					 		}
      	  					 		else
      		  				 		{
	      	  				 		echo "<center><b style=\"color:#800000\">Ошибка при оплате!</b></center><br>";
      	  				 			}
      	  				 		}
      	  				 			else
      		  				 		{
	      	  				 		echo "<center><b style=\"color:#800000\">Ошибка при оплате!</b></center><br>";
      	  				 			}

      	  						}
      	  			 		else
      	  			 		{
      	  					echo "<br><form id=\"form1\" name=\"form1\" method=get >";
	 					echo "<input type=hidden name=act value='service'><input type=hidden name=param value='{$_GET[param]}'><input type=hidden name=menu value='{$menu}'><input type=hidden name=userok value='1'><input type=hidden name=paymethod value='1'><input type=hidden name=next value='1'>
	 					<CENTER><input type=submit name=pay value='ПОДТВЕРДИТЬ ОПЛАТУ' class='button2'; ></center>
					  	</p></form><br>";

					  	}
      	  				}

      	  				$form_kazna=0;
			  	   }
			  	   else
			  	   {
			  	   unset($_SESSION['kaznapass']);
					echo '<center><b style="color:#800000">Ошибка! Неверный пароль екр. казны клана, либо у клана нет клановой казны!</b></center><br>';
			  	   }
			  	}
			  if ($form_kazna==1)
			  {
				echo "<center><form method=post>";
				echo "<fieldset style=\"width:300px; height:130px;\">";
				echo "<legend><b>Войти в клановую казну</b></legend><BR>";
				echo "<BR> &nbsp; Пароль от екровой казны клана: <input type=password name=kaznapass size=16>";
				echo "<BR><BR><BR>";
				echo "<center><input type=submit name='enter' value='ВОЙТИ' class='button2'; >";
				echo "</form>";
			  }
			echo "</td></tr></table>";
	  		 }


							}
							elseif (($PRICE[$menu][vau]==true) and ($_GET[paymethod]==5))
							{
							//оплата услуг КО ваучерами
							$vch = array (	5   => 100005,	15  => 100015,	20  => 100020,	25  => 100025,	40  => 100040,	100 => 100100,	200 => 100200,	300 => 100300);
							$sum=$PRICE[$menu][cost];
		if (isset($_POST['paybillds']) && !empty($_POST['paybillds']))
		{

								if ($sum > 0)
								{
								$ids = explode(",",$_POST['paybillds']);
								if (count($ids) > 0 && !empty($ids[0]))
								{
								while(list($k,$v) = each($ids))
									{
									$ids[$k] = intval($v);
									}
								$us = check_users_city_datal($user);
								$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND (setsale=0 and (prototype in (100005,100015,100020,100025,100020,100040,100100,100200,100300)))) AND id IN('.implode(",",$ids).') ');
								$ekrnum = 0;
								$ekrids = array();
								$useditems = "";

								while($i = mysql_fetch_assoc($q))
									{
										$useditems .= get_xitem_fid($i).",";

									if ($i['prototype'] == "100300") {
										$ekrnum += 300;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100200") {
										$ekrnum += 200;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100100") {
										$ekrnum += 100;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100040") {
										$ekrnum += 40;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100025") {
										$ekrnum += 25;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100020") {
										$ekrnum += 20;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100015") {
										$ekrnum += 15;
										$ekrids[] = $i['id'];
									} elseif ($i['prototype'] == "100005") {
										$ekrnum += 5;
										$ekrids[] = $i['id'];
									}
								}

								if ($ekrnum < $sum) {
								serr("Сумма ваучеров должна быть ".$sum." екр или больше");
								} else {
								// всё ок - начинаем
								$q = mysql_query('START TRANSACTION') or die();

									$rec = array();
						    			$rec['owner']=$us[id];
									$rec['owner_login']=$us[login];
									$rec['owner_balans_do']=$us['money'];
									$rec['owner_balans_posle']=$us['money'];
									$rec['target_login'] = "КО";
									$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
									$rec['type'] = 282;
									if (add_to_new_delo($rec) === FALSE) die();


									// сносим
									mysql_query('DELETE FROM oldbk.inventory WHERE id IN ('.implode(",",$ekrids).')') or die();

									// выдаём сдачу
									$retmoney = $ekrnum - $sum;
									$nominals = array(300,200,100,40,25,20,15,5);
									$newret = array();
									while(list($k,$v) = each($nominals)) {
										$z = floor($retmoney / $v);
										if ($z > 0) {
											$newret[$v] = $z;
											$retmoney = $retmoney - ($z*$v);
										}
									}

									$vdress = array();
									$nomlist = "";
									while(list($k,$v) = each($newret))
									{
										if (!isset($vdress[$k])) {
											$t = mysql_query('select * from oldbk.eshop where id = '.$vch[$k]) or die();
											$vdress[$k] = mysql_fetch_array($t);
										}
									$dress = $vdress[$k];
							if ($dress['id'] > 0) {
							for($i = 0; $i < $v; $i++) {
								$nomlist .= $k."екр, ";
								mysql_query("INSERT INTO oldbk.`inventory`
									(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
									`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
									`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
									`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`
									)
									VALUES
									('{$dress['id']}','{$us['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
									'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
									'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
									,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$us['id']}'
									);
								") or die();

								//new_delo
								$rec = array();
			  		    			$rec['owner']=$us[id];
								$rec['owner_login']=$us[login];
								$rec['owner_balans_do']=$us['money'];
								$rec['owner_balans_posle']=$us['money'];
								$rec['target_login']="КО";
								$rec['type']=280;//получил ваучер
								$rec['sum_kr']=0;
								$rec['sum_ekr']=$k;
								$rec['sum_kom']=0;
								$rec['item_id']=get_xitem_fid(array("idcity" => $us['id_city'], "id" => mysql_insert_id()));
								$rec['item_name']=$dress[name];
								$rec['item_count']=1;
								$rec['item_type']=$dress['type'];
								$rec['item_cost']=$dress['cost'];
								$rec['item_dur']=$dress['duration'];
								$rec['item_maxdur']=$dress['maxdur'];
								$rec['item_ups']=$dress['ups'];
								$rec['item_unic']=$dress['unic'];
								$rec['item_incmagic']=$dress['includemagicname'];
								$rec['item_incmagic_count']=$dress['includemagicuses'];
								$rec['item_arsenal']='';
								$rec['bank_id']='';
								$rec['add_info']='Покупка реликтов';
								$rec['item_proto']=$dress['prototype'];
								$rec['item_sowner']=($dress['sowner']>0?1:0);
								$rec['item_incmagic_id']=$dress['includemagic'];
								if (add_to_new_delo($rec) === FALSE) die();

							}
						}

					}
 					if (strlen($nomlist)) {
 					 	$nomlist = substr($nomlist,0,strlen($nomlist)-2);
					}

					echo '<table  align="center" cellpadding="0" cellspacing="0" class="tbl_inside"><tr bgcolor="#f4f2e9"><td><br><b style="color:#800000">Вы удачно оплатили счет!</b><br><br>';

					//операция по оплате счета
					$id_bill=mk_img_rec($menu,1,5,$_GET[param],$_SESSION['new_serv_img']);
					 if ($id_bill)
						{
									unset($_SESSION['bankid']);
								 	unset($_SESSION['bank_ekr']);
								 	unset($_SESSION['new_serv_img']);
								 	unset($_SESSION['new_serv_img_size']);
								 	unset($_SESSION['select_menu']);
								 	unset($_SESSION['select_array']);
						}
					echo 'Сумма <b>'.$sum.' екр.</b><br>';
					echo 'Уплачено ваучерами на сумму '.$ekrnum.' екр.<br>';
					if (strlen($nomlist)) {
						echo 'Выдана сдача - ваучер(ы) на '.$nomlist.'<br>';
					}
					echo '<br></td></tr></table>';
					echo '<br><br><br><center><a href="/commerce/" class="button2"> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br><br>';
					$q = mysql_query('COMMIT') or die();
				}
			} else {
				$view = true;
			}
		} else {
			$view = true;
		}
	}
	else
	{
	$view = true;
	}








							if ($view)
							//форма перетягивания ваучеров
							{
							echo '<center>Ваш заказ на сумму: <b>'.$sum.'</b> екр. </center><br><br>';
							echo '
							<style>
							#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
							</style>
							<center>Ваучеры на сумму: <span id="ekrnum" style="font-weight:bold;">0</span> екр<br><br>
							<div id="allconstr">
							<div id="snaptarget">Переместите ваучер(ы) на необходимую сумму
							</div><br>
							<form id="paybill" method="POST">
							<input type=hidden name=act value="service">
							<input type=hidden name=param value="'.$_GET[param].'">
							<input type=hidden name=menu value="'.$menu.'">
			 				<input type=hidden name=userok value="1">
			 				<input type=hidden name=paymethod value="5">
			 				<input type=hidden name=next value="1">
							<input type="hidden" id="paybillds" name="paybillds" value="">
							<input type="button" value="ОПЛАТИТЬ" class="button2"  OnClick="CheckF();"><br>
							';

							echo '</form>';

					$ids = array();
					$us = check_users_city_datal($user);

					$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale=0 and (prototype in (100005,100015,100020,100025,100020,100040,100100,100200,100300))) ORDER BY ecost DESC');

				if (mysql_num_rows($q) > 0)
				{
				while($i = mysql_fetch_assoc($q))
					{
					$ids[] = $i['id'];
					echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
					}

				echo '
				<script>
				var spans = [];
				var ekrnum = 0;
				var bprice = 0;
				var needekr = '.$sum.';

				function CheckF() {
					if (spans.length == 0) {
						alert("Вы ничего не положили");
						return;
					}
					if (needekr > ekrnum) {
						alert("Сумма ваучеров должна быть "+needekr+" екр или больше");
						return;
					}
					if (confirm("Вы уверены?")) {
						document.getElementById("paybill").submit();
					}

				}

				$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
				$("#allconstr span" ).bind( "dragstop", function(event, ui) {
					spans.splice(0,spans.length);


					$("#allconstr span").each(function(index,item) {
						m = $("#allconstr").offset().top;

						if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
							spans.push(item);
						}
					});

					ekrnum = 0;

					var ids = new Array();

					for (key in spans) {
						var n = spans[key];
						itemid = n.id;
						itemid = itemid.substring(4);
						itemproto = $("#"+n.id).attr("name");
						itemproto = itemproto.substr(4);
						ids.push(itemid);

						if (itemproto == "100300") {
							ekrnum += 300;
						} else if (itemproto == "100200") {
							ekrnum += 200;
						} else if (itemproto == "100100") {
							ekrnum += 100;
						} else if (itemproto == "100040") {
							ekrnum += 40;
						} else if (itemproto == "100025") {
							ekrnum += 25;
						} else if (itemproto == "100020") {
							ekrnum += 20;
						} else if (itemproto == "100015") {
							ekrnum += 15;
						} else if (itemproto == "100005") {
							ekrnum += 5;
						}
					}
					document.getElementById("paybillds").value = ids.join();
					document.getElementById("ekrnum").innerHTML = ekrnum;

				});
				</script>';
				} else
				{
				echo '<script>function CheckF() {alert("У вас нет ваучеров.");}</script>У вас нет ваучеров.';
				}
				echo '</div></center></div>';
				}

							////////////////////////////////////////////
							}




					}
					else
					{
					 echo "<center><b style=\"color:#800000\">Выберите метод оплаты!</b></center><br><br>";
					$print_form=0;
					print_pay_form($menu,$_SESSION['new_serv_img_size']);
					}
				}
				else
					{
					print_pay_form($menu,$_SESSION['new_serv_img_size']);
					}
				}
			}





			 if ($print_form==1)
			{
			get_load_img($menu);
			}

		}
	}


function mk_img_rec($n,$pay,$pay_type,$param=null,$img=null, $sert = 0) {
	global $PRICE;
	global $EKR_TO_GOLD;

	$array=$PRICE[$n];

	if ($pay_type==2 ) { $bank_rem=" , bank='{$_SESSION['bankid']}' "; } else { $bank_rem=''; } //оплата из банка - запоминаем номер счета

	$addsert = "";
	if ($sert > 0) $addsert = ",addinfo = ".$sert;

	if ($array[klan]==true) {
		$glava_test_clear=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
		if ($glava_test_clear[id] >0 )	{
			$add_klan_id=" , klan_id={$glava_test_clear[id]}";
		}
	}

	if (($array[present]==true) and ($_SESSION[select_present]) and ($_SESSION[select_present]!=$_SESSION['uid'])) {
		//типа подарок ставится поле target
		$add_trag=" ,  target='{$_SESSION[select_present]}'  ";
	} else {
		$add_trag='';
	}

	$in_gold='';
	if ($pay_type==3)
		{
		$in_gold=" `cost_gold`= '".round($array[cost]*$EKR_TO_GOLD*0.9)."' , ";
		}


	if (is_array($img)) {
		//оптовая заявка
		$group_ids=array();

		foreach ($img as $i => $v) {
			mysql_query("INSERT INTO `oldbk`.`com_service` SET owner='{$_SESSION['uid']}'  ".$bank_rem." ,  `type`='{$n}',`cost`='{$array[cost]}', ".$in_gold." `cost_type`='{$pay_type}',`stat`='{$pay}',`moder`=0 ".$add_trag." ,`param`='{$i}',`img`='{$v}' ".$add_klan_id." ".$addsert." ;");
			$last_id=mysql_insert_id();
			$group_ids[]=$last_id;
		}
		mysql_query("UPDATE `oldbk`.`com_service` SET group_id='{$last_id}' WHERE id in (".implode(", ", $group_ids).") ");
		$bill_id=$last_id;
	} else {
		mysql_query("INSERT INTO `oldbk`.`com_service` SET owner='{$_SESSION['uid']}'  ".$bank_rem." ,  `type`='{$n}',`cost`='{$array[cost]}', ".$in_gold."  `cost_type`='{$pay_type}',`stat`='{$pay}',`moder`=0 ".$add_trag."  ,`param`='{$param}',`img`='{$img}' ".$add_klan_id." ".$addsert." ;");
		$bill_id=mysql_insert_id();
	}


	$str_bill='SC'.$bill_id;

	$str_type=$array[desc];
	$str_pay=get_cost($array);
 	if ($pay>0) { $str_stat=' - <b>Оплачено</b>';} else { $str_stat=''; }


	if ($pay_type == 6) {
		// nothing
		mysql_query("INSERT INTO oldbk.`inventory` (`owner`,`name`,`type`,`massa`,`cost`,`img`,`letter`,`maxdur`,`isrep`,`present`) VALUES('{$_SESSION['uid']}','Счет на оплату услуг','50',0,0,'paper100.gif','Счет на оплату услуги:<b>{$str_type}</b>.<br>\n Оплачено сертификатом <br>\n Номер счета:<b>{$str_bill}</b> {$str_stat}',1,0,'Коммерческий отдел') ;");
	} else {
		mysql_query("INSERT INTO oldbk.`inventory` (`owner`,`name`,`type`,`massa`,`cost`,`img`,`letter`,`maxdur`,`isrep`,`present`) VALUES('{$_SESSION['uid']}','Счет на оплату услуг','50',0,0,'paper100.gif','Счет на оплату услуги:<b>{$str_type}</b>.<br>\n Сумма:{$str_pay} <br>\n Номер счета:<b>{$str_bill}</b> {$str_stat}',1,0,'Коммерческий отдел') ;");
	}

	return $str_bill;
}




function print_pay_form($n,$valsize=0)
	{
	global $EKR_TO_GOLD;
	global $PRICE;
	$array=$PRICE[$n];
	global $user;
	$us = check_users_city_datal($user);
	echo "<center><b>Выберите один из способов оплаты:</b></center>";
	echo "
   	<table align=center width=\"450\" border=\"0\"  >
  	<tr>
	<td>&nbsp;
   	<form id=\"form1\" name=\"form1\" method=get >";

   	if (($n==1||$n==2||$n==5||$n==6||$n==90||($n>=21 and $n<=50)) and ($_SESSION[select_present] != $_SESSION['uid']))
   	{
   	$array['ekr']=false;
   	$array['sert']=false;
   	}

		if (($array[size_prise]>0) AND (($valsize/1024)>$array[size] ))
		{
		//если есть параметр стоимость за 1 кб и размер $valsize больше допустимого  $array[size]  , то цена из конфига за каждый КБ
		$array[cost]=round(($array[size_prise]/1024)*$valsize);
		//echo "Добавочная стоимость!";
		}

	  	if ($array[real]==true)
  		{
    		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"3\" id=\"paymethod_3\" />&nbsp;&nbsp;Списать ".round($array[cost]*$EKR_TO_GOLD*0.9)." золотых монет.</label><br />";
  		}

	  	if ($array[klan]==true)
	  	{
  		echo "<label><input type=\"radio\" name=\"paymethod\" value=\"1\" id=\"paymethod_1\" />&nbsp;&nbsp;Списать ".$array[cost]." екр. из казны клана </label><br />";
  		}

	  	if ($array[ekr]==true)
  		{
	    	echo "<label><input type=\"radio\" name=\"paymethod\" value=\"2\" id=\"paymethod_2\" />&nbsp;&nbsp;Списать ".$array[cost]." екр. с Вашего банковского счета </label><br />";
	    	}

	  	if ($array[vau]==true)
  		{
	    	echo "<label><input type=\"radio\" name=\"paymethod\" value=\"5\" id=\"paymethod_5\" />&nbsp;&nbsp;Оплатить ".$array[cost]." екр. Ваучерами Коммерческого отдела </label><br />";
	    	}

	  	if ($array[sert]==true)
  		{
			$sertinfo = mysql_fetch_assoc(mysql_query('SELECT * FROM oldbk.inventory WHERE prototype = '.$array[sert].' and owner = '.$us['id']));
			if ($sertinfo) {
			    	echo "<label><input type=\"radio\" name=\"paymethod\" value=\"6\" id=\"paymethod_6\" />&nbsp;&nbsp;Оплатить с помощью &quot;".$sertinfo['name']."&quot; </label><br />";
			}
	    	}

	echo "

	<input type=hidden name=param value='{$_GET[param]}'>
	<input type=hidden name=next value='1'>
	<input type=hidden name=act value='service'>
	<input type=hidden name=menu value='$n'>
	</td>
	</tr>
  	</table><br><br>
    	<center><input type=submit name=pay value=' ОПЛАТИТЬ ' class='button2';  ></center>

	</form>
";
	}

function get_cost($array,$d=false)
{
	global $EKR_TO_GOLD;

	if ($array[cost]==0) return "бесплатно";

 if ($d==true)
 	{
 	return $array[cost];
 	}
  else  if ( ($array[ekr]==true) and ($array[real]!=true))
 	{
 	return $array[cost]." екр";
 	}
  else  if ( ($array[ekr]==true or  $array[klan]==true) and ($array[real]==true))
 	{
 	return $array[cost]." екр / ".round($EKR_TO_GOLD*$array[cost]*0.9)." <img src='https://i.oldbk.com/i/icon/coin_icon.png' style='margin-bottom:-2px;'> ";//долларов/
 	}
  else  if ( ($array[ekr]!=true) and ($array[real]==true))
 	{
 	return $array[cost]." екр";//долларов
 	}
  else  if ( ($array[kr]==true) )
  	{
  	return $array[cost]." кредитов ";
  	}
  else
     {
      	return $array[cost];
     }
}


function get_load_img($n)
	{
global $PRICE;
	$array=$PRICE[$n];
	 if ( ($array[w]>0) and ($array[h]>0))
		{

		echo "
	<script type=\"text/javascript\">
	function ajaxFileUpload(fid)
	{

	if (fid!=-1)
		{
		  param=document.getElementById('masparam'+fid).value;
		 }
		 else
		 {
		  param='';
		  fid='';
		 }

		$(\"#loading\")
		.ajaxStart(function(){
			$(this).show();
		})
		.ajaxComplete(function(){
			$(this).hide();
		});

		$.ajaxFileUpload
		(
			{
				url:'doajaxfileuploadimg.php?f='+fid+'&masparam='+param,
				secureuri:false,
				fileElementId:'fileToUpload'+fid,
				dataType: 'json',
				data:{name:'logan', id:'id'},
				success: function (data, status)
				{
					if(typeof(data.error) != 'undefined')
					{
						if(data.error != '')
						{
							alert(data.error);
						}else
						{
							document.getElementById('old_img'+fid).innerHTML='';
							document.getElementById('new_img_load'+fid).innerHTML=data.msg;
						}
					}
				},
				error: function (data, status, e)
				{
					alert(e);
				}
			}
		)

		return false;

	}
	</script>  	";



	 	//показываем поле загрузки картинки

		echo "<table width=\"880\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" class=\"tbl_inside\">
			<tr bgcolor=\"#f4f2e9\">";

	  	//echo "start";
	  	echo "<td valign=top align=center>";



		$upload_form= "<br><b>Загрузите изображение (*.gif) :</b><br><br><br><div id=\"old_img\"><img src=".(($_SESSION['new_serv_img'])?"uploadimg/{$_SESSION['new_serv_img']}":"'https://i.oldbk.com/i/sh/wish_t333.gif' border=1   width={$array[w]}   height={$array[h]} ")."><br><br></div>
		  	<div id=\"new_img_load\"></div>
			<img id=\"loading\" src=\"loading.gif\" style=\"display:none;\">
			<form name=\"form\" method=\"POST\" enctype=\"multipart/form-data\">
			<input id=\"fileToUpload\" type=\"file\" size=\"20\" name=\"fileToUpload\"  accept='image/gif' onchange=\"return ajaxFileUpload(-1);\" style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'  >
			</form><br>";

 	  	$upload_form1= "<br><b>Загрузите изображение (*.gif) :</b><br><br>
		  	<div id=\"new_img_load\"></div>
			<img id=\"loading\" src=\"loading.gif\" style=\"display:none;\">
			<form name=\"form\" method=\"POST\" enctype=\"multipart/form-data\">
			<input id=\"fileToUpload\" type=\"file\" size=\"20\" name=\"fileToUpload\"  accept='image/gif' onchange=\"return ajaxFileUpload(-1);\" style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'  >
			<br><br><br><div id=\"old_img\"><img src=".(($_SESSION['new_serv_img'])?"uploadimg/{$_SESSION['new_serv_img']}":"'https://i.oldbk.com/i/sh/wish_t333.gif' border=1   width={$array[w]}   height={$array[h]} ")."><br><br></div>
			</form><br>";


	 		//подолнительно для конкретного типа

	 		if ( ($n==11) or ($n==12) or ($n == 612) or ($n==13) or ($n==14) or ($n==15) or ($n == 602) or ($n == 603) or ($n == 600) or ($n == 601) or ($n == 613) or ($n == 614)  or ($n==16) or ($n==83) )   //Cмена или перезаливка личного образа
	 			{

				echo $upload_form1;
				echo "<br></td><td valign=top width=440 align=center>";
	 			//echo "start2"; echo $n;



	 			echo "<form id=\"form1\" name=\"form1\" method=get >
	 			<script>
			        function requestimg(param){
			        hax({url:'https://oldbk.com/commerce/getimg.php?n={$n}&param='+param, id:'idivimg', anticache:1});
				document.getElementById('new_img_load').innerHTML='';
				document.getElementById('old_img').innerHTML='<img src=https://i.oldbk.com/i/sh/wish_t333.gif  border=1   width={$array[w]}   height={$array[h]}>';
			        }
				</script>";
	 			echo "<center><br><b>{$array[param]}:</b><br><br></center>";
	 			echo '<select name="param" id="param" onChange="requestimg(this.value)">
			        <option class="select" value="0">Выберите существующее изображение... </option>';

			        if (($n==11) OR ($n==83))
			        {
				 $get_sh=mysql_query("SELECT * FROM oldbk.users_shadows  where owner='{$_SESSION['uid']}' and type=2 ;");
					 while ($row=mysql_fetch_array($get_sh))
					{
					echo '<option value="'.$row[id].'">'.$row[name].'.gif</option>';
					}
				 }
				 else if ($n==12 || $n==612)
				 {
				  $glava_test_clear=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
				  if ($glava_test_clear[id]>0)
				  	{
				  	 $get_sh=mysql_query("SELECT * FROM oldbk.users_shadows  where klan='{$glava_test_clear[id]}' and type=1 ;");
					$pref[0]='g';
		 			$pref[1]='m';
						while ($row=mysql_fetch_array($get_sh))
							{
							echo '<option value="'.$row[id].'">'.$pref[$row[sex]].$row[name].'.gif</option>';
							}
				  	}
				 }
				 else if ($n==13)
				 {
				  $get_sh=mysql_query("SELECT * FROM oldbk.eshop  where owner='{$_SESSION['uid']}' and type=200 and razdel=72 ;");
						while ($row=mysql_fetch_array($get_sh))
							{
							echo '<option value="'.$row[id].'"> ['.$row[name].'] - '.$row[img].'</option>';
							}

				 }
				  else if ($n==14)
				 {
				 $glava_test_clear=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
				  if ($glava_test_clear[id]>0)
				 	{
					  $get_sh=mysql_query("SELECT * FROM oldbk.eshop  where klan='{$glava_test_clear[short]}' and type=200 and razdel=72 ;");
						while ($row=mysql_fetch_array($get_sh))
							{
							echo '<option value="'.$row[id].'"> ['.$row[name].'] - '.$row[img].'</option>';
							}
					}
				 }
				 else if ($n==15 || $n==600 || $n == 601)
				  {

				  	$test_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
				  	 if ($test_telo[id]>0)
				  	 {
				  	 //есть чар
							$addsql = "";
							if ($n == 600) $addsql = " and otdel != 42 ";
							if ($n == 601) $addsql = " and otdel = 42 ";

				  	 		if ($test_telo[klan]!='')
				  	 		{
				  	 		//в клане
				  	 		$get_klan=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `short` = '".$test_telo[klan]."'  ;"));
			  	 			$get_sh=mysql_query("SELECT * FROM gellery where owner='{$test_telo[id]}' and otdel != 99 and img not in (select img from gellery_prot where klan_owner='{$get_klan[id]}') ".$addsql.";");
				  	 		}
				  	 		else
				  	 		{
				  	 		//не в клане
							$get_sh=mysql_query("SELECT * FROM gellery where owner='{$test_telo[id]}' and otdel != 99 ".$addsql);
				  	 		}

				  	 		//масив настроек для шмоток
				  	 		$otdels_array=array(1=>'Кастеты,ножи',11=>'Топоры',12=>'Дубины,булавы',13=>'Мечи',14=>'Луки и арбалеты',2=>'Сапоги',21=>'Перчатки',22=>'Легкая броня',23=>'Тяжелая броня',6=>'Плащи',24=>'Шлемы',3=>'Щиты',4=>'Серьги',41=>'Ожерелья',42=>'Кольца',99=>'Свадебные кольца');

							while ($row=mysql_fetch_array($get_sh))
								{
								echo '<option value="'.$row[id].'"> ['.$otdels_array[$row[otdel]].'] - '.$row[img].'</option>';
								}
					}

				   }

				   else if ($n==613 || $n == 614)
				  {

				  	$test_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
				  	 if ($test_telo[id]>0)
				  	 {
				  	 //есть чар
					$get_sh=mysql_query("SELECT * FROM oldbk.inventory WHERE owner='{$test_telo[id]}'  AND setsale=0 AND bs_owner=0  AND sowner = '{$test_telo[id]}'  AND arsenal_klan='' AND art_param !=''  ");


				  	 		//масив настроек для шмоток
				  	 		$otdels_array=array(1=>'Кастеты,ножи',11=>'Топоры',12=>'Дубины,булавы',13=>'Мечи',14=>'Луки и арбалеты',2=>'Сапоги',21=>'Перчатки',22=>'Легкая броня',23=>'Тяжелая броня',6=>'Плащи',24=>'Шлемы',3=>'Щиты',4=>'Серьги',41=>'Ожерелья',42=>'Кольца',99=>'Свадебные кольца');

							while ($row=mysql_fetch_array($get_sh))
								{
								echo '<option value="'.$row[id].'"> ['.$otdels_array[$row[otdel]].'] - '.$row[img].'</option>';
								}
					}

				   }

				   else if ($n==16 || $n==602 || $n==603)
				  {
				  	$test_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$_SESSION['uid']."'  ;"));
				  	 if ($test_telo[id]>0)
				  	 {
				  	 //есть чар

							$addsql = "";
							if ($n == 602) $addsql = " and otdel != 42 ";
							if ($n == 603) $addsql = " and otdel = 42 ";

				  	 		if ($test_telo[klan]!='')
				  	 		{
				  	 		//в клане
				  	 		$get_klan=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `short` = '".$test_telo[klan]."'  ;"));
				  	 		$get_sh=mysql_query("select * from gellery_prot where klan_owner='{$get_klan[id]}' ".$addsql);
				  	 		//масив настроек для шмоток
				  	 		$otdels_array=array(1=>'Кастеты,ножи',11=>'Топоры',12=>'Дубины,булавы',13=>'Мечи',14=>'Луки и арбалеты',2=>'Сапоги',21=>'Перчатки',22=>'Легкая броня',23=>'Тяжелая броня',6=>'Плащи',24=>'Шлемы',3=>'Щиты',4=>'Серьги',41=>'Ожерелья',42=>'Кольца',99=>'Свадебные кольца');

							while ($row=mysql_fetch_array($get_sh))
								{
								echo '<option value="'.$row[id].'"> ['.$otdels_array[$row[otdel]].'] - '.$row[img].'</option>';
								}

							}
					}

				   }
				echo '    </select>';


	 			echo '<br><br><br><div id="idivimg"></div>';
	 			echo "<input type=hidden name=act value='service'>
				<input type=hidden name=menu value='$n'>";
 	  			echo "<br></td></tr>";
				echo "</table>";
				echo "<br><br><center><input type=submit name=next value=' ПРОДОЛЖИТЬ ' class='button2';  ></center></form>	<br><br><br>";
	 			}
	 		elseif (($n==17) or ($n==18) or ($n==19) or ($n==20) )
	 			{
	 			//оптовые картинки
	 			if (is_array($array[param]))
	 			{
	 			echo "<script>
	 			function Clear(n)
	 			{
	 			if (document.getElementById('new_img_load'+n).innerHTML!='')
	 				{
		 			document.getElementById('new_img_load'+n).innerHTML='<img src=\"https://i.oldbk.com/i/sh/wish_t333.gif\" border=1 height=\"60\" width=\"60\">';
		 			}
	 			}
	 				</script>";
	 			echo "<img id=\"loading\" src=\"loading.gif\" style=\"display:none;\">";

	 			echo "<table width=\"880\" align=\"center\" cellpadding=\"10\" cellspacing=\"0\">"; // нужная таблица

	 				foreach ($array[param] as $i => $v )
	 				{
	 				$itm=$PRICE[$v];

					if ($i==2)
						{
						echo "<tr valign=top>";
		 				echo "<form name=\"form2\" method=\"POST\" enctype=\"multipart/form-data\">";
		 				echo "<td align=left width=\"300\">";
						echo "<select name=masparam id=masparam2 onchange=\"Clear(2)\"><option value='$v'>$itm[desc]</option>";
						}
					elseif (($i==3) OR ($i==4) OR ($i==5) )
						{
						echo "<option value='$v'>$itm[desc]</option>";
						}
					elseif ($i==6)
						{
						echo "<option value='$v'>$itm[desc]</option>";
						echo "</select>";
		 				echo "</td><td align=center>";
		 				echo "<input id=\"fileToUpload2\" type=\"file\" size=\"20\" name=\"fileToUpload2\"  accept='image/gif' onchange=\"return ajaxFileUpload(2);\" style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'  >";
		 				echo "</td><td align=center>";
						echo "<div id=\"old_img2\"><img src='https://i.oldbk.com/i/sh/wish_t333.gif' border=1  width={$itm[w]}   height={$itm[h]}></div>
						<div id=\"new_img_load2\"></div>";
						echo "</td>";
		 				echo "</form>";
		 				echo "</tr>";
						}
					elseif ($i==7)
						{
						echo "<tr valign=top>";
		 				echo "<form name=\"form7\" method=\"POST\" enctype=\"multipart/form-data\">";
		 				echo "<td align=left>";
						echo "<select name=masparam id=masparam7 onchange=\"Clear(7)\"><option value='$v'>$itm[desc]</option>";
						}
					elseif ($i==8)
						{
						echo "<option value='$v'>$itm[desc]</option>";
						}
					elseif ($i==9)
						{
						echo "<option value='$v'>$itm[desc]</option>";
						echo "</select>";
		 				echo "</td><td align=center>";
		 				echo "<input id=\"fileToUpload7\" type=\"file\" size=\"20\" name=\"fileToUpload7\"  accept='image/gif' onchange=\"return ajaxFileUpload(7);\" style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'  >";
		 				echo "</td><td align=center>";
						echo "<div id=\"old_img7\"><img src='https://i.oldbk.com/i/sh/wish_t333.gif' border=1 width={$itm[w]}   height={$itm[h]}></div>
		 				<div id=\"new_img_load7\"></div>";
						echo "</td>";
		 				echo "</form>";
		 				echo " </tr>";
						}
						else
						{
						echo "<tr valign=top>";
		 				echo "<form name=\"form$i\" method=\"POST\" enctype=\"multipart/form-data\">";
		 				echo "<td align=left>";
						echo $itm[desc];
		 				echo "<input type=hidden name=masparam id=masparam$i  value='$v'>";
		 				echo "</td><td align=center width=\"300\">";
		 				echo "<input id=\"fileToUpload$i\" type=\"file\" size=\"20\" name=\"fileToUpload$i\"  accept='image/gif' onchange=\"return ajaxFileUpload($i);\" style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'  >";
		 				echo "</td><td align=center>";
		 				echo "<div id=\"old_img$i\"><img src='https://i.oldbk.com/i/sh/wish_t333.gif' border=1 width={$itm[w]}   height={$itm[h]}></div>";
		 				echo "<div id=\"new_img_load$i\"></div>";
		 				echo "</td>";
		 				echo "</form>";
		 				echo " </tr>";
						}
					}
	 			echo "</table>"; // нужная таблица закрылась

				echo "</td></tr></table>";
				echo  "<form id=\"form1\" name=\"form1\" method=get ><p>";
				echo "<input type=hidden name=act value='service'>
				<input type=hidden name=menu value='$n'>
			    	<center><input type=submit name=next value=' ПРОДОЛЖИТЬ ' class='button2';  ></center></p></form>
	  			";

				}
	 			}
	 		else if (($n==81) or ($n==82) )
	 			{
	 				if (is_array($array[param]))
	 				{
				echo "";
	 			echo "<img id=\"loading\" src=\"loading.gif\" style=\"display:none;\">";
	 				foreach ($array[param] as $i => $v )
	 					{
	 					$itm=$PRICE[$v];
	 					echo "<form name=\"form$i\" method=\"POST\" enctype=\"multipart/form-data\">";
						if ( $i==0) { echo "<br><b>Загрузите изображение Женского образа (*.gif) :</b> ";}
						if ( $i==1) { echo "<br><b>Загрузите изображение Мужского образа (*.gif) :</b> ";}
						//echo $itm[desc];
		 				echo "<input type=hidden name=masparam id=masparam$i  value='$v'>";
		 				echo "<input id=\"fileToUpload$i\" type=\"file\" size=\"20\" name=\"fileToUpload$i\"  accept='image/gif' onchange=\"return ajaxFileUpload($i);\" style='border: 1px solid #b0b0b0; background: #eaeaea;color:#323231; font-size: 11px;  height:18px;font-family:Tahoma;font-weight:bold;'  ><br><br>
						<div id=\"old_img$i\"><img src='https://i.oldbk.com/i/sh/wish_t333.gif' border=1 width={$itm[w]}   height={$itm[h]}></div>
		 				<div id=\"new_img_load$i\"></div>
		 				</form>";
		 				echo " <br><br>";
	 					}
 				echo "</td></tr></table>";
				echo  "<form id=\"form1\" name=\"form1\" method=get ><p>";
	 			echo "<br>";

				echo "<input type=hidden name=act value='service'>
				<input type=hidden name=menu value='$n'>
			    	<center><input type=submit name=next value=' ПРОДОЛЖИТЬ ' class='button2';  ></center></p></form>	";


	 				}
	 			}
	 		else
	 		if ($array[param])
	 			{
				$form_out.=$upload_form;
				$form_out.= "<form id=\"form1\" name=\"form1\" method=get ><p>";
	 			echo $form_out;
	 			echo "<br><br><br><b>{$array[param]}: &nbsp;&nbsp;</b>";

	 			if ($array[selectbox])
	 				{
	 				echo $array[selectbox];
	 				}
	 				else
	 				{
	 				echo "<input type=text size=20 name=param><br>";
	 				}

				echo "<input type=hidden name=act value='service'>
				<input type=hidden name=menu value='$n'>
				<br><br>
			    	<input type=submit name=next value=' ПРОДОЛЖИТЬ ' class='button2';  ></p></form>
			    	</td>
				</tr>
	  			</table>";
	 			}
	 		else
	 			{
				$form_out.=$upload_form;
				$form_out.= "&nbsp;	<form id=\"form1\" name=\"form1\" method=get ><p>";
	 			echo $form_out;
				echo "<input type=hidden name=act value='service'>
				<input type=hidden name=menu value='$n'>
				<br><br>
			    	<input type=submit name=next value=' ПРОДОЛЖИТЬ ' class='button2';  ></p></form>
			    	</td>
				</tr>
	  			</table>";
	 			}


	 	}
	else
		{
		return false;
		}

	}

function AdminShow_img($data,$act,$t)
	{
	global $PRICE, $user;
	global $EKR_TO_GOLD;
	echo "<tr>";
	echo "<td>Услуга:<b>".$PRICE[$data[type]][desc]."</b>   <i><b>{$data[mtime]}</b></i> ";
		if (($user=="Архитектор" or $user=='Bred' or $user=='Пресс-секретарь' ) AND ($t==2) )
			{
				echo "<a href='?act=look_img_prep&delete={$data['id']}'><img src='https://i.oldbk.com/i/clear.gif' title='Удалить' alt='Удалить'></a>";
			}
	echo " <br>";

	if ($data[group_id]>0)
	{
		if ( ($data[type]==81) OR ($data[type]==82) )
		{
			if ($t==3)
			{
			$pref='https://i.oldbk.com/i/shadow/';
			}
			else
			{
			$pref='uploadimg/';
			}

			$get_gr_img=mysql_query("select * from oldbk.com_service where  group_id='{$data[group_id]}'  ");
			while ($row=mysql_fetch_array($get_gr_img))
			{
				if ( ($row[param]==7) or ($row[param]==9))
				{
				//Ж
				 if (($t==1) or ($row['stat']!=2) )
				 	{
					$img_g=$row[img];
				 	}
				 	else
				 	{
					$img_g='g'.$row[img];
					}
				}
				elseif ( ($row[param]==107) or ($row[param]==109) )
				{
				//м
					if (($t==1) or ($row['stat']!=2))
					{
					$img_m=$row[img];
					}
					else
					{
					$img_m='m'.$row[img];
					}
				}
			}
			echo "<TABLE cellspacing=0 cellpadding=0>";
			echo "<tr>";
			echo "<td><i>Женский</i></td>";
			echo "<td>&nbsp;</td>";
			echo "<td><i>Мужской</i></td>";
			echo "</tr>";
			echo "<tr>";
			echo "<td><img src=".$pref.$img_g."></td>";
			echo "<td>&nbsp;</td>";
			echo "<td><img src=".$pref.$img_m."></td>";
			echo "</tr>";
			echo "</TABLE>";

		}
		else
		{
	//оптовые картинки для шмоток
	//выбираем все картинки этого ид_группы
	if ($t==3)
		{
		$pref='https://i.oldbk.com/i/sh/';
		}
		else
		{
		$pref='uploadimg/';
		}
	$img1="https://i.oldbk.com/i/w1.gif";
	$img2="https://i.oldbk.com/i/w2.gif";
	$img3="https://i.oldbk.com/i/w3.gif";
	$img4="https://i.oldbk.com/i/w4.gif";
	$img5="https://i.oldbk.com/i/w6.gif";
	$img6="https://i.oldbk.com/i/w6.gif";
	$img7="https://i.oldbk.com/i/w6.gif";
	$img8="https://i.oldbk.com/i/w9.gif";
	$img9="https://i.oldbk.com/i/w11.gif";
	$img10="https://i.oldbk.com/i/w10.gif";
	$img11="https://i.oldbk.com/i/w12.gif";


	$get_gr_img=mysql_query("select * from oldbk.com_service where  group_id='{$data[group_id]}'  ");
		while ($row=mysql_fetch_array($get_gr_img))
		{
			if (($row[param]==21) OR ($row[param]==36) OR ($row[param]==51) OR ($row[param]==66))
				{
				$img1=$pref.$row[img];
				}
			elseif (($row[param]==22) OR ($row[param]==37) OR ($row[param]==52) OR ($row[param]==67))
				{
				$img2=$pref.$row[img];
				}
			elseif ( (($row[param]>=23) AND ($row[param]<=27)) OR (($row[param]>=38) AND ($row[param]<=42)) OR (($row[param]>=53) AND ($row[param]<=57)) OR (($row[param]>=68) AND ($row[param]<=72))  )
				{
				$img3=$pref.$row[img];
				}
			elseif (  (($row[param]>=28) AND ($row[param]<=30) ) OR (($row[param]>=43) AND ($row[param]<=45) )  OR (($row[param]>=58) AND ($row[param]<=60) ) OR (($row[param]>=73) AND ($row[param]<=75)) )
				{
				$img4=$pref.$row[img];
				}
			elseif (($row[param]==1031) OR ($row[param]==1046) OR ($row[param]==1061) OR ($row[param]==1076) )
				{
				$img5=$pref.$row[img];
				}
			elseif ( ($row[param]==1131) OR ($row[param]==1146) OR ($row[param]==1161) OR ($row[param]==1176) )
				{
				$img6=$pref.$row[img];
				}
			elseif ( ($row[param]==1231) OR ($row[param]==1246) OR ($row[param]==1261) OR ($row[param]==1276) )
				{
				$img7=$pref.$row[img];
				}
			elseif ( ($row[param]==32) OR ($row[param]==47) OR ($row[param]==62) OR ($row[param]==77) )
				{
				$img8=$pref.$row[img];
				}
			elseif ( ($row[param]==33)  OR ($row[param]==48) OR ($row[param]==63) OR ($row[param]==78) )
				{
				$img9=$pref.$row[img];
				}
			elseif ( ($row[param]==34) OR ($row[param]==49)  OR ($row[param]==64) OR ($row[param]==79) )
				{
				$img10=$pref.$row[img];
				}
			elseif ( ($row[param]==35) OR ($row[param]==50)  OR ($row[param]==65) OR ($row[param]==80) )
				{
				$img11=$pref.$row[img];
				}

		}

	echo "
	<TABLE cellPadding=0 cellSpacing=0 width=100% border=0>
	  <TBODY>
	  <TR>
	    <TD align=left vAlign=top  style=\"width:250px;\">
      		<CENTER>
		<TABLE cellspacing=0 cellpadding=0>
	<TR>
	<TD valign=top>
	<TABLE width=196 cellspacing=0 cellpadding=0 ><tr><td valign=top>
	<TABLE width=100% cellspacing=0 cellpadding=0>
	<TR><TD ><img src=\"{$img1}\" width=60 height=20 ></a></TD></TR>
	<TR><TD  ><img src=\"{$img2}\" width=60 height=20 ></A></TD></TR>
	<TR><TD  ><img src=\"{$img3}\" width=60 height=60 ></A></TD></TR>
	<TR><TD ><img src=\"{$img4}\" width=60 height=80 ></a></TD></TR>
	<TR><TD><TABLE cellspacing=0 cellpadding=0><tr>
		<td ><img src=\"{$img5}\" width=20 height=20  ></A></td>
		<td ><img src=\"{$img6}\" width=20 height=20  ></A></td>
		<td ><img src=\"{$img7}\" width=20 height=20 ></A></td></tr></table>
	</TD></TR>
	</TABLE>
	</TD>
		<TD valign=top>
		<img src=\"https://i.oldbk.com/i/shadow/0.gif\" width=76 height=209 >
	</TD>
	<TD width=62 valign=top>
	<TABLE width=100% cellspacing=0 cellpadding=0>
	<TR><TD ><img src=\"{$img8}\" width=60 height=60 ></A></TD></TR>
	<TR><TD ><img src=\"{$img9}\" width=60 height=40 ></A></TD></TR>
	<TR><TD ><img src=\"{$img10}\" width=60 height=60 ></A></TD></TR>
	<TR><TD ><img src=\"{$img11}\" width=60 height=40 ></A></TD></TR>
	</TABLE></td></tr></table>
	</TD></TR>
	</TABLE></TABLE>";
		}
	}
	else
	 if ($data[img])
	 	{

	 	if ($t==3)
	 		{
	 		 if ( (($data[type]>=1) and ($data[type]<=4) ) OR  (($data[type]>=21) and ($data[type]<=80) ) OR ($data[type]==603) OR ($data[type]==602) OR ($data[type]==601) OR ($data[type]==600) OR ($data[type]==15) OR ($data[type]==16) )
	 		 	{
 		 	 	echo "<img src=https://i.oldbk.com/i/sh/$data[img]><br>";

	 		 	}
	 		 	else if (($data[type]==5) OR  ($data[type]==6) OR  ($data[type]==11) OR  ($data[type]==83) )
	 		 	{
	 		 	echo "<img src=https://i.oldbk.com/i/shadow/$data[img]><br>";
	 		 	}
	 		 	else if (($data[type]>=7) and  ($data[type]<=10))
	 		 	{
	 		 	 if ($data[param]=='Ж')
	 		 	 	{
	 		 	  	echo "<img src=https://i.oldbk.com/i/shadow/g$data[img]><br>";
	 		 	  	}
	 		 	  	else
	 		 	  	{
	 		 	  	echo "<img src=https://i.oldbk.com/i/shadow/m$data[img]><br>";
	 		 	  	}
	 		 	}
	 		 	else if ($data[type]==12 || $data[type] == 612)
	 		 	{
 		 	  	echo "<img src=https://i.oldbk.com/i/shadow/g$data[img]>";
 		 	  	echo "<img src=https://i.oldbk.com/i/shadow/m$data[img]><br>";
	 		 	}
	 		 	else if (($data[type]==90) OR ($data[type]==91))
	 		 	{
 		 	  	echo "<img src=https://i.oldbk.com/i/smiles/$data[img]><br>";
	 		 	}
	 		}
	 		else
	 		{
	 	 	echo "<img src=uploadimg/$data[img]><br>";
	 	 	}


	 	 		 		 if (($data[type]==603) OR ($data[type]==602) OR ($data[type]==601) OR ($data[type]==600)  )
	 	 		 		 {
 	 	 		 		 $otdels_array=array(	1=>'Кастеты,ножи',11=>'Топоры',12=>'Дубины,булавы',13=>'Мечи',14=>'Луки и арбалеты',	2=>'Сапоги',21=>'Перчатки',22=>'Легкая броня',23=>'Тяжелая броня',6=>'Плащи',24=>'Шлемы',	3=>'Щиты',	4=>'Серьги',41=>'Ожерелья',42=>'Кольца');
	 	 		 		 $get_old_img=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.gellery WHERE `id` = '".$data[param]."'  ;"));
	 	 		 		 echo "Старая картинка на ".$otdels_array[$get_old_img[otdel]]." <br>";
		  		 	 	echo "<img src=https://i.oldbk.com/i/sh/$get_old_img[img]><br>";
	 	 		 		 }


	 	}

	 if (($data[param]) and (!$data[group_id]) )
	 	{

	 		if ( (($data[type]>=11) and ($data[type]<=16) ) OR ($data[type]==83) OR ($data[type]==613) OR ($data[type]==614) )
	 			{
	 			 $link_img_old=AdminGetReloadImg($data[type],$data[param]);
	 			  if ($link_img_old)
	 			  	{
		 			if ($t !=3 ) { echo "<b>Старое изображение:</b><br>"; }
		 			echo "<img src=".$link_img_old." ><br>";
		 			}
	 			}
	 			else
	 			{
	 		 	echo "<b>".$PRICE[$data[type]][param].":</b>";
		 		echo $data[param];
			 	echo "<br>";
			 	}
	 	}

	if ($data[owner])
		{
	  	$img_telo=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$data[owner]."'  ;"));
		 echo "Персонаж: <b>{$img_telo[login]}</b><a href='http://capitalcity.oldbk.com/inf.php?{$data[owner]}' target=_blank><img src='https://i.oldbk.com/i/inf.gif'></a> ";
		}
	if ($data[target])
		{
	  	$img_telo_target=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users WHERE `id` = '".$data[target]."'  ;"));
		 echo "Подарок для персонажа: <b>{$img_telo_target[login]}</b><a href='http://capitalcity.oldbk.com/inf.php?{$data[target]}' target=_blank><img src='https://i.oldbk.com/i/inf.gif'></a> ";
		}


	if  ( ($data[group_id]>0) and ($data[group_id]!=$data[id]))
		{
		$pay_type[1]='Казна клана';
		$pay_type[2]='Банк игры';
		$pay_type[3]='За монеты:'.$data[dil];

		echo "Счет  №<b>SC".$data[group_id]."</b><br>";

		echo "<br><br></td></tr>";
		}
		else
		{
		$pay_type[1]='Казна клана';
		$pay_type[2]='Банк игры';
		$pay_type[3]='За монеты:'.$data[dil];

		if ($data['cost_type'] == 3) {
			echo "Счет  №<b>SC".$data[id]."</b>  - оплата: ".$pay_type[$data[cost_type]]."  - Сумма: <b>";

			if ($data['cost_gold']>0)
				{
				echo $data[cost_gold];
				}
				else
				{
				echo ($data[cost]*$EKR_TO_GOLD);
				}
			echo " монет</b> Эквивалент: ".$data[cost]." екр.<br>";

		} else {
			echo "Счет  №<b>SC".$data[id]."</b>  - оплата: ".$pay_type[$data[cost_type]]."  - Сумма: <b>".$data[cost]."</b> <br>";
		}
		if ($t==1) { echo "<a href=?act={$act}&yes={$data[id]}>Установить</a> | <a href=?act={$act}&no={$data[id]}>Отказать</a>"; }
		if (($t==2)and($data[mess]==0))  { echo "<a href=?act={$act}&yes={$data[id]}>Одобрить</a> | <a href=?act={$act}&no={$data[id]}>Отказать</a>"; }
		if (($user=="Архитектор" or $user=='Bred' ) AND ($t==2) )
			{
			echo "| <a href=?act={$act}&apay={$data[id]}>Оплатить</a> ";
			}
		if (($t==2)and($data[mess]>0))  { echo "<b>Одобрено - ожидается оплата!</b> "; }



		echo "<br><br></td></tr>";
		}
	}




function GetSuvenirID()
{
$item = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`eshop` WHERE `id` >='55600000' AND `id` <'55700000' ORDER BY id DESC LIMIT 1;"));
	if($item[id]>0)
	{
	$id=$item[id]+1;
	return $id;
	}
	else
	{
	echo "Не хватает свободных ИД Для добавления сувенира!";
	return false;
	}
}

function AdminGetReloadImg($m,$id)
{
	if (($m==11) OR ($m==83) )
		{
		$get_sh=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users_shadows  where id='{$id}' ;"));

		 if ($get_sh[id]>0)
		 	{
			return 'https://i.oldbk.com/i/shadow/'.$get_sh[name].'.gif';
			}
			else
			{
			return false;
			}
		}
	elseif ($m==12 || $m==612)
		{
		$get_sh=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.users_shadows  where id='{$id}' ;"));
		 if ($get_sh[id]>0)
	 	{
			if ($get_sh[sex]==0)
			{
			return 'https://i.oldbk.com/i/shadow/g'.$get_sh[name].'.gif';
			}
			else
			{
			return 'https://i.oldbk.com/i/shadow/m'.$get_sh[name].'.gif';
			}
		}
		else
			{
			return false;
			}
		}
	else if (($m==13) or ($m==14))
		{
		$get_sh=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.eshop  where id='{$id}'  ;"));
		 if ($get_sh[id]>0)
		 	{
			return 'https://i.oldbk.com/i/sh/'.$get_sh[img];
			}
			else
			{
			return false;
			}
		}
	else if ( $m==15 || $m==600 || $m==601)
		{
		$get_sh=mysql_fetch_assoc(mysql_query("SELECT * FROM gellery where  id='{$id}'  ;"));
		 if ($get_sh[id]>0)
		 	{
			return 'https://i.oldbk.com/i/sh/'.$get_sh[img];
		 	}
			else
			{
			return false;
			}
		}
	else if ( $m==16 || $m == 602 || $m==603)
		{
		$get_sh=mysql_fetch_assoc(mysql_query("SELECT * FROM gellery_prot where  id='{$id}'  ;"));
		 if ($get_sh[id]>0)
		 	{
			return 'https://i.oldbk.com/i/sh/'.$get_sh[img];
		 	}
			else
			{
			return false;
			}
		}
	else if ($m == 613 || $m==614)
		{
		$get_sh=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.inventory  where  id='{$id}'  ;"));
		 if ($get_sh[id]>0)
		 	{
			return 'https://i.oldbk.com/i/sh/'.$get_sh[img];
		 	}
			else
			{
			return false;
			}
		}
		else
		{
		return false;
		}

}

function pays_ico($ekr,$kazna,$vau,$dil,$rep)
{
/*
	if ($dil)
		{
		$out.='<img src="https://i.oldbk.com/i/pay_coins.png" title="Принимается оплата золотыми монетами" alt="Принимается оплата золотыми монетами"> ';
		}

	if ($ekr)
		{
		$out.='<img src="https://i.oldbk.com/i/pay_bank.png" title="Принимается оплата из Банка oldbk.com" alt="Принимается оплата из Банка oldbk.com"> ';
		}
	if ($kazna)
		{
		$out.='<img src="https://i.oldbk.com/i/pay_kazna.png" title="Принимается оплата из Клановой казны" alt="Принимается оплата из Клановой казны"> ';
		}
	if ($vau)
		{
		$out.='<img src="https://i.oldbk.com/i/pay_vau4.png" title="Принимается оплата Ваучерами Коммерческого отдела" alt="Принимается оплата Ваучерами Коммерческого отдела"> ';
		}

	if ($rep)
		{
		$out.='<img src="https://i.oldbk.com/i/pay_repa.png" title="Принимается оплата игровой репутацией" alt="Принимается оплата  игровой репутацией"> ';
		}
*/
	return $out;

}


function ShowVitrina($auch=false)
{
?>
<br>

<table width="885" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td height="145"><table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=mkpersonalart";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link1.jpg" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Боевая мощь Вашего персонажа значительно увеличится, когда Вы наденете свой личный Артефакт, созданный специально для Вас и по Вашим требованиям.<br>
<div align=center><?=pays_ico(0,0,0,1,1);?></div>
</td>
</tr>
</table></td>
<td>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "?act=mkchart";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_art_change.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Здесь Вы можете изменить Ваш личный Артефакт или поднять его уровень, сменить храмовый Артефакт на другой, а также обменять устаревший Артефакт созданный до 21.09.14.<br>
<div align=center><?=pays_ico(0,0,1,0,0);?></div>
</td>
</tr>
</table>
</td>
<td>
<?
/*
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=mkdart";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link33.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Вы можете вернуть свой личный или стандартный Артефакт, дабы затем сделать что-то другое.<br></td>
</tr>
</table>
*/
?>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=chruns";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link_runes.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Вы можете обменять свои руны на другие, но только если Ваши руны не ниже 5 уровня.<br>
<div align=center><?=pays_ico(1,0,0,1,0);?></div>
</td>
</tr>
</table>
</td>
</tr>
<tr>
<td height="145"><table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=persobraz";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link4.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Сделайте своего персонажа особенным, установив собственный яркий статичный или анимированный образ. Вы можете установить несколько образов, меняя их по желанию.<br>
<div align=center><?=pays_ico(1,0,0,1,0);?></div>
</td>
</tr>
</table></td>
<td>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=klanobraz";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link7.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Сделайте свой клан особенным, установив яркий и неповторимый клановый образ.<br>Женские и Мужские образы устанавливаются отдельно.<br>
<div align=center><?=pays_ico(1,1,0,0,0);?></div>
</td>
</tr>
</table>
</td>
<td>

<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=exunik";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_unik_change2.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Если Вы решили сменить свой комплект обмундирования или вышли на следующий уровень, здесь Вы сможете обменять свои старые уникальные и улучшенные уникальные вещи  на новые.<br>
<div align=center><?=pays_ico(1,1,0,0,0);?></div>
</td>
</tr>
</table>

</td>
</tr>

<tr>
<td height="145">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=persimgs";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link5.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Ваш персонаж станет уникальным, когда Вы установите на вещи собственные неповторимые статичные или анимированные картинки.<br>
Здесь же вы можете изменить внешний вид своего личного артефакта. <br>
<div align=center><?=pays_ico(1,0,0,1,0);?></div>
</td>
</tr>
</table>

</td>
<td>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=clanimgs";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link8.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Только Ваши соклановцы будут иметь право носить установленные клановые уникальные изображения вещей, тем самым, отличаясь от всех остальных.<br>
<div align=center><?=pays_ico(1,1,0,0,0);?></div>
</td>
</tr>
</table>
</td>
<td>


<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=persabil";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link11.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Сделайте свою игру более комфортной, установив личные Реликты, которые заменят многие свитки и дадут вашему персонажу дополнительные возможности.<br>
<div align=center><?=pays_ico(1,1,0,0,0);?></div>
</td>
</tr>
</table>

</td>
</tr>

<tr>
<td height="145">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=perspres";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link6.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Установите свой статичный или анимированный индивидуальный подарок или подарки, которыми распоряжаться сможете только Вы.<br>
<div align=center><?=pays_ico(1,0,0,1,0);?></div>
</td>
</tr>
</table>

</td>
<td>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=clanpres";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link9.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Создайте свой уникальный клановый подарок или подарки, которые смогут дарить друзьям от имени клана только Ваши соклановцы.<br>
<div align=center><?=pays_ico(1,1,0,0,0);?></div>
</td>
</tr>
</table>
</td>
<td>

<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=clansabil";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link17.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Клановые Реликты дадут дополнительный комфорт и удобство для всего Вашего клана, сэкономив время, заменив некоторые свитки и расширив игровые возможности. <br>
<div align=center><?=pays_ico(1,1,0,0,0);?></div>
</td>
</tr>
</table>


</td>
</tr>


<tr>
<td height="145">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=perssmile";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link13.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Добавьте своему персонажу индивидуальность, установив свои личные смайлы в чат, которыми сможете пользоваться в разговоре только Вы.<br></td>
</tr>
</table></td>
<td>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=clansmile";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link14.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Только Вы и Ваши соклановцы смогут пользоваться Вашими особенными клановыми смайлами, отправляя сообщения в чат.<br></td>
</tr>
</table>
</td>
<td>

<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=marservice";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
?>"><img src="i/cat_link_rings1.jpg" alt="" width="290" height="52"></a></td>

</td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Порадуйте себя и свою половинку уникальными изображениями обручальных колец в информации о персонажах. Подарите своему союзу неповторимость и красоту во всем.<br></td>
</tr>
</table>


</td></tr>



<tr><td height="145">
<?
/*
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52">			<a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=money";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link_mony.jpg" alt="" width="290" height="52"></a>
			</td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">
	Заработайте реальные деньги играя! За репутацию, полученную в игре, Вы можете приобрести купюры на валютном аукционе, которые здесь обменяют на реальные деньги.<br></td>
</tr>
</table>
*/
?>


<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=clanservice";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link10.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Здесь Вы можете изменить значок клана, сменить его склонность или название, или воспользоваться другими услугами, относящимися к кланам.<br></td>
</tr>
</table>

</td><td>

<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52">
			<a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=sendmess";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link15.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Если Вы не нашли необходимой услуги или хотите задать вопрос представителю Коммерческого отдела - воспользуйтесь услугами обратной связи, и представитель Ком.отдела постарается вам помочь.<br>
	</td>
</tr>
</table>


</td><td>

<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=other";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link12.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">При необходимости, Вы можете сменить пол, сбросить второй пароль, обменять или купить вещи и воспользоваться другими услугами.<br></td>
</tr>
</table>


</td></tr>

<?
/*
<tr><td height="145">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><br></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m"><br>
	</td>
</tr>
</table>
</td>
</tr>
<tr>
<td height="88" valign="top"></td>
</tr>
</table>

</td><td>

<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52">
			<a href="
			<? if ($auch) { echo "https://oldbk.com/commerce/index.php?act=sendmess";} else { echo "https://oldbk.com/commerce/index.php?act=needlogin";}
			?>"><img src="i/cat_link15.jpg" alt="" width="290" height="52"></a></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m">Если Вы не нашли необходимой услуги или хотите задать вопрос представителю Коммерческого отдела - воспользуйтесь услугами обратной связи, и представитель Ком.отдела постарается вам помочь.<br>
	</td>
</tr>
</table>
</td>
</tr>
<tr>
<td height="88" valign="top"></td>
</tr>
</table>

</td><td>
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52">
<table width="290" border="0" cellspacing="0" cellpadding="0">
<tr>
<td height="52"><br></td>
</tr>
<tr>
<td height="88" valign="top" class="cat_m"><br></td>
</tr>
</table>

</td>
</tr>

<tr>
<td height="88" valign="top"></td>
</tr>
</table>
*/
?>


</td></tr>
</table>
<br>


<?
}

function ShowPObraz($view=true)
{
global $PRICE;
?>
<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> ЛИЧНЫЕ ОБРАЗЫ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку личного образа своему или другому персонажу.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером 76х209<br>
- фон: прозрачный или серый в цвет инфы (#e2e0e0), либо фоновое изображение.<br>
- вес: статичного файла не более 40Кб, анимированного файла не более  80Кб</small>
<p><b style="color:#800000">Запрещены к установке:</b> образы низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой; уникальные и стандартные образы из бБК;<br>
не подходящие к тематике игры (исключение может быть сделано в случае, если образ по смыслу сочетается с ником  или названием клана)</p>
<p>После одобрения Администрацией, образ появится в Инвентаре >> вкладка Образ >> раздел Личные образы</p>
<p>Оплата с банковского счета происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены на счет.</p>

<p><b style="color:#800000">Примечание:</b><small> при установке личных образов Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с персонажа установившего «дубликат» картинка будет снята и ему будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>



<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. с Вашего счета в Банке] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] [</td><td><img src=https://i.oldbk.com/i/pay_sert_obraz.png border=0></td><td>сертификатом]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
 if ($view)
 {
 ?>
<form method=get id="mainform" >
<input type=hidden name="act" value="service">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">
<?
	if ($PRICE[5][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input type=radio name="menu"  value="5" class="tbl_inside"></td>
<td class="tbl_inside" ><b><? echo $PRICE[5][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[5]);?></b></td></tr>
<?	}

	if ($PRICE[6][desc])
	{
?>
<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
<input type=radio name="menu"  value="6" class="tbl_inside"></td>
<td class="tbl_inside" ><b><? echo $PRICE[6][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[6]);?></b></td></tr>
<?	}

	if ($PRICE[11][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input type=radio name="menu"  value="11" class="tbl_inside"></td>
<td class="tbl_inside" ><b><? echo $PRICE[11][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[11]);?></b></td></tr>
<?	}

	if ($PRICE[83][desc])
	{
?>
<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
<input type=radio name="menu"  value="83" class="tbl_inside"></td>
<td class="tbl_inside" ><b><? echo $PRICE[83][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[83]);?></b></td></tr>
<?	}
?>

	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>
<?
  }
}


function KlanObraz($view=true)
{
	global $user;
	global $PRICE;

	$us = check_users_city_datal($user);
	$isglava = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}
		}
	}

if ($PRICE[7])
	{
	?>
	<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> КЛАНОВЫЕ ОБРАЗЫ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку мужского или женского кланового образа для своего клана.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером 76х209<br>
- фон: прозрачный или серый в цвет инфы (#e2e0e0), либо фоновое изображение.<br>
- вес: статичного файла не более 40Кб, анимированного файла не более  80Кб</small>
<p><b style="color:#800000">Запрещены к установке:</b> образы низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой; уникальные и стандартные образы из бБК;<br>
не подходящие к тематике игры (исключение может быть сделано в случае, если образ по смыслу сочетается с названием клана)</p>
<p>После одобрения Администрацией, образ появится в Инвентаре >> вкладка Образ >> раздел Клановые образы</p>
<p>Оплата происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены в казну или, в случае с монетами, оплатившему их персонажу.</p>
<p><b style="color:#800000">Примечание:</b><small> при установке клановых образов Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с клана установившего «дубликат» картинка будет снята и ему в казну будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>

<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_kazna.png border=0></td><td> екр. с казны клана]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
if ($view)
	{
?>
	<form method=get id="mainform" >
	<input type=hidden name="act" value="service">
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

	<?
	if ($PRICE[7][desc])
	{
	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="7" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[7][desc];?> </b> </td><td width="150" align="center"><b> <? echo get_cost($PRICE[7]);?></b></td></tr>
	<?	}

	if ($PRICE[8][desc])
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="8" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[8][desc];?> </b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[8]);?></b></td></tr>
	<?	}

	if ($PRICE[81][desc])
	{
	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="81" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[81][desc];?></b> </td><td width="150" align="center"><b> <? echo get_cost($PRICE[81]);?></b></td></tr>
	<?	}

	if ($PRICE[9][desc])
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="9" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[9][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[9]);?></b></td></tr>
	<?	}

	if ($PRICE[10][desc])
	{
	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="10" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[10][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[10]);?></b></td></tr>
	<?	}

	if ($PRICE[82][desc])
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="82" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[82][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[82]);?></b></td></tr>
	<?	}

	if ($PRICE[12][desc] && $isglava)
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="12" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[12][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[12]);?></b></td></tr>
	<?	}


	if ($PRICE[612][desc] && $isglava)
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input type=radio name="menu"  value="612" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[612][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[612]);?></b></td></tr>
	<?	}

	?>

	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>

	<?
	  }
	}
	else
	{
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
	</tr>
	</table>
	<?

	}

}


function MarServ($view=true)
{
global $PRICE;


if ($PRICE[500])
	{
	?>
	<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000">ЛИЧНЫЕ КАРТИНКИ ОБРУЧАЛЬНЫХ КОЛЕЦ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете изменить внешний вид своих свадебных колец.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером от 30 до 60 px по ширине и 30 px по высоте.<br>
- фон: прозрачный или серый в цвет инфы (#e2e0e0), либо фоновое изображение с рамкой.<br>
- вес: статичного файла не более 5Кб, анимированного файла не более  10Кб</small>
<p><b style="color:#800000">Запрещены к установке:</b> картинки низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой;</p>

<b style="color:#800000">Примечание:</b><br>
При разводе установленные картинки пропадают. При повторном заключении того же брака потребуется новая установка. <br>
Установить две картинки обручальных колец для одного и того-же персонажа невозможно.<br>
При повторной установке картинки, предыдущая картинка аннулируется. <br><br>
После одобрения Администрацией, личное изображение колец появится в информации о персонаже.<br><br>

<p><b style="color:#800000">Примечание:</b><small> при установке обручальных колец Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с персонажа установившего «дубликат» картинка будет снята и ему будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>

<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
	<?
	global $user;
	$us = check_users_city_datal($user);

	if ($us['married'] > 0) {
	if ($view) {

	?>
	<form method=get id="mainform" >
	<input type="hidden" name="act" value="service">
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

	<?
	for ($i = 500; $i < 505; $i++) {
	if ($PRICE[$i][desc])
	{
	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
	<input name="menu" value="<? echo $i;?>" type="radio" class="tbl_inside"></td>
	</td>
	<td class="tbl_inside"><b><? echo $PRICE[$i][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[$i]);?></b></td></tr>
	<?	}
	}
	?>

	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center"></td>
	<td ></td>
	<td width="150" align="center"></td></tr>

	</table><br><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>	<BR><BR><BR>
	<?
	}
	} else {
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ПЕРСОНАЖАМ СОСТОЯЩИМ В БРАКЕ</b></td>
	</tr>
	</table>
	<?
	}
	}

}


function ClanServ($view=true)
{
global $PRICE;


if ($PRICE[101])
	{
	?>
	<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> КЛАНОВЫЕ УСЛУГИ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете изменить внешний вид своего клана.</center><br>
<div align=center><b style="color:#800000">Процесс обработки заявки:</b> После подачи заявки, представитель коммерческого отдела свяжется с Вами в течение 5ти дней.<br>
Ответ на заявку и указания по дальнейшим действиям и оплате будет дан телеграфом в Игре и продублирован на Ваш email.<br><br>
<?
	if(time()>mktime(17,0,1,11,29,2016) && time()<mktime(23,59,59,6,4,2016)) {
		echo "<font color=red>На время действия акции «Свобода выбора» услуга смены склонности бесплатна.</font><br>";
	}
?>
</div>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
	<?
	if ($view) {

	global $user;
	$us = check_users_city_datal($user);
	$isglava = false;
	if (strlen($us['klan'])) {
		$q = mysql_query('SELECT * FROM oldbk.clans WHERE short = "'.$us['klan'].'"');
		$kk = mysql_fetch_assoc($q);
		if ($kk) {
			if ($us['id'] == $kk['glava']) {
				$isglava = true;
			}
		}
	}

	?>
	<form method=post id="mainform" >
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

	<?
	if ($PRICE[100][desc] && $isglava)
	{
	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[100][desc];?>" type="radio" class="tbl_inside">
	</td>
	<td class="tbl_inside"><b><? echo $PRICE[100][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[100]);?></b></td></tr>
	<?	}

	if ($PRICE[101][desc] && $isglava && $kk['base_klan'] == 0)
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[101][desc];?>" type="radio" class="tbl_inside">
	</td>
	<td class="tbl_inside"><b><? echo $PRICE[101][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[101]);?></b></td></tr>
	<?	}

	if ($PRICE[102][desc] && $isglava)
	{
	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[102][desc];?>" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[102][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[102]);?></b></td></tr>
	<?	}

	if ($PRICE[103][desc])
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[103][desc];?>" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[103][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[103]);?></b></td></tr>
	<?	}


	if ($PRICE[105][desc] && $isglava && $kk['rekrut_klan'] == 0 && $kk['base_klan'] == 0)
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[105][desc];?>" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[105][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[105]);?></b></td></tr>
	<?	}

	if ($PRICE[106][desc] && $isglava && $kk['rekrut_klan'] > 0)
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[106][desc];?>" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[106][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[106]);?></b></td></tr>
	<?	}


	if ($isglava && $kk['base_klan'] > 0)
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input name="services" value="Отсоединить клан-основу" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b>Отсоединить клан-основу</b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[106]);?></b></td></tr>
	<?	}


	?>
	<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center"></td>
	<td ></td>
	<td width="150" align="center"></td></tr>

	</table><br><br><br>

	<center><b>Введите email адрес для связи:</b>&nbsp;&nbsp; <input id="comemail" name="comemail" value="<?=$_SESSION['usrmail'];?>" type="text"></center><br><br>







	<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
	</tr>
	<tr>
	<td class="cont_bg">
	<center>
	<b style="color:#800000"> Добавьте комментарии к заявке:</b><br><br>
	<textarea name="comment" style="width: 705px;" rows="6" id="commentarea"></textarea>
	</center>
	</td></tr>
	<tr>
	<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
	</tr>
	</table>
	<br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ОТПРАВИТЬ ЗАЯВКУ</a></center>
	</form>
	<br>	<br>
	<?
	  }
	}
	else
	{
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
	</tr>
	</table>
	<?
	}


}

function MoneyOut()
{
global $user;

	$minimalka=50; // минимальная сумма вывода

?>
<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> ВЫВОД ДЕНЕЖНЫХ СРЕДСТВ ИЗ ИГРЫ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на вывод денежных средств из Игры.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к выводу средств:</b><br>
<small>
- активный игровой персонаж выше 8го уровня не в блоке и не в хаосе<br>
- наличие WMZ кошелька<br>
- минимальная сумма для вывода денег 50$ </small>

<p><b style="color:#800000">Понятие активного игрового персонажа:</b><br>
<small>Активный игровой персонаж - игрок проведший не менее 250 активных боев за последние 30 дней.<br>Активными боями считаются все бои КРОМЕ: <br>- боев в БС<br>
- боев в Руинах<br>
- боев в Лабиринте<br>
- боев на Ристалище<br>
- боев с квестовыми Загородными ботами</small>

<p><b style="color:#800000">Ограничения по выводу средств:</b><br>
<small>- после выхода из блока вывод средств невозможен в течение 60 дней<br>
- после выхода из первого в истории персонажа хаоса/блока за ДВП вывод средств невозможен в течение 6 месяцев<br>
- при наличии в истории персонажа более одного хаоса/блока за ДВП вывод средств невозможен<br>
- при наличии наказания за ЧР в истории персонажа вывод средств невозможен<br>
<b>Примечание:</b> <br>
К наказанию за ДВП (денежно-вещевую прокачку) приравниваются наказания за нарушения законов «О денежно-вещевой прокачке»,  «О сделках», а так же наказания за отказ сотрудничать с паладинами по делам, связанным с переводами персонажа.</small>


<p><b style="color:#800000">Условия установки WMZ кошелька:</b><br>
<small>- кошелек для персонажа устанавливается один раз в этом же разделе<br>
-  WMID и номер кошелька уникален для каждого персонажа. Если такой WMID и номер кошелька уже указан кем-либо в игре, установить его нельзя<br>
- для установки кошелька необходим загруженный и подтвержденный скан паспорта, который можно загрузить в "Инвентаре" в разделе "Безопасность". После загрузки скана необходимо обратиться
к любому Паладину с красным или белым крестом для подтверждения загруженного скана</small></p>

<p><b style="color:#800000">Условия смены WMZ кошелька:</b><br>
<small>- изменить установленный WMZ кошелек можно в разделе <a href=https://oldbk.com/commerce/index.php?act=other target=_blank>"Прочие услуги"</a> в Коммерческом отделе, указав вескую причину смены номера WMZ кошелька<br>
- если Ваш номер WMZ кошелька занят другим персонажем, освободить его можно в разделе <a href=https://oldbk.com/commerce/index.php?act=sendmess target=_blank>"Обратная связь"</a> в Коммерческом отделе, дав подробные объяснения ситуации</small></p>



<p><b style="color:#800000">Примечание:</b><br>
<small>
После подачи заявки, сотрудники Ком.отдела проводят проверку баланса переводов Вашего персонажа, что означает необходимость свести баланс со всеми персонажами, в т.ч. кланом, супругом (вне зависимости от факта покупки этими персонажами еврокредитов у официальных дилеров ОлдБК) и не иметь открытых сделок.
В противном случае Вам может быть отказано в выводе денежных средств. В случае отказа по заявке, вложенные купюры возвращаются в полном объеме. Причина отказа приходит телеграфом персонажу и отображается в разделе "Мои заявки"<br>


В случае подтверждения заявки, денежные средства переводятся на указанный WMZ кошелек в срок до 14 дней с момента одобрения заявки.</small><br><br></p>

<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_real.gif border=0> </td><td>денежные купюры] &nbsp;&nbsp;&nbsp;</td></tr></table>

</td></tr></table>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>




<?
			$us = check_users_city_datal($user);
			$ekr_kurs=mysql_fetch_assoc(mysql_query("select * from oldbk.variables where var='ekrbonus'"));

			$ekr_kurs['value']=((int)((1/(1+$ekr_kurs['value']))*100))/100;


			if ($us['level']<9)
			{
				echo "<font color=red><b>Вывод средств доступен персонажам выше 8-го уровня!</b></font>";
			}
			elseif ($us['align']==4)
			{
				echo "<font color=red><b>Вывод средств не доступен персонажам в хаосе!</b></font>";
			}
			else
			{
			//проверка wmz
			$wmz=mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`users_money`  WHERE `owner` = '{$us['id']}' LIMIT 1;"));
			//проверка активных  боев -за 30 дней - чистка данных 1 раз в сутки в кроне - держится инфа за последние 30 дней
			$active_battle=mysql_fetch_array(mysql_query("select owner, sum(val) as val from oldbk.active_battle where owner='{$us['id']}' ;"));
			//проверка хаоса блока за последние 60 дней
			$get_chaos=mysql_fetch_array(mysql_query("select * from oldbk.lichka where pers='{$us['id']}' and ( text like '%наложил заклятие смерти %' OR text like '%отправил в хаос%'   ) and `date` > UNIX_TIMESTAMP()-5184000 LIMIT 1"));

			if ($get_chaos['id']>0)
				{
				echo "<font color=red><b>Вы не можете подать заявку на вывод денег, поскольку в течение последних 60 дней находились в блоке или хаосе.<br> Подождите необходимое время и приходите снова.</b></font>";
				}
			else
			//если астивных боев меньше 250
			if ($active_battle['val']<250)
				{
				echo "<center><table ><tr><td><font color=red><b>
				Вы не можете подать заявку на вывод денег, поскольку за последние 30 дней Вы провели менее 250 активных боев. <br> Доведите свою игровую активность до необходимого уровня и приходите снова.<br><br>
				Активными боями считаются все бои КРОМЕ: <br>- боев в БС<br>- боев в Руинах<br>- боев в Лабиринте<br>- боев на Ристалище<br>- боев с квестовыми Загородными ботами<br><br>
				На данный момент вам не хватает ".(250-$active_battle['val'])." активных боев.</b></font></b></font><br><br></td></tr></table></center>";
				}
			else
			//если бан
			if (($wmz['owner']>0) AND ($wmz['ban']>0))
				{
				if ($wmz['bantime'] > 0) {
					echo "<font color=red><b>Вам запрещен вывод средств до ".date("d.m.Y H:i:s",$wmz['bantime'])."!</b></font>";
				} else {
					echo "<font color=red><b>Вам запрещен вывод средств!</b></font>";
				}
				}
			elseif (($wmz['owner']>0) AND ($wmz['wmz']!=$wmz['owner']) )
			{
			//есть кошель
			$view_form=true;

				if ($_POST['outmoneyids'])
					{
					$ids = explode(",",$_POST['outmoneyids']);
					if (count($ids) > 0 && !empty($ids[0]))
						{
							while(list($k,$v) = each($ids))
							{
							$ids[$k] = intval($v);
							}

							$us = check_users_city_datal($user);
							$q = mysql_query('SELECT * FROM inventory WHERE (owner = '.$us['id'].' AND (setsale=0 and (prototype in (5001,5002,5003,5005,5010,5015,5020,5025)))) AND id IN('.implode(",",$ids).') ');
							$ekrnum = 0;
							$ekrids = array();
							$useditems = "";

							while($i = mysql_fetch_assoc($q))
							{
								$useditems .= get_xitem_fid($i).",";

								if ($i['prototype'] == "5025") {
									$ekrnum += 25;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5020") {
									$ekrnum += 20;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5015") {
									$ekrnum += 15;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5010") {
									$ekrnum += 10;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5005") {
									$ekrnum += 5;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5003") {
									$ekrnum += 3;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5002") {
									$ekrnum += 2;
									$ekrids[] = $i['id'];
								} elseif ($i['prototype'] == "5001") {
									$ekrnum += 1;
									$ekrids[] = $i['id'];
								}


							}

							if ($ekrnum < $minimalka)
							{
							echo "<font color=red>";
							echo "Сумма купюр должна быть ".$minimalka." $ или больше";
							echo "</font>";
							} else
							{
							// всё ок - начинаем
							//echo $useditems;
							$itmsids=substr($useditems,0,strlen($useditems)-1);

								if (!empty($_SERVER['HTTP_CLIENT_IP']))   //check ip from share internet
									{
									$ip=$_SERVER['HTTP_CLIENT_IP'];
									}
									elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']))   //to check ip is pass from proxy
									{
									$ip=$_SERVER['HTTP_X_FORWARDED_FOR'];
									}
									else
									{
									$ip=REMIP;
									}

										$q = mysql_query('START TRANSACTION') or die();
										//создаем запись о выводе
										mysql_query("INSERT INTO `oldbk`.`com_money` SET `owner`='{$us['id']}',`msum`='{$ekrnum}',`stat`=-1,`outwmz`='{$wmz['wmz']}',`logids`='{$itmsids}' , `logip`='{$ip}' , `kof`='{$ekr_kurs['value']}' ;");
										$zapid=mysql_insert_id();
										$wmzsum=round(($ekrnum*$ekr_kurs['value']),2);
										$rec = array();
							    			$rec['owner']=$us['id'];
										$rec['owner_login']=$us['login'];
										$rec['owner_balans_do']=$us['money'];
										$rec['owner_balans_posle']=$us['money'];
										$rec['target_login'] = "КО";
										$rec['item_id']=$itmsids;
										$rec['type'] = 414; //тип - запрос на вывод средств
										$rec['sum_ekr'] = $ekrnum;
										$rec['add_info']='Заявка №WM'.$zapid.' , на WMZ:'.$wmz['wmz'].' Cумма:'.$wmzsum.'WMZ';
										if (add_to_new_delo($rec) === FALSE) die();

									// сносим купюры- в коллектор onwer 453  с пометкой ид заказа на вывод в поле battle - по этому полу будем делать возврат если надо
									mysql_query('UPDATE oldbk.inventory  set owner=453, battle='.$zapid.'  WHERE id IN ('.implode(",",$ekrids).')') or die();
									//mysql_query('DELETE FROM oldbk.inventory WHERE id IN ('.implode(",",$ekrids).')') or die();

									$q = mysql_query('COMMIT') or die();
									echo "<font color=red>";

									echo "<center>Вы отправили запрос на вывод средств на сумму <b>".$ekrnum." $ OldBK => ".$wmzsum." WMZ</b>.<br>После проверки и одобрения коммерческим отделом сумма будет зачислена на ваш WMZ кошелек:".$wmz['wmz']."</center><br>";
									echo "</font>";
									$view_form=false;
									echo "<center><br><br><a href='/commerce/' class=button2> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a><br></center>";

							///////////////////////////////////////////////
							}


					}
					}



			}
			else
			{

					//проверка скана
					$get_scan=mysql_fetch_array(mysql_query("select * from oldbk.users_scans  WHERE `owner` = '{$us['id']}' and status=1 LIMIT 1;"));

					if ($get_scan['id']>0)
					{

					if (($_POST['savewmz']) AND ($_POST['mywmz']))
					{
					$twm=explode("Z",$_POST['mywmz']);
					$twmn=$twm[1];
					if ((preg_match("/^[0-9]{12,12}$/",$twmn))  AND ($_POST['mywmz'][0]=='Z') )
						{
					 	$mywmz='Z'.$twmn;
					 	$getwmid=get_wmid_from_wmz($mywmz); //запрашиваем ВМид по кошельку
					 	if ($getwmid)
							{
//							echo $getwmid;
								mysql_query("INSERT INTO `oldbk`.`users_money` SET `owner`='{$us[id]}',`wmz`='{$mywmz}' , `wmid`='{$getwmid}'  ;");
								if (mysql_affected_rows()>0)
								{
								$msg='<center>Ваш WMZ-кошелек:'.$mywmz.' WMID:'.$getwmid.' Удачно сохранен!</center>';
								$wmz['wmz']=$mywmz;
								$wmz['wmid']=$getwmid;
								$view_form=true;
								}
								else
								{
								$msg='<center>Ошибка ввода WMZ-кошелька. Такой кошелек или WMID уже существует в системе!</center>';
								}
							}
							else
							{
							$msg='<center>Ошибка проверки WMID или WM-кошелек с указанным номером в системе не зарегистрирован!</center>';
							}

						}
					else
						{
						$msg='<center>Ошибка ввода WMZ-кошелька, неподходящий формат!<br>Внимание у Вас не установлен WMZ-кошелек!</center>';
						$stop=1;
						}
					}
					else
					{
					$msg='<center>Внимание у Вас не установлен WMZ-кошелек!';
					$stop=1;
					}
					}
					else
					{
					$msg='<center>Внимание у Вас не установлен WMZ-кошелек!<br>Для установки кошелька необходим подтвержденный скан документа, подтверждающий вашу личность!<br> Загрузить скан можно в "Инвентаре" в разделе "Безопасность".</center>';
					$stop=2;
					}
				if ($msg)
					{
					echo "<font color=red>";
					echo $msg;
					echo "</font>";
					}

						if ($stop==2)
							{
							$ii=0;
							$get_scan2=mysql_query("select * from oldbk.users_scans  WHERE `owner` = '{$us['id']}' ;");
							while($d = mysql_fetch_assoc($get_scan2))
							{
							$ii++;
							$f = explode('_',$d['filename']);
							$st = "";
							if ($d['status'] == 0) $st = "В обработке";
							if ($d['status'] == 1) $st = "Подтверждён";
							if ($d['status'] == 2) $st = "Отклонён";

								$inf_scan=" Cкан документа от:<b>".date("d/m/Y H:i:s",$f[1])."</b> Статус: <b>".$st."</b>.<br>";
							}
							 if ($inf_scan) echo "<br>".$inf_scan;
							}
							elseif ($stop==1)
							{
							echo "<br>";
							/*
							echo "<div align=left>Для Вывода средств необходимо указать Ваш WMZ - кошелек. <br>
								&nbsp;&nbsp;&nbsp;<u>Условия заполнения:</u><br>
								&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. Кошелек на <b>одного персонажа вписывается один раз</b>. Изменить его можно только через <a href='https://oldbk.com/commerce/index.php?' target=_blank>коммерческий отдел </a>, с указанием веской причины смены номера WMZ-кошелька.<br>
								&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. Если  вводимый Вами номер кошелека <b>уже существует в игре ввести его нельзя</b>. В таком случае если нужен именно этот кошелек надо обратиться через форму обратной свзязи <a href='https://oldbk.com/commerce/index.php?' target=_blank>коммерческого отдела </a> с объяснениями.</div>";
							*/
							echo "<FORM METHOD=POST>";
							echo "<center><br>Введите Ваш WMZ-кошелек <small>(в формате: Z123456789101)</small>:<input type=text size=16 MAXLENGTH=13 name=mywmz><input type=submit name=savewmz value='Сохранить' class='button2'></center>";
							echo "</FORM>";

							}
			}
			}

			if ($view_form)
			{
			echo '<div align=center><b>Ваш WMZ-кошелек: '.$wmz['wmz'].'</b> WMID:'.$wmz['wmid'].'</div><br>';

			echo "<div align=center>Минимальная сумма для вывод денежных средств <font color=red>{$minimalka}$</font> </b></div>";

			echo '
			<style>
			#snaptarget { height: 140px; background-color:#f2efe8;width:700px;border: 4px; border-style:double; border-color: #908869;}
			</style>
			<div align=center><b>Курс: 1$ OldBK = '.$ekr_kurs['value'].' WMZ</b></div>
			<center>Заявка на сумму: <span id="ekrnum" style="font-weight:bold;">0 $ OldBK => 0 WMZ</span><br><br>

			<div id="allconstr">
				<div id="snaptarget">
					Переместите купюры на необходимую сумму
				</div><br><form id="outmoney" method="POST">
				<input type="hidden" id="outmoneyids" name="outmoneyids" value="">
				<input type=hidden name="paymethod" value="5">
				<input type="button" value="Подать запрос на вывод" class="button2"  OnClick="CheckF();"><br><br>
			';


			echo '</form>';

			$ids = array();

			$q = mysql_query('SELECT * FROM inventory WHERE owner = '.$us['id'].' AND (setsale=0 and (prototype in (5001,5002,5003,5005,5010,5015,5020,5025))) ORDER BY ecost DESC');

			if (mysql_num_rows($q) > 0) {
				while($i = mysql_fetch_assoc($q)) {
					$ids[] = $i['id'];
					echo '<span name="prot'.$i['prototype'].'" style="display:inline-block;" id="drag'.$i['id'].'"> <img alt="'.$i['name'].'" title="'.$i['name'].'" src="https://i.oldbk.com/i/sh/'.$i['img'].'"> </span> ';
				}

				echo '
				<script>
				var spans = [];
				var ekrnum = 0;
				var bprice = 0;
				var ekrkurs =  '.$ekr_kurs['value'].';
				var wmzsum = 0;
				var needekr = '.$minimalka.';

				function CheckF() {
					if (spans.length == 0) {
						alert("Вы ничего не положили");
						return;
					}
					if (needekr > ekrnum) {
						alert("Сумма купюр должна быть "+needekr+" $ или больше");
						return;
					}
					if (confirm("Вы уверены?")) {
						document.getElementById("outmoney").submit();
					}

				}

				$("#allconstr span" ).draggable({ containment: "#allconstr", scroll: false});
				$("#allconstr span" ).bind( "dragstop", function(event, ui) {
					spans.splice(0,spans.length);


					$("#allconstr span").each(function(index,item) {
						m = $("#allconstr").offset().top;

						if (($(item).offset().top-m) < ($("#snaptarget").height()-$(item).height())) {
							spans.push(item);
						}
					});

					ekrnum = 0;
					wmzsum=0;

					var ids = new Array();

					for (key in spans) {
						var n = spans[key];
						itemid = n.id;
						itemid = itemid.substring(4);
						itemproto = $("#"+n.id).attr("name");
						itemproto = itemproto.substr(4);
						ids.push(itemid);


						if (itemproto == "5025") {
							ekrnum += 25;
						} else if (itemproto == "5020") {
							ekrnum += 20;
						} else if (itemproto == "5015") {
							ekrnum += 15;
						} else if (itemproto == "5010") {
							ekrnum += 10;
						} else if (itemproto == "5005") {
							ekrnum += 5;
						} else if (itemproto == "5003") {
							ekrnum += 3;
						} else if (itemproto == "5002") {
							ekrnum += 2;
						} else if (itemproto == "5001") {
							ekrnum += 1;
						}
					}
					document.getElementById("outmoneyids").value = ids.join();

					wmzsum=ekrnum*ekrkurs;

					document.getElementById("ekrnum").innerHTML = ekrnum+" $ OldBK => "+wmzsum.toFixed(2)+" WMZ";

				});
				</script>';
			} else {
				echo '<script>function CheckF() {alert("У вас нет купюр.");}</script>У вас нет купюр.';
			}
			echo '</div></center></div>';

			}





}

function OtherServ($view=true)
{
global $PRICE;
global $user;
global $ny_events;
global $start_volna,$end_volna;

	if ((time()>$ny_events['nghaosstart']) and (time()<$ny_events['nghaosend'])) {
		$PRICE[221][cost] = 0;
	}

	if ((time()>$ny_events['hbhaosstart']) and (time()<$ny_events['hbhaosend'])) {
		$PRICE[221][cost] = 0;
	}

	if ((time()>$start-volna) and (time()<$end_volna)) {
		$PRICE[221][cost] = 0;
	}


if ($PRICE[203])
	{
	?>
	<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> УСЛУГИ КОММЕРЧЕСКОГО ОТДЕЛА </b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете воспользоваться дополнительными услугами коммерческого отдела.</center>

<table align=center><tr align=left><td>


<p><b style="color:#800000">Экспресс проверка на чистоту:</b> Ускоренная паладинская проверка, которая дает экономию времени и возможность пройти проверку до достижения 7-го уровня.</p>

<p><b style="color:#800000">Смена главы клана:</b> Возможна при участии ком.отдела в случае, если действующий глава клана находится в блоке или
не заходил в Игру более 3х месяцев. Для смены главы, клану будет необходимо провести процедуру выборов нового кандидата.<br>
Представитель ком.отдела даст Вам полную информацию о том, что необходимо сделать.</p>



<p><b style="color:#800000">Восстановление клана :</b> После расформирования клана (при неуплате налога), клан подлежит восстановлению в течение 30 дней после расформирования.
Подать заявку на восстановление может только бывший Глава клана. При восстановлении клана, в клан автоматически возвращаются все персонажи, состоявшие в нем на момент расформирования,
если к моменту восстановления они не состоят в других кланах или не имеют личной склонности.
Основа и рекруты считаются отдельными кланами (каждый со своей отдельной заявкой). После восстановления основа и рекруты не имеют между собой связи.
По истечению 30 дней после расформирования, клан восстановлению не подлежит.</p>
</p>
<p>После подачи заявки представитель ком.отдела свяжется с Вами в течение 5ти дней.<br>
Ответ на заявку и указания по дальнейшим действиям и оплате будет дан телеграфом в игре и продублирован на Ваш email.</p>

<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td>
<td><img src=https://i.oldbk.com/i/pay_kazna.png border=0></td><td> с екр. казны клана] &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0> </td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></td></tr></table>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
	<?

	$us = check_users_city_datal($user);
	$q = mysql_query('SELECT * FROM oldbk.com_requests WHERE charid = '.$us['id'].' and `comment` NOT LIKE "%<font color=red>%" AND status = "" LIMIT 3');
	if (mysql_num_rows($q) >= 3) {
		echo '<center><b style="color:#800000">У Вас уже есть три неподтверждённые заявки, ожидайте ответа.</b></center>';
		return;
	}


	if ($view)
	{
	?>
	<form method=post id="mainform" >
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

	<?
	if ($PRICE[104][desc])
	{
	?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
	<input name="services" value="<? echo $PRICE[104][desc];?>" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[104][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[104]);?></b></td></tr>
	<?
	}

	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for ($ii=203;$ii<=228;$ii++)
	{
	if ($ii==210) continue;
		if ($PRICE[$ii][desc])
	      {


		if ($ii == 224)
		{
		echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"><input OnClick="document.forms[0].submit();" name="services" value="Обмен Плащей (мф)" type="radio" class="tbl_inside"></td>';
		}
		elseif ($ii == 226)
		{
		echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"><input OnClick="document.forms[0].submit();" name="services" value="Обмен футболок (мф)" type="radio" class="tbl_inside"></td>';
		}
		else
		if ($ii == 211 || $ii == 221 || $ii == 223  || $ii == 225  ) {
			echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"><input OnClick="document.forms[0].submit();" name="services" value="'.$PRICE[$ii][desc].'" type="radio" class="tbl_inside"></td>';
		} else {
			echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center"><input name="services" value="'.$PRICE[$ii][desc].'" type="radio" class="tbl_inside"></td>';
		}

/*
		if ($ii==211 || $ii == 207 || $ii == 204 || $ii == 203 || $ii == 214 || $ii == 201 || $ii == 221 || $ii == 205 || $ii == 206 || $ii == 223 || $ii == 224 || $ii == 225  ) {
		      echo '<td class="tbl_inside"><font color=green><b>'.$PRICE[$ii][desc].'</font></b></td><td width="150" align="center"><b>';
		} else
		*/
		if ($ii == 224)
		{
		      echo '<td class="tbl_inside"><b>Обмен Плащей (мф)</b></td><td width="150" align="center"><b>';
		}
		elseif ($ii == 226)
		{
		      echo '<td class="tbl_inside"><b>Обмен футболок (мф)</b></td><td width="150" align="center"><b>';
		}
		else
		{
		      echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b></td><td width="150" align="center"><b>';
		}
		if (($ii == 211)||($ii == 226)||($ii == 227)||($ii == 224))  {
		      echo "цена варьируется";
		}else if ($ii == 228)  {
		      echo $PRICE[$ii]['cost'];
		      echo " $";
		}
		else {
		      echo get_cost($PRICE[$ii]);
		}
	      echo '</b></td></tr>';

	      if ($c==1) {$c=2;} else {$c=1;}

		}
	}

	?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td ></td>
	<td width="150" align="center"></td></tr>
	</table><br><br><br>

	<center><b>Введите email адрес для связи:</b>&nbsp;&nbsp; <input id="comemail" name="comemail" value="<?=$_SESSION['usrmail'];?>" type="text"></center><br><br>




	<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
	</tr>
	<tr>
	<td class="cont_bg">
	<center>
	<b style="color:#800000"> Добавьте комментарии к заявке:</b><br><br>

	<textarea name="comment" style="width: 705px;" rows="6" id="commentarea"></textarea>
	</center>
	</td></tr>
	<tr>
	<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
	</tr>
	</table>
	<br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ОТПРАВИТЬ ЗАЯВКУ</a></center>
	</form>
	<br>	<br>
	<?
	  }
	}

}


function PersAbil($view=true)
{
global $PRICE, $EKR_TO_GOLD;
global $user;
$pst = 301;
$pse = 317;

$remove_abil = array(314,305);

$us = check_users_city_datal($user);

	if ($us['level']<8)
	{
	$remove_abil[]=313;
	$remove_abil[]=315;
	$remove_abil[]=316;
	$remove_abil[]=317;
	}

?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg"><center><b style="color:#800000"> ЛИЧНЫЕ РЕЛИКТЫ</b></center></td></tr>

<tr><td class="text1 cont_bg"><br>Здесь Вы можете установить себе личные реликты.<br>

			<div align=center>
			<b style="color:#800000">Правила покупки:</b> После покупки одного или нескольких пакетов личных реликтов, они появятся в Вашей <img src=https://i.oldbk.com/i/images/bdalign_6.jpg border=0><img src=https://i.oldbk.com/i/images/bdalign_2.jpg border=0><img src=https://i.oldbk.com/i/images/bdalign_3.gif border=0><img src=https://i.oldbk.com/i/images/bdalign_0.jpg border=0> панели склонностей
			<br>в разделе личных реликтов.<br>
			<p>Личные реликты доступны Вам, как между боями, так и во время боя (если это боевые реликты).<br>Использование личных реликтов экономит Вам слоты в бою и сокращает время на поиски необходимых встроек и свитков в Инвентаре.</p>
			<p>Личные реликты не имеют требований и срока годности и ограничены только купленным количеством.</p>
			</div>



			<br>			<br>			<br>
			<div align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></div>

</td>
</tr>

<tr>
<td valign="top" class="cont_dwn" height="18"></td>
</tr>
</table>
<br><br>
<?
$view2 = false;

if ($_SERVER['REQUEST_METHOD'] == "POST") {
	$view = false;
	$view2 = true;
	//исключение абилок
	foreach ($remove_abil as $_abil_id_) {
		if(isset($_POST['price_'.$_abil_id_])) {
			unset($_POST['price_'.$_abil_id_]);
		}
		if(isset($PRICE[$_abil_id_])) {
			unset($PRICE[$_abil_id_]);
		}
	}
}

if ($view2) {
	if (isset($_POST['pricev_'.$pst])) {
		// вбили что хотим купить, показываем форму на перетаскивание ваучеров
		$sum = 0;

		for($ii=$pst;$ii<=$pse;$ii++) {
			$sum += intval($_POST['price_'.$ii])*$PRICE[$ii][cost];
		}

		if ($sum > 0) {
			echo '<center>Ваш заказ на сумму: <b>'.$sum.'</b> екр. </center><br><br>';
			$BANKS='';

					$get_bank=mysql_query("select * from oldbk.bank where owner='{$us['id']}' ");
					if (!(mysql_num_rows($get_bank) > 0) )
						{
						echo '<font color=red>У вас нет доступных банковских счетов!</font>';
						}
					else
					{
								$BANKS="<select style='width:150px' name=bankid>";
								while($row = mysql_fetch_assoc($get_bank))
								{
								$BANKS.="<option>".$row['id']."</option>";
								}
								$BANKS.="</select>";
					}
								echo '
								<center><br>

								<div id="allconstr">
									<br><form id="persabil" method="POST"><input type="hidden" id="persabilids" name="persabilids" value=""> ';

									echo '<table>';

							if ($BANKS!='')	{ echo '<tr><td><input type="radio" name="paytype" value="0"></td><td><font color=red><b>'.$sum.' екр</font></b> Банковский счет: '.$BANKS.' пароль <input type=password size=8 name=bankpass></td></tr>'; }
									echo '<tr><td><input type="radio" name="paytype" value="1"></td><td><font color=red><b>'.round(($sum*$EKR_TO_GOLD)*0.9).' монет (с учетом скидки 10%)</font></b> (в наличии <b>'.$us['gold'].'</b> монет)</td></tr></table><br>';

								echo '<input type="button" value="КУПИТЬ РЕЛИКТЫ" class="button2" OnClick="CheckF();"><br>';

								for($ii=$pst;$ii<=$pse;$ii++) {
									echo '<input type=hidden name="price_'.$ii.'" value="'.$_POST['price_'.$ii].'">';
								}

								echo '</form>

								<script>
										function CheckF() {
										if (confirm("Вы уверены?")) {
											document.getElementById("persabil").submit();
										}

									}
								</script>
								';

								$ids = array();

								echo '</div></center></div>';

		} else {
			echo 'Вы ничего не выбрали для заказа.';
		}

	}
	if (isset($_POST['persabilids']) && isset($_POST['paytype']) ) {
		$sum = 0;
		for($ii=$pst;$ii<=$pse;$ii++) {
			$sum += intval($_POST['price_'.$ii])*$PRICE[$ii][cost];
		}
		if ($sum > 0) {
				$good = true;
				$us = check_users_city_datal($user);
				if ( (($_POST['bankpass']=='') OR ($_POST['bankid']=='') ) AND ($_POST['paytype']==0) )
				{
				serr("Вы не указали пароль от банковского счета!");
				$view = true;
				$good=false;
				}
				elseif ($_POST['paytype']==0)
				{
					$bankid=(int)($_POST['bankid']);
					$bankpas=$_POST['bankpass'];
					$bank=mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.`bank` WHERE `owner` = '".$us['id']."' AND `id`= '".$bankid."' AND `pass` = '".md5($bankpas)."';"));
					if ($bank[id]>0)
					{
						if (($bank['ekr']) < $sum)
						{
						serr("Суммы на вашем счету недостаточно для совершения операции. Необходимая сумма ".$sum." екр.");
						$view = true;
						$good=false;
						}
					}
					else
					{
					serr('Ошибка! Не верный пароль от банковского счета!');
					$view = true;
					$good=false;
					}
				}
				elseif ($_POST['paytype']==1)
				{
					$needm = round(($sum*$EKR_TO_GOLD)*0.9);
					if ($us['gold'] < $needm) {
						serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
						$view = true;
						$good = false;
					}
				}
				else
				{
				serr("Ошибка параметров!");
				$view = true;
				$good = false;
				}


										if ($good)
										{
										// всё ок - начинаем
										$rec = array();
							    			$rec['owner']=$us[id];
										$rec['owner_login']=$us[login];
										$rec['owner_balans_do']=$us['money'];
										$rec['owner_balans_posle']=$us['money'];
										$rec['target_login'] = "КО";
										$rec['item_id']=substr($useditems,0,strlen($useditems)-1);

										for($ii=$pst;$ii<=$pse;$ii++)
										{
											$r = intval($_POST['price_'.$ii]);
											if ($r > 0)
											{
												$add_info_txt.=$PRICE[$ii]['desc'].' - '.($r*$PRICE[$ii]['kol']).' шт.;';
											}
										}

										$rec['type'] = 1281;
										$rec['add_info']=$add_info_txt;

										$q = mysql_query('START TRANSACTION') or die();

										if ($_POST['paytype']==0)
											{
												$get_bank=mysql_query("SELECT * FROM oldbk.`bank` WHERE `id`= '".$bank[id]."' AND owner='{$us['id']}'  AND ekr>=".$sum."  FOR UPDATE ;");
												if (!(mysql_num_rows($get_bank) > 0) )
												{
												die();
												}
												else
												{
												$bank = mysql_fetch_assoc($get_bank);
												mysql_query("UPDATE `oldbk`.`bank` SET `ekr` = `ekr` - '{$sum}' WHERE `id`= '{$bank['id']}' and owner='{$us['id']}'  ");
												//  пишем в хистори банка
												$bank['ekr']-=$sum;
												mysql_query("INSERT INTO `oldbk`.`bankhistory`(`date`, `text` , `bankid`) VALUES ('".time()."','Покупка личных риликтов на сумму:<b>{$sum} екр.</b>, <i>(Итого: ".($bank['cr'])." кр., {$bank['ekr']} екр.)</i>','{$bank['id']}');");
												}


											$rec['sum_ekr']=$sum;
											$rec['bank_id']=$bank['id'];
											}
											elseif ($_POST['paytype']==1)
											{
												if ($needm > 0) {
													mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - ".$needm." WHERE `id`= '{$us['id']}'") or die(mysql_error());
													$us['gold'] -= $needm;
													$rec['add_info'].=':'.$us['gold'].':'.$needm;
												}
												else
												{
													die();
												}


											}
											else
											{
												die();
											}




										if (add_to_new_delo($rec) === FALSE) die();


										echo '<table  align="center" cellpadding="0" cellspacing="0" class="tbl_inside"><tr bgcolor="#f4f2e9"><td><br><b style="color:#800000">Вы удачно купили личные реликты:</b><br><br>';
										for($ii=$pst;$ii<=$pse;$ii++) {
											$r = intval($_POST['price_'.$ii]);
											if ($r > 0) {

											if ($PRICE[$ii]['eshopid']>0)
											{
											//не абилка а свиток или предмет
											$itm = mysql_query('select * from oldbk.eshop where id = '.$PRICE[$ii]['eshopid']) or die();
											$dress  = mysql_fetch_array($itm);

													for($kk=1;$kk<=($r*$PRICE[$ii]['kol']);$kk++) //нужное кол-во
														{
														//делаем инсерт
														mysql_query("INSERT INTO oldbk.`inventory`
														(`prototype`,`owner`,`name`,`type`,`massa`,`cost`,`ecost`,`img`,`maxdur`,`isrep`,`nclass`,
														`gsila`,`glovk`,`ginta`,`gintel`,`ghp`,`gnoj`,`gtopor`,`gdubina`,`gmech`,`gfire`,`gwater`,`gair`,`gearth`,`glight`,`ggray`,`gdark`,`needident`,`nsila`,`nlovk`,`ninta`,`nintel`,`nmudra`,`nvinos`,`nnoj`,`ntopor`,`ndubina`,`nmech`,`nfire`,`nwater`,`nair`,`nearth`,`nlight`,`ngray`,`ndark`,
														`mfkrit`,`mfakrit`,`mfuvorot`,`mfauvorot`,`bron1`,`bron2`,`bron3`,`bron4`,`maxu`,`minu`,`magic`,`nlevel`,`nalign`,`dategoden`,`goden`,
														`otdel`,`gmp`,`gmeshok`, `group`,`letter`, `ab_mf`,`ab_bron`,`ab_uron`,`sowner`,`present`
														)
														VALUES
														('{$dress['id']}','{$us['id']}','{$dress['name']}','{$dress['type']}',{$dress['massa']},{$dress['cost']},{$dress['ecost']},'{$dress['img']}',{$dress['maxdur']},{$dress['isrep']},'{$dress['nclass']}','{$dress['gsila']}','{$dress['glovk']}','{$dress['ginta']}','{$dress['gintel']}','{$dress['ghp']}','{$dress['gnoj']}','{$dress['gtopor']}','{$dress['gdubina']}','{$dress['gmech']}','{$dress['gfire']}','{$dress['gwater']}','{$dress['gair']}','{$dress['gearth']}','{$dress['glight']}','{$dress['ggray']}','{$dress['gdark']}','{$dress['needident']}','{$dress['nsila']}','{$dress['nlovk']}','{$dress['ninta']}','{$dress['nintel']}','{$dress['nmudra']}','{$dress['nvinos']}','{$dress['nnoj']}','{$dress['ntopor']}','{$dress['ndubina']}','{$dress['nmech']}','{$dress['nfire']}','{$dress['nwater']}','{$dress['nair']}','{$dress['nearth']}','{$dress['nlight']}','{$dress['ngray']}','{$dress['ndark']}',
														'{$dress['mfkrit']}','{$dress['mfakrit']}','{$dress['mfuvorot']}','{$dress['mfauvorot']}','{$dress['bron1']}','{$dress['bron2']}','{$dress['bron3']}','{$dress['bron4']}','{$dress['maxu']}','{$dress['minu']}','{$dress['magic']}','{$dress['nlevel']}',
														'{$dress['nalign']}','".(($dress['goden'])?($dress['goden']*24*60*60+time()):"")."','{$dress['goden']}'
														,'{$dress['razdel']}','{$dress['gmp']}','{$dress['gmeshok']}','{$dress['group']}','{$dress['letter']}','{$dress['ab_mf']}','{$dress['ab_bron']}','{$dress['ab_uron']}','{$us['id']}','Коммерческий отдел'
														);
														") or die();
														$insert_id[$kk]=mysql_insert_id();
														}

														$dressid="cap".implode(',cap',$insert_id);
														//пишем в дело
														$rec['owner']=$us['id'];
														$rec['owner_login']=$us['login'];
														$rec['target']=0;
														$rec['target_login']='КО';
														$rec['type']=1140;
														$rec['sum_kr']=0;
														$rec['sum_ekr']=($r*$PRICE[$ii]['cost']);
														$rec['sum_kom']=0;
														$rec['item_id']=$dressid;
														$rec['item_name']=$dress['name'];
														$rec['item_count']=($r*$PRICE[$ii]['kol']);
														$rec['item_type']=$dress['type'];
														$rec['item_cost']=$dress['cost'];
														$rec['item_dur']=$dress['duration'];
														$rec['item_maxdur']=$dress['maxdur'];
														if ($_POST['paytype']==1)
															{
															$rec['add_info']='Покупка из Коммерческого отдела - оплата монетами:'.$us['gold'].':'.$needm;
															}
															else
															{
															$rec['bank_id']=$bank['id'];
															$rec['add_info']='Покупка из Коммерческого отдела - оплата екр';
															}
														add_to_new_delo($rec);


											}
											else
											{

												mysql_query('
													INSERT INTO oldbk.users_abils (owner,magic_id, allcount, findata)
													VALUES(
														"'.$us['id'].'",
														"'.$PRICE[$ii]['magid'].'",
														"'.($r*$PRICE[$ii]['kol']).'",
														"0"
													) ON DUPLICATE KEY UPDATE
														`allcount` = `allcount` + '.($r*$PRICE[$ii]['kol'])
												) or die();
											}

												echo $PRICE[$ii]['desc'].' - '.($r*$PRICE[$ii]['kol']).' шт.<br>';

											}
										}
										echo '<br><br>';

										if ($_POST['paytype']==1)
										{
										echo 'Всего на сумму <b>'.$needm.' монет.</b><br>';
										}
										else
										{
										echo 'Всего на сумму <b>'.$sum.' екр.</b><br>';
										}


										echo '<br></td></tr></table>';
										echo '<br><br><br><center><a href="/commerce/" class="button2"> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br><br>';
										$q = mysql_query('COMMIT') or die();
										}
										else
										{
										$view = true;
										serr("Ошибка оплаты!");
										}


		} else {
			$view = true;
			serr("Ошибка суммы оплаты!");

		}
	}
	elseif (isset($_POST['persabilids']) )
	{
		$view = true;
		serr("Укажите способ оплаты!");

	}

}

if ($view) {
?>

<script>

function CalcAll() {
	d = document;
	sum = 0;
	for (i = <?php echo $pst;?>; i <= <?php echo $pse;?>; i++) {
		if(d.getElementById("pricet_"+i)) {
			sum += parseFloat(d.getElementById("pricet_"+i).innerHTML);
		}
	}
	d.getElementById("calcsum").innerHTML = "<b>"+sum+"</b>";
}

function OnPChange(t) {
	d = document;
	val = d.getElementById("price_"+t);
	if (val) {
		val = parseFloat(val.value);
		if (val > 0) {
			p = d.getElementById("pricev_"+t).value;
			sum = val * p;
			d.getElementById("pricet_"+t).innerHTML = sum;
		} else {
			d.getElementById("pricet_"+t).innerHTML = 0;
		}
	}
	CalcAll();
}
</script>
<form method=post id="mainform" >
<input type=hidden name="act" value="persabil">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">
		<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
		<td align=center><b style="color:#800000">Название пакета реликтов</b></td>
		<td align=center><b style="color:#800000">Цена</b></td>
		<td align=center><b style="color:#800000">Купить пакетов</b></td>
		<td align=center><b style="color:#800000">Сумма к оплате</b></td>
		</tr>


	<?
	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for($ii=$pst;$ii<=$pse;$ii++)
	{
		if(in_array($ii, $remove_abil)) {
			continue;
		}
		?>
		<tr bgcolor="<?php echo $co[$c];?>"><td width="25" height="25" align="center">
		<td class="tbl_inside"><b><? echo $PRICE[$ii][desc];?> (пакет из <?php echo $PRICE[$ii][kol] ?>шт.)</b></td>
		<td align="center"><b><? echo $PRICE[$ii][cost];?> екр</b></td>
		<td align="center"><input type="hidden" name="pricev_<?php echo $ii; ?>" id="pricev_<?php echo $ii; ?>" value="<? echo $PRICE[$ii][cost];?>"><input size=5 value=0 onkeyup="OnPChange(<?php echo $ii; ?>);" name="price_<?php echo $ii; ?>" type=text id="price_<?php echo $ii; ?>"></td>
		<td align="center"><div id="pricet_<?php echo $ii; ?>">0</div></td>
		</tr>
		<?
		if ($c==1) {$c=2;} else {$c=1;}
	}
	?>

	<tr bgcolor="#f9f7ee">
	<td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td align=center></td>
	<td align=center><b style="color:#800000">Итого к оплате:</b></td>
	<td width="150" align="center"><div id="calcsum">0</div></td>
	</tr>

	</table><br><br>
	<center><a href='#'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center><br><br>
	</form>
<?
	}


}


function ClansAbil($view=true)
{
global $PRICE , $EKR_TO_GOLD;
$remove_abil = array(314,305);

unset($PRICE[314]); // кланам не выдаются свитки
if ($_POST['price_314']) die();

$glava_test= mysql_fetch_assoc(mysql_query("SELECT * FROM oldbk.clans WHERE `glava` = '".$_SESSION['uid']."'  ;"));
 if (($PRICE[300][desc]) and ($glava_test[id]>0))
 {
global $user;
$pst = 301;
$pse = 317;

	foreach ($remove_abil as $_abil_id_) {
		if(isset($_POST['price_'.$_abil_id_])) {
			unset($_POST['price_'.$_abil_id_]);
		}
		if(isset($PRICE[$_abil_id_])) {
			unset($PRICE[$_abil_id_]);
		}
	}

?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> КЛАНОВЫЕ РЕЛИКТЫ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете установить клановые реликты для Вашего клана.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Правила покупки:</b> После покупки одного или нескольких пакетов клановых реликтов, они появятся в Вашей <img src=https://i.oldbk.com/i/clan.gif border=0> клановой панели
<br>в разделе "Клановые реликты". Глава клана должен выставить права соклановцам на использование покупных реликтов.<br>
<p>Клановые реликты доступны Вам, как между боями, так и во время боя (если это боевые реликты).
<br>Использование клановых реликтов экономит Вам слоты в бою и сокращает время на поиски необходимых встроек и свитков в Инвентаре.</p>
<p>Клановые реликты не имеют требований и срока годности и ограничены только купленным количеством. <br>Если Ваш клан имеет рейтинговые реликты, то покупные реликты добавятся к рейтинговым.<br>
При использовании реликтов, в первую очередь тратятся рейтинговые реликты, а уже затем покупные. </p>


<table align=left border=0>
				<tr valign=middle>
				<td>Возможные способы оплаты:  &nbsp;&nbsp;[ </td>
						<td><img src=https://i.oldbk.com/i/pay_kazna.png border=0></td>
						<td>списать екр. из клановой казны] &nbsp;&nbsp;&nbsp;[ </td>
						<td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td>
						<td> оплата золотыми монетами]</td>
				</tr>
			</table>
			<br>			<br>			<br>
			<div align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></div>
</td></tr></table>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br><?
$view2 = false;

if ($_SERVER['REQUEST_METHOD'] == "POST") {
	$view = false;
	$view2 = true;
}

if ($view2) {

	if (($_POST[paymethod]==1) OR ($_POST[paymethod]==3))
		{
//print_r($_POST);
		// вбили что хотим купить, показываем форму на перетаскивание ваучеров
		$sum = 0;

		for($ii=$pst;$ii<=$pse;$ii++) {
			$sum += intval($_POST['price_'.$ii])*$PRICE[$ii][cost];
		}

		if ($sum > 0) {

			if (($_POST[paymethod]==1) and ($PRICE[300][klan]) )
			{
			$view_caznapass=true;
				if (($_POST[kaznapass]) OR ($_SESSION['kaznapass']))
			  	{
			  	if (isset($_SESSION['kaznapass'])) {$klan_pass=$_SESSION['kaznapass']; } else {$klan_pass=$_POST[kaznapass]; }

					 if ($glava_test[id]>0)
						{
						$kaznadata = mysql_fetch_array(mysql_query("SELECT * FROM oldbk.`clans_kazna` WHERE `clan_id` = '".$glava_test[id]."' AND `ekr_pass`= '".mysql_real_escape_string($klan_pass)."' ;"));
					  	 if ($kaznadata[clan_id]>0)
						 	{
						  	$_SESSION['kaznapass']=$kaznadata[ekr_pass];
							$view_caznapass=false;

								if ($_POST[userpay])
									{
									//снимаем деньги
									mysql_query("UPDATE oldbk.clans_kazna set ekr=ekr-{$sum}  WHERE `clan_id` = '{$kaznadata[clan_id]}' and ekr>={$sum} ;");
										if (mysql_affected_rows()>0)
 			     	  						{
	      		  					 		// записать в дело казны
								        	$txt="Оплата из клан казны, ".$sum." екр. за услуги Коммерческого отдела: \"Покупка клановых абилити\".";
								           	mysql_query("INSERT INTO oldbk.`clans_kazna_log` (`method` ,`ktype`, `clan_id`, `owner`, `target`, `kdate`)   VALUES  ('2','2','{$kaznadata[clan_id]}','{$glava_test[id]}','".$txt."','".time()."');");
      	  							 		echo '<center><table  align="center" cellpadding="0" cellspacing="0" class="tbl_inside"><tr bgcolor="#f4f2e9"><td><br><b style="color:#800000">Вы удачно купили клановые реликты:</b><br><br>';
			           						for($ii=$pst;$ii<=$pse;$ii++)
			           						{
											$r = intval($_POST['price_'.$ii]);
										if ($r > 0)
											{
											//для админов пишем счетчик сколько купили
										       mysql_query("UPDATE `oldbk`.`abil_shop` SET `allbuy`=`allbuy`+'".($r*$PRICE[$ii]['kol'])."' WHERE `magic`='{$PRICE[$ii]['magid']}';");
	        						           	       $fin_date=time(); //врема вокупки
								           	       mysql_query("INSERT INTO oldbk.abil_buy_clans SET `klan_id`='{$glava_test[id]}',`klan_name`='{$glava_test[short]}' ,`magic_id`='{$PRICE[$ii]['magid']}',`findata`='{$fin_date}' , `all_count`='".($r*$PRICE[$ii]['kol'])."' ON DUPLICATE KEY UPDATE `findata`='{$fin_date}' , `all_count`=`all_count`+'".($r*$PRICE[$ii]['kol'])."' ; ");
									       	       //тут добавить инсерт и апдейт в клан_абилс
								           	       // для основной выборки надо с 0 значениями
								           	       mysql_query("INSERT IGNORE oldbk.`clans_abil`  (`klan`, `magic`, `count`,`maxcount`) values ('{$glava_test[short]}','{$PRICE[$ii]['magid']}',0,'0') ;");
								           	      // mysql_query("INSERT IGNORE avalon.`clans_abil`  (`klan`, `magic`, `count`,`maxcount`) values ('{$glava_test[short]}','{$PRICE[$ii]['magid']}',0,'0') ;");
								           	    //   mysql_query("INSERT IGNORE angels.`clans_abil`  (`klan`, `magic`, `count`,`maxcount`) values ('{$glava_test[short]}','{$PRICE[$ii]['magid']}',0,'0') ;");
											echo "<b>".$PRICE[$ii]['desc'].' - '.($r*$PRICE[$ii]['kol']).' шт.</b><br>';
											}
										}

										echo '<br></td></tr></table>';
										echo '<br><br><br><a href="/commerce/" class="button2"> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br><br>';
									 	unset($_SESSION['kaznapass']);
      	  				 					}
	      	  					 			else
      			  					 		{
	      		  					 		echo "<center><b style=\"color:#800000\">Ошибка при оплате!</b></center><br>";
      	  						 			}
									}
								else
									{
									echo "<center><form method=post>";
									echo '<br>Ваш заказ на сумму: <b>'.$sum.'</b> екр. <br><br>';
									for($ii=$pst;$ii<=$pse;$ii++)
									{
									echo '<input type=hidden name="price_'.$ii.'" value="'.$_POST['price_'.$ii].'">';
									}
									echo '<input type=hidden name="paymethod" value="1">';
									echo "<b>В клановой казне:{$kaznadata['ekr']} екр.</b><br>";
									echo "<BR><BR><BR>";
									if ($sum<$kaznadata['ekr'])
										{
										echo "<input type=submit name='userpay' value='КУПИТЬ РЕЛИКТЫ' class='button2'; >";
										}
										else
										{
										echo "<b>НЕДОСТАТОЧНО СРЕДСТВ ДЛЯ ОПАЛТЫ</b>";
										}

									echo "</form></center>";
									}

							}
							else
							{
							echo "<center><b>Ошиба входа в казну, неверный пароль!</b></center>";
							}
						}
						else
						{
						echo "<center><b>Ошибка входа в казну, Вы не глава клана!</b></center>";
						}
					}

			if ($view_caznapass)
				{
				echo "<center><form method=post>";
				for($ii=$pst;$ii<=$pse;$ii++)
					{
					echo '<input type=hidden name="price_'.$ii.'" value="'.$_POST['price_'.$ii].'">';
					}
				echo '<input type=hidden name="paymethod" value="1">';
				echo "<fieldset style=\"width:300px; height:130px;\">";
				echo "<legend><b>Войти в клановую казну</b></legend><BR>";
				echo "<BR> &nbsp; Пароль от екровой казны клана: <input type=password name=kaznapass size=16>";
				echo "<BR><BR><BR>";
				echo "<center><input type=submit name='enter' value='ВОЙТИ' class='button2'; >";
				echo "</form></fieldset>";
				}
			}
			else
			if (($_POST[paymethod]==3) and ($PRICE[300][ekr]) and empty($_POST['clansabilids']) )
			{

				$needm = round(($sum*$EKR_TO_GOLD)*0.9);
				echo '<center>Ваш заказ на сумму: <b>'.$sum.'</b> екр. оплата (с учетом скидки 10%) <font color=red>'.$needm.'</font> монет<br><br>';
				$us = check_users_city_datal($user);
				echo 'У Вас в наличии: <b>'.$us['gold'].'</b>  монет.</center>';
					if ($us['gold'] < $needm)
					{
						serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
					}
					else
					{
						echo '<center><br>
								<div id="allconstr">
								<br><form id="clansabil" method="POST">
								<input type="hidden" id="clansabilids" name="clansabilids" value="Yes">
								<input type=hidden name="paymethod" value="3">
								<input type="button" value="КУПИТЬ РЕЛИКТЫ" class="button2" name="купить реликты" OnClick="CheckF();"><br>';

								for($ii=$pst;$ii<=$pse;$ii++)
								{
								echo '<input type=hidden name="price_'.$ii.'" value="'.$_POST['price_'.$ii].'">';
								}
								echo '</form>
								<script>
										function CheckF() {
										if (confirm("Вы уверены?")) {
											document.getElementById("clansabil").submit();
										}

									}
								</script>
								';
								echo '</div></center></div>';
					}

			}//форма



		} else {
	 		echo "<center><b style=\"color:#800000\">Вы ничего не выбрали для заказа!</b></center><br>";
		}


	if ( (isset($_POST['clansabilids']) ) and ($PRICE[300][ekr]) and ($_POST[paymethod]==3) )
	{
		$sum = 0;

		for($ii=$pst;$ii<=$pse;$ii++) {
			$sum += intval($_POST['price_'.$ii])*$PRICE[$ii][cost];
		}
		if ($sum > 0)
		{
		$needm = round(($sum*$EKR_TO_GOLD)*0.9);
		$us = check_users_city_datal($user);

										if (($us['gold'] < $needm) OR ($needm<=0) )
										{
										serr("Недостаточно монет для совершения операции. Необходимая сумма ".($needm)." монет.");
										$view = true;
										}
										else
										{
										// всё ок - начинаем
										$q = mysql_query('START TRANSACTION') or die();

										mysql_query("UPDATE `oldbk`.`users` SET `gold` = `gold` - ".$needm." WHERE `id`= '{$us['id']}'") or die(mysql_error());

										$rec = array();
							    			$rec['owner']=$us[id];
										$rec['owner_login']=$us[login];
										$rec['owner_balans_do']=$us['money'];
										$rec['owner_balans_posle']=$us['money'];
										$rec['target_login'] = "КО";
										$rec['item_id']=substr($useditems,0,strlen($useditems)-1);;
										$rec['type'] = 1284;
										$us['gold'] -= $needm;
										$rec['add_info']='Покупка из Коммерческого отдела - оплата монетами:'.$us['gold'].':'.$needm;
										if (add_to_new_delo($rec) === FALSE) die();


										echo '<table  align="center" cellpadding="0" cellspacing="0" class="tbl_inside"><tr bgcolor="#f4f2e9"><td><br><b style="color:#800000">Вы удачно купили клановые реликты:</b><br><br>';
										for($ii=$pst;$ii<=$pse;$ii++) {
											$r = intval($_POST['price_'.$ii]);
											if ($r > 0)
											{
											//для админов пишем счетчик сколько купили
										       mysql_query("UPDATE `oldbk`.`abil_shop` SET `allbuy`=`allbuy`+'".($r*$PRICE[$ii]['kol'])."' WHERE `magic`='{$PRICE[$ii]['magid']}';");
								           	       $fin_date=time(); //врема вокупки
								           	       mysql_query("INSERT INTO oldbk.abil_buy_clans SET `klan_id`='{$glava_test[id]}',`klan_name`='{$glava_test[short]}' ,`magic_id`='{$PRICE[$ii]['magid']}',`findata`='{$fin_date}' , `all_count`='".($r*$PRICE[$ii]['kol'])."' ON DUPLICATE KEY UPDATE `findata`='{$fin_date}' , `all_count`=`all_count`+'".($r*$PRICE[$ii]['kol'])."' ; ");
									       	       //тут добавить инсерт и апдейт в клан_абилс
								           	       // для основной выборки надо с 0 значениями
								           	       mysql_query("INSERT IGNORE oldbk.`clans_abil`  (`klan`, `magic`, `count`,`maxcount`) values ('{$glava_test[short]}','{$PRICE[$ii]['magid']}',0,'0') ;");
								           	       //mysql_query("INSERT IGNORE avalon.`clans_abil`  (`klan`, `magic`, `count`,`maxcount`) values ('{$glava_test[short]}','{$PRICE[$ii]['magid']}',0,'0') ;");
					       			           	       //mysql_query("INSERT IGNORE angels.`clans_abil`  (`klan`, `magic`, `count`,`maxcount`) values ('{$glava_test[short]}','{$PRICE[$ii]['magid']}',0,'0') ;");

											echo $PRICE[$ii]['desc'].' - '.($r*$PRICE[$ii]['kol']).' шт.<br>';
											}
										}
										echo '<br><br>';
										echo 'Всего на сумму <b>'.$needm.' монет.</b><br>';
										echo '<br></td></tr></table>';
										echo '<br><br><br><center><a href="/commerce/" class="button2"> ВЕРНУТЬСЯ НА ГЛАВНУЮ СТРАНИЦУ </a></center><br><br>';
										$q = mysql_query('COMMIT') or die();
										}


		}
	}//обработка оплата монеты


	}


}

if ($view) {
?>

<script>

function CalcAll() {
	d = document;
	sum = 0;
	for (i = <?php echo $pst;?>; i <= <?php echo $pse;?>; i++) {
		if (d.getElementById("pricet_"+i) != undefined)
		{
		sum += parseFloat(d.getElementById("pricet_"+i).innerHTML);
		}
	}
	d.getElementById("calcsum").innerHTML = "<b>"+sum+"</b>";
}

function OnPChange(t) {
	d = document;
	val = d.getElementById("price_"+t);
	if (val) {
		val = parseFloat(val.value);
		if (val > 0) {
			p = d.getElementById("pricev_"+t).value;
			sum = val * p;
			d.getElementById("pricet_"+t).innerHTML = sum;
		} else {
			d.getElementById("pricet_"+t).innerHTML = 0;
		}
	}
	CalcAll();
}
</script>
<form method=post id="mainform" >
<input type=hidden name="act" value="clansabil">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">
		<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
		<td align=center><b style="color:#800000">Название пакета реликтов</b></td>
		<td align=center><b style="color:#800000">Цена</b></td>
		<td align=center><b style="color:#800000">Купить пакетов</b></td>
		<td align=center><b style="color:#800000">Сумма к оплате</b></td>
		</tr>


	<?
	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for($ii=$pst;$ii<=$pse;$ii++)
	{
	if (isset($PRICE[$ii]))
	{
	 if ($ii==314)
	 	{
		?>
		<input type="hidden" name="pricev_<?php echo $ii; ?>" id="pricev_<?php echo $ii; ?>" value="<? echo $PRICE[$ii][cost];?>">
		<input type="hidden" value=0 name="price_314" id="price_314">
		<div id="pricet_314">0</div>
		<?
	 	}
	 	else
	 	{
		?>
		<tr bgcolor="<?php echo $co[$c];?>"><td width="25" height="25" align="center">
		<td class="tbl_inside"><b><? echo $PRICE[$ii][desc];?> (пакет из <?php echo $PRICE[$ii][kol] ?>шт.)</b></td>
		<td align="center"><b><? echo $PRICE[$ii][cost];?> екр</b></td>
		<td align="center"><input type="hidden" name="pricev_<?php echo $ii; ?>" id="pricev_<?php echo $ii; ?>" value="<? echo $PRICE[$ii][cost];?>"><input size=5 value=0 onkeyup="OnPChange(<?php echo $ii; ?>);" name="price_<?php echo $ii; ?>" type=text id="price_<?php echo $ii; ?>"></td>
		<td align="center"><div id="pricet_<?php echo $ii; ?>">0</div></td>
		</tr>
		<?
		if ($c==1) {$c=2;} else {$c=1;}
		}
	}
	}
	?>

	<tr bgcolor="#f9f7ee">
	<td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td align=center></td>
	<td align=center><b style="color:#800000">Итого к оплате:</b></td>
	<td width="150" align="center"><div id="calcsum">0</div></td>
	</tr>

	<tr bgcolor="#f9f7ee">
	<td align=center colspan=5><br><br><b style="color:#800000"><BR>ВЫБЕРИТЕ СПОСОБ ОПЛАТЫ:<BR></b>
		<br>
			<table class="tbl_inside">
			<tr>
			<td><BR>
	  		<label><input type="radio" name="paymethod" value="1" id="paymethod_1" checked="checked" />&nbsp;&nbsp;<b>Списать из казны клана</b></label>&nbsp;&nbsp;<br />
	  		<label><input type="radio" name="paymethod" value="3" id="paymethod_3" />&nbsp;&nbsp;<b>Оплата золотыми монетами</b></label>&nbsp;&nbsp;<br />
			<?
			//<label><input type="radio" name="paymethod" value="2" id="paymethod_2"  />&nbsp;&nbsp;<b>Списать из банковского счета</b></label>&nbsp;&nbsp;<br />
			?>

			<BR></td>
			</tr>
			</table>
		<br>
		</td>
	</tr>

	</table><br><br>
	<center><a href='#'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center><br><br>
	</form>
<?
	}
}
else
	{
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
	</tr>
	</table>
	<?
	}


}



function ClanSmile($view=true)
{
global $PRICE;

if ($PRICE[91][desc])
{
?>
<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> КЛАНОВЫЕ СМАЙЛИКИ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку уникального кланового смайлика.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером от <?=$PRICE[91][w];?> до <?=$PRICE[91][wmax];?> px по ширине и от <?=$PRICE[91][h];?> до <?=$PRICE[91][hmax];?> px по высоте.  <br>
- фон: прозрачный<br>
- вес:  не более <?=$PRICE[91][size];?> Кб<br>
</small>
<p><b style="color:#800000">Запрещены к установке:</b>  смайлики низкого качества; порно-нарко-пошло-оскорбительного содержания, с провокационной символикой, единовременное заполнение периметра смайла не может превышать 60%
<p>Окончательное решение по установке смайла принимает Администрация проекта. Смайл может быть отклонен без объяснения причин.</p>
<p>После одобрения Администрацией, клановый смайлик добавится в стандартную панель смайлов в чате для всех Ваших соклановцев.</p>
<p>Оплата происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены в казну или, в случае с монетами, оплатившему их персонажу.</p>

<p><b style="color:#800000">Примечание:</b><small> при установке клановых смайлов Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с клана установившего «дубликат» картинка будет снята и ему в казну будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>

<table align=left><tr valign=middle><td>Способы оплаты: &nbsp;&nbsp;&nbsp;</td><td>[<img align=top src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами]&nbsp;&nbsp;&nbsp;</td><td>[<img align=top src=https://i.oldbk.com/i/pay_kazna.png border=0></td><td>  с клан.казны]&nbsp;&nbsp;&nbsp; </td><td>[<img align=top src=https://i.oldbk.com/i/pay_sert.png border=0></td><td> сертификат на клан.смайл] &nbsp;&nbsp;[ </td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
if ($view)
	{
?>
<form method=get id="mainform" >
<input type=hidden name="act" value="service">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

<?
	if ($PRICE[91][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input name="menu" value="91" type="radio" class="tbl_inside"></td>
<td class="tbl_inside"><b><? echo $PRICE[91][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[91]);?></b></td></tr>
<?	}


?>

	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>
<?
  }

}
	else
	{
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
	</tr>
	</table>
	<?
	}


}

function PersSmile($view=true)
{
global $PRICE;
?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> ЛИЧНЫЕ СМАЙЛИКИ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку уникального смайлика своему или другому персонажу.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером от <?=$PRICE[90][w];?> до <?=$PRICE[90][wmax];?> px по ширине и от <?=$PRICE[90][h];?> до <?=$PRICE[90][hmax];?> px по высоте.  <br>
- фон: прозрачный<br>
- вес:  не более <?=$PRICE[90][size];?> Кб<br>
</small>
<p><b style="color:#800000">Запрещены к установке:</b> Запрещены к установке: смайлики низкого качества; порно-нарко-пошло-оскорбительного содержания, с провокационной символикой, единовременное заполнение периметра смайла не может превышать 60%
<p>Окончательное решение по установке смайла принимает Администрация проекта. Смайл может быть отклонен без объяснения причин.</p>



<p><b style="color:#800000">Примечание:</b><small> при установке личных смайлов Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с персонажа установившего «дубликат» картинка будет снята и ему будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>

<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами]&nbsp;&nbsp;&nbsp;</td><td></td><td>&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_sert.png border=0></td><td> сертификат на личный смайл] &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. со счета в Банке]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
if ($view)
	{
?>
<form method=get id="mainform" >
<input type=hidden name="act" value="service">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

<?
	if ($PRICE[90][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input name="menu" value="90" type="radio" class="tbl_inside"></td>
<td class="tbl_inside"><b><? echo $PRICE[90][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[90]);?></b></td></tr>
<?	}


?>

	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>
<?
  }

}

function SendMess($view=true)
{
	?>
	<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> ОБРАТНАЯ СВЯЗЬ </b></center></td></tr>
<tr><td align=left class="text1 cont_bg">
<table align=center><tr align=left><td>
<p>Если Вы не нашли необходимой услуги или хотите задать вопрос представителю Коммерческого отдела,<br>Вы можете воспользоваться
услугами обратной связи. </p>
<p>Введите свой email и текст сообщения в форму ниже и представитель Коммерческого отдела постарается Вам помочь.</p>

<p>При подаче жалобы на установку "дубликата картинки" (образа, иллюзии, смайла и тд) необходимо дать ссылку на свою картинку и на картинку дубликата, указать ник персонажа установившего дубликат и примерное время (год, месяц) когда была установлена ваша картинка. </p>

<p>Ответ на Ваше сообщение будет дан телеграфом в Игре и продублирован на Ваш email в течение 5ти дней.</p> <br>
</td></tr></table>
</td></tr>
<tr><td class="cont_bg">
<br><br>
	<?
	if ($view)
	{
	?>
	<form method=post id="mainform" >
	<input type=hidden name="services" value='Обратная связь'>

<br><br>
<table width="705" border="0" align="center" cellpadding="0" cellspacing="0"><tr><td>
	<b style="color:#800000"> Введите email адрес для связи:</b>&nbsp;&nbsp;  <input id="comemail" name="comemail" value="<?=$_SESSION['usrmail'];?>" type="text">



<br><br>


	<b style="color:#800000"> Впишите текст сообщения:</b><br><br>
		</td></tr></table>
			<center>
	<textarea name="comment" style="width: 705px;" rows="6" id="commentarea"></textarea>
	</center>
	<br>
		<br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ОТПРАВИТЬ СООБЩЕНИЕ</a></center>
	</form>	<br>	<br>
	</td></tr>
	<tr>
	<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
	</tr>
	</table>

	<br>	<br>
	<?
	  }


}

function PersImgs($view=true)
{

global $PRICE;


	?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> ЛИЧНЫЕ ИЗОБРАЖЕНИЯ ВЕЩЕЙ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку личных изображений вещей своему или другому персонажу.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображениям:</b><br>
<small>- формат: GIF файл размером - кольцо 20х20, серьги и кулон 60х20, оружие и щит и шлем 60х60, броня и плащ 60х80, перчи и сапоги 60х40.  <br>
- фон: прозрачный или серый в цвет инфы (#e2e0e0), либо фоновое изображение (в случае "полного образа", т.е. когда образ вместе с вещами создают одну картину).<br>
- вес: статичного файла не более 20Кб, анимированного файла не более  40Кб<br>
- рамка: шириной 1px - справа и снизу черная, слева и сверху белая (в случае "полного образа" рамка требуется только вокруг общей картины)</small>
<p><b style="color:#800000">Запрещены к установке:</b> картинки низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой; уникальные и стандартные картинки из бБК;<br>
не подходящие к тематике игры (исключение может быть сделано в случае, если картинки устанавливаются сразу на все вещи и они по смыслу сочетаются с ником или образом персонажа)</p>
<p>После одобрения Администрацией, изображения вещей появится в Инвентаре >> вкладка Галерея</p>
<p>Оплата с банковского счета происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены на счет.</p>
<p><b style="color:#800000">Примечание:</b><small> при установке личных изображений вещей Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с персонажа установившего «дубликат» картинка будет снята и ему будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. с Вашего счета в Банке] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] [</td><td><img src=https://i.oldbk.com/i/pay_sert_image.png border=0></td><td>сертификатом]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
if ($view)
	{
?>



	<form method=get id="mainform" >
	<input type=hidden name="act" value="service">
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">
	<tr>
	<td colspan=3 align=center><br><b style="color:#800000"> СТАТИЧНЫЕ ИЗОБРАЖЕНИЯ</b><br>&nbsp;</td></tr>
	<?
	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for ($ii=21;$ii<=35;$ii++)
	{
		if ($PRICE[$ii][desc])
	      {
	      echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center">
	      <input name="menu" value="'.$ii.'" type="radio" class="tbl_inside"></td>';
	      echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b></td><td width="150" align="center"><b>';
	      echo get_cost($PRICE[$ii]);
	      echo '</b></td></tr>';

	      if ($c==1) {$c=2;} else {$c=1;}

		}
	}

	if ($PRICE[17][desc])
      {
      	     if ($c==1) {$c=2;} else {$c=1;}
       ?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="17" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[17][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[17]);?></b></td></tr>
	<?
	}
	?>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	<?      if ($c==1) {$c=2;} else {$c=1;} ?>



	<tr>
	<td colspan=3 align=center><br><b style="color:#800000"> АНИМИРОВАННЫЕ ИЗОБРАЖЕНИЯ</b><br>&nbsp;</td></tr>

<br>
	<?
	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for ($ii=36;$ii<=50;$ii++)
	{
		if ($PRICE[$ii][desc])
	      {
	      echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center">
	      <input name="menu" value="'.$ii.'" type="radio" class="tbl_inside"></td>';
	      echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b></td><td width="150" align="center"><b>';
	      echo get_cost($PRICE[$ii]);
	      echo '</b></td></tr>';

	      if ($c==1) {$c=2;} else {$c=1;}

		}
	}

	if ($PRICE[18][desc])
      {
       ?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="18" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[18][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[18]);?></b></td></tr>
	<?
	}

	if ($PRICE[15][desc])
      {
	      if ($c==1) {$c=2;} else {$c=1;}
       ?>
	   	<tr>
		       	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td ></td><td width="150" align="center"></td></tr>
	<td colspan=3 align=center><br><b style="color:#800000"> ДОПОЛНИТЕЛЬНЫЕ ВОЗМОЖНОСТИ </b><br>&nbsp;</td></tr>


	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="15" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[15][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[15]);?></b></td></tr>
	<?
	}

	      if ($c==1) {$c=2;} else {$c=1;}

	if ($PRICE[600][desc]) {
	?>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="600" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[600][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[600]);?></b></td></tr>
	<?
	}

	      if ($c==1) {$c=2;} else {$c=1;}

	if ($PRICE[601][desc]) {
	?>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="601" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[601][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[601]);?></b></td></tr>
	<?
	}

	      if ($c==1) {$c=2;} else {$c=1;}

	if ($PRICE[613][desc]) {
	?>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="613" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[613][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[613]);?></b></td></tr>
	<?
	}

	      if ($c==1) {$c=2;} else {$c=1;}

	if ($PRICE[614][desc]) {
	?>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu" value="614" type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[614][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[614]);?></b></td></tr>
	<?
	}

	      if ($c==1) {$c=2;} else {$c=1;}
	?>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	<?      if ($c==1) {$c=2;} else {$c=1;} ?>


		</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>	<BR><BR><BR>
	<?
  }

}



function PersARTSImgs($view=true)
{

global $PRICE;


	?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000">ЗАМЕНА ИЗОБРАЖЕНИЯ ЛИЧНЫХ АРТЕФАКТОВ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на смену изображения личного артефакта.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображениям:</b><br>
<small>- формат: GIF файл размером - кольцо 20х20, серьги и кулон 60х20, оружие и щит и шлем 60х60, броня и плащ 60х80, перчи и сапоги 60х40.  <br>
- фон: прозрачный или серый в цвет инфы (#e2e0e0), либо фоновое изображение (в случае "полного образа", т.е. когда образ вместе с вещами создают одну картину).<br>
- вес: статичного файла не более 100Кб<br>
- рамка: шириной 1px - справа и снизу черная, слева и сверху белая (в случае "полного образа" рамка требуется только вокруг общей картины)</small>
<p><b style="color:#800000">Запрещены к установке:</b> картинки низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой; уникальные и стандартные картинки из бБК;<br>
не подходящие к тематике игры (исключение может быть сделано в случае, если картинки устанавливаются сразу на все вещи и они по смыслу сочетаются с ником или образом персонажа)</p>
<p>После одобрения Администрацией, изображение будет обновлено втечении 24 часов</p>
<p><b style="color:#800000">Примечание:</b><small> при установке изображений Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с персонажа установившего «дубликат» картинка будет снята и ему будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. с Вашего счета в Банке] &nbsp;&nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами]</td></tr></table></td></tr></table>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?



}


function PersPres($view=true)
{
global $PRICE;
?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> ЛИЧНЫЕ ПОДАРКИ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку уникального подарка своему или другому персонажу.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером 60х60.  <br>
- фон: любой цвет либо фоновое изображение<br>
- вес: статичного файла не более 20Кб, анимированного файла не более  40Кб<br>
- рамка: шириной 1px - справа и снизу черная, слева и сверху белая</small>
<p><b style="color:#800000">&nbsp;&nbsp;Запрещены к установке:</b> картинки низкого качества; порно-нарко-пошло-оскорбительного содержания; с провокационной символикой; подарки содержащие спец. символы в названии, интимные оголенные или частично оголенные части тела отображенные крупным планом.<br>
&nbsp;&nbsp;Окончательное решение по установке подарка принимает Администрация проекта. Подарок может быть отклонен без объяснения причин.<br><br>
&nbsp;&nbsp;После одобрения Администрацией, обладатель подарка сможет купить его в Цветочном магазине в разделе «Уникальные подарки» по цене - 10кр за статичный подарок и 20кр за анимированный подарок, в количестве не более <?= round((EKR_TO_KR*$PRICE[1]['cost']) / 50) ?> и <?= round((EKR_TO_KR*$PRICE[2]['cost']) / 50) ?> подарков соответственно.
Уникальный подарок невозможно подарить анонимно или от имени клана.</p>
<p><b style="color:#800000">Примечание:</b><small> при установке личных подарков Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
<p><b style="color:#800000">Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с персонажа установившего «дубликат» картинка будет снята и ему будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>
<p><b style="color:#FF0000">При оплате подарка для ДРУГОГО персонажа оплата возможно ТОЛЬКО золотыми монетами. При установке подарка для себя, оплатить можно екрами, золотыми монетами или сертификатом на уникальный подарок.</b></p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;&nbsp;</td><td>[</td><td><img align=top src=https://i.oldbk.com/i/pay_bank.png border=0> </td><td>списать екр. с Банка]</td><td>&nbsp;&nbsp;&nbsp;[ </td><td><img align=top src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] &nbsp;&nbsp;&nbsp;</td><td>[</td><td><img align=top src=https://i.oldbk.com/i/pay_sert.png border=0></td><td> сертификат на уник. подарок]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
if ($view)
	{
?>
<form method=get id="mainform" >
<input type=hidden name="act" value="service">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

<?
	if ($PRICE[1][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input name="menu" value="1" type="radio" class="tbl_inside"></td>
<td class="tbl_inside"><b><? echo $PRICE[1][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[1]);?></b></td></tr>
<?	}

	if ($PRICE[2][desc])
	{
?>
<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
<input name="menu" value="2" type="radio" class="tbl_inside"></td>
<td class="tbl_inside"><b><? echo $PRICE[2][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[2]);?></b></td></tr>
<?	}

	if ($PRICE[13][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input name="menu" value="13" type="radio" class="tbl_inside"></td>
<td class="tbl_inside"><b><? echo $PRICE[13][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[13]);?></b></td></tr>
<?
	}
?>

	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	<?      if ($c==1) {$c=2;} else {$c=1;} ?>


	</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>
<?
  }

}


function ClanPres($view=true)
{
global $PRICE;

if ($PRICE[3][desc])
{
?><br>

<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> КЛАНОВЫЕ ПОДАРКИ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку уникального подарка для своего клана.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображению:</b><br>
<small>- формат: GIF файл размером 60х60.  <br>
- фон: любой цвет либо фоновое изображение<br>
- вес: статичного файла не более 20Кб, анимированного файла не более  40Кб<br>
- рамка: шириной 1px - справа и снизу черная, слева и сверху белая</small>
<p><b style="color:#800000">Запрещены к установке:</b>  картинки низкого качества; порно-нарко-пошло-оскорбительного содержания; с провокационной символикой; подарки содержащие спец. символы в названии, интимные оголенные или частично оголенные части тела отображенные крупным планом.
<p>Окончательное решение по установке подарка принимает Администрация проекта. Подарок может быть отклонен без объяснения причин.</p>
<p>После одобрения Администрацией, обладатель подарка сможет купить его в Цветочном магазине в разделе «Уникальные подарки» по цене - 10кр за статичный подарок и 20кр за анимированный подарок, в количестве не более <?= round((EKR_TO_KR*$PRICE[3]['cost']) / 50) ?> и <?= round((EKR_TO_KR*$PRICE[4]['cost']) / 50) ?> подарков соответственно.
<br>Клановый подарок дарится только от имени клана и его невозможно подарить анонимно или от своего имени. <br>Подаренный клановый подарок отображается в инфе получателя в разделе «Уникальные подарки» и не имеет срока годности.</p>
<p>Оплата происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены в казну или, в случае с монетами, оплатившему их персонажу.</p>
<p><b style="color:#800000">Примечание:</b><small> при установке клановых подарков Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с клана установившего «дубликат» картинка будет снята и ему в казну будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;</td><td>[</td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] &nbsp;&nbsp;</td><td>[</td><td><img src=https://i.oldbk.com/i/pay_kazna.png border=0></td><td> екр. с казны клана] &nbsp;&nbsp;</td><td>[</td><td><img src=https://i.oldbk.com/i/pay_sert.png border=0></td><td> Сертификат]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
 if ($view)
 {
 ?>
 <form method=get id="mainform" >
<input type=hidden name="act" value="service">
<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">

<?
	if ($PRICE[3][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input name="menu" value="3" type="radio" class="tbl_inside"></td>
<td class="tbl_inside" ><b><? echo $PRICE[3][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[3]);?></b></td></tr>
<?	}

	if ($PRICE[4][desc])
	{
?>
<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center">
<input name="menu" value="4" type="radio" class="tbl_inside"></td>
<td class="tbl_inside" ><b><? echo $PRICE[4][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[4]);?></b></td></tr>
<?	}

	if ($PRICE[14][desc])
	{
?>
<tr bgcolor="#f4f2e9"><td width="25" height="25" align="center">
<input name="menu" value="14" type="radio" class="tbl_inside"></td>
<td class="tbl_inside"><b><? echo $PRICE[14][desc];?> </b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[14]);?></b></td></tr>
<?
	}
?>
	<tr bgcolor="#f9f7ee"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	</table><br><br>
	<center><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></center>
	</form>

<?
 }
}
else
	{
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
	</tr>
	</table>
	<?

	}
}



function ClanImgs($view=true)
{

global $PRICE;

if ($PRICE[51][desc])
	{
	?>
		<br>
<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
<tr>
<td valign="bottom" class="cont_up" width="940" height="18">&nbsp;</td>
</tr>
<tr>
<td class="cont_bg">
<center><b style="color:#800000"> КЛАНОВЫЕ ИЗОБРАЖЕНИЯ ВЕЩЕЙ</b></center></td></tr>
<tr><td class="text1 cont_bg"><br><center>Здесь Вы можете подать заявку на установку изображений вещей для своего клана.</center><br>
<table align=center><tr align=left><td><b style="color:#800000">Требования к изображениям:</b><br>
<small>- формат: GIF файл размером - кольцо 20х20, серьги и кулон 60х20, оружие и щит и шлем 60х60, броня и плащ 60х80, перчи и сапоги 60х40.  <br>
- фон: прозрачный или серый в цвет инфы (#e2e0e0), либо фоновое изображение (в случае "полного образа", т.е. когда образ вместе с вещами создают одну картину).<br>
- вес: статичного файла не более 20Кб, анимированного файла не более  40Кб<br>
- рамка: шириной 1px - справа и снизу черная, слева и сверху белая (в случае "полного образа" рамка требуется только вокруг общей картины)</small>
<p><b style="color:#800000">Запрещены к установке:</b> картинки низкого качества; алкогольно-порно-нарко-содержания; с провокационной символикой; уникальные и стандартные картинки из бБК;<br>
не подходящие к тематике игры (исключение может быть сделано в случае, если картинки устанавливаются сразу на все вещи и они по смыслу сочетаются с названием клана или клановым образом)</p>
<p>После одобрения Администрацией, изображения вещей появится у всех соклановцев в Инвентаре >> вкладка Галерея</p>
<p>Оплата происходит в момент подачи заявки. В случае отказа по заявке, все средства будут полностью возвращены в казну или, в случае с монетами, оплатившему их персонажу.</p>
<p><b style="color:#800000">Примечание:</b><small> при установке клановых изображений вещей Коммерческий отдел не несет ответственности за установку «дубликатов» (т.е. картинок, которые уже установлены в игре другими персонажами или кланами).
Если жалоба в Коммерческий отдел на установку «дубликата» будет удовлетворена, то с клана установившего «дубликат» картинка будет снята и ему в казну будут возвращены екры, потраченные на установку за вычетом 25% комиссионных.</small></p>
<table align=left><tr valign=middle><td>Возможные способы оплаты: &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_coins.png border=0></td><td> оплата золотыми монетами] &nbsp;&nbsp;[ </td><td><img src=https://i.oldbk.com/i/pay_kazna.png border=0></td><td> екр. с казны клана]</td></tr></table></td></tr></table>
<p align=left><font color='red'><b>При оплате золотыми монетами скидка 10%!</b></font></p>
</td>
</tr>
<tr>
<td valign="top" class="cont_dwn" height="18">&nbsp;</td>
</tr>
</table>
<br><br>
<?
	if ($view)
	{
?>

<br>
	<form method=get id="mainform" >
	<input type=hidden name="act" value="service">
	<table width="880" align="center" cellpadding="0" cellspacing="0" class="tbl_inside">
	<tr><td colspan=3 align=center><br><b style="color:#800000"> СТАТИЧНЫЕ ИЗОБРАЖЕНИЯ </b><br>&nbsp;</td></tr>
	<?
	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for ($ii=51;$ii<=65;$ii++)
	{
		if ($PRICE[$ii][desc])
	      {
	      echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center">
	      <input name="menu" value="'.$ii.'" type="radio" class="tbl_inside"></td>';
	      echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b> </td><td width="150" align="center"><b>';
	      echo get_cost($PRICE[$ii]);
	      echo '</b></td></tr>';

	      if ($c==1) {$c=2;} else {$c=1;}

		}
	}

	if ($PRICE[19][desc])
       {
       ?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu"  value="19"  type="radio" class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[19][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[19]);?></b></td></tr>
	<?
	}
	    if ($c==1) {$c=2;} else {$c=1;}
	?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>

	<?      if ($c==1) {$c=2;} else {$c=1;} ?>



	<tr>
	<td colspan=3 align=center><br><b style="color:#800000"> АНИМИРОВАННЫЕ ИЗОБРАЖЕНИЯ </b><br>&nbsp;</td></tr>


	<?
	$co[1]='#f4f2e9';
	$co[2]='#f9f7ee';
	$c=1;
	for ($ii=66;$ii<=80;$ii++)
	{
		if ($PRICE[$ii][desc])
	      {
	      echo '<tr bgcolor="'.$co[$c].'"><td width="25" height="25" align="center">
	      <input name="menu" value="'.$ii.'" type="radio" class="tbl_inside"></td>';
	      echo '<td class="tbl_inside"><b>'.$PRICE[$ii][desc].'</b></td><td width="150" align="center"><b>';
	      echo get_cost($PRICE[$ii]);
	      echo '</b></td></tr>';

	      if ($c==1) {$c=2;} else {$c=1;}

		}
	}

	if ($PRICE[20][desc])
      {
       ?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu"  value="20"  type="radio"  class="tbl_inside"></td>
	<td class="tbl_inside"><b><? echo $PRICE[20][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[20]);?></b></td></tr>
	<?
	}
	if ($PRICE[16][desc])
      {
	      if ($c==1) {$c=2;} else {$c=1;}
       ?>
       	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td ></td><td width="150" align="center"></td></tr>
	<td colspan=3 align=center><br><b style="color:#800000"> ДОПОЛНИТЕЛЬНЫЕ ВОЗМОЖНОСТИ </b><br>&nbsp;</td></tr>

	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu"  value="16"  type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[16][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[16]);?></b></td></tr>
	<?
	}
	    if ($c==1) {$c=2;} else {$c=1;}

	if ($PRICE[602][desc]) {
	?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu"  value="602"  type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[602][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[602]);?></b></td></tr>
	<?
	}
	    if ($c==1) {$c=2;} else {$c=1;}

	if ($PRICE[603][desc]) {
	?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center">
	<input name="menu"  value="603"  type="radio" class="tbl_inside"></td>
	<td class="tbl_inside" ><b><? echo $PRICE[603][desc];?></b></td><td width="150" align="center"><b> <? echo get_cost($PRICE[603]);?></b></td></tr>
	<?
	}
	    if ($c==1) {$c=2;} else {$c=1;}
	?>
	<tr bgcolor="<?=$co[$c];?>"><td width="25" height="25" align="center"></td>
	<td align=center></td>
	<td width="150" align="center"></td></tr>


	</table><BR><BR>

	<CENTER><a href='javascript://'  class="button2" onClick='document.forms[0].submit();' >ПРОДОЛЖИТЬ</a></CENTER>



	</form>
	<BR><BR>
	<?
 	}
}
else
	{
	?>
	<table width="880" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	<td width="27" height="30">&nbsp;</td>
	<td align="center"><b style="color:#800000"> ДОСТУПНО ТОЛЬКО ГЛАВАМ КЛАНОВ</b></td>
	</tr>
	</table>
	<?

	}


}


//нижняя часть страницы

function hot_links()
{
?>
<!--hotlink-->
<table width="974" border="0" align="center" cellpadding="0" cellspacing="0" class="subDm">
<tr>
<td height="80" align="center" valign="top"><br>

	<table width="880" border="0" cellspacing="0" cellpadding="0" class="subMt">
	<tr>
	<td width="33%" valign="top">
		<table width="250" border="0" cellpadding="0" cellspacing="0">
		<tr>
		<td><a class="hot" href="https://oldbk.com/commerce/index.php?act=mkclanart">Клановые артефакты</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=klanobraz">Клановые образы</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=clanimgs">Клановые картинки вещей</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=clanpres">Клановые подарки</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=clansmile">Клановые смайлы</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=clansabil">Клановые реликты</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=clanservice">Клановые услуги</a></td>
		</tr>
		</table><p>&nbsp;</p></td>
	<td width="33%" valign="top">
		<table width="250" border="0" align="right" cellpadding="0" cellspacing="0">
		<tr>
		<td><a class="hot" href="https://oldbk.com/commerce/index.php?act=mkpersonalart">Личные артефакты</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=persobraz">Личные образы</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=persimgs">Личные изображения вещей</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=perspres">Личные подарки</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=perssmile">Личные смайлы</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=persabil">Личные абилити</a></td>
		</tr>
		</table>
	<br>
	</td>
	<td valign="top">
		<table width="230" border="0" align="right" cellpadding="0" cellspacing="0">
		<tr>
		<td><a class="hot" href="https://oldbk.com/commerce/index.php?act=other">Услуги коммерческого отдела</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=mkdart">Возврат артефакта</a>
		<br><a class="hot" href="https://oldbk.com/commerce/index.php?act=sendmess">Обратная связь</a></td>
		</tr>
		</table>
	<p>&nbsp;</p>
	</td>
	</tr>
	</table>
</td>
</tr>
</table>
<!--/hotlink-->
<?
}


function page_bottom()
{
global $user;

?>
<!--content fin-->
	<table width="940" border="0" align="center" cellpadding="0" cellspacing="0">
	</table>

</td>
</tr>
</table>
</td>
</tr>
</table>
	<?

	if (($_REQUEST['act']) and ($_SESSION['uid']>0) and ($user) )
	{
	hot_links();
	}
	?>

</td>
    <td valign="top" class="rightY"><table width="100%" height="215" border="0" cellpadding="0" cellspacing="0" class="headRight">
<tr>
<td height="270">&nbsp;</td>
</tr>
</table></td>
  </tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td class="footLeft">&nbsp;</td>
    <td width="1018" height="138" valign="top" class="footer">
    <table width="600" border="0" align="center" cellpadding="0" cellspacing="0" class="down_menu">
	<tr>
	<td height="38" valign="bottom">
	<a href="https://oldbk.com/?about=yes" target=_blank class="down_menuL">ОБ ИГРЕ</a> |
	<a href="https://oldbk.com/news.php" target=_blank class="down_menuL">НОВОСТИ</a> |
	<a href="https://oldbk.com/encicl/index.php" target=_blank class="down_menuL">БИБЛИОТЕКА</a> |
	<a href="https://oldbk.com/forum.php" target=_blank class="down_menuL">ФОРУМ</a> |
	<a href="https://top.oldbk.com/index.php" target=_blank class="down_menuL">РЕЙТИНГИ</a> |
	<a href="https://oldbk.com/partners/index.php" target=_blank class="down_menuL">ПАРТНЕРАМ</a>
	</td>
	</tr>
   </table>
   <br>

<div align=center>
		<br>
		<?=include('../counters/all.php'); ?><br>
		<a href="https://oldbk.com">© 2010—<?=date("Y");?> «Бойцовский Клуб ОлдБК»</a>



		<br><a href="https://oldbk.com/" style="color:#808080;">Многопользовательская бесплатная онлайн фэнтези рпг - ОлдБК - Старый Бойцовский Клуб</a>
</div>


</td>
    <td class="footRight">&nbsp;</td>
  </tr>
</table>
</body>
</html>

<?
}




?>
