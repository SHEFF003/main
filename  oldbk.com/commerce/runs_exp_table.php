<?

//Таблица опыта для рун

$runs_exp_table=array(
"0" => array("next"=>10500, "stbonus"=>0,"mfbonus"=>0,"bron"=>0,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>0, "minu"=>0,"maxu"=>0 ),
"1" => array("next"=>23500, "stbonus"=>0,"mfbonus"=>10,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>0, "minu"=>0,"maxu"=>0 ),
"2" => array("next"=>38500, "stbonus"=>1,"mfbonus"=>0,"bron"=>0,"ghp"=>5,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"3" => array("next"=>57000, "stbonus"=>0,"mfbonus"=>10,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>1, "gmp"=>0, "minu"=>0,"maxu"=>0 ),
"4" => array("next"=>77000, "stbonus"=>0,"mfbonus"=>0,"bron"=>0,"ghp"=>5,"smast"=>0,"gintel"=>0, "gmp"=>1 , "minu"=>0,"maxu"=>0),
"5" => array("next"=>103000, "stbonus"=>0,"mfbonus"=>10,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"6" => array("next"=>136500, "stbonus"=>1,"mfbonus"=>0,"bron"=>0,"ghp"=>5,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"7" => array("next"=>171500, "stbonus"=>0,"mfbonus"=>10,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"8" => array("next"=>212500, "stbonus"=>1,"mfbonus"=>0,"bron"=>0,"ghp"=>5,"smast"=>0,"gintel"=>0, "gmp"=>1, "minu"=>0,"maxu"=>0 ),
"9" => array("next"=>257500, "stbonus"=>0,"mfbonus"=>10,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>1, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"10" => array("next"=>300000, "stbonus"=>2,"mfbonus"=>0,"bron"=>0,"ghp"=>10,"smast"=>1,"gintel"=>0, "gmp"=>0 , "minu"=>1,"maxu"=>2),
"11" => array("next"=>360000, "stbonus"=>0,"mfbonus"=>15,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>1 , "minu"=>0,"maxu"=>0),
"12" => array("next"=>430000, "stbonus"=>1,"mfbonus"=>0,"bron"=>0,"ghp"=>7,"smast"=>0,"gintel"=>1, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"13" => array("next"=>500000, "stbonus"=>0,"mfbonus"=>15,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>1, "minu"=>0,"maxu"=>0 ),
"14" => array("next"=>580000, "stbonus"=>1,"mfbonus"=>0,"bron"=>0,"ghp"=>7,"smast"=>0,"gintel"=>1, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"15" => array("next"=>670000, "stbonus"=>0,"mfbonus"=>15,"bron"=>1,"ghp"=>0,"smast"=>1,"gintel"=>0, "gmp"=>1 , "minu"=>0,"maxu"=>0),
"16" => array("next"=>770000, "stbonus"=>1,"mfbonus"=>0,"bron"=>1,"ghp"=>7,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>1,"maxu"=>2),
"17" => array("next"=>880000, "stbonus"=>0,"mfbonus"=>15,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>1, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"18" => array("next"=>1000000, "stbonus"=>1,"mfbonus"=>0,"bron"=>0,"ghp"=>7,"smast"=>0,"gintel"=>0, "gmp"=>1 , "minu"=>0,"maxu"=>0),
"19" => array("next"=>1200000, "stbonus"=>0,"mfbonus"=>15,"bron"=>1,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"20" => array("next"=>1500000, "stbonus"=>2,"mfbonus"=>20,"bron"=>0,"ghp"=>15,"smast"=>1,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"21" => array("next"=>2000000, "stbonus"=>2,"mfbonus"=>15,"bron"=>0,"ghp"=>16,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"22" => array("next"=>2600000, "stbonus"=>1,"mfbonus"=>16,"bron"=>0,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>1 , "minu"=>1,"maxu"=>1),
"23" => array("next"=>3300000, "stbonus"=>0,"mfbonus"=>17,"bron"=>0,"ghp"=>0,"smast"=>0,"gintel"=>1, "gmp"=>1 , "minu"=>1,"maxu"=>1),
"24" => array("next"=>4050000, "stbonus"=>2,"mfbonus"=>18,"bron"=>0,"ghp"=>17,"smast"=>1,"gintel"=>0, "gmp"=>0 , "minu"=>1,"maxu"=>1),
"25" => array("next"=>4900000, "stbonus"=>2,"mfbonus"=>25,"bron"=>2,"ghp"=>0,"smast"=>0,"gintel"=>0, "gmp"=>0 , "minu"=>1,"maxu"=>2),
"26" => array("next"=>6000000, "stbonus"=>1,"mfbonus"=>20,"bron"=>0,"ghp"=>18,"smast"=>0,"gintel"=>1, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"27" => array("next"=>7200000, "stbonus"=>2,"mfbonus"=>21,"bron"=>0,"ghp"=>0,"smast"=>0,"gintel"=>2, "gmp"=>1 , "minu"=>0,"maxu"=>0),
"28" => array("next"=>8800000, "stbonus"=>2,"mfbonus"=>22,"bron"=>0,"ghp"=>19,"smast"=>1,"gintel"=>0, "gmp"=>0 , "minu"=>0,"maxu"=>0),
"29" => array("next"=>11500000, "stbonus"=>1,"mfbonus"=>35,"bron"=>0,"ghp"=>20,"smast"=>0,"gintel"=>0, "gmp"=>1 , "minu"=>0,"maxu"=>0),
"30" => array("next"=>115000000, "stbonus"=>3,"mfbonus"=>30,"bron"=>3,"ghp"=>30,"smast"=>1,"gintel"=>0, "gmp"=>0 , "minu"=>1,"maxu"=>2),
);

//Таблица параметров которые добавляются для рун на 5-м уровне по типам
//по прототипам
$runs_5lvl_param=array(
"6000" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
"6001" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
"6002" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
"6003" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
"6004" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
"6005" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
"6006" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
"6007" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
"6008" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
"6009" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
"6010" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
"6011" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
"6012" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
"6013" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
"6014" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
"6015" =>array("ab_mf"=>0,"ab_bron"=>0,"ab_uron"=>1),
"6016" =>array("ab_mf"=>0,"ab_bron"=>3,"ab_uron"=>0),
"6017" =>array("ab_mf"=>1,"ab_bron"=>0,"ab_uron"=>0),
);


//Таблица базовых очков за юз магии для прокачки рун
$magic_points=array(
"9"=>0,
"10"=>0,
"11"=>0,
"12"=>5,
"61"=>50,
"203"=>20,
"204"=>30,
"206"=>10,
"207"=>20,
"208"=>30,
"209"=>40,
"270"=>50,
"271"=>75,
"272"=>50,
"273"=>75,
"274"=>100,
"275"=>75,
"1022"=>75,
"10001"=>0,

"10206"=>10,
"10207"=>20,
"10209"=>40,
"205205"=>60,
"275275"=>65,

"16"=>25,
"17"=>50,
"1616"=>25,
"1717"=>50,

"5001"=>100,
"5002"=>200,
"5003"=>300,
"5007005"=>300,

"4001"=>5,
"4002"=>15,
"4003"=>25,
"4011"=>5,
"4012"=>15,
"4013"=>25,
"5007004"=>75,

// new SELECT shop.id,shop.name,magic.id FROM shop LEFT JOIN magic ON shop.magic = magic.id WHERE shop.id IN (15004 ,14004 ,120120120 ,119119119 ,120120121 ,119119120 ,200278 ,200279 ,200277 )
"5004" => 300, // 15004 Большой свиток «Захват» 300
"4004" => 70, // 14004 Большой свиток «Призыв» 70
"171717" => 50, // 120120120 Большой свиток «Переманивание» 50
"161616" => 25, // 119119119 Большой свиток «Клонирование» 25
"171718" => 50, // 120120121 Совершенный свиток «Переманивание» 50
"161617" => 25, //119119120 Совершенный свиток «Клонирование» 25
"278" => 75, // 200278 Совершенный свиток «Восстановление здоровья 360» 75
"279" => 40, // 200279 Совершенный свиток «Восстановление здоровья 180» 40
"277" => 135, // 200277 Средний свиток «Восстановление здоровья 720» 135
"278" => 75, // 200278 Совершенный свиток «Восстановление здоровья 360» 75
"279" => 40, // 200279 Совершенный свиток «Восстановление здоровья 180» 40
"277" => 135, // 200277 Средний свиток «Восстановление здоровья 720» 135

202=>10, // Малый свиток «Восстановление 90HP»	
205=>40, // Малый свиток «Восстановление 180HP»	
2205=>40, //Большой свиток «Восстановление 180HP»	
1202=>10, //Средний свиток «Восстановление 90HP»	
276=>75, //Малый свиток «Восстановление 360HP»	
2276=>75, //Большой свиток «Восстановление 360HP»
1205=>40, //Средний свиток «Восстановление 180HP»	
1276=>75, //Средний свиток «Восстановление 360HP»	
2202=>10, //Большой свиток «Восстановление 90HP»	
2205=>40, // Большой свиток «Восстановление 180HP»	

);

//стоимость перехода на сл. уровень у МАГА в репутации
//на уровень=>стоимость в репе
$runs_mag_lvl_price=array(
"1"=>1000,
"2"=>1000,
"3"=>2000,
"4"=>1500,
"5"=>4000,
"6"=>3500,
"7"=>6000,
"8"=>5000,
"9"=>9000,
"10"=>15000,
"11"=>10000,
"12"=>30000,
"13"=>20000,
"14"=>45000,
"15"=>30000,
"17"=>55000,
"18"=>40000,
"19"=>65000,
"20"=>75000
);

//стоимость "докупки" уровня - для прокачки руны
//только до 10 лвла
$runs_lvl_cost=array(
"1"=>6000,
"2"=>7000,
"3"=>8000,
"4"=>10000,
"5"=>11000,
"6"=>14000,
"7"=>18000,
"8"=>19000,
"9"=>22000,
"10"=>25000,
"11"=>100000000
);


//функа просчета коф. очков для прокачки руны
function runs_battle_get_kof($bat) //масив
{

if  ($bat['teams']=='Бой склонностей' )
		{
		 return 1.5; 
		} 

if ($bat['coment'] =='<b>Куча-мала</b>') 
		{
		 return 1.5; 
		} 


	$KO_start_time30=mktime(12,0,0,8,8,date("Y")); 
	$KO_fin_time30 =mktime(23,59,59,8,14,date("Y"));

if ((time() >= $KO_start_time30) && (time() < $KO_fin_time30 ))
	{
		if ($bat['type'] == 601) return 2.1;
		if ($bat['type'] == 602) return 1.6;
		if ($bat['type'] == 603) return 1.8;
		if ($bat['type'] == 604) return 1.1;
	}	
	else
	{
		if ($bat['type'] == 601) return 2;
		if ($bat['type'] == 602) return 1.5;
		if ($bat['type'] == 603) return 1.7;
		if ($bat['type'] == 604) return 1;
	}
	
	
if ($bat['teams']=='AFB') { return 2;  }
if ($bat['status_flag'] == 4)  {  if ($bat['blood']>0) { return 2; } else { return 1; }  }

		if (($bat['coment'] =='Бой с Исчадием Хаоса') OR ($bat['coment'] =='<b>Бой с Духом Мерлина</b>')  OR ($bat['coment'] =='<b>Бой с Волнами Драконов</b>') )
		{
		 return 1; // в счетчике уже посчитано вернем 1 шоб не испортить
		} 
		else
		if ($bat['type'] == 40) 
		{
		//простое противостояние
		 return 0.5; 
		}
		elseif ($bat['type'] == 41) 
		{
		//кровавое противостояние
		 return 1; 
		}
		elseif ($bat['type'] == 61) 
		{
		//Арена Богов
		 return 1.5; 
		}
		elseif ($bat['type'] == 100) 
		{
		//простой клан бой
		 return 1; 
		}		
		elseif ($bat['type'] == 101) 
		{
		//Великий  клан бой
		 return 1.2; 
		}		
		elseif (($bat['type'] == 14)  OR ($bat['type'] == 13) )
		{
		//Бой в загороде начинающий с разбойного нападения тип 14
			if ($bat['blood']>0)
				 {
				 //коэф 1
				 return 1; 
				 }
				 else
				 {
				 //не кровь /2
				 return 0.5; 		 
				 }
		}
		elseif ($bat['type'] == 171) 
		{
		//Бой за замок
		 return 1; 
		}
		else
		if ($bat['status_flag'] == 10) 
		{
		//великую хаотическую битву коэф не меняется остаётся 1
			 if ($bat['blood']>0)
			 {
			 return 1; 
			 }
			 else
			 {
			 return 0.5; 
			 }
		}
		else
		if (($bat['CHAOS'] == 1) OR ($bat['CHAOS'] == 2))
		{
			 if ($bat['blood']>0)
			 {
			 //Хаотический бой  кровавый коэф 1 
			 return 1; 
			 }
			 else
			 {
			 //не кровавый /2
			 return 0.5; 
			 }		
		}
/////остальные бои по подсчету кол людей

$co=0; //считаем людей в бою
if ($bat['t1']!='') 	{  $ttt=explode(";",$bat['t1']); 	foreach($ttt as $k=>$v) {  if (!(($v > _BOTSEPARATOR_) and ($v < 1000000000 ))) {  $co++; } } 	}
if ($bat['t2']!='') 	{  $ttt=explode(";",$bat['t2']); 	foreach($ttt as $k=>$v) {  if (!(($v > _BOTSEPARATOR_) and ($v < 1000000000 ))) {  $co++; } } 	}						
if ($batt['t3']!='') 	{  $ttt=explode(";",$bat['t3']); 	foreach($ttt as $k=>$v) {  if (!(($v > _BOTSEPARATOR_) and ($v < 1000000000 ))) {  $co++; } } 	}						

if ($co>=666) {  if ($bat['blood']>0) { return 2; } else { return 1; }  }
elseif ($co>=600) { if ($bat['blood']>0) { return 1.9; } else { return 0.95 ; }   }
elseif ($co>=500) { if ($bat['blood']>0) {  return 1.85; } else { return 0.925 ; }   }
elseif ($co>=400) { if ($bat['blood']>0) {  return 1.8; } else { return 0.9 ; }   }
elseif ($co>=300) { if ($bat['blood']>0) {  return 1.75; } else { return 0.875 ; }   }
elseif ($co>=200) { if ($bat['blood']>0) {  return 1.7; } else { return 0.85 ; }   }
elseif ($co>=150) { if ($bat['blood']>0) {  return 1.6; } else { return 0.8 ; }   }
elseif ($co>=100) { if ($bat['blood']>0) {  return 1.5; } else { return 0.75 ; }   }
elseif ($co>=90) { if ($bat['blood']>0) {  return 1.45; } else { return 0.725 ; }   }
elseif ($co>=80) { if ($bat['blood']>0) {  return 1.4; } else { return 0.7 ; }   }
elseif ($co>=70) { if ($bat['blood']>0) {  return 1.35; } else { return 0.675 ; }   }
elseif ($co>=60) { if ($bat['blood']>0) {  return 1.3; } else { return 0.65 ; }   }
elseif ($co>=50) { if ($bat['blood']>0) {  return 1.25; } else { return 0.625 ; }   }
elseif ($co>=40) { if ($bat['blood']>0) {  return 1.2; } else { return 0.6 ; }   }
elseif ($co>=30) { if ($bat['blood']>0) {  return 1.15; } else { return 0.575 ; }   }
elseif ($co>=20) { if ($bat['blood']>0) {  return 1.1; } else { return 0.55 ; }   }
elseif ($co>=10) { if ($bat['blood']>0) {  return 1.05; } else { return 0.525 ; }   }
else {  if ($bat['blood']>0) {  return 1; } else { return 0.5 ; }   }
}

//функция - для поднятия уровня руне - когда она уже накачана
function mk_runs_lvl_up($itm_id)
{
global $runs_exp_table,$runs_mag_lvl_price,$runs_5lvl_param,$user;

$add_cost=30; //добавляем 30 кр в стоимость за каждый ур

if ($itm_id>0)
	{
	$get_item=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$itm_id}' and owner='{$user[id]}' and type=30 ;"));
	 if ($get_item[id]>0)
	 	{
	 if ($get_item[dressed]==0)		 	
	 	{
		 	 $runs_lvl_now=$get_item[up_level];
		 	 $need_exp_next=$runs_exp_table[$runs_lvl_now][next];
	 		 $runs_exp_now=$get_item[ups];
	 		 $new_data=$runs_exp_table[$runs_lvl_now+1];
	 		 
	 		 //echo $runs_exp_now ;
	 		 //echo "/"; 
	 		 //echo $need_exp_next;
	 		 
		 	  if ($runs_exp_now>=$need_exp_next)
		 	  	{
				$newlevel = $runs_lvl_now+1;		 	  		
				$ids = "";
				$go_ok=false;
				
				
		 	  		if ($newlevel>=21)
		 	  		{
		 	  		//дополнительные проверки если руна должна стать 21 и выше уровня
		 	  		//Масив с протоитпами  свитков развития
		 	  		$protmas=array(
		 	  				"21" => 4401,
		 	  				"22" => 4402,
		 	  				"23" => 4403,
		 	  				"24" => 4404,
		 	  				"25" => 4405,
		 	  				"26" => 4406,
		 	  				"27" => 4407,
		 	  				"28" => 4408,
		 	  				"29" => 4409,
		 	  				"30" => 4410);
						
					//масив с победами
					$needwin=array(
		 	  				"21" => 2000,
		 	  				"22" => 3000,
		 	  				"23" => 4000,
		 	  				"24" => 5000,
		 	  				"25" => 6500,
		 	  				"26" => 8000,
		 	  				"27" => 10000,
		 	  				"28" => 12000,
		 	  				"29" => 15000,
		 	  				"30" => 20000);
		 	  				
		 	  		//названия
		 	  		$scnam=array("21"=>"I" , "22"=>"II" , "23"=>"III" , "24"=>"IV" , "25"=>"V" , "26"=>"VI" , "27"=>"VII" , "28"=>"VIII" , "29"=>"IX" , "30"=>"X"  ) ;
					
						if ($user['winstbat']<$needwin[$newlevel])
							{
							$answ[msg]='У Вас не достаточно побед в Великих сражениях что бы прокачать эту руну!';
							$answ[stat]=0;
 							return $answ;							
							}
						
						if ($protmas[$newlevel] >0 )
						{
						//ищем в сумке предмет
								$getscr= mysql_fetch_array(mysql_query('SELECT * FROM oldbk.inventory WHERE prototype = '.$protmas[$newlevel].' AND owner = '.$user['id'].' LIMIT 1'));
								if ($getscr['id']>0)
								{
								//Удаляем предмет и  пишем для дела ид
															
									mysql_query('DELETE FROM oldbk.inventory WHERE id = '.$getscr['id']) or die();
									$ids = get_item_fid($getscr);
									$go_ok=true;
								}
								else
								{
								$answ[msg]='Для перехода этой руны на следующий уровень нужен свиток <b>"Рунический свиток развития '.$scnam[$newlevel].'"</b>!';
								$answ[stat]=0;
 								return $answ;							
								}
						}
						else
						{
							$answ[msg]='Руна на максимальном уровне!';
							$answ[stat]=0;
 							return $answ;
						}
		 	  		}
		 	  		else
		 	  		{
						$go_ok = true;
		 	  			///ниже 21 уровня за монетки
						/*		 	  		
		 	  			//good
						$q = mysql_query('SELECT * FROM oldbk.inventory WHERE prototype = 3003060 AND owner = '.$user['id']) or die();
						if (mysql_num_rows($q) >= $newlevel) 
						{
		 	  		/////////////////////	

							for ($i = 0; $i < $newlevel; $i++) {
							$it = mysql_fetch_assoc($q) or die();
							mysql_query('DELETE FROM oldbk.inventory WHERE id = '.$it['id']) or die();
							$ids .= get_item_fid($it).",";
							}

							if (strlen($ids) > 0) {
							$ids = substr($ids,0,strlen($ids)-1);
							}
							$go_ok=true;
						}
						else
						{
							$answ[msg]='У Вас не хватает монет для перехода руны на следующий уровень!';
							$answ[stat]=0;
 							return $answ;						 	  	
						}
						*/
		 	  		}
		 	  	

							
					if ($go_ok==true)
	 	  			{
		 	  			if ($runs_lvl_now==4) {
		 	  				//если руна была 4лвл и становится 5 лвл , то добавляем усиления
		 	  				$arr_add_param=$runs_5lvl_param[$get_item[prototype]];
		 	  				$add_sql_5lvl=" ,  ab_mf='{$arr_add_param[ab_mf]}', ab_bron='{$arr_add_param[ab_bron]}', ab_uron='{$arr_add_param[ab_uron]}'   ";
		 	  				}
		 	  				else
		 	  				{
		 	  				$add_sql_5lvl="";
		 	  				}
		 	  				
		 	  				
		 	  			if ($newlevel==30)
		 	  				{
		 	  				//бонус 30 левел +1% (к даваемым изначально рунным усилкам)
		 	  				$arr_add_param=$runs_5lvl_param[$get_item[prototype]];
		 	  				$arr_add_param[ab_mf]=($arr_add_param[ab_mf]>0)?$arr_add_param[ab_mf]+1:0;
		 	  				$arr_add_param[ab_bron]=($arr_add_param[ab_bron]>0)?$arr_add_param[ab_bron]+1:0;
		 	  				$arr_add_param[ab_uron]=($arr_add_param[ab_uron]>0)?$arr_add_param[ab_uron]+1:0;		 	  				
		 	  				$add_sql_5lvl=" ,  ab_mf='{$arr_add_param[ab_mf]}', ab_bron='{$arr_add_param[ab_bron]}', ab_uron='{$arr_add_param[ab_uron]}'   ";
		 	  				}
		 	  			
		 	  			
		 	  				mysql_query_100("UPDATE `oldbk`.`inventory` SET `cost`=`cost`+{$add_cost} , `ghp`=`ghp`+'{$new_data[ghp]}',`bron1`=`bron1`+'{$new_data[bron]}',`bron2`=`bron2`+'{$new_data[bron]}',`bron3`=`bron3`+'{$new_data[bron]}',`bron4`=`bron4`+'{$new_data[bron]}',
		 	  				`gfire`=`gfire`+'{$new_data[smast]}',`gwater`=`gwater`+'{$new_data[smast]}',`gair`=`gair`+'{$new_data[smast]}',`gearth`=`gearth`+'{$new_data[smast]}',`gmp`=`gmp`+'{$new_data[gmp]}',`gintel`=`gintel`+'{$new_data[gintel]}' , `minu`=`minu`+'{$new_data[minu]}' ,  `maxu`=`maxu`+'{$new_data[maxu]}' , 
		 	  				`stbonus`=`stbonus`+'{$new_data[stbonus]}',`mfbonus`=`mfbonus`+'{$new_data[mfbonus]}',`add_time`='{$new_data[next]}',`up_level`=`up_level`+1 ".$add_sql_5lvl."  WHERE `id`='{$get_item[id]}' and owner='{$user[id]}' and dressed=0 and type=30 ;");
			 	  			if (mysql_affected_rows()>0)
			 	  			{
			 	  			//пишем в дело
		  		    			$rec['owner']=$user['id'];
							$rec['owner_login']=$user['login'];
							$rec['owner_balans_do']=$user['money'];
							$rec['owner_balans_posle']=$user['money'];
							$rec['owner_rep_do']=$user['repmoney'];
							$rec['owner_rep_posle']=$user['repmoney'];
							$rec['target']=0;
							$rec['target_login']='Маг';
							$rec['type']=374; 
							$rec['sum_kr']=0;
							$rec['sum_ekr']=0;
							$rec['sum_kom']=0;
							$rec['sum_rep']=0;
							$rec['aitem_id']=$ids;
							$rec['item_id']=$get_item['id'];
							$rec['item_name']=$get_item['name'];
							$rec['item_count']=1;
							$rec['item_type']=$get_item['type'];
							$rec['item_cost']=$get_item['cost'];
							$rec['item_dur']=$get_item['duration'];
							$rec['item_maxdur']=$get_item['maxdur'];
							$rec['add_info']='на '.($runs_lvl_now+1).'-й уровень';
							add_to_new_delo($rec); //юзеру
							
							$answ[msg]='Все прошло удачно!';
							$answ[stat]=1;
 							return $answ;
			 	  			}
			 	  			else
			 	  			{
							$answ[msg]='Системная ошибка 1!';
							$answ[stat]=0;
 							return $answ;			 	  			
			 	  			}
		 		  	}
		 	  		
	 	  	
		 	  	}
		 	  	else
	 		  	{
							$answ[msg]='Руна еще не набрала нужного опыта для следующего уровня!';
							$answ[stat]=0;
 							return $answ;						 	  	
		 	  	}
		 }
		 else
		 	{
							$answ[msg]='Необходимо снять руну!';
							$answ[stat]=0;
 							return $answ;						 	  		 	
		 	}
		 }
		 else
		 {
							$answ[msg]='Такая руна у Вас не найдена!';
							$answ[stat]=0;
 							return $answ;					 
		 }
	}
	
							$answ[msg]='Такая руна у Вас не найдена!';
							$answ[stat]=0;
 							return $answ;	
}

//функция - для поднятия уровня - без учета накачки = покупка уровня
function mk_runs_full_lvl_up($itm_id)
{
global $runs_exp_table,$runs_lvl_cost,$runs_5lvl_param,$user;

$add_cost=30; //добавляем 30 кр в стоимость за каждый ур

if ($itm_id>0)
	{
	$get_item=mysql_fetch_array(mysql_query("select * from oldbk.inventory where id='{$itm_id}' and owner='{$user[id]}' and type=30 ;"));
	 if (($get_item[id]>0) and ($get_item[up_level]<10) ) //до 10го уровня
	 	{
	 if ($get_item[dressed]==0)		 	
	 	{
		 	 $runs_lvl_now=$get_item[up_level];
		 	 $need_exp_next=$runs_exp_table[$runs_lvl_now];
	 		 $runs_exp_now=$get_item[ups];
	 		 $new_data=$runs_exp_table[$runs_lvl_now+1];

	 	  	if ( $user[repmoney]>=$runs_lvl_cost[$runs_lvl_now+1])
		 		  	{
		 	  		//good
 	  				mysql_query_100('UPDATE users SET repmoney = repmoney - '.$runs_lvl_cost[$runs_lvl_now+1].' WHERE id = '.$user['id']);
	 	  				
		 	  			if (mysql_affected_rows()>0)
		 	  			{
		 	  			
		 	  				if ($runs_lvl_now==4)
		 	  				{
		 	  				//если руна была 4лвл и становится 5 лвл , то добавляем усиления
		 	  				$arr_add_param=$runs_5lvl_param[$get_item[prototype]];
		 	  				$add_sql_5lvl=" ,  ab_mf='{$arr_add_param[ab_mf]}', ab_bron='{$arr_add_param[ab_bron]}', ab_uron='{$arr_add_param[ab_uron]}'   ";
		 	  				}
		 	  				else
		 	  				{
		 	  				$add_sql_5lvl="";
		 	  				}
		 	  			
		 	  				mysql_query_100("UPDATE `oldbk`.`inventory` SET  `cost`=`cost`+{$add_cost} , `ghp`=`ghp`+'{$new_data[ghp]}',`bron1`=`bron1`+'{$new_data[bron]}',`bron2`=`bron2`+'{$new_data[bron]}',`bron3`=`bron3`+'{$new_data[bron]}',`bron4`=`bron4`+'{$new_data[bron]}',
		 	  				`gfire`=`gfire`+'{$new_data[smast]}',`gwater`=`gwater`+'{$new_data[smast]}',`gair`=`gair`+'{$new_data[smast]}',`gearth`=`gearth`+'{$new_data[smast]}',`gmp`=`gmp`+'{$new_data[gmp]}', `gintel`=`gintel`+'{$new_data[gintel]}' , `minu`=`minu`+'{$new_data[minu]}' ,  `maxu`=`maxu`+'{$new_data[maxu]}' , 
		 	  				`stbonus`=`stbonus`+'{$new_data[stbonus]}',`mfbonus`=`mfbonus`+'{$new_data[mfbonus]}',`add_time`='{$new_data[next]}',`ups`='{$get_item[add_time]}',`up_level`=`up_level`+1 ".$add_sql_5lvl."  WHERE `id`='{$get_item[id]}' and owner='{$user[id]}' and dressed=0 and type=30 ;");
			 	  			if (mysql_affected_rows()>0)
			 	  			{
			 	  			//пишем в дело
		  		    			$rec['owner']=$user[id];
							$rec['owner_login']=$user[login];
							$rec['owner_balans_do']=$user['money'];
							$rec['owner_balans_posle']=$user['money'];
							$rec['owner_rep_do']=$user[repmoney];
							$rec['owner_rep_posle']=($user[repmoney]-$runs_lvl_cost[$runs_lvl_now+1]);
							$rec['target']=0;
							$rec['target_login']='Маг';
							$rec['type']=375; 
							$rec['sum_kr']=0;
							$rec['sum_ekr']=0;
							$rec['sum_kom']=0;
							$rec['sum_rep']=$runs_lvl_cost[$runs_lvl_now+1];
							$rec['item_id']=get_item_fid($get_item);
							$rec['item_name']=$get_item[name];
							$rec['item_count']=1;
							$rec['item_type']=$get_item['type'];
							$rec['item_cost']=$get_item['cost'];
							$rec['item_dur']=$get_item['duration'];
							$rec['item_maxdur']=$get_item['maxdur'];
							$rec['add_info']='на '.($runs_lvl_now+1).'-й уровень';
							add_to_new_delo($rec); //юзеру

							$answ[msg]='Все прошло удачно!';
							$answ[stat]=1;
 							return $answ;

			 	  			}
			 	  			else
			 	  			{
							$answ[msg]='Системная ошибка 11!';
							$answ[stat]=0;
 							return $answ;
			 	  			}
	 		  			}
	 		  			else
	 		  				{
							$answ[msg]='Системная ошибка 12!';
							$answ[stat]=0;
 							return $answ; 		  				
	 		  				}
		 		  	}
		 	  		else
			 	  	{
							$answ[msg]='У Вас не хватает репутации для перехода руны на следующий уровень!';
							$answ[stat]=0;
 							return $answ;		
			 	  	}
	 	  	
		 	  	

		 }
		 else
		 	{
							$answ[msg]='Необходимо снять руну!';
							$answ[stat]=0;
 							return $answ;	
		 	}
		 }
		 else
		 {
							$answ[msg]='Такая руна у Вас не найдена!';
							$answ[stat]=0;
 							return $answ;	
		 }
	}
	
							$answ[msg]='Такая руна у Вас не найдена!';
							$answ[stat]=0;
 							return $answ;	
}



?>